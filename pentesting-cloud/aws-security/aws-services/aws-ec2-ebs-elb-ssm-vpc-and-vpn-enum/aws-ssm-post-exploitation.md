# AWS - SSM Post-Exploitation

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## MitM SSM

### MitM SSM Messages sent to an EC2 Instance <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

With **access to the IAM credentials of an EC2 instance**, you can intercept EC2 messages and SSM sessions due to SSM's authentication handling.

The [**SSM Agent**](https://github.com/aws/amazon-ssm-agent) continuously calls **`ec2messages:GetMessages`**, keeping the **connection open** for **20 seconds**. If a message is sent, such as via [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), it's received through this open connection.

An **attacker** can intercept EC2 messages by calling **`ec2messages:GetMessages`** more frequently. This [**proof of concept**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) demonstrates this by listening for send-command messages. The attacker can also **send any response** they want to the messages.

The attacker could also **send any response** he likes to the messages.

### MitM SSM Session Messages

This is more complex, involving multiple WebSocket connections and a unique binary protocol. When the **SSM Agent starts**, it **creates** a **WebSocket** connection to AWS. When a user starts an SSM session ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), the **control channel initiates a data channel** for user-EC2 instance communication.

The SSM Agent's source code, available [here](https://github.com/aws/amazon-ssm-agent), can be used to craft the messages in the binary format, like [this](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Intercepting SSM Sessions is more reliable than EC2 messages** as the **control channels are long lived** and AWS only communicates with the **newest one**. This [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) shows how to create a control channel and interact with the session.

From an abuse perspective, **intercepting SSM Sessions is more reliable than EC2 messages**. The reason for this is that the **control channels are long lived**, and just like with EC2 messages AWS will only communicate with the **newest one**. As a result, we can create our own control channel and listen for incoming sessions. Using the SSM Agent source code, we can craft the messages in the binary format (if you look to the [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), you‚Äôll notice I‚Äôve literally just translated the Go to Python), and interact with the session.

It's also possible to steal commands (**sensitive info**) and supply the attackers output.

## References

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
