# AWS - SSMポストエクスプロイテーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## MitM SSM

### EC2インスタンスに送信されるSSMメッセージのMitM <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

**EC2インスタンスのIAM資格情報にアクセス**がある場合、SSMの認証処理により、EC2メッセージとSSMセッションを傍受することができます。

[**SSMエージェント**](https://github.com/aws/amazon-ssm-agent)は、**`ec2messages:GetMessages`**を継続的に呼び出し、**接続を20秒間開いたままにします**。メッセージが送信されると、[**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html)などを介して、このオープンな接続を通じて受信されます。

**攻撃者**は、**`ec2messages:GetMessages`**をより頻繁に呼び出すことで、EC2メッセージを傍受することができます。この[**概念実証**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception)では、send-commandメッセージの受信をリッスンしています。攻撃者はまた、メッセージに対して**任意の応答**を送信することもできます。

攻撃者はまた、メッセージに対して**任意の応答**を送信することもできます。

### MitM SSMセッションメッセージ

これはより複雑で、複数のWebSocket接続とユニークなバイナリプロトコルが関与します。**SSMエージェントが開始**されると、AWSに対して**WebSocket接続を作成**します。ユーザーがSSMセッションを開始すると（[ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)）、**制御チャネルはユーザーとEC2インスタンスの通信のためのデータチャネルを開始**します。

SSMエージェントのソースコードは、[こちら](https://github.com/aws/amazon-ssm-agent)で利用でき、[こちら](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73)のようにバイナリ形式のメッセージを作成するために使用できます。

**SSMセッションの傍受は、EC2メッセージよりも信頼性が高い**です。なぜなら、**制御チャネルは長期間存続**し、AWSは常に**最新のチャネル**と通信するからです。この[概念実証](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception)では、制御チャネルを作成し、セッションとやり取りする方法が示されています。

乱用の観点からは、**SSMセッションの傍受はEC2メッセージよりも信頼性が高い**です。これは、**制御チャネルが長期間存続**し、EC2メッセージと同様にAWSは**最新のチャネル**との通信のみ行うためです。その結果、独自の制御チャネルを作成し、着信セッションをリッスンすることができます。SSMエージェントのソースコードを使用して、バイナリ形式のメッセージを作成し（[概念実証](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception)を見ると、GoからPythonに翻訳しただけです）、セッションとやり取りすることができます。

コマンド（**機密情報**）を盗むことも可能であり、攻撃者の出力を提供することもできます。

## 参考文献

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>
