# AWS - Post-Explotaci칩n de SSM

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este post fue copiado de** [**https://frichetten.com/blog/ssm-agent-tomfoolery/**](https://frichetten.com/blog/ssm-agent-tomfoolery/)

## Interceptando Comunicaciones de SSM

### Interceptando Mensajes de EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Debido a c칩mo SSM maneja la autenticaci칩n, si se puede obtener **acceso a las credenciales IAM de una instancia EC2, se pueden interceptar los mensajes de EC2 y las sesiones de SSM**.

El [**Agente SSM**](https://github.com/aws/amazon-ssm-agent) llamar치 constantemente a **`ec2messages:GetMessages`**. Por defecto, el agente lo har치 constantemente, manteniendo la **conexi칩n abierta** durante aproximadamente **20 segundos**. Durante este intervalo de 20 segundos, el agente est치 **escuchando** los mensajes. Si recibe uno, como cuando alguien llama a [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), recibir치 el mensaje a trav칠s de esta conexi칩n abierta.

Un **atacante** puede llamar con m치s frecuencia a **`ec2messages:GetMessages`**, y esto nos permitir치 **interceptar los mensajes de EC2 que llegan a la instancia**. Esto se debe a que los mensajes se enviar치n al 칰ltimo que estableci칩 una conexi칩n (as칤 que mientras un atacante lo haga con m치s frecuencia, obtendr치 los mensajes). Para probar esta idea, se puede utilizar este sencillo [**proof of concept**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) que escuchar치 los mensajes de env칤o de comandos y robar치 el comando.

El atacante tambi칠n podr칤a **enviar cualquier respuesta** que desee a los mensajes.

### Interceptando Sesiones de SSM

Esto es m치s complejo ya que implica m칰ltiples conexiones de socket web, un protocolo binario 칰nico y m치s. Lo siguiente es un resumen de los conceptos relevantes.

Poco despu칠s de que el **Agente SSM se inicie**, crear치 una conexi칩n **WebSocket** de vuelta a AWS. Esta conexi칩n es el canal de control y es responsable de escuchar las conexiones. Cuando un usuario intenta iniciar una sesi칩n de SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), el canal de control recibir치 la solicitud y generar치 un canal de datos. El canal de datos es responsable de la comunicaci칩n real del usuario con la instancia EC2.

La comunicaci칩n que tiene lugar entre los clientes es un protocolo binario espec칤fico para este prop칩sito. Afortunadamente, el c칩digo fuente del Agente SSM est치 disponible [aqu칤](https://github.com/aws/amazon-ssm-agent), y podemos buscar la especificaci칩n para 칠l. Se parece a [esto](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

![](<../../../../.gitbook/assets/image (4) (1) (1).png>)

Desde una perspectiva de abuso, **interceptar las sesiones de SSM es m치s fiable que los mensajes de EC2**. La raz칩n de esto es que los **canales de control tienen una vida 칰til larga**, y al igual que con los mensajes de EC2, AWS solo se comunicar치 con el **m치s nuevo**. Como resultado, podemos crear nuestro propio canal de control y escuchar las sesiones entrantes. Usando el c칩digo fuente del Agente SSM, podemos crear los mensajes en el formato binario (si se mira el [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), se notar치 que literalmente he traducido el Go a Python), e interactuar con la sesi칩n.

Debido a esto, podemos hacer cosas como las siguientes.

![](<../../../../.gitbook/assets/image (45).png>)

Alternativamente, podr칤amos hacer cosas como robar los comandos y suministrar nuestra propia salida. Por ejemplo, intentar espiar las credenciales que se pasan a la m치quina.