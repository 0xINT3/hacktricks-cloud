# AWS - Enumera√ß√£o do CloudHSM

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas dicas de hacking enviando PRs para** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## HSM - M√≥dulo de Seguran√ßa de Hardware

O Cloud HSM √© um dispositivo de hardware validado pelo n√≠vel dois do FIPS 140 para armazenamento seguro de chaves criptogr√°ficas (observe que o CloudHSM √© um dispositivo de hardware, n√£o √© um servi√ßo virtualizado). √â um dispositivo SafeNetLuna 7000 com a vers√£o 5.3.13 pr√©-carregada. Existem duas vers√µes de firmware e a escolha depende das suas necessidades espec√≠ficas. Uma √© para conformidade com o FIPS 140-2 e havia uma vers√£o mais recente que pode ser usada.

A caracter√≠stica incomum do CloudHSM √© que √© um dispositivo f√≠sico e, portanto, **n√£o √© compartilhado com outros clientes**, ou como √© comumente chamado, multi-inquilino. √â um dispositivo exclusivo de locat√°rio √∫nico dedicado disponibilizado exclusivamente para suas cargas de trabalho.

Normalmente, um dispositivo est√° dispon√≠vel em 15 minutos, assumindo que haja capacidade, mas em algumas zonas pode n√£o haver.

Como este √© um dispositivo f√≠sico dedicado a voc√™, **as chaves s√£o armazenadas no dispositivo**. As chaves precisam ser **replicadas para outro dispositivo**, copiadas para armazenamento offline ou exportadas para um dispositivo de reserva. **Este dispositivo n√£o √© suportado** pelo S3 ou por qualquer outro servi√ßo da AWS como o KMS.

No **CloudHSM**, voc√™ precisa **dimensionar o servi√ßo por conta pr√≥pria**. Voc√™ precisa provisionar dispositivos CloudHSM suficientes para lidar com suas necessidades de criptografia com base nos algoritmos de criptografia que voc√™ escolheu para implementar em sua solu√ß√£o.\
O dimensionamento do Key Management Service √© realizado pela AWS e dimensiona automaticamente conforme a demanda, portanto, √† medida que seu uso cresce, pode ser necess√°rio um n√∫mero maior de dispositivos CloudHSM. Mantenha isso em mente ao dimensionar sua solu√ß√£o e, se sua solu√ß√£o tiver dimensionamento autom√°tico, certifique-se de que seu dimensionamento m√°ximo seja considerado com dispositivos CloudHSM suficientes para atender √† solu√ß√£o.

Assim como o dimensionamento, **o desempenho depende de voc√™ com o CloudHSM**. O desempenho varia com base no algoritmo de criptografia usado e na frequ√™ncia com que voc√™ precisa acessar ou recuperar as chaves para criptografar os dados. O desempenho do servi√ßo de gerenciamento de chaves √© tratado pela Amazon e dimensiona automaticamente conforme a demanda. O desempenho do CloudHSM √© alcan√ßado adicionando mais dispositivos e, se precisar de mais desempenho, voc√™ adiciona dispositivos ou altera o m√©todo de criptografia para um algoritmo mais r√°pido.

Se sua solu√ß√£o for **multi-regi√£o**, voc√™ deve adicionar v√°rios **dispositivos CloudHSM na segunda regi√£o e configurar a conectividade entre regi√µes com uma conex√£o VPN privada** ou algum m√©todo para garantir que o tr√°fego esteja sempre protegido entre os dispositivos em cada camada da conex√£o. Se voc√™ tiver uma solu√ß√£o multi-regi√£o, precisar√° pensar em como **replicar chaves e configurar dispositivos CloudHSM adicionais nas regi√µes em que opera**. Voc√™ pode rapidamente chegar a um cen√°rio em que tem seis ou oito dispositivos distribu√≠dos em v√°rias regi√µes, permitindo a redund√¢ncia total de suas chaves de criptografia.

**CloudHSM** √© um servi√ßo de classe empresarial para armazenamento seguro de chaves e pode ser usado como uma **raiz de confian√ßa para uma empresa**. Ele pode armazenar chaves privadas em PKI e chaves de autoridade de certifica√ß√£o em implementa√ß√µes X509. Al√©m das chaves sim√©tricas usadas em algoritmos sim√©tricos como AES, **o KMS armazena e protege fisicamente apenas chaves sim√©tricas (n√£o pode atuar como uma autoridade de certifica√ß√£o)**, portanto, se voc√™ precisar armazenar chaves PKI e CA, um ou dois ou tr√™s CloudHSMs podem ser sua solu√ß√£o.

**O CloudHSM √© consideravelmente mais caro do que o Key Management Service**. O CloudHSM √© um dispositivo de hardware, ent√£o voc√™ tem custos fixos para provisionar o dispositivo CloudHSM, e depois um custo por hora para executar o dispositivo. O custo √© multiplicado pelo n√∫mero de dispositivos CloudHSM necess√°rios para atender aos seus requisitos espec√≠ficos.\
Al√©m disso, deve-se considerar a compra de software de terceiros, como os conjuntos de software SafeNet ProtectV, e o tempo e esfor√ßo de integra√ß√£o. O Key Management Service √© baseado no uso e depende do n√∫mero de chaves que voc√™ possui e das opera√ß√µes de entrada e sa√≠da. Como o gerenciamento de chaves oferece integra√ß√£o perfeita com muitos servi√ßos da AWS, os custos de integra√ß√£o devem ser significativamente menores. Os custos devem ser considerados um fator secund√°rio nas solu√ß√µes de criptografia. A criptografia √© tipicamente usada para seguran√ßa e conformidade.

**Com o CloudHSM, apenas voc√™ tem acesso √†s chaves** e, sem entrar em muitos detalhes, com o CloudHSM voc√™ gerencia suas pr√≥prias chaves. **Com o KMS, voc√™ e a Amazon co-gerenciam suas chaves**. A AWS possui muitas salvaguardas de pol√≠ticas contra abusos e **ainda n√£o pode acessar suas chaves em nenhuma das solu√ß√µes**. A principal distin√ß√£o √© a conformidade no que diz respeito √† propriedade e gerenciamento de chaves, e com o CloudHSM, este √© um dispositivo de hardware que voc√™ gerencia e mant√©m com acesso exclusivo a voc√™ e somente a voc√™.

### Sugest√µes do CloudHSM

1. Sempre implante o CloudHSM em uma **configura√ß√£o de alta disponibilidade** com pelo menos dois dispositivos em **zonas de disponibilidade separadas**, e, se poss√≠vel, implante um terceiro localmente ou em outra regi√£o na AWS.
2. Tenha cuidado ao **inicializar** um **CloudHSM**. Esta a√ß√£o **ir√° destruir as chaves**, ent√£o tenha outra c√≥pia das chaves ou tenha absoluta certeza de que voc√™ n√£o precisa e nunca precisar√° dessas chaves para descriptografar quaisquer dados.
3. O CloudHSM suporta apenas **certas vers√µes de firmware** e software. Antes de realizar qualquer atualiza√ß√£o, certifique-se de que o firmware e/ou software seja suportado pela AWS. Voc√™ sempre pode entrar em contato com o suporte da AWS para verificar se o guia de atualiza√ß√£o n√£o est√° claro.
4. A **configura√ß√£o de rede nunca deve ser alterada**. Lembre-se, est√° em um data center da AWS e a AWS est√° monitorando o hardware b√°sico para voc√™. Isso significa que se o hardware falhar, eles o substituir√£o, mas somente se souberem que falhou.
5. O **encaminhamento do SysLog n√£o deve ser removido ou alterado**. Voc√™ sempre pode **adicionar** um encaminhador de SysLog para direcionar os logs para sua pr√≥pria ferramenta de coleta.
6. A configura√ß√£o **SNMP** tem as mesmas restri√ß√µes b√°sicas que a rede e a pasta SysLog. Isso **n√£o deve ser alterado ou removido**. Uma **configura√ß√£o SNMP adicional** √© aceit√°vel, apenas certifique-se de n√£o alterar a que j√° est√° no dispositivo.
7. Outra pr√°tica recomendada interessante da AWS √© **n√£o alterar a configura√ß√£o do NTP**. N√£o est√° claro o que aconteceria se voc√™ o fizesse, ent√£o tenha em mente que se voc√™ n√£o usar a mesma configura√ß√£o de NTP para o restante de sua solu√ß√£o, poder√° ter duas fontes de tempo. Esteja ciente disso e saiba que o CloudHSM deve permanecer com a fonte de NTP existente.

A taxa de lan√ßamento inicial para o CloudHSM √© de $5.000 para alocar o dispositivo de hardware dedicado para seu uso, e depois h√° uma taxa por hora associada √† execu√ß√£o do CloudHSM, que atualmente √© de $1,88 por hora de opera√ß√£o, ou aproximadamente $1.373 por m√™s.

O motivo mais comum para usar o CloudHSM s√£o os padr√µes de conformidade que voc√™ deve atender por motivos regulat√≥rios. **O KMS n√£o oferece suporte de dados para chaves assim√©tricas. O CloudHSM permite que voc√™ armazene chaves assim√©tricas com seguran√ßa**.

A **chave p√∫blica √© instalada no dispositivo HSM durante o provisionamento** para que voc√™ possa acessar a inst√¢ncia do CloudHSM via SSH.

### O que √© um M√≥dulo de Seguran√ßa de Hardware

Um m√≥dulo de seguran√ßa de hardware (HSM) √© um dispositivo criptogr√°fico dedicado usado para gerar, armazenar e gerenciar chaves criptogr√°ficas e proteger dados sens√≠veis. Ele √© projetado para fornecer um alto n√≠vel de seguran√ßa, isolando fisicamente e eletronicamente as fun√ß√µes criptogr√°ficas do restante do sistema.

A forma como um HSM funciona pode variar dependendo do modelo e fabricante espec√≠ficos, mas geralmente, os seguintes passos ocorrem:

1. **Gera√ß√£o de chave**: O HSM gera uma chave criptogr√°fica aleat√≥ria usando um gerador de n√∫meros aleat√≥rios seguro.
2. **Armazenamento de chave**: A chave √© **armazenada com seguran√ßa dentro do HSM, onde s√≥ pode ser acessada por usu√°rios ou processos autorizados**.
3. **Gerenciamento de chave**: O HSM fornece uma variedade de fun√ß√µes de gerenciamento de chaves, incluindo rota√ß√£o de chaves, backup e revoga√ß√£o.
4. **Opera√ß√µes criptogr√°ficas**: O HSM realiza uma variedade de opera√ß√µes criptogr√°ficas, incluindo criptografia, descriptografia, assinatura digital e troca de chaves. Essas opera√ß√µes s√£o **realizadas dentro do ambiente seguro do HSM**, que protege contra acesso n√£o autorizado e adultera√ß√£o.
5. **Registro de auditoria**: O HSM registra todas as opera√ß√µes criptogr√°ficas e tentativas de acesso, que podem ser usadas para fins de auditoria de conformidade e seguran√ßa.

Os HSMs podem ser usados em uma ampla gama de aplica√ß√µes, incluindo transa√ß√µes online seguras, certificados digitais, comunica√ß√µes seguras e criptografia de dados. Eles s√£o frequentemente usados em setores que exigem um alto n√≠vel de seguran√ßa, como finan√ßas, sa√∫de e governo.

No geral, o alto n√≠vel de seguran√ßa fornecido pelos HSMs torna **muito dif√≠cil extrair chaves brutas deles, e tentar faz√™-lo √© frequentemente considerado uma viola√ß√£o de seguran√ßa**. No entanto, pode haver **certos cen√°rios** em que uma **chave bruta poderia ser extra√≠da** por pessoal autorizado para fins espec√≠ficos, como no caso de um procedimento de recupera√ß√£o de chave.

### Enumera√ß√£o
```
```
<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
