# AWS - Enumera√ß√£o CloudHSM

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## HSM - M√≥dulo de Seguran√ßa de Hardware

Cloud HSM √© um **dispositivo de hardware** validado pelo FIPS 140 n√≠vel dois para armazenamento seguro de chaves criptogr√°ficas (note que o CloudHSM √© um aparelho de hardware, n√£o √© um servi√ßo virtualizado). √â um aparelho SafeNetLuna 7000 com 5.3.13 pr√©-carregado. Existem duas vers√µes de firmware e a escolha depende das suas necessidades exatas. Uma √© para conformidade com FIPS 140-2 e havia uma vers√£o mais recente que pode ser usada.

A caracter√≠stica incomum do CloudHSM √© que ele √© um dispositivo f√≠sico, e, portanto, **n√£o √© compartilhado com outros clientes**, ou como √© comumente chamado, multi-tenant. √â um aparelho dedicado a um √∫nico inquilino, disponibilizado exclusivamente para suas cargas de trabalho.

Normalmente, um dispositivo est√° dispon√≠vel em 15 minutos, assumindo que haja capacidade, mas em algumas zonas pode n√£o haver.

Como este √© um dispositivo f√≠sico dedicado a voc√™, **as chaves s√£o armazenadas no dispositivo**. As chaves precisam ser **replicadas para outro dispositivo**, feito backup para armazenamento offline ou exportadas para um aparelho de espera. **Este dispositivo n√£o √© apoiado** pelo S3 ou qualquer outro servi√ßo da AWS como o KMS.

No **CloudHSM**, voc√™ precisa **escalar o servi√ßo por conta pr√≥pria**. Voc√™ deve provisionar dispositivos CloudHSM suficientes para lidar com suas necessidades de criptografia com base nos algoritmos de criptografia que voc√™ escolheu implementar para sua solu√ß√£o.\
A escalabilidade do Key Management Service √© realizada pela AWS e escala automaticamente conforme a demanda, ent√£o, √† medida que seu uso cresce, tamb√©m pode crescer o n√∫mero de aparelhos CloudHSM necess√°rios. Tenha isso em mente ao escalar sua solu√ß√£o e, se sua solu√ß√£o tem auto-scaling, certifique-se de que sua escala m√°xima seja contabilizada com aparelhos CloudHSM suficientes para atender a solu√ß√£o.

Assim como a escalabilidade, **o desempenho √© de sua responsabilidade com o CloudHSM**. O desempenho varia com base em qual algoritmo de criptografia √© usado e em qu√£o frequentemente voc√™ precisa acessar ou recuperar as chaves para criptografar os dados. O desempenho do servi√ßo de gerenciamento de chaves √© tratado pela Amazon e escala automaticamente conforme a demanda. O desempenho do CloudHSM √© alcan√ßado adicionando mais aparelhos e, se voc√™ precisar de mais desempenho, voc√™ adiciona dispositivos ou altera o m√©todo de criptografia para o algoritmo que √© mais r√°pido.

Se sua solu√ß√£o √© **multi-regi√£o**, voc√™ deve adicionar v√°rios **aparelhos CloudHSM na segunda regi√£o e resolver a conectividade entre regi√µes com uma conex√£o VPN privada** ou algum m√©todo para garantir que o tr√°fego esteja sempre protegido entre o aparelho em todas as camadas da conex√£o. Se voc√™ tem uma solu√ß√£o multi-regi√£o, precisa pensar em como **replicar chaves e configurar dispositivos CloudHSM adicionais nas regi√µes onde opera**. Voc√™ pode rapidamente entrar em um cen√°rio onde tem seis ou oito dispositivos espalhados por v√°rias regi√µes, permitindo redund√¢ncia total de suas chaves de criptografia.

**CloudHSM** √© um servi√ßo de classe empresarial para armazenamento seguro de chaves e pode ser usado como uma **raiz de confian√ßa para uma empresa**. Ele pode armazenar chaves privadas em PKI e chaves de autoridade de certifica√ß√£o em implementa√ß√µes X509. Al√©m de chaves sim√©tricas usadas em algoritmos sim√©tricos como AES, **KMS armazena e protege fisicamente apenas chaves sim√©tricas (n√£o pode atuar como uma autoridade de certifica√ß√£o)**, ent√£o se voc√™ precisa armazenar chaves PKI e CA, um ou dois CloudHSMs podem ser sua solu√ß√£o.

**CloudHSM √© consideravelmente mais caro do que o Key Management Service**. CloudHSM √© um aparelho de hardware, ent√£o voc√™ tem custos fixos para provisionar o dispositivo CloudHSM, depois um custo por hora para rodar o aparelho. O custo √© multiplicado pelo n√∫mero de aparelhos CloudHSM que s√£o necess√°rios para atingir seus requisitos espec√≠ficos.\
Al√©m disso, deve-se considerar a compra de softwares de terceiros, como os pacotes de software SafeNet ProtectV, e o tempo e esfor√ßo de integra√ß√£o. O Key Management Service √© baseado em uso e depende do n√∫mero de chaves que voc√™ tem e das opera√ß√µes de entrada e sa√≠da. Como o gerenciamento de chaves oferece integra√ß√£o perfeita com muitos servi√ßos da AWS, os custos de integra√ß√£o devem ser significativamente menores. Os custos devem ser considerados um fator secund√°rio em solu√ß√µes de criptografia. A criptografia √© tipicamente usada para seguran√ßa e conformidade.

**Com o CloudHSM, apenas voc√™ tem acesso √†s chaves** e, sem entrar em muitos detalhes, com o CloudHSM voc√™ gerencia suas pr√≥prias chaves. **Com o KMS, voc√™ e a Amazon co-gerenciam suas chaves**. A AWS tem muitas salvaguardas de pol√≠ticas contra abusos e **ainda assim n√£o pode acessar suas chaves em nenhuma das solu√ß√µes**. A principal distin√ß√£o √© a conformidade no que diz respeito √† propriedade e gerenciamento de chaves, e com o CloudHSM, este √© um aparelho de hardware que voc√™ gerencia e mant√©m com acesso exclusivo a voc√™ e somente a voc√™.

### Sugest√µes CloudHSM

1. Sempre implante o CloudHSM em uma configura√ß√£o **HA** com pelo menos dois aparelhos em **zonas de disponibilidade separadas**, e, se poss√≠vel, implante um terceiro no local ou em outra regi√£o na AWS.
2. Tenha cuidado ao **inicializar** um **CloudHSM**. Esta a√ß√£o **destruir√° as chaves**, ent√£o tenha outra c√≥pia das chaves ou esteja absolutamente certo de que voc√™ n√£o precisa e nunca precisar√° dessas chaves para descriptografar quaisquer dados.
3. CloudHSM s√≥ **suporta certas vers√µes de firmware** e software. Antes de realizar qualquer atualiza√ß√£o, certifique-se de que o firmware e/ou software s√£o suportados pela AWS. Voc√™ sempre pode entrar em contato com o suporte da AWS para verificar se o guia de atualiza√ß√£o n√£o est√° claro.
4. A **configura√ß√£o de rede nunca deve ser alterada.** Lembre-se, est√° em um data center da AWS e a AWS est√° monitorando o hardware base para voc√™. Isso significa que, se o hardware falhar, eles o substituir√£o para voc√™, mas apenas se souberem que falhou.
5. O **encaminhamento do SysLog n√£o deve ser removido ou alterado**. Voc√™ sempre pode **adicionar** um encaminhador de SysLog para direcionar os logs para sua pr√≥pria ferramenta de coleta.
6. A configura√ß√£o do **SNMP** tem as mesmas restri√ß√µes b√°sicas que a rede e a pasta SysLog. Isso **n√£o deve ser alterado ou removido**. Uma configura√ß√£o **adicional** de SNMP est√° bem, apenas certifique-se de n√£o alterar a que j√° est√° no aparelho.
7. Outra boa pr√°tica interessante da AWS √© **n√£o alterar a configura√ß√£o do NTP**. N√£o est√° claro o que aconteceria se voc√™ fizesse isso, ent√£o tenha em mente que, se voc√™ n√£o usar a mesma configura√ß√£o de NTP para o resto da sua solu√ß√£o, ent√£o voc√™ poderia ter duas fontes de tempo. Esteja ciente disso e saiba que o CloudHSM deve permanecer com a fonte de NTP existente.

A taxa inicial de lan√ßamento do CloudHSM √© de $5,000 para alocar o aparelho de hardware dedicado para seu uso, depois h√° uma taxa por hora associada √† opera√ß√£o do CloudHSM que atualmente √© de $1.88 por hora de opera√ß√£o, ou aproximadamente $1,373 por m√™s.

O motivo mais comum para usar o CloudHSM √© atender aos padr√µes de conformidade regulat√≥rios. **O KMS n√£o oferece suporte a dados para chaves assim√©tricas. O CloudHSM permite armazenar chaves assim√©tricas com seguran√ßa**.
A **chave p√∫blica √© instalada no dispositivo HSM durante o provisionamento** para que voc√™ possa acessar a inst√¢ncia CloudHSM via SSH.

### O que √© um M√≥dulo de Seguran√ßa de Hardware

Um m√≥dulo de seguran√ßa de hardware (HSM) √© um dispositivo criptogr√°fico dedicado que √© usado para gerar, armazenar e gerenciar chaves criptogr√°ficas e proteger dados sens√≠veis. Ele √© projetado para fornecer um alto n√≠vel de seguran√ßa isolando fisicamente e eletronicamente as fun√ß√µes criptogr√°ficas do restante do sistema.

O funcionamento de um HSM pode variar dependendo do modelo espec√≠fico e do fabricante, mas geralmente, os seguintes passos ocorrem:

1. **Gera√ß√£o de chave**: O HSM gera uma chave criptogr√°fica aleat√≥ria usando um gerador de n√∫meros aleat√≥rios seguro.
2. **Armazenamento de chave**: A chave √© **armazenada de forma segura dentro do HSM, onde s√≥ pode ser acessada por usu√°rios ou processos autorizados**.
3. **Gerenciamento de chave**: O HSM oferece uma gama de fun√ß√µes de gerenciamento de chaves, incluindo rota√ß√£o, backup e revoga√ß√£o de chaves.
4. **Opera√ß√µes criptogr√°ficas**: O HSM realiza uma s√©rie de opera√ß√µes criptogr√°ficas, incluindo criptografia, descriptografia, assinatura digital e troca de chaves. Essas opera√ß√µes s√£o **realizadas dentro do ambiente seguro do HSM**, o que protege contra acesso n√£o autorizado e adultera√ß√£o.
5. **Registro de auditoria**: O HSM registra todas as opera√ß√µes criptogr√°ficas e tentativas de acesso, que podem ser usadas para fins de conformidade e auditoria de seguran√ßa.

HSMs podem ser usados para uma ampla gama de aplica√ß√µes, incluindo transa√ß√µes online seguras, certificados digitais, comunica√ß√µes seguras e criptografia de dados. Eles s√£o frequentemente utilizados em ind√∫strias que exigem um alto n√≠vel de seguran√ßa, como finan√ßas, sa√∫de e governo.

No geral, o alto n√≠vel de seguran√ßa fornecido pelos HSMs torna **muito dif√≠cil extrair chaves brutas deles, e tentar fazer isso √© frequentemente considerado uma viola√ß√£o de seguran√ßa**. No entanto, pode haver **cen√°rios espec√≠ficos** onde uma **chave bruta poderia ser extra√≠da** por pessoal autorizado para fins espec√≠ficos, como no caso de um procedimento de recupera√ß√£o de chave.

### Enumera√ß√£o
```
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
