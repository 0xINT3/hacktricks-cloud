# AWS - CloudHSM 枚举

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## HSM - 硬件安全模块

Cloud HSM 是一个 FIPS 140 第二级验证的**硬件设备**，用于安全的加密密钥存储（注意 CloudHSM 是硬件设备，不是虚拟化服务）。它是一台预装了 5.3.13 的 SafeNetLuna 7000 设备。有两个固件版本，您选择哪一个完全基于您的具体需求。一个是为了符合 FIPS 140-2 标准，还有一个更新的版本可以使用。

CloudHSM 的不寻常之处在于它是一个物理设备，因此它**不与其他客户共享**，或者通常所说的，多租户。它是专门为您的工作负载提供的专用单租户设备。

通常，假设有容量，设备在 15 分钟内可用，但在某些区域可能没有。

由于这是专门为您提供的物理设备，**密钥存储在设备上**。密钥需要**复制到另一台设备**，备份到离线存储，或导出到备用设备。**这个设备没有**由 S3 或 AWS 的任何其他服务支持，如 KMS。

在 **CloudHSM** 中，您需要**自己扩展服务**。您需要根据您为解决方案选择实施的加密算法，提供足够的 CloudHSM 设备来处理您的加密需求。\
密钥管理服务的扩展由 AWS 执行，并根据需求自动扩展，因此随着您的使用增长，可能需要更多的 CloudHSM 设备。在扩展解决方案时请记住这一点，如果您的解决方案具有自动扩展功能，请确保您的最大扩展范围有足够的 CloudHSM 设备来服务解决方案。

就像扩展一样，**CloudHSM 的性能取决于您**。性能根据使用的加密算法和您需要访问或检索密钥以加密数据的频率而变化。密钥管理服务的性能由亚马逊处理，并根据需求自动扩展。CloudHSM 的性能是通过增加更多设备来实现的，如果您需要更多性能，您可以添加设备或更改加密方法到更快的算法。

如果您的解决方案是**多区域**的，您应该在第二个区域添加几台 **CloudHSM 设备，并通过私有 VPN 连接**或某种方法解决跨区域连接，以确保在连接的每一层之间的流量始终受到保护。如果您有一个多区域解决方案，您需要考虑如何**复制密钥并在您运营的区域设置额外的 CloudHSM 设备**。您可能很快就会遇到一个场景，即在多个区域分布有六到八台设备，实现加密密钥的完全冗余。

**CloudHSM** 是一个企业级服务，用于安全的密钥存储，并可作为企业的**信任根**。它可以存储 PKI 中的私钥和 X509 实现中的证书颁发机构密钥。除了在对称算法如 AES 中使用的对称密钥外，**KMS 仅存储和物理保护对称密钥（不能充当证书颁发机构）**，因此如果您需要存储 PKI 和 CA 密钥，一个或两个或三个 CloudHSM 可能是您的解决方案。

**CloudHSM 的成本远高于密钥管理服务**。CloudHSM 是硬件设备，因此您有固定成本来配置 CloudHSM 设备，然后是运行设备的每小时成本。成本是根据实现您特定要求所需的 CloudHSM 设备数量而倍增的。\
此外，在购买第三方软件（如 SafeNet ProtectV 软件套件）以及集成时间和努力方面也必须进行交叉考虑。密钥管理服务是基于使用量的，取决于您拥有的密钥数量和输入输出操作。由于密钥管理与许多 AWS 服务无缝集成，集成成本应该显著降低。在加密解决方案中，成本应该是次要因素。加密通常用于安全和合规。

**只有您可以访问 CloudHSM 的密钥**，不过不详细展开，使用 CloudHSM 您管理自己的密钥。**使用 KMS，您和亚马逊共同管理您的密钥**。AWS 确实有许多政策保障防止滥用，并且**在任何解决方案中都无法访问您的密钥**。主要区别在于合规性，因为它涉及到密钥所有权和管理，而使用 CloudHSM，这是您管理和维护的硬件设备，只有您独家访问。

### CloudHSM 建议

1. 始终在**高可用性（HA）设置**中部署 CloudHSM，至少在**不同的可用区**中部署两台设备，如果可能的话，在 AWS 的另一个区域或本地部署第三台。
2. 在**初始化** **CloudHSM** 时要小心。此操作**将销毁密钥**，因此要么有另一份密钥的副本，要么绝对确保您不需要，也永远不会需要这些密钥来解密任何数据。
3. CloudHSM 仅**支持特定版本的固件**和软件。在执行任何更新之前，请确保 AWS 支持固件和/或软件。如果升级指南不清楚，您可以随时联系 AWS 支持以验证。
4. **网络配置绝不应更改。** 记住，它位于 AWS 数据中心，AWS 正在为您监控基础硬件。这意味着如果硬件出现故障，他们将为您更换，但前提是他们知道它出现了故障。
5. **SysLog 转发不应被移除或更改**。您始终可以**添加** SysLog 转发器，将日志定向到您自己的收集工具。
6. **SNMP** 配置与网络和 SysLog 文件夹有相同的基本限制。这**不应更改或移除**。添加额外的 SNMP 配置是可以的，只要确保您没有更改已经在设备上的配置。
7. AWS 的另一个有趣的最佳实践是**不要更改 NTP 配置**。如果您这样做会发生什么并不清楚，因此请记住，如果您不使用与解决方案其余部分相同的 NTP 配置，那么您可能会有两个时间源。只要意识到这一点，并知道 CloudHSM 必须保持现有的 NTP 来源。

CloudHSM 的初始启动费用为 5,000 美元，用于分配专门为您使用的硬件设备，然后是与运行 CloudHSM 相关的每小时费用，目前为每小时运行 1.88 美元，或大约每月 1,373 美元。

使用 CloudHSM 的最常见原因是您必须满足合规标准，出于监管原因。**KMS 不支持非对称密钥的数据支持。CloudHSM 允许您安全地存储非对称密钥**。
**公钥在配置期间安装在HSM设备上**，以便您可以通过SSH访问CloudHSM实例。

### 什么是硬件安全模块

硬件安全模块（HSM）是一个专用的加密设备，用于生成、存储和管理加密密钥以及保护敏感数据。它旨在通过物理和电子隔离加密功能与系统的其他部分，提供高水平的安全性。

HSM的工作方式可能会根据具体型号和制造商而有所不同，但通常会发生以下步骤：

1. **密钥生成**：HSM使用安全的随机数生成器生成一个随机加密密钥。
2. **密钥存储**：密钥**安全地存储在HSM内部，只能由授权用户或进程访问**。
3. **密钥管理**：HSM提供一系列密钥管理功能，包括密钥轮换、备份和撤销。
4. **加密操作**：HSM执行一系列加密操作，包括加密、解密、数字签名和密钥交换。这些操作是**在HSM的安全环境内执行的**，以防止未授权访问和篡改。
5. **审计日志**：HSM记录所有加密操作和访问尝试，可用于合规性和安全审计目的。

HSM可用于广泛的应用，包括安全在线交易、数字证书、安全通信和数据加密。它们通常用于需要高安全级别的行业，如金融、医疗保健和政府。

总体而言，HSM提供的高安全级别使得**从中提取原始密钥非常困难，尝试这样做通常被视为安全性的破坏**。然而，在**某些情况下**，可能会由授权人员**提取原始密钥**，用于特定目的，例如在密钥恢复程序中。

### 枚举
```
```
<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
