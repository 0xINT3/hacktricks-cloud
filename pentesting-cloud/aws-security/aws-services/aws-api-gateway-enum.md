# AWS - API Gateway 枚举

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## API Gateway

### 基本信息

AWS API Gateway 是由亚马逊网络服务（AWS）提供的全托管服务，允许您以任何规模创建、发布、维护、监控和保护 **API（应用程序编程接口）**。API Gateway 充当应用程序访问后端服务（如运行在 Amazon Elastic Compute Cloud（**EC2**）、AWS **Lambda** 或任何 **Web 应用程序**上的工作负载）的 **"前门"**。

API Gateway 可以定义 **如何处理对 API 的请求**，并且可以创建具有特定方法（例如 GET、POST、PUT、DELETE）和资源的自定义 API 端点。它还可以生成客户端 SDK（软件开发工具包），以便开发人员可以更轻松地从其应用程序调用您的 API。

### API Gateway 类型

* **HTTP API**：使用内置功能（如 OIDC 和 OAuth2）和本地 CORS 支持构建低延迟和成本效益的 REST API。适用于以下内容：Lambda、HTTP 后端。
* **WebSocket API**：使用持久连接构建 WebSocket API，用于实时使用案例，如聊天应用程序或仪表板。适用于以下内容：Lambda、HTTP、AWS 服务。
* **REST API**：开发 REST API，可以完全控制请求和响应，以及 API 管理功能。适用于以下内容：Lambda、HTTP、AWS 服务。
* **REST API Private**：创建仅可从 VPC 内部访问的 REST API。

### API Gateway 主要组件

1. **资源**：在 API Gateway 中，资源是构成 API 结构的组件。它们代表 API 的不同路径或端点，并对应于 API 支持的各种操作。资源是每个路径（/、/users 或 /user/{id}）中的每个方法（例如 GET、POST、PUT、DELETE）。
2. **阶段**：API Gateway 中的阶段表示 API 的不同版本或环境，例如开发、暂存或生产。您可以使用阶段来管理和部署 **多个版本的 API**，从而可以在不影响生产环境的情况下测试新功能或错误修复。阶段还支持 **阶段变量**，它们是可以用于根据当前阶段配置 API 行为的键值对。例如，您可以使用阶段变量根据阶段将 API 请求定向到不同的 Lambda 函数或其他后端服务。
* 阶段在 API Gateway 端点的 URL 开头指示。
3. **授权者**：API Gateway 中的授权者负责通过验证调用者的身份来控制对 API 的访问。您可以使用 **AWS Lambda 函数**作为自定义授权者，从而可以实现自己的身份验证和授权逻辑。当请求进入时，API Gateway 将请求的授权令牌传递给 Lambda 授权者，后者处理令牌并返回确定调用者允许执行的操作的 IAM 策略。API Gateway 还支持 **内置授权者**，例如 **AWS Identity and Access Management（IAM）** 和 **Amazon Cognito**。
4. **资源策略**：API Gateway 中的资源策略是一个 JSON 文档，用于 **定义访问 API 的权限**。它类似于 IAM 策略，但专门针对 API Gateway 进行了调整。您可以使用资源策略来控制谁可以访问您的 API，他们可以调用哪些方法，以及他们可以连接到哪些 IP 地址或 VPC。**资源策略可以与授权者结合使用**，为您的 API 提供细粒度的访问控制。
* 在修改资源策略后，需要重新部署 API 才能生效。

### 日志记录

默认情况下，**CloudWatch Logs** 处于关闭状态，**访问日志记录** 处于关闭状态，**X-Ray 追踪** 也处于关闭状态。

### 枚举
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws --profile myadmin --region eu-west-1 apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
## 访问API Gateway端点的不同授权方式

### 资源策略

可以使用资源策略来定义谁可以调用API端点。在下面的示例中，您可以看到**指定的IP无法通过GET调用**端点`/resource_policy`。

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM授权者

可以设置路径（资源）内的方法需要IAM身份验证才能调用。

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

当设置了这个选项后，如果您尝试在没有任何授权的情况下访问端点，您将收到错误消息`{"message":"Missing Authentication Token"}`。

生成应用程序所期望的令牌的一种简单方法是在**Postman**中使用**`Authorization`**类型**`AWS Signature`**。

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

设置要使用的帐户的accessKey和SecretKey，然后您就可以对API端点进行身份验证。

它将生成一个名为**Authorization**的**header**，例如：
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
请注意，在其他情况下，**授权者（Authorizer）**可能已经**编码不当**，只要在**授权头（Authorization header）**中发送**任何内容**，就可以**查看隐藏的内容**。

### 自定义 Lambda 授权者（Authorizer）

可以使用基于给定令牌的 Lambda 函数，根据令牌**返回一个 IAM 策略**，指示用户是否**有权调用 API 端点**。\
您可以设置将使用授权者的每个资源方法。

<details>

<summary>Lambda 授权者代码示例</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

使用类似以下命令调用：

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
根据Lambda代码的不同，此授权可能存在漏洞
{% endhint %}

请注意，如果生成并返回了**拒绝策略**，API Gateway返回的错误是：`{"Message":"User is not authorized to access this resource with an explicit deny"}`

通过这种方式，您可以**识别此授权**是否已经生效。

### 需要 API 密钥

可以设置需要**有效 API 密钥**才能访问的 API 端点。

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

可以在 API Gateway 门户中生成 API 密钥，甚至可以设置其使用量（每秒请求数和每月请求数）。

要使 API 密钥起作用，您需要将其添加到**使用计划**中，此使用计划必须添加到**API 阶段**中，并且相关联的 API 阶段需要为需要 API 密钥的**端点**配置**方法限制**：

<figure><img src="../../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

## 未经身份验证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## 提权

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## 后渗透

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### 持久化

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
