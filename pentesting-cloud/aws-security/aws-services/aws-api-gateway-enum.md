# AWS - Wymienianie API Gateway

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## API Gateway

### Podstawowe informacje

AWS API Gateway to kompleksowa usługa oferowana przez Amazon Web Services (AWS), przeznaczona dla programistów do **tworzenia, publikowania i nadzorowania interfejsów API na dużą skalę**. Funkcjonuje jako punkt wejścia do aplikacji, pozwalając programistom ustanowić ramy reguł i procedur. Te ramy regulują dostęp, jaki zewnętrzni użytkownicy mają do określonych danych lub funkcji w aplikacji.

API Gateway umożliwia zdefiniowanie **sposobu obsługi żądań do Twoich interfejsów API**, może tworzyć niestandardowe punkty końcowe interfejsu API z określonymi metodami (np. GET, POST, PUT, DELETE) i zasobami. Może również generować zestawy SDK klienta (Software Development Kits), aby ułatwić programistom wywoływanie Twoich interfejsów API z ich aplikacji.

### Typy bram interfejsu API

* **API HTTP**: Buduj niskopoziomowe i opłacalne interfejsy REST z wbudowanymi funkcjami takimi jak OIDC i OAuth2 oraz natywnym wsparciem dla CORS. Działa z następującymi: Lambda, backendami HTTP.
* **API WebSocket**: Buduj interfejs WebSocket z użyciem trwałych połączeń do zastosowań czasu rzeczywistego, takich jak aplikacje czatowe lub panele. Działa z następującymi: Lambda, HTTP, Usługami AWS.
* **API REST**: Opracuj interfejs REST, w którym zyskujesz pełną kontrolę nad żądaniem i odpowiedzią wraz z możliwościami zarządzania interfejsem API. Działa z następującymi: Lambda, HTTP, Usługami AWS.
* **Prywatne API REST**: Utwórz interfejs REST, który jest dostępny tylko z wewnątrz VPC.

### Główne składniki bramy API

1. **Zasoby**: W API Gateway zasoby to komponenty, które **tworzą strukturę Twojego interfejsu API**. Reprezentują **różne ścieżki lub punkty końcowe** Twojego interfejsu API i odpowiadają różnym działaniom, które obsługuje Twoje interfejs API. Zasób to każda metoda (np. GET, POST, PUT, DELETE) **wewnątrz każdej ścieżki** (/, lub /users, lub /user/{id}).
2. **Etap**: Etapy w API Gateway reprezentują **różne wersje lub środowiska** Twojego interfejsu API, takie jak rozwój, staging lub produkcja. Możesz używać etapów do zarządzania i wdrażania **wielu wersji Twojego interfejsu jednocześnie**, pozwalając na testowanie nowych funkcji lub poprawek błędów bez wpływu na środowisko produkcyjne. Etapy obsługują również **zmienne etapowe**, które są parami klucz-wartość, które można użyć do konfigurowania zachowania Twojego interfejsu API na podstawie bieżącego etapu. Na przykład można użyć zmiennych etapowych do kierowania żądań interfejsu API do różnych funkcji Lambda lub innych usług backendowych w zależności od etapu.
* Etap jest wskazany na początku adresu URL punktu końcowego bramy API.
3. **Autoryzatory**: Autoryzatory w API Gateway są odpowiedzialne za **kontrolę dostępu do Twojego interfejsu API** poprzez weryfikację tożsamości osoby dzwoniącej przed zezwoleniem na kontynuację żądania. Możesz używać **funkcji AWS Lambda** jako autoryzatorów niestandardowych, co pozwala na zaimplementowanie własnej logiki uwierzytelniania i autoryzacji. Gdy wpłynie żądanie, API Gateway przekazuje token autoryzacji żądania do autoryzatora Lambda, który przetwarza token i zwraca politykę IAM, która określa, jakie działania osoba dzwoniąca ma zezwolenie na wykonanie. API Gateway obsługuje również **wbudowane autoryzatory**, takie jak **AWS Identity and Access Management (IAM)** i **Amazon Cognito**.
4. **Polityka zasobu**: Polityka zasobu w API Gateway to dokument JSON, który **definiuje uprawnienia dostępu do Twojego interfejsu API**. Jest podobna do polityki IAM, ale specjalnie dostosowana do API Gateway. Możesz użyć polityki zasobu do kontrolowania, kto może uzyskać dostęp do Twojego interfejsu API, jakie metody mogą wywołać i z jakich adresów IP lub VPC mogą się połączyć. **Polityki zasobów można używać w połączeniu z autoryzatorami**, aby zapewnić precyzyjną kontrolę dostępu do Twojego interfejsu API.
* Aby zastosować zmiany, API musi zostać **ponownie wdrożone po** zmodyfikowaniu polityki zasobu.

### Logowanie

Domyślnie **dzienniki CloudWatch** są **wyłączone**, **Logowanie dostępu** jest **wyłączone**, a **śledzenie X-Ray** również jest **wyłączone**.

### Wymienianie

{% hint style="success" %}
Zauważ, że w obu interfejsach API AWS do wymieniania zasobów (**`apigateway`** i **`apigatewayv2`**) jedyną wymaganą uprawnieniem i jedynym uprawnieniem do odczytu, które można udzielić, jest **`apigateway:GET`**, dzięki czemu można **wymieniać wszystko**.
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}Wyniki testu wykrywania usługi AWS API Gateway v2:
- Wersja: {version}
- Nazwa usługi: {service_name}
- Region: {region}
- ID użytkownika: {account_id}
- Konfiguracja: {configuration}
- Opcje: {options}
- Zasoby: {resources}
- Autoryzacja: {authorization}
- Integracje: {integrations}
- Wersje: {versions}
- Wersje etapów: {stage_versions}
- Wersje integracji: {integration_versions}
- Wersje autoryzacji: {authorization_versions}
- Wersje zasobów: {resource_versions}
- Wersje konfiguracji: {configuration_versions}
- Wersje opcji: {options_versions}
- Wersje planu: {plan_versions}
- Wersje mapy tras: {route_map_versions}
- Wersje modelu: {model_versions}
- Wersje dokumentacji: {documentation_versions}
- Wersje domeny: {domain_versions}
- Wersje monitorowania: {monitoring_versions}
- Wersje logowania: {logging_versions}
- Wersje metryk: {metrics_versions}
- Wersje certyfikatów: {certificate_versions}
- Wersje zarządzania dostępem: {access_management_versions}
- Wersje zabezpieczeń: {security_versions}
- Wersje audytu: {audit_versions}
- Wersje ochrony przed atakami: {waf_versions}
- Wersje ochrony przed botami: {bot_protection_versions}
- Wersje zgodności: {compliance_versions}
- Wersje polityki: {policy_versions}
- Wersje ograniczeń: {quota_versions}
- Wersje monitorowania wydajności: {performance_monitoring_versions}
- Wersje testów: {testing_versions}
- Wersje migracji: {migration_versions}
- Wersje rozliczeń: {billing_versions}
- Wersje rozwiązań: {solution_versions}
- Wersje wsparcia: {support_versions}
- Wersje dokumentacji API: {api_documentation_versions}
- Wersje SDK: {sdk_versions}
- Wersje CLI: {cli_versions}
- Wersje interfejsu użytkownika: {ui_versions}
- Wersje integracji z innymi usługami: {other_service_integration_versions}
- Wersje integracji z zewnętrznymi systemami: {external_system_integration_versions}
- Wersje integracji z aplikacjami mobilnymi: {mobile_app_integration_versions}
- Wersje integracji z aplikacjami webowymi: {web_app_integration_versions}
- Wersje integracji z IoT: {iot_integration_versions}
- Wersje integracji z bazami danych: {database_integration_versions}
- Wersje integracji z usługami chmurowymi: {cloud_service_integration_versions}
- Wersje integracji z narzędziami deweloperskimi: {dev_tool_integration_versions}
- Wersje integracji z systemami monitorowania: {monitoring_system_integration_versions}
- Wersje integracji z systemami zarządzania tożsamością: {identity_management_integration_versions}
- Wersje integracji z systemami płatności: {payment_system_integration_versions}
- Wersje integracji z systemami CRM: {crm_integration_versions}
- Wersje integracji z systemami e-commerce: {ecommerce_integration_versions}
- Wersje integracji z systemami marketingowymi: {marketing_integration_versions}
- Wersje integracji z systemami analitycznymi: {analytics_integration_versions}
- Wersje integracji z systemami raportowania: {reporting_integration_versions}
- Wersje integracji z systemami biznesowymi: {business_system_integration_versions}
- Wersje integracji z systemami ERP: {erp_integration_versions}
- Wersje integracji z systemami HR: {hr_integration_versions}
- Wersje integracji z systemami SCM: {scm_integration_versions}
- Wersje integracji z systemami logistycznymi: {logistics_integration_versions}
- Wersje integracji z systemami IoT: {iot_system_integration_versions}
- Wersje integracji z systemami AI: {ai_integration_versions}
- Wersje integracji z systemami ML: {ml_integration_versions}
- Wersje integracji z systemami Big Data: {big_data_integration_versions}
- Wersje integracji z systemami blockchain: {blockchain_integration_versions}
- Wersje integracji z systemami security: {security_integration_versions}
- Wersje integracji z systemami compliance: {compliance_integration_versions}
- Wersje integracji z systemami monitoring: {monitoring_integration_versions}
- Wersje integracji z systemami backup: {backup_integration_versions}
- Wersje integracji z systemami disaster recovery: {disaster_recovery_integration_versions}
- Wersje integracji z systemami networking: {networking_integration_versions}
- Wersje integracji z systemami CDN: {cdn_integration_versions}
- Wersje integracji z systemami DNS: {dns_integration_versions}
- Wersje integracji z systemami firewall: {firewall_integration_versions}
- Wersje integracji z systemami load balancing: {load_balancing_integration_versions}
- Wersje integracji z systemami VPN: {vpn_integration_versions}
- Wersje integracji z systemami proxy: {proxy_integration_versions}
- Wersje integracji z systemami WAF: {waf_integration_versions}
- Wersje integracji z systemami antywirusowymi: {antivirus_integration_versions}
- Wersje integracji z systemami antymalware: {antimalware_integration_versions}
- Wersje integracji z systemami IDS/IPS: {ids_ips_integration_versions}
- Wersje integracji z systemami SIEM: {siem_integration_versions}
- Wersje integracji z systemami SOC: {soc_integration_versions}
- Wersje integracji z systemami threat intelligence: {threat_intelligence_integration_versions}
- Wersje integracji z systemami encryption: {encryption_integration_versions}
- Wersje integracji z systemami tokenization: {tokenization_integration_versions}
- Wersje integracji z systemami PKI: {pki_integration_versions}
- Wersje integracji z systemami IAM: {iam_integration_versions}
- Wersje integracji z systemami MFA: {mfa_integration_versions}
- Wersje integracji z systemami SSO: {sso_integration_versions}
- Wersje integracji z systemami DLP: {dlp_integration_versions}
- Wersje integracji z systemami CASB: {casb_integration_versions}
- Wersje integracji z systemami secure email gateway: {secure_email_gateway_integration_versions}
- Wersje integracji z systemami secure web gateway: {secure_web_gateway_integration_versions}
- Wersje integracji z systemami secure access service edge: {sase_integration_versions}
- Wersje integracji z systemami secure DNS: {secure_dns_integration_versions}
- Wersje integracji z systemami secure web application firewall: {secure_web_application_firewall_integration_versions}
- Wersje integracji z systemami secure API gateway: {secure_api_gateway_integration_versions}
- Wersje integracji z systemami secure database: {secure_database_integration_versions}
- Wersje integracji z systemami secure storage: {secure_storage_integration_versions}
- Wersje integracji z systemami secure network: {secure_network_integration_versions}
- Wersje integracji z systemami secure endpoint: {secure_endpoint_integration_versions}
- Wersje integracji z systemami secure cloud: {secure_cloud_integration_versions}
- Wersje integracji z systemami secure container: {secure_container_integration_versions}
- Wersje integracji z systemami secure virtualization: {secure_virtualization_integration_versions}
- Wersje integracji z systemami secure DevOps: {secure_devops_integration_versions}
- Wersje integracji z systemami secure IoT: {secure_iot_integration_versions}
- Wersje integracji z systemami secure AI: {secure_ai_integration_versions}
- Wersje integracji z systemami secure ML: {secure_ml_integration_versions}
- Wersje integracji z systemami secure Big Data: {secure_big_data_integration_versions}
- Wersje integracji z systemami secure blockchain: {secure_blockchain_integration_versions}
- Wersje integracji z systemami secure security: {secure_security_integration_versions}
- Wersje integracji z systemami secure compliance: {secure_compliance_integration_versions}
- Wersje integracji z systemami secure monitoring: {secure_monitoring_integration_versions}
- Wersje integracji z systemami secure backup: {secure_backup_integration_versions}
- Wersje integracji z systemami secure disaster recovery: {secure_disaster_recovery_integration_versions}
- Wersje integracji z systemami secure networking: {secure_networking_integration_versions}
- Wersje integracji z systemami secure CDN: {secure_cdn_integration_versions}
- Wersje integracji z systemami secure DNS: {secure_dns_integration_versions}
- Wersje integracji z systemami secure firewall: {secure_firewall_integration_versions}
- Wersje integracji z systemami secure load balancing: {secure_load_balancing_integration_versions}
- Wersje integracji z systemami secure VPN: {secure_vpn_integration_versions}
- Wersje integracji z systemami secure proxy: {secure_proxy_integration_versions}
- Wersje integracji z systemami secure WAF: {secure_waf_integration_versions}
- Wersje integracji z systemami secure antywirusowymi: {secure_antivirus_integration_versions}
- Wersje integracji z systemami secure antymalware: {secure_antimalware_integration_versions}
- Wersje integracji z systemami secure IDS/IPS: {secure_ids_ips_integration_versions}
- Wersje integracji z systemami secure SIEM: {secure_siem_integration_versions}
- Wersje integracji z systemami secure SOC: {secure_soc_integration_versions}
- Wersje integracji z systemami secure threat intelligence: {secure_threat_intelligence_integration_versions}
- Wersje integracji z systemami secure encryption: {secure_encryption_integration_versions}
- Wersje integracji z systemami secure tokenization: {secure_tokenization_integration_versions}
- Wersje integracji z systemami secure PKI: {secure_pki_integration_versions}
- Wersje integracji z systemami secure IAM: {secure_iam_integration_versions}
- Wersje integracji z systemami secure MFA: {secure_mfa_integration_versions}
- Wersje integracji z systemami secure SSO: {secure_sso_integration_versions}
- Wersje integracji z systemami secure DLP: {secure_dlp_integration_versions}
- Wersje integracji z systemami secure CASB: {secure_casb_integration_versions}
- Wersje integracji z systemami secure secure email gateway: {secure_secure_email_gateway_integration_versions}
- Wersje integracji z systemami secure secure web gateway: {secure_secure_web_gateway_integration_versions}
- Wersje integracji z systemami secure secure access service edge: {secure_sase_integration_versions}
- Wersje integracji z systemami secure secure DNS: {secure_secure_dns_integration_versions}
- Wersje integracji z systemami secure secure web application firewall: {secure_secure_web_application_firewall_integration_versions}
- Wersje integracji z systemami secure secure API gateway: {secure_secure_api_gateway_integration_versions}
- Wersje integracji z systemami secure secure database: {secure_secure_database_integration_versions}
- Wersje integracji z systemami secure secure storage: {secure_secure_storage_integration_versions}
- Wersje integracji z systemami secure secure network: {secure_secure_network_integration_versions}
- Wersje integracji z systemami secure secure endpoint: {secure_secure_endpoint_integration_versions}
- Wersje integracji z systemami secure secure cloud: {secure_secure_cloud_integration_versions}
- Wersje integracji z systemami secure secure container: {secure_secure_container_integration_versions}
- Wersje integracji z systemami secure secure virtualization: {secure_secure_virtualization_integration_versions}
- Wersje integracji z systemami secure secure DevOps: {secure_secure_devops_integration_versions}
- Wersje integracji z systemami secure secure IoT: {secure_secure_iot_integration_versions}
- Wersje integracji z systemami secure secure AI: {secure_secure_ai_integration_versions}
- Wersje integracji z systemami secure secure ML: {secure_secure_ml_integration_versions}
- Wersje integracji z systemami secure secure Big Data: {secure_secure_big_data_integration_versions}
- Wersje integracji z systemami secure secure blockchain: {secure_secure_blockchain_integration_versions}
- Wersje integracji z systemami secure secure security: {secure_secure_security_integration_versions}
- Wersje integracji z systemami secure secure compliance: {secure_secure_compliance_integration_versions}
- Wersje integracji z systemami secure secure monitoring: {secure_secure_monitoring_integration_versions}
- Wersje integracji z systemami secure secure backup: {secure_secure_backup_integration_versions}
- Wersje integracji z systemami secure secure disaster recovery: {secure_secure_disaster_recovery_integration_versions}
- Wersje integracji z systemami secure secure networking: {secure_secure_networking_integration_versions}
- Wersje integracji z systemami secure secure CDN: {secure_secure_cdn_integration_versions}
- Wersje integracji z systemami secure secure DNS: {secure_secure_dns_integration_versions}
- Wersje integracji z systemami secure secure firewall: {secure_secure_firewall_integration_versions}
- Wersje integracji z systemami secure secure load balancing: {secure_secure_load_balancing_integration_versions}
- Wersje integracji z systemami secure secure VPN: {secure_secure_vpn_integration_versions}
- Wersje integracji z systemami secure secure proxy: {secure_secure_proxy_integration_versions}
- Wersje integracji z systemami secure secure WAF: {secure_secure_waf_integration_versions}
- Wersje integracji z systemami secure secure antywirusowymi: {secure_secure_antivirus_integration_versions}
- Wersje integracji z systemami secure secure antymalware: {secure_secure_antimalware_integration_versions}
- Wersje integracji z systemami secure secure IDS/IPS: {secure_secure_ids_ips_integration_versions}
- Wersje integracji z systemami secure secure SIEM: {secure_secure_siem_integration_versions}
- Wersje integracji z systemami secure secure SOC: {secure_secure_soc_integration_versions}
- Wersje integracji z systemami secure secure threat intelligence: {secure_secure_threat_intelligence_integration_versions}
- Wersje integracji z systemami secure secure encryption: {secure_secure_encryption_integration_versions}
- Wersje integracji z systemami secure secure tokenization: {secure_secure_tokenization_integration_versions}
- Wersje integracji z systemami secure secure PKI: {secure_secure_pki_integration_versions}
- Wersje integracji z systemami secure secure IAM: {secure_secure_iam_integration_versions}
- Wersje integracji z systemami secure secure MFA: {secure_secure_mfa_integration_versions}
- Wersje integracji z systemami secure secure SSO: {secure_secure_sso_integration_versions}
- Wersje integracji z systemami secure secure DLP: {secure_secure_dlp_integration_versions}
- Wersje integracji z systemami secure secure CASB: {secure_secure_casb_integration_versions}
- Wersje integracji z systemami secure secure secure email gateway: {secure_secure_secure_email_gateway_integration_versions}
- Wersje integracji z systemami secure secure secure web gateway: {secure_secure_secure_web_gateway_integration_versions}
- Wersje integracji z systemami secure secure secure access service edge: {secure_secure_sase_integration_versions}
- Wersje integracji z systemami secure secure secure DNS: {secure_secure_secure_dns_integration_versions}
- Wersje integracji z systemami secure secure secure web application firewall: {secure_secure_secure_web_application_firewall_integration_versions}
- Wersje integracji z systemami secure secure secure API gateway: {secure_secure_secure_api_gateway_integration_versions}
- Wersje integracji z systemami secure secure secure database: {secure_secure_secure_database_integration_versions}
- Wersje integracji z systemami secure secure secure storage: {secure_secure_secure_storage_integration_versions}
- Wersje integracji z systemami secure secure secure network: {secure_secure_secure_network_integration_versions}
- Wersje integracji z systemami secure secure secure endpoint: {secure_secure_secure_endpoint_integration_versions}
- Wersje integracji z systemami secure secure secure cloud: {secure_secure_secure_cloud_integration_versions}
- Wersje integracji z systemami secure secure secure container: {secure_secure_secure_container_integration_versions}
- Wersje integracji z systemami secure secure secure virtualization: {secure_secure_secure_virtualization_integration_versions}
- Wersje integracji z systemami secure secure secure DevOps: {secure_secure_secure_devops_integration_versions}
- Wersje integracji z systemami secure secure secure IoT: {secure_secure_secure_iot_integration_versions}
- Wersje integracji z systemami secure secure secure AI: {secure_secure_secure_ai_integration_versions}
- Wersje integracji z systemami secure secure secure ML: {secure_secure_secure_ml_integration_versions}
- Wersje integracji z systemami secure secure secure
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
## Różne uprawnienia do dostępu do punktów końcowych bramy API

### Polityka zasobów

Można użyć polityk zasobów do określenia, kto może wywołać punkty końcowe API.\
W poniższym przykładzie można zobaczyć, że **wskazany adres IP nie może wywołać** punktu końcowego `/resource_policy` za pomocą metody GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Autoryzator IAM

Można ustawić, że metody wewnątrz ścieżki (zasobu) wymagają uwierzytelnienia IAM, aby je wywołać.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Gdy to jest ustawione, otrzymasz błąd `{"message":"Brak tokenu uwierzytelniającego"}` gdy spróbujesz dotrzeć do punktu końcowego bez żadnej autoryzacji.

Jednym prostym sposobem na wygenerowanie oczekiwanego tokenu przez aplikację jest użycie typu **`Authorization`** **`Podpis AWS`** w **Postmanie**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Ustaw dostęp do klucza i klucza prywatnego konta, którego chcesz użyć, i możesz uwierzytelniać się przeciwko punktowi końcowemu API.

Wygeneruje to **nagłówek autoryzacji** taki jak:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Zauważ, że w innych przypadkach **Autoryzator** mógł zostać **źle zakodowany** i wysłanie **czegokolwiek** w nagłówku **Autoryzacji** pozwoli zobaczyć ukrytą zawartość.

### Podpisywanie żądania za pomocą Pythona
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Niestandardowy autoryzator Lambda

Istnieje możliwość użycia funkcji lambda, która na podstawie określonego tokena **zwróci politykę IAM**, wskazującą, czy użytkownik jest **uprawniony do wywołania punktu końcowego interfejsu API**.\
Można ustawić każdą metodę zasobu, która będzie korzystać z autoryzatora.

<details>

<summary>Przykład kodu autoryzatora Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Wywołaj to coś w ten sposób:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
W zależności od kodu Lambda, ta autoryzacja może być podatna
{% endhint %}

Zauważ, że jeśli **została wygenerowana i zwrócona polityka odrzucenia**, błąd zwrócony przez bramę API to: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

W ten sposób można **zidentyfikować tę autoryzację**.

### Wymagany klucz API

Możliwe jest ustawienie punktów końcowych API, które **wymagają poprawnego klucza API** do kontaktu.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Możliwe jest generowanie kluczy API w portalu Bramy API i nawet ustawienie, ile może być używane (pod względem żądań na sekundę i pod względem żądań na miesiąc).

Aby klucz API działał, musisz dodać go do **Planu Użycia**, ten plan użycia musi być dodany do **Etapu API** i powiązany etap API musi mieć skonfigurowane **ograniczenie metod** do **punktu końcowego** wymagającego klucza API:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Nieuwierzytelniony dostęp

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Przywileje

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Po eksploatacji

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Trwałość

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
