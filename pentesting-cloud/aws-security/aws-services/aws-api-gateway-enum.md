# AWS - √ânum√©ration de l'API Gateway

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## API Gateway

### Informations de base

AWS API Gateway est un service enti√®rement g√©r√© fourni par Amazon Web Services (AWS) qui vous permet de cr√©er, publier, maintenir, surveiller et s√©curiser **les API (Interfaces de Programmation d'Applications) √† n'importe quelle √©chelle**. API Gateway agit comme une **"porte d'entr√©e"** pour les applications pour acc√©der aux donn√©es, √† la logique m√©tier ou aux fonctionnalit√©s de vos services backend, tels que les charges de travail ex√©cut√©es sur Amazon Elastic Compute Cloud (**EC2**), AWS **Lambda**, ou toute **application web**.

API Gateway vous permet de d√©finir **comment les requ√™tes vers vos API doivent √™tre trait√©es**, et il peut cr√©er des points de terminaison API personnalis√©s avec des m√©thodes sp√©cifiques (par exemple, GET, POST, PUT, DELETE) et des ressources. Il peut √©galement g√©n√©rer des SDK clients (Kits de D√©veloppement Logiciel) pour faciliter l'appel de vos API par les d√©veloppeurs depuis leurs applications.

### Types d'API Gateway

* **HTTP API** : Construisez des API REST √† faible latence et √©conomiques avec des fonctionnalit√©s int√©gr√©es telles que OIDC et OAuth2, et un support CORS natif. Fonctionne avec les suivants : Lambda, backends HTTP.
* **WebSocket API** : Construisez une API WebSocket utilisant des connexions persistantes pour des cas d'utilisation en temps r√©el tels que les applications de chat ou les tableaux de bord. Fonctionne avec les suivants : Lambda, HTTP, Services AWS.
* **REST API** : D√©veloppez une API REST o√π vous avez un contr√¥le total sur la requ√™te et la r√©ponse ainsi que sur les capacit√©s de gestion des API. Fonctionne avec les suivants : Lambda, HTTP, Services AWS.
* **REST API Priv√©e** : Cr√©ez une API REST qui n'est accessible que depuis un VPC.

### Composants principaux de l'API Gateway

1. **Ressources** : Dans API Gateway, les ressources sont les composants qui **constituent la structure de votre API**. Elles repr√©sentent **les diff√©rents chemins ou points de terminaison** de votre API et correspondent aux diverses actions que votre API prend en charge. Une ressource est chaque m√©thode (par exemple, GET, POST, PUT, DELETE) **√† l'int√©rieur de chaque chemin** (/, ou /users, ou /user/{id}).
2. **√âtapes** : Les √©tapes dans API Gateway repr√©sentent **diff√©rentes versions ou environnements** de votre API, tels que le d√©veloppement, la pr√©production ou la production. Vous pouvez utiliser les √©tapes pour g√©rer et d√©ployer **plusieurs versions de votre API simultan√©ment**, vous permettant de tester de nouvelles fonctionnalit√©s ou des corrections de bugs sans affecter l'environnement de production. Les √©tapes prennent √©galement en charge **les variables d'√©tape**, qui sont des paires cl√©-valeur qui peuvent √™tre utilis√©es pour configurer le comportement de votre API en fonction de l'√©tape actuelle. Par exemple, vous pourriez utiliser des variables d'√©tape pour diriger les requ√™tes de l'API vers diff√©rentes fonctions Lambda ou autres services backend en fonction de l'√©tape.
* L'√©tape est indiqu√©e au d√©but de l'URL du point de terminaison de l'API Gateway.
3. **Autorisateurs** : Les autorisateurs dans API Gateway sont responsables de **contr√¥ler l'acc√®s √† votre API** en v√©rifiant l'identit√© de l'appelant avant de permettre √† la requ√™te de se poursuivre. Vous pouvez utiliser **des fonctions AWS Lambda** comme autorisateurs personnalis√©s, ce qui vous permet d'impl√©menter votre propre logique d'authentification et d'autorisation. Lorsqu'une requ√™te est re√ßue, API Gateway transmet le jeton d'autorisation de la requ√™te √† l'autorisateur Lambda, qui traite le jeton et retourne une politique IAM qui d√©termine quelles actions l'appelant est autoris√© √† effectuer. API Gateway prend √©galement en charge **les autorisateurs int√©gr√©s**, tels que **AWS Identity and Access Management (IAM)** et **Amazon Cognito**.
4. **Politique de Ressource** : Une politique de ressource dans API Gateway est un document JSON qui **d√©finit les permissions d'acc√®s √† votre API**. Elle est similaire √† une politique IAM mais sp√©cifiquement adapt√©e pour API Gateway. Vous pouvez utiliser une politique de ressource pour contr√¥ler qui peut acc√©der √† votre API, quelles m√©thodes ils peuvent appeler et depuis quelles adresses IP ou VPCs ils peuvent se connecter. **Les politiques de ressources peuvent √™tre utilis√©es en combinaison avec les autorisateurs** pour fournir un contr√¥le d'acc√®s pr√©cis pour votre API.
* Afin de prendre effet, l'API doit √™tre **d√©ploy√©e √† nouveau apr√®s** la modification de la politique de ressource.

### Journalisation

Par d√©faut, les **journaux CloudWatch** sont **d√©sactiv√©s**, le **journal d'acc√®s** est **d√©sactiv√©**, et le **tra√ßage X-Ray** est √©galement **d√©sactiv√©**.

### √ânum√©ration

{% hint style="success" %}
Notez que dans les deux API AWS pour √©num√©rer les ressources (**`apigateway`** et **`apigatewayv2`**), la seule permission dont vous avez besoin et la seule permission de lecture accordable est **`apigateway:GET`**, avec cela vous pouvez **√©num√©rer tout**.
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## Diff√©rentes autorisations pour acc√©der aux points de terminaison de l'API Gateway

### Politique de ressource

Il est possible d'utiliser des politiques de ressources pour d√©finir qui peut appeler les points de terminaison de l'API.\
Dans l'exemple suivant, vous pouvez voir que **l'IP indiqu√©e ne peut pas appeler** le point de terminaison `/resource_policy` via GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Autorisateur IAM

Il est possible de d√©finir qu'une m√©thode √† l'int√©rieur d'un chemin (une ressource) n√©cessite une authentification IAM pour √™tre appel√©e.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Lorsque cela est configur√©, vous recevrez l'erreur `{"message":"Missing Authentication Token"}` lorsque vous essayez d'atteindre le point de terminaison sans aucune autorisation.

Une mani√®re simple de g√©n√©rer le jeton attendu par l'application est d'utiliser le type **`Authorization`** **`AWS Signature`** dans **Postman**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

D√©finissez l'accessKey et la SecretKey du compte que vous souhaitez utiliser et vous pouvez maintenant vous authentifier contre le point de terminaison de l'API.

Cela g√©n√©rera un **en-t√™te** **`Authorization`** tel que :
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Notez que dans d'autres cas, l'**Authorizer** pourrait avoir √©t√© **mal cod√©** et le simple fait d'envoyer **n'importe quoi** dans l'**en-t√™te d'autorisation** permettra de **voir le contenu cach√©**.

### Authorizer Lambda personnalis√©

Il est possible d'utiliser une lambda qui, en fonction d'un token donn√©, **retournera une politique IAM** indiquant si l'utilisateur est **autoris√© √† appeler le point de terminaison de l'API**.\
Vous pouvez d√©finir chaque m√©thode de ressource qui utilisera l'autorisateur.

<details>

<summary>Exemple de code d'Authorizer Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
```markdown
</details>

Appelez-le avec quelque chose comme :

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Selon le code Lambda, cette autorisation pourrait √™tre vuln√©rable
{% endhint %}

Notez que si une **politique de refus est g√©n√©r√©e et retourn√©e**, l'erreur renvoy√©e par API Gateway est : `{"Message":"User is not authorized to access this resource with an explicit deny"}`

De cette mani√®re, vous pourriez **identifier cette autorisation** en place.

### Cl√© API requise

Il est possible de configurer des points de terminaison API qui **n√©cessitent une cl√© API valide** pour √™tre contact√©s.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Il est possible de g√©n√©rer des cl√©s API dans le portail API Gateway et m√™me de d√©finir combien de fois elles peuvent √™tre utilis√©es (en termes de requ√™tes par seconde et en termes de requ√™tes par mois).

Pour qu'une cl√© API fonctionne, vous devez l'ajouter √† un **Plan d'Utilisation**, ce plan d'utilisation doit √™tre ajout√© √† l'**√âtape API** et l'√©tape API associ√©e doit avoir configur√© un **√©tranglement de m√©thode** pour le **point de terminaison** n√©cessitant la cl√© API :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Acc√®s non authentifi√©

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## √âl√©vation de privil√®ges

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post-exploitation

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Persistance

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
