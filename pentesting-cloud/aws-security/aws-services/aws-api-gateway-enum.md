# AWS - API Gateway 枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## API Gateway

### 基本信息

AWS API Gateway是由亚马逊网络服务（AWS）提供的全托管服务，允许您创建、发布、维护、监控和保护**任何规模的API（应用程序编程接口）**。API Gateway充当应用程序访问数据、业务逻辑或后端服务功能的**“前门”**，例如在亚马逊弹性计算云（**EC2**）、AWS **Lambda**或任何**网络应用程序**上运行的工作负载。

API Gateway使您能够定义**如何处理对API的请求**，并且可以创建具有特定方法（例如GET、POST、PUT、DELETE）和资源的自定义API端点。它还可以生成客户端SDK（软件开发工具包），以便开发人员更容易地从他们的应用程序调用您的API。

### API Gateway类型

* **HTTP API**：构建低延迟和成本效益的REST API，内置功能如OIDC和OAuth2，以及原生CORS支持。适用于以下：Lambda, HTTP后端。
* **WebSocket API**：使用持久连接构建WebSocket API，适用于实时用例，如聊天应用或仪表板。适用于以下：Lambda, HTTP, AWS服务。
* **REST API**：开发REST API，在请求和响应以及API管理能力方面您可以完全控制。适用于以下：Lambda, HTTP, AWS服务。
* **REST API私有**：创建仅在VPC内部可访问的REST API。

### API Gateway主要组件

1. **资源**：在API Gateway中，资源是**构成API结构的组件**。它们代表了API的**不同路径或端点**，对应于API支持的各种操作。资源是每个路径（/, 或 /users, 或 /user/{id}）**内的每个方法**（例如GET、POST、PUT、DELETE）。
2. **阶段**：API Gateway中的阶段代表了API的**不同版本或环境**，如开发、预发布或生产。您可以使用阶段来管理和部署**API的多个版本**，允许您测试新功能或错误修复而不影响生产环境。阶段还**支持阶段变量**，这些是可以用来根据当前阶段配置API行为的键值对。例如，您可以使用阶段变量将API请求引导到不同的Lambda函数或其他后端服务。
* 阶段在API Gateway端点的URL开头处指示。
3. **授权者**：API Gateway中的授权者负责**控制对API的访问**，通过在允许请求继续之前验证调用者的身份。您可以使用**AWS Lambda函数**作为自定义授权者，这允许您实现自己的认证和授权逻辑。当请求到来时，API Gateway将请求的授权令牌传递给Lambda授权者，后者处理令牌并返回一个IAM策略，决定调用者被允许执行的操作。API Gateway还支持**内置授权者**，如**AWS身份和访问管理（IAM）**和**亚马逊Cognito**。
4. **资源策略**：API Gateway中的资源策略是一个JSON文档，**定义了访问API的权限**。它类似于IAM策略，但专门为API Gateway量身定制。您可以使用资源策略来控制谁可以访问您的API，他们可以调用哪些方法，以及他们可以从哪些IP地址或VPC连接。**资源策略可以与授权者结合使用**，为您的API提供细粒度的访问控制。
* 为了使资源策略生效，修改后需要**再次部署**API。

### 日志记录

默认情况下，**CloudWatch日志**是**关闭的**，**访问日志**是**关闭的**，**X-Ray追踪**也是**关闭的**。

### 枚举

{% hint style="success" %}
请注意，在两个AWS api中枚举资源（**`apigateway`** 和 **`apigatewayv2`**）时，您需要的唯一权限和唯一可授予的读权限是 **`apigateway:GET`**，有了它您可以**枚举一切**。
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## 访问 API Gateway 端点的不同授权方式

### 资源策略

可以使用资源策略定义谁可以调用 API 端点。\
在以下示例中，您可以看到**指定的 IP 无法**通过 GET 调用端点 `/resource_policy`。

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM 授权者

可以设置在路径（一个资源）内的方法需要 IAM 认证才能调用。

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

设置此项后，如果您在没有任何授权的情况下尝试访问端点，您将收到错误 `{"message":"Missing Authentication Token"}`。

在 **Postman** 中使用 **`Authorization`** 类型 **`AWS Signature`** 是生成应用程序期望的令牌的一种简单方法。

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

设置您想要使用的账户的 accessKey 和 SecretKey，您现在可以对 API 端点进行认证。

它将生成一个如下的 **Authorization** **header**：
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
请注意，在其他情况下，**Authorizer** 可能**编码不当**，仅仅发送**任何内容**到**Authorization header**中就会**允许查看隐藏内容**。

### 自定义 Lambda Authorizer

可以使用一个 lambda 函数，基于给定的令牌，将**返回一个 IAM 策略**，指示用户是否**有权调用 API 端点**。\
您可以设置将使用授权者的每个资源方法。

<details>

<summary>Lambda Authorizer 代码示例</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
