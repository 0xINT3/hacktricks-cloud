# AWS - Enum√©ration de l'API Gateway

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## API Gateway

### Informations de base

AWS API Gateway est un service enti√®rement g√©r√© fourni par Amazon Web Services (AWS) qui vous permet de cr√©er, publier, maintenir, surveiller et s√©curiser des **API (Interfaces de programmation d'applications) √† n'importe quelle √©chelle**. API Gateway agit comme une **"porte d'entr√©e"** pour les applications afin d'acc√©der aux donn√©es, √† la logique m√©tier ou aux fonctionnalit√©s de vos services backend, tels que les charges de travail s'ex√©cutant sur Amazon Elastic Compute Cloud (**EC2**), AWS **Lambda**, ou toute **application web**.

API Gateway vous permet de d√©finir **comment les requ√™tes vers vos API doivent √™tre trait√©es**, et il peut cr√©er des points de terminaison d'API personnalis√©s avec des m√©thodes sp√©cifiques (par exemple, GET, POST, PUT, DELETE) et des ressources. Il peut √©galement g√©n√©rer des SDK client (Kits de d√©veloppement logiciel) pour faciliter l'appel de vos API par les d√©veloppeurs depuis leurs applications.

### Types de passerelles API

* **API HTTP** : Cr√©ez des API REST √† faible latence et rentables avec des fonctionnalit√©s int√©gr√©es telles que OIDC et OAuth2, et une prise en charge native de CORS. Fonctionne avec les √©l√©ments suivants : Lambda, backends HTTP.
* **API WebSocket** : Cr√©ez une API WebSocket en utilisant des connexions persistantes pour des cas d'utilisation en temps r√©el tels que les applications de chat ou les tableaux de bord. Fonctionne avec les √©l√©ments suivants : Lambda, HTTP, Services AWS.
* **API REST** : D√©veloppez une API REST o√π vous avez un contr√¥le total sur la requ√™te et la r√©ponse ainsi que des capacit√©s de gestion d'API. Fonctionne avec les √©l√©ments suivants : Lambda, HTTP, Services AWS.
* **API REST priv√©e** : Cr√©ez une API REST accessible uniquement depuis un VPC.

### Principaux composants de l'API Gateway

1. **Ressources** : Dans API Gateway, les ressources sont les composants qui **constituent la structure de votre API**. Elles repr√©sentent **les diff√©rents chemins ou points de terminaison** de votre API et correspondent aux diff√©rentes actions que votre API prend en charge. Une ressource est chaque m√©thode (par exemple, GET, POST, PUT, DELETE) **√† l'int√©rieur de chaque chemin** (/, ou /users, ou /user/{id}).
2. **Stages** : Les stages dans API Gateway repr√©sentent **diff√©rentes versions ou environnements** de votre API, tels que le d√©veloppement, la mise en sc√®ne ou la production. Vous pouvez utiliser des stages pour g√©rer et d√©ployer **plusieurs versions de votre API simultan√©ment**, ce qui vous permet de tester de nouvelles fonctionnalit√©s ou des corrections de bugs sans affecter l'environnement de production. Les stages prennent √©galement en charge les **variables de stage**, qui sont des paires cl√©-valeur pouvant √™tre utilis√©es pour configurer le comportement de votre API en fonction du stage actuel. Par exemple, vous pourriez utiliser des variables de stage pour diriger les demandes d'API vers diff√©rentes fonctions Lambda ou autres services backend en fonction du stage.
* Le stage est indiqu√© au d√©but de l'URL du point de terminaison de l'API Gateway.
3. **Authorizers** : Les authorizers dans API Gateway sont responsables de **contr√¥ler l'acc√®s √† votre API** en v√©rifiant l'identit√© de l'appelant avant de permettre √† la requ√™te de se poursuivre. Vous pouvez utiliser des **fonctions AWS Lambda** en tant qu'authorizers personnalis√©s, ce qui vous permet de mettre en ≈ìuvre votre propre logique d'authentification et d'autorisation. Lorsqu'une requ√™te arrive, API Gateway transmet le jeton d'autorisation de la requ√™te √† l'authorizer Lambda, qui traite le jeton et renvoie une strat√©gie IAM qui d√©termine les actions que l'appelant est autoris√© √† effectuer. API Gateway prend √©galement en charge des **authorizers int√©gr√©s**, tels que **AWS Identity and Access Management (IAM)** et **Amazon Cognito**.
4. **Resource Policy** : Une resource policy dans API Gateway est un document JSON qui **d√©finit les autorisations d'acc√®s √† votre API**. Elle est similaire √† une strat√©gie IAM mais sp√©cifiquement adapt√©e √† API Gateway. Vous pouvez utiliser une resource policy pour contr√¥ler qui peut acc√©der √† votre API, quelles m√©thodes ils peuvent appeler et √† partir de quelles adresses IP ou VPC ils peuvent se connecter. **Les resource policies peuvent √™tre utilis√©es en combinaison avec des authorizers** pour fournir un contr√¥le d'acc√®s granulaire pour votre API.
* Pour que les modifications de la resource policy prennent effet, l'API doit √™tre **red√©ploy√©e**.

### Journalisation

Par d√©faut, les **CloudWatch Logs** sont **d√©sactiv√©s**, la **journalisation d'acc√®s** est **d√©sactiv√©e** et la **tra√ßabilit√© X-Ray** est √©galement **d√©sactiv√©e**.

### √ânum√©ration
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws --profile myadmin --region eu-west-1 apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
## Diff√©rentes autorisations pour acc√©der aux points de terminaison de l'API Gateway

### Politique de ressources

Il est possible d'utiliser des politiques de ressources pour d√©finir qui peut appeler les points de terminaison de l'API.\
Dans l'exemple suivant, vous pouvez voir que l'**adresse IP indiqu√©e ne peut pas appeler** le point de terminaison `/resource_policy` via GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Autorisateur IAM

Il est possible de d√©finir qu'une m√©thode √† l'int√©rieur d'un chemin (une ressource) n√©cessite une authentification IAM pour l'appeler.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Lorsque cela est configur√©, vous recevrez l'erreur `{"message":"Missing Authentication Token"}` lorsque vous essayez d'atteindre le point de terminaison sans aucune autorisation.

Un moyen facile de g√©n√©rer le jeton attendu par l'application est d'utiliser le type d'**`Autorisation`** **`Signature AWS`** dans **Postman**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

D√©finissez la cl√© d'acc√®s et la cl√© secr√®te du compte que vous souhaitez utiliser et vous pourrez vous authentifier aupr√®s du point de terminaison de l'API.

Cela g√©n√©rera un **en-t√™te d'autorisation** tel que :
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Notez que dans d'autres cas, l'**Authorizer** pourrait avoir √©t√© **mal cod√©** et simplement envoyer **n'importe quoi** dans l'en-t√™te **Authorization** permettra de voir le contenu cach√©.

### Authorisateur Lambda personnalis√©

Il est possible d'utiliser une fonction lambda qui, en fonction d'un jeton donn√©, **renverra une strat√©gie IAM** indiquant si l'utilisateur est **autoris√© √† appeler le point de terminaison de l'API**.\
Vous pouvez d√©finir chaque m√©thode de ressource qui utilisera l'auteurisateur.

<details>

<summary>Exemple de code de l'Authorisateur Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Appelez-le avec quelque chose comme :

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: votre-jeton-secret'
</strong></code></pre>

{% hint style="warning" %}
Selon le code Lambda, cette autorisation pourrait √™tre vuln√©rable
{% endhint %}

Notez que si une **politique de refus est g√©n√©r√©e et renvoy√©e**, l'erreur renvoy√©e par API Gateway est : `{"Message":"User is not authorized to access this resource with an explicit deny"}`

De cette fa√ßon, vous pourriez **identifier cette autorisation** en place.

### Cl√© API requise

Il est possible de d√©finir des points de terminaison d'API qui **requi√®rent une cl√© API valide** pour y acc√©der.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Il est possible de g√©n√©rer des cl√©s API dans le portail API Gateway et m√™me de d√©finir combien elles peuvent √™tre utilis√©es (en termes de requ√™tes par seconde et en termes de requ√™tes par mois).

Pour faire fonctionner une cl√© API, vous devez l'ajouter √† un **plan d'utilisation**, ce plan d'utilisation doit √™tre ajout√© √† la **sc√®ne de l'API** et la sc√®ne de l'API associ√©e doit avoir une **limitation de m√©thode** configur√©e pour le **point de terminaison** n√©cessitant la cl√© API :

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Acc√®s non authentifi√©

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privesc

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Supportez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
