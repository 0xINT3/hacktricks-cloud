# AWS - API Gateway Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki özel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

## API Gateway

### Temel Bilgiler

AWS API Gateway, geliştiricilerin **büyük ölçekte API'ler oluşturmasına, yayınlamasına ve denetlemesine** olanak tanıyan Amazon Web Services (AWS) tarafından sunulan kapsamlı bir hizmettir. Bir uygulamanın giriş noktası olarak işlev görerek, geliştiricilere belirli verilere veya uygulama içindeki işlevlere harici kullanıcıların erişimini düzenlemek için bir kurallar ve prosedürler çerçevesi oluşturma imkanı sağlar.

API Gateway, API'lerinize gelen isteklerin **nasıl işleneceğini tanımlamanıza** olanak sağlar ve belirli yöntemlere (GET, POST, PUT, DELETE gibi) ve kaynaklara sahip özel API uç noktaları oluşturabilir. Ayrıca, geliştiricilerin uygulamalarından API'lerinizi çağırmayı kolaylaştırmak için istemci SDK'ları (Yazılım Geliştirme Kiti) oluşturabilir.

### API Gateway Türleri

* **HTTP API**: Dahili özelliklere (OIDC ve OAuth2 gibi) ve yerleşik CORS desteğine sahip, düşük gecikmeli ve maliyet etkin REST API'leri oluşturun. Aşağıdaki ile çalışır: Lambda, HTTP arka uçları.
* **WebSocket API**: Sohbet uygulamaları veya panolar gibi gerçek zamanlı kullanım durumları için kalıcı bağlantılar kullanarak WebSocket API'si oluşturun. Aşağıdaki ile çalışır: Lambda, HTTP, AWS Hizmetleri.
* **REST API**: İstek ve yanıt üzerinde tam kontrol sağlayabileceğiniz, API yönetimi yetenekleriyle bir REST API geliştirin. Aşağıdaki ile çalışır: Lambda, HTTP, AWS Hizmetleri.
* **REST API Private**: Bir VPC içinden erişilebilen bir REST API oluşturun.

### API Gateway Ana Bileşenleri

1. **Kaynaklar**: API Gateway'de kaynaklar, API'nizin yapısını oluşturan bileşenlerdir. API'nizin desteklediği çeşitli eylemlere karşılık gelen API'nizin farklı yollarını veya uç noktalarını temsil ederler. Bir kaynak, her yolun (/, veya /kullanıcılar, veya /kullanıcı/{id}) içindeki her yöntem (GET, POST, PUT, DELETE gibi) **her biridir**.
2. **Aşamalar**: API Gateway'deki aşamalar, geliştirme, aşama veya üretim gibi API'nizin **farklı sürümlerini veya ortamlarını** temsil eder. Aşamaları kullanarak API'nizin **çoklu sürümlerini eşzamanlı olarak yönetebilir ve dağıtabilirsiniz**, böylece üretim ortamını etkilemeden yeni özellikleri veya hata düzeltmelerini test edebilirsiniz. Aşamalar ayrıca **aşama değişkenlerini** destekler, mevcut aşamaya bağlı olarak API'nizin davranışını yapılandırmak için kullanılan anahtar-değer çiftleridir. Örneğin, aşama değişkenlerini kullanarak API isteklerini farklı Lambda işlevlerine veya diğer arka uç hizmetlerine yönlendirebilirsiniz.
* Aşama, API Gateway uç noktasının URL'sinin başında belirtilir.
3. **Yetkilendiriciler**: API Gateway'deki yetkilendiriciler, isteğin devam etmesine izin vermeden önce çağrının kimliğini doğrulayarak API'nize **erişimi kontrol etmekten sorumludur**. Kendi kimlik doğrulama ve yetkilendirme mantığınızı uygulamanıza olanak tanıyan **AWS Lambda işlevlerini** özel yetkilendiriciler olarak kullanabilirsiniz. Bir istek geldiğinde, API Gateway isteğin yetkilendirme belirtecinin Lambda yetkilendiricisine ileterek belirteci işler ve çağrının yapıcı tarafından gerçekleştirilebilecek eylemleri belirleyen bir IAM politikası döndürür. API Gateway ayrıca **dahili yetkilendiricileri** destekler, örneğin **AWS Kimlik ve Erişim Yönetimi (IAM)** ve **Amazon Cognito**.
4. **Kaynak Politikası**: API Gateway'deki kaynak politikası, API'nize erişim izinlerini tanımlayan bir JSON belgesidir. IAM politikasına benzer, ancak özel olarak API Gateway için uyarlanmış bir kaynak politikasıdır. Bir kaynak politikası kullanarak API'nize kimlerin erişebileceğini, hangi yöntemleri çağırabileceklerini ve hangi IP adreslerinden veya VPC'lerden bağlantı kurabileceklerini kontrol edebilirsiniz. **Kaynak politikaları, yetkilendiricilerle birlikte kullanılabilir** ve API'nize incelemeli erişim kontrolü sağlar.
* Kaynak politikası değiştirildikten sonra etkili olması için API'nin **yeniden dağıtılması gerekir**.

### Günlükleme

Varsayılan olarak, **CloudWatch Günlükleri** kapalıdır, **Erişim Günlüğü** kapalıdır ve **X-Ray izlemesi** de kapalıdır.

### Enumerasyon

{% hint style="success" %}
AWS api'lerinde kaynakları listelemek için (**`apigateway`** ve **`apigatewayv2`**) ihtiyacınız olan tek izin ve okuma izni **`apigateway:GET`**'dir, bu izinle **her şeyi listeleyebilirsiniz**.
{% endhint %}

{% tabs %}
{% tab title="apigateway" %}
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% tab title="apigatewayv2" %}apigatewayv2 için enumarasyon teknikleri:

1. **API Gateway API'lerini Listeleyin**: `aws apigatewayv2 get-apis` komutunu kullanarak mevcut API'leri listeleyebilirsiniz.

2. **API Gateway API'sini Ayrıntılarıyla Görüntüleyin**: `aws apigatewayv2 get-api --api-id <api-id>` komutunu kullanarak belirli bir API'nin ayrıntılarını görüntüleyebilirsiniz.

3. **API Gateway API'sini Yayınla**: `aws apigatewayv2 create-deployment --api-id <api-id> --stage-name <stage-name>` komutunu kullanarak bir API'yi belirli bir aşamada yayınlayabilirsiniz.

4. **API Gateway API'sini Silin**: `aws apigatewayv2 delete-api --api-id <api-id>` komutunu kullanarak bir API'yi silme işlemi gerçekleştirebilirsiniz.

5. **API Gateway API'sini Güncelleyin**: `aws apigatewayv2 update-api --api-id <api-id> --name <new-name>` komutunu kullanarak bir API'nin adını güncelleyebilirsiniz.

6. **API Gateway API'sini Yeniden Dağıtın**: `aws apigatewayv2 update-stage --api-id <api-id> --stage-name <stage-name>` komutunu kullanarak bir API'nin belirli bir aşamasını yeniden dağıtabilirsiniz.

7. **API Gateway API'sini İzleyin**: `aws apigatewayv2 get-stages --api-id <api-id>` komutunu kullanarak bir API'nin aşamalarını izleyebilirsiniz.

8. **API Gateway API'sini Test Edin**: `aws apigatewayv2 test-invoke-method --api-id <api-id> --route-id <route-id> --stage-name <stage-name>` komutunu kullanarak bir API'nin belirli bir rotasını test edebilirsiniz.

9. **API Gateway API'sini İzleme Günlüklerini Görüntüleyin**: `aws apigatewayv2 get-logs --api-id <api-id>` komutunu kullanarak bir API'nin izleme günlüklerini görüntüleyebilirsiniz.

10. **API Gateway API'sini İzleme Günlüklerini Etkinleştirin**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini etkinleştirebilirsiniz.

11. **API Gateway API'sini İzleme Günlüklerini Devre Dışı Bırakın**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level OFF` komutunu kullanarak bir API'nin izleme günlüklerini devre dışı bırakabilirsiniz.

12. **API Gateway API'sini İzleme Günlüklerini Düzenleyin**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <new-logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini düzenleyebilirsiniz.

13. **API Gateway API'sini İzleme Günlüklerini Silin**: `aws apigatewayv2 delete-logging-config --api-id <api-id>` komutunu kullanarak bir API'nin izleme günlüklerini silebilirsiniz.

14. **API Gateway API'sini İzleme Günlüklerini Listeleyin**: `aws apigatewayv2 get-logging-config --api-id <api-id>` komutunu kullanarak bir API'nin izleme günlüklerini listeleyebilirsiniz.

15. **API Gateway API'sini İzleme Günlüklerini Güncelleyin**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini güncelleyebilirsiniz.

16. **API Gateway API'sini İzleme Günlüklerini Oluşturun**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini oluşturabilirsiniz.

17. **API Gateway API'sini İzleme Günlüklerini Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine yeni bir izleme günlüğü ekleyebilirsiniz.

18. **API Gateway API'sini İzleme Günlüklerini Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden bir izleme günlüğünü kaldırabilirsiniz.

19. **API Gateway API'sini İzleme Günlüklerini Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini güncelleyebilirsiniz.

20. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

21. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

22. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine izleme günlüğünü yeniden ekleyebilirsiniz.

23. **API Gateway API'sini İzleme Günlüklerini Yeniden Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden izleme günlüğünü yeniden kaldırabilirsiniz.

24. **API Gateway API'sini İzleme Günlüklerini Yeniden Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden güncelleyebilirsiniz.

25. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

26. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

27. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine izleme günlüğünü yeniden ekleyebilirsiniz.

28. **API Gateway API'sini İzleme Günlüklerini Yeniden Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden izleme günlüğünü yeniden kaldırabilirsiniz.

29. **API Gateway API'sini İzleme Günlüklerini Yeniden Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden güncelleyebilirsiniz.

30. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

31. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

32. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine izleme günlüğünü yeniden ekleyebilirsiniz.

33. **API Gateway API'sini İzleme Günlüklerini Yeniden Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden izleme günlüğünü yeniden kaldırabilirsiniz.

34. **API Gateway API'sini İzleme Günlüklerini Yeniden Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden güncelleyebilirsiniz.

35. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

36. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

37. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine izleme günlüğünü yeniden ekleyebilirsiniz.

38. **API Gateway API'sini İzleme Günlüklerini Yeniden Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden izleme günlüğünü yeniden kaldırabilirsiniz.

39. **API Gateway API'sini İzleme Günlüklerini Yeniden Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden güncelleyebilirsiniz.

40. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

41. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

42. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine izleme günlüğünü yeniden ekleyebilirsiniz.

43. **API Gateway API'sini İzleme Günlüklerini Yeniden Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden izleme günlüğünü yeniden kaldırabilirsiniz.

44. **API Gateway API'sini İzleme Günlüklerini Yeniden Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden güncelleyebilirsiniz.

45. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

46. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

47. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerine izleme günlüğünü yeniden ekleyebilirsiniz.

48. **API Gateway API'sini İzleme Günlüklerini Yeniden Kaldırma**: `aws apigatewayv2 delete-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerinden izleme günlüğünü yeniden kaldırabilirsiniz.

49. **API Gateway API'sini İzleme Günlüklerini Yeniden Güncelleme**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden güncelleyebilirsiniz.

50. **API Gateway API'sini İzleme Günlüklerini Yeniden Yapılandırma**: `aws apigatewayv2 update-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden yapılandırabilirsiniz.

51. **API Gateway API'sini İzleme Günlüklerini Yeniden Oluşturma**: `aws apigatewayv2 create-logging-config --api-id <api-id> --logging-level <logging-level>` komutunu kullanarak bir API'nin izleme günlüklerini yeniden oluşturabilirsiniz.

52. **API Gateway API'sini İzleme Günlüklerini Yeniden Ekleme**: `aws apigatewayv2 create-logging-config
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## API Gateway uç noktalarına erişim için farklı yetkilendirmeler

### Kaynak Politikası

API uç noktalarını kimin çağırabileceğini belirlemek için kaynak politikaları kullanılabilir.\
Aşağıdaki örnekte, **belirtilen IP'nin** GET ile `/resource_policy` uç noktasını çağıramayacağını görebilirsiniz.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM Yetkilendirici

Bir yolun içindeki (bir kaynak) yöntemlerin, onu çağırmak için IAM kimlik doğrulaması gerektirdiği belirtilebilir.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Bu ayarlandığında, yetkilendirme olmadan uç noktaya erişmeye çalıştığınızda `{"message":"Missing Authentication Token"}` hatasını alırsınız.

Beklenen belirteci uygulama tarafından oluşturmanın kolay bir yolu, **Postman** içinde **`Authorization`** türünü **`AWS Signature`** olarak kullanmaktır.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Kullanmak istediğiniz hesabın accessKey ve SecretKey'ini ayarlayın ve API uç noktasına karşı kimlik doğrulaması yapabilirsiniz.

Bu, aşağıdaki gibi bir **Authorization** **header** oluşturacaktır:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Not: Diğer durumlarda **Yetkilendirici** kötü kodlanmış olabilir ve **Yetkilendirme başlığı** içine herhangi bir şey göndermek, gizli içeriği görmeye izin verebilir.

### Python Kullanarak İstek İmzalama
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Özel Lambda Yetkilendirici

Verilen bir belirteçe dayanan bir lambda kullanarak, kullanıcının API uç noktasını çağırmaya yetkili olup olmadığını belirten bir IAM politikası döndürmek mümkündür.\
Yetkilendiriciyi kullanacak olan her kaynak yöntemini ayarlayabilirsiniz.

<details>

<summary>Lambda Yetkilendirici Kod Örneği</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Bunu şu şekilde çağırın:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Lambda koduna bağlı olarak, bu yetkilendirme zayıf olabilir
{% endhint %}

Unutmayın ki, bir **reddetme politikası oluşturulup döndürülürse**, API Gateway tarafından döndürülen hata şu şekildedir: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Bu şekilde, bu yetkilendirmenin var olduğunu **belirleyebilirsiniz**.

### Gerekli API Anahtarı

Bir API uç noktasının, ona ulaşmak için **geçerli bir API anahtarı gerektiren** şekilde ayarlanması mümkündür.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

API anahtarları, API Gateway portalında oluşturulabilir ve hatta kullanımı (saniye başına ve aylık istekler olarak) ne kadar olabileceği belirlenebilir.

Bir API anahtarının çalışması için, onu bir **Kullanım Planına** eklemeniz gerekmektedir, bu kullanım planı **API Aşamasına** eklenmeli ve ilişkili API aşamasının, API anahtarını gerektiren bir **uç noktaya yönelik bir yöntem sınırlaması** yapılandırması olması gerekmektedir:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Kimlik Doğrulamasız Erişim

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Privilege Escalation

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Sonrası Saldırı

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Kalıcılık

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **tanıtmak veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da** takip edin.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
