# AWS - API Gateway Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Lango la API

### Taarifa Msingi

AWS API Gateway ni huduma kamili inayotolewa na Amazon Web Services (AWS) iliyoundwa kwa watengenezaji wa **kuunda, kuchapisha, na kusimamia APIs kwa kiwango kikubwa**. Inafanya kazi kama lango la kuingilia kwenye programu, kuruhusu watengenezaji kuweka mfumo wa sheria na taratibu. Mfumo huu unatawala upatikanaji wa watumiaji wa nje wanavyopata data au utendaji fulani ndani ya programu.

API Gateway inawezesha kuamua **jinsi maombi kwa APIs yako yanapaswa kushughulikiwa**, na inaweza kuunda vituo vya API vya desturi na njia maalum (k.m., GET, POST, PUT, DELETE) na rasilimali. Pia inaweza kuzalisha SDK za wateja (Vifurushi vya Maendeleo ya Programu) kufanya iwe rahisi kwa watengenezaji kuita APIs yako kutoka kwenye programu zao.

### Aina za Malango ya API

* **API ya HTTP**: Jenga APIs za REST zenye latency ndogo na gharama nafuu na vipengele vilivyojengwa kama OIDC na OAuth2, na msaada wa asili wa CORS. Inafanya kazi na yafuatayo: Lambda, backend za HTTP.
* **API ya WebSocket**: Jenga API ya WebSocket kwa kutumia mawasiliano ya kudumu kwa matumizi ya wakati halisi kama programu za mazungumzo au dashibodi. Inafanya kazi na yafuatayo: Lambda, HTTP, Huduma za AWS.
* **API ya REST**: Endeleza API ya REST ambapo unapata udhibiti kamili juu ya ombi na majibu pamoja na uwezo wa usimamizi wa API. Inafanya kazi na yafuatayo: Lambda, HTTP, Huduma za AWS.
* **API ya REST ya Kibinafsi**: Unda API ya REST ambayo inaweza kufikiwa tu kutoka ndani ya VPC.

### Vipengele Vikuu vya Lango la API

1. **Rasilimali**: Katika API Gateway, rasilimali ni vipengele vinavyounda muundo wa API yako. Vinawakilisha **njia au vituo tofauti** vya API yako na vinalingana na vitendo mbalimbali ambavyo API yako inasaidia. Rasilimali ni kila njia (k.m., GET, POST, PUT, DELETE) **ndani ya kila njia** (/, au /watumiaji, au /mtumiaji/{id}.
2. **Hatua**: Hatua katika API Gateway inawakilisha **toleo au mazingira tofauti** ya API yako, kama vile maendeleo, hatua ya majaribio, au uzalishaji. Unaweza kutumia hatua kusimamia na kupeleka **matoleo mengi ya API yako kwa wakati mmoja**, kuruhusu kupima vipengele vipya au marekebisho ya kasoro bila kuathiri mazingira ya uzalishaji. Hatua pia **inaweza kusaidia mazingira ya hatua**, ambayo ni jozi za funguo-na-thamani zinazoweza kutumika kusanidi tabia ya API yako kulingana na hatua ya sasa. Kwa mfano, unaweza kutumia mazingira ya hatua kuongoza maombi ya API kwa Lambda functions tofauti au huduma zingine za nyuma kulingana na hatua.

* Hatua inaonyeshwa mwanzoni mwa URL ya mwisho ya lango la API.

3. **Wahakiki**: Wahakiki katika API Gateway wanahusika na **kudhibiti upatikanaji wa API yako** kwa kuthibitisha utambulisho wa mpigaji simu kabla ya kuruhusu ombi kuendelea. Unaweza kutumia **kazi za AWS Lambda** kama wahakiki wa desturi, ambayo inakuruhusu kutekeleza mantiki yako ya uthibitishaji na idhini. Wakati ombi linapoingia, API Gateway inapitisha tokeni ya idhini ya ombi kwa wahakiki wa Lambda, ambao wanaprocess tokeni na kurudisha sera ya IAM inayodhibiti ni vitendo gani mpigaji simu anaruhusiwa kufanya. API Gateway pia inasaidia **wahakiki zilizojengwa**, kama vile **Utambulisho na Usimamizi wa Upatikanaji wa Amazon (IAM)** na **Amazon Cognito**.
4. **Sera ya Rasilimali**: Sera ya rasilimali katika API Gateway ni hati ya JSON ambayo **inadefini ruhusa za kupata API yako**. Inafanana na sera ya IAM lakini imebuniwa mahsusi kwa API Gateway. Unaweza kutumia sera ya rasilimali kudhibiti ni nani anaweza kupata API yako, ni njia zipi wanaweza kuita, na kutoka kwa anwani za IP au VPC wanaweza kuunganisha. **Sera za rasilimali zinaweza kutumika pamoja na wahakiki** kutoa udhibiti wa upatikanaji wa kina kwa API yako.

* Ili sera ya rasilimali ifanye kazi API inahitaji **kupelekwa tena baada ya** sera ya rasilimali kubadilishwa.

### Kuingiza

Kwa chaguo-msingi, **Kumbukumbu za CloudWatch** ziko **zimezimwa**, **Kuingiza Kufikia** kiko **zimezimwa**, na **Ufuatiliaji wa X-Ray** pia uko **zimezimwa**.

### Uorodheshaji

{% hint style="success" %}
Tambua kwamba katika APIs zote mbili za AWS kwa ajili ya kuorodhesha rasilimali (**`apigateway`** na **`apigatewayv2`**) ruhusa pekee unayohitaji na ruhusa pekee inayoweza kutolewa ni **`apigateway:GET`**, kwa hiyo unaweza **kuorodhesha kila kitu.**
{% endhint %}

```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```

### Enumerating AWS API Gateway v2

#### List API Gateway v2 APIs

To list all API Gateway v2 APIs in the current AWS account, you can use the following CLI command:

```bash
aws apigatewayv2 get-apis
```

This command will return a list of all APIs along with their details such as API ID, name, protocol type, and creation date.

#### Describe API Gateway v2 API

To get more detailed information about a specific API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api --api-id <api-id>
```

Replace `<api-id>` with the actual API ID you want to describe. This command will provide detailed information about the specified API including routes, integrations, and other configurations.

#### List API Gateway v2 Integrations

You can also list all the integrations associated with an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-integrations --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to list the integrations. This command will return a list of integrations along with their details such as integration ID, integration type, and integration URI.

#### Enumerate API Gateway v2 Routes

To enumerate all the routes configured in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-routes --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to enumerate the routes. This command will provide a list of all routes defined in the specified API along with their route key, route ID, and other details.

#### List API Gateway v2 Deployments

To list all the deployments of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-deployments --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to list the deployments. This command will return a list of all deployments associated with the specified API including deployment ID, deployment status, and deployment creation date.

#### Describe API Gateway v2 Deployment

To get more information about a specific deployment of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-deployment --api-id <api-id> --deployment-id <deployment-id>
```

Replace `<api-id>` with the API ID and `<deployment-id>` with the deployment ID you want to describe. This command will provide detailed information about the specified deployment including deployment status, deployment creation date, and associated stage.

#### List API Gateway v2 Stages

You can list all the stages of an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-stages --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to list the stages. This command will return a list of all stages associated with the specified API including stage name, stage status, and stage creation date.

#### Describe API Gateway v2 Stage

To get more information about a specific stage of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-stage --api-id <api-id> --stage-name <stage-name>
```

Replace `<api-id>` with the API ID and `<stage-name>` with the stage name you want to describe. This command will provide detailed information about the specified stage including stage status, stage creation date, and stage variables.

#### List API Gateway v2 Domain Names

To list all the custom domain names associated with an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-domain-names
```

This command will return a list of all custom domain names along with their details such as domain name, domain name status, and domain name creation date.

#### Describe API Gateway v2 Domain Name

To get more information about a specific custom domain name of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-domain-name --domain-name <domain-name>
```

Replace `<domain-name>` with the actual domain name you want to describe. This command will provide detailed information about the specified custom domain name including domain name status, domain name creation date, and domain name configurations.

#### List API Gateway v2 Authorizers

You can list all the authorizers configured for an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-authorizers --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to list the authorizers. This command will return a list of all authorizers associated with the specified API including authorizer ID, authorizer name, and authorizer type.

#### Describe API Gateway v2 Authorizer

To get more information about a specific authorizer of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-authorizer --api-id <api-id> --authorizer-id <authorizer-id>
```

Replace `<api-id>` with the API ID and `<authorizer-id>` with the authorizer ID you want to describe. This command will provide detailed information about the specified authorizer including authorizer type, authorizer name, and authorizer configuration.

#### List API Gateway v2 Models

You can list all the models defined for an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-models --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to list the models. This command will return a list of all models associated with the specified API including model ID, model name, and model schema.

#### Describe API Gateway v2 Model

To get more information about a specific model of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-model --api-id <api-id> --model-id <model-id>
```

Replace `<api-id>` with the API ID and `<model-id>` with the model ID you want to describe. This command will provide detailed information about the specified model including model name, model schema, and model content type.

#### List API Gateway v2 Tags

To list all the tags associated with an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-tags --resource-arn <api-arn>
```

Replace `<api-arn>` with the ARN (Amazon Resource Name) of the API for which you want to list the tags. This command will return a list of all tags associated with the specified API.

#### Describe API Gateway v2 Tag

To get more information about a specific tag of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-tag --resource-arn <api-arn> --tag-key <tag-key>
```

Replace `<api-arn>` with the ARN of the API and `<tag-key>` with the tag key you want to describe. This command will provide detailed information about the specified tag including tag key and tag value.

#### List API Gateway v2 VPC Links

You can list all the VPC links associated with an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-vpc-links
```

This command will return a list of all VPC links along with their details such as VPC link ID, VPC link name, and VPC link status.

#### Describe API Gateway v2 VPC Link

To get more information about a specific VPC link of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-vpc-link --vpc-link-id <vpc-link-id>
```

Replace `<vpc-link-id>` with the actual VPC link ID you want to describe. This command will provide detailed information about the specified VPC link including VPC link name, VPC link status, and VPC link security group IDs.

#### List API Gateway v2 Security Policies

You can list all the security policies available for an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-security-policies
```

This command will return a list of all available security policies along with their details such as security policy ID, security policy name, and security policy description.

#### Describe API Gateway v2 Security Policy

To get more information about a specific security policy available for an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-security-policy --name <security-policy-name>
```

Replace `<security-policy-name>` with the name of the security policy you want to describe. This command will provide detailed information about the specified security policy including security policy ID, security policy description, and supported TLS versions.

#### List API Gateway v2 Domain Certificates

To list all the domain certificates associated with an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-domain-certificates
```

This command will return a list of all domain certificates along with their details such as certificate ARN, certificate name, and certificate expiration date.

#### Describe API Gateway v2 Domain Certificate

To get more information about a specific domain certificate of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-domain-certificate --certificate-arn <certificate-arn>
```

Replace `<certificate-arn>` with the ARN of the certificate you want to describe. This command will provide detailed information about the specified domain certificate including certificate name, certificate expiration date, and associated domain name.

#### List API Gateway v2 APIs by Tags

You can list all the APIs associated with specific tags in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-apis --tags <tags>
```

Replace `<tags>` with the specific tags you want to filter the APIs by. This command will return a list of all APIs associated with the specified tags.

#### Describe API Gateway v2 API Mapping

To get more information about the API mappings of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mappings --domain-name <domain-name>
```

Replace `<domain-name>` with the domain name for which you want to get the API mappings. This command will provide detailed information about the API mappings including API ID, API mapping ID, and API mapping status.

#### List API Gateway v2 API Mappings

You can list all the API mappings associated with an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mappings --api-id <api-id>
```

Replace `<api-id>` with the API ID for which you want to list the API mappings. This command will return a list of all API mappings associated with the specified API.

#### Describe API Gateway v2 API Mapping

To get more information about a specific API mapping of an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to describe the API mapping. This command will provide detailed information about the specified API mapping including API mapping ID, API ID, and stage.

#### List API Gateway v2 API Mapping Certificates

You can list all the certificates associated with API mappings in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-certificates --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to list the certificates. This command will return a list of all certificates associated with the specified API mappings.

#### Describe API Gateway v2 API Mapping Certificate

To get more information about a specific certificate associated with an API mapping in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-certificate --api-id <api-id> --domain-name <domain-name> --certificate-arn <certificate-arn>
```

Replace `<api-id>` with the API ID, `<domain-name>` with the domain name, and `<certificate-arn>` with the certificate ARN for which you want to get more information. This command will provide detailed information about the specified certificate associated with the API mapping.

#### List API Gateway v2 API Mapping Custom Domain Names

You can list all the custom domain names associated with API mappings in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-domain-names --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to list the custom domain names. This command will return a list of all custom domain names associated with the specified API mappings.

#### Describe API Gateway v2 API Mapping Custom Domain Name

To get more information about a specific custom domain name associated with an API mapping in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-domain-name --api-id <api-id> --domain-name <domain-name> --domain-name-configuration <domain-name-configuration>
```

Replace `<api-id>` with the API ID, `<domain-name>` with the domain name, and `<domain-name-configuration>` with the domain name configuration for which you want to get more information. This command will provide detailed information about the specified custom domain name associated with the API mapping.

#### List API Gateway v2 API Mapping VPC Links

You can list all the VPC links associated with API mappings in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-vpc-links --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to list the VPC links. This command will return a list of all VPC links associated with the specified API mappings.

#### Describe API Gateway v2 API Mapping VPC Link

To get more information about a specific VPC link associated with an API mapping in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-vpc-link --api-id <api-id> --domain-name <domain-name> --vpc-link-id <vpc-link-id>
```

Replace `<api-id>` with the API ID, `<domain-name>` with the domain name, and `<vpc-link-id>` with the VPC link ID for which you want to get more information. This command will provide detailed information about the specified VPC link associated with the API mapping.

#### List API Gateway v2 API Mapping Security Policies

You can list all the security policies associated with API mappings in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-security-policies --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to list the security policies. This command will return a list of all security policies associated with the specified API mappings.

#### Describe API Gateway v2 API Mapping Security Policy

To get more information about a specific security policy associated with an API mapping in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-security-policy --api-id <api-id> --domain-name <domain-name> --security-policy-id <security-policy-id>
```

Replace `<api-id>` with the API ID, `<domain-name>` with the domain name, and `<security-policy-id>` with the security policy ID for which you want to get more information. This command will provide detailed information about the specified security policy associated with the API mapping.

#### List API Gateway v2 API Mapping Tags

You can list all the tags associated with API mappings in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-tags --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to list the tags. This command will return a list of all tags associated with the specified API mappings.

#### Describe API Gateway v2 API Mapping Tag

To get more information about a specific tag associated with an API mapping in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-tag --api-id <api-id> --domain-name <domain-name> --tag-key <tag-key>
```

Replace `<api-id>` with the API ID, `<domain-name>` with the domain name, and `<tag-key>` with the tag key for which you want to get more information. This command will provide detailed information about the specified tag associated with the API mapping.

#### List API Gateway v2 API Mapping Models

You can list all the models associated with API mappings in an API Gateway v2 API using the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-models --api-id <api-id> --domain-name <domain-name>
```

Replace `<api-id>` with the API ID and `<domain-name>` with the domain name for which you want to list the models. This command will return a list of all models associated with the specified API mappings.

#### Describe API Gateway v2 API Mapping Model

To get more information about a specific model associated with an API mapping in an API Gateway v2 API, you can use the following CLI command:

```bash
aws apigatewayv2 get-api-mapping-model --api-id <api-id> --domain-name <domain-name> --model-id <model-id>
```

Replace `<api-id>` with the API ID, `<domain-name>` with the domain name, and `<model-id>` with the model ID for which you want to get more information. This command will provide detailed information about the specified model associated with the API mapping.

````
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
````

## Mamlaka Tofauti za kupata upatikanaji wa vituo vya API Gateway

### Sera ya Rasilimali

Inawezekana kutumia sera za rasilimali kufafanua ni nani anaweza kupiga simu kwa vituo vya API.\
Katika mfano ufuatao unaweza kuona kwamba **IP iliyotajwa haiwezi kupiga simu** kwa kituo cha mwisho `/resource_policy` kupitia GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### IAM Authorizer

Inawezekana kuweka kwamba njia ndani ya njia (rasilimali) inahitaji uwakilishi wa IAM ili kupiga simu.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Wakati hii inawekwa utapokea kosa `{"uajiri":"Kitambulisho cha Uthibitishaji Kimepotea"}` unapojaribu kufikia kituo cha mwisho bila idhini yoyote.

Njia moja rahisi ya kuzalisha kitambulisho kinachotarajiwa na programu ni kutumia aina ya **`Uthibitishaji`** ya **`Sahihi ya AWS`** ndani ya **Postman**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Wekeza ufikiaji na Kitufe cha Siri cha akaunti unayotaka kutumia na unaweza kujithibitisha dhidi ya kituo cha API.

Itazalisha **kitambulisho** cha **Uthibitishaji** kama vile:

```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```

Tafadhali elewa kwamba katika matukio mengine **Mwandishi** anaweza kuwa ameandika **kificho kibaya** na kutuma **kitu chochote** ndani ya **kichwa cha Uthibitisho** kutawezesha kuona **maudhui yaliyofichwa**.

### Kutia Saini Ombi Kwa Kutumia Python

```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```

### Mzuri wa Lambda wa Kuthibitisha

Inawezekana kutumia lambda ambayo kulingana na ishara iliyotolewa itarudisha sera ya IAM ikionyesha ikiwa mtumiaji ana **ruhusa ya kuita mwisho wa API**.\
Unaweza kuweka kila mbinu ya rasilimali itakayotumia mthibitishaji.

<details>

<summary>Mfano wa Msimbo wa Mzuri wa Lambda wa Kuthibitisha</summary>

\`\`\`python import json

def lambda\_handler(event, context): token = event\['authorizationToken'] method\_arn = event\['methodArn']

if not token: return { 'statusCode': 401, 'body': 'Unauthorized' }

try:

## Replace this with your own token validation logic

if token == "your-secret-token": return generate\_policy('user', 'Allow', method\_arn) else: return generate\_policy('user', 'Deny', method\_arn) except Exception as e: print(e) return { 'statusCode': 500, 'body': 'Internal Server Error' }

def generate\_policy(principal\_id, effect, resource): policy = { 'principalId': principal\_id, 'policyDocument': { 'Version': '2012-10-17', 'Statement': \[ { 'Action': 'execute-api:Invoke', 'Effect': effect, 'Resource': resource } ] } } return policy

```
</details>

Piga simu kama hivi:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

<div data-gb-custom-block data-tag="hint" data-style='warning'>

Kulingana na nambari ya Lambda, hii idhini inaweza kuwa na udhaifu

</div>

Tambua kwamba ikiwa **sera ya kukataa inazalishwa na kurudishwa** kosa linalorudishwa na API Gateway ni: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Hivi unaweza **kutambua idhini hii** ikiwa mahali pake.

### Kitufe cha API Kinachohitajika

Inawezekana kuweka vituo vya API ambavyo **vinahitaji kitufe halali cha API** kuwasiliana navyo.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Inawezekana kuzalisha vitufe vya API kwenye lango la API na hata kuweka ni mara ngapi inaweza kutumika (kwa maombi kwa sekunde na kwa maombi kwa mwezi).

Ili kufanya kitufe cha API kifanye kazi, unahitaji kuongeza kwenye **Mpango wa Matumizi**, mpango huu wa matumizi unapaswa kuongezwa kwenye **Hatua ya API** na hatua ya API inayohusiana inahitaji kuwa na **kupunguza kasi kwa njia** iliyowekwa kwa **kituo** kinachohitaji kitufe cha API:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Upatikanaji usiothibitishwa

<div data-gb-custom-block data-tag="content-ref" data-url='../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md'>

[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)

</div>

## Privesc

<div data-gb-custom-block data-tag="content-ref" data-url='../aws-privilege-escalation/aws-apigateway-privesc.md'>

[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)

</div>

## Baada ya Uvamizi

<div data-gb-custom-block data-tag="content-ref" data-url='../aws-post-exploitation/aws-api-gateway-post-exploitation.md'>

[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)

</div>

### Uthabiti

<div data-gb-custom-block data-tag="content-ref" data-url='../aws-persistence/aws-api-gateway-persistence.md'>

[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)

</div>

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
```

</details>
