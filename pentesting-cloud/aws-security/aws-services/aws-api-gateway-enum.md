# AWS - Απαρίθμηση API Gateway

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα hacking tricks σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## API Gateway

### Βασικές Πληροφορίες

Το AWS API Gateway είναι ένα ολοκληρωμένο υπηρεσία που προσφέρεται από το Amazon Web Services (AWS) σχεδιασμένο για τους προγραμματιστές για να **δημιουργούν, δημοσιεύουν και εποπτεύουν APIs μεγάλης κλίμακας**. Λειτουργεί ως σημείο εισόδου σε μια εφαρμογή, επιτρέποντας στους προγραμματιστές να δημιουργήσουν ένα πλαίσιο κανόνων και διαδικασιών. Αυτό το πλαίσιο διέπει την πρόσβαση που έχουν οι εξωτερικοί χρήστες σε συγκεκριμένα δεδομένα ή λειτουργίες εντός της εφαρμογής.

Το API Gateway σας επιτρέπει να καθορίσετε **πώς πρέπει να χειρίζονται οι αιτήσεις προς τα APIs σας**, και μπορεί να δημιουργήσει προσαρμοσμένα σημεία πρόσβασης του API με συγκεκριμένες μεθόδους (π.χ. GET, POST, PUT, DELETE) και πόρους. Μπορεί επίσης να δημιουργήσει SDKs πελατών (Software Development Kits) για να καθιστά ευκολότερο στους προγραμματιστές να καλούν τα APIs σας από τις εφαρμογές τους.

### Τύποι API Gateways

* **HTTP API**: Δημιουργήστε REST APIs χαμηλής καθυστέρησης και οικονομικά αποδοτικά με ενσωματωμένα χαρακτηριστικά όπως OIDC και OAuth2, και υποστήριξη native CORS. Λειτουργεί με τα εξής: Lambda, HTTP backends.
* **WebSocket API**: Δημιουργήστε ένα WebSocket API χρησιμοποιώντας μόνιμες συνδέσεις για πραγματικές χρονικές περιπτώσεις χρήσης όπως εφαρμογές συνομιλίας ή πίνακες ελέγχου. Λειτουργεί με τα εξής: Lambda, HTTP, AWS Services.
* **REST API**: Αναπτύξτε ένα REST API όπου αποκτάτε πλήρη έλεγχο επί του αιτήματος και της απόκρισης μαζί με δυνατότητες διαχείρισης του API. Λειτουργεί με τα εξής: Lambda, HTTP, AWS Services.
* **REST API Private**: Δημιουργήστε ένα REST API που είναι προσβάσιμο μόνο από μέσα σε ένα VPC.

### Κύρια Συστατικά του API Gateway

1. **Πόροι**: Στο API Gateway, οι πόροι είναι τα συστατικά που **αποτελούν τη δομή του API σας**. Αντιπροσωπεύουν **τις διάφορες διαδρομές ή σημεία πρόσβασης** του API σας και αντιστοιχούν στις διάφορες ενέργειες που υποστηρίζει το API σας. Ένας πόρος είναι κάθε μέθοδος (π.χ. GET, POST, PUT, DELETE) **μέσα σε κάθε διαδρομή** (/, ή /users, ή /user/{id}.
2. **Στάδια**: Τα στάδια στο API Gateway αντιπροσωπεύουν **διάφορες εκδόσεις ή περιβάλλοντα** του API σας, όπως ανάπτυξη, σταδιοδρομία ή παραγωγή. Μπορείτε να χρησιμοποιήσετε στάδια για να διαχειριστείτε και να αναπτύξετε **πολλαπλές εκδόσεις του API σας ταυτόχρονα**, επιτρέποντάς σας να δοκιμάσετε νέα χαρακτηριστικά ή διορθώσεις σφαλμάτων χωρίς να επηρεάζετε το περιβάλλον παραγωγής. Τα στάδια υποστηρίζουν επίσης **μεταβλητές σταδίου**, οι οποίες είναι ζεύγη κλειδιού-τιμής που μπορούν να χρησιμοποιηθούν για να διαμορφώσουν τη συμπεριφορά του API σας με βάση το τρέχον στάδιο. Για παράδειγμα, μπορείτε να χρησιμοποιήσετε μεταβλητές σταδίου για να κατευθύνετε τις αιτήσεις του API σε διάφορες συναρτήσεις Lambda ή άλλες υπ
```bash
# Generic info
aws apigateway get-account
aws apigateway get-domain-names
aws apigateway get-usage-plans
aws apigateway get-vpc-links
aws apigateway get-client-certificates

# Enumerate APIs
aws apigateway get-rest-apis # This will also show the resource policy (if any)
## Get stages
aws apigateway get-stages --rest-api-id <id>
## Get resources
aws apigateway get-resources --rest-api-id <id>
## Get API resource action per HTTP verb (check authorizers and api key required)
aws apigateway get-method --http-method GET --rest-api-id <api-id> --resource-id <resource-id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
## API authorizers
aws apigateway get-authorizers --rest-api-id <id>
## Models
aws apigateway get-models --rest-api-id <id>
## More info
aws apigateway get-gateway-responses --rest-api-id <id>
aws apigateway get-request-validators --rest-api-id <id>
aws apigateway get-deployments --rest-api-id <id>

# Get api keys generated
aws apigateway get-api-keys --include-value
aws apigateway get-api-key --api-key <id> --include-value # Get just 1
## Example use API key
curl -X GET -H "x-api-key: AJE&Ygenu4[..]" https://e83uuftdi8.execute-api.us-east-1.amazonaws.com/dev/test
## Usage plans
aws apigateway get-usage-plans #Get limit use info
aws apigateway get-usage-plan-keys --usage-plan-id <plan_id> #Get clear text values of api keys
aws apigateway get-usage-plan-key --usage-plan-id <plan_id> --key-id <key_id>
###Already consumed
aws apigateway get-usage --usage-plan-id <plan_id> --start-date 2023-07-01 --end-date 2023-07-12
```
{% endtab %}

{% tab title="apigatewayv2" %}
```bash
# Generic info
aws apigatewayv2 get-account --
aws apigatewayv2 get-domain-names
aws apigatewayv2 get-domain-name --domain-name <name>
aws apigatewayv2 get-usage-plans --
aws apigatewayv2 get-vpc-links
aws apigatewayv2 get-client-certificates --

# Enumerate APIs
aws apigatewayv2 get-apis # This will also show the resource policy (if any)
aws apigatewayv2 get-api --api-id <id>

## Get all the info from an api at once
aws apigatewayv2 export-api --api-id <id> --output-type YAML --specification OAS30 /tmp/api.yaml

## Get stages
aws apigatewayv2 get-stages --api-id <id>

## Get routes
aws apigatewayv2 get-routes --api-id <id>
aws apigatewayv2 get-route --api-id <id> --route-id <route-id>

## Get deployments
aws apigatewayv2 get-deployments --api-id <id>
aws apigatewayv2 get-deployment --api-id <id> --deployment-id <dep-id>

## Get integrations
aws apigatewayv2 get-integrations --api-id <id>

## Get authorizers
aws apigatewayv2 get-authorizers --api-id <id>
aws apigatewayv2 get-authorizer --api-id <id> --authorizer-id <uth-id>

## Get domain mappings
aws apigatewayv2 get-api-mappings --api-id <id> --domain-name <dom-name>
aws apigatewayv2 get-api-mapping --api-id <id> --api-mapping-id <map-id> --domain-name <dom-name>

## Get models
aws apigatewayv2 get-models --api-id <id>

## Call API
https://<api-id>.execute-api.<region>.amazonaws.com/<stage>/<resource>
```
{% endtab %}
{% endtabs %}

## Διάφορες Εξουσιοδοτήσεις για πρόσβαση σε σημεία πρόσβασης της API Gateway

### Πολιτική Πόρου

Είναι δυνατόν να χρησιμοποιηθούν πολιτικές πόρων για να καθοριστεί ποιος μπορεί να καλέσει τα σημεία πρόσβασης της API.\
Στο παρακάτω παράδειγμα μπορείτε να δείτε ότι η **υποδεικνυόμενη IP δεν μπορεί να καλέσει** το σημείο πρόσβασης `/resource_policy` μέσω GET.

<figure><img src="../../../.gitbook/assets/image (92) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Εξουσιοδοτητής IAM

Είναι δυνατόν να οριστεί ότι ένας μέθοδος μέσα σε ένα μονοπάτι (ένας πόρος) απαιτεί ταυτοποίηση IAM για να κληθεί.

<figure><img src="https://lh3.googleusercontent.com/GGx-kfqNXu6zMqGidnO8_eR88fYPpJG-wNuBBnedAJntiRUEPTEScl7OvWthGYRiI_msYCdC6oBFvJc827Tb4-4UogxpOyrEXyst-8IDzP9DC2NOtXSY7w58L0baCAcBQjSyvBhJREvWWCtiboNYPSKuEw=s2048" alt=""><figcaption></figcaption></figure>

Όταν αυτό ορίζεται, θα λάβετε το σφάλμα `{"message":"Missing Authentication Token"}` όταν προσπαθήσετε να φτάσετε στο σημείο πρόσβασης χωρίς καμία εξουσιοδότηση.

Ένας εύκολος τρόπος να δημιουργήσετε το αναμενόμενο διακριτικό από την εφαρμογή είναι να χρησιμοποιήσετε τον τύπο **`Authorization`** **`AWS Signature`** μέσα στο **Postman**.

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

Ορίστε το accessKey και το SecretKey του λογαριασμού που θέλετε να χρησιμοποιήσετε και μπορείτε να πιστοποιηθείτε εναντίον του σημείου πρόσβασης της API.

Θα δημιουργήσει ένα **Authorization** **header** όπως:
```
AWS4-HMAC-SHA256 Credential=AKIAYY7XU6ECUDOTWB7W/20220726/us-east-1/execute-api/aws4_request, SignedHeaders=host;x-amz-date, Signature=9f35579fa85c0d089c5a939e3d711362e92641e8c14cc571df8c71b4bc62a5c2
```
Να σημειωθεί ότι σε άλλες περιπτώσεις ο **Εξουσιοδοτητής** μπορεί να έχει γραφεί με **κακό τρόπο** και απλά να στέλνει **οτιδήποτε** μέσα στην **επικεφαλίδα Εξουσιοδότησης**, θα **επιτρέψει να δείτε το κρυφό περιεχόμενο**.

### Υπογραφή Αιτήσεων με Χρήση της Python
```python

pip install requests
pip install requests-aws4auth
pip install boto3

import boto3
import requests
from requests_aws4auth import AWS4Auth

region = 'us-east-1'  # Region
service = 'execute-api'
access_key = 'YOUR_ACCESS_KEY'
secret_key = 'YOUR_SECRET_KEY'

url = 'https://<apiid>.execute-api.us-east-1.amazonaws.com/<stage>/<resource>'

session = boto3.Session(aws_access_key_id=access_key, aws_secret_access_key=secret_key)
credentials = session.get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

response = requests.get(url, auth=awsauth)

print(response.text)

```
### Προσαρμοσμένος Εξουσιοδοτητής Lambda

Είναι δυνατόν να χρησιμοποιηθεί ένας λαμβάνοντας υπόψη ένα δεδομένο διακριτικό, θα **επιστρέψει μια πολιτική IAM** που υποδεικνύει εάν ο χρήστης έχει **εξουσιοδότηση να καλέσει το API endpoint**.\
Μπορείτε να ορίσετε κάθε μέθοδο πόρου που θα χρησιμοποιεί τον εξουσιοδοτητή.

<details>

<summary>Παράδειγμα Κώδικα Εξουσιοδοτητή Lambda</summary>
```python
import json

def lambda_handler(event, context):
token = event['authorizationToken']
method_arn = event['methodArn']

if not token:
return {
'statusCode': 401,
'body': 'Unauthorized'
}

try:
# Replace this with your own token validation logic
if token == "your-secret-token":
return generate_policy('user', 'Allow', method_arn)
else:
return generate_policy('user', 'Deny', method_arn)
except Exception as e:
print(e)
return {
'statusCode': 500,
'body': 'Internal Server Error'
}

def generate_policy(principal_id, effect, resource):
policy = {
'principalId': principal_id,
'policyDocument': {
'Version': '2012-10-17',
'Statement': [
{
'Action': 'execute-api:Invoke',
'Effect': effect,
'Resource': resource
}
]
}
}
return policy
```
</details>

Καλέστε το με κάτι σαν αυτό:

<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>curl "https://jhhqafgh6f.execute-api.eu-west-1.amazonaws.com/prod/custom_auth" -H 'Authorization: your-secret-token'
</strong></code></pre>

{% hint style="warning" %}
Ανάλογα με τον κώδικα του Lambda, αυτή η εξουσιοδότηση μπορεί να είναι ευάλωτη
{% endhint %}

Σημειώστε ότι αν δημιουργηθεί και επιστραφεί μια **απόρριψη πολιτικής**, το σφάλμα που επιστρέφεται από το API Gateway είναι: `{"Message":"User is not authorized to access this resource with an explicit deny"}`

Με αυτόν τον τρόπο μπορείτε να **αναγνωρίσετε αυτήν την εξουσιοδότηση** που έχει τεθεί σε ισχύ.

### Απαιτείται κλειδί API

Είναι δυνατόν να ορίσετε σημεία πρόσβασης του API που **απαιτούν ένα έγκυρο κλειδί API** για να το επικοινωνήσετε.

<figure><img src="../../../.gitbook/assets/image (92) (1).png" alt=""><figcaption></figcaption></figure>

Είναι δυνατόν να δημιουργήσετε κλειδιά API στο πύλη του API Gateway και ακόμα να ορίσετε πόσο μπορεί να χρησιμοποιηθεί (σε αιτήσεις ανά δευτερόλεπτο και αιτήσεις ανά μήνα).

Για να λειτουργήσει ένα κλειδί API, πρέπει να το προσθέσετε σε ένα **Σχέδιο Χρήσης**, αυτό το σχέδιο χρήσης πρέπει να προστεθεί στο **Στάδιο του API** και το συνδεδεμένο στάδιο του API πρέπει να έχει ρυθμισμένο ένα **περιορισμό μεθόδου** στο **σημείο πρόσβασης** που απαιτεί το κλειδί API:

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Μη εξουσιοδοτημένη πρόσβαση

{% content-ref url="../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md" %}
[aws-api-gateway-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-api-gateway-unauthenticated-enum.md)
{% endcontent-ref %}

## Ανέλιξη προνομιών

{% content-ref url="../aws-privilege-escalation/aws-apigateway-privesc.md" %}
[aws-apigateway-privesc.md](../aws-privilege-escalation/aws-apigateway-privesc.md)
{% endcontent-ref %}

## Μετά την εκμετάλλευση

{% content-ref url="../aws-post-exploitation/aws-api-gateway-post-exploitation.md" %}
[aws-api-gateway-post-exploitation.md](../aws-post-exploitation/aws-api-gateway-post-exploitation.md)
{% endcontent-ref %}

### Διατήρηση

{% content-ref url="../aws-persistence/aws-api-gateway-persistence.md" %}
[aws-api-gateway-persistence.md](../aws-persistence/aws-api-gateway-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
