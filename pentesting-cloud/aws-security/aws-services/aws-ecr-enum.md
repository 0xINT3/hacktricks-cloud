# AWS - ECR Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## ECR

### 基本情報

Amazon **Elastic Container Registry**（Amazon ECR）は、**管理されたコンテナイメージレジストリサービス**です。お客様は、おなじみのDocker CLIまたはお好みのクライアントを使用して、イメージのプッシュ、プル、および管理を行うことができます。

ECRは、**レジストリ**と**リポジトリ**の2つのタイプのオブジェクトで構成されています。

#### レジストリ

すべてのAWSアカウントには、**プライベート**と**パブリック**の2つのレジストリがあります。

1. **プライベートレジストリ**：

* **デフォルトでプライベート**：Amazon ECRプライベートレジストリに格納されているコンテナイメージは、AWSアカウント内の**承認されたユーザー**または許可されたユーザーにのみアクセスできます。
* **プライベートリポジトリ**のURIは、`<account_id>.dkr.ecr.<region>.amazonaws.com/<repo-name>`の形式に従います。
* **アクセス制御**：IAMポリシーを使用して、プライベートコンテナイメージへのアクセスを**制御**することができ、ユーザーまたはロールに基づいて細かい権限を設定することができます。
* **AWSサービスとの統合**：Amazon ECRプライベートレジストリは、EKS、ECSなどの他のAWSサービスと簡単に**統合**できます。
* **その他のプライベートレジストリオプション**：
* タグの不変性列には、タグの不変性が有効になっている場合、既存のタグを持つイメージの**上書きを防止**するためのステータスが表示されます。
* **暗号化タイプ**列には、リポジトリの暗号化プロパティが表示され、AES-256などのデフォルトの暗号化タイプやKMSが有効な暗号化が表示されます。
* **プルスルーキャッシュ**列には、プルスルーキャッシュのステータスが表示され、プルスルーキャッシュステータスがアクティブな場合、**外部のパブリックリポジトリのリポジトリがプライベートリポジトリにキャッシュ**されます。
* 特定の**IAMポリシー**を設定して、異なる**権限**を付与することができます。
* **スキャン構成**では、リポジトリ内のイメージの脆弱性をスキャンすることができます。

2. **パブリックレジストリ**：

* **パブリックアクセス可能**：ECRパブリックレジストリに格納されているコンテナイメージは、認証なしで**インターネット上の誰でもアクセス**できます。
* **パブリックリポジトリ**のURIは、`public.ecr.aws/<random>/<name>`のような形式です。ただし、`<random>`の部分は管理者によって別の文字列に変更できます。

#### **リポジトリ**

これらは、**プライベートレジストリ**または**パブリックレジストリ**の中にある**イメージ**です。

{% hint style="info" %}
イメージをリポジトリにアップロードするには、**ECRリポジトリの名前とイメージの名前が同じ**である必要があることに注意してください。
{% endhint %}

### レジストリとリポジトリのポリシー

**レジストリとリポジトリ**には、他のプリンシパル/アカウントに権限を付与するために使用できる**ポリシー**もあります。たとえば、次のリポジトリポリシーのイメージでは、組織全体のユーザーがイメージにアクセスできるようになっています。

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

### 列挙

{% code overflow="wrap" %}
```bash
# Get repos
aws ecr describe-repositories
aws ecr describe-registry

# Get image metadata
aws ecr list-images --repository-name <repo_name>
aws ecr describe-images --repository-name <repo_name>
aws ecr describe-image-replication-status --repository-name <repo_name> --image-id <image_id>
aws ecr describe-image-scan-findings --repository-name <repo_name> --image-id <image_id>
aws ecr describe-pull-through-cache-rules --repository-name <repo_name> --image-id <image_id>

# Get public repositories
aws ecr-public describe-repositories

# Get policies
aws ecr get-registry-policy
aws ecr get-repository-policy --repository-name <repo_name>
```
{% endcode %}

### 認証されていない列挙

{% content-ref url="../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md" %}
[aws-ecr-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md)
{% endcontent-ref %}

### 特権昇格

次のページで、**ECRの権限を悪用して特権を昇格する方法**を確認できます：

{% content-ref url="../aws-privilege-escalation/aws-ecr-privesc.md" %}
[aws-ecr-privesc.md](../aws-privilege-escalation/aws-ecr-privesc.md)
{% endcontent-ref %}

### 攻撃後の処理

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

### 永続化

{% content-ref url="../aws-persistence/aws-ecr-persistence.md" %}
[aws-ecr-persistence.md](../aws-persistence/aws-ecr-persistence.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有しましょう。

</details>
