# AWS - ECR Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## ECR

### 基本情報

Amazon **Elastic Container Registry** (Amazon ECR)は、**管理されたコンテナイメージレジストリサービス**です。顧客がDocker CLIや任意のクライアントを使用してコンテナイメージをプッシュ、プル、管理するなどの活動を行える環境を提供するように設計されています。

ECRは2種類のオブジェクトで構成されています: **レジストリ**と**リポジトリ**。

#### レジストリ

すべてのAWSアカウントには2つのレジストリがあります: **プライベート**と**パブリック**。

1. **プライベートレジストリ**:

* **デフォルトでプライベート**: Amazon ECRプライベートレジストリに格納されたコンテナイメージは、AWSアカウント内の**承認されたユーザーのみがアクセス可能**です。または、アクセス許可を与えられたユーザーがアクセスできます。
* **プライベートリポジトリ**のURIは`<account_id>.dkr.ecr.<region>.amazonaws.com/<repo-name>`の形式に従います。
* **アクセス制御**: **IAMポリシー**を使用してプライベートコンテナイメージへのアクセスを**制御**でき、ユーザーやロールに基づいて細かいアクセス許可を設定できます。
* **AWSサービスとの統合**: Amazon ECRプライベートレジストリは、EKS、ECSなどの他のAWSサービスと簡単に**統合**できます。
* **その他のプライベートレジストリオプション**:
* タグの不変性列にはその状態がリストされており、タグの不変性が有効になっている場合、既存のタグを使用したイメージの**プッシュ**がイメージの上書きを**防ぎます**。
* **暗号化タイプ**列にはリポジトリの暗号化プロパティがリストされており、AES-256などのデフォルトの暗号化タイプが表示されるか、**KMS**が有効な暗号化が表示されます。
* **プルスルーキャッシュ**列にはその状態がリストされており、プルスルーキャッシュの状態がアクティブであれば、**外部のパブリックリポジトリのリポジトリをプライベートリポジトリにキャッシュ**します。
* 特定の**IAMポリシー**を設定して異なる**権限**を付与できます。
* **スキャン設定**により、リポジトリ内に格納されたイメージの脆弱性をスキャンできます。

2. **パブリックレジストリ**:

* **パブリックアクセシビリティ**: ECRパブリックレジストリに格納されたコンテナイメージは、認証なしでインターネット上の**誰でもアクセス可能**です。
* **パブリックリポジトリ**のURIは`public.ecr.aws/<random>/<name>`のようになります。ただし、`<random>`部分は管理者によって覚えやすい別の文字列に変更することができます。

#### **リポジトリ**

これらは**プライベートレジストリ**または**パブリック**レジストリにある**イメージ**です。

{% hint style="info" %}
イメージをリポジトリにアップロードするためには、**ECRリポジトリはイメージと同じ名前である必要があります**。
{% endhint %}

### レジストリ & リポジトリポリシー

**レジストリとリポジトリ**には、他のプリンシパル/アカウントに権限を付与するために使用できる**ポリシー**もあります。例えば、以下のリポジトリポリシーのイメージでは、組織全体の任意のユーザーがイメージにアクセスできることがわかります：

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

### 列挙

{% code overflow="wrap" %}
```bash
# Get repos
aws ecr describe-repositories
aws ecr describe-registry

# Get image metadata
aws ecr list-images --repository-name <repo_name>
aws ecr describe-images --repository-name <repo_name>
aws ecr describe-image-replication-status --repository-name <repo_name> --image-id <image_id>
aws ecr describe-image-scan-findings --repository-name <repo_name> --image-id <image_id>
aws ecr describe-pull-through-cache-rules --repository-name <repo_name> --image-id <image_id>

# Get public repositories
aws ecr-public describe-repositories

# Get policies
aws ecr get-registry-policy
aws ecr get-repository-policy --repository-name <repo_name>
```
{% endcode %}

### 認証されていない列挙

{% content-ref url="../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md" %}
[aws-ecr-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md)
{% endcontent-ref %}

### 権限昇格

以下のページでは、**ECRの権限を悪用して権限を昇格させる方法**を確認できます：

{% content-ref url="../aws-privilege-escalation/aws-ecr-privesc.md" %}
[aws-ecr-privesc.md](../aws-privilege-escalation/aws-ecr-privesc.md)
{% endcontent-ref %}

### 攻撃後の活動

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

### 持続性

{% content-ref url="../aws-persistence/aws-ecr-persistence.md" %}
[aws-ecr-persistence.md](../aws-persistence/aws-ecr-persistence.md)
{% endcontent-ref %}

# 参考文献
* [https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html](https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSのハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
