# AWS - ECR Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れる
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する
- **ハッキングトリックを共有するには、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください**

</details>

## ECR

### 基本情報

Amazon **Elastic Container Registry**（Amazon ECR）は、**管理されたコンテナイメージレジストリサービス**です。顧客がよく知られたインターフェースを使用してコンテナイメージとやり取りできる環境を提供するよう設計されています。具体的には、Docker CLIや任意のクライアントを使用して、プッシュ、プル、およびコンテナイメージの管理などのアクティビティがサポートされています。

ECRは**レジストリ**と**リポジトリ**の2種類のオブジェクトで構成されています。

#### レジストリ

すべてのAWSアカウントには、**プライベート**と**パブリック**の2つのレジストリがあります。

1. **プライベートレジストリ**：

- **デフォルトでプライベート**：Amazon ECRプライベートレジストリに格納されているコンテナイメージは、AWSアカウント内の承認されたユーザーまたは許可されたユーザーにのみアクセス可能です。
- **プライベートリポジトリ**のURIは、`<account_id>.dkr.ecr.<region>.amazonaws.com/<repo-name>`の形式に従います。
- **アクセス制御**：プライベートコンテナイメージへのアクセスを**IAMポリシー**を使用して制御でき、ユーザーやロールに基づいて細かい権限を構成できます。
- **AWSサービスとの統合**：Amazon ECRプライベートレジストリは、EKS、ECSなどの他のAWSサービスと簡単に**統合**できます。
- **その他のプライベートレジストリオプション**：
- タグの不変性列には、有効になっている場合、タグの不変性が**事前に存在するタグ**のイメージを**上書きするプッシュ**を**防止**します。
- **暗号化タイプ**列には、リポジトリの暗号化プロパティがリストされ、AES-256などのデフォルトの暗号化タイプ、または**KMS**が有効になっている暗号化が表示されます。
- **Pull through cache**列には、Pull through cacheステータスがActiveの場合、**外部のパブリックリポジトリ内のリポジトリをプライベートリポジトリにキャッシュ**します。
- 特定の**IAMポリシー**を構成して異なる**権限**を付与できます。
- **スキャン構成**を使用して、リポジトリ内に格納されているイメージの脆弱性をスキャンできます。

2. **パブリックレジストリ**：

- **パブリックアクセス**：ECRパブリックレジストリに格納されているコンテナイメージは、**認証なしでインターネット上の誰でもアクセス**できます。
- **パブリックリポジトリ**のURIは、`public.ecr.aws/<random>/<name>`のような形式です。ただし、`<random>`部分は管理者によって別の文字列に変更され、覚えやすいものになる可能性があります。

#### **リポジトリ**

これらは**プライベートレジストリ**または**パブリック**の中にある**イメージ**です。

{% hint style="info" %}
リポジトリにイメージをアップロードするには、**ECRリポジトリがイメージと同じ名前である必要がある**ことに注意してください。
{% endhint %}

### レジストリとリポジトリポリシー

**レジストリとリポジトリ**には、他の主体/アカウントに権限を付与するために使用できる**ポリシー**もあります。たとえば、次のリポジトリポリシー画像では、組織全体のユーザーがイメージにアクセスできるようになります。

<figure><img src="../../../.gitbook/assets/image (87).png" alt=""><figcaption></figcaption></figure>

### 列挙

{% code overflow="wrap" %}
```bash
# Get repos
aws ecr describe-repositories
aws ecr describe-registry

# Get image metadata
aws ecr list-images --repository-name <repo_name>
aws ecr describe-images --repository-name <repo_name>
aws ecr describe-image-replication-status --repository-name <repo_name> --image-id <image_id>
aws ecr describe-image-scan-findings --repository-name <repo_name> --image-id <image_id>
aws ecr describe-pull-through-cache-rules --repository-name <repo_name> --image-id <image_id>

# Get public repositories
aws ecr-public describe-repositories

# Get policies
aws ecr get-registry-policy
aws ecr get-repository-policy --repository-name <repo_name>
```
{% endcode %}

### 認証されていない列挙

{% content-ref url="../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md" %}
[aws-ecr-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-ecr-unauthenticated-enum.md)
{% endcontent-ref %}

### 特権昇格

次のページで、**ECR権限を悪用して特権を昇格する方法**を確認できます：

{% content-ref url="../aws-privilege-escalation/aws-ecr-privesc.md" %}
[aws-ecr-privesc.md](../aws-privilege-escalation/aws-ecr-privesc.md)
{% endcontent-ref %}

### 攻撃後の活用

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

### 永続化

{% content-ref url="../aws-persistence/aws-ecr-persistence.md" %}
[aws-ecr-persistence.md](../aws-persistence/aws-ecr-persistence.md)
{% endcontent-ref %}

# 参考文献
* [https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html](https://docs.aws.amazon.com/AmazonECR/latest/APIReference/Welcome.html)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
