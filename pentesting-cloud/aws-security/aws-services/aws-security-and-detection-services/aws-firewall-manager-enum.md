# AWS - 防火墙管理器枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 防火墙管理器

**AWS防火墙管理器**简化了**AWS WAF、AWS Shield高级版、Amazon VPC安全组和网络访问控制列表（ACLs）、AWS网络防火墙、AWS Route 53解析器DNS防火墙和第三方防火墙**的管理和维护，跨多个帐户和资源。它使您能够仅需一次配置防火墙规则、Shield高级版保护、VPC安全组和网络防火墙设置，服务将**自动强制执行这些规则和保护跨您的帐户和资源**，包括新添加的资源。

该服务提供了**将特定资源分组和保护在一起**的能力，比如共享共同标签或所有CloudFront分发。防火墙管理器的一个重要优势是其能够**自动将保护扩展到您帐户中新添加的资源**。

一个**规则组**（一组WAF规则）可以被纳入AWS防火墙管理器策略中，然后链接到特定的AWS资源，比如CloudFront分发或应用程序负载均衡器。

AWS防火墙管理器提供**托管的应用程序和协议列表**，以简化安全组策略的配置和管理。这些列表允许您定义由您的策略允许或拒绝的协议和应用程序。有两种类型的托管列表：

* **防火墙管理器托管列表**：这些列表包括**FMS-Default-Public-Access-Apps-Allowed**、**FMS-Default-Protocols-Allowed**和**FMS-Default-Protocols-Allowed**。它们由防火墙管理器管理，并包括应该允许或拒绝给一般公众使用的常用应用程序和协议。无法编辑或删除它们，但可以选择其版本。
* **自定义托管列表**：您自己管理这些列表。您可以创建符合组织需求的自定义应用程序和协议列表。与防火墙管理器托管列表不同，这些列表没有版本，但您可以完全控制自定义列表，允许您根据需要创建、编辑和删除它们。

需要注意的是，**防火墙管理器策略仅允许对规则组执行“阻止”或“计数”操作**，没有“允许”的选项。

### 先决条件

在继续配置防火墙管理器以有效保护您组织的资源之前，必须完成以下先决步骤。这些步骤提供了防火墙管理器强制执行安全策略和确保符合AWS环境的基础设置所需的基础设置：

1. **加入并配置AWS组织：** 确保您的AWS帐户是AWS组织的一部分，计划在其中实施AWS防火墙管理器策略。这允许在组织内跨多个AWS帐户集中管理资源和策略。
2. **创建AWS防火墙管理器默认管理员帐户：** 为专门管理防火墙管理器安全策略的默认管理员帐户建立一个帐户。此帐户将负责配置和强制执行整个组织的安全策略。只有组织的管理帐户能够创建防火墙管理器默认管理员帐户。
3. **启用AWS Config：** 激活AWS Config，为防火墙管理器提供必要的配置数据和见解，以有效强制执行安全策略。AWS Config有助于分析、审计、监控和审计资源配置和更改，促进更好的安全管理。
4. **对于第三方策略，在AWS Marketplace中订阅并配置第三方设置：** 如果您计划使用第三方防火墙策略，请在AWS Marketplace中订阅并配置必要的设置。此步骤确保防火墙管理器可以集成和强制执行来自受信任第三方供应商的策略。
5. **对于网络防火墙和DNS防火墙策略，启用资源共享：** 启用资源共享，特别是针对网络防火墙和DNS防火墙策略。这使防火墙管理器可以将防火墙保护应用到组织的VPC和DNS解析，增强网络安全。
6. **在默认情况下禁用的区域中使用AWS防火墙管理器：** 如果您打算在默认情况下禁用的AWS区域中使用防火墙管理器，请确保采取必要步骤在这些区域启用其功能。这确保了在组织运营的所有区域中实施一致的安全强制执行。

有关更多信息，请查看：[开始使用AWS防火墙管理器AWS WAF策略](https://docs.aws.amazon.com/waf/latest/developerguide/getting-started-fms.html)。

### 保护策略类型

AWS防火墙管理器管理多种类型的策略，以强制执行安全控制跨组织基础架构的不同方面：

1. **AWS WAF策略：** 此策略类型支持AWS WAF和AWS WAF经典版。您可以定义由该策略保护的资源。对于AWS WAF策略，您可以指定要在Web ACL中首先和最后运行的规则组集。此外，帐户所有者可以添加规则和规则组以在这些集合之间运行。
2. **Shield高级版策略：** 此策略为指定的资源类型在整个组织中应用Shield高级版保护。它有助于防范DDoS攻击和其他威胁。
3. **Amazon VPC安全组策略：** 使用此策略，您可以管理在整个组织中使用的安全组，强制执行一组基线规则跨AWS环境控制网络访问。
4. **Amazon VPC网络访问控制列表（ACL）策略：** 此策略类型使您可以控制组织中使用的网络ACL，允许您在AWS环境中强制执行一组基线网络ACL。
5. **网络防火墙策略：** 此策略将AWS网络防火墙保护应用到组织的VPC，通过根据预定义规则过滤流量增强网络安全。
6. **Amazon Route 53解析器DNS防火墙策略：** 此策略将DNS防火墙保护应用到组织的VPC，有助于阻止恶意域名解析尝试并强制执行DNS流量的安全策略。
7. **第三方防火墙策略：** 此策略类型应用来自AWS Marketplace控制台订阅的第三方防火墙的保护措施。它允许您将来自受信任供应商的额外安全措施集成到您的AWS环境中。
1. **Palo Alto Networks云NGFW策略：** 此策略将Palo Alto Networks云下一代防火墙（NGFW）保护和规则堆栈应用到组织的VPC，提供高级威胁预防和应用级安全控制。
2. **Fortigate云原生防火墙（CNF）作为服务策略：** 此策略将Fortigate云原生防火墙（CNF）作为服务保护应用到组织的VPC，提供行业领先的威胁预防、Web应用程序防火墙（WAF）和API保护，专为云基础架构量身定制。
### 管理员账户

AWS防火墙管理器通过其管理范围和两种类型的管理员账户，为您的组织提供了管理防火墙资源的灵活性。

**管理范围定义了防火墙管理器管理员可以管理的资源**。在AWS组织管理账户将组织接入防火墙管理器后，它可以创建具有不同管理范围的其他管理员。这些范围可以包括：

- 管理员可以应用策略的账户或组织单位（OUs）。
- 管理员可以执行操作的区域。
- 管理员可以管理的防火墙管理器策略类型。

管理范围可以是**完整或受限**。完整范围授予管理员访问**所有指定的资源类型、区域和策略类型**。相比之下，**受限范围仅提供对资源、区域或策略类型的部分管理权限**。建议仅授予管理员完成其角色所需的权限。您可以将这些管理范围条件的任意组合应用于管理员，确保遵守最小特权原则。

有两种不同类型的管理员账户，每种都担当特定的角色和责任：

- **默认管理员：**
- 默认管理员账户是由AWS组织组织的管理账户在将组织接入防火墙管理器的过程中创建的。
- 该账户具有管理第三方防火墙的能力，并拥有完整的管理范围。
- 它作为防火墙管理器的主要管理员账户，负责配置和执行组织内的安全策略。
- 虽然默认管理员对所有资源类型和管理功能具有完全访问权限，但如果组织内使用多个管理员，则它将在同一对等级别上运行。
- **防火墙管理器管理员：**
- 这些管理员可以在由AWS组织管理账户指定的管理范围内管理资源，具体取决于管理范围配置。
- 防火墙管理器管理员被创建以履行组织内的特定角色，允许委派责任同时保持安全和合规标准。
- 创建后，防火墙管理器会与AWS组织进行检查，以确定该账户是否已经是委派管理员。如果不是，则防火墙管理器会调用组织来指定该账户为防火墙管理器的委派管理员。

管理这些管理员账户涉及在防火墙管理器内创建它们，并根据组织的安全要求和最小特权原则定义它们的管理范围。通过分配适当的管理角色，组织可以确保有效的安全管理，同时保持对敏感资源访问的细粒度控制。

需要强调的是**组织内只能有一个账户充当防火墙管理器的默认管理员**，遵循“**先进先出**”原则。要指定新的默认管理员，必须遵循一系列步骤：

- 首先，每个防火墙管理员管理员账户必须撤销自己的账户。
- 然后，现有的默认管理员可以撤销自己的账户，有效地将组织从防火墙管理器中移出。此过程将导致撤销账户创建的所有防火墙管理器策略被删除。
- 最后，AWS组织管理账户必须指定防火墙管理器的默认管理员。

## 枚举
```
# Users/Administrators

## Get the AWS Organizations account that is associated with AWS Firewall Manager as the AWS Firewall Manager default administrator
aws fms get-admin-account

## List of Firewall Manager administrators within the organization
aws fms list-admin-accounts-for-organization # ReadOnlyAccess policy is not enough for this

## Return a list of the member accounts in the FM administrator's AWS organization
aws fms list-member-accounts # Only a Firewall Manager administrator or the Organization's management account can make this request

## List the accounts that are managing the specified AWS Organizations member account
aws fms list-admins-managing-account # ReadOnlyAccess policy is not enough for this

# Resources

## Get the resources that a Firewall Manager administrator can manage
aws fms get-admin-scope --admin-account <value> # ReadOnlyAccess policy is not enough for this

## Returns the summary of the resource sets used
aws fms list-resource-sets # ReadOnlyAccess policy is not enough for this

## Get information about a specific resource set
aws fms get-resource-set --identifier <value>  # ReadOnlyAccess policy is not enough for this

## Retrieve the list of tags for a given resource
aws fms list-tags-for-resource --resource-arn <value>

## List of the resources in the AWS Organization's accounts that are available to be associated with a FM resource set. Only one account is supported per request.
aws fms list-compliance-status --member-account-ids <value> --resource-type <value> # ReadOnlyAccess policy is not enough for this

## List the resources that are currently associated to a resource set
aws fms list-resource-set-resources --identifier <value> # ReadOnlyAccess policy is not enough for this

# Policies

## Returns the list of policies
aws fms list-policies

## Get information about the specified AWS Firewall Manager policy
aws fms get-policy --policy-id <value>

## List all of the third-party firewall policies that are associated with the third-party firewall administrator's account
aws fms list-third-party-firewall-firewall-policies --third-party-firewall <PALO_ALTO_NETWORKS_CLOUD_NGFW|FORTIGATE_CLOUD_NATIVE_FIREWALL> # ReadOnlyAccess policy is not enough for this

# AppsList

## Return a list of apps list
aws fms list-apps-lists --max-results [1-100]

## Get information about the specified AWS Firewall Manager applications list
aws fms get-apps-list --list-id <value>

# Protocols

## Get the details of the Firewall Manager protocols list.
aws fms list-protocols-lists

## Get information about the specified AWS Firewall Manager Protocols list
aws fms get-protocols-list --list-id <value>

# Compliance

## Return a summary of which member accounts are protected by the specified policy
aws fms list-compliance-status --policy-id <policy-id>

## Get detailed compliance information about the specified member account (resources that are in and out of compliance with the specified policy)
aws fms get-compliance-detail --policy-id <value> --member-account <value>

# Other useful info

## Get information about the SNS topic that is used to record AWS Firewall Manager SNS logs (if any)
aws fms get-notification-channel

## Get policy-level attack summary information in the event of a potential DDoS attack
aws fms get-protection-status --policy-id <value> # Just for Shield Advanced policy

## Get the onboarding status of a Firewall Manager admin account to third-party firewall vendor tenant.
aws fms get-third-party-firewall-association-status --third-party-firewall <PALO_ALTO_NETWORKS_CLOUD_NGFW|FORTIGATE_CLOUD_NATIVE_FIREWALL> # ReadOnlyAccess policy is not enough for this

## Get violations' details for a resource based on the specified AWS Firewall Manager policy and AWS account.
aws fms get-violation-details --policy-id <value> --member-account <value> --resource-id <value> --resource-type <value>
```
## 后渗透 / 绕过检测

### `organizations:DescribeOrganization` & (`fms:AssociateAdminAccount`, `fms:DisassociateAdminAccount`, `fms:PutAdminAccount`)
拥有 **`fms:AssociateAdminAccount`** 权限的攻击者可以设置防火墙管理器的默认管理员帐户。具有 **`fms:PutAdminAccount`** 权限的攻击者可以创建或更新防火墙管理器管理员帐户，而具有 **`fms:DisassociateAdminAccount`** 权限的潜在攻击者可以移除当前防火墙管理器管理员帐户的关联。

- **防火墙管理器默认管理员的取消关联遵循先进后出原则**。在防火墙管理器默认管理员可以取消关联帐户之前，所有防火墙管理器管理员必须取消关联。
- 为了通过 **PutAdminAccount** 创建防火墙管理器管理员，该帐户必须属于之前使用 **AssociateAdminAccount** 将其纳入防火墙管理器的组织。
- 只有组织的管理帐户才能创建防火墙管理器管理员帐户。
```bash
aws fms associate-admin-account --admin-account <value>
aws fms disassociate-admin-account
aws fms put-admin-account --admin-account <value>
```
**潜在影响:** 集中管理丢失，策略规避，合规性违规，以及环境内安全控制的中断。

### `fms:PutPolicy`, `fms:DeletePolicy`

拥有 **`fms:PutPolicy`**、**`fms:DeletePolicy`** 权限的攻击者可以创建、修改或永久删除 AWS 防火墙管理器策略。
```bash
aws fms put-policy --policy <value> | --cli-input-json file://<policy.json> [--tag-list <value>]
aws fms delete-policy --policy-id <value> [--delete-all-policy-resources | --no-delete-all-policy-resources]
```
一个通过宽松安全组实现宽松策略的示例，以绕过检测，可能是以下内容：
```json
{
"Policy": {
"PolicyName": "permisive_policy",
"SecurityServicePolicyData": {
"Type": "SECURITY_GROUPS_COMMON",
"ManagedServiceData": "{\"type\":\"SECURITY_GROUPS_COMMON\",\"securityGroups\":[{\"id\":\"<permisive_security_group_id>\"}], \"applyToAllEC2InstanceENIs\":\"true\",\"IncludeSharedVPC\":\"true\"}"
},
"ResourceTypeList": ["AWS::EC2::Instance", "AWS::EC2::NetworkInterface", "AWS::EC2::SecurityGroup", "AWS::ElasticLoadBalancingV2::LoadBalancer", "AWS::ElasticLoadBalancing::LoadBalancer"],
"ResourceType": "AWS::EC2::SecurityGroup",
"ExcludeResourceTags": false,
"ResourceTags": [],
"RemediationEnabled": true
},
"TagList": []
}
```
**潜在影响:** 安全控制拆除，策略规避，合规性违规，运营中断，以及环境内潜在数据泄露。

### `fms:BatchAssociateResource`, `fms:BatchDisassociateResource`, `fms:PutResourceSet`, `fms:DeleteResourceSet`

拥有 **`fms:BatchAssociateResource`** 和 **`fms:BatchDisassociateResource`** 权限的攻击者可以分别将资源与防火墙管理器资源集关联或取消关联。此外，**`fms:PutResourceSet`** 和 **`fms:DeleteResourceSet`** 权限允许攻击者在 AWS 防火墙管理器中创建、修改或删除这些资源集。
```bash
# Associate/Disassociate resources from a resource set
aws fms batch-associate-resource --resource-set-identifier <value> --items <value>
aws fms batch-disassociate-resource --resource-set-identifier <value> --items <value>

# Create, modify or delete a resource set
aws fms put-resource-set --resource-set <value> [--tag-list <value>]
aws fms delete-resource-set --identifier <value>
```
**潜在影响：** 向资源集添加不必要数量的项目将增加服务中的噪音级别，可能导致 DoS。此外，资源集的更改可能导致资源中断、策略规避、合规性违规以及环境中安全控制的中断。

### `fms:PutAppsList`，`fms:DeleteAppsList`

拥有 **`fms:PutAppsList`** 和 **`fms:DeleteAppsList`** 权限的攻击者可以在 AWS 防火墙管理器中创建、修改或删除应用程序列表。这可能非常关键，因为未经授权的应用程序可能被允许访问一般公众，或者可能拒绝对授权应用程序的访问，从而导致 DoS。
```bash
aws fms put-apps-list --apps-list <value> [--tag-list <value>]
aws fms delete-apps-list --list-id <value>
```
**潜在影响：** 这可能导致环境中的配置错误、策略规避、合规性违规以及安全控制中断。

### `fms:PutProtocolsList`，`fms:DeleteProtocolsList`

拥有 **`fms:PutProtocolsList`** 和 **`fms:DeleteProtocolsList`** 权限的攻击者可以在 AWS 防火墙管理器中创建、修改或删除协议列表。与应用程序列表类似，这可能是关键的，因为未经授权的协议可能被普通公众使用，或者可能拒绝使用授权的协议，导致 DoS。
```bash
aws fms put-protocols-list --apps-list <value> [--tag-list <value>]
aws fms delete-protocols-list --list-id <value>
```
**潜在影响:** 这可能导致环境中的错误配置、策略规避、合规性违规以及安全控制中断。

### `fms:PutNotificationChannel`, `fms:DeleteNotificationChannel`

拥有 **`fms:PutNotificationChannel`** 和 **`fms:DeleteNotificationChannel`** 权限的攻击者可以删除并指定 Firewall Manager 用于记录 SNS 日志的 IAM 角色和Amazon Simple Notification Service (SNS) 主题。

要在控制台之外使用 **`fms:PutNotificationChannel`**，需要设置 SNS 主题的访问策略，允许指定的 **SnsRoleName** 发布 SNS 日志。如果提供的 **SnsRoleName** 是除 **`AWSServiceRoleForFMS`** 之外的角色，则需要配置信任关系以允许 Firewall Manager 服务主体 **fms.amazonaws.com** 承担此角色。

有关配置 SNS 访问策略的信息：

{% content-ref url="../aws-services/aws-sns-enum.md" %}
[aws-sns-enum.md](../aws-services/aws-sns-enum.md)
{% endcontent-ref %}
```bash
aws fms put-notification-channel --sns-topic-arn <value> --sns-role-name <value>
aws fms delete-notification-channel
```
**潜在影响：** 这可能导致安全警报被忽略，事件响应延迟，潜在数据泄露以及环境中的运营中断。

### `fms:AssociateThirdPartyFirewall`，`fms:DisssociateThirdPartyFirewall`
拥有 **`fms:AssociateThirdPartyFirewall`**，**`fms:DisssociateThirdPartyFirewall`** 权限的攻击者可以将第三方防火墙与通过 AWS防火墙管理器进行集中管理关联或取消关联。
{% hint style="warning" %}
只有默认管理员可以创建和管理第三方防火墙。
{% endhint %}
```bash
aws fms associate-third-party-firewall --third-party-firewall [PALO_ALTO_NETWORKS_CLOUD_NGFW | FORTIGATE_CLOUD_NATIVE_FIREWALL]
aws fms disassociate-third-party-firewall --third-party-firewall [PALO_ALTO_NETWORKS_CLOUD_NGFW | FORTIGATE_CLOUD_NATIVE_FIREWALL]
```
**潜在影响:** 解除关联将导致策略规避、合规性违规以及环境内安全控制的中断。另一方面，关联将导致成本和预算分配的中断。

### `fms:TagResource`, `fms:UntagResource`

攻击者可以向防火墙管理器资源添加、修改或移除标签，从而破坏您组织基于标签的成本分配、资源跟踪和访问控制策略。
```bash
aws fms tag-resource --resource-arn <value> --tag-list <value>
aws fms untag-resource --resource-arn <value> --tag-keys <value>
```
**潜在影响**：破坏成本分配、资源跟踪和基于标记的访问控制策略。

## 参考资料

* [https://docs.aws.amazon.com/govcloud-us/latest/UserGuide/govcloud-fms.html](https://docs.aws.amazon.com/govcloud-us/latest/UserGuide/govcloud-fms.html)
* [https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsfirewallmanager.html](https://docs.aws.amazon.com/service-authorization/latest/reference/list_awsfirewallmanager.html)
* [https://docs.aws.amazon.com/waf/latest/developerguide/fms-chapter.html](https://docs.aws.amazon.com/waf/latest/developerguide/fms-chapter.html)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
