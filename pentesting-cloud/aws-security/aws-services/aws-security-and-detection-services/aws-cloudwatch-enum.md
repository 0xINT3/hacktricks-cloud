# AWS - CloudWatch 枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## CloudWatch

**CloudWatch** **收集**监控和操作**数据**，形式为日志/指标/事件，提供AWS资源、应用程序和服务的**统一视图**。\
CloudWatch日志事件对每条日志行有**256KB的大小限制**。\
它可以设置**高分辨率警报**，并排可视化**日志**和**指标**，采取自动化操作，排除故障，并发现洞察以优化应用程序。

您可以监控例如CloudTrail的日志。被监控的事件包括：

* 安全组和NACLs的变更
* 启动、停止、重启和终止EC2实例
* IAM和S3内的安全策略变更
* AWS管理控制台的登录尝试失败
* 导致授权失败的API调用
* 在cloudwatch中搜索的过滤器：[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch 日志 <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

允许**聚合和监控来自应用程序**和系统的日志，包括**AWS服务**（包括CloudTrail）和**来自应用/系统**的日志（可以在主机上安装**CloudWatch Agent**）。日志可以**无限期存储**（取决于日志组设置），并且可以导出。

**元素**：

| **日志组**                | 一系列共享相同保留、监控和访问控制设置的**日志流**                                                                                   |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **日志流**               | 一系列共享**相同来源**的**日志事件**                                                                                                                      |
| **订阅过滤器**           | 定义一个**匹配特定日志组中事件的过滤模式**，将它们发送到Kinesis Data Firehose流、Kinesis流或Lambda函数                                                  |

### CloudWatch 监控 & 事件

CloudWatch **基础**每**5分钟**聚合数据一次（**详细**的每**1分钟**一次）。聚合后，它会**检查警报的阈值**，以防需要触发一个。\
在这种情况下，CloudWatch可以准备发送一个事件并执行一些自动操作（AWS lambda函数、SNS主题、SQS队列、Kinesis流）

### Agent 安装

您可以在您的机器/容器内安装代理，以自动将日志发送回CloudWatch。

* **创建**一个**角色**并将其**附加**到具有允许CloudWatch从实例收集数据以及与AWS系统管理器SSM（CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM）交互权限的**实例**
* **下载**并**安装**代理到EC2实例（[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)）。您可以从EC2内部下载，也可以使用AWS系统管理器自动安装，选择AWS-ConfigureAWSPackage包
* **配置**并**启动**CloudWatch代理

一个日志组有许多流。一个流有许多事件。并且在每个流内部，事件的顺序是有保证的。

## 操作

### 枚举
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## 避免被检测

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDuty 每5分钟将其发现同步到 Cloudwatch 事件。修改事件模式或事件的目标**可能会减少 GuardDuty 警报和触发自动修复发现的能力**，尤其是在成员账户中触发修复时，因为 GuardDuty 管理员保护并不扩展到成员账户中的 Cloudwatch 事件。

{% hint style="info" %}
在委托或邀请管理员的 GuardDuty 架构中，cloudwatch 事件仍将在管理员账户中创建。
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## 参考资料

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客技术！</strong></summary>

其他支持 HackTricks 的方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
