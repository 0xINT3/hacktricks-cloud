# AWS - CloudWatch枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## CloudWatch

**CloudWatch**以日志/指标/事件的形式**收集**监控和运营**数据**，提供对AWS资源、应用程序和服务的**统一视图**。\
CloudWatch日志事件每行日志有**256KB的大小限制**。\
它可以设置**高分辨率警报**，将**日志**和**指标**并排显示，执行自动操作，解决问题，并发现优化应用程序的见解。

例如，您可以监控来自CloudTrail的日志。监控的事件包括：

* 安全组和NACL的更改
* 启动、停止、重启和终止EC2实例
* IAM和S3中的安全策略更改
* 对AWS管理控制台的登录尝试失败
* 导致授权失败的API调用
* 在cloudwatch中搜索的过滤器：[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch日志 <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

允许**聚合和监控来自应用程序**和**AWS服务**（包括CloudTrail）以及**应用程序/系统**的日志（可以在主机上安装CloudWatch代理）。日志可以**无限期存储**（取决于日志组设置）并且可以导出。

**元素**：

| **日志组**            | 具有相同保留、监控和访问控制设置的**日志流集合**                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **日志流**           | 具有**相同来源**的**日志事件**序列                                                                                                |
| **订阅过滤器** | 定义与特定日志组中的事件匹配的**过滤模式**，将其发送到Kinesis Data Firehose流、Kinesis流或Lambda函数 |

### CloudWatch监控和事件

CloudWatch **基本**每5分钟聚合一次数据（**详细**模式每1分钟聚合一次）。聚合后，它会**检查警报的阈值**，以确定是否需要触发警报。\
在这种情况下，CloudWatch可以准备发送事件并执行一些自动操作（AWS Lambda函数、SNS主题、SQS队列、Kinesis流）

### 代理安装

您可以在您的机器/容器内安装代理，以自动将日志发送回CloudWatch。

* **创建**一个**角色**并将其**附加**到**实例**上，该角色具有允许CloudWatch从实例收集数据以及与AWS系统管理器SSM交互的权限（CloudWatchAgentAdminPolicy和AmazonEC2RoleforSSM）
* **下载**并**安装**代理到EC2实例（[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)）。您可以从EC2内部下载它，或者使用AWS系统管理器自动安装它，选择AWS-ConfigureAWSPackage软件包
* **配置**并**启动**CloudWatch代理

一个日志组有多个流。一个流有多个事件。在每个流中，事件的顺序是有保证的。

## 操作

### 枚举
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## 避免被检测

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDuty以5分钟的频率将其发现结果填充到Cloudwatch Events中。修改事件模式或事件的目标**可能会降低GuardDuty的警报能力和触发发现结果的自动修复**，特别是在成员账户中触发修复时，GuardDuty管理员保护不会扩展到成员账户中的Cloudwatch事件。

{% hint style="info" %}
在委派或邀请管理员GuardDuty架构中，Cloudwatch事件仍将在管理员账户中创建。
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## 参考资料

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
