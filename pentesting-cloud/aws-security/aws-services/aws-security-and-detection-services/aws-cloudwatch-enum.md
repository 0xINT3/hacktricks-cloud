# AWS - CloudWatch Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## CloudWatch

**CloudWatch**は、ログ/メトリクス/イベントの形で監視と運用**データ**を**収集**し、AWSリソース、アプリケーション、サービスの**統合ビュー**を提供します。\
CloudWatch Log Eventは、各ログラインに**256KBのサイズ制限**があります。\
**高解像度のアラーム**を設定し、**ログ**と**メトリクス**を並べて可視化し、自動化されたアクションを取り、問題をトラブルシューティングし、アプリケーションを最適化するための洞察を発見することができます。

例えば、CloudTrailからのログを監視することができます。監視されるイベントには以下が含まれます:

* セキュリティグループとNACLの変更
* EC2インスタンスの起動、停止、再起動、終了
* IAMとS3内のセキュリティポリシーの変更
* AWS管理コンソールへのログイン試行の失敗
* 認証に失敗したAPIコール
* cloudwatchでの検索フィルタ: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch Logs <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

**AWSサービス**（CloudTrailを含む）および**アプリ/システム**からのログを**集約して監視**することができます（**CloudWatch Agent**はホストにインストール可能）。ログは**無期限に保存**されることができ（ロググループの設定に依存）、エクスポートすることができます。

**要素**:

| **Log Group**            | 同じ保持期間、監視、アクセス制御設定を共有する**ログストリームの集合**                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Log Stream**           | **同じソース**を共有する**ログイベント**のシーケンス                                                                                                      |
| **Subscription Filters** | 特定のロググループ内のイベントに**マッチするフィルターパターンを定義**し、それらをKinesis Data Firehoseストリーム、Kinesisストリーム、またはLambda関数に送信する |

### CloudWatch Monitoring & Events

CloudWatch **基本**は**5分ごと**にデータを集約し（**詳細**なものは**1分ごと**）、集約後にアラームのしきい値を**チェック**して必要に応じてトリガーします。\
その場合、CloudWatchはイベントを送信し、自動アクションを実行する準備ができています（AWS lambda関数、SNSトピック、SQSキュー、Kinesisストリーム）

### エージェントのインストール

マシン/コンテナ内にエージェントをインストールして、ログを自動的にCloudWatchに送信することができます。

* **ロールを作成**し、CloudWatchがインスタンスからデータを収集し、AWSシステムマネージャSSMと連携する権限を持つインスタンスに**アタッチ**する（CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM）
* EC2インスタンスに**エージェントをダウンロード**して**インストール**する（[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)）。EC2内からダウンロードするか、AWS System Managerを使用して自動的にインストールすることができます（パッケージAWS-ConfigureAWSPackageを選択）
* CloudWatch Agentを**設定**して**起動**する

ロググループには多くのストリームがあります。ストリームには多くのイベントがあります。そして、各ストリーム内では、イベントが順序通りであることが保証されています。

## アクション

### 列挙
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## 検出を避ける

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDutyは、5分間隔でその検出結果をCloudwatch Eventsに送信します。イベントのパターンやターゲットを変更することは、**特にリメディエーションがメンバーアカウントでトリガーされる場合、GuardDutyがアラートを出し、自動リメディエーションをトリガーする能力を低下させる可能性があります**。なぜなら、GuardDuty管理者の保護はメンバーアカウントのCloudwatchイベントには及ばないからです。

{% hint style="info" %}
委任されたり招待された管理者のGuardDutyアーキテクチャでは、cloudwatchイベントは管理アカウントで引き続き作成されます。
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## 参考文献

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
