# AWS - CloudWatch Enum

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## CloudWatch

**CloudWatch** **coleta** dados de monitoramento e operacionais na forma de logs/m√©tricas/eventos fornecendo uma **vis√£o unificada dos recursos da AWS**, aplica√ß√µes e servi√ßos.\
Eventos de Log do CloudWatch t√™m uma **limita√ß√£o de tamanho de 256KB por linha de log**.\
Pode configurar **alarmes de alta resolu√ß√£o**, visualizar **logs** e **m√©tricas** lado a lado, tomar a√ß√µes automatizadas, solucionar problemas e descobrir insights para otimizar aplica√ß√µes.

Voc√™ pode monitorar, por exemplo, logs do CloudTrail. Eventos que s√£o monitorados:

* Altera√ß√µes em Security Groups e NACLs
* Iniciar, Parar, reiniciar e terminar inst√¢ncias EC2
* Altera√ß√µes em Pol√≠ticas de Seguran√ßa dentro do IAM e S3
* Tentativas de login falhadas no AWS Management Console
* Chamadas de API que resultaram em autoriza√ß√£o falhada
* Filtros para pesquisa no cloudwatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch Logs <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permite **agregar e monitorar logs de aplica√ß√µes** e sistemas de **servi√ßos da AWS** (incluindo CloudTrail) e **de apps/sistemas** (**Agente CloudWatch** pode ser instalado em um host). Logs podem ser **armazenados indefinidamente** (dependendo das configura√ß√µes do Grupo de Logs) e podem ser exportados.

**Elementos**:

| **Log Group**            | Uma **cole√ß√£o de fluxos de log** que compartilham as mesmas configura√ß√µes de reten√ß√£o, monitoramento e controle de acesso                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Log Stream**           | Uma sequ√™ncia de **eventos de log** que compartilham a **mesma fonte**                                                                                                |
| **Subscription Filters** | Define um **padr√£o de filtro que corresponde a eventos** em um grupo de log espec√≠fico, enviando-os para um stream do Kinesis Data Firehose, stream do Kinesis ou uma fun√ß√£o Lambda |

### CloudWatch Monitoring & Events

CloudWatch **b√°sico** agrega dados **a cada 5min** (o **detalhado** faz isso **a cada 1 min**). Ap√≥s a agrega√ß√£o, **verifica os limiares dos alarmes** caso precise acionar um.\
Nesse caso, CloudWatch pode ser preparado para enviar um evento e realizar algumas a√ß√µes autom√°ticas (fun√ß√µes lambda da AWS, t√≥picos SNS, filas SQS, Streams Kinesis)

### Instala√ß√£o do Agente

Voc√™ pode instalar agentes dentro de suas m√°quinas/containers para enviar automaticamente os logs de volta para o CloudWatch.

* **Crie** um **papel** e **anexe** √† **inst√¢ncia** com permiss√µes que permitem ao CloudWatch coletar dados das inst√¢ncias al√©m de interagir com o gerenciador de sistemas da AWS SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Baixe** e **instale** o **agente** na inst√¢ncia EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Voc√™ pode baix√°-lo de dentro do EC2 ou instal√°-lo automaticamente usando o AWS System Manager selecionando o pacote AWS-ConfigureAWSPackage
* **Configure** e **inicie** o Agente CloudWatch

Um grupo de logs tem muitos fluxos. Um fluxo tem muitos eventos. E dentro de cada fluxo, os eventos s√£o garantidos de estar em ordem.

## A√ß√µes

### Enumera√ß√£o
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Evitar Detec√ß√£o

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDuty popula seus achados em Eventos Cloudwatch com uma cad√™ncia de 5 minutos. Modificar o padr√£o de Evento ou Destinos para um evento **pode reduzir a capacidade do GuardDuty de alertar e acionar a auto-remedia√ß√£o de achados**, especialmente onde a remedia√ß√£o √© acionada em uma conta de membro, pois as prote√ß√µes do administrador do GuardDuty n√£o se estendem aos eventos Cloudwatch na conta de membro.

{% hint style="info" %}
Em uma arquitetura de administra√ß√£o delegada ou por convite do GuardDuty, eventos Cloudwatch ainda ser√£o criados na conta do administrador.
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## Refer√™ncias

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
