# AWS - CloudWatch Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks** で **あなたの会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または **HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## CloudWatch

**CloudWatch**は、ログ/メトリクス/イベントの形式でモニタリングおよび運用データを収集し、AWSリソース、アプリケーション、およびサービスの**統合ビュー**を提供します。\
CloudWatchログイベントは、各ログ行ごとに**256KBのサイズ制限**があります。\
高解像度のアラームを設定したり、ログとメトリクスを**並べて表示**したり、自動アクションを実行したり、問題をトラブルシューティングしたり、アプリケーションを最適化するための洞察を得ることができます。

例えば、CloudTrailからログを監視することができます。監視されるイベントは以下の通りです：

* セキュリティグループとNACLの変更
* EC2インスタンスの起動、停止、再起動、終了
* IAMとS3内のセキュリティポリシーの変更
* AWS Management Consoleへのログイン試行の失敗
* 認証に失敗したAPI呼び出し
* CloudWatchでの検索フィルタ：[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatchログ <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

AWSサービス（CloudTrailを含む）およびアプリケーション/システムからのログを**集約および監視**することができます（ホストにはCloudWatchエージェントをインストールできます）。ログは**無期限に保存**されることがあります（ロググループの設定による）。

**要素**：

| **ロググループ**         | 同じ保持、監視、アクセス制御設定を共有する**ログストリームのコレクション**                                                                 |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ログストリーム**       | **同じソース**を共有する**ログイベントのシーケンス**                                                                                                        |
| **サブスクリプションフィルタ** | 特定のロググループ内のイベントに一致する**フィルタパターン**を定義し、それらをKinesis Data Firehoseストリーム、Kinesisストリーム、またはLambda関数に送信します |

### CloudWatchモニタリング＆イベント

CloudWatchの**基本**は、データを**5分ごとに集約**します（**詳細**は**1分ごと**に集約します）。集約後、アラームの閾値をチェックし、トリガーする必要がある場合にはイベントを送信する準備ができます。\
その場合、CloudWatchはイベントを送信し、自動的なアクション（AWS Lambda関数、SNSトピック、SQSキュー、Kinesisストリーム）を実行することができます。

### エージェントのインストール

マシン/コンテナ内にエージェントをインストールして、ログを自動的にCloudWatchに送信することができます。

* **ロール**を**作成**し、**インスタンス**に**アタッチ**して、CloudWatchがインスタンスからデータを収集する権限を与えます。これにはAWSシステムマネージャSSMとのやり取りも含まれます（CloudWatchAgentAdminPolicy＆AmazonEC2RoleforSSM）。
* EC2インスタンスに**エージェント**を**ダウンロード**して**インストール**します（[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)）。EC2内部からダウンロードするか、AWSシステムマネージャを使用してパッケージAWS-ConfigureAWSPackageを自動的にインストールすることができます。
* CloudWatchエージェントを**設定**して**開始**します。

ロググループには多くのストリームがあります。ストリームには多くのイベントがあります。そして、各ストリームの中では、イベントの順序が保証されています。

## アクション

### 列挙
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## 検出を回避する

### `event:ListRules`、`event:ListTargetsByRule`、`event:PutRule`、`event:RemoveTargets`

GuardDutyは、5分ごとにCloudwatch Eventsに調査結果を表示します。イベントのパターンやターゲットを変更すると、**GuardDutyのアラート機能や調査結果の自動修復のトリガー機能が低下する可能性があります**。特に、修復がメンバーアカウントでトリガーされる場合、GuardDutyの管理者保護はメンバーアカウントのCloudwatchイベントには適用されません。

{% hint style="info" %}
委任または招待管理者GuardDutyアーキテクチャでは、Cloudwatchイベントは管理者アカウントに作成されます。
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## 参考文献

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンをダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
