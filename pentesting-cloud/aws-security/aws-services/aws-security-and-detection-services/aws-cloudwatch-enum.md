# AWS - Enumera√ß√£o do CloudWatch

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## CloudWatch

**CloudWatch** **coleta** monitoramento e dados operacionais na forma de logs/m√©tricas/eventos fornecendo uma **vis√£o unificada dos recursos da AWS**, aplicativos e servi√ßos.\
Os Eventos de Log do CloudWatch t√™m uma **limita√ß√£o de tamanho de 256KB em cada linha de log**.\
Ele pode definir **alarmes de alta resolu√ß√£o**, visualizar **logs** e **m√©tricas** lado a lado, tomar a√ß√µes automatizadas, solucionar problemas e descobrir insights para otimizar aplicativos.

Voc√™ pode monitorar, por exemplo, logs do CloudTrail. Eventos que s√£o monitorados:

* Altera√ß√µes em Grupos de Seguran√ßa e NACLs
* Iniciando, Parando, reiniciando e terminando inst√¢ncias EC2
* Altera√ß√µes em Pol√≠ticas de Seguran√ßa dentro do IAM e S3
* Tentativas de login malsucedidas no Console de Gerenciamento da AWS
* Chamadas de API que resultaram em autoriza√ß√£o falhada
* Filtros para pesquisar no cloudwatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### Logs do CloudWatch <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permite **agregar e monitorar logs de aplicativos** e sistemas de **servi√ßos da AWS** (incluindo CloudTrail) e **de aplicativos/sistemas** (o **Agente CloudWatch** pode ser instalado em um host). Os logs podem ser **armazenados indefinidamente** (dependendo das configura√ß√µes do Grupo de Logs) e podem ser exportados.

**Elementos**:

| **Grupo de Logs**       | Uma **cole√ß√£o de fluxos de log** que compartilham as mesmas configura√ß√µes de reten√ß√£o, monitoramento e controle de acesso                                       |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Fluxo de Logs**        | Uma sequ√™ncia de **eventos de log** que compartilham a **mesma origem**                                                                                      |
| **Filtros de Assinatura**| Definem um **padr√£o de filtro que corresponde a eventos** em um determinado grupo de logs, enviam-nos para um fluxo de Kinesis Data Firehose, fluxo de Kinesis ou uma fun√ß√£o Lambda |

### Monitoramento e Eventos do CloudWatch

O CloudWatch **b√°sico** agrega dados **a cada 5 minutos** (o **detalhado** faz isso **a cada 1 minuto**). Ap√≥s a agrega√ß√£o, ele **verifica os limites dos alarmes** no caso de precisar acionar um.\
Nesse caso, o CloudWatch pode estar preparado para enviar um evento e realizar algumas a√ß√µes autom√°ticas (fun√ß√µes AWS lambda, t√≥picos SNS, filas SQS, fluxos Kinesis)

### Instala√ß√£o do Agente

Voc√™ pode instalar agentes em suas m√°quinas/cont√™ineres para enviar automaticamente os logs de volta para o CloudWatch.

* **Crie** uma **fun√ß√£o** e **anexe** a ela a **inst√¢ncia** com permiss√µes que permitam ao CloudWatch coletar dados das inst√¢ncias, al√©m de interagir com o AWS Systems Manager SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Baixe** e **instale** o **agente** na inst√¢ncia EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Voc√™ pode baix√°-lo de dentro da EC2 ou instal√°-lo automaticamente usando o AWS System Manager selecionando o pacote AWS-ConfigureAWSPackage
* **Configure** e **inicie** o Agente CloudWatch

Um grupo de logs tem muitos fluxos. Um fluxo tem muitos eventos. E dentro de cada fluxo, os eventos s√£o garantidos a estar em ordem.

## A√ß√µes

### Enumera√ß√£o
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## Refer√™ncias

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
