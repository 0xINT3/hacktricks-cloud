# AWS - CloudWatch Enum

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## CloudWatch

**CloudWatch** **collecte** des donn√©es de surveillance et op√©rationnelles sous forme de logs/metrics/events offrant une **vue unifi√©e des ressources AWS**, applications et services.\
Les √©v√©nements de log CloudWatch ont une **limitation de taille de 256KB par ligne de log**.\
Il peut configurer des **alarmes haute r√©solution**, visualiser **les logs** et **les m√©triques** c√¥te √† c√¥te, prendre des actions automatis√©es, d√©panner des probl√®mes et d√©couvrir des insights pour optimiser les applications.

Vous pouvez surveiller par exemple les logs de CloudTrail. √âv√©nements surveill√©s :

* Changements dans les Security Groups et NACLs
* D√©marrage, arr√™t, red√©marrage et terminaison d'instances EC2
* Changements dans les politiques de s√©curit√© au sein de IAM et S3
* Tentatives de connexion √©chou√©es √† la console de gestion AWS
* Appels API ayant entra√Æn√© une autorisation √©chou√©e
* Filtres pour rechercher dans cloudwatch : [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch Logs <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permet d'**agr√©ger et surveiller les logs des applications** et syst√®mes des **services AWS** (y compris CloudTrail) et **des apps/syst√®mes** (**l'Agent CloudWatch** peut √™tre install√© sur un h√¥te). Les logs peuvent √™tre **stock√©s ind√©finiment** (selon les param√®tres du groupe de logs) et peuvent √™tre export√©s.

**√âl√©ments** :

| **Log Group**            | Une **collection de flux de logs** qui partagent les m√™mes param√®tres de r√©tention, de surveillance et de contr√¥le d'acc√®s                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Log Stream**           | Une s√©quence d'**√©v√©nements de log** qui partagent la **m√™me source**                                                                                                |
| **Subscription Filters** | D√©finissent un **mod√®le de filtre qui correspond aux √©v√©nements** dans un groupe de logs particulier, les envoient √† un flux Kinesis Data Firehose, un flux Kinesis ou une fonction Lambda |

### CloudWatch Monitoring & Events

CloudWatch **basic** agr√®ge les donn√©es **toutes les 5min** (la version **d√©taill√©e** le fait **toutes les 1 min**). Apr√®s l'agr√©gation, il **v√©rifie les seuils des alarmes** au cas o√π il aurait besoin d'en d√©clencher une.\
Dans ce cas, CloudWatch peut √™tre pr√©par√© √† envoyer un √©v√©nement et √† effectuer certaines actions automatiques (fonctions AWS lambda, sujets SNS, files d'attente SQS, flux Kinesis)

### Installation de l'Agent

Vous pouvez installer des agents √† l'int√©rieur de vos machines/conteneurs pour envoyer automatiquement les logs √† CloudWatch.

* **Cr√©ez** un **r√¥le** et **attachez**-le √† l'**instance** avec des permissions permettant √† CloudWatch de collecter des donn√©es des instances en plus d'interagir avec le gestionnaire de syst√®mes AWS SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **T√©l√©chargez** et **installez** l'**agent** sur l'instance EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Vous pouvez le t√©l√©charger depuis l'EC2 ou l'installer automatiquement en utilisant le gestionnaire de syst√®mes AWS en s√©lectionnant le package AWS-ConfigureAWSPackage
* **Configurez** et **d√©marrez** l'Agent CloudWatch

Un groupe de logs contient de nombreux flux. Un flux contient de nombreux √©v√©nements. Et √† l'int√©rieur de chaque flux, l'ordre des √©v√©nements est garanti.

## Actions

### √ânum√©ration
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## √âviter la D√©tection

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDuty envoie ses r√©sultats √† Cloudwatch Events toutes les 5 minutes. Modifier le mod√®le d'√©v√©nement ou les cibles pour un √©v√©nement **peut r√©duire la capacit√© de GuardDuty √† alerter et √† d√©clencher l'auto-r√©paration des r√©sultats**, en particulier lorsque la r√©paration est d√©clench√©e dans un compte membre car les protections de l'administrateur GuardDuty ne s'√©tendent pas aux √©v√©nements Cloudwatch dans le compte membre.

{% hint style="info" %}
Dans une architecture GuardDuty avec un administrateur d√©l√©gu√© ou invit√©, les √©v√©nements cloudwatch seront toujours cr√©√©s dans le compte administrateur.
{% endhint %}
```bash
# Disable GuardDuty Cloudwatch Event
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modify Event Pattern
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remove Event Targets
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```
## R√©f√©rences

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
