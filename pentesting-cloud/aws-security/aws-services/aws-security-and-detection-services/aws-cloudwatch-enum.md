# AWS - Enumera√ß√£o do CloudWatch

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## CloudWatch

O **CloudWatch** **coleta** dados de monitoramento e operacionais na forma de logs/m√©tricas/eventos, fornecendo uma **vis√£o unificada dos recursos**, aplicativos e servi√ßos da AWS.\
Os eventos de log do CloudWatch t√™m um **limite de tamanho de 256KB em cada linha de log**.\
Ele pode definir **alarmes de alta resolu√ß√£o**, visualizar **logs** e **m√©tricas** lado a lado, tomar a√ß√µes automatizadas, solucionar problemas e descobrir insights para otimizar aplicativos.

Voc√™ pode monitorar, por exemplo, logs do CloudTrail. Eventos que s√£o monitorados:

* Altera√ß√µes em grupos de seguran√ßa e NACLs
* Iniciando, parando, reiniciando e encerrando inst√¢ncias EC2
* Altera√ß√µes nas pol√≠ticas de seguran√ßa dentro do IAM e S3
* Tentativas de login falhadas no Console de gerenciamento da AWS
* Chamadas de API que resultaram em autoriza√ß√£o falhada
* Filtros para pesquisa no cloudwatch: [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch Logs <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permite **agregar e monitorar logs de aplicativos** e sistemas de **servi√ßos AWS** (incluindo CloudTrail) e **de aplicativos/sistemas** (o **Agente CloudWatch** pode ser instalado em um host). Os logs podem ser **armazenados indefinidamente** (dependendo das configura√ß√µes do Grupo de logs) e podem ser exportados.

**Elementos**:

| **Grupo de logs**            | Uma **cole√ß√£o de fluxos de log** que compartilham as mesmas configura√ß√µes de reten√ß√£o, monitoramento e controle de acesso                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Fluxo de log**           | Uma sequ√™ncia de **eventos de log** que compartilham a **mesma fonte**                                                                                                |
| **Filtros de assinatura** | Defina um **padr√£o de filtro que corresponda a eventos** em um determinado grupo de log, envie-os para o fluxo Kinesis Data Firehose, fluxo Kinesis ou uma fun√ß√£o Lambda |

### Monitoramento e Eventos do CloudWatch

O CloudWatch **b√°sico** agrega dados **a cada 5 minutos** (o **detalhado** faz isso **a cada 1 minuto**). Ap√≥s a agrega√ß√£o, ele **verifica os limites dos alarmes** no caso de precisar acionar um.\
Nesse caso, o CloudWatch pode estar preparado para enviar um evento e realizar algumas a√ß√µes autom√°ticas (fun√ß√µes lambda da AWS, t√≥picos SNS, filas SQS, fluxos Kinesis)

### Instala√ß√£o do Agente

Voc√™ pode instalar agentes dentro de suas m√°quinas/cont√™ineres para enviar automaticamente os logs de volta para o CloudWatch.

* **Crie** uma **fun√ß√£o** e **anexe** a ela a **inst√¢ncia** com permiss√µes que permitam ao CloudWatch coletar dados das inst√¢ncias, al√©m de interagir com o AWS Systems Manager SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **Baixe** e **instale** o **agente** na inst√¢ncia EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Voc√™ pode baix√°-lo de dentro do EC2 ou instal√°-lo automaticamente usando o AWS System Manager selecionando o pacote AWS-ConfigureAWSPackage
* **Configure** e **inicie** o Agente CloudWatch

Um grupo de logs tem muitos fluxos. Um fluxo tem muitos eventos. E dentro de cada fluxo, os eventos s√£o garantidos para estar em ordem.

## A√ß√µes

### Enumera√ß√£o

```bash
# Pain√©is
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarmes
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Detec√ß√µes de anomalias
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Enumera√ß√£o de eventos
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```

## Evitar Detec√ß√£o

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

O GuardDuty popula suas descobertas no Cloudwatch Events em um ritmo de 5 minutos. Modificar o padr√£o de evento ou os alvos para um evento **pode reduzir a capacidade do GuardDuty de alertar e acionar a auto-remedia√ß√£o das descobertas**, especialmente quando a remedia√ß√£o √© acionada em uma conta de membro, pois as prote√ß√µes do administrador do GuardDuty n√£o se estendem aos eventos do Cloudwatch na conta de membro.

{% hint style="info" %}
Em uma arquitetura de administra√ß√£o delegada ou convidada do GuardDuty, os eventos do cloudwatch ainda ser√£o criados na conta do administrador.
{% endhint %}

```bash
# Desativar o Evento do Cloudwatch do GuardDuty
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modificar o Padr√£o de Evento
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Remover Alvos de Evento
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```

## Refer√™ncias

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-pe