# AWS - CloudWatch Enum

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## CloudWatch

**CloudWatch** **collecte** des donn√©es de surveillance et op√©rationnelles sous forme de journaux/m√©triques/√©v√©nements fournissant une **vue unifi√©e des ressources**, applications et services AWS.\
Les √©v√©nements de journalisation de CloudWatch ont une **limite de taille de 256 Ko sur chaque ligne de journal**.\
Il peut d√©finir des **alarmes de haute r√©solution**, visualiser des **journaux** et des **m√©triques** c√¥te √† c√¥te, prendre des actions automatis√©es, r√©soudre les probl√®mes et d√©couvrir des informations pour optimiser les applications.

Vous pouvez surveiller par exemple les journaux de CloudTrail. √âv√©nements surveill√©s :

* Modifications des groupes de s√©curit√© et des ACL
* D√©marrage, arr√™t, red√©marrage et suppression des instances EC2
* Modifications des politiques de s√©curit√© dans IAM et S3
* Tentatives de connexion √©chou√©es √† la console de gestion AWS
* Appels API ayant entra√Æn√© une autorisation √©chou√©e
* Filtres de recherche dans CloudWatch : [https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch Logs <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

Permet d'**agr√©ger et de surveiller les journaux des applications** et des syst√®mes des **services AWS** (y compris CloudTrail) et des **applications/syst√®mes** (l'**agent CloudWatch** peut √™tre install√© sur un h√¥te). Les journaux peuvent √™tre **stock√©s ind√©finiment** (en fonction des param√®tres du groupe de journaux) et peuvent √™tre export√©s.

**√âl√©ments** :

| **Groupe de journaux** | Une **collection de flux de journaux** qui partagent les m√™mes param√®tres de r√©tention, de surveillance et de contr√¥le d'acc√®s |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Flux de journaux** | Une s√©quence d'**√©v√©nements de journal** qui partagent la **m√™me source** |
| **Filtres d'abonnement** | D√©finir un **motif de filtre qui correspond aux √©v√©nements** dans un groupe de journaux particulier, les envoyer √† un flux Kinesis Data Firehose, un flux Kinesis ou une fonction Lambda |

### CloudWatch Monitoring & Events

CloudWatch **basique** agr√®ge les donn√©es **toutes les 5 minutes** (le mode **d√©taill√©** le fait **toutes les 1 minute**). Apr√®s l'agr√©gation, il **v√©rifie les seuils des alarmes** au cas o√π il doit en d√©clencher une.\
Dans ce cas, CloudWatch peut √™tre pr√©par√© √† envoyer un √©v√©nement et √† effectuer des actions automatiques (fonctions lambda AWS, sujets SNS, files SQS, flux Kinesis)

### Installation de l'agent

Vous pouvez installer des agents √† l'int√©rieur de vos machines/conteneurs pour envoyer automatiquement les journaux √† CloudWatch.

* **Cr√©er** un **r√¥le** et **l'attacher** √† l'**instance** avec des autorisations permettant √† CloudWatch de collecter des donn√©es √† partir des instances en plus d'interagir avec AWS Systems Manager SSM (CloudWatchAgentAdminPolicy & AmazonEC2RoleforSSM)
* **T√©l√©charger** et **installer** l'**agent** sur l'instance EC2 ([https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)). Vous pouvez le t√©l√©charger depuis l'int√©rieur de l'EC2 ou l'installer automatiquement √† l'aide d'AWS System Manager en s√©lectionnant le package AWS-ConfigureAWSPackage
* **Configurer** et **d√©marrer** l'agent CloudWatch

Un groupe de journaux a de nombreux flux. Un flux a de nombreux √©v√©nements. Et √† l'int√©rieur de chaque flux, les √©v√©nements sont garantis d'√™tre dans l'ordre.

## Actions

### √ânum√©ration

```bash
# Tableaux de bord
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarmes
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# D√©tections d'anomalies
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Journaux
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# √ânum√©ration des √©v√©nements
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```

## √âviter la d√©tection

### `event:ListRules`, `event:ListTargetsByRule`, `event:PutRule`, `event:RemoveTargets`

GuardDuty alimente ses r√©sultats √† Cloudwatch Events sur une cadence de 5 minutes. La modification du mod√®le d'√©v√©nement ou des cibles pour un √©v√©nement **peut r√©duire la capacit√© de GuardDuty √† alerter et √† d√©clencher une auto-r√©paration des r√©sultats**, en particulier lorsque la r√©paration est d√©clench√©e dans un compte membre car les protections administratives de l'administrateur GuardDuty ne s'√©tendent pas aux √©v√©nements Cloudwatch dans le compte membre.

{% hint style="info" %}
Dans une architecture d'administration d√©l√©gu√©e ou invit√©e GuardDuty, les √©v√©nements Cloudwatch seront toujours cr√©√©s dans le compte administrateur.
{% endhint %}

```bash
# D√©sactiver l'√©v√©nement Cloudwatch GuardDuty
aws events put-rule --name guardduty-event \
--event-pattern "{\"source\":[\"aws.guardduty\"]}" \
--state DISABLED

# Modifier le mod√®le d'√©v√©nement
aws events put-rule --name guardduty-event \
--event-pattern '{"source": ["aws.somethingthatdoesntexist"]}'

# Supprimer les cibles d'√©v√©nement
aws events remove-targets --name guardduty-event \
--ids "GuardDutyTarget"
```

## R√©f√©rences

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag