# AWS - CloudWatch Enum

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **Discordグループ**に**参加**する💬（https://discord.gg/hRep4RUj7f）または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**🐦で**フォロー**する[**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
- **HackTricks**（https://github.com/carlospolop/hacktricks）および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>

## CloudWatch

**CloudWatch**は、ログ/メトリクス/イベントの形式で監視および運用データを収集し、AWSリソース、アプリケーション、およびサービスの**統合ビュー**を提供します。\
CloudWatchログイベントは、各ログ行に**256KBのサイズ制限**があります。\
**高解像度のアラーム**を設定したり、**ログ**と**メトリクス**を並べて表示したり、自動アクションを実行したり、問題をトラブルシューティングしたり、アプリケーションを最適化するための洞察を見つけたりできます。

たとえば、CloudTrailからのログを監視できます。監視されるイベント：

- セキュリティグループやNACLの変更
- EC2インスタンスの起動、停止、再起動、終了
- IAMおよびS3内のセキュリティポリシーの変更
- AWS Management Consoleへのログイン失敗試行
- 認証に失敗したAPI呼び出し
- CloudWatchで検索するためのフィルタ：[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatchログ <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

**AWSサービス**（CloudTrailを含む）および**アプリケーション/システム**からのログを**集約および監視**できます（**CloudWatchエージェント**をホストにインストールできます）。ログは**無期限に保存**できます（ロググループの設定による）。

**要素**：

| **ロググループ** | 同じ保持、監視、およびアクセス制御設定を共有する**ログストリームのコレクション** |
| ---------------- | --------------------------------------------------------------- |
| **ログストリーム** | **同じソース**を共有する**ログイベントのシーケンス** |
| **サブスクリプションフィルタ** | 特定のロググループ内のイベントに一致する**フィルタパターン**を定義し、それらをKinesis Data Firehoseストリーム、Kinesisストリーム、またはLambda関数に送信します |

### CloudWatchモニタリング＆イベント

CloudWatch **basic**はデータを**5分ごと**に集約します（**detailed**は**1分ごと**に行います）。集約後、アラームの閾値を**チェック**して、トリガーする必要があるかどうかを確認します。\
その場合、CloudWatchはイベントを送信し、自動アクション（AWS Lambda関数、SNSトピック、SQSキュー、Kinesisストリーム）を実行する準備ができています。

### エージェントのインストール

マシン/コンテナ内にエージェントをインストールして、ログを自動的にCloudWatchに送信できます。

- **ロール**を**作成**し、CloudWatchがインスタンスからデータを収集する権限とAWSシステムマネージャSSMとのやり取りを許可する権限を持つ**インスタンス**に**アタッチ**します（CloudWatchAgentAdminPolicy＆AmazonEC2RoleforSSM）
- EC2インスタンスに**エージェント**を**ダウンロード**して**インストール**します（[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)）。EC2内からダウンロードするか、AWS System Managerを使用してパッケージAWS-ConfigureAWSPackageを選択して自動的にインストールできます
- CloudWatchエージェントを**構成**して**開始**します

ロググループには多くのストリームがあります。ストリームには多くのイベントがあります。そして、各ストリームの中で、イベントは順番に保証されています。

## アクション

### 列挙
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## 参考文献

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする。
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
