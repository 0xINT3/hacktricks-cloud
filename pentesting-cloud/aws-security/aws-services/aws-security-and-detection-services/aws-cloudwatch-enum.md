# AWS - CloudWatch Enum

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## CloudWatch

**CloudWatch** **收集**监控和运营**数据**，以日志/指标/事件的形式提供对AWS资源、应用程序和服务的**统一视图**。\
CloudWatch日志事件每行有**256KB的大小限制**。\
它可以设置**高分辨率警报**，将**日志**和**指标**并排可视化，执行自动操作，解决问题，并发现优化应用程序的见解。

例如，您可以监视来自CloudTrail的日志。监视的事件包括：

* 安全组和NACL的更改
* 启动、停止、重启和终止EC2实例
* IAM和S3中安全策略的更改
* AWS管理控制台登录尝试失败
* 导致授权失败的API调用
* 在CloudWatch中搜索的过滤器：[https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html)

### CloudWatch日志 <a href="#cloudwatch-logs" id="cloudwatch-logs"></a>

允许**聚合和监视**来自**AWS服务**（包括CloudTrail）和**应用程序/系统**的日志。日志可以**无限期存储**（取决于日志组设置）并且可以导出。

**元素**：

| **日志组**            | 具有相同保留、监控和访问控制设置的**日志流集合**                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **日志流**           | 具有**相同来源**的**日志事件**序列                                                                                                |
| **订阅过滤器** | 定义与特定日志组中事件匹配的**过滤模式**，将其发送到Kinesis Data Firehose流、Kinesis流或Lambda函数 |

### CloudWatch监控和事件

CloudWatch **基本**每5分钟聚合一次数据（**详细**聚合每1分钟一次）。在聚合后，它会**检查警报的阈值**，以确定是否需要触发警报。\
在这种情况下，CloudWatch可以准备发送事件并执行一些自动操作（AWS Lambda函数、SNS主题、SQS队列、Kinesis流）

### 代理安装

您可以在您的机器/容器内安装代理，自动将日志发送回CloudWatch。

* **创建**一个**角色**并将其附加到具有允许CloudWatch从实例收集数据的权限的**实例**上，除了与AWS系统管理器SSM交互的权限（CloudWatchAgentAdminPolicy和AmazonEC2RoleforSSM）
* **下载**并**安装**代理到EC2实例上（[https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip](https://s3.amazonaws.com/amazoncloudwatch-agent/linux/amd64/latest/AmazonCloudWatchAgent.zip)）。您可以从EC2内部下载它或使用AWS System Manager自动安装，选择包AWS-ConfigureAWSPackage
* **配置**并**启动**CloudWatch代理

一个日志组有许多流。一个流有许多事件。在每个流的内部，事件保证按顺序排列。 

## 操作

### 枚举
```bash
# Dashboards
aws cloudwatch list-dashboards
aws cloudwatch get-dashboard --dashboard-name <dashboard_name>

# Alarms
aws cloudwatch describe-alarms
aws cloudwatch describe-alarm-history
aws cloudwatch describe-alarms-for-metric --metric-name <metric_name> --namespace <namespace>
aws cloudwatch describe-alarms-for-metric --metric-name IncomingLogEvents --namespace AWS/Logs

# Anomaly Detections
aws cloudwatch describe-anomaly-detectors
aws cloudwatch describe-insight-rules

# Logs
aws logs tail "<log_group_name>" --follow
aws logs get-log-events --log-group-name "<log_group_name>" --log-stream-name "<log_stream_name>" --output text > <output_file>

# Events enumeration
aws events list-rules
aws events describe-rule --name <name>
aws events list-targets-by-rule --rule <name>
aws events list-archives
aws events describe-archive --archive-name <name>
aws events list-connections
aws events describe-connection --name <name>
aws events list-endpoints
aws events describe-endpoint --name <name>
aws events list-event-sources
aws events describe-event-source --name <name>
aws events list-replays
aws events list-api-destinations
aws events list-event-buses
```
## 参考

* [https://cloudsecdocs.com/aws/services/logging/cloudwatch/](https://cloudsecdocs.com/aws/services/logging/cloudwatch/#general-info)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我们的**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。 

</details>
