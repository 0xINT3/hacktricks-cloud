# AWS - CloudTrail Enum

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFT exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## **CloudTrail**

Ce service **suit et surveille les appels d'API AWS effectu√©s dans l'environnement**. Chaque appel √† une API (√©v√©nement) est enregistr√©. Chaque √©v√©nement enregistr√© contient :

* Le nom de l'API appel√©e : `eventName`
* Le service appel√© : `eventSource`
* L'heure : `eventTime`
* L'adresse IP : `SourceIPAddress`
* La m√©thode de l'agent : `userAgent`. Exemples :
  * Signing.amazonaws.com - Depuis la console de gestion AWS
  * console.amazonaws.com - Utilisateur root du compte
  * lambda.amazonaws.com - AWS Lambda
* Les param√®tres de la demande : `requestParameters`
* Les √©l√©ments de r√©ponse : `responseElements`

Les √©v√©nements sont √©crits dans un nouveau fichier journal **environ toutes les 5 minutes dans un fichier JSON**, ils sont conserv√©s par CloudTrail et enfin, les fichiers journaux sont **livr√©s √† S3 environ 15 minutes apr√®s**.\
Les journaux CloudTrails peuvent √™tre **agr√©g√©s entre les comptes et entre les r√©gions**.\
CloudTrail permet d'utiliser **l'int√©grit√© des fichiers journaux afin de pouvoir v√©rifier que vos fichiers journaux sont rest√©s inchang√©s** depuis que CloudTrail vous les a livr√©s. Il cr√©e un hachage SHA-256 des journaux √† l'int√©rieur d'un fichier de synth√®se. Un hachage sha-256 des nouveaux journaux est cr√©√© toutes les heures.\
Lors de la cr√©ation d'une Trail, les s√©lecteurs d'√©v√©nements vous permettront d'indiquer la Trail √† enregistrer : √©v√©nements de gestion, de donn√©es ou d'insights.

Les journaux sont enregistr√©s dans un compartiment S3. Par d√©faut, le chiffrement c√¥t√© serveur est utilis√© (SSE-S3) de sorte qu'AWS d√©cryptera le contenu pour les personnes qui y ont acc√®s, mais pour une s√©curit√© suppl√©mentaire, vous pouvez utiliser SSE avec KMS et vos propres cl√©s.

### Convention de nommage des fichiers journaux

![](<../../../../.gitbook/assets/image (29).png>)

### Structure des dossiers S3

![](<../../../../.gitbook/assets/image (47).png>)

Notez que les dossiers "_AWSLogs_" et "_CloudTrail_" sont des noms de dossiers fixes,

Les fichiers **Digest** ont un chemin de dossier similaire :

![](<../../../../.gitbook/assets/image (22).png>)

### Agr√©ger les journaux de plusieurs comptes

* Cr√©er un essai dans le compte AWS o√π vous souhaitez que les fichiers journaux soient livr√©s
* Appliquer des autorisations au compartiment S3 de destination permettant l'acc√®s intercompte pour CloudTrail et autoriser chaque compte AWS qui a besoin d'un acc√®s
* Cr√©er une nouvelle Trail dans les autres comptes AWS et s√©lectionner d'utiliser le compartiment cr√©√© √† l'√©tape 1

Cependant, m√™me si vous pouvez enregistrer tous les journaux dans le m√™me compartiment S3, vous ne pouvez pas agr√©ger les journaux CloudTrail de plusieurs comptes dans un CloudWatch Logs appartenant √† un seul compte AWS.

### Cloudtrail de tous les comptes d'organisation en un seul

Lors de la cr√©ation d'un CloudTrail, il est possible d'indiquer d'activer cloudtrail pour tous les comptes de l'organisation et d'obtenir les journaux dans un seul compartiment :

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De cette fa√ßon, vous pouvez facilement configurer CloudTrail dans toutes les r√©gions de tous les comptes et centraliser les journaux dans 1 compte (que vous devriez prot√©ger).

### V√©rification des fichiers journaux

Vous pouvez v√©rifier que les journaux n'ont pas √©t√© modifi√©s en ex√©cutant

```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```

### Journaux vers CloudWatch

**CloudTrail peut envoyer automatiquement des journaux vers CloudWatch afin que vous puissiez d√©finir des alertes qui vous avertissent lorsque des activit√©s suspectes sont effectu√©es.**\
Notez que pour permettre √† CloudTrail d'envoyer les journaux vers CloudWatch, un **r√¥le** doit √™tre cr√©√© qui permet cette action. Si possible, il est recommand√© d'utiliser le r√¥le par d√©faut AWS pour effectuer ces actions. Ce r√¥le permettra √† CloudTrail de :

* CreateLogStream : cela permet de cr√©er des flux de journaux CloudWatch Logs
* PutLogEvents : livrer les journaux CloudTrail au flux de journaux CloudWatch Logs

### Historique des √©v√©nements

L'historique des √©v√©nements CloudTrail permet d'inspecter dans un tableau les journaux qui ont √©t√© enregistr√©s :

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** analyse automatiquement les √©v√©nements de gestion d'√©criture des trails CloudTrail et vous alerte sur une activit√© inhabituelle. Par exemple, s'il y a une augmentation des √©v√©nements `TerminateInstance` qui diff√®re des baselines √©tablies, vous le verrez comme un √©v√©nement Insight. Ces √©v√©nements rendent **plus facile que jamais la recherche et la r√©ponse √† une activit√© API inhabituelle**.

### S√©curit√©

| Int√©grit√© des fichiers journaux CloudTrail | <ul><li>Valider si les journaux ont √©t√© alt√©r√©s (modifi√©s ou supprim√©s)</li><li><p>Utilise des fichiers de synth√®se (cr√©e un hachage pour chaque fichier)</p><ul><li>Hachage SHA-256</li><li>SHA-256 avec RSA pour la signature num√©rique</li><li>cl√© priv√©e appartenant √† Amazon</li></ul></li><li>Prend 1 heure pour cr√©er un fichier de synth
### Suppression de pistes

```
aws cloudtrail delete-trail --name [nom-de-la-piste]
```

### Arr√™t des pistes

```
aws cloudtrail stop-logging --name [nom-de-la-piste]
```

### D√©sactiver la journalisation multi-r√©gion

```
aws cloudtrail update-trail --name [nom-de-la-piste] --no-is-multi-region --no-include-global-services
```

### Modification du bucket

* Supprimer le bucket S3
* Modifier la politique du bucket pour refuser toute √©criture provenant du service CloudTrail
* Ajouter une politique de cycle de vie au bucket S3 pour supprimer les objets
* D√©sactiver la cl√© KMS utilis√©e pour chiffrer les journaux CloudTrail

### "Ran√ßongiciel" CloudTrail

Vous pouvez **g√©n√©rer une cl√© asym√©trique** et faire **chiffrer les donn√©es par CloudTrail** avec cette cl√©, puis **supprimer la cl√© priv√©e** pour que le contenu de CloudTrail ne puisse pas √™tre r√©cup√©r√©.

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **R√©f√©rences**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>