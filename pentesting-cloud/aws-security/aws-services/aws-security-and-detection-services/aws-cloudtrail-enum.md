# AWS - Enumera√ß√£o do CloudTrail

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## **CloudTrail**

Este servi√ßo **rastreia e monitora as chamadas de API da AWS feitas dentro do ambiente**. Cada chamada para uma API (evento) √© registrada. Cada evento registrado cont√©m:

* O nome da API chamada: `eventName`
* O servi√ßo chamado: `eventSource`
* O tempo: `eventTime`
* O endere√ßo IP: `SourceIPAddress`
* O m√©todo do agente: `userAgent`. Exemplos:
  * Signing.amazonaws.com - Do console de gerenciamento da AWS
  * console.amazonaws.com - Usu√°rio raiz da conta
  * lambda.amazonaws.com - AWS Lambda
* Os par√¢metros da solicita√ß√£o: `requestParameters`
* Os elementos de resposta: `responseElements`

Os eventos s√£o escritos em um novo arquivo de log **aproximadamente a cada 5 minutos em um arquivo JSON**, eles s√£o mantidos pelo CloudTrail e, finalmente, os arquivos de log s√£o **entregues ao S3 aproximadamente 15 minutos depois**.\
Os logs do CloudTrails podem ser **agregados em v√°rias contas e regi√µes**.\
O CloudTrail permite usar a **integridade do arquivo de log para poder verificar se seus arquivos de log permaneceram inalterados** desde que o CloudTrail os entregou a voc√™. Ele cria um hash SHA-256 dos logs dentro de um arquivo de digest√£o. Um hash sha-256 dos novos logs √© criado a cada hora.\
Ao criar um Trail, os seletores de eventos permitir√£o que voc√™ indique o trail para registrar: eventos de gerenciamento, dados ou insights.

Os logs s√£o salvos em um bucket S3. Por padr√£o, a criptografia do lado do servidor √© usada (SSE-S3), portanto, a AWS descriptografar√° o conte√∫do para as pessoas que t√™m acesso a ele, mas, para seguran√ßa adicional, voc√™ pode usar SSE com KMS e suas pr√≥prias chaves.

### Conven√ß√£o de nomenclatura de arquivos de log

![](<../../../../.gitbook/assets/image (29).png>)

### Estrutura de pastas do S3

![](<../../../../.gitbook/assets/image (47).png>)

Observe que as pastas "_AWSLogs_" e "_CloudTrail_" s√£o nomes de pastas fixos,

Os arquivos de **digest√£o** t√™m um caminho de pastas semelhante:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregar logs de v√°rias contas

* Crie um Trial na conta da AWS onde deseja que os arquivos de log sejam entregues
* Aplique permiss√µes ao bucket S3 de destino permitindo acesso entre contas para o CloudTrail e permita que cada conta da AWS que precisa de acesso
* Crie um novo Trail nas outras contas da AWS e selecione usar o bucket criado na etapa 1

No entanto, mesmo que voc√™ possa salvar todos os logs no mesmo bucket S3, voc√™ n√£o pode agregar logs do CloudTrail de v√°rias contas em um CloudWatch Logs pertencente a uma √∫nica conta da AWS.

### Cloudtrail de todas as contas da organiza√ß√£o em 1

Ao criar um CloudTrail, √© poss√≠vel indicar para ativar o cloudtrail para todas as contas na organiza√ß√£o e obter os logs em apenas 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

Dessa forma, voc√™ pode configurar facilmente o CloudTrail em todas as regi√µes de todas as contas e centralizar os logs em 1 conta (que voc√™ deve proteger).

### Verifica√ß√£o de arquivos de log

Voc√™ pode verificar se os logs n√£o foram alterados executando

```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```

### Logs para CloudWatch

**O CloudTrail pode enviar automaticamente logs para o CloudWatch para que voc√™ possa definir alertas que o avisem quando atividades suspeitas forem executadas.**\
Observe que, para permitir que o CloudTrail envie os logs para o CloudWatch, √© necess√°rio criar uma **fun√ß√£o** que permita essa a√ß√£o. Se poss√≠vel, √© recomend√°vel usar a fun√ß√£o padr√£o da AWS para executar essas a√ß√µes. Essa fun√ß√£o permitir√° que o CloudTrail:

* CreateLogStream: Isso permite criar fluxos de log do CloudWatch Logs
* PutLogEvents: Entregar logs do CloudTrail para o fluxo de log do CloudWatch Logs

### Hist√≥rico de eventos

O Hist√≥rico de eventos do CloudTrail permite inspecionar em uma tabela os logs que foram registrados:

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**O CloudTrail Insights** analisa automaticamente **eventos de gerenciamento de grava√ß√£o** de trilhas do CloudTrail e **alerta** voc√™ sobre **atividades incomuns**. Por exemplo, se houver um aumento nos eventos `TerminateInstance` que difere das linhas de base estabelecidas, voc√™ ver√° isso como um evento Insight. Esses eventos tornam **mais f√°cil do que nunca encontrar e responder a atividades de API incomuns**.

### Seguran√ßa

| Integridade do arquivo de log do CloudTrail | <ul><li>Validar se os logs foram adulterados (modificados ou exclu√≠dos)</li><li><p>Usa arquivos de digest√£o (cria hash para cada arquivo)</p><ul><li>Hashing SHA-256</li><li>SHA-256 com RSA para assinatura digital</li><li>chave privada de propriedade da Amazon</li></ul></li><li>Leva 1 hora para criar um arquivo de digest√£o (feito na hora a cada hora)</li></ul> |
| ------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Impedir acesso n√£o autorizado               | <ul><li><p
### Excluir trilhas

```
aws cloudtrail delete-trail --name [nome-da-trilha]
```

### Parar trilhas

```
aws cloudtrail stop-logging --name [nome-da-trilha]
```

### Desativar o registro em v√°rias regi√µes

```
aws cloudtrail update-trail --name [nome-da-trilha] --no-is-multi-region --no-include-global-services
```

### Modifica√ß√£o do bucket

* Excluir o bucket S3
* Alterar a pol√≠tica do bucket para negar qualquer grava√ß√£o do servi√ßo CloudTrail
* Adicionar pol√≠tica de ciclo de vida ao bucket S3 para excluir objetos
* Desativar a chave KMS usada para criptografar os logs do CloudTrail

### "Ransomware" do CloudTrail

Voc√™ pode **gerar uma chave assim√©trica** e fazer com que o **CloudTrail criptografe os dados** com essa chave e **excluir a chave privada** para que o conte√∫do do CloudTrail n√£o possa ser recuperado.

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **Refer√™ncias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>