# AWS - Enumeraci√≥n de CloudTrail

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°echa un vistazo a los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **CloudTrail**

Este servicio **rastrea y monitorea las llamadas a las API de AWS realizadas dentro del entorno**. Cada llamada a una API (evento) se registra. Cada evento registrado contiene:

* El nombre de la API llamada: `eventName`
* El servicio llamado: `eventSource`
* La hora: `eventTime`
* La direcci√≥n IP: `SourceIPAddress`
* El m√©todo del agente: `userAgent`. Ejemplos:
  * Signing.amazonaws.com - Desde la consola de administraci√≥n de AWS
  * console.amazonaws.com - Usuario ra√≠z de la cuenta
  * lambda.amazonaws.com - AWS Lambda
* Los par√°metros de la solicitud: `requestParameters`
* Los elementos de respuesta: `responseElements`

Los eventos se escriben en un nuevo archivo de registro **aproximadamente cada 5 minutos en un archivo JSON**, son retenidos por CloudTrail y finalmente, los archivos de registro se **entregan a S3 aproximadamente 15 minutos despu√©s**.\
Los registros de CloudTrails se pueden **agregar en varias cuentas y regiones.**\
CloudTrail permite usar **la integridad del archivo de registro para poder verificar que sus archivos de registro no han cambiado** desde que CloudTrail los entreg√≥. Crea un hash SHA-256 de los registros dentro de un archivo de resumen. Se crea un hash sha-256 de los nuevos registros cada hora.\
Al crear un Trail, los selectores de eventos le permitir√°n indicar el Trail para registrar: eventos de gesti√≥n, datos o de an√°lisis.

Los registros se guardan en un bucket S3. Por defecto se utiliza el cifrado del lado del servidor (SSE-S3) por lo que AWS descifrar√° el contenido para las personas que tengan acceso a √©l, pero para una seguridad adicional, puede utilizar SSE con KMS y sus propias claves.

### Convenci√≥n de nomenclatura de archivos de registro

![](<../../../../.gitbook/assets/image (29).png>)

### Estructura de carpetas de S3

![](<../../../../.gitbook/assets/image (47).png>)

Tenga en cuenta que las carpetas "_AWSLogs_" y "_CloudTrail_" son nombres de carpetas fijos,

Los archivos de resumen tienen una ruta de carpetas similar:

![](<../../../../.gitbook/assets/image (22).png>)

### Agregar registros de varias cuentas

* Cree un Trial en la cuenta de AWS donde desea que se entreguen los archivos de registro
* Aplique permisos al bucket S3 de destino que permitan el acceso entre cuentas para CloudTrail y permita el acceso a cada cuenta de AWS que necesite acceso
* Cree un nuevo Trail en las otras cuentas de AWS y seleccione usar el bucket creado en el paso 1

Sin embargo, aunque puede guardar todos los registros en el mismo bucket S3, no puede agregar registros de CloudTrail de varias cuentas en un CloudWatch Logs que pertenezca a una sola cuenta de AWS.

### Cloudtrail de todas las cuentas de la organizaci√≥n en 1

Al crear un CloudTrail, es posible indicar que se active cloudtrail para todas las cuentas de la organizaci√≥n y obtener los registros en solo 1 bucket:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (5).png" alt=""><figcaption></figcaption></figure>

De esta manera, puede configurar f√°cilmente CloudTrail en todas las regiones de todas las cuentas y centralizar los registros en 1 cuenta (que debe proteger).

### Verificaci√≥n de archivos de registro

Puede comprobar que los registros no han sido alterados ejecutando

```javascript
aws cloudtrail validate-logs --trail-arn <trailARN> --start-time <start-time> [--end-time <end-time>] [--s3-bucket <bucket-name>] [--s3-prefix <prefix>] [--verbose]
```

### Registros en CloudWatch

**CloudTrail puede enviar autom√°ticamente registros a CloudWatch para que pueda configurar alertas que le adviertan cuando se realizan actividades sospechosas.**\
Tenga en cuenta que para permitir que CloudTrail env√≠e los registros a CloudWatch, se debe crear un **rol** que permita esa acci√≥n. Si es posible, se recomienda utilizar el rol predeterminado de AWS para realizar estas acciones. Este rol permitir√° que CloudTrail:

* CreateLogStream: Esto permite crear flujos de registro de CloudWatch Logs
* PutLogEvents: Entregar registros de CloudTrail a flujos de registro de CloudWatch Logs

### Historial de eventos

El historial de eventos de CloudTrail le permite inspeccionar en una tabla los registros que se han registrado:

![](<../../../../.gitbook/assets/image (24).png>)

### An√°lisis

**CloudTrail Insights** analiza autom√°ticamente los eventos de gesti√≥n de escritura de los trails de CloudTrail y le alerta sobre la actividad inusual. Por ejemplo, si hay un aumento en los eventos `TerminateInstance` que difiere de las l√≠neas de base establecidas, lo ver√° como un evento de Insight. Estos eventos hacen que **encontrar y responder a la actividad de API inusual sea m√°s f√°cil que nunca**.

### Seguridad

| Integridad del archivo de registro de CloudTrail | <ul><li>Validar si los registros han sido manipulados (modificados o eliminados)</li><li><p>Usa archivos de resumen (crea hash para cada archivo)</p><ul><li>Hashing SHA-256</li><li>SHA-256 con RSA para la firma digital</li><li>clave privada propiedad de Amazon</li></ul></li><li>Tarda 1 hora en crear un archivo de resumen (se realiza en punto cada hora)</li></ul> |
| ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Detener el acceso no autorizado                  | <ul><li><p>Usar pol√≠ticas IAM y pol√≠ticas de bucket S3</p><ul><li>equipo de seguridad ‚Äî> acceso de administrador</li><li>auditores ‚Äî> acceso de solo lectura</li></ul></li><li>Usar SSE-S3/SSE-KMS para cifrar los registros</li></ul>                                                                                                                                                                                                                                            |
| Evitar que se eliminen los archivos de registro   | <ul><li>Restringir el
### Eliminar senderos

```
aws cloudtrail delete-trail --name [nombre-del-sendero]
```

### Detener senderos

```
aws cloudtrail stop-logging --name [nombre-del-sendero]
```

### Deshabilitar el registro en varias regiones

```
aws cloudtrail update-trail --name [nombre-del-sendero] --no-is-multi-region --no-include-global-services
```

### Modificaci√≥n del cubo

* Eliminar el cubo S3
* Cambiar la pol√≠tica del cubo para denegar cualquier escritura desde el servicio CloudTrail
* Agregar una pol√≠tica de ciclo de vida al cubo S3 para eliminar objetos
* Deshabilitar la clave KMS utilizada para cifrar los registros de CloudTrail

### "Ransomware" de CloudTrail

Podr√≠a **generar una clave asim√©trica** y hacer que **CloudTrail cifre los datos** con esa clave y **eliminar la clave privada** para que el contenido de CloudTrail no pueda ser recuperado.

![](https://lh6.googleusercontent.com/DRckYJKCAVyDeUY6cganqHTcfvlRMrOcnInUx25f9s9rstNvvkXbu-OS2ZozMvh0Oqxdc9Ehrsc8QJTVGZkbDih\_zsjU2KRvHVGahLqbfAhnD0VLdk096xPNJuAebOJYtDZ71SlnJt6rQj0\_3Q)

![](https://lh3.googleusercontent.com/GfGI0jCdTe2S2HNVMKdNaltBfv9ls6lZqSQt1FkR8mgcxKNdvVmAE2vl77Sr23KWJ6X7-X4UJVgkN5KsQxYEdqOTIWwjr6DHCK9s\_iw5whQkN\_TVPOycc2qHZUSU9NED\_k2lEYK4SpavbTxZ6w)

![](https://lh5.googleusercontent.com/Y9iLLB5RtmBoBVrLE9GKkGK6mxGWtAL6oSwVxgwqYxYHkXpimUZJmAT\_AkxQW-hpdz2kaHpaqXXHwvzz3osg-JA5i1c8\_bWoz5HlTj0mup0MAvG6B5IAnnsnvIDtpqflW4UzIOKZYDxxdxUSDQ)

## **Referencias**

* [https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory](https://cloudsecdocs.com/aws/services/logging/cloudtrail/#inventory)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>