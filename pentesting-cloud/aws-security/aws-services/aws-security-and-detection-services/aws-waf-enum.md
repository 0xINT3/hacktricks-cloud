# AWS - WAF Enum

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## WAF

AWS WAF est un **pare-feu d'application Web** qui aide √† **prot√©ger vos applications Web** ou APIs contre les exploits Web courants qui peuvent affecter la disponibilit√©, compromettre la s√©curit√© ou consommer des ressources excessives. AWS WAF vous donne le contr√¥le sur **la mani√®re dont le trafic atteint vos applications** en vous permettant de cr√©er **des r√®gles de s√©curit√© qui bloquent les mod√®les d'attaque courants**, tels que l'injection SQL ou le cross-site scripting, et des r√®gles qui filtrent des motifs de trafic sp√©cifiques que vous d√©finissez.

### Conditions

Les conditions vous permettent de sp√©cifier **quels √©l√©ments de la requ√™te HTTP ou HTTPS entrante vous souhaitez que WAF surveille** (XSS, GEO - filtrage par emplacement -, adresse IP, contraintes de taille, attaques d'injection SQL, correspondance de cha√Ænes et d'expressions r√©guli√®res). Notez que si vous restreignez un pays depuis cloudfront, cette requ√™te n'arrivera pas au waf.

Vous pouvez avoir **100 conditions de chaque type**, telles que la correspondance g√©ographique ou les contraintes de taille, cependant **Regex** est l'**exception** √† cette r√®gle o√π **seulement 10 conditions Regex** sont autoris√©es mais cette limite peut √™tre augment√©e. Vous pouvez avoir **100 r√®gles et 50 Web ACL par compte AWS**. Vous √™tes limit√© √† **5 r√®gles bas√©es sur le taux** par compte. Enfin, vous pouvez avoir **10 000 requ√™tes par seconde** lors de **l'utilisation de WAF** avec votre √©quilibreur de charge d'application.

### R√®gles

En utilisant ces conditions, vous pouvez cr√©er des r√®gles : Par exemple, bloquer la requ√™te si 2 conditions sont remplies.\
Lors de la cr√©ation de votre r√®gle, on vous demandera de s√©lectionner un **Type de R√®gle** : **R√®gle R√©guli√®re** ou **R√®gle Bas√©e sur le Taux**.

La seule **diff√©rence** entre une r√®gle bas√©e sur le taux et une r√®gle r√©guli√®re est que les r√®gles bas√©es sur le taux **comptent** le **nombre** de **requ√™tes** re√ßues d'une adresse IP particuli√®re sur une p√©riode de **cinq minutes**.

Lorsque vous s√©lectionnez une option de r√®gle bas√©e sur le taux, on vous demande d'**entrer le nombre maximum de requ√™tes d'une seule IP dans un intervalle de cinq minutes**. Lorsque la limite de comptage est **atteinte**, **toutes les autres requ√™tes de cette m√™me adresse IP sont alors bloqu√©es**. Si le taux de requ√™te retombe en dessous de la limite de taux sp√©cifi√©e, le trafic est alors autoris√© √† passer et n'est plus bloqu√©. Lors de la d√©finition de votre limite de taux, elle **doit √™tre fix√©e √† une valeur sup√©rieure √† 2000**. Toute requ√™te en dessous de cette limite est consid√©r√©e comme une R√®gle R√©guli√®re.

### Actions

Une action est appliqu√©e √† chaque r√®gle, ces actions peuvent √™tre **Autoriser**, **Bloquer** ou **Compter**.

* Lorsqu'une requ√™te est **autoris√©e**, elle est **transmise** √† la distribution CloudFront ou √† l'√©quilibreur de charge d'application pertinent.
* Lorsqu'une requ√™te est **bloqu√©e**, la requ√™te est **termin√©e** l√† et aucun traitement suppl√©mentaire de cette requ√™te n'est effectu√©.
* Une action **Compter** va **compter le nombre de requ√™tes qui r√©pondent aux conditions** de cette r√®gle. C'est une tr√®s bonne option √† s√©lectionner lors du test des r√®gles pour s'assurer que la r√®gle capte bien les requ√™tes comme pr√©vu avant de la r√©gler sur Autoriser ou Bloquer.

Si une **requ√™te entrante ne r√©pond √† aucune r√®gle** dans le Web ACL, alors la requ√™te prend l'action associ√©e √† une **action par d√©faut** sp√©cifi√©e qui peut √™tre **Autoriser** ou **Bloquer**. Un point important √† noter √† propos de ces r√®gles est qu'elles sont **ex√©cut√©es dans l'ordre o√π elles sont list√©es dans un Web ACL**. Soyez donc prudent pour architecturer cet ordre correctement pour votre base de r√®gles, **typiquement** elles sont **ordonn√©es** comme montr√© :

1. IPs de la liste blanche comme Autoriser.
2. IPs de la liste noire comme Bloquer.
3. Toute signature malveillante √©galement comme Bloquer.

### CloudWatch

Les m√©triques CloudWatch de WAF sont rapport√©es **par intervalles d'une minute par d√©faut** et sont conserv√©es pendant une p√©riode de deux semaines. Les m√©triques surveill√©es sont AllowedRequests, BlockedRequests, CountedRequests et PassedRequests.

## √ânum√©ration

Le scope peut √©galement √™tre CLOUDFRONT, mais lors de la v√©rification d'un WAF non li√© √† Cloudfront, vous devez utiliser REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Exploitation / Contournement

{% hint style="success" %}
Du point de vue d'un attaquant, ce service peut aider l'attaquant √† identifier les protections WAF et les expositions r√©seau qui pourraient l'aider √† compromettre d'autres sites web.

Cependant, un attaquant pourrait √©galement √™tre int√©ress√© par la perturbation de ce service afin que les sites web ne soient pas prot√©g√©s par le WAF.
{% endhint %}

TODO : Les PR sont les bienvenues

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
