# AWS - Enumera√ß√£o do WAF

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## WAF

O AWS WAF √© um **firewall de aplica√ß√£o web** que ajuda a **proteger suas aplica√ß√µes web** ou APIs contra explora√ß√µes web comuns que podem afetar a disponibilidade, comprometer a seguran√ßa ou consumir recursos excessivos. O AWS WAF oferece controle sobre **como o tr√°fego chega √†s suas aplica√ß√µes** ao permitir que voc√™ crie **regras de seguran√ßa que bloqueiam padr√µes de ataque comuns**, como inje√ß√£o de SQL ou cross-site scripting, e regras que filtram padr√µes de tr√°fego espec√≠ficos que voc√™ define.

### Condi√ß√µes

As condi√ß√µes permitem que voc√™ especifique **quais elementos da solicita√ß√£o HTTP ou HTTPS de entrada voc√™ deseja que o WAF monitore** (XSS, GEO - filtragem por localiza√ß√£o -, endere√ßo IP, restri√ß√µes de tamanho, ataques de inje√ß√£o de SQL, strings e correspond√™ncia de regex). Observe que, se voc√™ estiver restringindo um pa√≠s no CloudFront, essa solicita√ß√£o n√£o chegar√° ao WAF.

Voc√™ pode ter **100 condi√ß√µes de cada tipo**, como correspond√™ncia geogr√°fica ou restri√ß√µes de tamanho, no entanto, **Regex** √© a **exce√ß√£o** a essa regra, onde s√£o permitidas apenas **10 condi√ß√µes de Regex**, mas esse limite pode ser aumentado. Voc√™ pode ter **100 regras e 50 Web ACLs por conta da AWS**. Voc√™ est√° limitado a **5 regras baseadas em taxa** por conta. Por fim, voc√™ pode ter **10.000 solicita√ß√µes por segundo** ao **usar o WAF** em seu balanceador de carga de aplicativo.

### Regras

Usando essas condi√ß√µes, voc√™ pode criar regras: por exemplo, bloquear uma solicita√ß√£o se 2 condi√ß√µes forem atendidas.\
Ao criar sua regra, voc√™ ser√° solicitado a selecionar um **Tipo de Regra**: **Regra Regular** ou **Regra Baseada em Taxa**.

A √∫nica **diferen√ßa** entre uma regra baseada em taxa e uma regra regular √© que as regras baseadas em taxa **contam** o **n√∫mero** de **solicita√ß√µes** recebidas de um determinado endere√ßo IP durante um per√≠odo de tempo de **cinco minutos**.

Ao selecionar a op√ß√£o de regra baseada em taxa, voc√™ √© solicitado a **inserir o n√∫mero m√°ximo de solicita√ß√µes de um √∫nico IP dentro de um intervalo de cinco minutos**. Quando o limite de contagem √© **atingido**, **todas as outras solicita√ß√µes desse mesmo endere√ßo IP s√£o bloqueadas**. Se a taxa de solicita√ß√£o voltar abaixo do limite especificado, o tr√°fego √© permitido passar e n√£o √© mais bloqueado. Ao definir seu limite de taxa, ele **deve ser definido com um valor acima de 2000**. Qualquer solicita√ß√£o abaixo desse limite √© considerada uma Regra Regular.

### A√ß√µes

Uma a√ß√£o √© aplicada a cada regra, essas a√ß√µes podem ser **Permitir**, **Bloquear** ou **Contar**.

* Quando uma solicita√ß√£o √© **permitida**, ela √© **encaminhada** para a distribui√ß√£o relevante do CloudFront ou para o balanceador de carga de aplicativo.
* Quando uma solicita√ß√£o √© **bloqueada**, a solicita√ß√£o √© **encerrada** ali e nenhum processamento adicional dessa solicita√ß√£o √© realizado.
* Uma a√ß√£o de **Contagem** ir√° **contar o n√∫mero de solicita√ß√µes que atendem √†s condi√ß√µes** dentro dessa regra. Essa √© uma op√ß√£o muito boa para selecionar ao testar as regras para garantir que a regra esteja capturando as solicita√ß√µes conforme o esperado antes de defini-la como Permitir ou Bloquear.

Se uma **solicita√ß√£o de entrada n√£o atender a nenhuma regra** dentro do Web ACL, a solicita√ß√£o adota a a√ß√£o associada a uma **a√ß√£o padr√£o** especificada, que pode ser **Permitir** ou **Bloquear**. Um ponto importante a ser observado sobre essas regras √© que elas s√£o **executadas na ordem em que est√£o listadas dentro de um Web ACL**. Portanto, tenha cuidado ao arquitetar essa ordem corretamente para sua base de regras, **tipicamente** elas s√£o **ordenadas** da seguinte forma:

1. IPs na lista de permiss√µes como Permitir.
2. IPs na lista de bloqueios como Bloquear.
3. Quaisquer assinaturas ruins tamb√©m como Bloquear.

### CloudWatch

As m√©tricas do WAF no CloudWatch s√£o relatadas **em intervalos de um minuto por padr√£o** e s√£o mantidas por um per√≠odo de duas semanas. As m√©tricas monitoradas s√£o Solicita√ß√µes Permitidas, Solicita√ß√µes Bloqueadas, Solicita√ß√µes Contadas e Solicita√ß√µes Passadas.

## Enumera√ß√£o

O escopo tamb√©m pode ser CLOUDFRONT, mas ao verificar um WAF n√£o relacionado ao CloudFront, voc√™ precisa usar REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## P√≥s-Explora√ß√£o / Bypass

{% hint style="success" %}
Do ponto de vista de um atacante, este servi√ßo pode ajudar o atacante a identificar prote√ß√µes do WAF e exposi√ß√µes de rede que poderiam ajud√°-lo a comprometer outros sites.

No entanto, um atacante tamb√©m pode estar interessado em interromper este servi√ßo para que os sites n√£o sejam protegidos pelo WAF.
{% endhint %}

TODO: PRs s√£o bem-vindos

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
