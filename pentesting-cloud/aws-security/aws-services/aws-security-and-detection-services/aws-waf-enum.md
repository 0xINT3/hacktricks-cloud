# AWS - Enumeraci√≥n de WAF

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## WAF

AWS WAF es un **firewall de aplicaciones web** que ayuda a **proteger tus aplicaciones web** o APIs contra exploits web comunes que pueden afectar la disponibilidad, comprometer la seguridad o consumir recursos excesivos. AWS WAF te brinda control sobre **c√≥mo llega el tr√°fico a tus aplicaciones** al permitirte crear **reglas de seguridad que bloquean patrones de ataque comunes**, como la inyecci√≥n SQL o el scripting entre sitios, y reglas que filtran patrones de tr√°fico espec√≠ficos que definas.

### Condiciones

Las condiciones te permiten especificar **qu√© elementos de la solicitud HTTP o HTTPS entrante quieres que WAF est√© monitoreando** (XSS, GEO - filtrado por ubicaci√≥n-, direcci√≥n IP, restricciones de tama√±o, ataques de inyecci√≥n SQL, cadenas y coincidencia de expresiones regulares). Ten en cuenta que si est√°s restringiendo un pa√≠s desde CloudFront, esta solicitud no llegar√° al WAF.

Puedes tener **100 condiciones de cada tipo**, como coincidencia geogr√°fica o restricciones de tama√±o, sin embargo, **Regex** es la **excepci√≥n** a esta regla, donde solo se permiten **10 condiciones Regex**, pero este l√≠mite es posible aumentarlo. Puedes tener **100 reglas y 50 Web ACLs por cuenta de AWS**. Est√°s limitado a **5 reglas basadas en la tasa** por cuenta. Finalmente, puedes tener **10,000 solicitudes por segundo** cuando **utilizas WAF** dentro de tu balanceador de carga de aplicaciones.

### Reglas

Utilizando estas condiciones, puedes crear reglas: por ejemplo, bloquear una solicitud si se cumplen 2 condiciones.\
Al crear tu regla, se te pedir√° que selecciones un **Tipo de Regla**: **Regla Regular** o **Regla Basada en Tasa**.

La √∫nica **diferencia** entre una regla basada en tasa y una regla regular es que las reglas basadas en tasa **cuentan** la **cantidad** de **solicitudes** que se reciben de una direcci√≥n IP espec√≠fica durante un per√≠odo de tiempo de **cinco minutos**.

Cuando seleccionas la opci√≥n de regla basada en tasa, se te pide que **ingreses el n√∫mero m√°ximo de solicitudes de una sola IP dentro de un marco de tiempo de cinco minutos**. Cuando se alcanza el l√≠mite de conteo, **todas las dem√°s solicitudes de esa misma direcci√≥n IP se bloquean**. Si la tasa de solicitudes vuelve a caer por debajo del l√≠mite especificado, el tr√°fico se permite pasar y ya no se bloquea. Al establecer tu l√≠mite de tasa, **debe ser un valor superior a 2000**. Cualquier solicitud por debajo de este l√≠mite se considera una Regla Regular.

### Acciones

Se aplica una acci√≥n a cada regla, estas acciones pueden ser **Permitir** (**Allow**), **Bloquear** (**Block**) o **Contar** (**Count**).

* Cuando una solicitud es **permitida**, se **reenv√≠a** a la distribuci√≥n relevante de CloudFront o al balanceador de carga de aplicaciones correspondiente.
* Cuando una solicitud es **bloqueada**, la solicitud se **termina** all√≠ y no se realiza ning√∫n otro procesamiento de esa solicitud.
* Una acci√≥n de **Contar** contar√° la cantidad de solicitudes que cumplen las condiciones dentro de esa regla. Esta es una opci√≥n muy √∫til para seleccionar al probar las reglas y asegurarse de que la regla est√© captando las solicitudes como se espera antes de establecerla como Permitir o Bloquear.

Si una **solicitud entrante no cumple ninguna regla** dentro de la Web ACL, la solicitud toma la acci√≥n asociada a una **acci√≥n predeterminada** especificada, que puede ser **Permitir** o **Bloquear**. Un punto importante a tener en cuenta sobre estas reglas es que se **ejecutan en el orden en que se enumeran dentro de una Web ACL**. As√≠ que ten cuidado al dise√±ar este orden correctamente para tu base de reglas, **normalmente** se ordenan de la siguiente manera:

1. IPs en lista blanca como Permitir.
2. IPs en lista negra como Bloquear.
3. Cualquier firma maliciosa tambi√©n como Bloquear.

### CloudWatch

Las m√©tricas de CloudWatch de WAF se informan **en intervalos de un minuto de forma predeterminada** y se conservan durante un per√≠odo de dos semanas. Las m√©tricas monitoreadas son Solicitudes Permitidas (AllowedRequests), Solicitudes Bloqueadas (BlockedRequests), Solicitudes Contadas (CountedRequests) y Solicitudes Pasadas (PassedRequests).

## Enumeraci√≥n

El alcance tambi√©n puede ser CLOUDFRONT, pero al verificar un WAF no relacionado con CloudFront, debes usar REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Explotaci√≥n / Bypass

{% hint style="success" %}
Desde la perspectiva de un atacante, este servicio puede ayudar al atacante a identificar protecciones de WAF y exposiciones de red que podr√≠an ayudarlo a comprometer otros sitios web.

Sin embargo, un atacante tambi√©n podr√≠a estar interesado en interrumpir este servicio para que los sitios web no est√©n protegidos por el WAF.
{% endhint %}

TODO: Se aceptan PRs

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
