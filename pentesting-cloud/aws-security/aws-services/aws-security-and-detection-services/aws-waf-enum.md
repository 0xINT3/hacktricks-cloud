# AWS - Enum√©ration WAF

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## WAF

AWS WAF est un **pare-feu d'application web** qui aide √† **prot√©ger vos applications web** ou vos API contre les exploits web courants qui peuvent affecter la disponibilit√©, compromettre la s√©curit√© ou consommer des ressources excessives. AWS WAF vous donne le contr√¥le sur **la mani√®re dont le trafic atteint vos applications** en vous permettant de cr√©er des **r√®gles de s√©curit√© qui bloquent les sch√©mas d'attaque courants**, tels que l'injection SQL ou les scripts intersites, et des r√®gles qui filtrent des sch√©mas de trafic sp√©cifiques que vous d√©finissez.

### Conditions

Les conditions vous permettent de sp√©cifier **quels √©l√©ments de la requ√™te HTTP ou HTTPS entrante vous souhaitez que WAF surveille** (XSS, GEO - filtrage par emplacement -, adresse IP, contraintes de taille, attaques par injection SQL, correspondance de cha√Ænes et d'expressions r√©guli√®res). Notez que si vous restreignez un pays depuis CloudFront, cette requ√™te n'arrivera pas au WAF.

Vous pouvez avoir **100 conditions de chaque type**, telles que la correspondance g√©ographique ou les contraintes de taille, cependant **Regex** est **l'exception** √† cette r√®gle o√π **seules 10 conditions Regex** sont autoris√©es, mais cette limite peut √™tre augment√©e. Vous pouvez avoir **100 r√®gles et 50 Web ACL par compte AWS**. Vous √™tes limit√© √† **5 r√®gles bas√©es sur le taux** par compte. Enfin, vous pouvez avoir **10 000 requ√™tes par seconde** lorsque vous utilisez WAF avec votre r√©partiteur de charge d'application.

### R√®gles

En utilisant ces conditions, vous pouvez cr√©er des r√®gles : par exemple, bloquer une requ√™te si 2 conditions sont remplies.\
Lors de la cr√©ation de votre r√®gle, on vous demandera de s√©lectionner un **type de r√®gle** : **r√®gle r√©guli√®re** ou **r√®gle bas√©e sur le taux**.

La seule **diff√©rence** entre une r√®gle bas√©e sur le taux et une r√®gle r√©guli√®re est que les r√®gles bas√©es sur le taux **comptent** le **nombre de requ√™tes** re√ßues d'une adresse IP particuli√®re sur une p√©riode de **cinq minutes**.

Lorsque vous s√©lectionnez une option de r√®gle bas√©e sur le taux, on vous demande d'**entrer le nombre maximum de requ√™tes provenant d'une seule adresse IP dans une p√©riode de cinq minutes**. Lorsque la limite de comptage est **atteinte**, **toutes les autres requ√™tes provenant de cette m√™me adresse IP sont alors bloqu√©es**. Si le taux de requ√™tes retombe en dessous de la limite sp√©cifi√©e, le trafic est autoris√© √† passer et n'est plus bloqu√©. Lors de la d√©finition de votre limite de taux, elle **doit √™tre sup√©rieure √† 2000**. Toute requ√™te inf√©rieure √† cette limite est consid√©r√©e comme une r√®gle r√©guli√®re.

### Actions

Une action est appliqu√©e √† chaque r√®gle, ces actions peuvent √™tre **Autoriser**, **Bloquer** ou **Compter**.

* Lorsqu'une requ√™te est **autoris√©e**, elle est **transmise** √† la distribution CloudFront ou au r√©partiteur de charge d'application correspondant.
* Lorsqu'une requ√™te est **bloqu√©e**, la requ√™te est **interrompue** et aucun traitement ult√©rieur de cette requ√™te n'est effectu√©.
* Une action de **Comptage** permet de **compter le nombre de requ√™tes qui satisfont les conditions** de cette r√®gle. Il s'agit d'une option tr√®s utile √† s√©lectionner lors de la v√©rification des r√®gles pour s'assurer que la r√®gle d√©tecte les requ√™tes comme pr√©vu avant de la d√©finir comme Autoriser ou Bloquer.

Si une **requ√™te entrante ne satisfait aucune r√®gle** de la Web ACL, la requ√™te prend l'action associ√©e √† une **action par d√©faut** sp√©cifi√©e, qui peut √™tre soit **Autoriser**, soit **Bloquer**. Un point important √† souligner concernant ces r√®gles est qu'elles sont **ex√©cut√©es dans l'ordre dans lequel elles sont r√©pertori√©es dans une Web ACL**. Veillez donc √† bien organiser cet ordre pour votre base de r√®gles, **g√©n√©ralement** elles sont **ordonn√©es** comme suit :

1. Adresses IP en liste blanche en tant qu'Autoriser.
2. Adresses IP en liste noire en tant que Bloquer.
3. Toute signature suspecte √©galement en tant que Bloquer.

### CloudWatch

Les m√©triques CloudWatch de WAF sont rapport√©es **par d√©faut √† intervalles d'une minute** et sont conserv√©es pendant une p√©riode de deux semaines. Les m√©triques surveill√©es sont les suivantes : AllowedRequests, BlockedRequests, CountedRequests et PassedRequests.

## √ânum√©ration

La port√©e peut √©galement √™tre CLOUDFRONT, mais lors de la v√©rification d'un WAF non li√© √† CloudFront, vous devez utiliser REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Exploitation / Contournement

{% hint style="success" %}
Du point de vue d'un attaquant, ce service peut l'aider √† identifier les protections WAF et les vuln√©rabilit√©s r√©seau qui pourraient l'aider √† compromettre d'autres sites web.

Cependant, un attaquant pourrait √©galement √™tre int√©ress√© par la perturbation de ce service afin que les sites web ne soient pas prot√©g√©s par le WAF.
{% endhint %}

TODO: Les PR sont les bienvenues

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
