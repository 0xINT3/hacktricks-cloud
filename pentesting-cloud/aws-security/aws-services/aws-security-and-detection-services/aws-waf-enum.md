# AWS - WAF Enum

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

# AWS WAF

AWS WAF √© um **firewall de aplica√ß√£o web** projetado para **proteger aplica√ß√µes web ou APIs** contra v√°rios exploits da web que podem afetar sua disponibilidade, seguran√ßa ou consumo de recursos. Ele permite que os usu√°rios controlem o tr√°fego de entrada configurando **regras de seguran√ßa** que mitigam vetores de ataque t√≠picos como inje√ß√£o SQL ou cross-site scripting, al√©m de definir regras de filtragem personalizadas.

## Crit√©rios de Monitoramento (Condi√ß√µes)

Condi√ß√µes especificam os elementos das requisi√ß√µes HTTP/HTTPS de entrada que o AWS WAF monitora, que incluem XSS, localiza√ß√£o geogr√°fica (GEO), endere√ßos IP, restri√ß√µes de tamanho, inje√ß√£o SQL e padr√µes (correspond√™ncia de strings e regex). √â importante notar que requisi√ß√µes restritas no n√≠vel do CloudFront com base no pa√≠s n√£o chegar√£o ao WAF.

Cada conta AWS pode configurar:
- **100 condi√ß√µes** para cada tipo (exceto para Regex, onde apenas **10 condi√ß√µes** s√£o permitidas, mas esse limite pode ser aumentado).
- **100 regras** e **50 Web ACLs**.
- Um m√°ximo de **5 regras baseadas em taxa**.
- Um throughput de **10.000 requisi√ß√µes por segundo** quando o WAF √© implementado com um balanceador de carga de aplica√ß√£o.

## Configura√ß√£o de Regra

Regras s√£o criadas usando as condi√ß√µes especificadas. Por exemplo, uma regra pode bloquear uma requisi√ß√£o se ela atender a 2 condi√ß√µes espec√≠ficas. Existem dois tipos de regras:

1. **Regra Regular**: Regra padr√£o baseada nas condi√ß√µes especificadas.
2. **Regra Baseada em Taxa**: Conta as requisi√ß√µes de um endere√ßo IP espec√≠fico durante um per√≠odo de cinco minutos. Aqui, os usu√°rios definem um limite, e se o n√∫mero de requisi√ß√µes de um IP exceder esse limite dentro de cinco minutos, requisi√ß√µes subsequentes desse IP s√£o bloqueadas at√© que a taxa de requisi√ß√µes caia abaixo do limite. O limite m√≠nimo para regras baseadas em taxa √© de **2000 requisi√ß√µes**.

## A√ß√µes

A√ß√µes s√£o atribu√≠das a cada regra, com op√ß√µes sendo **Permitir**, **Bloquear** ou **Contar**:

- **Permitir**: A requisi√ß√£o √© encaminhada para a distribui√ß√£o CloudFront ou Balanceador de Carga de Aplica√ß√£o apropriado.
- **Bloquear**: A requisi√ß√£o √© terminada imediatamente.
- **Contar**: Registra as requisi√ß√µes que atendem √†s condi√ß√µes da regra. Isso √© √∫til para testar regras, confirmando a precis√£o da regra antes de configur√°-la para Permitir ou Bloquear.

Se uma requisi√ß√£o n√£o corresponder a nenhuma regra dentro da Web ACL, ela passa pela **a√ß√£o padr√£o** (Permitir ou Bloquear). A ordem de execu√ß√£o das regras, definida dentro de uma Web ACL, √© crucial e normalmente segue esta sequ√™ncia:

1. Permitir IPs na lista branca.
2. Bloquear IPs na lista negra.
3. Bloquear requisi√ß√µes que correspondam a quaisquer assinaturas prejudiciais.

## Integra√ß√£o com CloudWatch

AWS WAF integra-se com o CloudWatch para monitoramento, oferecendo m√©tricas como AllowedRequests, BlockedRequests, CountedRequests e PassedRequests. Essas m√©tricas s√£o relatadas a cada minuto por padr√£o e retidas por um per√≠odo de duas semanas.


## Enumera√ß√£o

O escopo tamb√©m pode ser CLOUDFRONT, mas ao verificar um WAF n√£o relacionado ao Cloudfront, voc√™ precisa usar REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## P√≥s-Explora√ß√£o / Bypass

{% hint style="success" %}
Do ponto de vista de um atacante, este servi√ßo pode ajudar o atacante a identificar prote√ß√µes WAF e exposi√ß√µes de rede que poderiam ajud√°-lo a comprometer outros sites.

No entanto, um atacante tamb√©m pode estar interessado em interromper este servi√ßo para que os sites n√£o sejam protegidos pelo WAF.
{% endhint %}

TODO: PRs s√£o bem-vindos

# Refer√™ncias
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo do [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
