# AWS - WAF Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## WAF

AWS WAF es un **firewall de aplicaciones web** que ayuda a **proteger tus aplicaciones web** o APIs contra explotaciones web comunes que pueden afectar la disponibilidad, comprometer la seguridad o consumir recursos excesivos. AWS WAF te permite controlar **c√≥mo llega el tr√°fico a tus aplicaciones** al permitirte crear **reglas de seguridad que bloquean patrones de ataque comunes**, como inyecci√≥n SQL o cross-site scripting, y reglas que filtran patrones de tr√°fico espec√≠ficos que defines.

### Condiciones

Las condiciones te permiten especificar **qu√© elementos de la solicitud HTTP o HTTPS entrante quieres que WAF est√© monitoreando** (XSS, GEO - filtrado por ubicaci√≥n-, direcci√≥n IP, restricciones de tama√±o, ataques de inyecci√≥n SQL, coincidencia de cadenas y regex). Ten en cuenta que si est√°s restringiendo un pa√≠s desde CloudFront, esta solicitud no llegar√° al WAF.

Puedes tener **100 condiciones de cada tipo**, como coincidencia geogr√°fica o restricciones de tama√±o, sin embargo, **Regex** es la **excepci√≥n** a esta regla donde **solo se permiten 10 condiciones Regex** pero es posible aumentar este l√≠mite. Puedes tener **100 reglas y 50 Web ACLs por cuenta de AWS**. Est√°s limitado a **5 reglas basadas en tasa** por cuenta. Finalmente, puedes tener **10,000 solicitudes por segundo** cuando **utilizas WAF** dentro de tu balanceador de carga de aplicaciones.

### Reglas

Usando estas condiciones puedes crear reglas: Por ejemplo, bloquear solicitud si se cumplen 2 condiciones.\
Al crear tu regla se te pedir√° que selecciones un **Tipo de Regla**: **Regla Regular** o **Regla Basada en Tasa**.

La √∫nica **diferencia** entre una regla basada en tasa y una regla regular es que las reglas basadas en tasa **cuentan** el **n√∫mero** de **solicitudes** que se reciben de una direcci√≥n IP particular durante un per√≠odo de **cinco minutos**.

Cuando seleccionas la opci√≥n de regla basada en tasa, se te pide que **introduzcas el n√∫mero m√°ximo de solicitudes de una sola IP dentro de un marco de tiempo de cinco minutos**. Cuando se **alcanza el l√≠mite de conteo**, **todas las dem√°s solicitudes de esa misma direcci√≥n IP se bloquean**. Si la tasa de solicitudes vuelve a caer por debajo del l√≠mite de tasa especificado, el tr√°fico se permite pasar y ya no se bloquea. Al establecer tu l√≠mite de tasa, **debe ser un valor superior a 2000**. Cualquier solicitud por debajo de este l√≠mite se considera una Regla Regular.

### Acciones

Una acci√≥n se aplica a cada regla, estas acciones pueden ser **Permitir**, **Bloquear** o **Contar**.

* Cuando una solicitud es **permitida**, se **reenv√≠a** a la distribuci√≥n de CloudFront o al Balanceador de Carga de Aplicaciones correspondiente.
* Cuando una solicitud es **bloqueada**, la solicitud se **termina** all√≠ y no se realiza ning√∫n procesamiento adicional de esa solicitud.
* Una acci√≥n de **Contar** **contabilizar√° el n√∫mero de solicitudes que cumplen con las condiciones** dentro de esa regla. Esta es una muy buena opci√≥n para seleccionar al probar las reglas para asegurarse de que la regla est√° capturando las solicitudes como se espera antes de configurarla para Permitir o Bloquear.

Si una **solicitud entrante no cumple con ninguna regla** dentro de la Web ACL, entonces la solicitud toma la acci√≥n asociada a una **acci√≥n predeterminada** especificada que puede ser **Permitir** o **Bloquear**. Un punto importante a mencionar sobre estas reglas es que se **ejecutan en el orden en que est√°n listadas dentro de una Web ACL**. Por lo tanto, ten cuidado de arquitectar este orden correctamente para tu base de reglas, **t√≠picamente** estas est√°n **ordenadas** como se muestra:

1. IPs en la Lista Blanca como Permitir.
2. IPs en la Lista Negra como Bloquear.
3. Cualquier Firma Mala tambi√©n como Bloquear.

### CloudWatch

Las m√©tricas de WAF CloudWatch se informan **en intervalos de un minuto por defecto** y se mantienen durante un per√≠odo de dos semanas. Las m√©tricas monitoreadas son AllowedRequests, BlockedRequests, CountedRequests y PassedRequests.

## Enumeraci√≥n

El alcance tambi√©n puede ser CLOUDFRONT, pero al verificar un WAF no relacionado con CloudFront necesitas usar REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Explotaci√≥n / Evasi√≥n

{% hint style="success" %}
Desde la perspectiva de un atacante, este servicio puede ayudar al atacante a identificar protecciones de WAF y exposiciones de red que podr√≠an ayudarle a comprometer otras webs.

Sin embargo, un atacante tambi√©n podr√≠a estar interesado en interrumpir este servicio para que las webs no est√©n protegidas por el WAF.
{% endhint %}

TODO: Se aceptan PRs

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
