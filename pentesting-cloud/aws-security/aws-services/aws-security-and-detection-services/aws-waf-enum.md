# AWS - WAF 枚举

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## WAF

AWS WAF是一个**网络应用防火墙**，它有助于**保护您的网络应用程序**或API免受可能影响可用性、危害安全或消耗过多资源的常见网络攻击。AWS WAF让您可以控制**如何处理流向您的应用程序的流量**，通过创建**阻止常见攻击模式的安全规则**，例如SQL注入或跨站脚本攻击，以及过滤您定义的特定流量模式的规则。

### 条件

条件允许您指定**您希望WAF监控的传入HTTP或HTTPS请求的哪些元素**（XSS、GEO - 根据位置过滤 -、IP地址、大小限制、SQL注入攻击、字符串和正则表达式匹配）。请注意，如果您从cloudfront限制了一个国家，这个请求将不会到达waf。

您可以拥有**每种类型100个条件**，例如地理匹配或大小限制，但**正则表达式**是**例外**，在这个规则中**只允许10个正则表达式**条件，但这个限制是可能增加的。您可以在每个AWS账户中拥有**100条规则和50个Web ACL**。您每个账户限制**5个基于速率的规则**。最后，当**使用WAF**时，您的应用程序负载均衡器可以有**每秒10,000个请求**。

### 规则

使用这些条件，您可以创建规则：例如，如果满足2个条件，则阻止请求。\
创建规则时，您将被要求选择一个**规则类型**：**常规规则**或**基于速率的规则**。

基于速率的规则和常规规则之间的唯一**区别**是，基于速率的规则**计算**在**五分钟**时间内从特定IP地址收到的**请求数**。

当您选择基于速率的规则选项时，您将被要求**输入五分钟时间内单个IP的最大请求数**。当达到计数限制时，**来自同一IP地址的所有其他请求随后被阻止**。如果请求速率降低到指定的速率限制以下，流量则被允许通过，不再被阻止。设置速率限制时，**必须设置一个超过2000的值**。任何低于此限制的请求被视为常规规则。

### 操作

每条规则都应用一个操作，这些操作可以是**允许**、**阻止**或**计数**。

* 当一个请求被**允许**时，它被**转发**到相关的CloudFront分发或应用程序负载均衡器。
* 当一个请求被**阻止**时，该请求被**终止**，不再对该请求进行进一步处理。
* **计数**操作将**计算符合该规则条件的请求数量**。在测试规则以确保规则如预期般捕获请求之前，选择这个选项是一个非常好的选择，然后再将其设置为允许或阻止。

如果**传入请求不符合Web ACL中的任何规则**，则请求采取与**默认操作**相关联的操作，该操作可以是**允许**或**阻止**。关于这些规则的一个重要点是，它们是**按照在Web ACL中列出的顺序执行的**。因此，要小心正确地为您的规则库设计这个顺序，**通常**这些是**按照以下顺序排列**的：

1. 将白名单IP设置为允许。
2. 将黑名单IP设置为阻止。
3. 将任何坏的签名也设置为阻止。

### CloudWatch

WAF CloudWatch指标**默认以一分钟间隔报告**，并保留两周时间。监控的指标包括AllowedRequests, BlockedRequests, CountedRequests和PassedRequests。

## 枚举

范围也可以是CLOUDFRONT，但在检查与CLoudfront无关的WAF时，您需要使用REGIONAL。
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## 后渗透 / 绕过

{% hint style="success" %}
从攻击者的角度来看，这项服务可以帮助攻击者识别WAF保护和网络暴露，这可能有助于他们攻破其他网站。

然而，攻击者也可能对破坏这项服务感兴趣，以便网站不受WAF的保护。
{% endhint %}

TODO: 欢迎提交PR

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库**提交PR来分享你的黑客技巧**。

</details>
