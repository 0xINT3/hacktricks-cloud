# AWS - WAF Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

# AWS WAF

AWS WAFは、**ウェブアプリケーションファイアウォール**であり、可用性、セキュリティ、またはリソース消費に影響を与える可能性のある様々なウェブ攻撃から**ウェブアプリケーションやAPIを保護**するように設計されています。ユーザーは、SQLインジェクションやクロスサイトスクリプティングなどの典型的な攻撃ベクトルを軽減する**セキュリティルール**を設定することで、またカスタムフィルタリングルールを定義することで、受信トラフィックを制御することができます。

## 監視基準（条件）

条件は、AWS WAFが監視する受信HTTP/HTTPSリクエストの要素を指定し、XSS、地理的位置（GEO）、IPアドレス、サイズ制約、SQLインジェクション、パターン（文字列と正規表現マッチング）を含みます。国に基づいてCloudFrontレベルで制限されたリクエストはWAFに到達しないことに注意が必要です。

各AWSアカウントは以下を設定できます:
- 各タイプごとに**100条件**（ただしRegexは**10条件**のみ許可され、この制限は増やすことができます）。
- **100ルール**と**50 Web ACL**。
- 最大**5レートベースのルール**。
- アプリケーションロードバランサーでWAFが実装された場合の**秒間10,000リクエスト**のスループット。

## ルール設定

ルールは指定された条件を使用して作成されます。例えば、ルールは2つの特定の条件を満たすリクエストをブロックするかもしれません。ルールには2種類あります:

1. **通常のルール**: 指定された条件に基づく標準的なルール。
2. **レートベースのルール**: 5分間の期間に特定のIPアドレスからのリクエストをカウントします。ここで、ユーザーは閾値を定義し、5分以内にIPからのリクエスト数がこの限界を超えると、そのIPからの後続のリクエストは、リクエスト率が閾値以下に下がるまでブロックされます。レートベースのルールの最小閾値は**2000リクエスト**です。

## アクション

各ルールには**許可**、**ブロック**、または**カウント**のオプションが割り当てられたアクションがあります:

- **許可**: リクエストは適切なCloudFrontディストリビューションまたはアプリケーションロードバランサーに転送されます。
- **ブロック**: リクエストは即座に終了します。
- **カウント**: ルールの条件を満たすリクエストを集計します。これは、ルールを許可またはブロックに設定する前に、ルールの正確さを確認するためのテストに役立ちます。

Web ACL内のどのルールにも一致しないリクエストは、**デフォルトアクション**（許可またはブロック）を受けます。Web ACL内で定義されたルールの実行順序は重要であり、通常は以下の順序に従います:

1. ホワイトリストされたIPを許可。
2. ブラックリストされたIPをブロック。
3. 有害なシグネチャに一致するリクエストをブロック。

## CloudWatch統合

AWS WAFはCloudWatchと統合して監視を提供し、AllowedRequests、BlockedRequests、CountedRequests、PassedRequestsなどのメトリクスを提供します。これらのメトリクスはデフォルトで毎分報告され、2週間保持されます。

## 列挙

スコープはCLOUDFRONTも可能ですが、Cloudfrontに関連しないWAFをチェックする場合はREGIONALを使用する必要があります。
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Exploitation / Bypass

{% hint style="success" %}
攻撃者の視点からは、このサービスは攻撃者がWAFの保護やネットワークの露出を特定し、他のウェブサイトを侵害するのに役立つ可能性があります。

しかし、攻撃者はこのサービスを妨害してウェブサイトがWAFによって保護されないようにすることにも関心を持つかもしれません。
{% endhint %}

TODO: PRs are welcome

# 参考文献
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローになる方法を学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
