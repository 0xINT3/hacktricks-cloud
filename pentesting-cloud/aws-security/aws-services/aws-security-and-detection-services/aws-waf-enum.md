# AWS - WAF Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## WAF

AWS WAFは、可用性に影響を与えたり、セキュリティを損なったり、過剰なリソースを消費する可能性のある一般的なWeb攻撃から、WebアプリケーションまたはAPIを保護するのに役立つ**Webアプリケーションファイアウォール**です。AWS WAFを使用すると、SQLインジェクションやクロスサイトスクリプティングなどの一般的な攻撃パターンをブロックする**セキュリティルール**を作成したり、定義した特定のトラフィックパターンをフィルタリングするルールを作成することで、アプリケーションへのトラフィックの流れを制御できます。

### 条件

条件を使用すると、WAFが監視する必要がある**受信HTTPまたはHTTPSリクエストのどの要素を指定するか**（XSS、GEO - 位置によるフィルタリング -、IPアドレス、サイズ制約、SQLインジェクション攻撃、文字列および正規表現マッチング）を指定できます。cloudfrontから国を制限している場合、このリクエストはWAFに到達しません。

Geo Matchやサイズ制約など、各タイプの条件を**100個**持つことができますが、**Regex**はこのルールの**例外**で、**Regex条件は10個**のみ許可されていますが、この制限は増やすことが可能です。AWSアカウントごとに**100のルールと50のWeb ACL**を持つことができます。アカウントごとに**5つのレートベースのルール**に制限されています。最後に、アプリケーションロードバランサー内で**WAFを使用する場合、秒間**10,000リクエスト**を持つことができます。

### ルール

これらの条件を使用してルールを作成できます。例えば、2つの条件が満たされた場合にリクエストをブロックします。\
ルールを作成するときには、**ルールタイプ**を選択するように求められます：**通常のルール**または**レートベースのルール**。

レートベースのルールと通常のルールの唯一の**違い**は、レートベースのルールが**5分間**の期間に特定のIPアドレスから受け取った**リクエストの数**を**カウント**することです。

レートベースのルールオプションを選択すると、**5分間の時間枠内で単一のIPからの最大リクエスト数**を入力するように求められます。カウント制限に**達した場合**、その同じIPアドレスからの**他のすべてのリクエストはブロックされます**。リクエスト率が指定されたレート制限を下回ると、トラフィックは通過を許可され、もはやブロックされません。レート制限を設定するときは、**2000以上の値に設定する必要があります**。この制限以下のリクエストは通常のルールと見なされます。

### アクション

各ルールにはアクションが適用され、これらのアクションは**許可**、**ブロック**、または**カウント**のいずれかになります。

* リクエストが**許可される**と、関連するCloudFrontディストリビューションまたはアプリケーションロードバランサーに**転送**されます。
* リクエストが**ブロックされる**と、そのリクエストはそこで**終了**し、そのリクエストのさらなる処理は行われません。
* **カウント**アクションは、そのルール内の条件を満たすリクエストの数を**カウント**します。これは、ルールが期待どおりにリクエストを検出していることを確認するために、設定を許可またはブロックにする前に選択するのに非常に良いオプションです。

**Web ACL内のどのルールにも該当しない受信リクエスト**は、**デフォルトアクション**に関連付けられたアクションを取ります。これは**許可**または**ブロック**のいずれかになります。これらのルールについて重要な点は、Web ACL内でリストされている順序で**実行される**ということです。したがって、ルールベースを正しく設計するために、この順序に注意してください。**通常**、次のように**順序付け**されます：

1. 許可としてのホワイトリストIP。
2. ブロックとしてのブラックリストIP。
3. ブロックとしての悪いシグネチャも。

### CloudWatch

WAF CloudWatchメトリクスは**デフォルトで1分間隔**で報告され、2週間の期間保持されます。監視されるメトリクスにはAllowedRequests、BlockedRequests、CountedRequests、PassedRequestsがあります。

## 列挙

スコープはCLOUDFRONTも可能ですが、Cloudfrontに関連しないWAFをチェックする場合はREGIONALを使用する必要があります。
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post Exploitation / Bypass

{% hint style="success" %}
攻撃者の視点からは、このサービスはWAFの保護とネットワークの露出を特定するのに役立ち、他のウェブサイトの侵害につながる可能性があります。

しかし、攻撃者はこのサービスを妨害してウェブサイトがWAFによって保護されないようにすることにも関心を持つかもしれません。
{% endhint %}

TODO: PRs are welcome

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
