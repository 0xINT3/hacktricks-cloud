# AWS - WAF枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## WAF

AWS WAF是一个**Web应用程序防火墙**，可帮助**保护您的Web应用程序**或API免受可能影响可用性、危害安全性或消耗过多资源的常见Web攻击。AWS WAF通过允许您创建**安全规则来阻止常见的攻击模式**（如SQL注入或跨站脚本），以及过滤您定义的特定流量模式的规则，使您能够控制**流量如何到达您的应用程序**。

### 条件

条件允许您指定**您希望WAF监视的传入HTTP或HTTPS请求的哪些元素**（XSS、GEO-按位置过滤-、IP地址、大小约束、SQL注入攻击、字符串和正则表达式匹配）。请注意，如果您限制了来自CloudFront的某个国家/地区的请求，该请求将不会到达WAF。

您可以拥有每种类型的**100个条件**，例如Geo Match或大小约束，但是**正则表达式**是**例外**，只允许**10个正则表达式**条件，但可以增加此限制。您的AWS账户可以拥有**100个规则和50个Web ACL**。您的账户每个账户限制为**5个基于速率的规则**。最后，当在应用程序负载均衡器中**使用WAF**时，您可以每秒处理**10,000个请求**。

### 规则

使用这些条件，您可以创建规则：例如，如果满足2个条件，则阻止请求。\
在创建规则时，您将被要求选择**规则类型**：**常规规则**或**基于速率的规则**。

基于速率的规则和常规规则之间唯一的**区别**在于，**基于速率的规则**会**计算**在**五分钟**时间段内从特定IP地址接收到的**请求数量**。

当您选择基于速率的规则选项时，您将被要求**输入在五分钟时间范围内从单个IP地址接收到的最大请求数量**。当达到计数限制时，**来自同一IP地址的所有其他请求将被阻止**。如果请求速率回落到指定的速率限制以下，则允许流量通过并不再被阻止。在设置速率限制时，**必须将其设置为大于2000的值**。低于此限制的任何请求都被视为常规规则。

### 操作

每个规则都应用一个操作，这些操作可以是**允许**、**阻止**或**计数**。

* 当请求被**允许**时，它会被**转发**到相应的CloudFront分发或应用程序负载均衡器。
* 当请求被**阻止**时，请求会在那里**终止**，不再进行进一步处理。
* **计数**操作将**计算满足该规则条件的请求数量**。这是一个非常好的选项，用于在设置为允许或阻止之前测试规则，以确保规则按预期捕获请求。

如果**传入请求不符合Web ACL中的任何规则**，则该请求将采取与指定的**默认操作**相关联的操作，该操作可以是**允许**或**阻止**。关于这些规则的一个重要点是它们是按照在Web ACL中列出的顺序**执行**的。因此，在为您的规则库正确构建此顺序时要小心，**通常**按照以下顺序排序：

1. 将白名单IP设置为允许。
2. 将黑名单IP设置为阻止。
3. 将任何不良签名也设置为阻止。

### CloudWatch

WAF CloudWatch指标默认以**一分钟间隔报告**，并保留两周。监控的指标包括AllowedRequests、BlockedRequests、CountedRequests和PassedRequests。

## 枚举

范围也可以是CLOUDFRONT，但是在检查与CLoudfront无关的WAF时，您需要使用REGIONAL。
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## 后渗透/绕过

{% hint style="success" %}
从攻击者的角度来看，这项服务可以帮助攻击者识别WAF保护和网络暴露，从而帮助他入侵其他网站。

然而，攻击者也可能对破坏这项服务感兴趣，以便使网站不受WAF保护。
{% endhint %}

TODO：欢迎提交PR

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
