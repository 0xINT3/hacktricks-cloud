# AWS - WAF Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## WAF

AWS WAFは、一般的なWebの脆弱性からWebアプリケーションやAPIを保護するための**Webアプリケーションファイアウォール**です。AWS WAFを使用すると、SQLインジェクションやクロスサイトスクリプティングなどの一般的な攻撃パターンをブロックする**セキュリティルール**や、特定のトラフィックパターンをフィルタリングするルールを作成することができます。

### 条件

条件を使用すると、WAFが監視する**受信HTTPまたはHTTPSリクエストの要素**（XSS、GEO-場所によるフィルタリング、IPアドレス、サイズ制約、SQLインジェクション攻撃、文字列および正規表現の一致）を指定できます。ただし、CloudFrontから特定の国を制限している場合、このリクエストはWAFに到達しません。

Geo Matchやサイズ制約などのように、各タイプの条件を**100個**持つことができますが、**Regex**はこのルールの**例外**であり、**10個のRegex**条件のみが許可されますが、この制限は増やすことが可能です。AWSアカウントごとに**100のルールと50のWeb ACL**を持つことができます。アカウントごとに**5つのレートベースのルール**が制限されています。最後に、アプリケーションロードバランサー内で**WAFを使用**する場合、**1秒あたりのリクエスト数は10,000**まで可能です。

### ルール

これらの条件を使用して、ルールを作成することができます。例えば、2つの条件が満たされた場合にリクエストをブロックするなどです。\
ルールを作成する際には、**ルールタイプ**（**通常のルール**または**レートベースのルール**）を選択するように求められます。

レートベースのルールと通常のルールの唯一の**違い**は、レートベースのルールが**5分間**の時間枠内で特定のIPアドレスから受信される**リクエストの数**を**カウント**することです。

レートベースのルールオプションを選択すると、**5分間の時間枠内で単一のIPからの最大リクエスト数**を入力するように求められます。カウント制限に達すると、そのIPアドレスからの他のすべてのリクエストがブロックされます。リクエストレートが指定されたレート制限以下に戻った場合、トラフィックは通過し、ブロックされなくなります。レート制限は**2000以上の値に設定する必要があります**。この制限以下のリクエストは通常のルールと見なされます。

### アクション

各ルールにはアクションが適用されます。これらのアクションは**許可**、**ブロック**、または**カウント**のいずれかです。

* リクエストが**許可**されると、関連するCloudFrontディストリビューションまたはアプリケーションロードバランサーに**転送**されます。
* リクエストが**ブロック**されると、リクエストはそこで**終了**し、そのリクエストのさらなる処理は行われません。
* **カウント**アクションは、そのルール内の条件を満たすリクエストの数を**カウント**します。これは、ルールが予想どおりのリクエストを取得していることを確認するためにルールをテストする際に選択する非常に良いオプションです。その後、AllowまたはBlockに設定する前に。

Web ACL内の**どのルールにも一致しない受信リクエスト**は、指定された**デフォルトアクション**（AllowまたはBlock）に関連付けられたアクションを実行します。これらのルールについて重要なポイントは、それらがWeb ACL内でリストされている順序で**実行**されることです。したがって、ルールベースのためにこの順序を正しく設計するために注意が必要です。**通常**、これらは次のように**順序付け**られます：

1. AllowとしてホワイトリストされたIPアドレス。
2. ブロックされたIPアドレスをブラックリストに登録。
3. バッドシグネチャもブロックとして。

### CloudWatch

WAF CloudWatchメトリクスは、デフォルトでは**1分間隔**で報告され、2週間保持されます。監視されるメトリクスには、AllowedRequests、BlockedRequests、CountedRequests、PassedRequestsがあります。

## 列挙

スコープはCLOUDFRONTでも可能ですが、CLoudfrontに関連しないWAFをチェックする場合は、REGIONALを使用する必要があります。
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## ポストエクスプロイテーション / バイパス

{% hint style="success" %}
攻撃者の視点から見ると、このサービスは攻撃者が他のウェブを侵害するのに役立つ可能性のあるWAFの保護とネットワークの露出を特定するのに役立ちます。

ただし、攻撃者はこのサービスを妨害して、ウェブがWAFで保護されないようにすることにも興味を持つかもしれません。
{% endhint %}

TODO: PRは歓迎されています

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
