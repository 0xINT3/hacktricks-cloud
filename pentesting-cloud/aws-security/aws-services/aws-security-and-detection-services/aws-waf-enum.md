# AWS - WAF Enum

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Heldenniveau mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

# AWS WAF

AWS WAF ist eine **Web Application Firewall**, die entwickelt wurde, um **Webanwendungen oder APIs** vor verschiedenen Web-Exploits zu sch√ºtzen, die sich auf deren Verf√ºgbarkeit, Sicherheit oder Ressourcenverbrauch auswirken k√∂nnen. Es erm√∂glicht Benutzern, den eingehenden Datenverkehr zu kontrollieren, indem sie **Sicherheitsregeln** festlegen, die typische Angriffsvektoren wie SQL-Injektion oder Cross-Site-Scripting abwehren, und auch benutzerdefinierte Filterregeln definieren.

## √úberwachungskriterien (Bedingungen)

Bedingungen legen die Elemente der eingehenden HTTP/HTTPS-Anfragen fest, die von AWS WAF √ºberwacht werden, darunter XSS, geografischer Standort (GEO), IP-Adressen, Gr√∂√üenbeschr√§nkungen, SQL-Injektion und Muster (Zeichenfolgen und Regex-√úbereinstimmungen). Es ist wichtig zu beachten, dass Anfragen, die auf CloudFront-Ebene auf L√§nderbasis eingeschr√§nkt sind, WAF nicht erreichen.

Jedes AWS-Konto kann konfigurieren:
- **100 Bedingungen** f√ºr jeden Typ (au√üer f√ºr Regex, wo nur **10 Bedingungen** erlaubt sind, aber dieses Limit kann erh√∂ht werden).
- **100 Regeln** und **50 Web ACLs**.
- Maximal **5 ratebasierte Regeln**.
- Eine Durchsatzrate von **10.000 Anfragen pro Sekunde**, wenn WAF mit einem Application Load Balancer implementiert ist.

## Regelkonfiguration

Regeln werden unter Verwendung der spezifizierten Bedingungen erstellt. Zum Beispiel k√∂nnte eine Regel eine Anfrage blockieren, wenn sie 2 spezifische Bedingungen erf√ºllt. Es gibt zwei Arten von Regeln:

1. **Regul√§re Regel**: Standardregel basierend auf spezifizierten Bedingungen.
2. **Ratebasierte Regel**: Z√§hlt Anfragen von einer bestimmten IP-Adresse √ºber einen Zeitraum von f√ºnf Minuten. Hier definieren Benutzer einen Schwellenwert, und wenn die Anzahl der Anfragen von einer IP-Adresse innerhalb von f√ºnf Minuten diesen Grenzwert √ºberschreitet, werden nachfolgende Anfragen von dieser IP-Adresse blockiert, bis die Anfrageh√§ufigkeit unter den Schwellenwert f√§llt. Der Mindestschwellenwert f√ºr ratebasierte Regeln betr√§gt **2000 Anfragen**.

## Aktionen

Aktionen werden jeder Regel zugewiesen, wobei die Optionen **Erlauben**, **Blockieren** oder **Z√§hlen** sind:

- **Erlauben**: Die Anfrage wird an die entsprechende CloudFront-Verteilung oder den Application Load Balancer weitergeleitet.
- **Blockieren**: Die Anfrage wird sofort beendet.
- **Z√§hlen**: Z√§hlt die Bedingungen der Regel erf√ºllenden Anfragen. Dies ist n√ºtzlich f√ºr die Regelpr√ºfung, um die Genauigkeit der Regel vor der Einstellung auf Erlauben oder Blockieren zu best√§tigen.

Wenn eine Anfrage keiner Regel innerhalb der Web ACL entspricht, durchl√§uft sie die **Standardaktion** (Erlauben oder Blockieren). Die Reihenfolge der Regelausf√ºhrung, die innerhalb einer Web ACL definiert ist, ist entscheidend und folgt in der Regel dieser Sequenz:

1. Erlauben von IP-Adressen in der Whitelist.
2. Blockieren von IP-Adressen in der Blacklist.
3. Blockieren von Anfragen, die mit sch√§dlichen Signaturen √ºbereinstimmen.

## CloudWatch-Integration

AWS WAF integriert sich mit CloudWatch zur √úberwachung und bietet Metriken wie Erlaubte Anfragen, Blockierte Anfragen, Gez√§hlte Anfragen und Bestandene Anfragen. Diese Metriken werden standardm√§√üig alle Minute gemeldet und f√ºr einen Zeitraum von zwei Wochen gespeichert.

## Enumeration

Der Bereich kann auch CLOUDFRONT sein, aber wenn Sie nach einem WAF suchen, der nicht mit Cloudfront zusammenh√§ngt, m√ºssen Sie REGIONAL verwenden.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## Post-Exploitation / Umgehung

{% hint style="success" %}
Aus der Sicht eines Angreifers kann dieser Dienst dem Angreifer helfen, WAF-Schutzma√ünahmen und Netzwerkexpositionen zu identifizieren, die ihm helfen k√∂nnten, andere Websites zu kompromittieren.

Ein Angreifer k√∂nnte jedoch auch daran interessiert sein, diesen Dienst zu st√∂ren, damit die Websites nicht durch die WAF gesch√ºtzt sind.
{% endhint %}

TODO: PRs sind willkommen

# Referenzen
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
