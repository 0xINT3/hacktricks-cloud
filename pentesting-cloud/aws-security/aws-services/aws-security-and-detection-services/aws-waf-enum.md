# AWS - Enumera√ß√£o do WAF

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

# AWS WAF

O AWS WAF √© um **firewall de aplicativos da web** projetado para **proteger aplicativos da web ou APIs** contra v√°rios exploits da web que podem afetar sua disponibilidade, seguran√ßa ou consumo de recursos. Ele capacita os usu√°rios a controlar o tr√°fego de entrada configurando **regras de seguran√ßa** que mitigam vetores de ataque t√≠picos como inje√ß√£o de SQL ou scripts entre sites e tamb√©m definindo regras de filtragem personalizadas.

## Crit√©rios de Monitoramento (Condi√ß√µes)

As condi√ß√µes especificam os elementos das solicita√ß√µes HTTP/HTTPS de entrada que o AWS WAF monitora, que incluem XSS, localiza√ß√£o geogr√°fica (GEO), endere√ßos IP, restri√ß√µes de tamanho, inje√ß√£o de SQL e padr√µes (correspond√™ncia de strings e regex). √â importante observar que as solicita√ß√µes restritas no n√≠vel do CloudFront com base no pa√≠s n√£o alcan√ßar√£o o WAF.

Cada conta da AWS pode configurar:
- **100 condi√ß√µes** para cada tipo (exceto para Regex, onde apenas **10 condi√ß√µes** s√£o permitidas, mas esse limite pode ser aumentado).
- **100 regras** e **50 Web ACLs**.
- Um m√°ximo de **5 regras baseadas em taxa**.
- Uma taxa de transfer√™ncia de **10.000 solicita√ß√µes por segundo** quando o WAF √© implementado com um balanceador de carga de aplicativo.

## Configura√ß√£o de Regras

As regras s√£o elaboradas usando as condi√ß√µes especificadas. Por exemplo, uma regra pode bloquear uma solicita√ß√£o se ela atender a 2 condi√ß√µes espec√≠ficas. Existem dois tipos de regras:

1. **Regra Regular**: Regra padr√£o baseada em condi√ß√µes especificadas.
2. **Regra Baseada em Taxa**: Conta solicita√ß√µes de um endere√ßo IP espec√≠fico ao longo de um per√≠odo de cinco minutos. Aqui, os usu√°rios definem um limite, e se o n√∫mero de solicita√ß√µes de um IP exceder esse limite dentro de cinco minutos, as solicita√ß√µes subsequentes desse IP s√£o bloqueadas at√© que a taxa de solicita√ß√£o caia abaixo do limite. O limite m√≠nimo para regras baseadas em taxa √© de **2000 solicita√ß√µes**.

## A√ß√µes

As a√ß√µes s√£o atribu√≠das a cada regra, com op√ß√µes sendo **Permitir**, **Bloquear** ou **Contar**:

- **Permitir**: A solicita√ß√£o √© encaminhada para a distribui√ß√£o CloudFront apropriada ou Balanceador de Carga de Aplicativos.
- **Bloquear**: A solicita√ß√£o √© encerrada imediatamente.
- **Contar**: Contabiliza as solicita√ß√µes que atendem √†s condi√ß√µes da regra. Isso √© √∫til para testar a regra, confirmando a precis√£o da regra antes de defini-la como Permitir ou Bloquear.

Se uma solicita√ß√£o n√£o corresponder a nenhuma regra dentro do Web ACL, ela passar√° pela **a√ß√£o padr√£o** (Permitir ou Bloquear). A ordem de execu√ß√£o das regras, definida dentro de um Web ACL, √© crucial e geralmente segue esta sequ√™ncia:

1. Permitir IPs na lista branca.
2. Bloquear IPs na lista negra.
3. Bloquear solicita√ß√µes que correspondam a quaisquer assinaturas prejudiciais.

## Integra√ß√£o com o CloudWatch

O AWS WAF se integra ao CloudWatch para monitoramento, oferecendo m√©tricas como Solicita√ß√µes Permitidas, Solicita√ß√µes Bloqueadas, Solicita√ß√µes Contadas e Solicita√ß√µes Passadas. Essas m√©tricas s√£o relatadas a cada minuto por padr√£o e retidas por um per√≠odo de duas semanas.

## Enumera√ß√£o

O escopo tamb√©m pode ser CLOUDFRONT, mas ao verificar um WAF n√£o relacionado ao Cloudfront, √© necess√°rio usar REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## P√≥s-Explora√ß√£o / Bypass

{% hint style="success" %}
Do ponto de vista de um atacante, este servi√ßo pode ajudar o atacante a identificar prote√ß√µes do WAF e exposi√ß√µes de rede que poderiam ajud√°-lo a comprometer outros sites.

No entanto, um atacante tamb√©m pode estar interessado em interromper este servi√ßo para que os sites n√£o sejam protegidos pelo WAF.
{% endhint %}

TODO: Pull Requests s√£o bem-vindos

# Refer√™ncias
* https://www.citrusconsulting.com/aws-web-application-firewall-waf/#:~:text=Conditions%20allow%20you%20to%20specify,user%20via%20a%20web%20application.

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
