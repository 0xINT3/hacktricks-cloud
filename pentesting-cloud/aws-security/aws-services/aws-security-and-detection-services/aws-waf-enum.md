# AWS - WAF Enum

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## WAF

O AWS WAF √© um **firewall de aplica√ß√£o web** que ajuda a **proteger suas aplica√ß√µes web** ou APIs contra explora√ß√µes comuns da web que podem afetar a disponibilidade, comprometer a seguran√ßa ou consumir recursos excessivos. O AWS WAF permite que voc√™ controle **como o tr√°fego chega √†s suas aplica√ß√µes** ao possibilitar a cria√ß√£o de **regras de seguran√ßa que bloqueiam padr√µes de ataque comuns**, como inje√ß√£o de SQL ou cross-site scripting, e regras que filtram padr√µes de tr√°fego espec√≠ficos que voc√™ define.

### Condi√ß√µes

Condi√ß√µes permitem que voc√™ especifique **quais elementos da requisi√ß√£o HTTP ou HTTPS entrante voc√™ quer que o WAF monitore** (XSS, GEO - filtragem por localiza√ß√£o -, endere√ßo IP, restri√ß√µes de tamanho, ataques de inje√ß√£o de SQL, correspond√™ncia de strings e regex). Note que se voc√™ est√° restringindo um pa√≠s do CloudFront, essa requisi√ß√£o n√£o chegar√° ao WAF.

Voc√™ pode ter **100 condi√ß√µes de cada tipo**, como Geo Match ou restri√ß√µes de tamanho, no entanto, **Regex** √© a **exce√ß√£o** a esta regra, onde **apenas 10 condi√ß√µes Regex** s√£o permitidas, mas esse limite pode ser aumentado. Voc√™ pode ter **100 regras e 50 Web ACLs por conta AWS**. Voc√™ est√° limitado a **5 regras baseadas em taxa** por conta. Finalmente, voc√™ pode ter **10.000 requisi√ß√µes por segundo** ao **usar o WAF** dentro do seu balanceador de carga de aplica√ß√£o.

### Regras

Usando essas condi√ß√µes, voc√™ pode criar regras: Por exemplo, bloquear a requisi√ß√£o se 2 condi√ß√µes forem atendidas.\
Ao criar sua regra, ser√° solicitado que voc√™ selecione um **Tipo de Regra**: **Regra Regular** ou **Regra Baseada em Taxa**.

A √∫nica **diferen√ßa** entre uma regra baseada em taxa e uma regra regular √© que regras baseadas em taxa **contam** o **n√∫mero** de **requisi√ß√µes** que est√£o sendo recebidas de um determinado endere√ßo IP durante um per√≠odo de **cinco minutos**.

Quando voc√™ seleciona a op√ß√£o de regra baseada em taxa, √© solicitado que voc√™ **insira o n√∫mero m√°ximo de requisi√ß√µes de um √∫nico IP dentro de um per√≠odo de cinco minutos**. Quando o limite de contagem √© **atingido**, **todas as outras requisi√ß√µes desse mesmo endere√ßo IP s√£o ent√£o bloqueadas**. Se a taxa de requisi√ß√µes voltar a ficar abaixo do limite especificado, o tr√°fego √© ent√£o permitido passar e n√£o √© mais bloqueado. Ao definir seu limite de taxa, ele **deve ser definido para um valor acima de 2000**. Qualquer requisi√ß√£o abaixo desse limite √© considerada uma Regra Regular.

### A√ß√µes

Uma a√ß√£o √© aplicada a cada regra, essas a√ß√µes podem ser **Permitir**, **Bloquear** ou **Contar**.

* Quando uma requisi√ß√£o √© **permitida**, ela √© **encaminhada** para a distribui√ß√£o do CloudFront relevante ou para o Balanceador de Carga de Aplica√ß√£o.
* Quando uma requisi√ß√£o √© **bloqueada**, a requisi√ß√£o √© **terminada** ali e nenhum processamento adicional dessa requisi√ß√£o √© realizado.
* Uma a√ß√£o de **Contar** ir√° **contar o n√∫mero de requisi√ß√µes que atendem √†s condi√ß√µes** dentro daquela regra. Esta √© uma op√ß√£o muito boa para selecionar ao testar as regras para garantir que a regra est√° capturando as requisi√ß√µes conforme esperado antes de configur√°-la para Permitir ou Bloquear.

Se uma **requisi√ß√£o entrante n√£o atender a nenhuma regra** dentro da Web ACL, ent√£o a requisi√ß√£o toma a a√ß√£o associada a uma **a√ß√£o padr√£o** especificada, que pode ser **Permitir** ou **Bloquear**. Um ponto importante a ser mencionado sobre essas regras √© que elas s√£o **executadas na ordem em que est√£o listadas dentro de uma Web ACL**. Portanto, tenha cuidado ao arquitetar essa ordem corretamente para sua base de regras, **tipicamente** elas s√£o **ordenadas** como mostrado:

1. IPs na Lista Branca como Permitir.
2. IPs na Lista Negra como Bloquear.
3. Qualquer Assinatura Ruim tamb√©m como Bloquear.

### CloudWatch

As m√©tricas do WAF CloudWatch s√£o relatadas **em intervalos de um minuto por padr√£o** e s√£o mantidas por um per√≠odo de duas semanas. As m√©tricas monitoradas s√£o AllowedRequests, BlockedRequests, CountedRequests e PassedRequests.

## Enumera√ß√£o

O escopo tamb√©m pode ser CLOUDFRONT, mas ao verificar um WAF n√£o relacionado ao CloudFront, voc√™ precisa usar REGIONAL.
```
# Get web acls
aws wafv2 list-web-acls --scope REGIONAL
aws wafv2 get-web-acl --scope REGIONAL --name <name> --id <id>
aws wafv2 list-resources-for-web-acl --web-acl-arn <web-acl-arn> #Resources associated with the ACL
aws wafv2 get-web-acl-for-resource --resource-arn <arn> # Get web acl of the resource

# Rule groups
aws wafv2 list-rule-groups --scope REGIONAL
aws wafv2 get-rule-group --scope REGIONAL --name <name> --id <id>

# Get IP sets
aws wafv2 list-ip-sets --scope=REGIONAL
aws wafv2 get-ip-set --scope=REGIONAL --name <name> --id <id>

# Get regex patterns
aws wafv2 list-regex-pattern-sets --scope REGIONAL

# Get logging config (buckets storing the logs)
aws wafv2 list-logging-configurations --scope=REGIONAL
```
## P√≥s-Explora√ß√£o / Bypass

{% hint style="success" %}
Do ponto de vista de um atacante, este servi√ßo pode ajudar o atacante a identificar prote√ß√µes WAF e exposi√ß√µes de rede que poderiam ajud√°-lo a comprometer outros sites.

No entanto, um atacante tamb√©m pode estar interessado em interromper este servi√ßo para que os sites n√£o estejam protegidos pelo WAF.
{% endhint %}

TODO: PRs s√£o bem-vindos

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo do [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
