# AWS - GuardDuty 枚举

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## GuardDuty

根据[**文档**](https://aws.amazon.com/guardduty/features/)：GuardDuty 结合了**机器学习、异常检测、网络监控和恶意文件发现**，使用 AWS 和业界领先的第三方来源来帮助保护 AWS 上的工作负载和数据。GuardDuty 能够分析数十亿个事件，跨多个 AWS 数据源，例如 AWS CloudTrail 事件日志、Amazon Virtual Private Cloud (VPC) 流日志、Amazon Elastic Kubernetes Service (EKS) 审计和系统级日志以及 DNS 查询日志。

Amazon GuardDuty **识别账户中的异常活动**，分析活动的**安全相关性**，并提供其被调用的**上下文**。这使得响应者能够确定是否应该花时间进行进一步调查。

警报会出现在 GuardDuty 控制台（90 天）和 CloudWatch 事件中。

{% hint style="warning" %}
当用户**禁用 GuardDuty**时，它将停止监控您的 AWS 环境，并且不会生成任何新的发现，**现有的发现将丢失**。\
如果只是停止它，现有的发现将保留。
{% endhint %}

### 发现示例

* **侦察**：活动表明攻击者进行侦察，例如**异常的 API 活动**、可疑的数据库**登录**尝试、VPC 内部**端口扫描**、异常的登录请求失败模式，或者来自已知恶意 IP 的未阻止的端口探测。
* **实例被入侵**：表明实例被入侵的活动，例如**加密货币挖矿、后门命令和控制 (C\&C)** 活动、使用域生成算法 (DGA) 的恶意软件、出站拒绝服务活动、异常**高网络**流量量、异常的网络协议、实例与已知恶意 IP 的出站通信、外部 IP 地址使用的临时 Amazon EC2 凭证，以及使用 DNS 进行的数据外泄。
* **账户被入侵**：表明账户被入侵的常见模式包括来自异常地理位置或匿名代理的 API 调用、试图禁用 AWS CloudTrail 日志记录、削弱账户密码策略的更改、异常的实例或基础架构启动、在异常区域部署基础架构、凭证盗窃、可疑的数据库登录活动以及来自已知恶意 IP 地址的 API 调用。
* **存储桶被入侵**：表明存储桶被入侵的活动，例如表明凭证滥用的可疑数据访问模式、来自远程主机的异常 Amazon S3 API 活动、来自已知恶意 IP 地址的未经授权的 S3 访问，以及从以前没有访问过该存储桶的用户或从异常位置调用的用户中检索 S3 存储桶中的数据的 API 调用。Amazon GuardDuty 持续监控和分析 AWS CloudTrail S3 数据事件（例如 GetObject、ListObjects、DeleteObject），以检测所有 Amazon S3 存储桶中的可疑活动。

<details>

<summary>发现信息</summary>

发现摘要：

* 发现类型
* 严重程度：7-8.9 高，4-6.9 中，01-3.9 低
* 区域
* 账户 ID
* 资源 ID
* 检测时间
* 使用的威胁列表

正文包含以下信息：

* 受影响的资源
* 操作
* 执行者：IP 地址、端口和域名
* 附加信息

</details>

### 所有发现

访问所有 GuardDuty 发现的列表：[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### 多账户

#### 通过邀请

您可以**邀请其他账户**加入不同的 AWS GuardDuty 账户，以便**从同一个 GuardDuty 监控所有账户**。主账户必须邀请成员账户，然后成员账户的代表必须接受邀请。

#### 通过组织

您可以指定组织中的任何账户为**GuardDuty 委派管理员**。只有组织管理账户可以指定委派管理员。

被指定为委派管理员的账户将成为 GuardDuty 管理员账户，在指定的 AWS 区域自动启用 GuardDuty，并且还具有**在该区域内为组织中的所有账户启用和管理 GuardDuty 的权限**。组织中的其他账户可以被视为与该委派管理员账户关联的 GuardDuty 成员账户，并且可以查看并添加这些账户。

## 枚举

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty绕过

### 一般指导

尽可能多地了解您将要使用的凭据的行为：

* 使用的时间
* 位置
* 用户代理/服务（可能是从awscli、webconsole、lambda等使用）
* 常用的权限

根据这些信息，尽可能地重新创建相同的场景来使用访问权限：

* 如果是由用户访问的**用户或角色**，请尝试在相同的时间段内、相同的地理位置（甚至是相同的ISP和IP，如果可能的话）使用它
* 如果是由服务使用的**角色**，请在相同的区域创建相同的服务，并在相同的时间范围内使用它
* 始终尝试使用此主体已使用的**相同权限**
* 如果您需要**使用其他权限或滥用权限**（例如，下载1,000,000个cloudtrail日志文件），请**缓慢**进行，并且与AWS的**最小交互次数**（awscli有时在写入之前调用多个读取API）

### 修改GuardDuty

#### `guardduty:ListDetectors`，`guardduty:UpdateDetector`

使用这些权限，您可以禁用GuardDuty以避免触发警报。
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

攻击者可以创建或更新GuardDuty的[受信任的IP列表](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)，包括将**自己的IP添加到列表中**。在受信任的IP列表中的任何IP都**不会触发任何Cloudtrail或VPC流日志警报**。

{% hint style="info" %}
DNS发现不受受信任的IP列表的影响。
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
根据所需的隐蔽程度，文件可以上传到目标账户的s3存储桶中，或者上传到攻击者控制的账户中。
{% endhint %}

#### `guardduty:CreateFilter`

新创建的GuardDuty发现可以通过[抑制规则](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)自动归档。攻击者可以使用[过滤器](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html)来自动归档他们可能生成的发现。

可以使用[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html)来创建过滤器。
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

攻击者可以通过[删除警报的目标](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)来禁用警报。
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
删除此发布目标将**不会影响GuardDuty控制台中的发现生成或可见性**。GuardDuty将继续分析您的AWS环境中的事件，识别可疑或意外行为，并生成发现。
{% endhint %}

### 特定发现绕过

#### 渗透测试发现

OS的GuardDuty检测到常见渗透测试工具的AWS API请求，并触发[Pentest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux)。\
它是通过传递的API请求中的**用户代理名称**来检测的。\
因此，**修改用户代理**可以防止GuardDuty检测到攻击。

使用Ubuntu、Mac或Windows等操作系统将防止触发此警报。

要防止此问题，您可以在`botocore`包中的脚本`session.py`中搜索。在Kali Linux中，它位于`/usr/local/lib/python3.7/dist-packages/botocore/session.py`。

在[456行附近](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)，您应该看到`platform.system()`和`platform.release()`。将此**代码替换为合法的用户代理字符串，例如**[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt)**中的字符串**。

#### Tor客户端发现

{% hint style="success" %}
绕过此问题最简单的方法就是**不使用Tor连接到AWS**（如果您想保持隐身并模拟凭据被入侵的情况，为什么要使用Tor呢？）
{% endhint %}

如果您从**Tor**进行连接，**Guarduty**将设置警报[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**。**

Guarduty通过[公共的Tor节点列表](https://metrics.torproject.org/exonerator.html)来检测此问题。&#x20;

如果您需要通过Tor进行连接，可以使用[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)来绕过此问题。但显然，最好的方法是根本不使用Tor进行连接。

要使用桥接，您可以使用[Obfs4](https://gitlab.com/yawning/obfs4)（`apt install tor obfs4proxy`）并从[bridges.torproject.org](https://bridges.torproject.org/options)获取桥接地址。

从这里，创建一个类似以下内容的`torrc`文件：
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
运行 `tor -f torrc`，您可以连接到端口9050上的常规socks5代理。

#### 凭证泄露检测

如果您从元数据服务中**窃取EC2凭证**并在**AWS基础设施之外**使用它们，将触发警报[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)。

此外，如果您**使用自己的EC2实例**来使用**窃取的凭证**，将触发警报[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)。

{% hint style="warning" %}
如果您已经**入侵**了同一**账户**中的另一个**EC2**机器，您可以在那里使用凭证而**不会触发警报**。
{% endhint %}

然而，目前有一种可以绕过此问题的方法 - [VPC终端节点](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)。使用**VPC终端节点**将**不会触发GuardDuty警报**。这意味着，作为攻击者，`如果您从EC2实例窃取IAM凭证，您可以在通过VPC终端节点路由流量的自己的EC2实例中使用这些凭证。这不会触发GuardDuty发现`。

工具[**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints)被创建用于自动化此过程。该项目通过Terraform在私有子网中创建一个没有互联网访问权限的EC2实例，并为您创建多个VPC终端节点供您使用。

**绕过此警报的另一种方法**是在被窃取凭证的同一台机器上**或者同一账户中的其他机器上**简单地使用窃取的凭证。

## 参考资料

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本**或下载**PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[NFT收藏品**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
