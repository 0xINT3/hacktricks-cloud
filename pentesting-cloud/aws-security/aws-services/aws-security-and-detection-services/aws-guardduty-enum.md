# AWS - √ânum√©ration GuardDuty

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GuardDuty

Selon la [**documentation**](https://aws.amazon.com/guardduty/features/) : GuardDuty combine **l'apprentissage automatique, la d√©tection d'anomalies, la surveillance du r√©seau et la d√©couverte de fichiers malveillants**, en utilisant √† la fois des sources AWS et des sources tierces de premier plan pour aider √† prot√©ger les charges de travail et les donn√©es sur AWS. GuardDuty est capable d'analyser des dizaines de milliards d'√©v√©nements √† travers de multiples sources de donn√©es AWS, telles que les journaux d'√©v√©nements AWS CloudTrail, les journaux de flux Amazon Virtual Private Cloud (VPC), les journaux d'audit et les journaux syst√®me Amazon Elastic Kubernetes Service (EKS), et les journaux de requ√™tes DNS.

Amazon GuardDuty **identifie les activit√©s inhabituelles au sein de vos comptes**, analyse la **pertinence s√©curitaire** de l'activit√© et donne le **contexte** dans lequel elle a √©t√© invoqu√©e. Cela permet √† un intervenant de d√©terminer s'il doit consacrer du temps √† une enqu√™te approfondie.

Les alertes **apparaissent dans la console GuardDuty (90 jours)** et les √©v√©nements CloudWatch.

{% hint style="warning" %}
Lorsqu'un utilisateur **d√©sactive GuardDuty**, il arr√™tera la surveillance de votre environnement AWS et ne g√©n√©rera plus de nouvelles d√©couvertes, et les **d√©couvertes existantes seront perdues**.\
Si vous l'arr√™tez simplement, les d√©couvertes existantes resteront.
{% endhint %}

### Exemple de d√©couvertes

* **Reconnaissance** : Activit√© sugg√©rant une reconnaissance par un attaquant, telle que **activit√© API inhabituelle**, tentatives de **connexion** √† la base de donn√©es suspectes, **balayage de ports** intra-VPC, motifs inhabituels de demandes de connexion √©chou√©es, ou sondage de ports non bloqu√©s depuis une IP malveillante connue.
* **Compromission d'instance** : Activit√© indiquant une compromission d'instance, telle que **minage de cryptomonnaie, commande et contr√¥le (C&C)** de backdoor, malware utilisant des algorithmes de g√©n√©ration de domaines (DGA), activit√© de d√©ni de service sortant, volume de trafic r√©seau **√©lev√©** inhabituel, protocoles r√©seau inhabituels, communication sortante d'instance avec une IP malveillante connue, utilisation de cr√©dentials Amazon EC2 temporaires par une adresse IP externe, et exfiltration de donn√©es via DNS.
* **Compromission de compte** : Des mod√®les communs indiquant une compromission de compte incluent des appels API depuis une g√©olocalisation inhabituelle ou un proxy anonymisant, des tentatives de d√©sactivation de la journalisation AWS CloudTrail, des modifications affaiblissant la politique de mot de passe du compte, des lancements d'instance ou d'infrastructure inhabituels, des d√©ploiements d'infrastructure dans une r√©gion inhabituelle, vol de cr√©dentials, activit√© de connexion √† la base de donn√©es suspecte, et appels API depuis des adresses IP malveillantes connues.
* **Compromission de bucket** : Activit√© indiquant une compromission de bucket, telle que des mod√®les d'acc√®s aux donn√©es suspects indiquant un abus de cr√©dentials, activit√© API Amazon S3 inhabituelle depuis un h√¥te distant, acc√®s non autoris√© √† S3 depuis des adresses IP malveillantes connues, et appels API pour r√©cup√©rer des donn√©es dans des buckets S3 par un utilisateur sans historique pr√©alable d'acc√®s au bucket ou invoqu√©s depuis un emplacement inhabituel. Amazon GuardDuty surveille et analyse en continu les √©v√©nements de donn√©es S3 AWS CloudTrail (par exemple, GetObject, ListObjects, DeleteObject) pour d√©tecter une activit√© suspecte dans tous vos buckets Amazon S3.

<details>

<summary>Informations sur les d√©couvertes</summary>

R√©sum√© des d√©couvertes :

* Type de d√©couverte
* S√©v√©rit√© : 7-8.9 √âlev√©e, 4-6.9 Moyenne, 01-3.9 Faible
* R√©gion
* ID de compte
* ID de ressource
* Moment de la d√©tection
* Liste des menaces utilis√©e

Le corps contient ces informations :

* Ressource affect√©e
* Action
* Acteur : adresse IP, port et domaine
* Informations suppl√©mentaires

</details>

### Toutes les d√©couvertes

Acc√©dez √† une liste de toutes les d√©couvertes GuardDuty sur : [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Comptes multiples

#### Par invitation

Vous pouvez **inviter d'autres comptes** √† un compte AWS GuardDuty diff√©rent afin que **chaque compte soit surveill√© depuis le m√™me GuardDuty**. Le compte principal doit inviter les comptes membres puis le repr√©sentant du compte membre doit accepter l'invitation.

#### Via l'organisation

Vous pouvez d√©signer n'importe quel compte au sein de l'organisation pour √™tre l'**administrateur d√©l√©gu√© GuardDuty**. Seul le compte de gestion de l'organisation peut d√©signer un administrateur d√©l√©gu√©.

Un compte qui est d√©sign√© comme administrateur d√©l√©gu√© devient un compte administrateur GuardDuty, a GuardDuty activ√© automatiquement dans la r√©gion AWS d√©sign√©e, et a √©galement la **permission d'activer et de g√©rer GuardDuty pour tous les comptes de l'organisation dans cette r√©gion**. Les autres comptes de l'organisation peuvent √™tre consult√©s et ajout√©s en tant que comptes membres GuardDuty associ√©s √† ce compte administrateur d√©l√©gu√©.

## √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
## Contournement de GuardDuty

### Conseils g√©n√©raux

Essayez de d√©couvrir autant que possible le comportement des identifiants que vous allez utiliser :

* Fr√©quence d'utilisation
* Localisations
* Agents utilisateurs / Services (Il pourrait √™tre utilis√© depuis awscli, webconsole, lambda...)
* Permissions r√©guli√®rement utilis√©es

Avec ces informations, recr√©ez autant que possible le m√™me sc√©nario pour utiliser l'acc√®s :

* S'il s'agit d'**un utilisateur ou d'un r√¥le acc√©d√© par un utilisateur**, essayez de l'utiliser aux m√™mes heures, depuis la m√™me g√©olocalisation (m√™me le m√™me FAI et IP si possible)
* S'il s'agit d'**un r√¥le utilis√© par un service**, cr√©ez le m√™me service dans la m√™me r√©gion et utilisez-le de l√† aux m√™mes plages horaires
* Essayez toujours d'utiliser les **m√™mes permissions** que ce principal a utilis√©es
* Si vous avez besoin d'**utiliser d'autres permissions ou d'abuser d'une permission** (par exemple, t√©l√©charger 1.000.000 de fichiers de logs cloudtrail) faites-le **lentement** et avec le **nombre minimum d'interactions** avec AWS (awscli appelle parfois plusieurs API de lecture avant celle d'√©criture)

### Briser GuardDuty

#### `guardduty:UpdateDetector`

Avec cette permission, vous pourriez d√©sactiver GuardDuty pour √©viter de d√©clencher des alertes.

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
#### `guardduty:CreateFilter`

Les attaquants disposant de cette permission ont la capacit√© de **mettre en place des filtres pour l'archivage automatique** des r√©sultats :

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Les attaquants avec les privil√®ges pr√©c√©dents pourraient modifier la [**liste d'IP de confiance**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_upload-lists.html) de GuardDuty en ajoutant leur adresse IP pour √©viter de g√©n√©rer des alertes.

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
#### `guardduty:DeletePublishingDestination`

Les attaquants pourraient supprimer la destination pour emp√™cher les alertes :

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
Supprimer cette destination de publication **n'affectera pas la g√©n√©ration ou la visibilit√© des d√©couvertes dans la console GuardDuty**. GuardDuty continuera d'analyser les √©v√©nements dans votre environnement AWS, d'identifier les comportements suspects ou inattendus et de g√©n√©rer des d√©couvertes.
{% endhint %}

### Exemples de contournement de d√©couvertes sp√©cifiques

Notez qu'il existe des dizaines de d√©couvertes GuardDuty, cependant, **en tant que Red Teamer, elles ne vous affecteront pas toutes**, et mieux encore, vous avez la **documentation compl√®te de chacune d'entre elles** sur [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html) donc consultez-la avant toute action pour ne pas vous faire prendre.

Voici quelques exemples de contournements de d√©couvertes sp√©cifiques de GuardDuty :

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty d√©tecte les requ√™tes API AWS provenant d'outils de pentesting courants et d√©clenche une [d√©couverte PenTest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Cela est d√©tect√© par le **nom de l'agent utilisateur** qui est transmis dans la requ√™te API.\
Par cons√©quent, **modifier l'agent utilisateur** permet d'emp√™cher GuardDuty de d√©tecter l'attaque.

Pour √©viter cela, vous pouvez rechercher le script `session.py` dans le package `botocore` et modifier l'agent utilisateur, ou configurer Burp Suite comme proxy de l'AWS CLI et changer l'agent utilisateur avec le MitM ou simplement utiliser un OS comme Ubuntu, Mac ou Windows pour √©viter le d√©clenchement de cette alerte.

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

Extraire les identifiants EC2 du service de m√©tadonn√©es et les **utiliser √† l'ext√©rieur** de l'environnement AWS active l'alerte [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws). √Ä l'inverse, utiliser ces identifiants depuis votre instance EC2 d√©clenche l'alerte [**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws). Cependant, **utiliser les identifiants sur une autre instance EC2 compromise dans le m√™me compte passe inaper√ßu**, sans d√©clencher d'alerte.

{% hint style="success" %}
Par cons√©quent, **utilisez les identifiants exfiltr√©s depuis la machine** o√π vous les avez trouv√©s pour ne pas d√©clencher cette alerte.
{% endhint %}

## R√©f√©rences

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
