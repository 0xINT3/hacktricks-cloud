# AWS - Enumera√ß√£o do GuardDuty

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>

## GuardDuty

De acordo com a [**documenta√ß√£o**](https://aws.amazon.com/guardduty/features/): O GuardDuty combina **aprendizado de m√°quina, detec√ß√£o de anomalias, monitoramento de rede e descoberta de arquivos maliciosos**, usando tanto fontes da AWS quanto de terceiros l√≠deres do setor para ajudar a proteger cargas de trabalho e dados na AWS. O GuardDuty √© capaz de analisar dezenas de bilh√µes de eventos em v√°rias fontes de dados da AWS, como logs de eventos do AWS CloudTrail, logs de fluxo do Amazon Virtual Private Cloud (VPC), logs de auditoria e logs de n√≠vel de sistema do Amazon Elastic Kubernetes Service (EKS) e logs de consulta DNS.

O Amazon GuardDuty **identifica atividades incomuns em suas contas**, analisa a **relev√¢ncia de seguran√ßa** da atividade e fornece o **contexto** em que ela foi invocada. Isso permite que um respondedor determine se deve gastar tempo em investiga√ß√µes adicionais.

Alertas **aparecem no console do GuardDuty (90 dias)** e em Eventos do CloudWatch.

{% hint style="warning" %}
Quando um usu√°rio **desativa o GuardDuty**, ele deixar√° de monitorar seu ambiente da AWS e n√£o gerar√° novas descobertas, e as **descobertas existentes ser√£o perdidas**.\
Se voc√™ apenas parar, as descobertas existentes permanecer√£o.
{% endhint %}

### Exemplo de Descobertas

* **Reconhecimento**: Atividade que sugere reconhecimento por um invasor, como atividade de API **incomum**, tentativas de **login** suspeitas em bancos de dados, **varredura de porta** intra-VPC, padr√µes de solicita√ß√£o de login falhadas incomuns ou sondagem de porta desbloqueada de um IP conhecido como malicioso.
* **Comprometimento de inst√¢ncia**: Atividade que indica um comprometimento de inst√¢ncia, como minera√ß√£o de **criptomoedas, comando e controle (C\&C)** de backdoor, malware usando algoritmos de gera√ß√£o de dom√≠nio (DGA), atividade de nega√ß√£o de servi√ßo de sa√≠da, volume de tr√°fego de rede **muito alto**, protocolos de rede incomuns, comunica√ß√£o de inst√¢ncia de sa√≠da com um IP malicioso conhecido, credenciais tempor√°rias do Amazon EC2 usadas por um endere√ßo IP externo e exfiltra√ß√£o de dados usando DNS.
* **Comprometimento de conta**: Padr√µes comuns indicativos de comprometimento de conta incluem chamadas de API de uma geolocaliza√ß√£o incomum ou proxy de anonimiza√ß√£o, tentativas de desativar o registro do AWS CloudTrail, altera√ß√µes que enfraquecem a pol√≠tica de senha da conta, lan√ßamentos de inst√¢ncia ou infraestrutura incomuns, implanta√ß√µes de infraestrutura em uma regi√£o incomum, roubo de credenciais, atividade de login de banco de dados suspeita e chamadas de API de endere√ßos IP maliciosos conhecidos.
* **Comprometimento de bucket**: Atividade que indica um comprometimento de bucket, como padr√µes de acesso a dados suspeitos que indicam uso indevido de credenciais, atividade de API do Amazon S3 incomum de um host remoto, acesso n√£o autorizado ao S3 de endere√ßos IP maliciosos conhecidos e chamadas de API para recuperar dados em buckets S3 de um usu√°rio sem hist√≥rico pr√©vio de acesso ao bucket ou invocado de uma localiza√ß√£o incomum. O Amazon GuardDuty monitora e analisa continuamente eventos de dados do AWS CloudTrail S3 (por exemplo, GetObject, ListObjects, DeleteObject) para detectar atividades suspeitas em todos os seus buckets do Amazon S3.

<details>

<summary>Informa√ß√µes sobre Descobertas</summary>

Resumo da descoberta:

* Tipo de descoberta
* Gravidade: 7-8.9 Alta, 4-6.9 M√©dia, 01-3.9 Baixa
* Regi√£o
* ID da conta
* ID do recurso
* Hora da detec√ß√£o
* Lista de amea√ßas utilizada

O corpo cont√©m estas informa√ß√µes:

* Recurso afetado
* A√ß√£o
* Ator: Endere√ßo IP, porta e dom√≠nio
* Informa√ß√µes adicionais

</details>

### Todas as Descobertas

Acesse uma lista de todas as descobertas do GuardDuty em: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### M√∫ltiplas Contas

#### Por Convite

Voc√™ pode **convidar outras contas** para uma conta diferente do AWS GuardDuty para que **todas as contas sejam monitoradas pelo mesmo GuardDuty**. A conta mestre deve convidar as contas de membro e, em seguida, o representante da conta de membro deve aceitar o convite.

#### Via Organiza√ß√£o

Voc√™ pode designar qualquer conta dentro da organiza√ß√£o para ser o **administrador delegado do GuardDuty**. Somente a conta de gerenciamento da organiza√ß√£o pode designar um administrador delegado.

Uma conta que √© designada como administrador delegado se torna uma conta de administrador do GuardDuty, tem o GuardDuty habilitado automaticamente na regi√£o AWS designada e tamb√©m tem a **permiss√£o para habilitar e gerenciar o GuardDuty para todas as contas na organiza√ß√£o dentro dessa regi√£o**. As outras contas na organiza√ß√£o podem ser visualizadas e adicionadas como contas de membro do GuardDuty associadas a essa conta de administrador delegado.

## Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass do GuardDuty

### Orienta√ß√µes Gerais

Tente descobrir o m√°ximo poss√≠vel sobre o comportamento das credenciais que voc√™ vai usar:

* Hor√°rios em que s√£o usadas
* Localiza√ß√µes
* Agentes de usu√°rio / Servi√ßos (pode ser usado a partir do awscli, webconsole, lambda...)
* Permiss√µes regularmente usadas

Com essas informa√ß√µes, recrie o m√°ximo poss√≠vel o mesmo cen√°rio para usar o acesso:

* Se for um **usu√°rio ou uma fun√ß√£o acessada por um usu√°rio**, tente us√°-lo nas mesmas horas, na mesma geolocaliza√ß√£o (at√© mesmo o mesmo ISP e IP, se poss√≠vel)
* Se for uma **fun√ß√£o usada por um servi√ßo**, crie o mesmo servi√ßo na mesma regi√£o e use-o a partir da√≠ nos mesmos intervalos de tempo
* Sempre tente usar as **mesmas permiss√µes** que esse principal usou
* Se voc√™ precisar **usar outras permiss√µes ou abusar de uma permiss√£o** (por exemplo, baixar 1.000.000 de arquivos de log do CloudTrail), fa√ßa isso **devagar** e com a **quantidade m√≠nima de intera√ß√µes** com a AWS (o awscli √†s vezes chama v√°rias APIs de leitura antes da de grava√ß√£o)

### Modificar o GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Com essas permiss√µes, voc√™ pode desativar o GuardDuty para evitar acionar alertas.
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Um atacante poderia criar ou atualizar a lista de IPs confi√°veis do GuardDuty, incluindo **seu pr√≥prio IP na lista**. Quaisquer IPs na lista de IPs confi√°veis **n√£o ter√£o nenhum alerta de Cloudtrail ou VPC flow log** emitido contra eles.

{% hint style="info" %}
As descobertas de DNS est√£o isentas da lista de IPs confi√°veis.
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
Dependendo do n√≠vel de sigilo necess√°rio, o **arquivo pode ser enviado para um bucket s3 na conta alvo ou em uma conta controlada pelo atacante**.
{% endhint %}

#### `guardduty:CreateFilter`

As descobertas rec√©m-criadas do GuardDuty podem ser automaticamente arquivadas por meio de [Regras de Supress√£o](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html). Um advers√°rio poderia **usar** [**filtros**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html) **para arquivar automaticamente as descobertas** que eles provavelmente ir√£o gerar.

Filtros podem ser criados usando a API [CreateFilter](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html).
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

Um advers√°rio poderia desativar o alerta simplesmente [excluindo o destino](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) dos alertas.
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
Excluir este destino de publica√ß√£o **n√£o afetar√° a gera√ß√£o ou visibilidade das descobertas no console do GuardDuty**. O GuardDuty continuar√° a analisar eventos em seu ambiente AWS, identificar comportamentos suspeitos ou inesperados e gerar descobertas.
{% endhint %}

### Bypass de Descobertas Espec√≠ficas

#### Descobertas de Pentest

O GuardDuty do OS detecta solicita√ß√µes de API da AWS de ferramentas comuns de teste de penetra√ß√£o e aciona uma [Descoberta de Pentest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Isso √© detectado pelo **nome do agente do usu√°rio** que √© passado na solicita√ß√£o da API.\
Portanto, **modificando o agente do usu√°rio**, √© poss√≠vel evitar que o GuardDuty detecte o ataque.

Usar OS como Ubuntu, Mac ou Windows evitar√° que esse alerta seja acionado.

Para evitar isso, voc√™ pode procurar pelo script `session.py` no pacote `botocore`. No Kali Linux, ele est√° em `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Por volta da linha [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456), voc√™ deve ver `platform.system()` e `platform.release()`. Substitua esse **c√≥digo por strings de agente do usu√°rio leg√≠timas, como as encontradas em** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

#### Descobertas de Cliente Tor

{% hint style="success" %}
A maneira mais f√°cil de contornar isso √© simplesmente **n√£o usar o Tor para se conectar √† AWS** (por que voc√™ usaria o Tor se deseja permanecer oculto e simular o cen√°rio das credenciais comprometidas?)
{% endhint %}

Se voc√™ fizer uma conex√£o a partir do **Tor**, o **Guarduty** definir√° o alerta [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

O Guarduty detecta isso gra√ßas a uma [lista p√∫blica de n√≥s Tor](https://metrics.torproject.org/exonerator.html).&#x20;

Se voc√™ precisar se conectar por meio do Tor, pode **contornar isso usando** [**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge). Mas obviamente, seria melhor se voc√™ simplesmente n√£o usasse o Tor para se conectar.

Para usar uma bridge, voc√™ pode usar [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) e obter um endere√ßo de bridge em [bridges.torproject.org](https://bridges.torproject.org/options).

A partir daqui, `crie um arquivo torrc` com algo semelhante a:
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
Execute `tor -f torrc` e voc√™ pode se conectar ao proxy socks5 regular na porta 9050.

#### Detec√ß√£o de Exfiltra√ß√£o de Credenciais

Se voc√™ **roubar credenciais EC2** do servi√ßo de metadados e us√°-las **fora da infraestrutura da AWS**, o alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) ser√° acionado.

Al√©m disso, se voc√™ **usar sua pr√≥pria inst√¢ncia EC2** para usar as **credenciais roubadas**, o alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) ser√° acionado.

No entanto, atualmente existe uma forma de contornar isso - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Usar **VPC Endpoints** n√£o acionar√° o alerta do GuardDuty. Isso significa que, como atacante, `se voc√™ roubar credenciais IAM de uma inst√¢ncia EC2, poder√° usar essas credenciais em sua pr√≥pria inst√¢ncia EC2 enquanto roteia o tr√°fego por meio de VPC Endpoints. Isso n√£o acionar√° a detec√ß√£o do GuardDuty`.

A ferramenta [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) foi criada para automatizar esse processo. Este projeto **cria um ambiente para atacar via Terraform**. Ele criar√° uma inst√¢ncia EC2 em uma sub-rede privada sem acesso √† internet e criar√° v√°rios VPC Endpoints para voc√™ usar.

**Outra forma de contornar esse alerta** √© simplesmente usar as credenciais roubadas na mesma m√°quina em que foram roubadas **ou em uma da mesma conta**.

## Refer√™ncias

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
