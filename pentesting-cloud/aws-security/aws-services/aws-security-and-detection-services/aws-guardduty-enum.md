# AWS - GuardDuty 枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## GuardDuty

根据[**文档**](https://aws.amazon.com/guardduty/features/)：GuardDuty结合了**机器学习、异常检测、网络监控和恶意文件发现**，使用AWS和行业领先的第三方资源来帮助保护AWS上的工作负载和数据。GuardDuty能够分析数十亿个事件，跨多个AWS数据源，如AWS CloudTrail事件日志、Amazon Virtual Private Cloud (VPC) 流日志、Amazon Elastic Kubernetes Service (EKS) 审计和系统级日志以及DNS查询日志。

Amazon GuardDuty **识别账户内的异常活动**，分析活动的**安全相关性**，并提供调用的**上下文**。这使得响应者能够确定是否应该花时间进一步调查。

警报**显示在GuardDuty控制台（90天）**和CloudWatch事件中。

{% hint style="warning" %}
当用户**禁用GuardDuty**时，它将停止监控您的AWS环境，并且不会生成任何新的发现，而且**现有的发现将会丢失**。\
如果您只是停止它，现有的发现将保留。
{% endhint %}

### 发现示例

* **侦察**：活动表明攻击者的侦察，如**不寻常的API活动**、可疑的数据库**登录**尝试、VPC内的**端口扫描**、不寻常的登录请求失败模式，或来自已知恶意IP的未被阻止的端口探测。
* **实例妥协**：活动表明实例被妥协，如**加密货币挖矿、后门命令和控制（C&C）**活动、使用域名生成算法（DGA）的恶意软件、出站拒绝服务活动、异常**高网络**流量、不寻常的网络协议、与已知恶意IP通信的出站实例、由外部IP地址使用的临时Amazon EC2凭证，以及使用DNS的数据泄露。
* **账户妥协**：表明账户妥协的常见模式包括来自不寻常地理位置或匿名代理的API调用、尝试禁用AWS CloudTrail日志记录、改变弱化账户密码策略的变更、不寻常的实例或基础设施启动、在不寻常区域的基础设施部署、凭证盗窃、可疑的数据库登录活动，以及来自已知恶意IP地址的API调用。
* **存储桶妥协**：活动表明存储桶被妥协，如可疑的数据访问模式表明凭证滥用、来自远程主机的不寻常Amazon S3 API活动、来自已知恶意IP地址的未授权S3访问，以及从没有访问过该存储桶或从不寻常位置调用的用户检索S3存储桶中数据的API调用。Amazon GuardDuty持续监控和分析AWS CloudTrail S3数据事件（例如GetObject, ListObjects, DeleteObject）以检测您所有Amazon S3存储桶中的可疑活动。

<details>

<summary>发现信息</summary>

发现摘要：

* 发现类型
* 严重性：7-8.9 高，4-6.9 中，01-3.9 低
* 区域
* 账户ID
* 资源ID
* 检测时间
* 使用的威胁列表

正文包含以下信息：

* 受影响的资源
* 行动
* 行为者：IP地址、端口和域名
* 额外信息

</details>

### 所有发现

访问所有GuardDuty发现的列表：[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### 多账户

#### 通过邀请

您可以**邀请其他账户**到不同的AWS GuardDuty账户，以便**每个账户都从同一个GuardDuty监控**。主账户必须邀请成员账户，然后成员账户的代表必须接受邀请。

#### 通过组织

您可以指定组织内的任何账户作为**GuardDuty委派管理员**。只有组织管理账户可以指定委派管理员。

被指定为委派管理员的账户成为GuardDuty管理员账户，在指定的AWS区域自动启用GuardDuty，并且还有**权限为该区域内组织的所有账户启用和管理GuardDuty**。组织中的其他账户可以被查看并添加为与此委派管理员账户关联的GuardDuty成员账户。

## 枚举

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty 绕过

### 基本指南

尽可能多地了解您将要使用的凭证的行为：

* 使用次数
* 地点
* 用户代理/服务（可能来自 awscli、webconsole、lambda...）
* 常用权限

根据这些信息，尽可能重现相同的场景来使用访问权限：

* 如果是**用户或用户访问的角色**，尝试在相同的时间段，从相同的地理位置使用（如果可能的话，甚至是相同的 ISP 和 IP）
* 如果是**服务使用的角色**，在相同的区域创建相同的服务，并在相同的时间范围内使用它
* 始终尝试使用这个主体已经使用过的**相同权限**
* 如果您需要**使用其他权限或滥用权限**（例如，下载 1,000,000 个 cloudtrail 日志文件），请**慢慢地**进行，并且与 AWS 的交互**尽量少**（awscli 有时会在写操作之前调用几个读取 API）

### 修改 GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

拥有这些权限，您可以禁用 GuardDuty 以避免触发警报。
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

攻击者可以创建或更新GuardDuty的[可信IP列表](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_upload-lists.html)，包括**将他们自己的IP添加到列表中**。任何在可信IP列表中的IP将**不会触发任何Cloudtrail或VPC流量日志警报**。

{% hint style="info" %}
DNS发现不受可信IP列表的限制。
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
根据所需的隐蔽性级别，**文件可以上传到目标账户中的s3桶，或者攻击者控制的账户中。**
{% endhint %}

#### `guardduty:CreateFilter`

通过[抑制规则](https://docs.aws.amazon.com/guardduty/latest/ug/findings_suppression-rule.html)，新创建的GuardDuty发现可以被自动归档。攻击者可以**使用**[**过滤器**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_filter-findings.html) **来自动归档他们可能产生的发现**。

过滤器可以使用[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API_CreateFilter.html)创建。
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

敌手可以通过[删除警报的目的地](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)来简单地禁用警报功能。
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
删除此发布目标将**不会影响GuardDuty控制台内发现的生成或可见性**。GuardDuty将继续分析您的AWS环境中的事件，识别可疑或异常行为，并生成发现。
{% endhint %}

### 特定发现绕过

#### 渗透测试发现

OS的GuardDuty能够检测来自常见渗透测试工具的AWS API请求，并触发[渗透测试发现](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux)。\
它是通过API请求中传递的**用户代理名称**来检测的。\
因此，**修改用户代理**可以防止GuardDuty检测到攻击。

使用像Ubuntu、Mac或Windows这样的OS将防止此警报触发。

为了防止这种情况，您可以在`botocore`包中搜索脚本`session.py`。在Kali Linux中，它位于`/usr/local/lib/python3.7/dist-packages/botocore/session.py`。

在[456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)行左右，您应该会看到`platform.system()`和`platform.release()`。将此**代码替换为合法的用户代理字符串，如** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt)中找到的那些。

#### Tor客户端发现

{% hint style="success" %}
绕过这个最简单的方法就是**不使用Tor连接到AWS**（如果您想保持隐身并模拟被泄露凭证的场景，为什么要使用Tor呢？）
{% endhint %}

如果您从**Tor**进行连接，**Guarduty**将设置警报[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**。**

Guarduty通过[公开的Tor节点列表](https://metrics.torproject.org/exonerator.html)来检测这一点。&#x20;

如果您需要通过Tor连接，您可以使用[**桥接**](https://community.torproject.org/relay/types-of-relays/#Bridge)来**绕过这个问题**。但显然，最好是根本不使用Tor连接。

要使用桥接，您可以使用[Obfs4](https://gitlab.com/yawning/obfs4)（`apt install tor obfs4proxy`）并从[bridges.torproject.org](https://bridges.torproject.org/options)获取桥接地址。

从这里开始，`创建一个torrc`文件，内容类似于：
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
执行 `tor -f torrc` 后，你可以连接到9050端口上的常规socks5代理。

#### 凭证泄露检测

如果你**从元数据服务中窃取EC2凭证**并在**AWS基础设施之外**使用它们，将触发警报[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)。

此外，如果你**使用自己的EC2实例**来使用**被盗凭证**，将触发警报[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)。

{% hint style="warning" %}
如果你**入侵**了**同一账户**下的另一台**EC2**机器，你可以在那里使用凭证且**不会产生警报**。
{% endhint %}

然而，目前有一个有效的绕过方法 - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)。使用**VPC Endpoints**将**不会触发GuardDuty警报**。这意味着，作为攻击者，`如果你从EC2实例中窃取IAM凭证，你可以在自己的EC2实例中使用这些凭证，同时通过VPC Endpoints路由流量。这不会触发GuardDuty发现`。

工具[**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints)被创建来自动化这个过程。该项目将通过Terraform**启动一个攻击环境**。它将在一个没有互联网访问的私有子网中创建一个EC2实例，并为你创建多个VPC Endpoints供使用。

**另一种绕过此警报的方法**是在被盗凭证的同一台机器上简单使用，**或者在同一账户下的机器上使用。**

## 参考资料

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果你想在**HackTricks中看到你的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。

</details>
