# AWS - GuardDuty枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## GuardDuty

Amazon GuardDuty是一种基于区域的智能**威胁检测服务**，是AWS提供的首个此类服务，允许用户通过分析VPC流日志、AWS CloudTrail管理事件日志、CloudTrail S3数据事件日志和DNS日志来**监控**其**AWS账户**以寻找**异常和意外行为**。它使用**威胁情报源**，如恶意IP地址和域名列表，以及**机器学习**来识别AWS环境中的**意外和潜在的未经授权和恶意活动**。这可能包括特权升级、使用暴露的凭据或与恶意IP地址或域名的通信等问题。

警报会**在GuardDuty控制台（90天）**和CloudWatch事件中显示。

例如，GuardDuty可以检测到被入侵的**EC2实例提供恶意软件或进行挖矿**。它还监控AWS账户的**访问行为以寻找被入侵的迹象**，例如未经授权的基础设施部署，比如在从未使用过的**区域部署实例**，或者**异常的API调用**，比如更改密码策略以降低密码强度。\
您可以**上传白名单和黑名单IP地址列表**，以便GuardDuty考虑这些信息。

发现摘要：

* 发现类型
* 严重程度：7-8.9高，4-6.9中，01-3.9低
* 区域
* 账户ID
* 资源ID
* 检测时间
* 使用的威胁列表

正文包含以下信息：

* 受影响的资源
* 操作
* 执行者：IP地址、端口和域名
* 附加信息

您可以将其他账户邀请到不同的AWS GuardDuty账户中，以便从同一个GuardDuty监控每个账户。主账户必须邀请成员账户，然后成员账户的代表必须接受邀请。\
有不同的IAM角色权限，允许GuardDuty获取信息并允许用户**上传白名单和黑名单的IP地址**。\
GuardDuty使用名为"AWSServiceRoleForAmazonGuardDuty"的服务关联角色，允许其从受影响的端点检索元数据。

您需要支付日志文件处理费用，每月每1百万个事件的CloudTrail费用以及分析日志的VPC流量的每GB费用。

当用户**禁用GuardDuty**时，它将停止监控您的AWS环境，并且不会生成任何新的发现，**现有的发现将丢失**。\
如果只是停止它，现有的发现将保留。

## 操作

### 枚举
```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
## 避免被检测

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

通过这些权限，您可以禁用GuardDuty以避免触发警报。
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

攻击者可以创建或更新GuardDuty的[受信任IP列表](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)，包括将**自己的IP添加到列表中**。在受信任IP列表中的任何IP都**不会触发任何Cloudtrail或VPC流日志警报**。

{% hint style="info" %}
DNS发现不受受信任IP列表的影响。
{% endhint %}
```
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
根据所需的隐蔽程度，文件可以上传到目标账户的s3存储桶中，或者上传到攻击者控制的账户中。
{% endhint %}

### `guardduty:CreateFilter`

新创建的GuardDuty发现可以通过[抑制规则](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)自动归档。攻击者可以使用[过滤器](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html)来自动归档他们可能生成的发现。

可以使用[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html)来创建过滤器。
```
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
### `guardduty:DeletePublishingDestination`

攻击者可以通过[删除警报的目标](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)来禁用警报。
```
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
### 渗透测试发现

GuardDuty可以检测到常见渗透测试的AWS API请求，并触发[渗透测试发现](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux)。\
它是通过API请求中传递的**用户代理名称**来检测的。\
因此，**修改用户代理**可以防止GuardDuty检测到攻击。

使用Ubuntu、Mac或Windows操作系统可以防止触发此警报。

要防止此问题，您可以在`botocore`包中的`session.py`脚本中进行搜索。在Kali Linux中，它位于`/usr/local/lib/python3.7/dist-packages/botocore/session.py`。

在[456行附近](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)，您应该看到`platform.system()`和`platform.release()`。将此**代码替换为合法的用户代理字符串，例如**[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt)**中的字符串**。

### Tor客户端发现

如果您使用**Tor**进行连接，**GuardDuty**将设置警报[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**。**

GuardDuty通过[公共的Tor节点列表](https://metrics.torproject.org/exonerator.html)来检测此问题。&#x20;

如果您需要通过Tor进行连接，可以使用[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)来**绕过此问题**。但显然最好的解决方法是根本不使用Tor进行连接。

要使用桥接，您可以使用[Obfs4](https://gitlab.com/yawning/obfs4)（`apt install tor obfs4proxy`）并从[bridges.torproject.org](https://bridges.torproject.org/options)获取桥接地址。

从这里，创建一个类似以下内容的torrc文件：
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
有趣的是，使用 `tor -f torrc` 命令可以连接到端口 9050 上的常规 socks5 代理。

### 凭证泄露检测

如果从元数据服务中窃取了 EC2 凭证并在 AWS 基础设施之外使用它们，则会触发警报 [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)。

此外，如果使用自己的 EC2 实例来使用被窃取的凭证，则会触发警报 [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)。

然而，目前存在一种绕过此警报的方法 - [VPC 端点](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)。使用 **VPC 端点** 将不会触发 GuardDuty 警报。这意味着，作为攻击者，`如果你从一个 EC2 实例窃取了 IAM 凭证，你可以在通过 VPC 端点路由流量的同时，使用这些凭证从你自己的 EC2 实例中使用。这不会触发 GuardDuty 发现`。

工具 [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) 旨在自动化此过程。该项目通过 Terraform 在私有子网中创建一个没有互联网访问权限的 EC2 实例，并为您创建多个 VPC 端点供您使用。

**绕过此警报的另一种方法**是在被窃取凭证的同一台机器上使用这些凭证**或者在同一账户中的另一台机器上使用**。

## 参考资料

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您希望在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 格式的 HackTricks，请查看 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧**。

</details>
