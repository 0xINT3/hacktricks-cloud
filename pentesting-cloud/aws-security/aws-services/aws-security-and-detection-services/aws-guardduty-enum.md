# AWS - GuardDuty Enum

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## GuardDuty

[**ドキュメント**](https://aws.amazon.com/guardduty/features/)によると：GuardDutyは**機械学習、異常検知、ネットワーク監視、および悪意のあるファイルの発見**を組み合わせ、AWSおよび業界をリードするサードパーティの情報源を使用して、AWS上のワークロードとデータを保護するのに役立ちます。GuardDutyは、AWS CloudTrailイベントログ、Amazon Virtual Private Cloud (VPC) Flow Logs、Amazon Elastic Kubernetes Service (EKS)監査およびシステムレベルのログ、DNSクエリログなど、複数のAWSデータソースにわたる数十億のイベントを分析する能力があります。

Amazon GuardDutyは、アカウント内の**異常な活動を特定**し、活動の**セキュリティ関連性**を分析し、それが呼び出された**コンテキスト**を提供します。これにより、対応者はさらなる調査に時間を費やすべきかどうかを判断できます。

アラートは**GuardDutyコンソール（90日間）**とCloudWatchイベントに表示されます。

{% hint style="warning" %}
ユーザーが**GuardDutyを無効にする**と、AWS環境の監視が停止し、新しい発見は一切生成されず、**既存の発見は失われます**。\
単に停止した場合は、既存の発見は残ります。
{% endhint %}

### 発見の例

* **偵察**: 攻撃者による偵察を示唆する活動、例えば**異常なAPI活動**、怪しいデータベースの**ログイン**試行、VPC内の**ポートスキャン**、通常とは異なるログインリクエストの失敗パターン、または既知の悪意のあるIPからのブロックされていないポートプロービング。
* **インスタンスの侵害**: インスタンスの侵害を示す活動、例えば**暗号通貨のマイニング、バックドアのコマンドアンドコントロール(C&C)** 活動、ドメイン生成アルゴリズム(DGA)を使用するマルウェア、外部からのサービス拒否活動、通常とは異なる**高いネットワーク**トラフィック量、異常なネットワークプロトコル、既知の悪意のあるIPとの外部インスタンス通信、外部IPアドレスによる一時的なAmazon EC2クレデンシャルの使用、DNSを使用したデータ漏洩。
* **アカウントの侵害**: アカウント侵害を示す一般的なパターンには、通常とは異なる地理的位置からのAPIコールや匿名化プロキシ、AWS CloudTrailログの無効化の試み、アカウントのパスワードポリシーを弱める変更、通常とは異なるインスタンスやインフラの起動、通常とは異なる地域でのインフラのデプロイ、クレデンシャルの盗難、怪しいデータベースログイン活動、既知の悪意のあるIPアドレスからのAPIコールが含まれます。
* **バケットの侵害**: バケットの侵害を示す活動、例えばクレデンシャルの不正使用を示唆する怪しいデータアクセスパターン、リモートホストからの異常なAmazon S3 API活動、既知の悪意のあるIPアドレスからの許可されていないS3アクセス、および通常の場所からのバケットへのデータ取得を試みるAPIコール。Amazon GuardDutyは、すべてのAmazon S3バケットにわたる怪しい活動を検出するために、AWS CloudTrail S3データイベント（例：GetObject、ListObjects、DeleteObject）を継続的に監視および分析します。

<details>

<summary>発見情報</summary>

発見の概要:

* 発見のタイプ
* 重大度: 7-8.9 高、4-6.9 中、01-3.9 低
* リージョン
* アカウントID
* リソースID
* 検出時刻
* 使用された脅威リスト

本文には以下の情報が含まれます:

* 影響を受けるリソース
* 行動
* アクター: IPアドレス、ポート、ドメイン
* 追加情報

</details>

### すべての発見

すべてのGuardDuty発見のリストにアクセスするには: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### 複数アカウント

#### 招待による

他のアカウントを異なるAWS GuardDutyアカウントに**招待**することができ、**すべてのアカウントが同じGuardDutyから監視されます**。マスターアカウントはメンバーアカウントに招待を送り、その後メンバーアカウントの代表者が招待を受け入れる必要があります。

#### 組織を通じて

組織内の任意のアカウントを**GuardDuty委任管理者**に指定することができます。委任管理者を指定できるのは組織管理アカウントのみです。

委任管理者として指定されたアカウントはGuardDuty管理アカウントになり、指定されたAWSリージョンで自動的にGuardDutyが有効になり、そのリージョン内の組織のすべてのアカウントに対してGuardDutyを有効にして管理する**権限を持ちます**。他の組織アカウントは、この委任管理者アカウントに関連付けられたGuardDutyメンバーアカウントとして表示および追加することができます。

## 列挙

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty バイパス

### 一般的なガイダンス

使用する予定の認証情報の動作についてできるだけ多くの情報を収集してください：

* 利用される時間
* 場所
* ユーザーエージェント / サービス（awscli、webconsole、lambdaなどから使用される可能性があります）
* 通常使用される権限

この情報をもとに、アクセスを使用する際にできるだけ同じシナリオを再現してください：

* **ユーザーまたはユーザーによってアクセスされるロール**の場合、同じ時間帯に、同じ地理的位置から（可能であれば同じISPおよびIPから）使用してみてください
* **サービスによって使用されるロール**の場合、同じリージョンで同じサービスを作成し、そこから同じ時間帯に使用してください
* 常に、このプリンシパルが使用していた**同じ権限**を使用しようとしてください
* **他の権限を使用する必要がある場合や権限を乱用する必要がある場合**（例えば、1,000,000のcloudtrailログファイルをダウンロードするなど）、**ゆっくりと**、AWSとのやり取りを**最小限に抑えて**行ってください（awscliは書き込み前にいくつかの読み取りAPIを呼び出すことがあります）

### GuardDuty の破壊

#### `guardduty:UpdateDetector`

この権限を持っていると、アラートを引き起こさないようにGuardDutyを無効にすることができます。

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

この権限を持つ攻撃者は、**自動で**検出結果のアーカイブにフィルターを**使用する**能力があります：

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

前述の権限を持つ攻撃者は、自分のIPアドレスを[**信頼できるIPリスト**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)に追加することで、GuardDutyのリストを変更し、アラートの生成を回避することができます。

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
#### `guardduty:DeletePublishingDestination`

攻撃者はアラートを防ぐために、宛先を削除する可能性があります：

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
この公開先を削除しても、GuardDutyコンソール内の検出結果の生成や可視性には**影響しません**。GuardDutyはAWS環境のイベントを引き続き分析し、不審または予期しない動作を特定し、検出結果を生成します。
{% endhint %}

### 特定の検出結果バイパス例

GuardDutyの検出結果は数十種類ありますが、**レッドチームのメンバーとしてすべてに影響されるわけではありません**。さらに良いことに、それぞれの完全なドキュメントが[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)にあるので、捕まらないように行動する前に確認してください。

ここには、特定のGuardDuty検出結果のバイパス例をいくつか紹介します：

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDutyは一般的なペネトレーションテストツールからのAWS APIリクエストを検出し、[PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux)をトリガーします。\
これはAPIリクエストで渡される**ユーザーエージェント名**によって検出されます。\
したがって、**ユーザーエージェントを変更する**ことで、攻撃の検出を防ぐことができます。

これを防ぐためには、`botocore`パッケージの`session.py`スクリプトを探してユーザーエージェントを変更するか、AWS CLIのプロキシとしてBurp Suiteを設定してMitMでユーザーエージェントを変更するか、またはUbuntu、Mac、WindowsのようなOSを使用することで、このアラートのトリガーを防ぐことができます。

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

メタデータサービスからEC2クレデンシャルを抽出し、AWS環境**外部で使用する**と、[**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)アラートが発生します。逆に、これらのクレデンシャルをEC2インスタンスから使用すると、[**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)アラートがトリガーされます。しかし、**同じアカウント内の別の侵害されたEC2インスタンスでクレデンシャルを使用すると検出されず**、アラートは発生しません。

{% hint style="success" %}
したがって、このアラートをトリガーしないためには、**見つけたマシン内部から抽出したクレデンシャルを使用してください**。
{% endhint %}

## 参考文献

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTコレクション**](https://opensea.io/collection/the-peass-family)です。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* **あなたのハッキングのコツを、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出することで共有してください。

</details>
