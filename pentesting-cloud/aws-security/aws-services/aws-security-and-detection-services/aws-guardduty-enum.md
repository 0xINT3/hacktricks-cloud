# AWS - GuardDuty Enum

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## GuardDuty

[**ドキュメント**](https://aws.amazon.com/guardduty/features/)によると：GuardDutyは**機械学習、異常検知、ネットワーク監視、および悪意のあるファイルの発見**を組み合わせ、AWSおよび業界をリードするサードパーティの情報源を使用して、AWS上のワークロードとデータを保護するのに役立ちます。GuardDutyは、AWS CloudTrailイベントログ、Amazon Virtual Private Cloud (VPC) Flow Logs、Amazon Elastic Kubernetes Service (EKS)監査およびシステムレベルのログ、DNSクエリログなど、複数のAWSデータソースにわたる数十億のイベントを分析する能力があります。

Amazon GuardDutyは、アカウント内の**異常な活動を特定**し、活動の**セキュリティの関連性**を分析し、それが呼び出された**コンテキスト**を提供します。これにより、対応者はさらなる調査に時間を費やすべきかどうかを判断できます。

アラートは**GuardDutyコンソール（90日間）**とCloudWatchイベントに**表示されます**。

{% hint style="warning" %}
ユーザーが**GuardDutyを無効にする**と、AWS環境の監視が停止し、新しい発見は一切生成されず、**既存の発見は失われます**。\
単に停止した場合は、既存の発見は残ります。
{% endhint %}

### 発見の例

* **偵察**: 攻撃者による偵察を示唆する活動。例えば、**異常なAPI活動**、怪しいデータベースの**ログイン**試行、VPC内の**ポートスキャン**、通常とは異なるログインリクエストの失敗パターン、または既知の悪意のあるIPからのブロックされていないポートプロービング。
* **インスタンスの侵害**: インスタンスの侵害を示す活動。例えば、**暗号通貨のマイニング、バックドアのコマンドアンドコントロール（C&C）**活動、ドメイン生成アルゴリズム（DGA）を使用するマルウェア、外部からのサービス拒否活動、通常よりも**高いネットワーク**トラフィック量、通常とは異なるネットワークプロトコル、既知の悪意のあるIPとの外部インスタンス通信、外部IPアドレスによって使用された一時的なAmazon EC2クレデンシャル、DNSを使用したデータの流出。
* **アカウントの侵害**: アカウントの侵害を示す一般的なパターンには、通常とは異なる地理的位置からのAPIコールや匿名化プロキシ、AWS CloudTrailログの無効化の試み、アカウントのパスワードポリシーを弱める変更、通常とは異なるインスタンスやインフラの起動、通常とは異なる地域でのインフラの展開、クレデンシャルの盗難、怪しいデータベースログイン活動、既知の悪意のあるIPアドレスからのAPIコールが含まれます。
* **バケットの侵害**: バケットの侵害を示す活動。例えば、クレデンシャルの誤用を示す怪しいデータアクセスパターン、リモートホストからの異常なAmazon S3 API活動、既知の悪意のあるIPアドレスからの許可されていないS3アクセス、および通常の場所からのバケットへのデータの取得を試みるAPIコール。Amazon GuardDutyは、Amazon S3バケット内の怪しい活動を検出するために、AWS CloudTrail S3データイベント（例：GetObject、ListObjects、DeleteObject）を継続的に監視および分析します。

<details>

<summary>発見情報</summary>

発見の概要:

* 発見のタイプ
* 重大度: 7-8.9 高、4-6.9 中、01-3.9 低
* リージョン
* アカウントID
* リソースID
* 検出時刻
* 使用された脅威リスト

本文には以下の情報が含まれています:

* 影響を受けるリソース
* 行動
* アクター: IPアドレス、ポート、ドメイン
* 追加情報

</details>

### 全ての発見

すべてのGuardDuty発見のリストにアクセス: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### 複数アカウント

#### 招待による

他のアカウントを異なるAWS GuardDutyアカウントに**招待**することができ、**すべてのアカウントが同じGuardDutyから監視されます**。マスターアカウントはメンバーアカウントに招待を送り、その後メンバーアカウントの代表者が招待を受け入れる必要があります。

#### 組織を通じて

組織内の任意のアカウントを**GuardDuty委任管理者**に指定することができます。委任管理者を指定できるのは組織管理アカウントのみです。

委任管理者として指定されたアカウントはGuardDuty管理アカウントになり、指定されたAWSリージョンで自動的にGuardDutyが有効になり、そのリージョン内の組織のすべてのアカウントに対してGuardDutyを有効にして管理する**権限を持ちます**。他の組織アカウントは、この委任管理者アカウントに関連付けられたGuardDutyメンバーアカウントとして表示および追加することができます。

## 列挙

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty バイパス

### 一般的なガイダンス

使用する予定の認証情報の動作についてできるだけ多くの情報を収集してください：

* 使用される時間
* 場所
* ユーザーエージェント / サービス（awscli、webconsole、lambdaなどから使用される可能性があります）
* 通常使用される権限

この情報をもとに、アクセスを使用する際にできるだけ同じシナリオを再現してください：

* **ユーザーまたはユーザーによってアクセスされるロール**の場合、同じ時間帯に、同じ地理的位置から（可能であれば同じISPおよびIPから）使用してみてください
* **サービスによって使用されるロール**の場合、同じリージョンで同じサービスを作成し、そこから同じ時間帯に使用してください
* 常に、このプリンシパルが使用していた**同じ権限**を使用しようとしてください
* **他の権限を使用する必要がある場合や権限を乱用する必要がある場合**（例えば、1,000,000のcloudtrailログファイルをダウンロードする場合）、**ゆっくりと**、AWSとのやり取りを**最小限に抑えて**行ってください（awscliは書き込み前にいくつかの読み取りAPIを呼び出すことがあります）

### GuardDuty の変更

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

これらの権限を持っていれば、アラートを引き起こさないようにGuardDutyを無効にすることができます。
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

攻撃者はGuardDutyの[信頼できるIPリスト](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)を作成または更新し、**自分のIPをリストに含める**ことができます。信頼できるIPリストにあるIPに対しては、**CloudtrailやVPCフローログのアラートが発生しません**。

{% hint style="info" %}
DNSの検出結果は信頼できるIPリストの対象外です。
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
ステルス性のレベルに応じて、**ファイルはターゲットアカウントのs3バケットにアップロードされるか、攻撃者が管理するアカウントにアップロードされます。**
{% endhint %}

#### `guardduty:CreateFilter`

新しく作成されたGuardDutyの検出結果は、[抑制ルール](https://docs.aws.amazon.com/guardduty/latest/ug/findings_suppression-rule.html)を通じて自動的にアーカイブされることがあります。攻撃者は、自分が生成する可能性のある検出結果を**自動的にアーカイブするために**[**フィルター**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_filter-findings.html)を**使用する**ことができます。

フィルターは[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API_CreateFilter.html)を使用して作成できます。
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

敵対者は、[アラートの送信先を削除する](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)ことで、アラートを簡単に無効にすることができます。
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
この公開先を削除しても、**GuardDutyコンソール内の検出結果の生成や可視性には影響しません**。GuardDutyはAWS環境のイベントを引き続き分析し、不審または予期しない動作を特定し、検出結果を生成します。
{% endhint %}

### 特定の検出結果のバイパス

#### ペネトレーションテストの検出結果

OSのGuardDutyは、一般的なペネトレーションテストツールからのAWS APIリクエストを検出し、[PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux)をトリガーします。\
これはAPIリクエストで渡される**ユーザーエージェント名**によって検出されます。\
したがって、**ユーザーエージェントを変更する**ことで、GuardDutyが攻撃を検出するのを防ぐことができます。

Ubuntu、Mac、WindowsのようなOSを使用すると、このアラートがトリガーされるのを防ぐことができます。

これを防ぐためには、`botocore`パッケージのスクリプト`session.py`を探すことができます。Kali Linuxでは`/usr/local/lib/python3.7/dist-packages/botocore/session.py`にあります。

[456行目](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)付近で`platform.system()`と`platform.release()`を見ることができるはずです。この**コードを、**[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt)で見つかるような正当なユーザーエージェント文字列に置き換えてください。

#### Torクライアントの検出結果

{% hint style="success" %}
これをバイパスする最も簡単な方法は、**AWSに接続するためにTorを使用しないことです**（なぜステルスを保ち、侵害された資格情報のシナリオをシミュレートしたい場合にTorを使用するのでしょうか？）
{% endhint %}

**Tor**から接続すると、**Guarduty**はアラート[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)を設定します。

Guardutyは、[Torノードの公開リスト](https://metrics.torproject.org/exonerator.html)を使ってこれを検出します。

Torを介して接続する必要がある場合は、[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)を使用してこれをバイパスできます。しかし、当然ながら、そもそもTorを使用せずに接続する方が良いでしょう。

ブリッジを使用するには、[Obfs4](https://gitlab.com/yawning/obfs4)（`apt install tor obfs4proxy`）を使用し、[bridges.torproject.org](https://bridges.torproject.org/options)からブリッジアドレスを取得します。

ここから、次のような内容で`torrc`ファイルを作成します：
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
`tor -f torrc` を実行すると、ポート9050で通常のsocks5プロキシに接続できます。

#### クレデンシャル流出検出

**EC2のクレデンシャルをメタデータサービスから盗み**、それを **AWSインフラストラクチャの外部で使用する** 場合、アラート [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) がトリガーされます。

さらに、**自分のEC2インスタンスを使用して**、**盗まれたクレデンシャルを使用する** 場合、アラート [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) がトリガーされます。

{% hint style="warning" %}
**同じアカウントの別のEC2** マシンを **侵害した** 場合、そこでクレデンシャルを使用しても **アラートは生成されません**。
{% endhint %}

しかし、これを回避する機能的な方法があります - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)。**VPC Endpoints** を使用すると、**GuardDutyアラートはトリガーされません**。つまり、攻撃者として、`EC2インスタンスからIAMクレデンシャルを盗んだ場合、VPC Endpointsを介してトラフィックをルーティングしながら、自分のEC2インスタンスからそれらのクレデンシャルを使用することができます。これはGuardDutyの検出をトリガーしません`。

このプロセスを自動化するために、ツール [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) が作成されました。このプロジェクトは **Terraformを介して攻撃環境を立ち上げます**。インターネットアクセスのないプライベートサブネットにEC2インスタンスを作成し、使用するための多数のVPC Endpointsを作成します。

**このアラートを回避する別の方法** は、盗まれたクレデンシャルを盗まれたのと同じマシンで使用するか、**同じアカウントの別のマシンで使用することです。**

## 参考文献

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksに広告を掲載したい**、または **HackTricksをPDFでダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や [**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
