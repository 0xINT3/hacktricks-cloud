# AWS - GuardDuty Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GuardDuty

Según la [**documentación**](https://aws.amazon.com/guardduty/features/): GuardDuty combina **aprendizaje automático, detección de anomalías, monitoreo de red y descubrimiento de archivos maliciosos**, utilizando tanto fuentes líderes de la industria como de AWS para ayudar a proteger cargas de trabajo y datos en AWS. GuardDuty es capaz de analizar decenas de miles de millones de eventos a través de múltiples fuentes de datos de AWS, como registros de eventos de AWS CloudTrail, registros de flujo de Amazon Virtual Private Cloud (VPC), registros de auditoría y de sistema de Amazon Elastic Kubernetes Service (EKS) y registros de consultas DNS.

Amazon GuardDuty **identifica actividad inusual dentro de tus cuentas**, analiza la **relevancia de seguridad** de la actividad y proporciona el **contexto** en el que se invocó. Esto permite a un respondedor determinar si debe invertir tiempo en una investigación más profunda.

Las alertas **aparecen en la consola de GuardDuty (90 días)** y en los Eventos de CloudWatch.

{% hint style="warning" %}
Cuando un usuario **desactiva GuardDuty**, dejará de monitorear tu entorno de AWS y no generará nuevos hallazgos en absoluto, y los **hallazgos existentes se perderán**.\
Si solo lo detienes, los hallazgos existentes permanecerán.
{% endhint %}

### Ejemplo de Hallazgos

* **Reconocimiento**: Actividad que sugiere reconocimiento por parte de un atacante, como **actividad inusual de API**, intentos sospechosos de **inicio de sesión** en bases de datos, **escaneo de puertos** dentro de VPC, patrones inusuales de solicitudes de inicio de sesión fallidas o sondeo de puertos no bloqueados desde una IP conocida por ser mala.
* **Compromiso de instancia**: Actividad que indica un compromiso de instancia, como **minería de criptomonedas, comando y control (C\&C) de puerta trasera**, actividad de malware utilizando algoritmos de generación de dominios (DGA), actividad de denegación de servicio saliente, volumen de tráfico de red **inusualmente alto**, protocolos de red inusuales, comunicación saliente de una instancia con una IP maliciosa conocida, uso de credenciales temporales de Amazon EC2 por una dirección IP externa y exfiltración de datos utilizando DNS.
* **Compromiso de cuenta**: Patrones comunes que indican un compromiso de cuenta incluyen llamadas a API desde una geolocalización inusual o un proxy anonimizador, intentos de desactivar el registro de AWS CloudTrail, cambios que debilitan la política de contraseñas de la cuenta, lanzamientos inusuales de instancias o infraestructura, despliegues de infraestructura en una región inusual, robo de credenciales, actividad sospechosa de inicio de sesión en bases de datos y llamadas a API desde direcciones IP maliciosas conocidas.
* **Compromiso de bucket**: Actividad que indica un compromiso de bucket, como patrones de acceso a datos sospechosos que indican mal uso de credenciales, actividad inusual de API de Amazon S3 desde un host remoto, acceso no autorizado a S3 desde direcciones IP maliciosas conocidas y llamadas a API para recuperar datos en buckets de S3 por un usuario sin historial previo de acceso al bucket o invocado desde una ubicación inusual. Amazon GuardDuty monitorea y analiza continuamente los eventos de datos de S3 de AWS CloudTrail (por ejemplo, GetObject, ListObjects, DeleteObject) para detectar actividad sospechosa en todos tus buckets de Amazon S3.

<details>

<summary>Información de Hallazgos</summary>

Resumen de hallazgos:

* Tipo de hallazgo
* Severidad: 7-8.9 Alta, 4-6.9 Media, 0.1-3.9 Baja
* Región
* ID de cuenta
* ID de recurso
* Tiempo de detección
* Qué lista de amenazas se utilizó

El cuerpo tiene esta información:

* Recurso afectado
* Acción
* Actor: dirección IP, puerto y dominio
* Información adicional

</details>

### Todos los Hallazgos

Accede a una lista de todos los hallazgos de GuardDuty en: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Cuentas Múltiples

#### Por Invitación

Puedes **invitar otras cuentas** a una cuenta de AWS GuardDuty diferente para que **cada cuenta sea monitoreada desde el mismo GuardDuty**. La cuenta principal debe invitar a las cuentas miembro y luego el representante de la cuenta miembro debe aceptar la invitación.

#### A través de la Organización

Puedes designar cualquier cuenta dentro de la organización para ser el **administrador delegado de GuardDuty**. Solo la cuenta de gestión de la organización puede designar un administrador delegado.

Una cuenta que se designa como administrador delegado se convierte en una cuenta administradora de GuardDuty, tiene GuardDuty habilitado automáticamente en la región designada y también tiene el **permiso para habilitar y gestionar GuardDuty para todas las cuentas de la organización dentro de esa región**. Las otras cuentas de la organización pueden ser vistas y añadidas como cuentas miembro de GuardDuty asociadas con esta cuenta administradora delegada.

## Enumeración

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Evasión de GuardDuty

### Orientación General

Intenta averiguar tanto como sea posible sobre el comportamiento de las credenciales que vas a utilizar:

* Horarios de uso
* Ubicaciones
* Agentes de Usuario / Servicios (Podría ser utilizado desde awscli, webconsole, lambda...)
* Permisos utilizados regularmente

Con esta información, recrea tanto como sea posible el mismo escenario para utilizar el acceso:

* Si es un **usuario o un rol accedido por un usuario**, intenta usarlo en las mismas horas, desde la misma geolocalización (incluso el mismo ISP y IP si es posible)
* Si es un **rol utilizado por un servicio**, crea el mismo servicio en la misma región y úsalo desde allí en los mismos rangos de tiempo
* Intenta siempre usar los **mismos permisos** que este principal ha utilizado
* Si necesitas **usar otros permisos o abusar de un permiso** (por ejemplo, descargar 1.000.000 de archivos de registro de cloudtrail) hazlo **lentamente** y con la **mínima cantidad de interacciones** con AWS (awscli a veces llama a varias APIs de lectura antes de la de escritura)

### Modificar GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Con esos permisos podrías desactivar GuardDuty para evitar desencadenar alertas.
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Un atacante podría crear o actualizar la [lista de IP confiables](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) de GuardDuty, incluyendo **su propia IP en la lista**. Cualquier IP en una lista de IP confiables **no generará alertas de Cloudtrail o registros de flujo de VPC** contra ellas.

{% hint style="info" %}
Los hallazgos de DNS están exentos de la lista de IP confiables.
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
Dependiendo del nivel de sigilo requerido, **el archivo puede ser subido a un bucket s3 en la cuenta objetivo, o una cuenta controlada por el atacante.**
{% endhint %}

#### `guardduty:CreateFilter`

Los hallazgos de GuardDuty recién creados pueden ser archivados automáticamente a través de [Reglas de Supresión](https://docs.aws.amazon.com/guardduty/latest/ug/findings_suppression-rule.html). Un adversario podría **usar** [**filtros**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_filter-findings.html) **para archivar automáticamente hallazgos** que probablemente generen.

Los filtros pueden ser creados utilizando la [API CreateFilter](https://docs.aws.amazon.com/guardduty/latest/APIReference/API_CreateFilter.html).
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

Un adversario podría desactivar las alertas simplemente [eliminando el destino](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) de las mismas.
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
Eliminar este destino de publicación **no afectará la generación o visibilidad de hallazgos dentro de la consola de GuardDuty**. GuardDuty continuará analizando eventos en su entorno de AWS, identificando comportamientos sospechosos o inesperados y generando hallazgos.
{% endhint %}

### Omisión de Hallazgos Específicos

#### Hallazgos de Pentest

GuardDuty de OS detecta solicitudes de API de AWS provenientes de herramientas comunes de pentesting y desencadena un [Hallazgo de Pentest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#pentest-iam-kalilinux).\
Se detecta por el **nombre del agente de usuario** que se pasa en la solicitud de la API.\
Por lo tanto, **modificar el agente de usuario** es posible para prevenir que GuardDuty detecte el ataque.

Usar OS como Ubuntu, Mac o Windows evitará que se active esta alerta.

Para prevenir esto puedes buscar el script `session.py` en el paquete `botocore`. En Kali Linux está en `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Alrededor de la línea [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456) deberías ver `platform.system()` y `platform.release()`. Reemplaza este **código con cadenas de agente de usuario legítimas como las que se encuentran en** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user_agents.txt).

#### Hallazgos de Cliente Tor

{% hint style="success" %}
La forma más fácil de evitar esto es simplemente **no usar Tor para conectarse a AWS** (¿por qué usarías Tor si quieres permanecer oculto y simular el escenario de credenciales comprometidas?)
{% endhint %}

Si haces una conexión desde **Tor**, **Guarduty** establecerá la alerta [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

Guarduty detecta esto gracias a una [lista pública de nodos Tor](https://metrics.torproject.org/exonerator.html).&#x20;

Si necesitas conectarte a través de Tor puedes **evitar esto usando** [**Puentes**](https://community.torproject.org/relay/types-of-relays/#Bridge). Pero obviamente sería mejor si simplemente no usas Tor para conectarte.

Para usar un puente puedes usar [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) y obtener una dirección de puente de [bridges.torproject.org](https://bridges.torproject.org/options).

Desde aquí, `crea un archivo torrc` con algo similar a:
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
Ejecuta `tor -f torrc` y podrás conectarte al proxy socks5 regular en el puerto 9050.

#### Detección de Exfiltración de Credenciales

Si **robas credenciales de EC2** del servicio de metadatos y las usas **fuera de la infraestructura de AWS**, se activará la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws).

Además, si **usas tu propia instancia de EC2** para utilizar las **credenciales robadas**, se activará la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws).

{% hint style="warning" %}
Si has **comprometido** otra máquina **EC2** de la **misma cuenta**, podrías usar las credenciales allí y **no se generará ninguna alerta**.
{% endhint %}

Sin embargo, actualmente existe un método de evasión funcional para esto: [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Usar **VPC Endpoints** **no activará la alerta de GuardDuty**. Esto significa que, como atacante, `si robas credenciales IAM de una instancia de EC2, puedes usar esas credenciales desde tu propia instancia de EC2 mientras diriges el tráfico a través de VPC Endpoints. Esto no activará el hallazgo de GuardDuty`.

La herramienta [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) fue creada para automatizar este proceso. Este proyecto **inicia un entorno para atacar a través de Terraform**. Creará una instancia de EC2 en una subred privada sin acceso a internet y creará varios VPC Endpoints para que los uses.

**Otra forma de eludir esta alerta** es simplemente usar credenciales robadas en la misma máquina de donde fueron robadas **o en una de la misma cuenta**.

## Referencias

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Aprende hacking de AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
