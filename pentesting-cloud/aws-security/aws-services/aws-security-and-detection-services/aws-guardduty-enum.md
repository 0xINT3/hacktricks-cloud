# AWS - Enumeración de GuardDuty

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## GuardDuty

Amazon GuardDuty es un servicio de detección de amenazas inteligente basado en regiones, el primero de su tipo ofrecido por AWS, que permite a los usuarios **monitorear** su **cuenta de AWS** en busca de **comportamientos inusuales e inesperados analizando los registros de flujo de VPC, los registros de eventos de administración de AWS CloudTrail, los registros de eventos de datos de S3 de CloudTrail y los registros de DNS**. Utiliza **fuentes de inteligencia de amenazas**, como listas de direcciones IP y dominios maliciosos, y **aprendizaje automático** para identificar **actividades inesperadas y potencialmente no autorizadas y maliciosas** dentro de su entorno de AWS. Esto puede incluir problemas como escalaciones de privilegios, uso de credenciales expuestas o comunicación con direcciones IP o dominios maliciosos.

Las alertas **aparecen en la consola de GuardDuty (90 días)** y en los eventos de CloudWatch.

Por ejemplo, GuardDuty puede detectar instancias de **EC2 comprometidas que sirven malware o realizan minería** de bitcoin. También monitorea el **comportamiento de acceso a la cuenta de AWS en busca de signos de compromiso**, como implementaciones de infraestructura no autorizadas, como instancias implementadas en una **región que nunca se ha utilizado**, o **llamadas API inusuales**, como un cambio de política de contraseña para reducir la fuerza de la contraseña.\
Puede **cargar una lista de direcciones IP permitidas y denegadas** para que GuardDuty tenga en cuenta esa información.

Resumen de los hallazgos:

* Tipo de hallazgo
* Gravedad: 7-8.9Alta, 4-6.9Media, 01-3.9Baja
* Región
* ID de cuenta
* ID de recurso
* Hora de detección
* Qué lista de amenazas se utilizó

El cuerpo tiene esta información:

* Recurso afectado
* Acción
* Actor: dirección IP, puerto y dominio
* Información adicional

Puede **invitar a otras cuentas** a una cuenta de AWS GuardDuty diferente para que **cada cuenta sea monitoreada desde el mismo GuardDuty**. La cuenta principal debe invitar a las cuentas de miembros y luego el representante de la cuenta de miembro debe aceptar la invitación.\
Existen diferentes permisos de rol de IAM para permitir que GuardDuty obtenga la información y para permitir que un usuario **cargue direcciones IP permitidas y denegadas**.\
GuarDuty utiliza un rol vinculado al servicio llamado "AWSServiceRoleForAmazonGuardDuty" que le permite recuperar metadatos de los puntos finales afectados.

Paga por el procesamiento de tus archivos de registro, por cada millón de eventos por mes de CloudTrail y por GB de registros analizados de VPC Flow.

Cuando un usuario **deshabilita GuardDuty**, dejará de monitorear su entorno de AWS y no generará nuevos hallazgos en absoluto, y los **hallazgos existentes se perderán**.\
Si simplemente lo detiene, los hallazgos existentes permanecerán.

## Acciones

### Enumeración

```bash
aws guardduty list-organization-admin-accounts
aws guardduty list-invitations
aws guardduty get-invitations-count
aws guardduty list-detectors
aws guardduty describe-organization-configuration --detector-id <id>
aws guardduty get-detector --detector-id <id>
aws guardduty list-filters --detector-id <id>
aws guardduty get-filter --detector-id <id> --filter-name
aws guardduty list-findings --detector-id <id>
aws guardduty get-findings --detector-id <id> --finding-ids <id>
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>
aws guardduty list-ip-sets --detector-id <id>
aws guardduty list-members --detector-id <id>
aws guardduty list-publishing-destinations --detector-id <id>
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty list-ip-sets
aws guardduty get-ip-set --detector-id <id>
aws guardduty get-master-account --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```

## Evitar la detección

### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Con esos permisos, podría deshabilitar GuardDuty para evitar activar alertas.

```bash
# Deshabilitar el detector
aws guardduty update-detector \
    --detector-id <detector-id> \
    --no-enable 

# Eliminar s3 como fuente de registro
aws guardduty update-detector \
    --detector-id <detector-id> \
    --data-sources S3Logs={Enable=false}

# Aumentar el tiempo de actualización de hallazgos a 6 horas
aws guardduty update-detector \
    --detector-id <detector-id> \
    --finding-publishing-frequency SIX_HOURS
```

### `guardduty:ListDetectors`, `guardduty:
### Detección de Exfiltración de Credenciales

Si se **roban credenciales de EC2** del servicio de metadatos y se usan **fuera de la infraestructura de AWS**, se activa la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws).

Además, si se **utiliza una instancia EC2 propia** para usar las **credenciales robadas**, se activa la alerta [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws).

Sin embargo, actualmente hay un bypass funcional para esto - [Puntos de conexión de VPC](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). El uso de **Puntos de conexión de VPC** no activará la alerta de GuardDuty. Lo que significa que, como atacante, `si se roban credenciales IAM de una instancia EC2, se pueden usar esas credenciales desde su propia instancia EC2 mientras se enruta el tráfico a través de Puntos de conexión de VPC. Esto no activará la alerta de GuardDuty`.

La herramienta [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) fue creada para automatizar este proceso. Este proyecto **crea un entorno para atacar a través de Terraform**. Creará una instancia EC2 en una subred privada sin acceso a Internet y creará varios puntos de conexión de VPC para que los use.

**Otra forma de evitar esta alerta** es simplemente usar las credenciales robadas en la misma máquina donde se robaron **o en una de la misma cuenta.**

## Referencias

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>