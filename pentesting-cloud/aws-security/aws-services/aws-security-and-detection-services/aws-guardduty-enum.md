# AWS - GuardDuty Enum

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GuardDuty

According to the [**docs**](https://aws.amazon.com/guardduty/features/): GuardDuty combines **machine learning, anomaly detection, network monitoring, and malicious file discovery**, using both AWS and industry-leading third-party sources to help protect workloads and data on AWS. GuardDuty is capable of analyzing tens of billions of events across multiple AWS data sources, such as AWS CloudTrail event logs, Amazon Virtual Private Cloud (VPC) Flow Logs, Amazon Elastic Kubernetes Service (EKS) audit and system-level logs, and DNS query logs.

Amazon GuardDuty **identifies unusual activity within your accounts**, analyzes the **security relevanc**e of the activity, and gives the **context** in which it was invoked. This allows a responder to determine if they should spend time on further investigation.

Alerts **appear in the GuardDuty console (90 days)** and CloudWatch Events.

{% hint style="warning" %}
When a user **disable GuardDuty**, it will stop monitoring your AWS environment and it won't generate any new findings at all, and the **existing findings will be lost**.\
If you just stop it, the existing findings will remain.
{% endhint %}

### Findings Example

* **Reconnaissance**: Activity suggesting reconnaissance by an attacker, such as **unusual API activity**, suspicious database **login** attempts, intra-VPC **port scanning**, unusual failed login request patterns, or unblocked port probing from a known bad IP.
* **Instance compromise**: Activity indicating an instance compromise, such as **cryptocurrency mining, backdoor command and control (C\&C)** activity, malware using domain generation algorithms (DGA), outbound denial of service activity, unusually **high network** traffic volume, unusual network protocols, outbound instance communication with a known malicious IP, temporary Amazon EC2 credentials used by an external IP address, and data exfiltration using DNS.
* **Account compromise**: Common patterns indicative of account compromise include API calls from an unusual geolocation or anonymizing proxy, attempts to disable AWS CloudTrail logging, changes that weaken the account password policy, unusual instance or infrastructure launches, infrastructure deployments in an unusual region, credential theft, suspicious database login activity, and API calls from known malicious IP addresses.
* **Bucket compromise**: Activity indicating a bucket compromise, such as suspicious data access patterns indicating credential misuse, unusual Amazon S3 API activity from a remote host, unauthorized S3 access from known malicious IP addresses, and API calls to retrieve data in S3 buckets from a user with no prior history of accessing the bucket or invoked from an unusual location. Amazon GuardDuty continuously monitors and analyzes AWS CloudTrail S3 data events (e.g. GetObject, ListObjects, DeleteObject) to detect suspicious activity across all of your Amazon S3 buckets.

<details>

<summary>Finding Information</summary>

Finding summary:

* Finding type
* Severity: 7-8.9 High, 4-6.9 Medium, 01-3.9 Low
* Region
* Account ID
* Resource ID
* Time of detection
* Which threat list was used

The body has this information:

* Resource affected
* Action
* Actor: Ip address, port and domain
* Additional Information

</details>

### All Findings

Access a list of all the GuardDuty findings in: [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Multi Accounts

#### By Invitation

You can **invite other accounts** to a different AWS GuardDuty account so **every account is monitored from the same GuardDuty**. The master account must invite the member accounts and then the representative of the member account must accept the invitation.

#### Via Organization

You can designate any account within the organization to be the **GuardDuty delegated administrator**. Only the organization management account can designate a delegated administrator.

An account that gets designated as a delegated administrator becomes a GuardDuty administrator account, has GuardDuty enabled automatically in the designated AWS Region, and also has the **permission to enable and manage GuardDuty for all of the accounts in the organization within that Region**. The other accounts in the organization can be viewed and added as GuardDuty member accounts associated with this delegated administrator account.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings 
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty Bypass

### General Guidance

Try to find out as much as possible about the behaviour of the credentials you are going to use:

* Times it's used
* Locations
* User Agents / Services (It could be used from awscli, webconsole, lambda...)
* Permissions regularly used

With this information, recreate as much as possible the same scenario to use the access:

* If it's a **user or a role accessed by a user**, try to use it in the same hours, from the same geolocation (even the same ISP and IP if possible)
* If it's a **role used by a service**, create the same service in the same region and use it from there in the same time ranges
* Always try to use the **same permissions** this principal has used&#x20;
* If you need to **use other permissions or abuse a permission** (for example, download 1.000.000 cloudtrail log files) do it **slowly** and with the **minimum amount of interactions** with AWS (awscli sometime call several read APIs before the write one)

### Modify GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

With those permissions you could disable GuardDuty to avoid triggering alerts.

```bash
# Disabling the detector
aws guardduty update-detector \
    --detector-id <detector-id> \
    --no-enable 

# Removing s3 as a log source
aws guardduty update-detector \
    --detector-id <detector-id> \
    --data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
    --detector-id <detector-id> \
    --finding-publishing-frequency SIX_HOURS
```

#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

An attacker could create or update GuardDuty's [Trusted IP list](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html), including **their own IP on the list**. Any IPs in a trusted IP list will **not have any Cloudtrail or VPC flow log alerts raised** against them.

{% hint style="info" %}
DNS findings are exempt from the Trusted IP list.
{% endhint %}

```bash
aws guardduty update-ip-set \
    --detector-id <detector-id> \
    --ip-set-id 24adjigdk34290840348exampleiplist \
    --location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
    --activate
```

{% hint style="info" %}
Depending on the level of stealth required, the **file can be uploaded to an s3 bucket in the target account, or an account controlled by the attacker.**
{% endhint %}

#### `guardduty:CreateFilter`

Newly create GuardDuty findings can be automatically archived via [Suppression Rules](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html). An adversary could **use** [**filters**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html) **to automatically archive findings** they are likely to generate.

Filters can be created using the [CreateFilter API](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html).

```bash
aws guardduty create-filter \
    --action ARCHIVE \
    --detector-id <detector-id> \
    --name yourfiltername \
    --finding-criteria file://criteria.json
```

#### `guardduty:DeletePublishingDestination`

An adversary could disable alerting simply by [deleting the destination](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) of alerts.

```bash
aws guardduty delete-publishing-destination \
    --detector-id <detector-id> \
    --destination-id def456
```

{% hint style="danger" %}
Deleting this publishing destination will **not affect the generation or visibility of findings within the GuardDuty console**. GuardDuty will continue to analyze events in your AWS environment, identify suspicious or unexpected behavior, and generate findings.
{% endhint %}

### Specific Findings Bypass

#### Pentest Findings

OS's GuardDuty detect AWS API requests from common penetration testing tools and trigger a [PenTest Finding](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
It's detected by the **user agent name** that is passed in the API request.\
Therefore, **modifying the user agent** it's possible to prevent GuardDuty from detecting the attack.

Using OS like Ubuntu, Mac or Windows will prevent this alert from triggering.

To prevent this you can search from the script `session.py` in the `botocore` package. In Kali Linux it's in `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Around line [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456) you should see `platform.system()` and `platform.release()`. Replace this **code with legitimate user agent strings like those found in** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

#### Tor Client Findings

{% hint style="success" %}
The easiest way to bypass this is just to **not use Tor to connect to AWS** (why would you be using Tor if you want to remain stealth and simulate the scenario of the compromised credentials?)
{% endhint %}

If you make a connection from **Tor**, **Guarduty** will set the alert [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

Guarduty detect this thanks to a [public list of Tor nodes](https://metrics.torproject.org/exonerator.html).&#x20;

If you need to connect through Tor you can **bypass this using** [**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge). But obviously it would be better if you just don't use Tor at all to connect.

To use a bridge you an use [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) and get a bridge address from [bridges.torproject.org](https://bridges.torproject.org/options).

From here, `create a torrc` file with something similar to:

```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```

Run `tor -f torrc` and you can connect to the regular socks5 proxy on port 9050.

#### Credential Exfiltration Detection

If you **steals EC2 creds** from the metadata service and uses them **outside AWS infrastructure** the alert [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) is triggered.

Moreover, if you **use your own EC2 instance** to use the **stolen credentials** the alert [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) is triggered.

{% hint style="warning" %}
If you have **compromised** another **EC2** machine from the **same account**, you could use the credentials there and **no alert** will be generated.
{% endhint %}

However, there is currently a functioning bypass for this - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Using **VPC Endpoints** will **not trigger the GuardDuty alert**. What this means is that, as an attacker, `if you steal IAM credentials from an EC2 instance, you can use those credentials from your own EC2 instance while routing traffic through VPC Endpoints. This will not trigger the GuardDuty finding`.

The tool [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) was created to automate this process. This project **spins up an environment to attack from via Terraform**. It will create an EC2 instance in a private subnet without internet access and create a number of VPC Endpoints for you to use.

**Another way to bypass this alert** is to simple use stolen credentials in the same machine they were stolen **or in one from the same account.**

## References

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
