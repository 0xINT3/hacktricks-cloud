# AWS - GuardDuty 枚举

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## GuardDuty

根据[**文档**](https://aws.amazon.com/guardduty/features/)：GuardDuty 结合了**机器学习、异常检测、网络监控和恶意文件发现**，使用AWS和业界领先的第三方资源来帮助保护AWS上的工作负载和数据。GuardDuty 能够分析数十亿个事件，跨多个AWS数据源，如AWS CloudTrail事件日志、Amazon Virtual Private Cloud (VPC) 流日志、Amazon Elastic Kubernetes Service (EKS) 审计和系统级日志以及DNS查询日志。

Amazon GuardDuty **识别您账户内的异常活动**，分析活动的**安全相关性**，并提供其被调用的**上下文**。这允许响应者确定他们是否应该花时间进行进一步调查。

警报**显示在GuardDuty控制台（90天）**和CloudWatch事件中。

{% hint style="warning" %}
当用户**禁用GuardDuty**时，它将停止监控您的AWS环境，并且不会生成任何新的发现，**现有的发现将会丢失**。\
如果您只是停止它，现有的发现将保留。
{% endhint %}

### 发现示例

* **侦察**：活动表明攻击者的侦察，如**不寻常的API活动**、可疑的数据库**登录**尝试、VPC内**端口扫描**、不寻常的登录请求失败模式，或来自已知恶意IP的未被阻止的端口探测。
* **实例妥协**：活动表明实例被妥协，如**加密货币挖矿、后门命令和控制（C&C）**活动、使用域名生成算法（DGA）的恶意软件、出站拒绝服务活动、异常**高网络**流量、不寻常的网络协议、与已知恶意IP通信的出站实例、由外部IP地址使用的临时Amazon EC2凭证，以及使用DNS的数据泄露。
* **账户妥协**：表明账户妥协的常见模式包括来自不寻常地理位置或匿名代理的API调用、尝试禁用AWS CloudTrail日志记录、改变弱化账户密码策略的更改、不寻常的实例或基础设施启动、在不寻常地区的基础设施部署、凭证盗窃、可疑的数据库登录活动，以及来自已知恶意IP地址的API调用。
* **存储桶妥协**：活动表明存储桶被妥协，如可疑的数据访问模式表明凭证滥用、来自远程主机的不寻常Amazon S3 API活动、来自已知恶意IP地址的未授权S3访问，以及从没有访问过该存储桶或从不寻常位置调用的用户检索S3桶中数据的API调用。Amazon GuardDuty持续监控和分析AWS CloudTrail S3数据事件（例如GetObject, ListObjects, DeleteObject）以检测您所有Amazon S3桶中的可疑活动。

<details>

<summary>发现信息</summary>

发现摘要：

* 发现类型
* 严重性：7-8.9 高，4-6.9 中，01-3.9 低
* 地区
* 账户ID
* 资源ID
* 检测时间
* 使用了哪个威胁列表

正文包含以下信息：

* 受影响的资源
* 行动
* 行为者：Ip地址、端口和域名
* 额外信息

</details>

### 所有发现

访问所有GuardDuty发现的列表：[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### 多账户

#### 通过邀请

您可以**邀请其他账户**到不同的AWS GuardDuty账户，以便**每个账户都从同一个GuardDuty监控**。主账户必须邀请成员账户，然后成员账户的代表必须接受邀请。

#### 通过组织

您可以指定组织内的任何账户作为**GuardDuty委派管理员**。只有组织管理账户可以指定委派管理员。

被指定为委派管理员的账户成为GuardDuty管理员账户，在指定的AWS地区自动启用GuardDuty，并且还有**权限为该地区内组织的所有账户启用和管理GuardDuty**。组织中的其他账户可以被查看并添加为与此委派管理员账户关联的GuardDuty成员账户。

## 枚举

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## GuardDuty 绕过

### 基本指导

尽可能多地了解您将要使用的凭证的行为：

* 使用次数
* 地点
* 用户代理/服务（可能是从 awscli、webconsole、lambda... 使用）
* 常规使用的权限

根据这些信息，尽可能重现相同的场景来使用访问权限：

* 如果是**用户或用户访问的角色**，尝试在相同的时间段，从相同的地理位置使用（如果可能的话，甚至是相同的 ISP 和 IP）
* 如果是**服务使用的角色**，在相同的区域创建相同的服务，并在相同的时间范围内从那里使用
* 始终尝试使用该主体已使用的**相同权限**
* 如果您需要**使用其他权限或滥用权限**（例如，下载 1,000,000 个 cloudtrail 日志文件），请**慢慢地**进行，并且与 AWS 的交互**尽量少**（awscli 有时会在写操作之前调用几个读取 API）

### 破解 GuardDuty

#### `guardduty:UpdateDetector`

拥有此权限，您可以禁用 GuardDuty 以避免触发警报。

{% code overflow="wrap" %}
```bash
aws guardduty update-detector --detector-id <detector-id> --no-enable
aws guardduty update-detector --detector-id <detector-id> --data-sources S3Logs={Enable=false}
```
{% endcode %}

#### `guardduty:CreateFilter`

拥有此权限的攻击者能够**使用过滤器来自动**归档发现：

{% code overflow="wrap" %}
```bash
aws guardduty create-filter  --detector-id <detector-id> --name <filter-name> --finding-criteria file:///tmp/criteria.json --action ARCHIVE
```
#### `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

拥有前述权限的攻击者可以通过在GuardDuty的[**可信IP列表**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)中添加他们的IP地址来修改该列表，从而避免触发警报。

{% code overflow="wrap" %}
```bash
aws guardduty update-ip-set --detector-id <detector-id> --activate --ip-set-id <ip-set-id> --location https://some-bucket.s3-eu-west-1.amazonaws.com/attacker.csv
```
#### `guardduty:DeletePublishingDestination`

攻击者可以删除目的地以防止警报：

{% code overflow="wrap" %}
```bash
aws guardduty delete-publishing-destination --detector-id <detector-id> --destination-id <dest-id>
```
{% endcode %}

{% hint style="danger" %}
删除此发布目的地将**不会影响GuardDuty控制台内发现的生成或可见性**。GuardDuty将继续分析您的AWS环境中的事件，识别可疑或异常行为，并生成发现。
{% endhint %}

### 特定发现绕过示例

请注意，GuardDuty有数十种发现，但是，**作为红队成员，并非所有这些发现都会影响您**，更好的是，您可以在[https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)查看它们的**完整文档**，因此在采取任何行动之前先查看，以免被发现。

以下是一些特定GuardDuty发现绕过的示例：

#### [PenTest:IAMUser/KaliLinux](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux) <a href="#pentest-iam-kalilinux" id="pentest-iam-kalilinux"></a>

GuardDuty检测到来自常见渗透测试工具的AWS API请求，并触发[PenTest发现](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux)。\
它是通过在API请求中传递的**用户代理名称**来检测的。\
因此，**修改用户代理**可以防止GuardDuty检测到攻击。

为了防止这种情况，您可以在`botocore`包中搜索脚本`session.py`并修改用户代理，或者将Burp Suite设置为AWS CLI代理并使用MitM更改用户代理，或者只是使用像Ubuntu、Mac或Windows这样的操作系统也会防止触发此警报。

#### UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration

从元数据服务中提取EC2凭证并**在AWS环境外使用它们**会激活[**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)警报。相反，从您的EC2实例中使用这些凭证会触发[**`UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS`**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)警报。然而，**在同一账户内的另一个受损EC2实例上使用这些凭证则不会被检测到**，不会引发警报。

{% hint style="success" %}
因此，**在您发现它们的机器内部使用被窃取的凭证**以避免触发此警报。
{% endhint %}

## 参考资料

* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html)
* [https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws)
* [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws)
* [https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html](https://docs.aws.amazon.com/whitepapers/latest/aws-privatelink/what-are-vpc-endpoints.html)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
