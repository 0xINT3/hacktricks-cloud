# AWS - Enum√©ration de GuardDuty

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## GuardDuty

Selon les [**docs**](https://aws.amazon.com/guardduty/features/) : GuardDuty combine **l'apprentissage automatique, la d√©tection d'anomalies, la surveillance du r√©seau et la d√©couverte de fichiers malveillants**, en utilisant √† la fois AWS et des sources tierces leaders du secteur pour aider √† prot√©ger les charges de travail et les donn√©es sur AWS. GuardDuty est capable d'analyser des dizaines de milliards d'√©v√©nements provenant de plusieurs sources de donn√©es AWS, telles que les journaux d'√©v√©nements AWS CloudTrail, les journaux de flux Amazon Virtual Private Cloud (VPC), les journaux d'audit et de niveau syst√®me Amazon Elastic Kubernetes Service (EKS), et les journaux de requ√™tes DNS.

Amazon GuardDuty **identifie les activit√©s inhabituelles au sein de vos comptes**, analyse la **pertinence de la s√©curit√©** de l'activit√© et fournit le **contexte** dans lequel elle a √©t√© invoqu√©e. Cela permet √† un intervenant de d√©terminer s'il doit consacrer du temps √† une enqu√™te plus approfondie.

Les alertes **apparaissent dans la console GuardDuty (90 jours)** et les √©v√©nements CloudWatch.

{% hint style="warning" %}
Lorsqu'un utilisateur **d√©sactive GuardDuty**, il cesse de surveiller votre environnement AWS et ne g√©n√®re plus de nouvelles d√©couvertes, et les **d√©couvertes existantes seront perdues**.\
Si vous vous contentez de l'arr√™ter, les d√©couvertes existantes resteront.
{% endhint %}

### Exemple de d√©couvertes

* **Reconnaissance** : Activit√© sugg√©rant une reconnaissance par un attaquant, telle qu'une activit√© d'API **inhabituelle**, des tentatives de **connexion** suspectes √† une base de donn√©es, un **balayage de port** intra-VPC, des motifs inhabituels de demandes de connexion √©chou√©es ou une sonde de port non bloqu√©e depuis une adresse IP connue comme √©tant mauvaise.
* **Compromission d'instance** : Activit√© indiquant une compromission d'instance, telle que l'exploitation de **cryptomonnaie, l'activit√© de commande et de contr√¥le (C\&C)** de porte d√©rob√©e, des logiciels malveillants utilisant des algorithmes de g√©n√©ration de domaine (DGA), une activit√© de d√©ni de service sortant, un volume de trafic r√©seau **anormalement √©lev√©**, des protocoles r√©seau inhabituels, une communication d'instance sortante avec une adresse IP malveillante connue, des informations d'identification temporaires Amazon EC2 utilis√©es par une adresse IP externe, et une exfiltration de donn√©es utilisant DNS.
* **Compromission de compte** : Les mod√®les courants indiquant une compromission de compte incluent des appels d'API depuis une g√©olocalisation inhabituelle ou un proxy d'anonymisation, des tentatives de d√©sactivation de l'enregistrement AWS CloudTrail, des modifications affaiblissant la politique de mot de passe du compte, des lancements d'instances ou d'infrastructures inhabituels, des d√©ploiements d'infrastructures dans une r√©gion inhabituelle, le vol d'informations d'identification, une activit√© de connexion suspecte √† une base de donn√©es, et des appels d'API depuis des adresses IP malveillantes connues.
* **Compromission de compartiment** : Activit√© indiquant une compromission de compartiment, telle que des motifs d'acc√®s de donn√©es suspects indiquant une utilisation abusive d'informations d'identification, une activit√© d'API Amazon S3 inhabituelle depuis un h√¥te distant, un acc√®s S3 non autoris√© depuis des adresses IP malveillantes connues, et des appels d'API pour r√©cup√©rer des donn√©es dans des compartiments S3 √† partir d'un utilisateur sans historique d'acc√®s au compartiment ou invoqu√© depuis un emplacement inhabituel. Amazon GuardDuty surveille et analyse en continu les √©v√©nements de donn√©es AWS CloudTrail S3 (par exemple, GetObject, ListObjects, DeleteObject) pour d√©tecter une activit√© suspecte dans tous vos compartiments Amazon S3.

<details>

<summary>Informations sur la d√©couverte</summary>

R√©sum√© de la d√©couverte :

* Type de d√©couverte
* Gravit√© : 7-8.9 √âlev√©e, 4-6.9 Moyenne, 01-3.9 Faible
* R√©gion
* ID du compte
* ID de la ressource
* Heure de d√©tection
* Liste de menaces utilis√©e

Le corps contient ces informations :

* Ressource affect√©e
* Action
* Acteur : Adresse IP, port et domaine
* Informations suppl√©mentaires

</details>

### Toutes les d√©couvertes

Acc√©dez √† la liste de toutes les d√©couvertes de GuardDuty sur : [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Multi-comptes

#### Par invitation

Vous pouvez **inviter d'autres comptes** √† rejoindre un compte AWS GuardDuty diff√©rent afin que **chaque compte soit surveill√© par le m√™me GuardDuty**. Le compte principal doit inviter les comptes membres, puis le repr√©sentant du compte membre doit accepter l'invitation.

#### Via l'organisation

Vous pouvez d√©signer n'importe quel compte au sein de l'organisation comme **administrateur d√©l√©gu√© de GuardDuty**. Seul le compte de gestion de l'organisation peut d√©signer un administrateur d√©l√©gu√©.

Un compte d√©sign√© comme administrateur d√©l√©gu√© devient un compte administrateur de GuardDuty, a GuardDuty activ√© automatiquement dans la r√©gion AWS d√©sign√©e, et a √©galement la **permission d'activer et de g√©rer GuardDuty pour tous les comptes de l'organisation dans cette r√©gion**. Les autres comptes de l'organisation peuvent √™tre consult√©s et ajout√©s en tant que comptes membres de GuardDuty associ√©s √† ce compte administrateur d√©l√©gu√©.

## √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Contournement de GuardDuty

### Conseils g√©n√©raux

Essayez de d√©couvrir autant d'informations que possible sur le comportement des informations d'identification que vous allez utiliser :

* Les moments o√π elles sont utilis√©es
* Les emplacements
* Les agents utilisateurs / services (elles peuvent √™tre utilis√©es √† partir d'awscli, de la console web, de lambda...)
* Les autorisations r√©guli√®rement utilis√©es

Avec ces informations, recr√©ez autant que possible le m√™me sc√©nario pour utiliser l'acc√®s :

* S'il s'agit d'un **utilisateur ou d'un r√¥le utilis√© par un utilisateur**, essayez de l'utiliser aux m√™mes heures, depuis la m√™me g√©olocalisation (m√™me fournisseur d'acc√®s Internet et m√™me adresse IP si possible)
* S'il s'agit d'un **r√¥le utilis√© par un service**, cr√©ez le m√™me service dans la m√™me r√©gion et utilisez-le √† partir de l√† aux m√™mes intervalles de temps
* Essayez toujours d'utiliser les **m√™mes autorisations** que celles utilis√©es par ce principal&#x20;
* Si vous avez besoin d'**utiliser d'autres autorisations ou d'abuser d'une autorisation** (par exemple, t√©l√©charger 1 000 000 de fichiers journaux CloudTrail), faites-le **lentement** et avec le **minimum d'interactions** avec AWS (awscli appelle parfois plusieurs API de lecture avant celle d'√©criture)

### Modifier GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Avec ces autorisations, vous pouvez d√©sactiver GuardDuty pour √©viter de d√©clencher des alertes.
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Un attaquant pourrait cr√©er ou mettre √† jour la liste des adresses IP de confiance de GuardDuty, y compris **leur propre adresse IP dans la liste**. Toutes les adresses IP figurant dans une liste d'adresses IP de confiance ne d√©clencheront **aucune alerte Cloudtrail ou VPC flow log**.

{% hint style="info" %}
Les r√©sultats DNS sont exempt√©s de la liste des adresses IP de confiance.
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
Selon le niveau de discr√©tion requis, le fichier peut √™tre t√©l√©charg√© dans un compartiment s3 du compte cible ou dans un compte contr√¥l√© par l'attaquant.
{% endhint %}

#### `guardduty:CreateFilter`

Les nouvelles d√©couvertes de GuardDuty peuvent √™tre automatiquement archiv√©es via des [r√®gles de suppression](https://docs.aws.amazon.com/guardduty/latest/ug/findings\_suppression-rule.html). Un adversaire pourrait utiliser des [filtres](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_filter-findings.html) pour archiver automatiquement les d√©couvertes qu'il est susceptible de g√©n√©rer.

Les filtres peuvent √™tre cr√©√©s √† l'aide de l'API [CreateFilter](https://docs.aws.amazon.com/guardduty/latest/APIReference/API\_CreateFilter.html).
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

Un adversaire pourrait d√©sactiver l'alerte simplement en [supprimant la destination](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) des alertes.
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
La suppression de cette destination de publication n'affectera **pas la g√©n√©ration ni la visibilit√© des r√©sultats dans la console GuardDuty**. GuardDuty continuera d'analyser les √©v√©nements dans votre environnement AWS, d'identifier les comportements suspects ou inattendus et de g√©n√©rer des r√©sultats.
{% endhint %}

### Contournement des r√©sultats sp√©cifiques

#### R√©sultats de test de p√©n√©tration

GuardDuty d'OS d√©tecte les requ√™tes API AWS √† partir d'outils courants de test de p√©n√©tration et d√©clenche un [r√©sultat de test de p√©n√©tration](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Cela est d√©tect√© par le **nom de l'agent utilisateur** qui est transmis dans la requ√™te API.\
Par cons√©quent, il est possible d'emp√™cher GuardDuty de d√©tecter l'attaque en **modifiant l'agent utilisateur**.

L'utilisation d'OS tels que Ubuntu, Mac ou Windows emp√™chera le d√©clenchement de cette alerte.

Pour √©viter cela, vous pouvez rechercher le script `session.py` dans le package `botocore`. Dans Kali Linux, il se trouve dans `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Vers la ligne [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456), vous devriez voir `platform.system()` et `platform.release()`. Remplacez ce **code par des cha√Ænes d'agent utilisateur l√©gitimes comme celles trouv√©es dans** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

#### R√©sultats du client Tor

{% hint style="success" %}
La fa√ßon la plus simple de contourner cela est simplement de **ne pas utiliser Tor pour se connecter √† AWS** (pourquoi utiliseriez-vous Tor si vous voulez rester discret et simuler le sc√©nario des informations d'identification compromises ?)
{% endhint %}

Si vous √©tablissez une connexion depuis **Tor**, **Guarduty** d√©clenchera l'alerte [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

Guarduty d√©tecte cela gr√¢ce √† une [liste publique de n≈ìuds Tor](https://metrics.torproject.org/exonerator.html).&#x20;

Si vous avez besoin de vous connecter via Tor, vous pouvez **contourner cela en utilisant** [**Bridges**](https://community.torproject.org/relay/types-of-relays/#Bridge). Mais √©videmment, il serait pr√©f√©rable de ne pas utiliser du tout Tor pour vous connecter.

Pour utiliser un bridge, vous pouvez utiliser [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) et obtenir une adresse de bridge depuis [bridges.torproject.org](https://bridges.torproject.org/options).

√Ä partir de l√†, `cr√©ez un fichier torrc` avec quelque chose de similaire √† :
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
Ex√©cutez `tor -f torrc` et vous pouvez vous connecter au proxy socks5 standard sur le port 9050.

#### D√©tection de l'exfiltration des informations d'identification

Si vous volez les informations d'identification EC2 √† partir du service de m√©tadonn√©es et les utilisez en dehors de l'infrastructure AWS, l'alerte [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) est d√©clench√©e.

De plus, si vous utilisez votre propre instance EC2 pour utiliser les informations d'identification vol√©es, l'alerte [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) est d√©clench√©e.

{% hint style="warning" %}
Si vous avez compromis une autre machine EC2 du m√™me compte, vous pouvez utiliser les informations d'identification l√†-bas et aucune alerte ne sera g√©n√©r√©e.
{% endhint %}

Cependant, il existe actuellement une contournement fonctionnel pour cela - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). L'utilisation des **VPC Endpoints** ne d√©clenchera pas l'alerte GuardDuty. Cela signifie que, en tant qu'attaquant, `si vous volez les informations d'identification IAM √† partir d'une instance EC2, vous pouvez utiliser ces informations d'identification depuis votre propre instance EC2 tout en routant le trafic via les VPC Endpoints. Cela ne d√©clenchera pas la d√©tection de GuardDuty`.

L'outil [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) a √©t√© cr√©√© pour automatiser ce processus. Ce projet **met en place un environnement pour attaquer via Terraform**. Il cr√©era une instance EC2 dans un sous-r√©seau priv√© sans acc√®s √† Internet et cr√©era plusieurs VPC Endpoints que vous pourrez utiliser.

**Une autre fa√ßon de contourner cette alerte** est simplement d'utiliser les informations d'identification vol√©es dans la m√™me machine o√π elles ont √©t√© vol√©es **ou dans une machine du m√™me compte**.

## R√©f√©rences

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Supportez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
