# AWS - GuardDuty Enum

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## GuardDuty

Selon la [**documentation**](https://aws.amazon.com/guardduty/features/) : GuardDuty combine **l'apprentissage automatique, la d√©tection d'anomalies, la surveillance du r√©seau et la d√©couverte de fichiers malveillants**, en utilisant √† la fois des sources AWS et des sources tierces de premier plan pour aider √† prot√©ger les charges de travail et les donn√©es sur AWS. GuardDuty est capable d'analyser des dizaines de milliards d'√©v√©nements √† travers de multiples sources de donn√©es AWS, telles que les journaux d'√©v√©nements AWS CloudTrail, les journaux de flux Amazon Virtual Private Cloud (VPC), les journaux d'audit et les journaux syst√®me Amazon Elastic Kubernetes Service (EKS), et les journaux de requ√™tes DNS.

Amazon GuardDuty **identifie les activit√©s inhabituelles au sein de vos comptes**, analyse la **pertinence s√©curitaire** de l'activit√© et donne le **contexte** dans lequel elle a √©t√© invoqu√©e. Cela permet √† un intervenant de d√©terminer s'il doit consacrer du temps √† une enqu√™te plus approfondie.

Les alertes **apparaissent dans la console GuardDuty (90 jours)** et les √©v√©nements CloudWatch.

{% hint style="warning" %}
Lorsqu'un utilisateur **d√©sactive GuardDuty**, il arr√™tera la surveillance de votre environnement AWS et il ne g√©n√©rera plus de nouvelles d√©couvertes du tout, et les **d√©couvertes existantes seront perdues**.\
Si vous l'arr√™tez simplement, les d√©couvertes existantes resteront.
{% endhint %}

### Exemple de d√©couvertes

* **Reconnaissance** : Activit√© sugg√©rant une reconnaissance par un attaquant, telle que **activit√© API inhabituelle**, tentatives de **connexion** √† la base de donn√©es suspectes, **balayage de ports** intra-VPC, motifs inhabituels de demandes de connexion √©chou√©es, ou sondage de ports non bloqu√©s depuis une IP malveillante connue.
* **Compromission d'instance** : Activit√© indiquant une compromission d'instance, telle que **minage de cryptomonnaie, commande √† distance et contr√¥le (C\&C)**, malware utilisant des algorithmes de g√©n√©ration de domaines (DGA), activit√© de d√©ni de service sortant, volume de trafic r√©seau **anormalement √©lev√©**, protocoles r√©seau inhabituels, communication sortante d'instance avec une IP malveillante connue, utilisation de cr√©dits Amazon EC2 temporaires par une adresse IP externe, et exfiltration de donn√©es via DNS.
* **Compromission de compte** : Des mod√®les communs indiquant une compromission de compte incluent des appels API depuis une g√©olocalisation inhabituelle ou un proxy anonymisant, des tentatives de d√©sactivation de la journalisation AWS CloudTrail, des changements qui affaiblissent la politique de mot de passe du compte, des lancements d'instance ou d'infrastructure inhabituels, des d√©ploiements d'infrastructure dans une r√©gion inhabituelle, vol de cr√©dentiels, activit√© de connexion √† la base de donn√©es suspecte, et appels API depuis des adresses IP malveillantes connues.
* **Compromission de bucket** : Activit√© indiquant une compromission de bucket, telle que des mod√®les d'acc√®s aux donn√©es suspects indiquant un abus de cr√©dentiels, activit√© API Amazon S3 inhabituelle depuis un h√¥te distant, acc√®s S3 non autoris√© depuis des adresses IP malveillantes connues, et appels API pour r√©cup√©rer des donn√©es dans des buckets S3 par un utilisateur sans historique pr√©alable d'acc√®s au bucket ou invoqu√©s depuis un emplacement inhabituel. Amazon GuardDuty surveille et analyse en continu les √©v√©nements de donn√©es S3 AWS CloudTrail (par exemple, GetObject, ListObjects, DeleteObject) pour d√©tecter une activit√© suspecte dans tous vos buckets Amazon S3.

<details>

<summary>Informations sur les d√©couvertes</summary>

R√©sum√© des d√©couvertes :

* Type de d√©couverte
* S√©v√©rit√© : 7-8.9 √âlev√©e, 4-6.9 Moyenne, 01-3.9 Faible
* R√©gion
* ID de compte
* ID de ressource
* Moment de la d√©tection
* Quelle liste de menaces a √©t√© utilis√©e

Le corps contient ces informations :

* Ressource affect√©e
* Action
* Acteur : adresse IP, port et domaine
* Informations suppl√©mentaires

</details>

### Toutes les d√©couvertes

Acc√©dez √† la liste de toutes les d√©couvertes GuardDuty sur : [https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-active.html)

### Comptes multiples

#### Par invitation

Vous pouvez **inviter d'autres comptes** √† un compte AWS GuardDuty diff√©rent afin que **chaque compte soit surveill√© depuis le m√™me GuardDuty**. Le compte principal doit inviter les comptes membres puis le repr√©sentant du compte membre doit accepter l'invitation.

#### Via l'organisation

Vous pouvez d√©signer n'importe quel compte au sein de l'organisation pour √™tre l'**administrateur d√©l√©gu√© GuardDuty**. Seul le compte de gestion de l'organisation peut d√©signer un administrateur d√©l√©gu√©.

Un compte qui est d√©sign√© comme administrateur d√©l√©gu√© devient un compte administrateur GuardDuty, GuardDuty est automatiquement activ√© dans la r√©gion AWS d√©sign√©e, et a √©galement la **permission d'activer et de g√©rer GuardDuty pour tous les comptes de l'organisation dans cette r√©gion**. Les autres comptes de l'organisation peuvent √™tre consult√©s et ajout√©s en tant que comptes membres GuardDuty associ√©s √† ce compte administrateur d√©l√©gu√©.

## √ânum√©ration

{% code overflow="wrap" %}
```bash
# Get Org config
aws guardduty list-organization-admin-accounts #Get Delegated Administrator
aws guardduty describe-organization-configuration --detector-id <id>

# Check external invitations
aws guardduty list-invitations
aws guardduty get-invitations-count

# Detector Information
aws guardduty list-detectors # 1 detector per account with GuardDuty
aws guardduty get-detector --detector-id <id> # Get detector info
aws guardduty get-master-account --detector-id <id>

# Get filters
aws guardduty list-filters --detector-id <id> # Check filters
aws guardduty get-filter --detector-id <id> --filter-name <name>

# Findings
aws guardduty list-findings --detector-id <id> # List findings
aws guardduty get-findings --detector-id <id> --finding-ids <id> # Get details about the finding
aws guardduty get-findings-statistics --detector-id <id> --finding-statistic-types <types>

# Get trusted IP addresses
aws guardduty list-ip-sets --detector-id <id>
aws guardduty get-ip-set --detector-id <id>

# Member accounts of the current AWS GuardDuty master account
aws guardduty list-members --detector-id <id>
aws guardduty get-members --detector-id <id> --account-ids <id>
aws guardduty get-member-detectors --detector-id <id> --account-ids <id>

# Continuously export its findings to an Amazon S3 bucket
aws guardduty list-publishing-destinations --detector-id <id>

# Intelligence sets that you have uploaded to GuardDuty
aws guardduty list-threat-intel-sets --detector-id <id>
aws guardduty get-threat-intel-set --detector-id <id> --threat-intel-set-id <id>
```
{% endcode %}

## Contournement de GuardDuty

### Conseils g√©n√©raux

Essayez de d√©couvrir autant que possible le comportement des identifiants que vous allez utiliser :

* Fr√©quence d'utilisation
* Localisations
* Agents utilisateurs / Services (Peut √™tre utilis√© depuis awscli, webconsole, lambda...)
* Permissions r√©guli√®rement utilis√©es

Avec ces informations, recr√©ez autant que possible le m√™me sc√©nario pour utiliser l'acc√®s :

* S'il s'agit d'**un utilisateur ou d'un r√¥le acc√©d√© par un utilisateur**, essayez de l'utiliser aux m√™mes heures, depuis la m√™me g√©olocalisation (m√™me le m√™me FAI et IP si possible)
* S'il s'agit d'**un r√¥le utilis√© par un service**, cr√©ez le m√™me service dans la m√™me r√©gion et utilisez-le de l√† aux m√™mes plages horaires
* Essayez toujours d'utiliser les **m√™mes permissions** que ce principal a utilis√©es
* Si vous devez **utiliser d'autres permissions ou abuser d'une permission** (par exemple, t√©l√©charger 1.000.000 de fichiers de logs cloudtrail) faites-le **lentement** et avec le **nombre minimum d'interactions** avec AWS (awscli appelle parfois plusieurs API de lecture avant celle d'√©criture)

### Modifier GuardDuty

#### `guardduty:ListDetectors`, `guardduty:UpdateDetector`

Avec ces permissions, vous pourriez d√©sactiver GuardDuty pour √©viter de d√©clencher des alertes.
```bash
# Disabling the detector
aws guardduty update-detector \
--detector-id <detector-id> \
--no-enable

# Removing s3 as a log source
aws guardduty update-detector \
--detector-id <detector-id> \
--data-sources S3Logs={Enable=false}

# Increase finding update time to 6 hours
aws guardduty update-detector \
--detector-id <detector-id> \
--finding-publishing-frequency SIX_HOURS
```
#### `guardduty:ListDetectors`, `guardduty:ListIPSet`, `iam:PutRolePolicy`, (`guardduty:CreateIPSet`|`guardduty:UpdateIPSet`)

Un attaquant pourrait cr√©er ou mettre √† jour la [liste des IP de confiance](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_upload-lists.html) de GuardDuty, y compris **leur propre IP sur la liste**. Toutes les IP figurant sur une liste d'IP de confiance **ne d√©clencheront aucune alerte de Cloudtrail ou de journal de flux VPC** contre elles.

{% hint style="info" %}
Les d√©couvertes DNS sont exempt√©es de la liste des IP de confiance.
{% endhint %}
```bash
aws guardduty update-ip-set \
--detector-id <detector-id> \
--ip-set-id 24adjigdk34290840348exampleiplist \
--location https://malicious-bucket.s3-us-east-1.amazonaws.com/customiplist.csv \
--activate
```
{% hint style="info" %}
Selon le niveau de discr√©tion requis, **le fichier peut √™tre t√©l√©charg√© dans un seau s3 du compte cible, ou un compte contr√¥l√© par l'attaquant.**
{% endhint %}

#### `guardduty:CreateFilter`

Les nouvelles d√©tections de GuardDuty peuvent √™tre automatiquement archiv√©es via les [R√®gles de Suppression](https://docs.aws.amazon.com/guardduty/latest/ug/findings_suppression-rule.html). Un adversaire pourrait **utiliser** [**des filtres**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_filter-findings.html) **pour archiver automatiquement les d√©tections** qu'ils sont susceptibles de g√©n√©rer.

Les filtres peuvent √™tre cr√©√©s en utilisant l'API [CreateFilter](https://docs.aws.amazon.com/guardduty/latest/APIReference/API_CreateFilter.html).
```bash
aws guardduty create-filter \
--action ARCHIVE \
--detector-id <detector-id> \
--name yourfiltername \
--finding-criteria file://criteria.json
```
#### `guardduty:DeletePublishingDestination`

Un adversaire pourrait d√©sactiver les alertes simplement en [supprimant la destination](https://docs.aws.amazon.com/cli/latest/reference/guardduty/delete-publishing-destination.html) des alertes.
```bash
aws guardduty delete-publishing-destination \
--detector-id <detector-id> \
--destination-id def456
```
{% hint style="danger" %}
Supprimer cette destination de publication **n'affectera pas la g√©n√©ration ou la visibilit√© des r√©sultats dans la console GuardDuty**. GuardDuty continuera d'analyser les √©v√©nements dans votre environnement AWS, d'identifier les comportements suspects ou inattendus et de g√©n√©rer des r√©sultats.
{% endhint %}

### Contournement de R√©sultats Sp√©cifiques

#### R√©sultats de Pentest

Le GuardDuty d'OS d√©tecte les requ√™tes API AWS provenant d'outils de pentesting courants et d√©clenche un [R√©sultat de Pentest](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-iam.html#pentest-iam-kalilinux).\
Il est d√©tect√© par le **nom de l'agent utilisateur** qui est transmis dans la requ√™te API.\
Par cons√©quent, **modifier l'agent utilisateur** permet de pr√©venir la d√©tection de l'attaque par GuardDuty.

Utiliser des OS comme Ubuntu, Mac ou Windows emp√™chera le d√©clenchement de cette alerte.

Pour √©viter cela, vous pouvez rechercher le script `session.py` dans le paquet `botocore`. Sur Kali Linux, il se trouve dans `/usr/local/lib/python3.7/dist-packages/botocore/session.py`.

Aux alentours de la ligne [456](https://github.com/boto/botocore/blob/7de36c07ecec503f588ac27658b1795e83b67b75/botocore/session.py#L456), vous devriez voir `platform.system()` et `platform.release()`. Remplacez ce **code par des cha√Ænes d'agent utilisateur l√©gitimes comme celles trouv√©es dans** [**Pacu**](https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/user\_agents.txt).

#### R√©sultats de Client Tor

{% hint style="success" %}
La mani√®re la plus simple de contourner cela est simplement de **ne pas utiliser Tor pour se connecter √† AWS** (pourquoi utiliseriez-vous Tor si vous voulez rester discret et simuler le sc√©nario de cr√©dentials compromises ?)
{% endhint %}

Si vous faites une connexion depuis **Tor**, **Guarduty** d√©clenchera l'alerte [**UnauthorizedAccess:EC2/TorClient**](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types-ec2.html#unauthorizedaccess-ec2-torclient)**.**

Guarduty d√©tecte cela gr√¢ce √† une [liste publique de n≈ìuds Tor](https://metrics.torproject.org/exonerator.html).&#x20;

Si vous avez besoin de vous connecter via Tor, vous pouvez **contourner cela en utilisant** [**des Ponts**](https://community.torproject.org/relay/types-of-relays/#Bridge). Mais √©videmment, il serait pr√©f√©rable de ne pas utiliser Tor du tout pour se connecter.

Pour utiliser un pont, vous pouvez utiliser [Obfs4](https://gitlab.com/yawning/obfs4) (`apt install tor obfs4proxy`) et obtenir une adresse de pont depuis [bridges.torproject.org](https://bridges.torproject.org/options).

√Ä partir de l√†, `cr√©ez un fichier torrc` avec quelque chose de similaire √† :
```
UseBridges 1
Bridge obfs4 <IP ADDRESS>:<PORT> <FINGERPRINT> cert=<cert_string> iat-mode=0
ClientTransportPlugin obfs4 exec /bin/obfs4proxy
```
Ex√©cutez `tor -f torrc` et vous pourrez vous connecter au proxy socks5 r√©gulier sur le port 9050.

#### D√©tection de l'exfiltration des identifiants

Si vous **volez des identifiants EC2** depuis le service de m√©tadonn√©es et les utilisez **en dehors de l'infrastructure AWS**, l'alerte [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.OutsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationoutsideaws) est d√©clench√©e.

De plus, si vous **utilisez votre propre instance EC2** pour utiliser les **identifiants vol√©s**, l'alerte [UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration.InsideAWS](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-iam.html#unauthorizedaccess-iam-instancecredentialexfiltrationinsideaws) est d√©clench√©e.

{% hint style="warning" %}
Si vous avez **compromis** une autre machine **EC2** du **m√™me compte**, vous pourriez utiliser les identifiants l√†-bas et **aucune alerte** ne sera g√©n√©r√©e.
{% endhint %}

Cependant, il existe actuellement un contournement fonctionnel pour cela - [VPC Endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints.html). Utiliser **VPC Endpoints** ne **d√©clenchera pas l'alerte GuardDuty**. Cela signifie que, en tant qu'attaquant, `si vous volez des identifiants IAM d'une instance EC2, vous pouvez utiliser ces identifiants depuis votre propre instance EC2 tout en acheminant le trafic via VPC Endpoints. Cela ne d√©clenchera pas la d√©tection GuardDuty`.

L'outil [**SneakyEndpoints**](https://github.com/Frichetten/SneakyEndpoints) a √©t√© cr√©√© pour automatiser ce processus. Ce projet **met en place un environnement d'attaque via Terraform**. Il cr√©era une instance EC2 dans un sous-r√©seau priv√© sans acc√®s internet et cr√©era un certain nombre de VPC Endpoints pour que vous les utilisiez.

**Une autre fa√ßon de contourner cette alerte** est d'utiliser simplement les identifiants vol√©s dans la m√™me machine o√π ils ont √©t√© vol√©s **ou dans une du m√™me compte.**

## R√©f√©rences

* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-pentest/)
* [https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/](https://hackingthe.cloud/aws/avoiding-detection/guardduty-tor-client/)
* [https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/](https://hackingthe.cloud/aws/avoiding-detection/modify-guardduty-config/)
* [https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/](https://hackingthe.cloud/aws/avoiding-detection/steal-keys-undetected/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
