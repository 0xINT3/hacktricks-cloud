# AWS - MSK Enum

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Amazon MSK

Amazon **Managed Streaming for Apache Kafka** (Amazon MSK) est un service enti√®rement g√©r√© qui vous permet de cr√©er et d'ex√©cuter des applications qui utilisent **Apache Kafka pour traiter des donn√©es en continu**. Amazon MSK fournit les op√©rations de plan de contr√¥le, telles que la cr√©ation, la mise √† jour et la suppression de **clusters**.\
Il vous permet d'utiliser les op√©rations de plan de donn√©es Apache **Kafka**, telles que la production et la consommation de donn√©es. Il ex√©cute des versions **open source d'Apache Kafka**. Cela signifie que les applications, les outils et les plugins existants des partenaires et de la **communaut√© Apache Kafka sont pris en charge** sans n√©cessiter de modifications du code d'application.

Amazon MSK **d√©tecte et r√©cup√®re automatiquement les sc√©narios de d√©faillance les plus courants** pour les clusters afin que vos applications productrices et consommatrices puissent continuer leurs op√©rations d'√©criture et de lecture avec un impact minimal. De plus, lorsque cela est possible, il **r√©utilise le stockage** de l'ancien **broker** pour **r√©duire les donn√©es que Apache Kafka doit r√©pliquer.**

### **Types**

Il existe 2 types de clusters Kafka que AWS permet de cr√©er : Provisioned et Serverless.

Du point de vue d'un attaquant, vous devez savoir que :

* **Serverless ne peut pas √™tre directement public** (il ne peut fonctionner que dans un VPN sans aucune adresse IP publique expos√©e). Cependant, **Provisioned** peut √™tre configur√© pour obtenir une **adresse IP publique** (par d√©faut, il n'en a pas) et configurer le **groupe de s√©curit√©** pour **exposer** les ports pertinents.
* **Serverless** ne prend en charge que l'authentification **IAM**. **Provisioned** prend en charge l'authentification SASL/SCRAM (**mot de passe**), l'authentification **IAM**, le gestionnaire de certificats AWS **Certificate** Manager (ACM) et l'acc√®s **non authentifi√©**.
  * Notez qu'il n'est pas possible d'exposer publiquement un Kafka Provisioned si l'acc√®s non authentifi√© est activ√©.

### √ânum√©ration

```bash
#Obtenir les clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# V√©rifier l'authentification prise en charge
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Obtenir les points de terminaison Zookeeper
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Obtenir les n≈ìuds et les points de terminaison des n≈ìuds
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Obtenir les points de terminaison

# Obtenir les configurations kafka utilis√©es
aws kafka list-configurations #Obtenir le fichier de configuration Kafka
aws kafka describe-configuration --arn <config-arn> # Obtenir la version de la configuration
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Obtenir le contenu de la version de configuration

# Si l'authentification SCRAN est utilis√©e, obtenir le nom du secret AWS utilis√© (pas la valeur du secret)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```

### Acc√®s IAM Kafka (en mode serverless)

```bash
# Guide √† partir de https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# T√©l√©charger Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# Dans kafka_2.12-2.8.1/libs, t√©l√©charger le fichier JAR MSK IAM. 
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Cr√©er le fichier client.properties dans kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Exporter les adresses des points de terminaison
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Assurez-vous que vous pourrez acc√©der au port 9098 depuis l'instance EC2 (v√©rifiez les VPS, les sous-r√©seaux et les SG)

# Cr√©er un sujet appel√© msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Envoyer un message pour chaque nouvelle ligne
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Lire les messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```

### Privesc

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### Acc√®s non authentifi√©

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### Persistance

Si vous allez **avoir acc√®s au VPC** o√π se trouve un Kafka Provisioned, vous pouvez **activer l'acc√®s non autoris√©**, si l'authentification **SASL/SCRAM**, **lire** le mot de passe √† partir du secret, donner des **autorisations IAM √† un autre utilisateur contr√¥l√©** (si IAM ou serverless est utilis√©) ou persister avec des **certificats**.

## R√©f√©rences

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://