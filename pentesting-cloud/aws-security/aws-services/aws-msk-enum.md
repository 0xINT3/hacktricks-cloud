# AWS - MSK枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## Amazon MSK

Amazon **Managed Streaming for Apache Kafka**（Amazon MSK）是一项完全托管的服务，使您能够构建和运行使用**Apache Kafka处理流数据**的应用程序。Amazon MSK提供了控制平面操作，例如创建、更新和删除**集群**。\
它允许您使用Apache **Kafka数据平面操作**，例如生产和消费数据。它运行**Apache Kafka的开源版本**。这意味着现有的应用程序、工具和来自合作伙伴和**Apache Kafka社区的插件**都得到支持，而无需更改应用程序代码。

Amazon MSK可以**检测并自动从最常见的故障场景中恢复**，以便您的生产者和消费者应用程序可以继续进行写入和读取操作，对业务影响最小。此外，尽可能地，它会**重用旧的** **broker** 的存储，以**减少Apache Kafka需要复制的数据量**。

### **类型**

AWS允许创建两种类型的Kafka集群：Provisioned（预配置）和Serverless（无服务器）。

从攻击者的角度来看，您需要知道以下内容：

* **Serverless无法直接公开**（只能在没有公开IP的VPN中运行）。然而，**Provisioned**可以配置为获取**公共IP**（默认情况下不会），并配置**安全组**以**公开**相关端口。
* **Serverless仅支持IAM**作为身份验证方法。**Provisioned**支持SASL/SCRAM（**密码**）身份验证、IAM身份验证、AWS **Certificate** Manager（ACM）身份验证和**未经身份验证**的访问。
* 请注意，如果启用了未经身份验证的访问，无法公开暴露Provisioned Kafka

### 枚举
```bash
#Get clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# Check the supported authentication
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Get Zookeeper endpoints
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Get nodes and node enspoints
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Get endpoints

# Get used kafka configs
aws kafka list-configurations #Get Kafka config file
aws kafka describe-configuration --arn <config-arn> # Get version of config
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Get content of config version

# If using SCRAN authentication, get used AWS secret name (not secret value)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```
### Kafka IAM访问（在无服务器环境中）

AWS Managed Streaming for Apache Kafka (MSK) is a fully managed service that makes it easy to build and run applications that use Apache Kafka to process streaming data. When using MSK in a serverless environment, it is important to properly configure IAM access to ensure the security of your Kafka cluster.

#### IAM Roles for MSK

To grant IAM access to MSK, you can create IAM roles with the necessary permissions. These roles can be attached to AWS Lambda functions or other AWS resources that need to interact with the Kafka cluster.

#### Permissions for MSK IAM Roles

The IAM roles for MSK should have the following permissions:

- `kafka:DescribeCluster` - Allows the role to describe the Kafka cluster.
- `kafka:ListClusters` - Allows the role to list all available Kafka clusters.
- `kafka:GetBootstrapBrokers` - Allows the role to get the bootstrap brokers for the Kafka cluster.
- `kafka:Connect` - Allows the role to connect to the Kafka cluster.
- `kafka:Describe*` - Allows the role to describe various Kafka resources, such as topics, configurations, and consumer groups.
- `kafka:Create*` - Allows the role to create various Kafka resources, such as topics and configurations.
- `kafka:Delete*` - Allows the role to delete various Kafka resources, such as topics and configurations.
- `kafka:Alter*` - Allows the role to alter various Kafka resources, such as topics and configurations.
- `kafka:DescribeAcls` - Allows the role to describe the access control lists (ACLs) for the Kafka cluster.
- `kafka:CreateAcls` - Allows the role to create ACLs for the Kafka cluster.
- `kafka:DeleteAcls` - Allows the role to delete ACLs for the Kafka cluster.

#### Example IAM Policy

Here is an example IAM policy that grants the necessary permissions for MSK IAM roles:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kafka:DescribeCluster",
        "kafka:ListClusters",
        "kafka:GetBootstrapBrokers",
        "kafka:Connect",
        "kafka:Describe*",
        "kafka:Create*",
        "kafka:Delete*",
        "kafka:Alter*",
        "kafka:DescribeAcls",
        "kafka:CreateAcls",
        "kafka:DeleteAcls"
      ],
      "Resource": "*"
    }
  ]
}
```

#### Conclusion

Properly configuring IAM access for MSK in a serverless environment is crucial for maintaining the security of your Kafka cluster. By creating IAM roles with the necessary permissions, you can ensure that only authorized resources can interact with your Kafka cluster.
```bash
# Guide from https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# Download Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# In kafka_2.12-2.8.1/libs download the MSK IAM JAR file.
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Create file client.properties in kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Export endpoints address
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Make sure you will be able to access the port 9098 from the EC2 instance (check VPS, subnets and SG)

# Create a topic called msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Send message of every new line
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Read messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```
### 提权

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### 未经身份验证的访问

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### 持久性

如果您将**访问 Provisioned Kafka 所在的 VPC**，您可以**启用未经授权的访问**，如果使用了**SASL/SCRAM 认证**，可以从密钥中**读取**密码，给一些**其他受控用户 IAM 权限**（如果使用了 IAM 或无服务器），或者使用**证书**进行持久化。

## 参考资料

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的**公司广告**，或者如果您想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
