# AWS - MSK Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## Amazon MSK

**Amazon Managed Streaming for Apache Kafka (Amazon MSK)**, **Apache Kafka** üzerinden akış verilerini işleyen uygulamaların geliştirilmesini ve yürütülmesini kolaylaştıran tamamen yönetilen bir hizmettir. Amazon MSK, **kümelerin** oluşturulması, güncellenmesi ve silinmesi gibi kontrol düzlemi işlemlerini sunar.
Hizmet, Apache Kafka **veri düzlemi işlemlerinin** kullanılmasına izin verir, bu da veri üretimi ve tüketimi anlamına gelir. **Apache Kafka**'nın açık kaynak sürümlerinde çalışır ve mevcut uygulamalar, araçlar ve eklentilerle uyumluluğu sağlar, böylece uygulama kodunda değişiklik yapma ihtiyacını ortadan kaldırır.

Güvenilirlik açısından, Amazon MSK, yaygın kümelerin başarısızlık senaryolarını otomatik olarak tespit eder ve kurtarır, böylece üretici ve tüketici uygulamaların veri yazma ve okuma faaliyetlerine kesintisiz devam etmesini sağlar. Ayrıca, Apache Kafka tarafından replike edilmesi gereken veri miktarını en aza indirmek için, değiştirilen brokerların depolama alanını yeniden kullanmaya çalışarak veri replikasyon süreçlerini optimize etmeyi amaçlar.

### **Türler**

AWS'nin oluşturmanıza izin verdiği 2 tür Kafka kümesi vardır: Provisioned ve Serverless.

Saldırganın bakış açısından, şunları bilmelisiniz:

* **Serverless doğrudan halka açık olamaz** (yalnızca herhangi bir halka açık IP'si olmadan bir VPN'de çalışabilir). Bununla birlikte, **Provisioned** bir **genel IP** alacak şekilde yapılandırılabilir (varsayılan olarak alınmaz) ve **güvenlik grubunu** ilgili bağlantı noktalarını **açığa çıkarmak** için yapılandırabilirsiniz.
* **Serverless** yalnızca IAM'ı kimlik doğrulama yöntemi olarak destekler. **Provisioned** SASL/SCRAM (**parola**) kimlik doğrulamasını, **IAM** kimlik doğrulamasını, AWS **Certificate** Manager (ACM) kimlik doğrulamasını ve **Kimliksiz** erişimi destekler.
* Unauthenticated erişimi etkinleştirilmişse, Provisioned Kafka'yı halka açık olarak açığa çıkarmak mümkün değildir.

### Enumerasyon
```bash
#Get clusters
aws kafka list-clusters
aws kafka list-clusters-v2

# Check the supported authentication
aws kafka list-clusters |  jq -r ".ClusterInfoList[].ClientAuthentication"

# Get Zookeeper endpoints
aws kafka list-clusters | jq -r ".ClusterInfoList[].ZookeeperConnectString, .ClusterInfoList[].ZookeeperConnectStringTls"

# Get nodes and node enspoints
aws kafka kafka list-nodes --cluster-arn <cluster-arn>
aws kafka kafka list-nodes --cluster-arn <cluster-arn> | jq -r ".NodeInfoList[].BrokerNodeInfo.Endpoints" # Get endpoints

# Get used kafka configs
aws kafka list-configurations #Get Kafka config file
aws kafka describe-configuration --arn <config-arn> # Get version of config
aws kafka describe-configuration-revision --arn <config-arn> --revision <version> # Get content of config version

# If using SCRAN authentication, get used AWS secret name (not secret value)
aws kafka list-scram-secrets --cluster-arn <cluster-arn>
```
### Kafka IAM Erişimi (sunucusuz)

Kafka, AWS Managed Streaming for Apache Kafka (MSK) hizmeti üzerinde çalışan bir dağıtılmış akış işleme platformudur. Kafka'nın sunucusuz bir ortamda kullanılması durumunda, IAM (Kimlik ve Erişim Yönetimi) rolleri kullanılarak erişim kontrolü sağlanır.

IAM rolleri, Kafka kaynaklarına erişim izinlerini yönetmek için kullanılır. Bu roller, AWS Identity and Access Management (IAM) hizmeti aracılığıyla oluşturulur ve yönetilir. IAM rolleri, Kafka kümelerine erişim sağlamak için gerekli olan izinleri içerir.

IAM rolleri, Kafka kümelerine erişim sağlamak için kullanılan AWS hizmetlerine özgü izinler içerir. Bu izinler, Kafka kümelerinin yönetimi, konfigürasyonu ve veri işleme işlemleri gibi farklı görevleri gerçekleştirmek için gereklidir.

IAM rolleri, AWS Management Console, AWS CLI veya AWS SDK'ları aracılığıyla oluşturulabilir ve yönetilebilir. Bu roller, Kafka kümelerine erişim sağlamak için kullanılan AWS hizmetlerine özgü izinler içerir.

IAM rolleri, Kafka kümelerine erişim sağlamak için kullanılan AWS hizmetlerine özgü izinler içerir. Bu izinler, Kafka kümelerinin yönetimi, konfigürasyonu ve veri işleme işlemleri gibi farklı görevleri gerçekleştirmek için gereklidir.

IAM rolleri, Kafka kümelerine erişim sağlamak için kullanılan AWS hizmetlerine özgü izinler içerir. Bu izinler, Kafka kümelerinin yönetimi, konfigürasyonu ve veri işleme işlemleri gibi farklı görevleri gerçekleştirmek için gereklidir.
```bash
# Guide from https://docs.aws.amazon.com/msk/latest/developerguide/create-serverless-cluster.html
# Download Kafka
wget https://archive.apache.org/dist/kafka/2.8.1/kafka_2.12-2.8.1.tgz
tar -xzf kafka_2.12-2.8.1.tgz

# In kafka_2.12-2.8.1/libs download the MSK IAM JAR file.
cd kafka_2.12-2.8.1/libs
wget https://github.com/aws/aws-msk-iam-auth/releases/download/v1.1.1/aws-msk-iam-auth-1.1.1-all.jar

# Create file client.properties in kafka_2.12-2.8.1/bin
security.protocol=SASL_SSL
sasl.mechanism=AWS_MSK_IAM
sasl.jaas.config=software.amazon.msk.auth.iam.IAMLoginModule required;
sasl.client.callback.handler.class=software.amazon.msk.auth.iam.IAMClientCallbackHandler

# Export endpoints address
export BS=boot-ok2ngypz.c2.kafka-serverless.us-east-1.amazonaws.com:9098
## Make sure you will be able to access the port 9098 from the EC2 instance (check VPS, subnets and SG)

# Create a topic called msk-serverless-tutorial
kafka_2.12-2.8.1/bin/kafka-topics.sh --bootstrap-server $BS --command-config client.properties --create --topic msk-serverless-tutorial --partitions 6

# Send message of every new line
kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list $BS --producer.config client.properties --topic msk-serverless-tutorial

# Read messages
kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server $BS --consumer.config client.properties --topic msk-serverless-tutorial --from-beginning
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-msk-privesc.md" %}
[aws-msk-privesc.md](../aws-privilege-escalation/aws-msk-privesc.md)
{% endcontent-ref %}

### Kimlik Doğrulaması Olmadan Erişim

{% content-ref url="../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md" %}
[aws-msk-unauthenticated-enum.md](../aws-unauthenticated-enum-access/aws-msk-unauthenticated-enum.md)
{% endcontent-ref %}

### Kalıcılık

Eğer bir Provisioned Kafka'nın olduğu VPC'ye **erişiminiz varsa**, **kimlik doğrulaması olmadan erişimi etkinleştirebilirsiniz**, eğer **SASL/SCRAM kimlik doğrulaması** kullanılıyorsa, şifreyi sırdan **okuyabilir**, bazı **diğer kontrol edilebilir kullanıcı IAM izinleri** (eğer IAM veya serverless kullanılıyorsa) verebilir veya **sertifikalarla** kalıcı hale getirebilirsiniz.

## Referanslar

* [https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html](https://docs.aws.amazon.com/msk/latest/developerguide/what-is-msk.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>
