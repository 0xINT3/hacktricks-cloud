# AWS - IAM Enum

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## IAM

IAM hakkında bir **açıklama bulabilirsiniz**:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Enumerasyon

Ana gereken izinler:

* `iam:ListPolicies`, `iam:GetPolicy` ve `iam:GetPolicyVersion`
* `iam:ListRoles`
* `iam:ListUsers`
* `iam:ListGroups`
* `iam:ListGroupsForUser`
* `iam:ListAttachedUserPolicies`
* `iam:ListAttachedRolePolicies`
* `iam:ListAttachedGroupPolicies`
* `iam:ListUserPolicies` ve `iam:GetUserPolicy`
* `iam:ListGroupPolicies` ve `iam:GetGroupPolicy`
* `iam:ListRolePolicies` ve `iam:GetRolePolicy`
```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
## one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user, included permissions boundaries
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role
## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
## attached policies
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerate providers
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Password Policy
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```
### İzinlerin Kaba Kuvvet Saldırısı

Kendi izinlerinizle ilgileniyorsanız ancak IAM sorgulama erişiminiz yoksa her zaman kaba kuvvet saldırısı yapabilirsiniz.

#### bf-aws-permissions

[**bf-aws-permissions**](https://github.com/carlospolop/bf-aws-permissions) aracı, `aws` cli yardım mesajlarını kullanarak bulduğu tüm **`list*`, `describe*`, `get*`** eylemlerini belirtilen profil kullanarak çalıştıran ve **başarılı yürütümleri döndüren** bir bash betiğidir.

{% code overflow="wrap" %}
```bash
# Bruteforce permissions
bash bf-aws-permissions.sh -p default > /tmp/bf-permissions-verbose.txt
```
{% endcode %}

#### bf-aws-perms-simulate

[**bf-aws-perms-simulate**](https://github.com/carlospolop/bf-aws-perms-simulate) aracı, **`iam:SimulatePrincipalPolicy`** iznine sahipseniz mevcut izinlerinizi (veya diğer prensiplerin izinlerini) bulabilir.
```bash
# Ask for permissions
python3 aws_permissions_checker.py --profile <AWS_PROFILE> [--arn <USER_ARN>]
```
#### Perms2ManagedPolicies

Eğer **kullanıcınızın bazı izinlere sahip olduğunu** ve bunların özel bir rol tarafından değil de bir **yönetilen AWS rolü tarafından verildiğini düşünüyorsanız**. Keşfettiğiniz izinleri veren tüm **AWS yönetilen rollerini kontrol etmek için** [**aws-Perms2ManagedPolicies**](https://github.com/carlospolop/aws-Perms2ManagedPolicies) aracını kullanabilirsiniz.

{% code overflow="wrap" %}
```bash
# Run example with my profile
python3 aws-Perms2ManagedPolicies.py --profile myadmin --permissions-file example-permissions.txt
```
{% endcode %}

{% hint style="warning" %}
Eğer sahip olduğunuz izinlerin AWS tarafından yönetilen bir rol tarafından verilip verilmediğini "bilmek" mümkündür, örneğin **kullanılmayan hizmetler üzerinde izinlere sahipseniz**.
{% endhint %}

#### Cloudtrail2IAM

[**CloudTrail2IAM**](https://github.com/carlospolop/Cloudtrail2IAM), herkesin veya sadece belirli bir kullanıcının veya rolün yaptığı eylemleri çıkarmak ve özetlemek için **AWS CloudTrail günlüklerini analiz eden bir Python aracıdır**. Aracı, belirtilen kovetten her cloudtrail günlüğünü **açacak**.

{% code overflow="wrap" %}
```bash
git clone https://github.com/carlospolop/Cloudtrail2IAM
cd Cloudtrail2IAM
pip install -r requirements.txt
python3 cloudtrail2IAM.py --prefix PREFIX --bucket_name BUCKET_NAME --profile PROFILE [--filter-name FILTER_NAME] [--threads THREADS]
```
{% endcode %}

{% hint style="warning" %}
Eğer .tfstate (Terraform durum dosyaları) veya CloudFormation dosyaları bulursanız (genellikle cf-templates ön ekiyle bir kovada bulunan yaml dosyalarıdır), bunları okuyarak aws yapılandırmasını bulabilir ve hangi izinlerin kime atandığını bulabilirsiniz.
{% endhint %}

#### enumerate-iam

[**https://github.com/andresriancho/enumerate-iam**](https://github.com/andresriancho/enumerate-iam) aracını kullanmak için öncelikle tüm API AWS uç noktalarını indirmeniz gerekmektedir, ardından **"list\_", "describe\_", ve "get\_" uç noktalarını** alacak olan **"generate_bruteforce_tests.py"** betiği çalıştırılır. Son olarak, verilen kimlik bilgileriyle bu uç noktalara **erişmeye çalışır** ve çalışıp çalışmadığını belirtir.

(Deneyimime göre, **araç bazen takılıyor**, bunu düzeltmek için [**bu düzeltmeyi**](https://github.com/andresriancho/enumerate-iam/pull/15/commits/77ad5b41216e3b5f1511d0c385da8cd5984c2d3c) deneyebilirsiniz).

{% hint style="warning" %}
Deneyimime göre, bu araç öncekine benzer ancak daha kötü çalışıyor ve daha az izin kontrol ediyor.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Install tool
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt

# Download API endpoints
cd enumerate_iam/
git clone https://github.com/aws/aws-sdk-js.git
python3 generate_bruteforce_tests.py
rm -rf aws-sdk-js
cd ..

# Enumerate permissions
python3 enumerate-iam.py --access-key ACCESS_KEY --secret-key SECRET_KEY [--session-token SESSION_TOKEN] [--region REGION]
```
{% endcode %}

#### weirdAAL

Ayrıca [**weirdAAL**](https://github.com/carnal0wnage/weirdAAL/wiki) adlı aracı da kullanabilirsiniz. Bu araç, **birkaç yaygın hizmette birkaç yaygın işlemi kontrol eder** (bazı numaralandırma izinlerini ve bazı ayrıcalık yükseltme izinlerini kontrol eder). Ancak, sadece kodlanmış kontrolleri kontrol eder (daha fazla şey kontrol etmek için daha fazla test kodlamak tek yol).
```bash
# Install
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>

# Setup DB
python3 create_dbs.py

# Invoke it
python3 weirdAAL.py -m ec2_describe_instances -t ec2test # Just some ec2 tests
python3 weirdAAL.py -m recon_all -t MyTarget # Check all permissions
# You will see output such as:
# [+] elbv2 Actions allowed are [+]
# ['DescribeLoadBalancers', 'DescribeAccountLimits', 'DescribeTargetGroups']
```
#### İzinleri Kaba Kuvvet Saldırılarına Karşı Güçlendirme Araçları

{% tabs %}
{% tab title="CloudSploit" %}
{% code overflow="wrap" %}
```bash
# Export env variables
./index.js --console=text --config ./config.js --json /tmp/out-cloudsploit.json

# Filter results removing unknown
jq 'map(select(.status | contains("UNKNOWN") | not))' /tmp/out-cloudsploit.json | jq 'map(select(.resource | contains("N/A") | not))' > /tmp/out-cloudsploit-filt.json

# Get services by regions
jq 'group_by(.region) | map({(.[0].region): ([map((.resource | split(":"))[2]) | unique])})' ~/Desktop/pentests/cere/greybox/core-dev-dev-cloudsploit-filtered.json
```
{% endcode %}
{% endtab %}

{% tab title="SteamPipe" %}
```bash
# https://github.com/turbot/steampipe-mod-aws-insights
steampipe check all --export=json

# https://github.com/turbot/steampipe-mod-aws-perimeter
# In this case you cannot output to JSON, so heck it in the dashboard
steampipe dashboard
```
{% endtab %}
{% endtabs %}

#### \<YourTool>

Önceki araçlardan hiçbiri tüm izinleri kontrol etme yeteneğine sahip değildir, bu yüzden daha iyi bir araç biliyorsanız bir PR gönderin!

## Kimlik Doğrulamasız Erişim

{% content-ref url="../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md" %}
[aws-iam-and-sts-unauthenticated-enum.md](../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md)
{% endcontent-ref %}

### Ayrıcalık Yükseltme

Aşağıdaki sayfada, **IAM izinlerini kötüye kullanarak ayrıcalıkları yükseltmenin** nasıl yapılacağını kontrol edebilirsiniz:

{% content-ref url="../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### IAM Sonrası Sızma

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md" %}
[aws-iam-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md)
{% endcontent-ref %}

### IAM Kalıcılığı

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## IAM Kimlik Merkezi

IAM Kimlik Merkezi'nin bir **açıklamasını burada** bulabilirsiniz:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### CLI ile SSO ile Bağlanma
```bash
# Connect with sso via CLI aws configure sso
aws configure sso

[profile profile_name]
sso_start_url = https://subdomain.awsapps.com/start/
sso_account_id = <account_numbre>
sso_role_name = AdministratorAccess
sso_region = us-east-1
```
### Sorgulama

Kimlik Merkezi'nin ana unsurları şunlardır:

* Kullanıcılar ve gruplar
* İzin Setleri: İliştirilmiş politikaları vardır
* AWS Hesapları

Ardından, ilişkiler oluşturulur, böylece kullanıcılar/gruplar AWS Hesabı üzerinde İzin Setlerine sahip olurlar.

{% hint style="info" %}
Unutmayın, İzin Setine politikaları iliştirmenin 3 yolu vardır. AWS tarafından yönetilen politikaları iliştirmek, Müşteri tarafından yönetilen politikalar (bu politikalar, İzin Setinin etkilediği tüm hesaplarda oluşturulmalıdır) ve iç içe politikalar (burada tanımlanır).
{% endhint %}
```bash
# Check if IAM Identity Center is used
aws sso-admin list-instances

# Get Permissions sets. These are the policies that can be assigned
aws sso-admin list-permission-sets --instance-arn <instance-arn>
aws sso-admin describe-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Get managed policies of a permission set
aws sso-admin list-managed-policies-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get inline policies of a permission set
aws sso-admin get-inline-policy-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get customer managed policies of a permission set
aws sso-admin list-customer-managed-policy-references-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get boundaries of a permission set
aws sso-admin get-permissions-boundary-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## List accounts a permission set is affecting
aws sso-admin list-accounts-for-provisioned-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## List principals given a permission set in an account
aws sso-admin list-account-assignments --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --account-id <account_id>

# Get permissions sets affecting an account
aws sso-admin list-permission-sets-provisioned-to-account --instance-arn <instance-arn> --account-id <account_id>

# List users & groups from the identity store
aws identitystore list-users --identity-store-id <store-id>
aws identitystore list-groups --identity-store-id <store-id>
## Get members of groups
aws identitystore list-group-memberships --identity-store-id <store-id> --group-id <group-id>
## Get memberships or a user or a group
aws identitystore list-group-memberships-for-member --identity-store-id <store-id> --member-id <member-id>
```
### Yerel Saptama

SSO üzerinden erişilebilen profilleri yapılandırmak için `$HOME/.aws` klasörü içinde config dosyası oluşturmak mümkündür. Örneğin:
```ini
[default]
region = us-west-2
output = json

[profile my-sso-profile]
sso_start_url = https://my-sso-portal.awsapps.com/start
sso_region = us-west-2
sso_account_id = 123456789012
sso_role_name = MySSORole
region = us-west-2
output = json

[profile dependent-profile]
role_arn = arn:aws:iam::<acc-id>:role/ReadOnlyRole
source_profile = Hacktricks-Admin
```
Bu yapılandırma aşağıdaki komutlarla kullanılabilir:
```bash
# Login in ms-sso-profile
aws sso login --profile my-sso-profile
# Use dependent-profile
aws s3 ls --profile dependent-profile
```
Bir **SSO profili kullanıldığında**, kimlik bilgileri **`$HOME/.aws/sso/cache`** klasöründe bir dosyada önbelleğe alınır. Bu nedenle, oradan **okunabilir ve kullanılabilir**.

Ayrıca, **daha fazla kimlik bilgisi** **`$HOME/.aws/cli/cache`** klasöründe saklanabilir. Bu önbellek dizini, IAM kullanıcı kimlik bilgilerini kullanan veya IAM üzerinden rolleri **assume** eden AWS CLI profilleriyle çalışırken kullanılır. Örnek yapılandırma:
```ini
[profile crossaccountrole]
role_arn = arn:aws:iam::234567890123:role/SomeRole
source_profile = default
mfa_serial = arn:aws:iam::123456789012:mfa/saanvi
external_id = 123456
```
### Privesc

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md" %}
[aws-sso-and-identitystore-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md" %}
[aws-sso-and-identitystore-post-exploitation.md](../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md)
{% endcontent-ref %}

### Kalıcılık

#### Bir kullanıcı oluşturun ve ona izinler atayın

{% code overflow="wrap" %}
```bash
# Create user identitystore:CreateUser
aws identitystore create-user --identity-store-id <store-id> --user-name privesc --display-name privesc --emails Value=sdkabflvwsljyclpma@tmmbt.net,Type=Work,Primary=True --name Formatted=privesc,FamilyName=privesc,GivenName=privesc
## After creating it try to login in the console using the selected username, you will receive an email with the code and then you will be able to select a password
```
{% endcode %}

* Bir grup oluşturun ve ona izinler atayın ve üzerine kontrol edilen bir kullanıcı tanımlayın.
* Kontrol edilen bir kullanıcı veya gruba ek izinler verin.
*   Varsayılan olarak, yalnızca Yönetim Hesabı'ndan izinlere sahip kullanıcılar IAM Kimlik Merkezi'ne erişebilir ve kontrol edebilir.

Ancak, Delegate Administrator aracılığıyla farklı bir hesaptan kullanıcıların bunu yönetmesine izin vermek mümkündür. Tam olarak aynı izinlere sahip olmayacaklar, ancak [**yönetim faaliyetlerini**](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html) gerçekleştirebileceklerdir.

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR göndererek paylaşın.

</details>
