# AWS - Enumera√ß√£o do IAM

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **reposit√≥rios do github.**

</details>

## IAM

Voc√™ pode encontrar uma **descri√ß√£o do IAM** em:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Enumera√ß√£o

Principais permiss√µes necess√°rias:

* `iam:ListPolicies`, `iam:GetPolicy` e `iam:GetPolicyVersion`
* `iam:ListRoles`
* `iam:ListUsers`
* `iam:ListGroups`
* `iam:ListGroupsForUser`
* `iam:ListAttachedUserPolicies`
* `iam:ListAttachedRolePolicies`
* `iam:ListAttachedGroupPolicies`
* `iam:ListUserPolicies` e `iam:GetUserPolicy`
* `iam:ListGroupPolicies` e `iam:GetGroupPolicy`
* `iam:ListRolePolicies` e `iam:GetRolePolicy`

```bash
# Todos os IAMs
## Recupera informa√ß√µes sobre todos os usu√°rios, grupos, fun√ß√µes e pol√≠ticas do IAM
## em sua conta da Amazon Web Services, incluindo seus relacionamentos entre si.
## Use esta opera√ß√£o para obter uma imagem instant√¢nea da configura√ß√£o das permiss√µes do IAM
## (usu√°rios, grupos, fun√ß√µes e pol√≠ticas) em sua conta.
aws iam get-account-authorization-details

# Listar usu√°rios
aws iam list-users
aws iam list-ssh-public-keys #Chaves de usu√°rio para o CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Obter chave p√∫blica com metadados
aws iam list-service-specific-credentials #Obter permiss√µes especiais do usu√°rio IAM sobre servi√ßos espec√≠ficos
aws iam get-user --user-name <username> #Obter metadados do usu√°rio, incluindo limites de permiss√µes
aws iam list-access-keys #Listar chaves de acesso criadas
## pol√≠ticas inline
aws iam list-user-policies --user-name <username> #Obter pol√≠ticas inline do usu√°rio
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Obter detalhes da pol√≠tica inline
## pol√≠ticas anexadas
aws iam list-attached-user-policies --user-name <username> #Obter pol√≠ticas do usu√°rio, n√£o obt√©m pol√≠ticas inline

# Listar grupos
aws iam list-groups #Obter grupos
aws iam list-groups-for-user --user-name <username> #Obter grupos de um usu√°rio
aws iam get-group --group-name <name> #Obter informa√ß√µes do nome do grupo
## pol√≠ticas inline
aws iam list-group-policies --group-name <username> #Obter pol√≠ticas inline do grupo
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Obter informa√ß√µes de uma pol√≠tica inline
## pol√≠ticas anexadas
aws iam list-attached-group-policies --group-name <name> #Obter pol√≠ticas do grupo, n√£o obt√©m pol√≠ticas inline

# Listar fun√ß√µes
aws iam list-roles #Obter fun√ß√µes
aws iam get-role --role-name <role-name> #Obter fun√ß√£o

## pol√≠ticas inline
aws iam list-role-policies --role-name <name> #Obter pol√≠ticas inline de uma fun√ß√£o
aws iam get-role-policy --role-name <name> --policy-name <name> #Obter detalhes de uma pol√≠tica inline
aws iam list-attached-role-policies --role-name <role-name> #Obter pol√≠ticas da fun√ß√£o, n√£o obt√©m pol√≠ticas inline

# Listar pol√≠ticas
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> #Obter lista de pol√≠ticas que d√£o acesso ao usu√°rio ao servi√ßo
## Obter conte√∫do da pol√≠tica
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerar provedores
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Pol√≠tica de senha
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```

### Brute Force de Permiss√µes

Se voc√™ est√° interessado em suas pr√≥prias permiss√µes, mas n√£o tem acesso para consultar o IAM, voc√™ sempre pode for√ß√°-las.

#### bf-aws-permissions

A ferramenta [**bf-aws-permissions**](https://github.com/carlospolop/bf-aws-permissions) √© apenas um script bash que ser√° executado usando o perfil indicado todas as a√ß√µes **`list*`, `describe*`, `get*`** que ele pode encontrar usando as mensagens de ajuda do cli `aws` e **retornar√° as execu√ß√µes bem-sucedidas**.

{% code overflow="wrap" %}
```bash
# For√ßar permiss√µes
bash bf-aws-permissions.sh -p default > /tmp/bf-permissions-verbose.txt
```
{% endcode %}

#### bf-aws-perms-simulate

A ferr
# Exportar vari√°veis de ambiente
./index.js --console=text --config ./config.js --json /tmp/out-cloudsploit.json

# Filtrar resultados removendo desconhecidos
jq 'map(select(.status | contains("UNKNOWN") | not))' /tmp/out-cloudsploit.json | jq 'map(select(.resource | contains("N/A") | not))' > /tmp/out-cloudsploit-filt.json

# Obter servi√ßos por regi√µes
jq 'group_by(.region) | map({(.[0].region): ([map((.resource | split(":"))[2]) | unique])})' ~/Desktop/pentests/cere/greybox/core-dev-dev-cloudsploit-filtered.json

{% tab title="SteamPipe" %}
```bash
# https://github.com/turbot/steampipe-mod-aws-insights
steampipe check all --export=json

# https://github.com/turbot/steampipe-mod-aws-perimeter
# Neste caso, n√£o √© poss√≠vel gerar sa√≠da em JSON, ent√£o verifique no painel
steampipe dashboard
```
{% endtab %}
{% endtabs %}

#### \<YourTool>

Nenhum dos ferramentas anteriores √© capaz de verificar perto de todas as permiss√µes, ent√£o se voc√™ conhece uma ferramenta melhor, envie um PR!

## Acesso n√£o autenticado

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes IAM para escalar privil√©gios**:

{% content-ref url="../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md" %}
[aws-iam-and-sts-unauthenticated-enum.md](../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md)
{% endcontent-ref %}

### Escalada de privil√©gios

Na p√°gina a seguir, voc√™ pode verificar como **abusar das permiss√µes IAM para escalar privil√©gios**:

{% content-ref url="../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### P√≥s-explora√ß√£o IAM

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md" %}
[aws-iam-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia IAM

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## Centro de identidade IAM

Voc√™ pode encontrar uma **descri√ß√£o do Centro de identidade IAM** em:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### Conectar via SSO com CLI

```bash
# Conectar com sso via CLI aws configure sso
aws configure sso

[profile profile_name]
sso_start_url = https://subdomain.awsapps.com/start/
sso_account_id = <account_numbre>
sso_role_name = AdministratorAccess
sso_region = us-east-1
```

### Enumera√ß√£o

Os principais elementos do Centro de identidade s√£o:

* Usu√°rios e grupos
* Conjuntos de permiss√µes: t√™m pol√≠ticas anexadas
* Contas AWS

Em seguida, s√£o criados relacionamentos para que usu√°rios/grupos tenham conjuntos de permiss√µes sobre a conta AWS.

{% hint style="info" %}
Observe que existem 3 maneiras de anexar pol√≠ticas a um conjunto de permiss√µes. Anexando pol√≠ticas gerenciadas pela AWS, pol√≠ticas gerenciadas pelo cliente (essas pol√≠ticas precisam ser criadas em todas as contas que o conjunto de permiss√µes est√° afetando) e pol√≠ticas inline (definidas l√°).
{% endhint %}

```bash
# Verificar se o Centro de identidade IAM √© usado
aws sso-admin list-instances

# Obter conjuntos de permiss√µes. Essas s√£o as pol√≠ticas que podem ser atribu√≠das
aws sso-admin list-permission-sets --instance-arn <instance-arn>
aws sso-admin describe-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Obter pol√≠ticas gerenciadas de um conjunto de permiss√µes
aws sso-admin list-managed-policies-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Obter pol√≠ticas inline de um conjunto de permiss√µes
aws sso-admin get-inline-policy-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Obter pol√≠ticas gerenciadas pelo cliente de um conjunto de permiss√µes
aws sso-admin list-customer-managed-policy-references-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Obter limites de um conjunto de permiss√µes
aws sso-admin get-permissions-boundary-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Listar contas que um conjunto de permiss√µes est√° afetando
aws sso-admin list-accounts-for-provisioned-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Listar princ√≠pios dados um conjunto de permiss√µes em uma conta
aws sso-admin list-account-assignments --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --account-id <account_id>

# Obter conjuntos de permiss√µes afetando uma conta
aws sso-admin list-permission-sets-provisioned-to-account --instance-arn <instance-arn> --account-id <account_id>

# Listar usu√°rios e grupos do armazenamento de identidade
aws identitystore list-users --identity-store-id <store-id>
aws identitystore list-groups --identity-store-id <store-id>
## Obter membros de grupos
aws identitystore list-group-memberships --identity-store-id <store-id> --group-id <group-id>
## Obter associa√ß√µes de um usu√°rio ou grupo
aws identitystore list-group-memberships-for-member --identity-store-id <store-id> --member-id <member-id>
```

### Escalada de privil√©gios

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md" %}
[aws-sso-and-identitystore-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md)
{% endcontent-ref %}

### P√≥s-explora√ß√£o

{% content-ref url="../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md" %}
[aws-sso-and-identitystore-post-exploitation.md](../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md)
{% endcontent-ref %}

### Persist√™ncia

#### Criar um usu√°rio e atribuir permiss√µes a ele

{% code overflow="wrap" %}
```bash
# Criar usu√°rio identitystore:CreateUser
aws identitystore create-user --identity-store-id <store-id> --user-name privesc --display-name privesc --emails Value=sdkabflvwsljyclpma@tmmbt.net,Type=Work,Primary=True --name Formatted=privesc,FamilyName=privesc,GivenName=privesc
## Depois de cri√°-lo, tente fazer login no console usando o nome de usu√°rio selecionado, voc√™ receber√° um e-mail com o c√≥digo e poder√° selecionar uma senha
```
{% endcode %}

* Criar um grupo e atribuir permiss√µes a ele e definir um usu√°rio controlado nele
* Dar permiss√µes extras a um usu√°rio ou grupo controlado
* Por padr√£o, apenas usu√°rios com permiss√µes da conta de gerenciamento poder√£o acessar e controlar o IAM Identity Center.

No entanto, √© poss√≠vel, por meio do Administrador delegado, permitir que usu√°rios de uma conta diferente o gerenciem. Eles n√£o ter√£o exatamente as mesmas permiss√µes, mas poder√£o realizar [**atividades de gerenciamento**](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html).