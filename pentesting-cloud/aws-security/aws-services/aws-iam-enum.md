# AWS - –ü–µ—Ä–µ–ª—ñ–∫ IAM

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—ñ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub**.

</details>

## IAM

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–æ–ø–∏—Å IAM** –≤:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### –ï–Ω—É–º–µ—Ä–∞—Ü—ñ—è

–û—Å–Ω–æ–≤–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ:

* `iam:ListPolicies`, `iam:GetPolicy` —Ç–∞ `iam:GetPolicyVersion`
* `iam:ListRoles`
* `iam:ListUsers`
* `iam:ListGroups`
* `iam:ListGroupsForUser`
* `iam:ListAttachedUserPolicies`
* `iam:ListAttachedRolePolicies`
* `iam:ListAttachedGroupPolicies`
* `iam:ListUserPolicies` —Ç–∞ `iam:GetUserPolicy`
* `iam:ListGroupPolicies` —Ç–∞ `iam:GetGroupPolicy`
* `iam:ListRolePolicies` —Ç–∞ `iam:GetRolePolicy`
```bash
# All IAMs
## Retrieves  information about all IAM users, groups, roles, and policies
## in your Amazon Web Services account, including their relationships  to
## one another. Use this operation to obtain a snapshot of the configura-
## tion of IAM permissions (users, groups, roles, and  policies)  in  your
## account.
aws iam get-account-authorization-details

# List users
aws iam list-users
aws iam list-ssh-public-keys #User keys for CodeCommit
aws iam get-ssh-public-key --user-name <username> --ssh-public-key-id <id> --encoding SSH #Get public key with metadata
aws iam list-service-specific-credentials #Get special permissions of the IAM user over specific services
aws iam get-user --user-name <username> #Get metadata of user, included permissions boundaries
aws iam list-access-keys #List created access keys
## inline policies
aws iam list-user-policies --user-name <username> #Get inline policies of the user
aws iam get-user-policy --user-name <username> --policy-name <policyname> #Get inline policy details
## attached policies
aws iam list-attached-user-policies --user-name <username> #Get policies of user, it doesn't get inline policies

# List groups
aws iam list-groups #Get groups
aws iam list-groups-for-user --user-name <username> #Get groups of a user
aws iam get-group --group-name <name> #Get group name info
## inline policies
aws iam list-group-policies --group-name <username> #Get inline policies of the group
aws iam get-group-policy --group-name <username> --policy-name <policyname> #Get an inline policy info
## attached policies
aws iam list-attached-group-policies --group-name <name> #Get policies of group, it doesn't get inline policies

# List roles
aws iam list-roles #Get roles
aws iam get-role --role-name <role-name> #Get role
## inline policies
aws iam list-role-policies --role-name <name> #Get inline policies of a role
aws iam get-role-policy --role-name <name> --policy-name <name> #Get inline policy details
## attached policies
aws iam list-attached-role-policies --role-name <role-name> #Get policies of role, it doesn't get inline policies

# List policies
aws iam list-policies [--only-attached] [--scope Local]
aws iam list-policies-granting-service-access --arn <identity> --service-namespaces <svc> # Get list of policies that give access to the user to the service
## Get policy content
aws iam get-policy --policy-arn <policy_arn>
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn:aws:iam::975426262029:policy/list_apigateways> --version-id <VERSION_X>

# Enumerate providers
aws iam list-saml-providers
aws iam get-saml-provider --saml-provider-arn <ARN>
aws iam list-open-id-connect-providers
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>

# Password Policy
aws iam get-account-password-policy

# MFA
aws iam list-mfa-devices
aws iam list-virtual-mfa-devices
```
### –ü–µ—Ä–µ–±—ñ—Ä –¥–æ–∑–≤–æ–ª—ñ–≤

–Ø–∫—â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–ª—è—Ç—å –≤–∞—à—ñ –≤–ª–∞—Å–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, –∞–ª–µ —É –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∑–∞–ø–∏—Ç—É IAM, –≤–∏ –∑–∞–≤–∂–¥–∏ –º–æ–∂–µ—Ç–µ —ó—Ö –ø–µ—Ä–µ–±—Ä–∞—Ç–∏.

#### bf-aws-permissions

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**bf-aws-permissions**](https://github.com/carlospolop/bf-aws-permissions) - —Ü–µ –ø—Ä–æ—Å—Ç–æ —Å—Ü–µ–Ω–∞—Ä—ñ–π –æ–±–æ–ª–æ–Ω–∫–∏ bash, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –≤—Å—ñ –¥—ñ—ó **`list*`, `describe*`, `get*`**, —è–∫—ñ –≤—ñ–Ω –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –¥–æ–ø–æ–º—ñ–∂–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è `aws` cli —Ç–∞ **–ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ —É—Å–ø—ñ—à–Ω—ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**.

{% code overflow="wrap" %}
```bash
# Bruteforce permissions
bash bf-aws-permissions.sh -p default > /tmp/bf-permissions-verbose.txt
```
#### bf-aws-perms-simulate

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**bf-aws-perms-simulate**](https://github.com/carlospolop/bf-aws-perms-simulate) –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏ –≤–∞—à—ñ –ø–æ—Ç–æ—á–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ (–∞–±–æ —Ç—ñ, —è–∫—ñ –Ω–∞–ª–µ–∂–∞—Ç—å —ñ–Ω—à–∏–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞–º), —è–∫—â–æ —É –≤–∞—Å —î –¥–æ–∑–≤—ñ–ª **`iam:SimulatePrincipalPolicy`**.
```bash
# Ask for permissions
python3 aws_permissions_checker.py --profile <AWS_PROFILE> [--arn <USER_ARN>]
```
#### Perms2ManagedPolicies

–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π—à–ª–∏ **–¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –≤–∞—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, —ñ –≤–∏ –≤–≤–∞–∂–∞—î—Ç–µ, —â–æ –≤–æ–Ω–∏ –Ω–∞–¥–∞—é—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **—É–ø—Ä–∞–≤–ª—è—î–º–æ—ó —Ä–æ–ª—ñ AWS** (–∞ –Ω–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–æ—ó). –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**aws-Perms2ManagedRoles**](https://github.com/carlospolop/aws-Perms2ManagedPolicies) –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤—Å—ñ—Ö **—É–ø—Ä–∞–≤–ª—è—î–º–∏—Ö —Ä–æ–ª–µ–π AWS, —è–∫—ñ –Ω–∞–¥–∞—é—Ç—å –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –≤–∏ –≤–∏—è–≤–∏–ª–∏, —â–æ —É –≤–∞—Å —î**.

{% code overflow="wrap" %}
```bash
# Run example with my profile
python3 aws-Perms2ManagedPolicies.py --profile myadmin --permissions-file example-permissions.txt
```
{% endcode %}

{% hint style="warning" %}
–ú–æ–∂–ª–∏–≤–æ "–∑–Ω–∞—Ç–∏", —è–∫—â–æ –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –≤–∏ –º–∞—î—Ç–µ, –Ω–∞–¥–∞–Ω—ñ –∫–µ—Ä–æ–≤–∞–Ω–æ—é —Ä–æ–ª–ª—é AWS, —è–∫—â–æ –≤–∏ –±–∞—á–∏—Ç–µ, —â–æ **–≤–∏ –º–∞—î—Ç–µ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ —Å–µ—Ä–≤—ñ—Å–∏, —è–∫—ñ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è**, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥.
{% endhint %}

#### Cloudtrail2IAM

[**CloudTrail2IAM**](https://github.com/carlospolop/Cloudtrail2IAM) - —Ü–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–∞ Python, —è–∫–∏–π –∞–Ω–∞–ª—ñ–∑—É—î **–∂—É—Ä–Ω–∞–ª–∏ CloudTrail AWS –¥–ª—è –≤–∏–ª—É—á–µ–Ω–Ω—è —Ç–∞ —É–∑–∞–≥–∞–ª—å–Ω–µ–Ω–Ω—è –¥—ñ–π**, –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö –∫–æ–∂–Ω–∏–º –∞–±–æ –ª–∏—à–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –∞–±–æ —Ä–æ–ª–ª—é. –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç **—Ä–æ–∑–±–µ—Ä–µ –∫–æ–∂–µ–Ω –∂—É—Ä–Ω–∞–ª cloudtrail –∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –∫–æ—à–∏–∫–∞**.

{% code overflow="wrap" %}
```bash
git clone https://github.com/carlospolop/Cloudtrail2IAM
cd Cloudtrail2IAM
pip install -r requirements.txt
python3 cloudtrail2IAM.py --prefix PREFIX --bucket_name BUCKET_NAME --profile PROFILE [--filter-name FILTER_NAME] [--threads THREADS]
```
{% endcode %}

{% hint style="warning" %}
–Ø–∫—â–æ –≤–∏ –∑–Ω–∞–π–¥–µ—Ç–µ .tfstate (—Ñ–∞–π–ª–∏ —Å—Ç–∞–Ω—É Terraform) –∞–±–æ —Ñ–∞–π–ª–∏ CloudFormation (–∑–∞–∑–≤–∏—á–∞–π —Ü–µ —Ñ–∞–π–ª–∏ yaml, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –≤—ñ–¥—Ä–∞ –∑ –ø—Ä–µ—Ñ—ñ–∫—Å–æ–º cf-templates), –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ —ó—Ö –ø—Ä–æ—á–∏—Ç–∞—Ç–∏, —â–æ–± –∑–Ω–∞–π—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é aws —Ç–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏, —è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –±—É–ª–∏ –Ω–∞–¥–∞–Ω—ñ –∫–æ–º—É.
{% endhint %}

#### enumerate-iam

–î–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É [**https://github.com/andresriancho/enumerate-iam**](https://github.com/andresriancho/enumerate-iam) —Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏ API AWS, –∑ —è–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç **`generate_bruteforce_tests.py`** –æ—Ç—Ä–∏–º–∞—î –≤—Å—ñ **–∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏ "list\_", "describe\_" —Ç–∞ "get\_".** –Ü, –Ω–∞—Ä–µ—à—Ç—ñ, –≤—ñ–Ω —Å–ø—Ä–æ–±—É—î **–æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ –Ω–∏—Ö –¥–æ—Å—Ç—É–ø** –∑–∞ –≤–∫–∞–∑–∞–Ω–∏–º–∏ –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –¥–∞–Ω–∏–º–∏ —Ç–∞ **–≤–∫–∞–∑–∞—Ç–∏, —è–∫—â–æ —Ü–µ –ø—Ä–∞—Ü—é—î**.

(–ó–∞ –º–æ—î—é –¥—É–º–∫–æ—é, **—ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è –Ω–∞ –ø–µ–≤–Ω–æ–º—É –µ—Ç–∞–ø—ñ**, [**–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**](https://github.com/andresriancho/enumerate-iam/pull/15/commits/77ad5b41216e3b5f1511d0c385da8cd5984c2d3c), —â–æ–± —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ —Ü–µ).

{% hint style="warning" %}
–ó–∞ –º–æ—î—é –¥—É–º–∫–æ—é, —Ü–µ–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å—Ö–æ–∂–∏–π –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π, –∞–ª–µ –ø—Ä–∞—Ü—é—î –≥—ñ—Ä—à–µ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –º–µ–Ω—à–µ –¥–æ–∑–≤–æ–ª—ñ–≤.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Install tool
git clone git@github.com:andresriancho/enumerate-iam.git
cd enumerate-iam/
pip install -r requirements.txt

# Download API endpoints
cd enumerate_iam/
git clone https://github.com/aws/aws-sdk-js.git
python3 generate_bruteforce_tests.py
rm -rf aws-sdk-js
cd ..

# Enumerate permissions
python3 enumerate-iam.py --access-key ACCESS_KEY --secret-key SECRET_KEY [--session-token SESSION_TOKEN] [--region REGION]
```
{% endcode %}

#### weirdAAL

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [**weirdAAL**](https://github.com/carnal0wnage/weirdAAL/wiki). –¶–µ–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å **–∫—ñ–ª—å–∫–∞ –∑–∞–≥–∞–ª—å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –Ω–∞ –∫—ñ–ª—å–∫–æ—Ö –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Å–µ—Ä–≤—ñ—Å–∞—Ö** (–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –ø–µ—Ä–µ–ª—ñ–∫ —Ç–∞ –¥–µ—è–∫—ñ –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤). –ê–ª–µ –≤—ñ–Ω –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –ª–∏—à–µ –∑–∞–∫–æ–¥–æ–≤–∞–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (—î–¥–∏–Ω–∏–π —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –±—ñ–ª—å—à–µ —Ä–µ—á–µ–π - —Ü–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ –±—ñ–ª—å—à–µ —Ç–µ—Å—Ç—ñ–≤).
```bash
# Install
git clone https://github.com/carnal0wnage/weirdAAL.git
cd weirdAAL
python3 -m venv weirdAAL
source weirdAAL/bin/activate
pip3 install -r requirements.txt

# Create a .env file with aws credentials such as
[default]
aws_access_key_id = <insert key id>
aws_secret_access_key = <insert secret key>

# Setup DB
python3 create_dbs.py

# Invoke it
python3 weirdAAL.py -m ec2_describe_instances -t ec2test # Just some ec2 tests
python3 weirdAAL.py -m recon_all -t MyTarget # Check all permissions
# You will see output such as:
# [+] elbv2 Actions allowed are [+]
# ['DescribeLoadBalancers', 'DescribeAccountLimits', 'DescribeTargetGroups']
```
#### –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–º—ñ—Ü–Ω–µ–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–±–æ—Ä—É –¥–æ–∑–≤–æ–ª—ñ–≤

{% tabs %}
{% tab title="CloudSploit" %}
{% code overflow="wrap" %}
```bash
# Export env variables
./index.js --console=text --config ./config.js --json /tmp/out-cloudsploit.json

# Filter results removing unknown
jq 'map(select(.status | contains("UNKNOWN") | not))' /tmp/out-cloudsploit.json | jq 'map(select(.resource | contains("N/A") | not))' > /tmp/out-cloudsploit-filt.json

# Get services by regions
jq 'group_by(.region) | map({(.[0].region): ([map((.resource | split(":"))[2]) | unique])})' ~/Desktop/pentests/cere/greybox/core-dev-dev-cloudsploit-filtered.json
```
{% endcode %}
{% endtab %}

{% tab title="SteamPipe" %}
```bash
# https://github.com/turbot/steampipe-mod-aws-insights
steampipe check all --export=json

# https://github.com/turbot/steampipe-mod-aws-perimeter
# In this case you cannot output to JSON, so heck it in the dashboard
steampipe dashboard
```
{% endtab %}
{% endtabs %}

#### \<–í–∞—à–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç>

–ñ–æ–¥–µ–Ω –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –Ω–µ –º–æ–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –±–ª–∏–∑—å–∫–æ –≤—Å—ñ—Ö –¥–æ–∑–≤–æ–ª—ñ–≤, —Ç–æ–º—É —è–∫—â–æ –≤–∏ –∑–Ω–∞—î—Ç–µ –∫—Ä–∞—â–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR!

## –ù–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –î–æ—Å—Ç—É–ø

{% content-ref url="../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md" %}
[aws-iam-and-sts-unauthenticated-enum.md](../../aws-pentesting/aws-unauthenticated-enum-access/aws-iam-and-sts-unauthenticated-enum.md)
{% endcontent-ref %}

### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ü—Ä–∏–≤—ñ–ª–µ—ó–≤

–ù–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —è–∫ **–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ IAM –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤**:

{% content-ref url="../aws-privilege-escalation/aws-iam-privesc.md" %}
[aws-iam-privesc.md](../aws-privilege-escalation/aws-iam-privesc.md)
{% endcontent-ref %}

### –ü–æ—Å—Ç-–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è IAM

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md" %}
[aws-iam-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-iam-post-exploitation.md)
{% endcontent-ref %}

### –ü–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å IAM

{% content-ref url="../aws-persistence/aws-iam-persistence.md" %}
[aws-iam-persistence.md](../aws-persistence/aws-iam-persistence.md)
{% endcontent-ref %}

## –¶–µ–Ω—Ç—Ä –Ü–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ IAM

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ **–æ–ø–∏—Å –¶–µ–Ω—Ç—Ä—É –Ü–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ IAM** –≤:

{% content-ref url="../aws-basic-information/" %}
[aws-basic-information](../aws-basic-information/)
{% endcontent-ref %}

### –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ SSO –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é CLI
```bash
# Connect with sso via CLI aws configure sso
aws configure sso

[profile profile_name]
sso_start_url = https://subdomain.awsapps.com/start/
sso_account_id = <account_numbre>
sso_role_name = AdministratorAccess
sso_region = us-east-1
```
### –ü–µ—Ä–µ–ª—ñ–∫

–û—Å–Ω–æ–≤–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¶–µ–Ω—Ç—Ä—É –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:

* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ —Ç–∞ –≥—Ä—É–ø–∏
* –ù–∞–±–æ—Ä–∏ –¥–æ–∑–≤–æ–ª—ñ–≤: –ú–∞—é—Ç—å –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏
* –û–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ AWS

–ü–æ—Ç—ñ–º —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è –≤–∑–∞—î–º–æ–∑–≤'—è–∑–∫–∏, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ/–≥—Ä—É–ø–∏ –º–∞–ª–∏ –Ω–∞–±–æ—Ä–∏ –¥–æ–∑–≤–æ–ª—ñ–≤ –¥–ª—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É AWS.

{% hint style="info" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —î 3 —Å–ø–æ—Å–æ–±–∏ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –ø–æ–ª—ñ—Ç–∏–∫ –¥–æ –Ω–∞–±–æ—Ä—É –¥–æ–∑–≤–æ–ª—ñ–≤. –ü—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è –∫–µ—Ä–æ–≤–∞–Ω–∏—Ö –ø–æ–ª—ñ—Ç–∏–∫ AWS, –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –∫–µ—Ä–æ–≤–∞–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ (—Ü—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –≤ —É—Å—ñ—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å–∞—Ö, –Ω–∞ —è–∫—ñ –≤–ø–ª–∏–≤–∞—î –Ω–∞–±—ñ—Ä –¥–æ–∑–≤–æ–ª—ñ–≤), —Ç–∞ –≤–±—É–¥–æ–≤–∞–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ (–≤–∏–∑–Ω–∞—á–µ–Ω—ñ —Ç–∞–º).
{% endhint %}
```bash
# Check if IAM Identity Center is used
aws sso-admin list-instances

# Get Permissions sets. These are the policies that can be assigned
aws sso-admin list-permission-sets --instance-arn <instance-arn>
aws sso-admin describe-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## Get managed policies of a permission set
aws sso-admin list-managed-policies-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get inline policies of a permission set
aws sso-admin get-inline-policy-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get customer managed policies of a permission set
aws sso-admin list-customer-managed-policy-references-in-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## Get boundaries of a permission set
aws sso-admin get-permissions-boundary-for-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>

## List accounts a permission set is affecting
aws sso-admin list-accounts-for-provisioned-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn>
## List principals given a permission set in an account
aws sso-admin list-account-assignments --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --account-id <account_id>

# Get permissions sets affecting an account
aws sso-admin list-permission-sets-provisioned-to-account --instance-arn <instance-arn> --account-id <account_id>

# List users & groups from the identity store
aws identitystore list-users --identity-store-id <store-id>
aws identitystore list-groups --identity-store-id <store-id>
## Get members of groups
aws identitystore list-group-memberships --identity-store-id <store-id> --group-id <group-id>
## Get memberships or a user or a group
aws identitystore list-group-memberships-for-member --identity-store-id <store-id> --member-id <member-id>
```
### –õ–æ–∫–∞–ª—å–Ω–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è

–ú–æ–∂–ª–∏–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —É –ø–∞–ø—Ü—ñ `$HOME/.aws` —Ñ–∞–π–ª config –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—ñ–≤, —è–∫—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ SSO, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥:
```ini
[default]
region = us-west-2
output = json

[profile my-sso-profile]
sso_start_url = https://my-sso-portal.awsapps.com/start
sso_region = us-west-2
sso_account_id = 123456789012
sso_role_name = MySSORole
region = us-west-2
output = json

[profile dependent-profile]
role_arn = arn:aws:iam::<acc-id>:role/ReadOnlyRole
source_profile = Hacktricks-Admin
```
–¶—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏:
```bash
# Login in ms-sso-profile
aws sso login --profile my-sso-profile
# Use dependent-profile
aws s3 ls --profile dependent-profile
```
–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è **–ø—Ä–æ—Ñ—ñ–ª—å –∑ SSO** –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –ø–µ–≤–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó, –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ **–∫–µ—à—É—é—Ç—å—Å—è** –≤ —Ñ–∞–π–ª—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞–ø–∫–∏ **`$HOME/.aws/sso/cache`**. –¢–æ–º—É —ó—Ö –º–æ–∂–Ω–∞ **–ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–≤—ñ–¥—Ç–∏**.

–ö—Ä—ñ–º —Ç–æ–≥–æ, **–¥–æ–¥–∞—Ç–∫–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ** –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ø–∞–ø—Ü—ñ **`$HOME/.aws/cli/cache`**. –¶—è –ø–∞–ø–∫–∞ –∫–µ—à—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É, –∫–æ–ª–∏ –≤–∏ **–ø—Ä–∞—Ü—é—î—Ç–µ –∑ –ø—Ä–æ—Ñ—ñ–ª—è–º–∏ AWS CLI**, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ IAM –∞–±–æ **–ø—Ä–∏–ø—É—Å–∫–∞—é—Ç—å** —Ä–æ–ª—ñ —á–µ—Ä–µ–∑ IAM (–±–µ–∑ SSO). –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:
```ini
[profile crossaccountrole]
role_arn = arn:aws:iam::234567890123:role/SomeRole
source_profile = default
mfa_serial = arn:aws:iam::123456789012:mfa/saanvi
external_id = 123456
```
### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤

{% content-ref url="../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md" %}
[aws-sso-and-identitystore-privesc.md](../../aws-pentesting/aws-privilege-escalation/aws-sso-and-identitystore-privesc.md)
{% endcontent-ref %}

### –ü—ñ—Å–ª—è–µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ–π–Ω–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å

{% content-ref url="../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md" %}
[aws-sso-and-identitystore-post-exploitation.md](../aws-post-exploitation/aws-sso-and-identitystore-post-exploitation.md)
{% endcontent-ref %}

### –ù–∞—Å—Ç—ñ–π–ª–∏–≤—ñ—Å—Ç—å

#### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –Ω–∞–¥–∞–Ω–Ω—è –π–æ–º—É –¥–æ–∑–≤–æ–ª—ñ–≤

{% code overflow="wrap" %}
```bash
# Create user identitystore:CreateUser
aws identitystore create-user --identity-store-id <store-id> --user-name privesc --display-name privesc --emails Value=sdkabflvwsljyclpma@tmmbt.net,Type=Work,Primary=True --name Formatted=privesc,FamilyName=privesc,GivenName=privesc
## After creating it try to login in the console using the selected username, you will receive an email with the code and then you will be able to select a password
```
* –°—Ç–≤–æ—Ä—ñ—Ç—å –≥—Ä—É–ø—É, –Ω–∞–¥–∞–π—Ç–µ —ó–π –¥–æ–∑–≤–æ–ª–∏ —Ç–∞ –ø—Ä–∏–∑–Ω–∞—á—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
* –ù–∞–¥–∞–π—Ç–µ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∞–±–æ –≥—Ä—É–ø—ñ
* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ª–∏—à–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ –≤—ñ–¥ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–∞—Ç–∏–º—É—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –¶–µ–Ω—Ç—Ä—É —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó IAM.

–û–¥–Ω–∞–∫ —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–æ–≤–∞–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –º–æ–∂–Ω–∞ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ —ñ–Ω—à–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–µ—Ä—É–≤–∞—Ç–∏ –Ω–∏–º. –í–æ–Ω–∏ –Ω–µ –º–∞—Ç–∏–º—É—Ç—å —Ç–æ—á–Ω–æ —Ç–∞–∫–∏—Ö —Å–∞–º–∏—Ö –¥–æ–∑–≤–æ–ª—ñ–≤, –∞–ª–µ –∑–º–æ–∂—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ [**—É–ø—Ä–∞–≤–ª—ñ–Ω—Å—å–∫—ñ –¥—ñ—ó**](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html).
