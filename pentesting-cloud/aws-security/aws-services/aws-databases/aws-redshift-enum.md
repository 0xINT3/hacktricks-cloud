# AWS - Redshift Enum

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Amazon Redshift

Redshift je potpuno upravljana usluga koja može da se skalira do preko petabajta, a koristi se kao **skladište podataka za rešenja velikih podataka**. Korišćenjem Redshift klastera, možete izvršavati analitiku nad svojim skupovima podataka koristeći brze, SQL bazirane alate za upite i aplikacije za poslovnu inteligenciju kako biste stekli veće razumevanje vizije za svoje poslovanje.

**Redshift nudi šifrovanje u mirovanju koristeći hijerarhiju od četiri nivoa šifarskih ključeva koji koriste KMS ili CloudHSM za upravljanje najvišim nivoom ključeva**. **Kada je šifrovanje omogućeno za vaš klaster, ne može se onemogućiti i obrnuto**. Kada imate nešifrovan klaster, ne može se šifrovati.

Šifrovanje za vaš klaster može se desiti samo prilikom njegovog kreiranja, a jednom kada je šifrovan, podaci, metapodaci i svi snimci takođe su šifrovani. Nivoi hijerarhije šifarskih ključeva su sledeći, **prvi nivo je glavni ključ, drugi nivo je ključ za šifrovanje klastera (CEK), treći nivo je ključ za šifrovanje baze podataka (DEK), a četvrti nivo su sami ključevi za šifrovanje podataka**.

### KMS

Prilikom kreiranja vašeg klastera, možete odabrati **podrazumevani KMS ključ** za Redshift ili odabrati **sopstveni CMK**, što vam pruža veću fleksibilnost u kontroli ključa, posebno sa auditorske perspektive.

Podrazumevani KMS ključ za Redshift automatski se kreira od strane Redshift-a prvi put kada se opcija ključa odabere i koristi, i potpuno je upravljan od strane AWS-a.

Ovaj KMS ključ zatim se šifruje glavnim CMK ključem, prvog nivoa. Ovaj šifrovani KMS ključ se zatim koristi kao ključ za šifrovanje klastera (CEK), drugog nivoa. Ovaj CEK se zatim šalje od strane KMS-a Redshift-u gde se čuva odvojeno od klastera. Redshift zatim šalje ovaj šifrovani CEK klasteru preko sigurnog kanala gde se čuva u memoriji.

Redshift zatim zahteva od KMS-a da dešifruje CEK, drugog nivoa. Ovaj dešifrovani CEK se zatim takođe čuva u memoriji. Redshift zatim kreira nasumični ključ za šifrovanje baze podataka (DEK), trećeg nivoa, i učitava ga u memoriju klastera. Dešifrovani CEK u memoriji zatim šifruje DEK, koji se takođe čuva u memoriji.

Ovaj šifrovani DEK se zatim šalje preko sigurnog kanala i čuva se u Redshift-u odvojeno od klastera. Sada su i CEK i DEK smešteni u memoriji klastera i u šifrovanom i dešifrovanom obliku. Dešifrovani DEK se zatim koristi za šifrovanje ključeva za podatke (četvrti nivo) koji se nasumično generišu od strane Redshift-a za svaki podatkovni blok u bazi podataka.

Možete koristiti AWS Trusted Advisor da pratite konfiguraciju vaših Amazon S3 kanti i obezbedite da je logovanje kanti omogućeno, što može biti korisno za izvođenje sigurnosnih revizija i praćenje obrazaca korišćenja u S3.

### CloudHSM

<details>

<summary>Korišćenje Redshift-a sa CloudHSM-om</summary>

Kada radite sa CloudHSM-om radi šifrovanja, prvo morate uspostaviti pouzdanu vezu između vašeg HSM klijenta i Redshift-a koristeći klijentske i serverske sertifikate.

Ova veza je neophodna kako bi se obezbedila sigurna komunikacija, omogućavajući slanje šifarskih ključeva između vašeg HSM klijenta i vaših Redshift klastera. Koristeći nasumično generisan par privatnog i javnog ključa, Redshift kreira javni klijentski sertifikat, koji se šifruje i čuva od strane Redshift-a. Ovaj sertifikat mora biti preuzet i registrovan na vašem HSM klijentu, i dodeljen odgovarajućoj HSM particiji.

Zatim morate konfigurisati Redshift sa sledećim detaljima vašeg HSM klijenta: IP adresa HSM-a, ime HSM particije, lozinka HSM particije i javni HSM serverski sertifikat, koji je šifrovan od strane CloudHSM-a koristeći interni glavni ključ. Nakon što su ove informacije dostavljene, Redshift će potvrditi i proveriti da može da se poveže i pristupi razvojnoj particiji.

Ako vaše interne bezbednosne politike ili upravljačke kontrole nalažu da morate primeniti rotaciju ključeva, to je moguće sa Redshift-om, što vam omogućava rotaciju šifarskih ključeva za šifrovane klastere, međutim, morate biti svesni da tokom procesa rotacije ključeva, klaster će biti nedostupan vrlo kratko vreme, pa je najbolje rotirati ključeve samo kada je to potrebno ili ako sumnjate da su kompromitovani.

Tokom rotacije, Redshift će rotirati CEK za vaš klaster i za sve rezervne kopije tog klastera. Rotiraće DEK za klaster, ali nije moguće rotirati DEK za snimke koji su smešteni u S3 i koji su šifrovani pomoću DEK. Klaster će biti postavljen u stanje 'rotiranje ključeva' sve dok proces ne bude završen, kada će status biti vraćen na 'dostupan'.

</details>

### Enumeracija
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Upornost

Sledeće radnje omogućavaju dodeljivanje pristupa drugim AWS nalozima klasteru:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju oglašenu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
