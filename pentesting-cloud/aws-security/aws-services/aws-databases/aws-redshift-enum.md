# AWS - Redshift Enum

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se quiser ver a sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Amazon Redshift

Redshift √© um servi√ßo totalmente gerenciado que pode escalar at√© mais de um petabyte em tamanho, utilizado como **data warehouse para solu√ß√µes de big data**. Utilizando clusters Redshift, voc√™ pode executar an√°lises em seus conjuntos de dados usando ferramentas de consulta r√°pidas baseadas em SQL e aplicativos de intelig√™ncia empresarial para obter um maior entendimento e vis√£o para o seu neg√≥cio.

**Redshift oferece criptografia em repouso usando uma hierarquia de quatro n√≠veis de chaves de criptografia usando KMS ou CloudHSM para gerenciar o n√≠vel mais alto de chaves**. **Quando a criptografia est√° habilitada para o seu cluster, ela n√£o pode ser desabilitada e vice-versa**. Quando voc√™ tem um cluster n√£o criptografado, ele n√£o pode ser criptografado.

A criptografia para o seu cluster s√≥ pode ocorrer durante sua cria√ß√£o, e uma vez criptografado, os dados, metadados e quaisquer snapshots tamb√©m s√£o criptografados. Os n√≠veis de hierarquia das chaves de criptografia s√£o os seguintes, **o primeiro n√≠vel √© a chave mestra, o segundo n√≠vel √© a chave de criptografia do cluster, a CEK, o terceiro n√≠vel, a chave de criptografia do banco de dados, a DEK, e finalmente o quarto n√≠vel, as pr√≥prias chaves de criptografia dos dados**.

### KMS

Durante a cria√ß√£o do seu cluster, voc√™ pode selecionar a **chave KMS padr√£o** para Redshift ou selecionar a sua **pr√≥pria CMK**, o que lhe d√° mais flexibilidade sobre o controle da chave, especificamente do ponto de vista de auditoria.

A chave KMS padr√£o para Redshift √© automaticamente criada pelo Redshift na primeira vez que a op√ß√£o de chave √© selecionada e usada, e √© totalmente gerenciada pela AWS.

Essa chave KMS √© ent√£o criptografada com a chave mestra CMK, n√≠vel um. Essa chave de dados KMS criptografada √© ent√£o usada como a chave de criptografia do cluster, a CEK, n√≠vel dois. Essa CEK √© ent√£o enviada pelo KMS para o Redshift onde √© armazenada separadamente do cluster. O Redshift ent√£o envia essa CEK criptografada para o cluster por um canal seguro onde √© armazenada na mem√≥ria.

O Redshift ent√£o solicita ao KMS para descriptografar a CEK, n√≠vel dois. Essa CEK descriptografada √© ent√£o tamb√©m armazenada na mem√≥ria. O Redshift cria ent√£o uma chave de criptografia de banco de dados aleat√≥ria, a DEK, n√≠vel tr√™s, e carrega isso na mem√≥ria do cluster. A CEK descriptografada na mem√≥ria ent√£o criptografa a DEK, que tamb√©m √© armazenada na mem√≥ria.

Essa DEK criptografada √© ent√£o enviada por um canal seguro e armazenada no Redshift separadamente do cluster. Tanto a CEK quanto a DEK agora est√£o armazenadas na mem√≥ria do cluster, ambas em forma criptografada e descriptografada. A DEK descriptografada √© ent√£o usada para criptografar chaves de dados, n√≠vel quatro, que s√£o geradas aleatoriamente pelo Redshift para cada bloco de dados no banco de dados.

Voc√™ pode usar o AWS Trusted Advisor para monitorar a configura√ß√£o dos seus buckets do Amazon S3 e garantir que o registro em log do bucket esteja habilitado, o que pode ser √∫til para realizar auditorias de seguran√ßa e rastrear padr√µes de uso no S3.

### CloudHSM

<details>

<summary>Usando Redshift com CloudHSM</summary>

Ao trabalhar com CloudHSM para realizar sua criptografia, primeiramente voc√™ deve configurar uma conex√£o confi√°vel entre o seu cliente HSM e o Redshift, utilizando certificados de cliente e servidor.

Essa conex√£o √© necess√°ria para fornecer comunica√ß√µes seguras, permitindo que as chaves de criptografia sejam enviadas entre o seu cliente HSM e seus clusters Redshift. Usando um par de chaves privada e p√∫blica gerado aleatoriamente, o Redshift cria um certificado de cliente p√∫blico, que √© criptografado e armazenado pelo Redshift. Este deve ser baixado e registrado no seu cliente HSM, e atribu√≠do √† parti√ß√£o HSM correta.

Voc√™ deve ent√£o configurar o Redshift com os seguintes detalhes do seu cliente HSM: o endere√ßo IP do HSM, o nome da parti√ß√£o HSM, a senha da parti√ß√£o HSM e o certificado p√∫blico do servidor HSM, que √© criptografado pelo CloudHSM usando uma chave mestra interna. Uma vez que essas informa√ß√µes tenham sido fornecidas, o Redshift confirmar√° e verificar√° que pode se conectar e acessar a parti√ß√£o de desenvolvimento.

Se suas pol√≠ticas de seguran√ßa internas ou controles de governan√ßa exigirem que voc√™ aplique a rota√ß√£o de chaves, isso √© poss√≠vel com o Redshift, permitindo que voc√™ gire as chaves de criptografia para clusters criptografados, no entanto, voc√™ precisa estar ciente de que durante o processo de rota√ß√£o de chaves, ele tornar√° um cluster indispon√≠vel por um curto per√≠odo de tempo, e por isso √© melhor girar as chaves apenas quando necess√°rio, ou se voc√™ achar que elas podem ter sido comprometidas.

Durante a rota√ß√£o, o Redshift girar√° a CEK para o seu cluster e para quaisquer backups desse cluster. Ele girar√° uma DEK para o cluster, mas n√£o √© poss√≠vel girar uma DEK para os snapshots armazenados no S3 que foram criptografados usando a DEK. Ele colocar√° o cluster em um estado de 'girando chaves' at√© que o processo seja conclu√≠do, quando o status retornar√° para 'dispon√≠vel'.

</details>

### Enumera√ß√£o
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persist√™ncia

As seguintes a√ß√µes permitem conceder acesso a outras contas AWS ao cluster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
