# AWS - Redshift Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)を**フォロー**してください。
* **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## Amazon Redshift

Redshiftは、**ビッグデータソリューションのデータウェアハウス**として使用される、サイズがペタバイトを超えるまでスケーリング可能な完全マネージドサービスです。Redshiftクラスタを使用すると、高速なSQLベースのクエリツールとビジネスインテリジェンスアプリケーションを使用して、データセットに対する分析を実行し、ビジネスのビジョンをより深く理解することができます。

**Redshiftは、KMSまたはCloudHSMを使用して暗号化を休止状態で提供し、暗号化がクラスタに有効になると無効にできず、その逆も同様です**。暗号化されていないクラスタの場合、暗号化することはできません。

クラスタの暗号化は作成時にのみ行うことができ、一旦暗号化されると、データ、メタデータ、およびスナップショットも暗号化されます。暗号化キーの階層レベルは次のとおりです。**階層1はマスターキー、階層2はクラスタ暗号化キー（CEK）、階層3はデータベース暗号化キー（DEK）、最後に階層4はデータ暗号化キー自体**です。

### KMS

クラスタの作成時に、Redshiftの**デフォルトKMSキー**を選択するか、**独自のCMK**を選択することができます。これにより、キーの制御に関して監査可能な観点から柔軟性が向上します。

RedshiftのデフォルトKMSキーは、Redshiftによって初めてキーが選択され使用されたときに自動的に作成され、AWSによって完全に管理されます。

このKMSキーは、CMKマスターキー（階層1）で暗号化され、暗号化されたKMSデータキーは、クラスタ暗号化キー（CEK、階層2）として使用されます。このCEKはKMSによってRedshiftに送信され、クラスタからは別々に保存されます。その後、Redshiftはこの暗号化されたCEKをセキュアチャネルを介してクラスタに送信し、メモリに保存します。

Redshiftは次に、KMSにCEK（階層2）の復号を要求します。復号されたCEKもメモリに保存されます。その後、Redshiftはランダムなデータベース暗号化キー（DEK、階層3）を作成し、それをクラスタのメモリにロードします。メモリ内の復号されたCEKは、メモリに保存されているDEKを暗号化し、それもメモリに保存します。

この暗号化されたDEKは、セキュアチャネルを介して送信され、クラスタから別々に保存されます。CEKとDEKは、メモリ内に暗号化および復号された形式でクラスタに保存されます。復号されたDEKは、データベース内の各データブロックに対してRedshiftによってランダムに生成されたデータキー（階層4）を暗号化するために使用されます。

Amazon S3バケットの構成を監視し、バケットのロギングが有効になっていることを確認するためにAWS Trusted Advisorを使用することができます。これは、セキュリティ監査を実行し、S3の使用パターンを追跡するのに役立ちます。

### CloudHSM

<details>

<summary>CloudHSMを使用したRedshift</summary>

暗号化を実行するためにCloudHSMを使用する場合、まずHSMクライアントとRedshiftの間に信頼された接続を設定する必要があります。この際、クライアントとサーバー証明書を使用します。

この接続は、暗号化キーをHSMクライアントとRedshiftクラスタの間で送信できるようにするために必要です。Redshiftはランダムに生成されたプライベートおよびパブリックキーペアを使用して、公開クライアント証明書を作成し、これを暗号化してRedshiftに保存します。これをHSMクライアントにダウンロードして登録し、適切なHSMパーティションに割り当てる必要があります。

次に、RedshiftをHSMクライアントの次の詳細で構成する必要があります：HSM IPアドレス、HSMパーティション名、HSMパーティションパスワード、およびCloudHSMによって暗号化された公開HSMサーバー証明書。これらの情報が提供されると、Redshiftは接続を確認し、開発パーティションにアクセスできることを確認します。

内部セキュリティポリシーまたはガバナンスコントロールによって、暗号鍵のローテーションを適用する必要がある場合、Redshiftを使用して暗号化されたクラスタの暗号鍵をローテーションできますが、キーのローテーションプロセス中にクラスタが非常に短い時間利用できなくなることに注意する必要があります。したがって、必要に応じてのみキーをローテーションするか、コンプロミスされた可能性がある場合にのみローテーションすることが最善です。

ローテーション中、RedshiftはクラスタのCEKおよびそのクラスタのバックアップのためのDEKをローテーションします。クラスタのDEKをローテーションすることは可能ですが、DEKを使用して暗号化されたS3に保存されているスナップショットのDEKをローテーションすることはできません。プロセスが完了するまで、クラスタを「キーのローテーション中」の状態にし、ステータスが「利用可能」に戻ると完了します。

</details>

### 列挙
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## 特権昇格

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## 永続性

以下のアクションにより、他のAWSアカウントにクラスタへのアクセス権限を付与できます：

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する。
* **HackTricks**および**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>
