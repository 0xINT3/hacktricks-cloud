# AWS - Enumeraci√≥n de Redshift

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Amazon Redshift

Redshift es un servicio completamente administrado que puede escalar hasta m√°s de un petabyte de tama√±o, que se utiliza como un **almac√©n de datos para soluciones de big data**. Usando cl√∫steres de Redshift, puedes ejecutar an√°lisis contra tus conjuntos de datos utilizando herramientas de consulta basadas en SQL y aplicaciones de inteligencia empresarial para obtener una mayor comprensi√≥n de la visi√≥n de tu negocio.

**Redshift ofrece cifrado en reposo utilizando una jerarqu√≠a de cuatro niveles de claves de cifrado utilizando KMS o CloudHSM para administrar el nivel superior de claves**. **Cuando se habilita el cifrado para tu cl√∫ster, no se puede deshabilitar y viceversa**. Cuando tienes un cl√∫ster sin cifrar, no se puede cifrar.

El cifrado para tu cl√∫ster solo puede ocurrir durante su creaci√≥n, y una vez cifrado, los datos, metadatos y cualquier instant√°nea tambi√©n est√°n cifrados. El nivel de jerarqu√≠a de las claves de cifrado son los siguientes, **el nivel uno es la clave maestra, el nivel dos es la clave de cifrado del cl√∫ster, el CEK, el nivel tres, la clave de cifrado de la base de datos, el DEK, y finalmente el nivel cuatro, las claves de cifrado de datos en s√≠**.

### KMS

Durante la creaci√≥n de tu cl√∫ster, puedes seleccionar la **clave KMS predeterminada** para Redshift o seleccionar tu **propio CMK**, lo que te da m√°s flexibilidad sobre el control de la clave, espec√≠ficamente desde una perspectiva auditiva.

La clave KMS predeterminada para Redshift se crea autom√°ticamente por Redshift la primera vez que se selecciona y utiliza la opci√≥n de clave, y es completamente administrada por AWS.

Esta clave KMS se cifra luego con la clave maestra CMK, nivel uno. Esta clave de datos KMS cifrada se utiliza como clave de cifrado del cl√∫ster, el CEK, nivel dos. Este CEK se env√≠a por KMS a Redshift donde se almacena por separado del cl√∫ster. Redshift luego env√≠a este CEK cifrado al cl√∫ster a trav√©s de un canal seguro donde se almacena en memoria.

Redshift luego solicita a KMS que descifre el CEK, nivel dos. Este CEK descifrado tambi√©n se almacena en memoria. Redshift luego crea una clave de cifrado de base de datos aleatoria, el DEK, nivel tres, y la carga en la memoria del cl√∫ster. El CEK descifrado en memoria cifra el DEK, que tambi√©n se almacena en memoria.

Este DEK cifrado se env√≠a luego a trav√©s de un canal seguro y se almacena en Redshift por separado del cl√∫ster. Tanto el CEK como el DEK ahora se almacenan en la memoria del cl√∫ster tanto en forma cifrada como descifrada. El DEK descifrado se utiliza para cifrar las claves de datos, nivel cuatro, que son generadas aleatoriamente por Redshift para cada bloque de datos en la base de datos.

Puedes usar AWS Trusted Advisor para monitorear la configuraci√≥n de tus buckets de Amazon S3 y asegurarte de que el registro de buckets est√© habilitado, lo que puede ser √∫til para realizar auditor√≠as de seguridad y rastrear patrones de uso en S3.

### CloudHSM

<details>

<summary>Usando Redshift con CloudHSM</summary>

Cuando trabajas con CloudHSM para realizar tu cifrado, primero debes configurar una conexi√≥n de confianza entre tu cliente HSM y Redshift mientras usas certificados de cliente y servidor.

Esta conexi√≥n es necesaria para proporcionar comunicaciones seguras, permitiendo que las claves de cifrado se env√≠en entre tu cliente HSM y tus cl√∫steres de Redshift. Usando un par de claves privadas y p√∫blicas generadas aleatoriamente, Redshift crea un certificado de cliente p√∫blico, que se cifra y almacena por Redshift. Este debe descargarse y registrarse en tu cliente HSM, y asignarse a la partici√≥n HSM correcta.

Luego debes configurar Redshift con los siguientes detalles de tu cliente HSM: la direcci√≥n IP de HSM, el nombre de la partici√≥n HSM, la contrase√±a de la partici√≥n HSM y el certificado de servidor HSM p√∫blico, que se cifra por CloudHSM utilizando una clave maestra interna. Una vez que se haya proporcionado esta informaci√≥n, Redshift confirmar√° y verificar√° que puede conectarse y acceder a la partici√≥n de desarrollo.

Si tus pol√≠ticas de seguridad internas o controles de gobierno dictan que debes aplicar la rotaci√≥n de claves, esto es posible con Redshift, lo que te permite rotar las claves de cifrado para cl√∫steres cifrados, sin embargo, debes tener en cuenta que durante el proceso de rotaci√≥n de claves, har√° que un cl√∫ster no est√© disponible por un per√≠odo muy corto de tiempo, por lo que es mejor rotar las claves solo cuando sea necesario, o si sientes que pueden haber sido comprometidas.

Durante la rotaci√≥n, Redshift rotar√° el CEK para tu cl√∫ster y para cualquier copia de seguridad de ese cl√∫ster. Rotar√° un DEK para el cl√∫ster, pero no es posible rotar un DEK para las instant√°neas almacenadas en S3 que se han cifrado utilizando el DEK. Pondr√° el cl√∫ster en un estado de 'rotaci√≥n de claves' hasta que se complete el proceso, momento en el que el estado volver√° a 'disponible'.

</details>

### Enumeraci√≥n

```bash
# Obtener cl√∫steres
aws redshift describe-clusters
## Obtener si es accesible p√∫blicamente
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Obtener el nombre de usuario de la BD para iniciar sesi√≥n
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Obtener el endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Direcciones p√∫blicas de los nodos
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Obtener roles IAM de los cl√∫steres
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Acceso y autorizaci√≥n de endpoint
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Obtener credenciales
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## De forma predeterminada, las credenciales temporales caducan en 900 segundos. Opcionalmente, puedes especificar una duraci√≥n entre 900 segundos (15 minutos) y 3600 segundos (60 minutos).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Da credenciales para acceder a redshift con los permisos de IAM redshift dados a la cuenta actual de AWS
## M√°s en https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Perfiles de autenticaci√≥n
aws redshift describe-authentication-profiles

# Instant√°neas
aws redshift describe-cluster-snapshots

# Acciones programadas
aws redshift describe-scheduled-actions

# Conexi√≥n
# La instancia de redshift debe estar disponible p√∫blicamente (no por defecto), el sg debe permitir conexiones entrantes al puerto y necesitas credenciales
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```

## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistencia

Las siguientes acciones permiten otorgar acceso a otros cuentas de AWS al cl√∫ster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>