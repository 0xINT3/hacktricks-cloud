# AWS - Redshift枚举

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向**[**HackTricks**](https://github.com/carlospolop/hacktricks) **和**[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## Amazon Redshift

Redshift是一个完全托管的服务，可以扩展到超过一PB的大小，用作**大数据解决方案的数据仓库**。使用Redshift集群，您可以使用快速的基于SQL的查询工具和商业智能应用程序对数据集进行分析，以更好地了解您的业务愿景。

**Redshift提供了使用四层加密密钥层次结构进行的静态加密，使用KMS或CloudHSM来管理顶层密钥**。**启用集群的加密后，无法禁用加密，反之亦然**。当您拥有一个未加密的集群时，无法对其进行加密。

集群的加密只能在创建期间进行，一旦加密，数据、元数据和任何快照也将被加密。加密密钥的分层级别如下，**第一层是主密钥，第二层是集群加密密钥（CEK），第三层是数据库加密密钥（DEK），最后一层是数据加密密钥本身**。

### KMS

在创建集群时，您可以选择为Redshift使用**默认的KMS密钥**或选择您自己的**CMK**，这使您在审计角度上对密钥的控制更加灵活。

Redshift的默认KMS密钥是由Redshift在首次选择并使用密钥选项时自动创建的，并由AWS完全管理。

然后，将此KMS密钥使用CMK主密钥（第一层）进行加密。然后，将加密的KMS数据密钥用作集群加密密钥（CEK，第二层）。然后，KMS将此CEK发送给Redshift，在那里它与集群分开存储。然后，Redshift通过安全通道将此加密的CEK发送到集群，存储在内存中。

然后，Redshift请求KMS解密CEK（第二层）。然后，解密的CEK也存储在内存中。然后，Redshift创建一个随机的数据库加密密钥（DEK，第三层），并将其加载到集群的内存中。内存中的解密CEK然后加密DEK，DEK也存储在内存中。

然后，将此加密的DEK通过安全通道发送并与集群分开存储。CEK和DEK现在都以加密和解密的形式存储在集群的内存中。解密的DEK然后用于加密数据块中每个数据块的随机生成的数据密钥（第四层）。

您可以使用AWS Trusted Advisor监视Amazon S3存储桶的配置，并确保启用了存储桶日志记录，这对于执行安全审计和跟踪S3中的使用模式非常有用。

### CloudHSM

<details>

<summary>使用CloudHSM的Redshift</summary>

在使用CloudHSM执行加密时，首先必须在使用客户端和服务器证书的情况下，在HSM客户端和Redshift之间建立一个受信任的连接。

此连接需要提供安全通信，允许加密密钥在HSM客户端和Redshift集群之间发送。使用随机生成的私钥和公钥对，Redshift创建一个公共客户端证书，该证书由Redshift加密并存储。必须下载并注册此证书到您的HSM客户端，并分配给正确的HSM分区。

然后，您必须配置Redshift以提供HSM客户端的以下详细信息：HSM IP地址、HSM分区名称、HSM分区密码和公共HSM服务器证书，该证书由CloudHSM使用内部主密钥进行加密。提供了这些信息后，Redshift将确认并验证其是否可以连接并访问开发分区。

如果您的内部安全策略或治理控制要求您必须应用密钥轮换，则可以使用Redshift来轮换加密密钥以用于加密的集群，但是，您需要注意，在密钥轮换过程中，集群将在很短的时间内不可用，因此最好只在需要时或者如果您觉得密钥可能已被泄露时才轮换密钥。

在轮换过程中，Redshift将轮换集群的CEK和该集群的任何备份的CEK。它将为集群轮换DEK，但无法轮换使用DEK加密的存储在S3中的快照的DEK。它将将集群置于“轮换密钥”状态，直到完成该过程，然后状态将返回“可用”。

</details>

### 枚举
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## 提权

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## 持久性

以下操作允许将对集群的访问权限授予其他AWS账户：

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**The PEASS Family**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
