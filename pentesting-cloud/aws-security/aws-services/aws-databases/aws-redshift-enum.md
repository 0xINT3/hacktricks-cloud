# AWS - Enumera√ß√£o do Redshift

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Amazon Redshift

O Redshift √© um servi√ßo totalmente gerenciado que pode ser dimensionado para mais de um petabyte de tamanho, que √© usado como um **data warehouse para solu√ß√µes de big data**. Usando clusters Redshift, voc√™ pode executar an√°lises em seus conjuntos de dados usando ferramentas de consulta baseadas em SQL e aplicativos de intelig√™ncia de neg√≥cios para obter uma compreens√£o maior da vis√£o para seus neg√≥cios.

**O Redshift oferece criptografia em repouso usando uma hierarquia de quatro n√≠veis de chaves de criptografia usando o KMS ou o CloudHSM para gerenciar o n√≠vel superior das chaves**. **Quando a criptografia √© habilitada para seu cluster, ela n√£o pode ser desabilitada e vice-versa**. Quando voc√™ tem um cluster n√£o criptografado, ele n√£o pode ser criptografado.

A criptografia para seu cluster s√≥ pode acontecer durante sua cria√ß√£o e, uma vez criptografada, os dados, metadados e quaisquer snapshots tamb√©m s√£o criptografados. O n√≠vel de hierarquia das chaves de criptografia √© o seguinte: **o n√≠vel um √© a chave mestra, o n√≠vel dois √© a chave de criptografia do cluster, o CEK, o n√≠vel tr√™s √© a chave de criptografia do banco de dados, o DEK, e finalmente o n√≠vel quatro, as pr√≥prias chaves de criptografia de dados**.

### KMS

Durante a cria√ß√£o do seu cluster, voc√™ pode selecionar a **chave KMS padr√£o** para o Redshift ou selecionar sua **pr√≥pria CMK**, o que lhe d√° mais flexibilidade no controle da chave, especificamente do ponto de vista audit√°vel.

A chave KMS padr√£o para o Redshift √© criada automaticamente pelo Redshift na primeira vez que a op√ß√£o de chave √© selecionada e usada, e √© totalmente gerenciada pela AWS.

Essa chave KMS √© ent√£o criptografada com a chave mestra CMK, n√≠vel um. Essa chave de dados KMS criptografada √© ent√£o usada como a chave de criptografia do cluster, o CEK, n√≠vel dois. Este CEK √© ent√£o enviado pelo KMS para o Redshift, onde √© armazenado separadamente do cluster. O Redshift ent√£o envia este CEK criptografado para o cluster por um canal seguro, onde √© armazenado na mem√≥ria.

O Redshift ent√£o solicita ao KMS que descriptografe o CEK, n√≠vel dois. Este CEK descriptografado tamb√©m √© armazenado na mem√≥ria. O Redshift ent√£o cria uma chave de criptografia de banco de dados aleat√≥ria, o DEK, n√≠vel tr√™s, e carrega isso na mem√≥ria do cluster. O CEK descriptografado na mem√≥ria ent√£o criptografa o DEK, que tamb√©m √© armazenado na mem√≥ria.

Este DEK criptografado √© ent√£o enviado por um canal seguro e armazenado no Redshift separadamente do cluster. Tanto o CEK quanto o DEK agora s√£o armazenados na mem√≥ria do cluster, tanto em forma criptografada quanto descriptografada. O DEK descriptografado √© ent√£o usado para criptografar as chaves de dados, n√≠vel quatro, que s√£o geradas aleatoriamente pelo Redshift para cada bloco de dados no banco de dados.

Voc√™ pode usar o AWS Trusted Advisor para monitorar a configura√ß√£o de seus buckets do Amazon S3 e garantir que o registro de bucket esteja habilitado, o que pode ser √∫til para realizar auditorias de seguran√ßa e rastrear padr√µes de uso no S3.

### CloudHSM

<details>

<summary>Usando o Redshift com o CloudHSM</summary>

Ao trabalhar com o CloudHSM para realizar sua criptografia, primeiro voc√™ deve configurar uma conex√£o confi√°vel entre seu cliente HSM e o Redshift enquanto usa certificados de cliente e servidor.

Essa conex√£o √© necess√°ria para fornecer comunica√ß√µes seguras, permitindo que as chaves de criptografia sejam enviadas entre seu cliente HSM e seus clusters Redshift. Usando um par de chaves privada e p√∫blica gerado aleatoriamente, o Redshift cria um certificado de cliente p√∫blico, que √© criptografado e armazenado pelo Redshift. Isso deve ser baixado e registrado em seu cliente HSM e atribu√≠do √† parti√ß√£o HSM correta.

Voc√™ deve ent√£o configurar o Redshift com os seguintes detalhes do seu cliente HSM: o endere√ßo IP do HSM, o nome da parti√ß√£o HSM, a senha da parti√ß√£o HSM e o certificado do servidor HSM p√∫blico, que √© criptografado pelo CloudHSM usando uma chave mestra interna. Depois que essas informa√ß√µes forem fornecidas, o Redshift confirmar√° e verificar√° se pode se conectar e acessar a parti√ß√£o de desenvolvimento.

Se suas pol√≠ticas internas de seguran√ßa ou controles de governan√ßa ditarem que voc√™ deve aplicar a rota√ß√£o de chaves, isso √© poss√≠vel com o Redshift, permitindo que voc√™ gire as chaves de criptografia para clusters criptografados, no entanto, voc√™ precisa estar ciente de que durante o processo de rota√ß√£o de chaves, ele tornar√° um cluster indispon√≠vel por um per√≠odo muito curto de tempo, e portanto, √© melhor girar as chaves apenas quando necess√°rio ou se voc√™ sentir que elas podem ter sido comprometidas.

Durante a rota√ß√£o, o Redshift girar√° o CEK para seu cluster e para qualquer backup desse cluster. Ele girar√° um DEK para o cluster, mas n√£o √© poss√≠vel girar um DEK para os snapshots armazenados no S3 que foram criptografados usando o DEK. Ele colocar√° o cluster em um estado de 'rota√ß√£o de chaves' at√© que o processo seja conclu√≠do, quando o status retornar√° a 'dispon√≠vel'.

</details>

### Enumera√ß√£o

```bash
# Obter clusters
aws redshift describe-clusters
## Obter se √© publicamente acess√≠vel
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Obter nome de usu√°rio do banco de dados para fazer login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Obter endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Endere√ßos p√∫blicos dos n√≥s
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Obter fun√ß√µes IAM dos clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Acesso e autoriza√ß√£o do endpoint
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Obter credenciais
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## Por padr√£o, as credenciais tempor√°rias expiram em 900 segundos. Voc√™ pode opcionalmente especificar uma dura√ß√£o entre 900 segundos (15 minutos) e 3600 segundos (60 minutos).
aws redshift get-cluster-credentials-with-iam