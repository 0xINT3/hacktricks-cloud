# AWS - Redshift Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Amazon Redshift

Redshiftは、**ビッグデータソリューションのデータウェアハウスとして使用される**、ペタバイト規模までスケールアップ可能な完全管理型サービスです。Redshiftクラスターを使用することで、高速なSQLベースのクエリツールやビジネスインテリジェンスアプリケーションを使用してデータセットに対する分析を実行し、ビジネスの理解を深めることができます。

**Redshiftは、KMSまたはCloudHSMを使用して最上位のキーを管理する、4階層の暗号化キーを使用して、暗号化された状態でのデータ保護を提供します**。**クラスターの暗号化が有効になっている場合、無効にすることはできませんし、その逆も同様です**。暗号化されていないクラスターは、暗号化することができません。

クラスターの暗号化は、その作成中にのみ行うことができ、一度暗号化されると、データ、メタデータ、およびスナップショットも暗号化されます。暗号化キーの階層レベルは次のとおりです。**レベル1はマスターキー、レベル2はクラスター暗号化キー（CEK）、レベル3はデータベース暗号化キー（DEK）、そして最後にレベル4はデータ暗号化キー自体です**。

### KMS

クラスターの作成中に、Redshiftの**デフォルトKMSキー**を選択するか、より柔軟なキーの制御を可能にする**独自のCMK**を選択できます。

RedshiftのデフォルトKMSキーは、初めてキーオプションが選択され使用されたときにRedshiftによって自動的に作成され、AWSによって完全に管理されます。

このKMSキーは、レベル1のCMKマスターキーで暗号化されます。この暗号化されたKMSデータキーは、レベル2のクラスター暗号化キー（CEK）として使用されます。このCEKはKMSによってRedshiftに送信され、クラスターから別に保存されます。Redshiftはこの暗号化されたCEKを安全なチャネルを通じてクラスターに送信し、メモリに保存されます。

RedshiftはKMSにCEKの復号を要求し、レベル2です。この復号されたCEKもメモリに保存されます。Redshiftはランダムなデータベース暗号化キー（DEK）、レベル3を作成し、クラスターのメモリにロードします。メモリ内の復号されたCEKはDEKを暗号化し、これもメモリに保存されます。

この暗号化されたDEKは、安全なチャネルを通じて送信され、クラスターから別にRedshiftに保存されます。CEKとDEKの両方が、暗号化された形式と復号された形式の両方でクラスターのメモリに保存されています。復号されたDEKは、データベース内の各データブロックに対してRedshiftによってランダムに生成されたデータキーを暗号化するために使用されます。

AWS Trusted Advisorを使用して、Amazon S3バケットの設定を監視し、バケットのロギングが有効になっていることを確認することができます。これは、セキュリティ監査を実行したり、S3での使用パターンを追跡したりするのに役立ちます。

### CloudHSM

<details>

<summary>CloudHSMを使用したRedshift</summary>

CloudHSMを使用して暗号化を行う場合、まず、HSMクライアントとRedshiftの間に信頼できる接続を設定する必要があります。これには、クライアントとサーバーの証明書を使用します。

この接続は、暗号化キーをHSMクライアントとRedshiftクラスター間で送信するために、安全な通信を提供するために必要です。ランダムに生成されたプライベートキーとパブリックキーのペアを使用して、Redshiftはパブリッククライアント証明書を作成し、Redshiftによって暗号化されて保存されます。これをダウンロードしてHSMクライアントに登録し、適切なHSMパーティションに割り当てる必要があります。

次に、HSMクライアントの次の詳細をRedshiftに設定する必要があります：HSMのIPアドレス、HSMパーティション名、HSMパーティションパスワード、およびCloudHSMによって内部マスターキーで暗号化されたパブリックHSMサーバー証明書。この情報が提供されると、Redshiftは接続して開発パーティションにアクセスできることを確認し、検証します。

内部のセキュリティポリシーまたはガバナンスコントロールがキーローテーションの適用を要求する場合、暗号化されたクラスターの暗号化キーを回転させることが可能ですが、キーローテーションプロセス中にクラスターが非常に短い期間使用できなくなるため、必要に応じて、またはキーが侵害された可能性があると感じた場合にのみキーを回転させるのが最善です。

ローテーション中、RedshiftはクラスターのCEKとそのクラスターのバックアップのCEKを回転させます。クラスターのDEKを回転させますが、S3に保存されているスナップショットのDEKを回転させることはできません。プロセスが完了すると、「利用可能」のステータスに戻るまで、クラスターは「キーを回転中」の状態になります。

</details>

### Enumeration
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

以下のアクションにより、他のAWSアカウントにクラスタへのアクセスを許可することができます:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
