# AWS - Redshift 枚举

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Amazon Redshift

Redshift是一个完全托管的服务，可以扩展到超过一个PB的大小，用作**大数据解决方案的数据仓库**。使用Redshift集群，您可以使用快速的基于SQL的查询工具和商业智能应用程序对数据集进行分析，以获得对业务的更深入理解。

**Redshift提供使用KMS或CloudHSM管理顶层密钥的四层加密密钥层次结构的静态加密**。**启用集群加密后，无法禁用，反之亦然**。当您有一个未加密的集群时，无法对其进行加密。

集群的加密只能在创建期间进行，一旦加密，数据、元数据和任何快照也将被加密。加密密钥的层次级别如下，**第一层是主密钥，第二层是集群加密密钥（CEK），第三层是数据库加密密钥（DEK），最后第四层是数据加密密钥本身**。

### KMS

在创建集群期间，您可以选择Redshift的**默认KMS密钥**或选择您自己的**CMK**，这为您对密钥的控制提供了更多的灵活性，特别是从可审计的角度来看。

Redshift的默认KMS密钥是由Redshift在第一次选择并使用密钥选项时自动创建的，并且由AWS完全管理。

然后，这个KMS密钥被CMK主密钥（第一层）加密。这个加密的KMS数据密钥然后被用作集群加密密钥（CEK，第二层）。KMS将这个CEK发送给Redshift，它被单独存储在集群之外。Redshift然后通过安全通道将这个加密的CEK发送到集群，在内存中存储。

Redshift然后请求KMS解密CEK（第二层）。这个解密的CEK也存储在内存中。Redshift然后创建一个随机的数据库加密密钥（DEK，第三层），并将其加载到集群的内存中。内存中的解密CEK然后加密DEK，它也存储在内存中。

这个加密的DEK然后通过安全通道发送并单独存储在Redshift中，与集群分开。CEK和DEK现在都以加密和解密的形式存储在集群的内存中。解密的DEK然后用于加密数据密钥（第四层），这些数据密钥由Redshift为数据库中的每个数据块随机生成。

您可以使用AWS Trusted Advisor来监控您的Amazon S3桶的配置，并确保启用了桶日志记录，这对于执行安全审计和跟踪S3中的使用模式非常有用。

### CloudHSM

<details>

<summary>结合CloudHSM使用Redshift</summary>

在使用CloudHSM进行加密时，首先您必须在HSM客户端和Redshift之间建立一个受信任的连接，同时使用客户端和服务器证书。

这种连接是必需的，以提供安全的通信，允许加密密钥在您的HSM客户端和Redshift集群之间传输。使用随机生成的私钥和公钥对，Redshift创建一个公共客户端证书，该证书被Redshift加密并存储。这必须下载并注册到您的HSM客户端，并分配给正确的HSM分区。

然后，您必须使用以下您的HSM客户端的详细信息配置Redshift：HSM IP地址、HSM分区名称、HSM分区密码和公共HSM服务器证书，这些都是由CloudHSM使用内部主密钥加密的。一旦提供了这些信息，Redshift将确认并验证它能够连接并访问开发分区。

如果您的内部安全政策或治理控制要求您必须应用密钥轮换，那么Redshift允许您为加密集群轮换加密密钥，但是您需要知道，在密钥轮换过程中，它会使集群在非常短的时间内不可用，因此最好只在需要时或如果您认为它们可能已经被泄露时才轮换密钥。

在轮换过程中，Redshift将为您的集群和该集群的任何备份轮换CEK。它将为集群轮换一个DEK，但是不可能为已使用DEK加密并存储在S3中的快照轮换DEK。它将把集群置于“轮换密钥”的状态，直到过程完成，状态将返回到“可用”。

</details>

### 枚举
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## 权限提升

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## 持久性

以下操作允许将对集群的访问权限授予其他AWS账户：

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
