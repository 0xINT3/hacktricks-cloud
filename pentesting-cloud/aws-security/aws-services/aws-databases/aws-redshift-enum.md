# AWS - Redshift Enum

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Amazon Redshift

Redshift es un servicio completamente gestionado que puede escalar hasta m√°s de un petabyte de tama√±o, que se utiliza como **almac√©n de datos para soluciones de big data**. Utilizando cl√∫steres de Redshift, puedes ejecutar an√°lisis en tus conjuntos de datos utilizando herramientas de consulta basadas en SQL r√°pidas y aplicaciones de inteligencia empresarial para obtener una mayor comprensi√≥n y visi√≥n para tu negocio.

**Redshift ofrece cifrado en reposo utilizando una jerarqu√≠a de cuatro niveles de claves de cifrado usando KMS o CloudHSM para gestionar el nivel superior de claves**. **Cuando el cifrado est√° habilitado para tu cl√∫ster, no se puede deshabilitar y viceversa**. Cuando tienes un cl√∫ster sin cifrar, no se puede cifrar.

El cifrado para tu cl√∫ster solo puede ocurrir durante su creaci√≥n, y una vez cifrado, los datos, metadatos y cualquier instant√°nea tambi√©n est√°n cifrados. Los niveles de jerarqu√≠a de las claves de cifrado son los siguientes, **el nivel uno es la clave maestra, el nivel dos es la clave de cifrado del cl√∫ster, la CEK, el nivel tres, la clave de cifrado de la base de datos, la DEK, y finalmente el nivel cuatro, las propias claves de cifrado de datos**.

### KMS

Durante la creaci√≥n de tu cl√∫ster, puedes seleccionar la **clave KMS predeterminada** para Redshift o seleccionar tu **propia CMK**, lo que te da m√°s flexibilidad sobre el control de la clave, espec√≠ficamente desde una perspectiva auditable.

La clave KMS predeterminada para Redshift se crea autom√°ticamente por Redshift la primera vez que se selecciona la opci√≥n de clave y se utiliza, y est√° completamente gestionada por AWS.

Esta clave KMS se cifra luego con la clave maestra CMK, nivel uno. Esta clave de datos KMS cifrada se utiliza entonces como la clave de cifrado del cl√∫ster, la CEK, nivel dos. Esta CEK se env√≠a por KMS a Redshift donde se almacena por separado del cl√∫ster. Redshift luego env√≠a esta CEK cifrada al cl√∫ster a trav√©s de un canal seguro donde se almacena en memoria.

Redshift luego solicita a KMS que descifre la CEK, nivel dos. Esta CEK descifrada tambi√©n se almacena en memoria. Redshift luego crea una clave de cifrado de base de datos aleatoria, la DEK, nivel tres, y la carga en la memoria del cl√∫ster. La CEK descifrada en memoria luego cifra la DEK, que tambi√©n se almacena en memoria.

Esta DEK cifrada se env√≠a luego a trav√©s de un canal seguro y se almacena en Redshift por separado del cl√∫ster. Tanto la CEK como la DEK ahora se almacenan en la memoria del cl√∫ster tanto en forma cifrada como descifrada. La DEK descifrada se utiliza entonces para cifrar las claves de datos, nivel cuatro, que son generadas aleatoriamente por Redshift para cada bloque de datos en la base de datos.

Puedes usar AWS Trusted Advisor para monitorear la configuraci√≥n de tus buckets de Amazon S3 y asegurarte de que el registro de buckets est√© habilitado, lo cual puede ser √∫til para realizar auditor√≠as de seguridad y rastrear patrones de uso en S3.

### CloudHSM

<details>

<summary>Usando Redshift con CloudHSM</summary>

Cuando trabajas con CloudHSM para realizar tu cifrado, primero debes establecer una conexi√≥n de confianza entre tu cliente HSM y Redshift utilizando certificados de cliente y servidor.

Esta conexi√≥n es necesaria para proporcionar comunicaciones seguras, permitiendo que las claves de cifrado se env√≠en entre tu cliente HSM y tus cl√∫steres de Redshift. Utilizando un par de claves privadas y p√∫blicas generadas aleatoriamente, Redshift crea un certificado de cliente p√∫blico, que es cifrado y almacenado por Redshift. Este debe ser descargado y registrado en tu cliente HSM, y asignado a la partici√≥n HSM correcta.

Luego debes configurar Redshift con los siguientes detalles de tu cliente HSM: la direcci√≥n IP de HSM, el nombre de la partici√≥n HSM, la contrase√±a de la partici√≥n HSM y el certificado de servidor HSM p√∫blico, que es cifrado por CloudHSM utilizando una clave maestra interna. Una vez que se ha proporcionado esta informaci√≥n, Redshift confirmar√° y verificar√° que puede conectarse y acceder a la partici√≥n de desarrollo.

Si tus pol√≠ticas de seguridad internas o controles de gobernanza dictan que debes aplicar rotaci√≥n de claves, entonces esto es posible con Redshift permiti√©ndote rotar las claves de cifrado para cl√∫steres cifrados, sin embargo, debes ser consciente de que durante el proceso de rotaci√≥n de claves, har√° que un cl√∫ster no est√© disponible por un per√≠odo de tiempo muy corto, por lo que es mejor rotar las claves solo cuando sea necesario, o si crees que pueden haber sido comprometidas.

Durante la rotaci√≥n, Redshift rotar√° la CEK para tu cl√∫ster y para cualquier respaldo de ese cl√∫ster. Rotar√° una DEK para el cl√∫ster pero no es posible rotar una DEK para las instant√°neas almacenadas en S3 que han sido cifradas utilizando la DEK. Pondr√° el cl√∫ster en un estado de 'rotaci√≥n de claves' hasta que se complete el proceso cuando el estado volver√° a 'disponible'.

</details>

### Enumeraci√≥n
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistencia

Las siguientes acciones permiten otorgar acceso a otras cuentas de AWS al cl√∫ster:

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al grupo de** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) o al grupo de [**telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
