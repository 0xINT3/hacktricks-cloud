# AWS - Redshift Enum

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks であなたの会社を宣伝したい**場合や、**PEASS の最新バージョンを見たい**場合、または **HackTricks を PDF でダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけてください。これは私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローしてください。
* **HackTricks** と **HackTricks Cloud** の github レポジトリに **PR を提出**して、あなたのハッキングテクニックを共有してください。

</details>

## Amazon Redshift

Redshift は、**ビッグデータソリューションのデータウェアハウス**として使用される、サイズがペタバイトを超えることができる完全に管理されたサービスです。Redshift クラスタを使用すると、高速な SQL ベースのクエリツールとビジネスインテリジェンスアプリケーションを使用してデータセットに対して分析を実行し、ビジネスのビジョンをより深く理解することができます。

**Redshift は、KMS または CloudHSM を使用して、4段階の暗号化キーの階層を使用して、データの暗号化を提供します**。**クラスタに対して暗号化が有効になっている場合、無効にすることはできず、その逆も同様です**。暗号化されていないクラスタは、暗号化することはできません。

クラスタの暗号化は、作成時にのみ行うことができ、一度暗号化されると、データ、メタデータ、およびスナップショットも暗号化されます。暗号化キーの階層レベルは次のとおりです。**第1階層はマスターキー、第2階層はクラスタ暗号化キー（CEK）、第3階層はデータベース暗号化キー（DEK）、最後に第4階層はデータ暗号化キー自体です**。

### KMS

クラスタの作成時に、Redshift の**デフォルトの KMS キー**を選択するか、**独自の CMK**を選択することができます。独自の CMK を選択すると、キーの制御に関して監査の観点からより柔軟性を持つことができます。

Redshift のデフォルトの KMS キーは、キーのオプションが選択されて使用される際に、Redshift によって自動的に作成され、AWS によって完全に管理されます。

この KMS キーは、CMK マスターキー（第1階層）で暗号化されます。この暗号化された KMS データキーは、クラスタ暗号化キー（CEK、第2階層）として使用されます。この CEK は、KMS によって Redshift に送信され、クラスタからは別々に保存されます。Redshift は、この暗号化された CEK をセキュアチャネルを介してクラスタに送信し、メモリに保存します。

Redshift は、その後、KMS に対して CEK（第2階層）を復号するよう要求します。この復号された CEK もメモリに保存されます。Redshift は、ランダムなデータベース暗号化キー（DEK、第3階層）を作成し、それをクラスタのメモリにロードします。メモリ内の復号された CEK は、メモリ内に保存されている DEK を暗号化し、それもメモリに保存します。

この暗号化された DEK は、セキュアチャネルを介して送信され、クラスタから別々に Redshift に保存されます。CEK と DEK の両方は、クラスタのメモリ内に暗号化された形式と復号された形式の両方で保存されます。復号された DEK は、Redshift によってデータベース内の各データブロックごとにランダムに生成されたデータキー（第4階層）を暗号化するために使用されます。

Amazon S3 バケットの構成を監視し、バケットのログ記録が有効になっていることを確認するために、AWS Trusted Advisor を使用することができます。これは、セキュリティ監査や使用パターンの追跡に役立ちます。

### CloudHSM

<details>

<summary>CloudHSM を使用した Redshift の利用</summary>

暗号化を行うために CloudHSM を使用する場合、まず HSM クライアントと Redshift の間で信頼できる接続を設定する必要があります。この接続は、暗号化キーを HSM クライアントと Redshift クラスタの間で送信するための安全な通信を提供するために必要です。ランダムに生成されたプライベートキーとパブリックキーのペアを使用して、Redshift は公開クライアント証明書を作成し、暗号化して Redshift に保存します。これをダウンロードして HSM クライアントに登録し、正しい HSM パーティションに割り当てる必要があります。

次に、Redshift を HSM クライアントの以下の詳細で構成する必要があります。HSM の IP アドレス、HSM パーティション名、HSM パーティションパスワード、および HSM サーバ証明書（CloudHSM によって内部マスターキーを使用して暗号化されます）。これらの情報が提供されると、Redshift は接続でき、開発パーティションにアクセスできることを確認および検証します。

内部のセキュリティポリシーまたはガバナンスコントロールにより、キーのローテーションを適用する必要がある場合は、Redshift を使用して暗号化されたクラスタの暗号化キーをローテーションすることが可能です。ただし、キーのローテーションプロセス中にクラスタが一時的に利用できなくなるため、必要な場合や疑われる場合にのみキーをローテーションすることが最善です。

ローテーション中、Redshift はクラスタの CEK とそのバックアップのための CEK をローテーションします。クラスタの DEK もローテーションしますが、DEK を使用して暗号化された S3 に保存されているスナップショットの DEK をローテーションすることはできません。クラスタは「キーのローテーション中」の状態になり、プロセスが完了すると状態が「利用可能」に戻ります。

</details>

### 列挙
```bash
# Get clusters
aws redshift describe-clusters
## Get if publicly accessible
aws redshift describe-clusters | jq -r ".Clusters[].PubliclyAccessible"
## Get DB username to login
aws redshift describe-clusters | jq -r ".Clusters[].MasterUsername"
## Get endpoint
aws redshift describe-clusters | jq -r ".Clusters[].Endpoint"
## Public addresses of the nodes
aws redshift describe-clusters | jq -r ".Clusters[].ClusterNodes[].PublicIPAddress"
## Get IAM roles of the clusters
aws redshift describe-clusters | jq -r ".Clusters[].IamRoles"

# Endpoint access & authorization
aws redshift describe-endpoint-access
aws redshift describe-endpoint-authorization

# Get credentials
aws redshift get-cluster-credentials --db-user <username> --cluster-identifier <cluster-id>
## By default, the temporary credentials expire in 900 seconds. You can optionally specify a duration between 900 seconds (15 minutes) and 3600 seconds (60 minutes).
aws redshift get-cluster-credentials-with-iam --cluster-identifier <cluster-id>
## Gives creds to access redshift with the IAM redshift permissions given to the current AWS account
## More in https://docs.aws.amazon.com/redshift/latest/mgmt/redshift-iam-access-control-identity-based.html

# Authentication profiles
aws redshift describe-authentication-profiles

# Snapshots
aws redshift describe-cluster-snapshots

# Scheduled actions
aws redshift describe-scheduled-actions

# Connect
# The redshift instance must be publicly available (not by default), the sg need to allow inbounds connections to the port and you need creds
psql -h redshift-cluster-1.sdflju3jdfkfg.us-east-1.redshift.amazonaws.com -U admin -d dev -p 5439
```
## Privesc

{% content-ref url="../../aws-privilege-escalation/aws-redshift-privesc.md" %}
[aws-redshift-privesc.md](../../aws-privilege-escalation/aws-redshift-privesc.md)
{% endcontent-ref %}

## Persistence

以下のアクションにより、他のAWSアカウントにクラスタへのアクセス権限を付与することができます：

* [authorize-endpoint-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-endpoint-access.html)
* [authorize-snapshot-access](https://docs.aws.amazon.com/cli/latest/reference/redshift/authorize-snapshot-access.html)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローしましょう。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有しましょう。

</details>
