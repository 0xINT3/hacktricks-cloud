# AWS - Grundlegende Informationen

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

## Organisationshierarchie

![](<../../../.gitbook/assets/image (151).png>)

### Konten

In AWS gibt es ein **Stammkonto,** das der **√ºbergeordnete Container f√ºr alle Konten** Ihrer **Organisation** ist. Sie m√ºssen jedoch nicht dieses Konto verwenden, um Ressourcen bereitzustellen. Sie k√∂nnen **andere Konten erstellen, um verschiedene AWS**-Infrastrukturen voneinander zu trennen.

Dies ist aus **Sicherheitssicht** sehr interessant, da **ein Konto nicht auf Ressourcen eines anderen Kontos zugreifen kann** (au√üer es werden speziell erstellte Br√ºcken verwendet), sodass Sie Grenzen zwischen Bereitstellungen erstellen k√∂nnen.

Daher gibt es **zwei Arten von Konten in einer Organisation** (wir sprechen von AWS-Konten und nicht von Benutzerkonten): ein einzelnes Konto, das als Verwaltungskonto festgelegt ist, und ein oder mehrere Mitgliedskonten.

*   Das **Verwaltungskonto (das Stammkonto)** ist das Konto, das Sie zur Erstellung der Organisation verwenden. Vom Verwaltungskonto der Organisation aus k√∂nnen Sie Folgendes tun:

* Konten in der Organisation erstellen
* Andere vorhandene Konten zur Organisation einladen
* Konten aus der Organisation entfernen
* Einladungen verwalten
* Richtlinien auf Entit√§ten (St√§mme, OUs oder Konten) innerhalb der Organisation anwenden
* Integration mit unterst√ºtzten AWS-Diensten aktivieren, um Dienstfunktionalit√§t in allen Konten der Organisation bereitzustellen.
* Es ist m√∂glich, sich als Root-Benutzer mit der E-Mail-Adresse und dem Passwort anzumelden, die zur Erstellung dieses Stammkontos/der Organisation verwendet wurden.

Das Verwaltungskonto hat die **Verantwortlichkeiten eines Zahlungskontos** und ist daf√ºr verantwortlich, alle Geb√ºhren zu zahlen, die von den Mitgliedskonten angefallen sind. Sie k√∂nnen das Verwaltungskonto nicht √§ndern.
* **Mitgliedskonten** bilden alle anderen Konten in einer Organisation. Ein Konto kann gleichzeitig nur Mitglied einer Organisation sein. Sie k√∂nnen einem Konto eine Richtlinie zuweisen, um Steuerungen nur auf dieses eine Konto anzuwenden.
* Mitgliedskonten **m√ºssen eine g√ºltige E-Mail-Adresse verwenden** und k√∂nnen einen **Namen** haben. Im Allgemeinen k√∂nnen sie die Abrechnung nicht verwalten (aber ihnen k√∂nnte der Zugriff darauf gew√§hrt werden).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organisationseinheiten**

Konten k√∂nnen in **Organisationseinheiten (OU)** gruppiert werden. Auf diese Weise k√∂nnen Sie **Richtlinien** f√ºr die Organisationseinheit erstellen, die auf alle Unterkonten angewendet werden. Beachten Sie, dass eine OU andere OUs als Unterkonten haben kann.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Eine **Service Control Policy (SCP)** ist eine Richtlinie, die die Dienste und Aktionen spezifiziert, die Benutzer und Rollen in den Konten verwenden k√∂nnen, die von der SCP betroffen sind. SCPs sind **√§hnlich wie IAM-Berechtigungsrichtlinien**, gew√§hren jedoch **keine Berechtigungen**. Stattdessen legen SCPs die **maximalen Berechtigungen** f√ºr eine Organisation, eine organisatorische Einheit (OU) oder ein Konto fest. Wenn Sie eine SCP an Ihre Organisationswurzel oder eine OU anh√§ngen, **beschr√§nkt die SCP die Berechtigungen f√ºr Entit√§ten in Mitgliedskonten**.

Dies ist der **EINZIGE Weg**, um selbst den Root-Benutzer daran zu hindern, etwas zu tun. Zum Beispiel k√∂nnte es verwendet werden, um Benutzer daran zu hindern, CloudTrail zu deaktivieren oder Backups zu l√∂schen.\
Der einzige Weg, dies zu umgehen, besteht darin, auch das **Masterkonto** zu kompromittieren, das die SCPs konfiguriert (das Masterkonto kann nicht blockiert werden).

{% hint style="warning" %}
Beachten Sie, dass **SCPs nur die Prinzipale im Konto einschr√§nken**, sodass andere Konten nicht betroffen sind. Dies bedeutet, dass das Verweigern von `s3:GetObject` durch eine SCP Personen nicht daran hindert, auf einen **√∂ffentlichen S3-Bucket** in Ihrem Konto zuzugreifen.
{% endhint %}

Beispiele f√ºr SCPs:

* Root-Konto vollst√§ndig verweigern
* Nur bestimmte Regionen zulassen
* Nur wei√üe Dienste zulassen
* Deaktivieren von GuardDuty, CloudTrail und S3 Public Block Access verweigern
* L√∂schen oder √Ñndern von Sicherheits-/Incident-Response-Rollen verweigern
* L√∂schen von Backups verweigern
* Erstellen von IAM-Benutzern und Zugriffsschl√ºsseln verweigern

Finden Sie **JSON-Beispiele** unter [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** ist der **eindeutige Name**, den jede Ressource innerhalb von AWS hat, er ist wie folgt aufgebaut:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Hinweis: In AWS gibt es 4 Partitionen, aber nur 3 M√∂glichkeiten, sie zu benennen:

- AWS Standard: `aws`
- AWS China: `aws-cn`
- AWS US √∂ffentliches Internet (GovCloud): `aws-us-gov`
- AWS Secret (US Classified): `aws`

## IAM - Identit√§ts- und Zugriffsverwaltung

IAM ist der Dienst, der es Ihnen erm√∂glicht, **Authentifizierung**, **Autorisierung** und **Zugriffskontrolle** innerhalb Ihres AWS-Kontos zu verwalten.

- **Authentifizierung** - Prozess zur Definition einer Identit√§t und deren √úberpr√ºfung. Dieser Prozess kann unterteilt werden in: Identifizierung und √úberpr√ºfung.
- **Autorisierung** - Bestimmt, auf welche Ressourcen eine Identit√§t innerhalb eines Systems zugreifen kann, sobald sie authentifiziert wurde.
- **Zugriffskontrolle** - Die Methode und der Prozess, wie der Zugriff auf eine sichere Ressource gew√§hrt wird.

IAM kann durch seine F√§higkeit definiert werden, Authentifizierungs-, Autorisierungs- und Zugriffskontrollmechanismen von Identit√§ten f√ºr Ihre Ressourcen innerhalb Ihres AWS-Kontos zu verwalten, zu steuern und zu regeln.

### [AWS-Konto Root-Benutzer](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Wenn Sie ein Amazon Web Services (AWS)-Konto erstellen, beginnen Sie mit einer einzelnen Anmeldeidentit√§t, die **vollen Zugriff auf alle** AWS-Dienste und Ressourcen im Konto hat. Dies ist der AWS-Konto _**Root-Benutzer**_ und wird durch die Anmeldung mit der **E-Mail-Adresse und dem Passwort, die Sie zur Kontoerstellung verwendet haben**, aufgerufen.

Beachten Sie, dass ein neuer **Admin-Benutzer** weniger Berechtigungen hat als der Root-Benutzer.

Aus Sicherheitssicht wird empfohlen, andere Benutzer zu erstellen und diesen nicht zu verwenden.

### [IAM-Benutzer](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Ein IAM-_Benutzer_ ist eine Entit√§t, die Sie in AWS erstellen, um die **Person oder Anwendung darzustellen**, die sie verwendet, um mit AWS zu **interagieren**. Ein Benutzer in AWS besteht aus einem Namen und Anmeldeinformationen (Passwort und bis zu zwei Zugriffsschl√ºssel).

Wenn Sie einen IAM-Benutzer erstellen, erteilen Sie ihm **Berechtigungen**, indem Sie ihn zu einem **Mitglied einer Benutzergruppe** machen, die entsprechende Berechtigungsrichtlinien angeh√§ngt hat (empfohlen), oder indem Sie Richtlinien **direkt an den Benutzer anh√§ngen**.

Benutzer k√∂nnen **MFA aktiviert haben, um sich anzumelden**. API-Token von Benutzern mit MFA sind nicht durch MFA gesch√ºtzt. Wenn Sie den Zugriff von Benutzer-API-Schl√ºsseln mit MFA **einschr√§nken m√∂chten**, m√ºssen Sie in der Richtlinie angeben, dass f√ºr bestimmte Aktionen MFA erforderlich ist (Beispiel [**hier**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

- **Zugriffsschl√ºssel-ID**: 20 zuf√§llige Gro√übuchstaben und Zahlen wie AKHDNAPO86BSHKDIRYT
- **Geheimer Zugriffsschl√ºssel**: 40 zuf√§llige Gro√ü- und Kleinbuchstaben: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Es ist nicht m√∂glich, verlorene geheime Zugriffsschl√ºssel abzurufen).

Wenn Sie den **Zugriffsschl√ºssel √§ndern m√ºssen**, sollten Sie diesem Prozess folgen:\
_Einen neuen Zugriffsschl√ºssel erstellen -> Den neuen Schl√ºssel auf System/Anwendung anwenden -> Den urspr√ºnglichen als inaktiv markieren -> Neuen Zugriffsschl√ºssel testen und √ºberpr√ºfen, ob er funktioniert -> Alten Zugriffsschl√ºssel l√∂schen_

### MFA - Multi-Faktor-Authentifizierung

Es wird verwendet, um eine **zus√§tzliche Authentifizierungsmethode** neben Ihren bestehenden Methoden wie Passwort zu erstellen und somit eine Multi-Faktor-Authentifizierungsebene zu schaffen.\
Sie k√∂nnen eine **kostenlose virtuelle Anwendung oder ein physisches Ger√§t** verwenden. Sie k√∂nnen kostenlose Apps wie Google Authenticator verwenden, um eine MFA in AWS zu aktivieren.

Richtlinien mit MFA-Bedingungen k√∂nnen an Folgendes angeh√§ngt werden:

- Einen IAM-Benutzer oder eine Gruppe
- Eine Ressource wie einen Amazon S3-Bucket, eine Amazon SQS-Warteschlange oder ein Amazon SNS-Thema
- Die Vertrauensrichtlinie einer IAM-Rolle, die von einem Benutzer angenommen werden kann

Wenn Sie auf eine Ressource **√ºber CLI zugreifen m√∂chten**, die **MFA √ºberpr√ºft**, m√ºssen Sie **`GetSessionToken`** aufrufen. Dadurch erhalten Sie ein Token mit Informationen zur MFA.\
Beachten Sie, dass **`AssumeRole`-Anmeldeinformationen diese Informationen nicht enthalten**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Wie [**hier angegeben**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), gibt es viele verschiedene F√§lle, in denen **MFA nicht verwendet werden kann**.

### [IAM-Benutzergruppen](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Eine IAM-[Benutzergruppe](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) ist eine M√∂glichkeit, **Richtlinien gleichzeitig an mehrere Benutzer anzuh√§ngen**, was es einfacher machen kann, die Berechtigungen f√ºr diese Benutzer zu verwalten. **Rollen und Gruppen k√∂nnen nicht Teil einer Gruppe sein**.

Sie k√∂nnen eine **Identit√§tsbasierte Richtlinie an eine Benutzergruppe anh√§ngen**, sodass alle **Benutzer** in der Benutzergruppe **die Berechtigungen der Richtlinie erhalten**. Sie **k√∂nnen eine Benutzergruppe nicht als `Principal` in einer Richtlinie** (wie einer ressourcenbasierten Richtlinie) identifizieren, da Gruppen sich auf Berechtigungen beziehen, nicht auf Authentifizierung, und Prinzipale authentifizierte IAM-Entit√§ten sind.

Hier sind einige wichtige Merkmale von Benutzergruppen:

* Eine Benutzer **gruppe** kann **viele Benutzer enthalten**, und ein **Benutzer** kann **mehreren Gruppen angeh√∂ren**.
* **Benutzergruppen k√∂nnen nicht verschachtelt werden**; sie k√∂nnen nur Benutzer, keine anderen Benutzergruppen enthalten.
* Es gibt **keine Standardbenutzergruppe, die automatisch alle Benutzer im AWS-Konto einschlie√üt**. Wenn Sie eine Benutzergruppe wie diese haben m√∂chten, m√ºssen Sie sie erstellen und jedem neuen Benutzer zuweisen.
* Die Anzahl und Gr√∂√üe der IAM-Ressourcen in einem AWS-Konto, wie die Anzahl der Gruppen und die Anzahl der Gruppen, denen ein Benutzer angeh√∂ren kann, sind begrenzt. Weitere Informationen finden Sie unter [IAM- und AWS STS-Quotas](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [IAM-Rollen](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Eine IAM-**Rolle** ist sehr **√§hnlich** zu einem **Benutzer**, da es sich um eine **Identit√§t mit Berechtigungsrichtlinien handelt, die bestimmen, was** es in AWS tun kann und nicht kann. Eine Rolle **hat jedoch keine Anmeldeinformationen** (Passwort oder Zugriffsschl√ºssel), die damit verbunden sind. Anstatt eindeutig einer Person zugeordnet zu sein, soll eine Rolle von jedem angenommen werden k√∂nnen, der sie ben√∂tigt (und ausreichende Berechtigungen hat). Ein **IAM-Benutzer kann eine Rolle vor√ºbergehend √ºbernehmen**, um unterschiedliche Berechtigungen f√ºr eine bestimmte Aufgabe zu erhalten. Eine Rolle kann einem [**f√∂derierten Benutzer**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) zugewiesen werden, der sich mithilfe eines externen Identit√§tsanbieters und nicht √ºber IAM anmeldet.

Eine IAM-Rolle besteht aus **zwei Arten von Richtlinien**: Eine **Vertrauensrichtlinie**, die nicht leer sein kann und festlegt, **wer die Rolle annehmen kann**, und eine **Berechtigungsrichtlinie**, die nicht leer sein kann und festlegt, **auf was sie zugreifen kann**.

#### AWS Security Token Service (STS)

Der AWS Security Token Service (STS) ist ein Webdienst, der die **Ausstellung tempor√§rer, eingeschr√§nkter Berechtigungen** erleichtert. Er ist speziell f√ºr:

### [Tempor√§re Anmeldeinformationen in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tempor√§re Anmeldeinformationen werden haupts√§chlich mit IAM-Rollen verwendet**, aber es gibt auch andere Verwendungen. Sie k√∂nnen tempor√§re Anmeldeinformationen anfordern, die √ºber einen eingeschr√§nkteren Satz von Berechtigungen als Ihr Standard-IAM-Benutzer verf√ºgen. Dies **verhindert**, dass Sie **versehentlich Aufgaben ausf√ºhren, die von den eingeschr√§nkteren Anmeldeinformationen nicht erlaubt sind**. Ein Vorteil tempor√§rer Anmeldeinformationen ist, dass sie automatisch nach einer festgelegten Zeitdauer ablaufen. Sie haben die Kontrolle dar√ºber, wie lange die Anmeldeinformationen g√ºltig sind.

### Richtlinien

#### Richtlinienberechtigungen

Werden verwendet, um Berechtigungen zuzuweisen. Es gibt 2 Arten:

* Von AWS verwaltete Richtlinien (von AWS vorab konfiguriert)
* Kundenverwaltete Richtlinien: Von Ihnen konfiguriert. Sie k√∂nnen Richtlinien basierend auf von AWS verwalteten Richtlinien erstellen (eine davon √§ndern und Ihre eigene erstellen), den Richtliniengenerator verwenden (eine grafische Benutzeroberfl√§che, die Ihnen beim Gew√§hren und Verweigern von Berechtigungen hilft) oder Ihre eigene schreiben.

Standardm√§√üig ist der Zugriff **verweigert**, der Zugriff wird gew√§hrt, wenn eine explizite Rolle angegeben wurde.\
Wenn ein **einziger "Deny" existiert, wird das "Allow" au√üer Kraft gesetzt**, au√üer f√ºr Anfragen, die die Root-Sicherheitsanmeldeinformationen des AWS-Kontos verwenden (die standardm√§√üig zugelassen sind).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Die [globalen Felder, die f√ºr Bedingungen in jedem Dienst verwendet werden k√∂nnen, sind hier dokumentiert](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
Die [spezifischen Felder, die f√ºr Bedingungen pro Dienst verwendet werden k√∂nnen, sind hier dokumentiert](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline-Richtlinien

Diese Art von Richtlinien wird **direkt einem Benutzer, einer Gruppe oder einer Rolle zugewiesen**. Sie erscheinen dann nicht in der Richtlinienliste, da sie von jedem anderen verwendet werden k√∂nnen.\
Inline-Richtlinien sind n√ºtzlich, wenn Sie eine **streng eins-zu-eins-Beziehung zwischen einer Richtlinie und der Identit√§t aufrechterhalten** m√∂chten, auf die sie angewendet wird. Wenn Sie beispielsweise sicherstellen m√∂chten, dass die Berechtigungen in einer Richtlinie nicht versehentlich einer anderen Identit√§t als der vorgesehenen zugewiesen werden. Wenn Sie eine Inline-Richtlinie verwenden, k√∂nnen die Berechtigungen in der Richtlinie nicht versehentlich an die falsche Identit√§t angeh√§ngt werden. Dar√ºber hinaus werden die Richtlinien, die in der Identit√§t eingebettet sind, gel√∂scht, wenn Sie die Identit√§t mit der AWS Management Console l√∂schen. Das liegt daran, dass sie Teil der Hauptentit√§t sind.

#### Ressourcen-Bucket-Richtlinien

Dies sind **Richtlinien**, die in **Ressourcen** definiert werden k√∂nnen. **Nicht alle Ressourcen von AWS unterst√ºtzen sie**.

Wenn einem Haupt keine explizite Verweigerung vorliegt und eine Ressourcenrichtlinie ihnen Zugriff gew√§hrt, sind sie erlaubt.

### IAM-Grenzen

IAM-Grenzen k√∂nnen verwendet werden, um die Berechtigungen zu **beschr√§nken, auf die ein Benutzer oder eine Rolle Zugriff haben sollte**. Auf diese Weise schl√§gt der Vorgang fehl, selbst wenn einem Benutzer durch eine **andere Richtlinie** ein anderes Berechtigungsset gew√§hrt wird, wenn er versucht, sie zu verwenden.

Eine Grenze ist nur eine Richtlinie, die einem Benutzer angeh√§ngt ist und **den maximalen Berechtigungsgrad angibt, den der Benutzer oder die Rolle haben kann**. Also, **selbst wenn der Benutzer Administratorzugriff hat**, wenn die Grenze angibt, dass er nur Lesezugriff auf S3-Buckets hat, ist das das Maximum, was er tun kann.

**Dies**, **SCPs** und **das Befolgen des Prinzips des geringsten Privilegs** sind die M√∂glichkeiten, um sicherzustellen, dass Benutzer nicht mehr Berechtigungen haben als die, die sie ben√∂tigen.

### Sitzungsrichtlinien

Eine Sitzungsrichtlinie ist eine **Richtlinie, die festgelegt wird, wenn eine Rolle angenommen wird**. Dies wird wie eine **IAM-Grenze f√ºr diese Sitzung** sein: Das bedeutet, dass die Sitzungsrichtlinie keine Berechtigungen gew√§hrt, sondern sie auf die in der Richtlinie angegebenen beschr√§nkt (wobei die maximalen Berechtigungen diejenigen sind, die die Rolle hat).

Dies ist n√ºtzlich f√ºr **Sicherheitsma√ünahmen**: Wenn ein Administrator eine sehr privilegierte Rolle √ºbernimmt, k√∂nnte er die Berechtigung auf nur die in der Sitzungsrichtlinie angegebenen beschr√§nken, falls die Sitzung kompromittiert wird.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Hinweis: Standardm√§√üig **kann AWS Sitzungsrichtlinien zu Sitzungen hinzuf√ºgen**, die aufgrund von Drittanbietergr√ºnden generiert werden. Zum Beispiel generiert AWS standardm√§√üig in [nicht authentifizierten Cognito angenommenen Rollen](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) (bei Verwendung der erweiterten Authentifizierung) **Sitzungsanmeldeinformationen mit einer Sitzungsrichtlinie**, die die Dienste einschr√§nkt, auf die die Sitzung zugreifen kann [**zu der folgenden Liste**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Daher, wenn Sie irgendwann den Fehler "..., weil keine Sitzungsrichtlinie den ..." erhalten und die Rolle Zugriff auf die Aktion hat, liegt dies daran, dass **eine Sitzungsrichtlinie dies verhindert**.

### Identit√§tsf√∂deration

Die Identit√§tsf√∂deration **erm√∂glicht es Benutzern von externen Identit√§tsanbietern**, sicher auf AWS-Ressourcen zuzugreifen, ohne AWS-Benutzeranmeldeinformationen von einem g√ºltigen IAM-Benutzerkonto bereitzustellen. Ein Beispiel f√ºr einen Identit√§tsanbieter kann Ihr eigenes Unternehmens-**Microsoft Active Directory**(√ºber **SAML**) oder **OpenID**-Dienste (wie **Google**) sein. Durch den f√∂derierten Zugriff k√∂nnen die Benutzer darin auf AWS zugreifen.

Um dieses Vertrauen zu konfigurieren, wird ein **IAM-Identit√§tsanbieter (SAML oder OAuth)** generiert, der dem **anderen Plattform** vertraut. Dann wird mindestens eine **IAM-Rolle (Vertrauen) dem Identit√§tsanbieter** zugewiesen. Wenn ein Benutzer von der vertrauensw√ºrdigen Plattform auf AWS zugreift, geschieht dies als die genannte Rolle.

Normalerweise m√∂chten Sie jedoch je nach Benutzergruppe in der Drittanbieterplattform eine **unterschiedliche Rolle zuweisen**. Dann k√∂nnen mehrere **IAM-Rollen dem Drittanbieter-Identit√§tsanbieter vertrauen**, und die Drittanbieterplattform wird den Benutzern erm√∂glichen, die eine oder andere Rolle anzunehmen.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM-Identit√§tszentrum

Das AWS IAM-Identit√§tszentrum (Nachfolger von AWS Single Sign-On) erweitert die M√∂glichkeiten von AWS Identity and Access Management (IAM), um einen **zentralen Ort** bereitzustellen, der die **Verwaltung von Benutzern und deren Zugriff auf AWS**-Konten und Cloud-Anwendungen zusammenf√ºhrt.

Die Anmeldedom√§ne wird etwas wie `<user_input>.awsapps.com` sein.

Zum Anmelden k√∂nnen 3 Identit√§tsquellen verwendet werden:

* Identit√§tszentrum-Verzeichnis: Regul√§re AWS-Benutzer
* Active Directory: Unterst√ºtzt verschiedene Connector
* Externer Identit√§tsanbieter: Alle Benutzer und Gruppen stammen von einem externen Identit√§tsanbieter (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Im einfachsten Fall des Identit√§tszentrum-Verzeichnisses wird das **Identit√§tszentrum eine Liste von Benutzern & Gruppen haben** und wird in der Lage sein, **Richtlinien** f√ºr sie **einem der Konten** der Organisation zuzuweisen.

Um einem Identit√§tszentrum-Benutzer/Gruppe Zugriff auf ein Konto zu gew√§hren, wird ein **SAML-Identit√§tsanbieter, der dem Identit√§tszentrum vertraut, erstellt**, und eine **Rolle, die dem Identit√§tsanbieter mit den angegebenen Richtlinien vertraut, wird im Zielskonto erstellt**.

#### AwsSSOInlinePolicy

Es ist m√∂glich, **Berechtigungen √ºber Inline-Richtlinien f√ºr im IAM-Identit√§tszentrum erstellte Rollen zu erteilen**. Die in den Konten erstellten Rollen, die im AWS-Identit√§tszentrum **Inline-Richtlinien haben**, haben diese Berechtigungen in einer Inline-Richtlinie namens **`AwsSSOInlinePolicy`**.

Daher bedeutet selbst wenn Sie 2 Rollen mit einer Inline-Richtlinie namens **`AwsSSOInlinePolicy`** sehen, **bedeutet dies nicht, dass sie die gleichen Berechtigungen haben**.

### Vertrauen und Rollen zwischen Konten

**Ein Benutzer** (Vertrauender) kann eine Cross-Account-Rolle mit bestimmten Richtlinien erstellen und dann einem anderen Benutzer (Vertrauensw√ºrdigen) **den Zugriff auf sein Konto erlauben**, jedoch nur mit den im neuen Rollenrichtlinien angegebenen Zugriffen. Um dies zu erstellen, erstellen Sie einfach eine neue Rolle und w√§hlen Sie Cross-Account-Rolle aus. Rollen f√ºr den Zugriff zwischen AWS-Konten bieten zwei Optionen. Bereitstellung von Zugriff zwischen AWS-Konten, die Ihnen geh√∂ren, und Bereitstellung von Zugriff zwischen einem Konto, das Ihnen geh√∂rt, und einem AWS-Konto eines Drittanbieters.\
Es wird empfohlen, **den vertrauensw√ºrdigen Benutzer zu spezifizieren und keine generische Bezeichnung zu verwenden**, da andernfalls auch andere authentifizierte Benutzer wie f√∂derierte Benutzer dieses Vertrauen missbrauchen k√∂nnen.

### AWS Simple AD

Nicht unterst√ºtzt:

* Vertrauensbeziehungen
* AD-Verwaltungszentrum
* Vollst√§ndige PS-API-Unterst√ºtzung
* AD-Papierkorb
* Gruppenverwaltete Dienstkonten
* Schemaerweiterungen
* Kein direkter Zugriff auf das Betriebssystem oder Instanzen

#### Web-F√∂deration oder OpenID-Authentifizierung

Die App verwendet AssumeRoleWithWebIdentity, um tempor√§re Anmeldeinformationen zu erstellen. Dies gew√§hrt jedoch keinen Zugriff auf die AWS-Konsole, sondern nur Zugriff auf Ressourcen innerhalb von AWS.

### Weitere IAM-Optionen

* Sie k√∂nnen **eine Kennwortrichtlinie festlegen** und Optionen wie Mindestl√§nge und Kennwortanforderungen festlegen.
* Sie k√∂nnen einen **"Credential Report" herunterladen** mit Informationen zu aktuellen Anmeldeinformationen (wie Benutzererstellungszeit, ist Kennwort aktiviert...). Sie k√∂nnen einen Anmeldeinformationsbericht so oft wie alle **vier Stunden** generieren.

AWS Identity and Access Management (IAM) bietet **feink√∂rnige Zugriffssteuerung** f√ºr alle AWS-Dienste. Mit IAM k√∂nnen Sie festlegen, **wer auf welche Dienste und Ressourcen zugreifen kann** und unter welchen Bedingungen. Mit IAM-Richtlinien verwalten Sie Berechtigungen f√ºr Ihre Mitarbeiter und Systeme, um **Berechtigungen mit minimalen Rechten zu gew√§hrleisten**.

### IAM-ID-Pr√§fixe

Auf [**dieser Seite**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) finden Sie die **IAM-ID-Pr√§fixe** von Schl√ºsseln je nach ihrer Art:

| ABIA | [AWS STS-Diensttr√§gertoken](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Kontextspezifische Anmeldeinformationen                                                                                                                                                                                           |
| AGPA | Benutzergruppe                                                                                                                                                                                                            |
| AIDA | IAM-Benutzer                                                                                                                                                                                                              |
| AIPA | Amazon EC2-Instanzprofil                                                                                                                                                                                           |
| AKIA | Zugriffsschl√ºssel                                                                                                                                                                                                            |
| ANPA | Verwaltete Richtlinie                                                                                                                                                                                                        |
| ANVA | Version in einer verwalteten Richtlinie                                                                                                                                                                                           |
| APKA | √ñffentlicher Schl√ºssel                                                                                                                                                                                                            |
| AROA | Rolle                                                                                                                                                                                                                  |
| ASCA | Zertifikat                                                                                                                                                                                                           |
| ASIA | [Tempor√§re (AWS STS) Zugriffsschl√ºssel-IDs](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) verwenden dieses Pr√§fix, sind jedoch nur in Kombination mit dem geheimen Zugriffsschl√ºssel und dem Sitzungstoken eindeutig. |

### Empfohlene Berechtigungen zur √úberpr√ºfung von Konten

Die folgenden Berechtigungen gew√§hren verschiedene Lesezugriffe auf Metadaten:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Sonstiges

### CLI-Authentifizierung

Damit ein regul√§rer Benutzer sich √ºber die CLI bei AWS authentifizieren kann, ben√∂tigen Sie **lokale Anmeldeinformationen**. Standardm√§√üig k√∂nnen Sie sie **manuell** in `~/.aws/credentials` konfigurieren oder durch Ausf√ºhren von `aws configure`.\
In dieser Datei k√∂nnen Sie mehr als ein Profil haben. Wenn beim **aws cli** kein Profil angegeben ist, wird dasjenige namens **`[default]`** in dieser Datei verwendet.\
Beispiel f√ºr eine Anmeldeinformationsdatei mit mehr als 1 Profil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Wenn Sie auf **verschiedene AWS-Konten** zugreifen m√ºssen und Ihr Profil Zugriff erhalten hat, **um eine Rolle in diesen Konten anzunehmen**, m√ºssen Sie nicht jedes Mal manuell STS aufrufen (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) und die Anmeldeinformationen konfigurieren.

Sie k√∂nnen die Datei `~/.aws/config` verwenden, um [**anzugeben, welche Rollen angenommen werden sollen**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), und dann den `--profile`-Parameter wie gewohnt verwenden (die `assume-role` wird transparent f√ºr den Benutzer durchgef√ºhrt).\
Ein Beispiel f√ºr eine Konfigurationsdatei:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Mit dieser Konfigurationsdatei k√∂nnen Sie dann aws cli wie folgt verwenden:
```
aws --profile acc2 ...
```
Wenn Sie etwas **√Ñhnliches** wie dies, aber f√ºr den **Browser** suchen, k√∂nnen Sie die **Erweiterung** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en) √ºberpr√ºfen.

## Referenzen

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
