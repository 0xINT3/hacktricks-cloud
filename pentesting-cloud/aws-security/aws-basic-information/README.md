# AWS - Informaci칩n B치sica

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Jerarqu칤a de la Organizaci칩n

![](<../../../.gitbook/assets/image (54).png>)

### Cuentas

En AWS existe una **cuenta ra칤z,** que es el **contenedor principal para todas las cuentas** de tu **organizaci칩n**. Sin embargo, no necesitas usar esa cuenta para desplegar recursos, puedes crear **otras cuentas para separar diferentes infraestructuras de AWS** entre ellas.

Esto es muy interesante desde un punto de vista de **seguridad**, ya que **una cuenta no podr치 acceder a recursos de otra cuenta** (a menos que se creen puentes espec칤ficamente), de esta manera puedes crear l칤mites entre despliegues.

Por lo tanto, hay **dos tipos de cuentas en una organizaci칩n** (estamos hablando de cuentas de AWS y no de cuentas de usuario): una 칰nica cuenta designada como la cuenta de gesti칩n, y una o m치s cuentas miembro.

*   La **cuenta de gesti칩n (la cuenta ra칤z)** es la cuenta que utilizas para crear la organizaci칩n. Desde la cuenta de gesti칩n de la organizaci칩n, puedes hacer lo siguiente:

* Crear cuentas en la organizaci칩n
* Invitar a otras cuentas existentes a la organizaci칩n
* Eliminar cuentas de la organizaci칩n
* Gestionar invitaciones
* Aplicar pol칤ticas a entidades (ra칤ces, OUs o cuentas) dentro de la organizaci칩n
* Habilitar la integraci칩n con servicios de AWS compatibles para proporcionar funcionalidad del servicio en todas las cuentas de la organizaci칩n.
* Es posible iniciar sesi칩n como el usuario ra칤z utilizando el correo electr칩nico y la contrase침a utilizados para crear esta cuenta ra칤z/organizaci칩n.

La cuenta de gesti칩n tiene las **responsabilidades de una cuenta pagadora** y es responsable de pagar todos los cargos que acumulen las cuentas miembro. No puedes cambiar la cuenta de gesti칩n de una organizaci칩n.
* Las **cuentas miembro** constituyen todas las dem치s cuentas de una organizaci칩n. Una cuenta solo puede ser miembro de una organizaci칩n a la vez. Puedes adjuntar una pol칤tica a una cuenta para aplicar controles solo a esa cuenta.
* Las cuentas miembro **deben usar una direcci칩n de correo electr칩nico v치lida** y pueden tener un **nombre**, en general no podr치n gestionar la facturaci칩n (pero se les podr칤a dar acceso a ella).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Unidades Organizativas**

Las cuentas pueden agruparse en **Unidades Organizativas (OU)**. De esta manera, puedes crear **pol칤ticas** para la Unidad Organizativa que se **aplicar치n a todas las cuentas hijas**. Ten en cuenta que una OU puede tener otras OUs como hijas.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Pol칤tica de Control de Servicios (SCP)

Una **pol칤tica de control de servicios (SCP)** es una pol칤tica que especifica los servicios y acciones que los usuarios y roles pueden utilizar en las cuentas que la SCP afecta. Las SCP son **similares a las pol칤ticas de permisos de IAM** excepto que **no otorgan permisos**. En cambio, las SCP especifican los **permisos m치ximos** para una organizaci칩n, unidad organizativa (OU) o cuenta. Al adjuntar una SCP a la ra칤z de tu organizaci칩n o una OU, la **SCP limita los permisos para las entidades en cuentas miembro**.

Esta es la 칔NICA manera de que **incluso el usuario root pueda ser detenido** de hacer algo. Por ejemplo, podr칤a usarse para evitar que los usuarios desactiven CloudTrail o eliminen copias de seguridad.\
La 칰nica manera de eludir esto es comprometiendo tambi칠n la **cuenta maestra** que configura las SCPs (la cuenta maestra no puede ser bloqueada).

{% hint style="warning" %}
Nota que **las SCP solo restringen a los principios en la cuenta**, por lo que otras cuentas no se ven afectadas. Esto significa que tener una SCP que niegue `s3:GetObject` no impedir치 que las personas **accedan a un bucket S3 p칰blico** en tu cuenta.
{% endhint %}

Ejemplos de SCP:

* Negar completamente la cuenta root
* Solo permitir regiones espec칤ficas
* Solo permitir servicios en la lista blanca
*   Negar que se desactiven GuardDuty, CloudTrail y el Bloqueo de Acceso P칰blico de S3
*   Negar que se eliminen o modifiquen roles de seguridad/respuesta a incidentes.
* Negar que se eliminen las copias de seguridad.
* Negar la creaci칩n de usuarios IAM y claves de acceso

Encuentra **ejemplos en JSON** en [https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html)

### ARN

**Amazon Resource Name** es el **nombre 칰nico** que tiene cada recurso dentro de AWS, est치 compuesto de la siguiente manera:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Tenga en cuenta que hay 4 particiones en AWS, pero solo 3 formas de llamarlas:

* AWS Est치ndar: `aws`
* AWS China: `aws-cn`
* AWS US Internet p칰blico (GovCloud): `aws-us-gov`
* AWS Secreto (Clasificado de EE. UU.): `aws`

## IAM - Gesti칩n de Identidad y Acceso

IAM es el servicio que le permitir치 gestionar **Autenticaci칩n**, **Autorizaci칩n** y **Control de Acceso** dentro de su cuenta de AWS.

* **Autenticaci칩n** - Proceso de definir una identidad y la verificaci칩n de esa identidad. Este proceso puede subdividirse en: Identificaci칩n y verificaci칩n.
* **Autorizaci칩n** - Determina a qu칠 puede acceder una identidad dentro de un sistema una vez que ha sido autenticada en 칠l.
* **Control de Acceso** - El m칠todo y proceso de c칩mo se concede el acceso a un recurso seguro

IAM se puede definir por su capacidad para gestionar, controlar y gobernar mecanismos de autenticaci칩n, autorizaci칩n y control de acceso de identidades a sus recursos dentro de su cuenta de AWS.

### [Usuario ra칤z de la cuenta de AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html) <a href="#id_root" id="id_root"></a>

Cuando crea una cuenta de Amazon Web Services (AWS) por primera vez, comienza con una 칰nica identidad de inicio de sesi칩n que tiene **acceso completo a todos** los servicios y recursos de AWS en la cuenta. Esta es el _**usuario ra칤z**_ de la cuenta de AWS y se accede iniciando sesi칩n con la **direcci칩n de correo electr칩nico y contrase침a que utiliz칩 para crear la cuenta**.

Tenga en cuenta que un nuevo **usuario administrador** tendr치 **menos permisos que el usuario ra칤z**.

Desde un punto de vista de seguridad, se recomienda crear otros usuarios y evitar usar este.

### [Usuarios de IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _usuario_ de IAM es una entidad que crea en AWS para **representar a la persona o aplicaci칩n** que lo utiliza para **interactuar con AWS**. Un usuario en AWS consta de un nombre y credenciales (contrase침a y hasta dos claves de acceso).

Cuando crea un usuario de IAM, le otorga **permisos** haci칠ndolo **miembro de un grupo de usuarios** que tiene pol칤ticas de permisos adjuntas apropiadas (recomendado), o **adjuntando pol칤ticas directamente** al usuario.

Los usuarios pueden tener **MFA habilitado para iniciar sesi칩n** a trav칠s de la consola. Los tokens de API de usuarios con MFA habilitado no est치n protegidos por MFA. Si desea **restringir el acceso de las claves API de un usuario utilizando MFA**, debe indicar en la pol칤tica que para realizar ciertas acciones se necesita tener MFA presente (ejemplo [**aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html)).

#### CLI

* **ID de clave de acceso**: 20 caracteres alfanum칠ricos aleatorios en may칰sculas como AKHDNAPO86BSHKDIRYT
* **ID de clave de acceso secreta**: 40 caracteres aleatorios en may칰sculas y min칰sculas: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (No es posible recuperar IDs de claves de acceso secretas perdidas).

Siempre que necesite **cambiar la clave de acceso**, este es el proceso que debe seguir:\
_Crear una nueva clave de acceso -> Aplicar la nueva clave al sistema/aplicaci칩n -> marcar la original como inactiva -> Probar y verificar que la nueva clave de acceso funciona -> Eliminar la clave de acceso antigua_

### MFA - Autenticaci칩n de M칰ltiples Factores

Se utiliza para **crear un factor adicional para la autenticaci칩n** adem치s de sus m칠todos existentes, como la contrase침a, creando as칤 un nivel de autenticaci칩n de m칰ltiples factores.\
Puede usar una **aplicaci칩n virtual gratuita o un dispositivo f칤sico**. Puede usar aplicaciones como la autenticaci칩n de Google de forma gratuita para activar un MFA en AWS.

Las pol칤ticas con condiciones de MFA se pueden adjuntar a lo siguiente:

* Un usuario o grupo de IAM
* Un recurso como un bucket de Amazon S3, una cola de Amazon SQS o un tema de Amazon SNS
* La pol칤tica de confianza de un rol de IAM que puede ser asumido por un usuario

Si desea **acceder a trav칠s de CLI** a un recurso que **verifica MFA**, necesita llamar a **`GetSessionToken`**. Eso le dar치 un token con informaci칩n sobre MFA.\
Tenga en cuenta que las credenciales de **`AssumeRole`** no contienen esta informaci칩n.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Como [**se indica aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html), hay muchos casos diferentes donde **no se puede utilizar MFA**.

### [Grupos de usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un [grupo de usuarios](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) IAM es una forma de **adjuntar pol칤ticas a m칰ltiples usuarios** al mismo tiempo, lo que puede facilitar la gesti칩n de los permisos para esos usuarios. **Los roles y grupos no pueden formar parte de un grupo**.

Puedes adjuntar una **pol칤tica basada en identidad a un grupo de usuarios** para que todos los **usuarios** del grupo reciban los **permisos de la pol칤tica**. **No puedes** identificar un **grupo de usuarios** como un **`Principal`** en una **pol칤tica** (como una pol칤tica basada en recursos) porque los grupos se relacionan con permisos, no con autenticaci칩n, y los principales son entidades IAM autenticadas.

Aqu칤 hay algunas caracter칤sticas importantes de los grupos de usuarios:

* Un **grupo** puede **contener muchos usuarios**, y un **usuario** puede **pertenecer a m칰ltiples grupos**.
* **Los grupos de usuarios no pueden anidarse**; solo pueden contener usuarios, no otros grupos de usuarios.
* **No hay un grupo de usuarios predeterminado que incluya autom치ticamente a todos los usuarios en la cuenta de AWS**. Si deseas tener un grupo de usuarios as칤, debes crearlo y asignar cada nuevo usuario a 칠l.
* El n칰mero y tama침o de los recursos IAM en una cuenta de AWS, como el n칰mero de grupos y la cantidad de grupos a los que un usuario puede pertenecer, est치n limitados. Para m치s informaci칩n, consulta [Cuotas de IAM y AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-quotas.html).

### [Roles IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **rol** IAM es muy **similar** a un **usuario**, en el sentido de que es una **identidad con pol칤ticas de permisos que determinan qu칠** puede y no puede hacer en AWS. Sin embargo, un rol **no tiene credenciales** (contrase침a o claves de acceso) asociadas. En lugar de estar asociado de manera 칰nica con una persona, un rol est치 destinado a ser **asumible por cualquier persona que lo necesite (y tenga suficientes permisos)**. Un **usuario IAM puede asumir un rol temporalmente** para adoptar diferentes permisos para una tarea espec칤fica. Un rol puede ser **asignado a un** [**usuario federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html) que inicia sesi칩n utilizando un proveedor de identidad externo en lugar de IAM.

Un rol IAM consta de **dos tipos de pol칤ticas**: Una **pol칤tica de confianza**, que no puede estar vac칤a, definiendo **qui칠n puede asumir** el rol, y una **pol칤tica de permisos**, que no puede estar vac칤a, definiendo **a qu칠 puede acceder**.

#### Servicio de Token de Seguridad de AWS (STS)

Este es un servicio web que te permite **solicitar credenciales temporales y de privilegio limitado** para usuarios de AWS Identity and Access Management (IAM) o para usuarios que autentiques (usuarios federados).

### [Credenciales temporales en IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Las credenciales temporales se utilizan principalmente con roles IAM**, pero tambi칠n tienen otros usos. Puedes solicitar credenciales temporales que tengan un conjunto de permisos m치s restringido que tu usuario IAM est치ndar. Esto **previene** que **accidentalmente realices tareas que no est치n permitidas** por las credenciales m치s restringidas. Una ventaja de las credenciales temporales es que expiran autom치ticamente despu칠s de un per칤odo de tiempo establecido. Tienes control sobre la duraci칩n de validez de las credenciales.

### Pol칤ticas

#### Permisos de Pol칤tica

Se utilizan para asignar permisos. Hay 2 tipos:

* Pol칤ticas gestionadas por AWS (preconfiguradas por AWS)
* Pol칤ticas gestionadas por el cliente: Configuradas por ti. Puedes crear pol칤ticas basadas en pol칤ticas gestionadas por AWS (modificando una de ellas y creando la tuya propia), utilizando el generador de pol칤ticas (una vista GUI que te ayuda a otorgar y negar permisos) o escribiendo tus propias pol칤ticas.

Por **defecto el acceso** es **denegado**, el acceso ser치 otorgado si se ha especificado un rol expl칤cito.\
Si existe un 칰nico "Denegar", este anular치 el "Permitir", excepto para las solicitudes que usen las credenciales de seguridad ra칤z de la cuenta de AWS (que est치n permitidas por defecto).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Los [campos globales que se pueden utilizar para condiciones en cualquier servicio est치n documentados aqu칤](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-resourceaccount).
Los [campos espec칤ficos que se pueden utilizar para condiciones por servicio est치n documentados aqu칤](https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html).

#### Pol칤ticas Integradas

Este tipo de pol칤ticas est치n **asignadas directamente** a un usuario, grupo o rol. Entonces, no aparecen en la lista de Pol칤ticas como cualquier otra que pueda ser utilizada por otros.
Las pol칤ticas integradas son 칰tiles si quieres **mantener una estricta relaci칩n uno a uno entre una pol칤tica y la identidad** a la que se aplica. Por ejemplo, quieres estar seguro de que los permisos en una pol칤tica no sean asignados inadvertidamente a una identidad diferente a la que est치n destinados. Cuando usas una pol칤tica integrada, los permisos en la pol칤tica no pueden ser adjuntados inadvertidamente a la identidad incorrecta. Adem치s, cuando usas la Consola de Administraci칩n de AWS para eliminar esa identidad, las pol칤ticas incrustadas en la identidad tambi칠n se eliminan. Eso es porque son parte de la entidad principal.

#### Pol칤ticas de Cubo de Recursos

Estas son **pol칤ticas** que pueden ser definidas en **recursos**. **No todos los recursos de AWS las soportan**.

Si un principal no tiene una negaci칩n expl칤cita sobre ellas, y una pol칤tica de recurso les otorga acceso, entonces se les permite.

### L칤mites de IAM

Los l칤mites de IAM se pueden usar para **limitar los permisos a los que un usuario o rol deber칤a tener acceso**. De esta manera, incluso si un conjunto diferente de permisos se otorgan al usuario por una **pol칤tica diferente**, la operaci칩n **fallar치** si intenta usarlos.

Un l칤mite es solo una pol칤tica adjunta a un usuario que **indica el nivel m치ximo de permisos que el usuario o rol puede tener**. As칤 que, **incluso si el usuario tiene acceso de Administrador**, si el l칤mite indica que solo puede leer cubos S3, eso es lo m치ximo que puede hacer.

**Esto**, **SCPs** y **seguir el principio de menor privilegio** son las formas de controlar que los usuarios no tengan m치s permisos de los que necesitan.

### Pol칤ticas de Sesi칩n

Una pol칤tica de sesi칩n es una **pol칤tica establecida cuando se asume un rol** de alguna manera. Esto ser치 como un **l칤mite de IAM para esa sesi칩n**: Esto significa que la pol칤tica de sesi칩n no otorga permisos sino que **los restringe a los indicados en la pol칤tica** (siendo los permisos m치ximos los que el rol tiene).

Esto es 칰til para **medidas de seguridad**: Cuando un administrador va a asumir un rol muy privilegiado, podr칤a restringir el permiso solo a los indicados en la pol칤tica de sesi칩n en caso de que la sesi칩n se vea comprometida.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Tenga en cuenta que, por defecto, **AWS podr칤a agregar pol칤ticas de sesi칩n a las sesiones** que se van a generar debido a terceros motivos. Por ejemplo, en [roles asumidos de cognito no autenticados](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) por defecto (usando autenticaci칩n mejorada), AWS generar치 **credenciales de sesi칩n con una pol칤tica de sesi칩n** que limita los servicios a los que la sesi칩n puede acceder [**a la siguiente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Por lo tanto, si en alg칰n momento se enfrenta al error "... porque ninguna pol칤tica de sesi칩n permite ...", y el rol tiene acceso para realizar la acci칩n, es porque **hay una pol칤tica de sesi칩n que lo impide**.

### Federaci칩n de Identidades

La federaci칩n de identidades **permite a usuarios de proveedores de identidad externos** a AWS acceder a recursos de AWS de manera segura sin tener que proporcionar credenciales de usuario de AWS de una cuenta IAM v치lida.\
Un ejemplo de un proveedor de identidad puede ser su propio **Microsoft Active Directory** corporativo (a trav칠s de **SAML**) o servicios **OpenID** (como **Google**). El acceso federado permitir치 entonces a los usuarios dentro de 칠l acceder a AWS.

Para configurar esta confianza, se genera un **Proveedor de Identidad IAM (SAML u OAuth)** que **confiar치** en **otra plataforma**. Luego, al menos un **rol IAM se asigna (confiando) al Proveedor de Identidad**. Si un usuario de la plataforma de confianza accede a AWS, lo har치 como el rol mencionado.

Sin embargo, normalmente querr치 dar un **rol diferente dependiendo del grupo del usuario** en la plataforma de terceros. Entonces, varios **roles IAM pueden confiar** en el Proveedor de Identidad de terceros y la plataforma de terceros ser치 la que permita a los usuarios asumir un rol u otro.

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (sucesor de AWS Single Sign-On) ampl칤a las capacidades de AWS Identity and Access Management (IAM) para proporcionar un **lugar central** que re칰ne la **administraci칩n de usuarios y su acceso a cuentas de AWS** y aplicaciones en la nube.

El dominio de inicio de sesi칩n ser치 algo como `<user_input>.awsapps.com`.

Para iniciar sesi칩n de usuarios, hay 3 fuentes de identidad que se pueden usar:

* Directorio de Identity Center: Usuarios regulares de AWS
* Active Directory: Soporta diferentes conectores
* Proveedor de Identidad Externo: Todos los usuarios y grupos provienen de un Proveedor de Identidad Externo (IdP)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

En el caso m치s simple del directorio de Identity Center, el **Identity Center tendr치 una lista de usuarios y grupos** y podr치 **asignar pol칤ticas** a ellos para **cualquiera de las cuentas** de la organizaci칩n.

Para dar acceso a un usuario/grupo de Identity Center a una cuenta, se crear치 un **Proveedor de Identidad SAML que conf칤e en el Identity Center**, y un **rol que conf칤e en el Proveedor de Identidad con las pol칤ticas indicadas se crear치** en la cuenta de destino.

#### AwsSSOInlinePolicy

Es posible **dar permisos a trav칠s de pol칤ticas inline a roles creados a trav칠s de IAM Identity Center**. Los roles creados en las cuentas que reciben **pol칤ticas inline en AWS Identity Center** tendr치n estos permisos en una pol칤tica inline llamada **`AwsSSOInlinePolicy`**.

Por lo tanto, incluso si ve 2 roles con una pol칤tica inline llamada **`AwsSSOInlinePolicy`**, **no significa que tenga los mismos permisos**.

### Confianzas y Roles entre Cuentas

**Un usuario** (confiante) puede crear un Rol entre Cuentas con algunas pol칤ticas y luego, **permitir a otro usuario** (confiado) **acceder a su cuenta** pero solo **teniendo el acceso indicado en las pol칤ticas del nuevo rol**. Para crear esto, solo cree un nuevo Rol y seleccione Rol entre Cuentas. Los Roles para Acceso entre Cuentas ofrecen dos opciones. Proporcionar acceso entre cuentas de AWS que usted posee, y proporcionar acceso entre una cuenta que usted posee y una cuenta de AWS de terceros.\
Se recomienda **especificar el usuario que es de confianza y no poner algo gen칠rico** porque si no, otros usuarios autenticados como usuarios federados tambi칠n podr치n abusar de esta confianza.

### AWS Simple AD

No soportado:

* Relaciones de Confianza
* Centro de Administraci칩n de AD
* Soporte completo de API de PS
* Papelera de Reciclaje de AD
* Cuentas de Servicio Administradas por Grupo
* Extensiones de Esquema
* No Acceso Directo al SO o Instancias

#### Federaci칩n Web o Autenticaci칩n OpenID

La aplicaci칩n utiliza AssumeRoleWithWebIdentity para crear credenciales temporales. Sin embargo, esto no otorga acceso a la consola de AWS, solo acceso a recursos dentro de AWS.

### Otras opciones de IAM

* Puede **establecer una pol칤tica de contrase침a** con opciones como longitud m칤nima y requisitos de contrase침a.
* Puede **descargar "Informe de Credenciales"** con informaci칩n sobre las credenciales actuales (como tiempo de creaci칩n del usuario, si la contrase침a est치 habilitada...). Puede generar un informe de credenciales tan a menudo como cada **cuatro horas**.

AWS Identity and Access Management (IAM) proporciona **control de acceso detallado** en todo AWS. Con IAM, puede especificar **qui칠n puede acceder a qu칠 servicios y recursos**, y bajo qu칠 condiciones. Con las pol칤ticas de IAM, gestiona permisos para su fuerza laboral y sistemas para **asegurar permisos de m칤nimo privilegio**.

### Prefijos de ID de IAM

En [**esta p치gina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) puede encontrar los **prefijos de ID de IAM** de las claves dependiendo de su naturaleza:

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial espec칤fica del contexto                                                                                                                                                                                    |
| AGPA | Grupo de usuarios                                                                                                                                                                                                     |
| AIDA | Usuario IAM                                                                                                                                                                                                           |
| AIPA | Perfil de instancia de Amazon EC2                                                                                                                                                                                      |
| AKIA | Clave de acceso                                                                                                                                                                                                        |
| ANPA | Pol칤tica administrada                                                                                                                                                                                                  |
| ANVA | Versi칩n en una pol칤tica administrada                                                                                                                                                                                   |
| APKA | Clave p칰blica                                                                                                                                                                                                          |
| AROA | Rol                                                                                                                                                                                                                    |
| ASCA | Certificado                                                                                                                                                                                                            |
| ASIA | [Temporary (AWS STS) access key IDs](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) usan este prefijo, pero son 칰nicos solo en combinaci칩n con la clave de acceso secreta y el token de sesi칩n. |

### Permisos recomendados para auditar cuentas

Los siguientes privilegios otorgan varios accesos de lectura de metadatos:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`
## Varios

### Autenticaci칩n CLI

Para que un usuario regular se autentique en AWS a trav칠s de CLI, necesita tener **credenciales locales**. Por defecto, puedes configurarlas **manualmente** en `~/.aws/credentials` o **ejecutando** `aws configure`.\
En ese archivo puedes tener m치s de un perfil, si **no se especifica un perfil** al usar **aws cli**, se utilizar치 el llamado **`[default]`** en ese archivo.\
Ejemplo de archivo de credenciales con m치s de 1 perfil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Si necesitas acceder a **diferentes cuentas de AWS** y tu perfil ha recibido acceso para **asumir un rol dentro de esas cuentas**, no necesitas llamar manualmente a STS cada vez (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) y configurar las credenciales.

Puedes usar el archivo `~/.aws/config` para [**indicar qu칠 roles asumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), y luego usar el par치metro `--profile` como de costumbre (el `assume-role` se realizar치 de manera transparente para el usuario).\
Ejemplo de archivo de configuraci칩n:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Con este archivo de configuraci칩n, puedes usar aws cli como:
```
aws --profile acc2 ...
```
Si buscas algo **similar** a esto pero para el **navegador**, puedes revisar la **extensi칩n** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Referencias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
