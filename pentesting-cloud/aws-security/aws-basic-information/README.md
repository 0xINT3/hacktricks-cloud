# AWS - Podstawowe informacje

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Hierarchia organizacji

![](<../../../.gitbook/assets/image (54).png>)

### Konta

W AWS istnieje **konto główne**, które jest **nadrzędnym kontenerem dla wszystkich kont** w Twojej **organizacji**. Jednak nie musisz używać tego konta do wdrażania zasobów, możesz tworzyć **inne konta, aby oddzielić różne infrastruktury AWS** między nimi.

Jest to bardzo interesujące z punktu widzenia **bezpieczeństwa**, ponieważ **jedno konto nie będzie miało dostępu do zasobów z innego konta** (chyba że zostaną specjalnie utworzone mosty), dzięki czemu można tworzyć granice między wdrożeniami.

Dlatego istnieją **dwa rodzaje kont w organizacji** (mówimy tutaj o kontach AWS, a nie o kontach użytkowników): jedno konto, które jest wyznaczone jako konto zarządzające, oraz jedno lub więcej kont członkowskich.

*   **Konto zarządzające (konto główne)** to konto, które używasz do tworzenia organizacji. Z konta zarządzającego organizacją możesz wykonywać następujące czynności:

* Tworzenie kont w organizacji
* Zapraszanie innych istniejących kont do organizacji
* Usuwanie kont z organizacji
* Zarządzanie zaproszeniami
* Stosowanie polityk do jednostek (korzeni, OU lub kont) w organizacji
* Włączanie integracji z obsługiwanymi usługami AWS w celu zapewnienia funkcjonalności usług we wszystkich kontach w organizacji.
* Możliwe jest zalogowanie się jako użytkownik root, używając adresu e-mail i hasła użytych do utworzenia tego konta głównego/organizacji.

Konto zarządzające ma **obowiązki konta płatnika** i jest odpowiedzialne za opłacanie wszystkich opłat naliczanych przez konta członkowskie. Nie można zmienić konta zarządzającego organizacją.
* **Konta członkowskie** stanowią wszystkie pozostałe konta w organizacji. Konto może być członkiem tylko jednej organizacji w danym czasie. Możesz dołączyć politykę do konta, aby zastosować kontrolę tylko do tego jednego konta.
* Konta członkowskie **muszą używać prawidłowego adresu e-mail** i mogą mieć **nazwę**, ogólnie nie będą mogły zarządzać rozliczeniami (ale mogą otrzymać do nich dostęp).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Jednostki organizacyjne**

Konta można grupować w **jednostki organizacyjne (OU)**. W ten sposób można tworzyć **polityki** dla jednostki organizacyjnej, które zostaną **zastosowane do wszystkich kont potomnych**. Należy zauważyć, że OU może mieć inne OU jako konta potomne.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Polityka kontroli usług (SCP)

**Polityka kontroli usług (SCP)** to polityka, która określa usługi i działania, które użytkownicy i role mogą używać w kontach, na które wpływa SCP. SCP są **podobne do polityk uprawnień IAM**, z tym że **nie przyznają żadnych uprawnień**. Zamiast tego, SCP określa **maksymalne uprawnienia** dla organizacji, jednostki organizacyjnej (OU) lub konta. Gdy dołączasz SCP do korzenia organizacji lub OU, SCP ogranicza uprawnienia dla jednostek w kontach członkowskich.

To jest JEDYNY sposób, w jaki **nawet użytkownik root może być zatrzymany** przed zrobieniem czegoś. Na przykład, może być używany do zatrzymania użytkowników przed wyłączeniem CloudTrail lub usuwaniem kopii zapasowych.\
Jedynym sposobem obejścia tego jest skompromitowanie również **konta głównego**, które konfiguruje SCP (konto główne nie może być zablokowane).

{% hint style="warning" %}
Należy zauważyć, że **SCPs ograniczają tylko podmioty w koncie**, więc inne konta nie są objęte tym ograniczeniem. Oznacza to, że odmowa SCP `s3:GetObject` nie powstrzyma ludzi przed **uzyskaniem dostępu do publicznego kubełka S3** w Twoim koncie.
{% endhint %}

Przykłady SCP:

* Zablokuj całkowicie konto root
* Pozwól tylko na określone regiony
* Pozwól tylko na usługi z białej listy
*   Zablokuj możliwość wyłączenia GuardDuty, CloudTrail i dostępu

publicznego do S3
*   Zablokuj możliwość usuwania lub modyfikowania ról

bezpieczeństwa/reagowania na incydenty.
* Zablokuj usuwanie kopii zapasowych.
* Zablokuj tworzenie użytkowników IAM i kluczy dostępu

Znajdź **przykłady JSON** pod adresem [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** to **unikalna nazwa**, którą ma każdy zasób wewnątrz AWS, składa się z:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Zauważ, że w AWS są 4 partycje, ale tylko 3 sposoby, aby je nazwać:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM to usługa, która umożliwia zarządzanie **uwierzytelnianiem**, **autoryzacją** i **kontrolą dostępu** wewnątrz Twojego konta AWS.

* **Uwierzytelnianie** - Proces definiowania tożsamości i weryfikacji tej tożsamości. Proces ten można podzielić na: identyfikację i weryfikację.
* **Autoryzacja** - Określa, do czego dana tożsamość ma dostęp w systemie po uwierzytelnieniu.
* **Kontrola dostępu** - Metoda i proces określania, jak dostęp jest udzielany do zasobu zabezpieczonego.

IAM można zdefiniować jako zdolność do zarządzania, kontrolowania i regulowania mechanizmów uwierzytelniania, autoryzacji i kontroli dostępu tożsamości do zasobów w Twoim koncie AWS.

### [Konto główne użytkownika AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Po utworzeniu konta Amazon Web Services (AWS) zaczynasz od pojedynczej tożsamości logowania, która ma **pełny dostęp do wszystkich** usług i zasobów AWS w danym koncie. Jest to użytkownik _**konto główne**_ AWS i uzyskuje się do niego, logując się za pomocą **adresu e-mail i hasła, które zostały użyte do utworzenia konta**.

Należy zauważyć, że nowy **użytkownik admin** będzie miał **mniej uprawnień niż użytkownik główny**.

Z punktu widzenia bezpieczeństwa zaleca się tworzenie innych użytkowników i unikanie korzystania z tego.

### [Użytkownicy IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Użytkownik IAM to jednostka, którą tworzysz w AWS, aby **reprezentować osobę lub aplikację**, która z niego korzysta do **interakcji z AWS**. Użytkownik w AWS składa się z nazwy i poświadczeń (hasła i maksymalnie dwóch kluczy dostępu).

Podczas tworzenia użytkownika IAM nadajesz mu **uprawnienia**, czyniąc go **członkiem grupy użytkowników**, która ma odpowiednio dołączone polisy uprawnień (zalecane), lub **bezpośrednio dołączając polisy** do użytkownika.

Użytkownicy mogą mieć **włączone MFA do logowania** przez konsolę. Tokeny API użytkowników z włączonym MFA nie są chronione przez MFA. Jeśli chcesz **ograniczyć dostęp do kluczy API użytkowników za pomocą MFA**, musisz wskazać w polisie, że w celu wykonania określonych czynności MFA musi być obecne (przykład [**tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID klucza dostępu**: 20 losowych wielkich liter i cyfr, np. AKHDNAPO86BSHKDIRYT
* **Tajny klucz dostępu**: 40 losowych dużych i małych liter: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Nie można odzyskać utraconego tajnego klucza dostępu).

Zawsze, gdy musisz **zmienić klucz dostępu**, powinieneś postępować zgodnie z tym procesem:\
_Utwórz nowy klucz dostępu -> Zastosuj nowy klucz do systemu/aplikacji -> oznacz oryginalny klucz jako nieaktywny -> Przetestuj i zweryfikuj, czy nowy klucz dostępu działa -> Usuń stary klucz dostępu_

### MFA - Wieloskładnikowe uwierzytelnianie

Służy do **utworzenia dodatkowego czynnika uwierzytelniania** oprócz istniejących metod, takich jak hasło, tworząc tym samym wieloskładnikowy poziom uwierzytelniania.\
Możesz użyć **darmowej aplikacji wirtualnej lub fizycznego urządzenia**. Możesz użyć bezpłatnych aplikacji, takich jak uwierzytelnianie Google, aby aktywować MFA w AWS.

Polisy z warunkami MFA mogą być dołączone do:

* Użytkownika IAM lub grupy
* Zasobu, takiego jak kubełek Amazon S3, kolejka Amazon SQS lub temat Amazon SNS
* Polityki zaufania roli IAM, którą może przyjąć użytkownik

Jeśli chcesz **uzyskać dostęp za pomocą CLI** do zasobu, który **sprawdza MFA**, musisz wywołać **`GetSessionToken`**. To dostarczy Ci token z informacjami o MFA.\
Należy zauważyć, że **poświadczenia `AssumeRole` nie zawierają tej informacji**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Jak [**stwierdzono tutaj**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), istnieje wiele różnych przypadków, w których **MFA nie może być używane**.

### [Grupy użytkowników IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Grupa użytkowników IAM to sposób **przypisywania polis do wielu użytkowników** jednocześnie, co ułatwia zarządzanie uprawnieniami dla tych użytkowników. **Role i grupy nie mogą być częścią grupy**.

Możesz przypisać **polisę opartą na tożsamości do grupy użytkowników**, dzięki czemu wszyscy **użytkownicy** w grupie użytkowników **otrzymują uprawnienia polisy**. Nie możesz jednak zidentyfikować **grupy użytkowników** jako **`Principal`** w **polisie** (takiej jak polisa oparta na zasobach), ponieważ grupy dotyczą uprawnień, a nie uwierzytelniania, a podmioty uwierzytelnione to tożsamości IAM.

Oto kilka ważnych cech grup użytkowników:

* **Grupa użytkowników** może **zawierać wielu użytkowników**, a **użytkownik** może **należeć do wielu grup**.
* **Grupy użytkowników nie mogą być zagnieżdżane**; mogą zawierać tylko użytkowników, a nie inne grupy użytkowników.
* Nie ma **domyślnej grupy użytkowników, która automatycznie zawiera wszystkich użytkowników w koncie AWS**. Jeśli chcesz mieć taką grupę użytkowników, musisz ją utworzyć i przypisać do niej każdego nowego użytkownika.
* Liczba i rozmiar zasobów IAM w koncie AWS, takich jak liczba grup i liczba grup, do których użytkownik może należeć, są ograniczone. Aby uzyskać więcej informacji, zobacz [limity IAM i AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Role IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Rola IAM jest bardzo **podobna** do **użytkownika**, ponieważ jest to **tożsamość z polisami uprawnień**, które określają, co może i czego nie może robić w AWS. Jednak rola **nie ma przypisanych żadnych poświadczeń** (hasła lub kluczy dostępu). Zamiast być unikalnie powiązaną z jedną osobą, rola ma być **przyjmowana przez każdego, kto jej potrzebuje (i ma wystarczające uprawnienia)**. Użytkownik IAM może przyjąć rolę, aby tymczasowo uzyskać inne uprawnienia do określonego zadania. Rolę można **przypisać do** [**użytkownika federacyjnego**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html), który loguje się za pomocą zewnętrznego dostawcy tożsamości, a nie IAM.

Rola IAM składa się z **dwóch rodzajów polis**: polisy **zaufania**, które nie mogą być puste i określają, **kto może przyjąć** rolę, oraz polisy **uprawnień**, które nie mogą być puste i określają, **do czego ma dostęp**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) to usługa sieciowa ułatwiająca **wydawanie tymczasowych, ograniczonych uprawnień**. Jest specjalnie dostosowana do:

### [Tymczasowe poświadczenia w IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Tymczasowe poświadczenia są głównie używane z rolami IAM**, ale mają również inne zastosowania. Możesz żądać tymczasowych poświadczeń, które mają bardziej ograniczony zestaw uprawnień niż standardowy użytkownik IAM. **Zapobiega to przypadkowemu wykonywaniu zadań, które nie są dozwolone** przez bardziej ograniczone poświadczenia. Korzyścią z tymczasowych poświadczeń jest to, że automatycznie wygasają po określonym czasie. Masz kontrolę nad czasem ważności poświadczeń.

### Polisy

#### Uprawnienia polis

Służą do przypisywania uprawnień. Istnieją 2 rodzaje:

* Zarządzane polisy AWS (prekonfigurowane przez AWS)
* Polisy zarządzane przez klienta: Konfigurowane przez Ciebie. Możesz tworzyć polisy oparte na zarządzanych polisach AWS (modyfikując jedną z nich i tworząc swoją własną), korzystając z generatora polis (widok GUI, który pomaga w przyznawaniu i odmawianiu uprawnień) lub pisząc własne.

Domyślnie dostęp jest **zablokowany**, dostęp zostanie udzielony, jeśli została określona rola.\
Jeśli istnieje **pojedyncze "Deny", to zastąpi "Allow"**, z wyjątkiem żądań, które używają korzeniowych poświadczeń bezpieczeństwa konta AWS (które są domyślnie dozwolone).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[Globalne pola, które można używać do warunków w dowolnej usłudze, są udokumentowane tutaj](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
[Specyficzne pola, które można używać do warunków dla poszczególnych usług, są udokumentowane tutaj](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Polityki w linii

Ten rodzaj polityk jest **bezpośrednio przypisany** do użytkownika, grupy lub roli. Nie pojawiają się one na liście polityk, tak jak inne, które można używać.\
Polityki w linii są przydatne, jeśli chcesz **utrzymać ścisły związek jeden do jednego między polityką a tożsamością**, do której jest zastosowana. Na przykład, chcesz upewnić się, że uprawnienia w polityce nie są przypadkowo przypisane do innej tożsamości niż ta, dla której są przeznaczone. Korzystając z polityki w linii, uprawnienia w polityce nie mogą być przypadkowo dołączone do niewłaściwej tożsamości. Ponadto, korzystając z konsoli AWS Management Console do usunięcia tej tożsamości, osadzone w tożsamości polityki również zostaną usunięte. Ponieważ są one częścią podmiotu głównego.

#### Polityki zasobów kubełka

Są to **polityki**, które można zdefiniować w **zasobach**. **Nie wszystkie zasoby AWS je obsługują**.

Jeśli podmiot nie ma jawnego odmowy dostępu do nich, a polityka zasobu przyznaje im dostęp, to są dozwolone.

### Granice IAM

Granice IAM można używać do **ograniczenia uprawnień, do których użytkownik lub rola powinny mieć dostęp**. W ten sposób, nawet jeśli inna polityka przyznaje użytkownikowi **inne zestaw uprawnień**, operacja **zakończy się niepowodzeniem**, jeśli spróbuje ich użyć.

Granica to po prostu polityka dołączona do użytkownika, która **określa maksymalny poziom uprawnień, jakie użytkownik lub rola może mieć**. Więc, **nawet jeśli użytkownik ma dostęp Administratora**, jeśli granica wskazuje, że może tylko odczytywać kubełki S3, to jest to maksimum, jakie może zrobić.

**To**, **SCP** i **zastosowanie zasady najmniejszych uprawnień** to sposoby kontroli, aby użytkownicy nie mieli większych uprawnień niż te, których potrzebują.

### Polityki sesji

Polityka sesji to **polityka ustawiana podczas przejęcia roli** w jakiś sposób. Będzie to jak **granica IAM dla tej sesji**: Oznacza to, że polityka sesji nie przyznaje uprawnień, ale **ogranicza je do tych wskazanych w polityce** (maksymalne uprawnienia to te, które ma rola).

Jest to przydatne dla **środków bezpieczeństwa**: Kiedy administrator ma przejąć bardzo uprzywilejowaną rolę, może ograniczyć uprawnienia tylko do tych wskazanych w polityce sesji, w przypadku skompromitowania sesji.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Zauważ, że domyślnie **AWS może dodawać polityki sesji do sesji**, które zostaną wygenerowane z powodu innych przyczyn. Na przykład, w przypadku [nieuwierzytelnionych ról Cognito](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) domyślnie (korzystając z rozszerzonej uwierzytelniania), AWS wygeneruje **poświadczenia sesji z polityką sesji**, która ogranicza usługi, do których sesja może uzyskać dostęp [**do następującej listy**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Dlatego, jeśli w pewnym momencie napotkasz błąd "... ponieważ żadna polityka sesji nie zezwala na ...", a rola ma dostęp do wykonania tej akcji, oznacza to, że **istnieje polityka sesji, która temu przeszkadza**.

### Federacja tożsamości

Federacja tożsamości **umożliwia użytkownikom zewnętrznym dostęp do zasobów AWS** bez konieczności dostarczania poświadczeń użytkownika AWS z ważnego konta IAM.\
Przykładem dostawcy tożsamości może być własny korporacyjny **Microsoft Active Directory** (za pomocą **SAML**) lub usługi **OpenID** (takie jak **Google**). Dzięki federacyjnemu dostępowi użytkownicy wewnątrz niego będą mieli dostęp do AWS.

Aby skonfigurować to zaufanie, generowany jest **dostawca tożsamości IAM (SAML lub OAuth)**, który będzie **ufać** **innemu platformie**. Następnie, przypisana jest przynajmniej jedna **roli IAM (zaufanie) do dostawcy tożsamości**. Jeśli użytkownik z zaufanej platformy uzyska dostęp do AWS, będzie działał jako wspomniana rola.

Jednak zazwyczaj chcesz przypisać **inną rolę w zależności od grupy użytkownika** w platformie zewnętrznej. Wtedy kilka **ról IAM może ufać** dostawcy tożsamości zewnętrznej, a platforma zewnętrzna będzie decydować, która rola może być przyjęta przez użytkowników.

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### Centrum tożsamości IAM

Centrum tożsamości IAM AWS (następca AWS Single Sign-On) rozszerza możliwości AWS Identity and Access Management (IAM), zapewniając **centralne miejsce**, które łączy **administrację użytkowników i ich dostęp do kont AWS** oraz aplikacji w chmurze.

Domena logowania będzie miała postać `<user_input>.awsapps.com`.

Do logowania użytkowników można użyć 3 źródeł tożsamości:

* Katalog Centrum Tożsamości: Zwykli użytkownicy AWS
* Active Directory: Obsługuje różne łączniki
* Zewnętrzny dostawca tożsamości: Wszyscy użytkownicy i grupy pochodzą z zewnętrznego dostawcy tożsamości (IdP)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

W najprostszym przypadku katalogu Centrum Tożsamości, **Centrum Tożsamości będzie miało listę użytkowników i grup**, a będzie w stanie **przypisywać im polityki** do **dowolnego z kont** organizacji.

Aby umożliwić dostęp użytkownikowi/grupie Centrum Tożsamości do konta, zostanie utworzony **dostawca tożsamości SAML, który ufa Centrum Tożsamości**, oraz **roli, która ufa dostawcy tożsamości z określonymi politykami, zostanie utworzona** w docelowym koncie.

#### AwsSSOInlinePolicy

Możliwe jest **udzielanie uprawnień za pomocą polityk wewnętrznych dla ról utworzonych za pomocą Centrum Tożsamości IAM**. Role utworzone w kontach, które otrzymują **polityki wewnętrzne w Centrum Tożsamości AWS**, będą miały te uprawnienia w polityce wewnętrznej o nazwie **`AwsSSOInlinePolicy`**.

Dlatego nawet jeśli zobaczysz 2 role z polityką wewnętrzną o nazwie **`AwsSSOInlinePolicy`**, **nie oznacza to, że mają one te same uprawnienia**.

### Zaufanie międzykontowe i role

**Użytkownik** (zaufany) może utworzyć rolę międzykontową z określonymi politykami, a następnie **umożliwić innemu użytkownikowi** (zaufanemu) **dostęp do swojego konta**, ale tylko **z dostępem określonym w nowych politykach roli**. Aby to zrobić, wystarczy utworzyć nową rolę i wybrać Rolę międzykontową. Role do dostępu międzykontowemu oferują dwie opcje. Udostępnianie dostępu między kontami AWS, które posiadasz, i udostępnianie dostępu między kontem, które posiadasz, a kontem AWS osób trzecich.\
Zaleca się **określenie użytkownika, który jest zaufany, a nie podawanie ogólnego określenia**, ponieważ w przeciwnym razie inni uwierzytelnieni użytkownicy, tacy jak użytkownicy federowani, będą również mogli nadużywać tego zaufania.

### AWS Simple AD

Nieobsługiwane:

* Relacje zaufania
* Centrum administracyjne AD
* Pełne wsparcie dla interfejsu API PS
* Kosz odzyskiwania AD
* Zarządzane konta usług grupowych
* Rozszerzenia schematu
* Brak bezpośredniego dostępu do systemu operacyjnego lub instancji

#### Federacja sieciowa lub uwierzytelnianie OpenID

Aplikacja korzysta z AssumeRoleWithWebIdentity, aby utworzyć tymczasowe poświadczenia. Jednak nie zapewnia to dostępu do konsoli AWS, a jedynie dostęp do zasobów w AWS.

### Inne opcje IAM

* Możesz **ustawić ustawienia polityki hasła**, takie jak minimalna długość i wymagania dotyczące hasła.
* Możesz **pobrać "Raport poświadczeń"** z informacjami na temat bieżących poświadczeń (takich jak czas utworzenia użytkownika, czy hasło jest włączone...). Możesz generować raport poświadczeń co najmniej raz co **cztery godziny**.

AWS Identity and Access Management (IAM) zapewnia **dokładną kontrolę dostępu** do wszystkich usług AWS. Dzięki IAM możesz określić, **kto może uzyskać dostęp do jakich usług i zasobów**, i pod jakimi warunkami. Za pomocą polityk IAM zarządzasz uprawnieniami dla swojej siły roboczej i systemów, aby **zapewnić uprawnienia o najmniejszych przywilejach**.

### Prefiksy IAM ID

Na [**tej stronie**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) znajdziesz **prefiksy IAM ID** dla kluczy w zależności od ich charakteru:

| ABIA | [Bearer token usługi AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Poświadczenie zależne od kontekstu                                                                                                                                                                                           |
| AGPA | Grupa użytkowników                                                                                                                                                                                                            |
| AIDA | Użytkownik IAM                                                                                                                                                                                                              |
| AIPA | Profil instancji Amazon EC2                                                                                                                                                                                           |
| AKIA | Klucz dostępu                                                                                                                                                                                                            |
| ANPA | Zarządzana polityka                                                                                                                                                                                                        |
| ANVA | Wersja w zarządzanej polityce                                                                                                                                                                                           |
| APKA | Klucz publiczny                                                                                                                                                                                                            |
| AROA | Rola                                                                                                                                                                                                                  |
| ASCA | Certyfikat                                                                                                                                                                                                           |
| ASIA | [Tymczasowe (AWS STS) identyfikatory kluczy dostępu](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) używają tego prefiksu, ale są unikalne tylko w połączeniu z tajnym kluczem dostępu i tokenem sesji. |

### Zalecane uprawnienia do audytu kont

Następujące uprawnienia umożliwiają różne rodzaje odczytu metadanych:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Jeśli musisz uzyskać dostęp do **różnych kont AWS** i twojemu profilowi został udzielony dostęp do **przyjęcia roli w tych kontach**, nie musisz wywoływać ręcznie STS za każdym razem (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) i konfigurować poświadczeń.

Możesz użyć pliku `~/.aws/config`, aby [**wskazać, które role przyjąć**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), a następnie używać parametru `--profile` jak zwykle (przyjęcie roli zostanie wykonane w sposób transparentny dla użytkownika).\
Przykład pliku konfiguracyjnego:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Z tym plikiem konfiguracyjnym możesz używać aws cli w ten sposób:
```
aws --profile acc2 ...
```
Jeśli szukasz czegoś **podobnego** do tego, ale dla **przeglądarki**, możesz sprawdzić **rozszerzenie** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Odwołania

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
