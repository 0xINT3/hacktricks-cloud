# AWS - 基本情報

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じて、ゼロからヒーローまでAWSハッキングを学びましょう</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい場合は** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする。
* **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## 組織階層

![](<../../../.gitbook/assets/image (151).png>)

### アカウント

AWSには、組織のすべてのアカウントの**親コンテナ**である**ルートアカウント**があります。ただし、リソースを展開するためにそのアカウントを使用する必要はありません。**異なるAWSインフラストラクチャを区別するために他のアカウントを作成**できます。

これは**セキュリティ**の観点から非常に興味深いです。**1つのアカウントは他のアカウントのリソースにアクセスできない**（特定のブリッジが作成されていない限り）、そのため、展開間に境界を作成できます。

したがって、組織内には**2種類のアカウント**があります（AWSアカウントであり、ユーザーアカウントではありません）：管理アカウントと1つ以上のメンバーアカウント。

*   **管理アカウント（ルートアカウント）** は、組織を作成するために使用するアカウントです。組織の管理アカウントから、以下の操作ができます：

* 組織内でアカウントを作成する
* 他の既存のアカウントを組織に招待する
* アカウントを組織から削除する
* 招待を管理する
* エンティティ（ルート、OU、またはアカウント）にポリシーを適用する
* サポートされているAWSサービスとの統合を有効にして、組織内のすべてのアカウントでサービス機能を提供する。
* このルートアカウント/組織を作成するために使用したメールアドレスとパスワードを使用して、ルートユーザーとしてログインすることが可能です。

管理アカウントは**支払いアカウントの責任**を負い、メンバーアカウントによって発生したすべての料金を支払う責任があります。組織の管理アカウントを変更することはできません。
* **メンバーアカウント** は、組織内のすべての残りのアカウントを構成します。アカウントは1度に1つの組織のメンバーになることができます。アカウントにポリシーを添付して、その1つのアカウントにのみコントロールを適用することができます。
* メンバーアカウントは**有効なメールアドレスを使用**する必要があり、**名前**を持つことができます。一般的に、請求を管理することはできません（ただし、アクセス権を与えられる場合があります）。
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **組織単位**

アカウントは**組織単位（OU）**にグループ化することができます。これにより、組織単位に対して**ポリシー**を作成し、**子アカウント全体に適用**することができます。OUは他のOUを子として持つことができることに注意してください。
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### サービス制御ポリシー（SCP）

**サービス制御ポリシー（SCP）**は、SCPが影響を受けるアカウントでユーザーとロールが使用できるサービスとアクションを指定するポリシーです。SCPはIAM権限ポリシーに似ていますが、**権限を付与しません**。代わりに、SCPは組織、組織単位（OU）、またはアカウントのための**最大権限を指定**します。SCPを組織ルートまたはOUにアタッチすると、**SCPはメンバーアカウント内のエンティティの権限を制限**します。

これは**ルートユーザーですら停止**される唯一の方法です。例えば、CloudTrailの無効化やバックアップの削除をユーザーが停止するのを防ぐために使用できます。\
これをバイパスする唯一の方法は、SCPを構成する**マスターアカウント**も侵害することです（マスターアカウントはブロックできません）。

{% hint style="warning" %}
**SCPはアカウント内の主体にのみ制限を設ける**ため、他のアカウントには影響しません。これはSCPが`s3:GetObject`を拒否しても、アカウント内の**パブリックS3バケットへのアクセスを停止しない**ことを意味します。
{% endhint %}

SCPの例：

- ルートアカウントを完全に拒否
- 特定のリージョンのみ許可
- ホワイトリストされたサービスのみ許可
- GuardDuty、CloudTrail、およびS3 Public Block Accessの無効化を拒否
- セキュリティ/インシデント対応ロールの削除や変更を拒否
- バックアップの削除を拒否
- IAMユーザーとアクセスキーの作成を拒否

[https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)で**JSONの例**を見つけることができます。

### ARN

**Amazon Resource Name（ARN）**は、AWS内のすべてのリソースが持つ**ユニークな名前**であり、次のように構成されています：
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
AWSには4つのパーティションがありますが、それらを呼び出す方法は3つだけです：

- AWS標準：`aws`
- AWS中国：`aws-cn`
- AWS米国公共インターネット（GovCloud）：`aws-us-gov`
- AWSシークレット（米国機密）：`aws`

## IAM - Identity and Access Management

IAMは、AWSアカウント内での**認証**、**認可**、および**アクセス制御**を管理するためのサービスです。

- **認証** - アイデンティティの定義とそのアイデンティティの検証のプロセス。このプロセスは、識別と検証に分割できます。
- **認可** - 認証された後のシステム内でアイデンティティがアクセスできる内容を決定します。
- **アクセス制御** - 安全なリソースへのアクセスがどのように許可されるかの方法とプロセス

IAMは、AWSアカウント内のリソースへのアイデンティティの認証、認可、およびアクセス制御メカニズムを管理、制御、および統治する能力によって定義できます。

### [AWSアカウントルートユーザー](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Amazon Web Services（AWS）アカウントを最初に作成すると、アカウント内のすべてのAWSサービスとリソースに**完全アクセス権を持つ**単一のサインインアイデンティティで開始します。これがAWSアカウントの_**ルートユーザー**_であり、アカウントを作成した際に使用した**メールアドレスとパスワード**でサインインします。

新しい**管理者ユーザー**は、ルートユーザーよりも**権限が少ない**ことに注意してください。

セキュリティの観点から、他のユーザーを作成し、このユーザーを使用しないようにすることが推奨されています。

### [IAMユーザー](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAMユーザーは、AWSで作成するエンティティであり、それを使用してAWSとやり取りする**人物またはアプリケーションを表す**ために作成されます。 AWSのユーザーは、名前と資格情報（パスワードと最大2つのアクセスキー）で構成されます。

IAMユーザーを作成すると、それを**適切な権限ポリシーがアタッチされたユーザーグループのメンバー**にすることによって**権限を付与**するか、ユーザーに**直接ポリシーをアタッチ**することによって権限を付与します。

ユーザーは、コンソールを介してログインするために**MFAを有効にできます**。 MFAが有効なユーザーのAPIトークンはMFAで保護されません。ユーザーのAPIキーのアクセスを**MFAで制限**する場合は、特定のアクションを実行するためにMFAが存在する必要があることをポリシーで示す必要があります（例は[こちら](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)）。

#### CLI

- **アクセスキーID**：AKHDNAPO86BSHKDIRYTのような20個のランダムな大文字英数字文字
- **シークレットアクセスキーID**：S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtUのような40個のランダムな大文字と小文字の文字（失われたシークレットアクセスキーIDを取得することはできません）。

アクセスキーを**変更する必要がある場合**は、次の手順に従う必要があります：\
_新しいアクセスキーを作成 -> 新しいキーをシステム/アプリケーションに適用 -> 元のキーを無効にする -> 新しいアクセスキーが機能していることをテストおよび検証 -> 古いアクセスキーを削除_

### MFA - マルチファクタ認証

これは、パスワードなどの既存の方法に**追加の認証要素を作成**するために使用され、したがって、認証のマルチファクタレベルを作成します。\
**無料の仮想アプリケーションまたは物理デバイス**を使用できます。 AWSでMFAを有効にするためには、google認証などのアプリを無料で使用できます。

MFA条件付きポリシーは、次のものにアタッチできます：

- IAMユーザーまたはグループ
- Amazon S3バケット、Amazon SQSキュー、またはAmazon SNSトピックなどのリソース
- ユーザーが仮定できるIAMロールの信頼ポリシー

MFAを**チェックするリソースにCLI経由でアクセス**する場合は、**`GetSessionToken`**を呼び出す必要があります。これにより、MFAに関する情報が含まれたトークンが取得されます。\
**`AssumeRole`資格情報にはこの情報が含まれない**ことに注意してください。
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
[**ここで述べられている**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)ように、**MFAを使用できない**さまざまなケースがあります。

### [IAMユーザーグループ](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [ユーザーグループ](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) は、**複数のユーザーにポリシーをアタッチ**する方法であり、これによりこれらのユーザーの権限を管理しやすくすることができます。**ロールとグループはグループの一部になれません**。

**ユーザーグループにアイデンティティベースのポリシーをアタッチ**して、ユーザーグループ内の**すべてのユーザーがポリシーの権限を受け取る**ことができます。グループは認証ではなく権限に関連しているため、リソースベースのポリシーなどの**ポリシー**で**ユーザーグループを`Principal`として識別することはできません**。

以下は、ユーザーグループの重要な特性です：

- ユーザー**グループ**には**多くのユーザー**が含まれ、**ユーザー**は**複数のグループに所属**することができます。
- **ユーザーグループはネストできません**。ユーザーグループには他のユーザーグループではなくユーザーのみが含まれることができます。
- **AWSアカウントのすべてのユーザーを自動的に含むデフォルトのユーザーグループはありません**。そのようなユーザーグループを作成し、各新規ユーザーを割り当てる必要があります。
- AWSアカウント内のIAMリソースの数やサイズ（グループの数、ユーザーがメンバーになれるグループの数など）には制限があります。詳細については、[IAMおよびAWS STSのクォータ](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html)を参照してください。

### [IAMロール](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **ロール**は、AWSで何ができるかできないかを決定する**権限ポリシーを持つアイデンティティ**である**ユーザー**と非常に**似ています**。ただし、ロールには（パスワードやアクセスキーなどの）**資格情報が関連付けられていません**。1人の人物に固有に関連付けられるのではなく、ロールはそれを必要とする誰でも（十分な権限を持っている場合）**仮定できるように意図されています**。IAMユーザーは、特定のタスクのために異なる権限を一時的に持つために**ロールを仮定**することができます。ロールは、IAMではなく外部のアイデンティティプロバイダーを使用してサインインする**[**連携ユーザー**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html)**に割り当てることができます。

IAMロールには**2種類のポリシー**が含まれています：**空にできない信頼ポリシー**（誰がロールを仮定できるかを定義）と**空にできない権限ポリシー**（アクセスできるものを定義）。

#### AWSセキュリティトークンサービス（STS）

AWSセキュリティトークンサービス（STS）は、**一時的で限られた特権の資格情報の発行**を容易にするWebサービスです。これは特に以下に適しています：

### [IAMでの一時的な資格情報](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**一時的な資格情報は主にIAMロールと共に使用**されますが、他にも使用方法があります。より制限された権限セットを持つ一時的な資格情報をリクエストすることができます。これにより、より制限された資格情報で許可されていないタスクを誤って実行することが**防止**されます。一時的な資格情報の利点は、一定期間後に自動的に期限切れになることです。資格情報の有効期間を制御できます。

### ポリシー

#### ポリシーの権限

権限を割り当てるために使用されます。2種類があります：

- AWS管理ポリシー（AWSによって事前に構成された）
- カスタマー管理ポリシー：ユーザーによって構成されます。AWS管理ポリシーを基にポリシーを作成できます（それらの1つを変更して独自のポリシーを作成する）、ポリシージェネレーター（許可と拒否の権限を助けるGUIビュー）を使用するか、独自のポリシーを作成するかを選択できます。

**デフォルトではアクセスが拒否**され、明示的なロールが指定されている場合にのみアクセスが許可されます。\
**単一の"Deny"が存在する場合、"Allow"がオーバーライド**されますが、AWSアカウントのルートセキュリティ資格情報を使用するリクエストは（デフォルトで許可されている）例外です。
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[ここ](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount) には、任意のサービスで使用できる条件に使用できる**グローバルフィールド**が文書化されています。\
[ここ](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html) には、サービスごとに使用できる条件に使用できる**特定のフィールド**が文書化されています。

#### インラインポリシー

この種類のポリシーは、ユーザー、グループ、またはロールに**直接割り当て**されます。そのため、他の誰もが使用できるようにポリシーのリストに表示されません。\
インラインポリシーは、ポリシーとそれが適用される**アイデンティティとの厳密な一対一の関係を維持**したい場合に便利です。たとえば、ポリシーのアクセス許可が意図されたアイデンティティ以外のアイデンティティに誤って割り当てられないようにしたい場合です。インラインポリシーを使用すると、ポリシーのアクセス許可は誤って間違ったアイデンティティに添付されることはありません。さらに、AWS Management Consoleを使用してそのアイデンティティを削除すると、アイデンティティに埋め込まれたポリシーも削除されます。それは、それらが主体エンティティの一部であるためです。

#### リソースバケットポリシー

これらは**リソース**で定義できる**ポリシー**です。**AWSのすべてのリソースがそれらをサポートしているわけではありません**。

主体に明示的な拒否がない場合、かつリソースポリシーがアクセスを許可している場合、アクセスが許可されます。

### IAM 境界

IAM 境界を使用して、ユーザーやロールがアクセスできる権限を**制限**できます。これにより、異なるポリシーによってユーザーに異なる権限セットが付与されても、その操作は**失敗**します。

境界は、ユーザーにアタッチされたポリシーであり、ユーザーやロールが持つことができる**最大レベルの権限を示す**ものです。したがって、ユーザーが管理者アクセス権を持っていても、境界が彼が S3 バケットを読むだけと示している場合、それができることの最大限度です。

**これ**、**SCPs**、および**最小特権の原則**に従うことは、ユーザーが必要な権限以上の権限を持たないように制御する方法です。

### セッションポリシー

セッションポリシーは、ロールが**仮定されるときに設定されるポリシー**です。これはそのセッションのための**IAM 境界のようなもの**です：つまり、セッションポリシーは権限を付与するのではなく、ポリシーで指定された権限に**制限**します（ロールが持つ権限の最大限度である）。

これは**セキュリティ対策**に役立ちます：管理者が非常に特権のあるロールを仮定する場合、セッションが侵害された場合にセッションポリシーで指定された権限のみに制限できます。
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
デフォルトでは、**AWS はセッションにセッションポリシーを追加**する可能性があります。これは第三者の理由によって生成されるセッションに制限を加えるためです。たとえば、[未認証の Cognito が想定するロール](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) では、デフォルトで（強化された認証を使用して）AWS は**セッションポリシーを持つセッション資格情報を生成**し、そのセッションがアクセスできるサービスを[**以下のリスト**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)に制限します。

したがって、ある時点で「... 何もセッションポリシーが許可していないため...」というエラーが発生し、ロールがアクションを実行できるアクセス権を持っている場合、**それを阻止するセッションポリシーがある**可能性があります。

### アイデンティティ連携

アイデンティティ連携は、AWS に外部のアイデンティティプロバイダーからのユーザーが AWS リソースにアクセスできるようにするためのもので、有効な IAM ユーザーアカウントから AWS ユーザー資格情報を提供する必要がないようにします。\
アイデンティティプロバイダーの例としては、独自の企業の**Microsoft Active Directory**（**SAML** 経由）や**OpenID** サービス（**Google** のような）が挙げられます。連携アクセスにより、それに含まれるユーザーが AWS にアクセスできるようになります。

この信頼を構成するためには、**IAM アイデンティティプロバイダー（SAML または OAuth）**が生成され、**他のプラットフォーム**を**信頼**するようになります。その後、少なくとも 1 つの**IAM ロールがアイデンティティプロバイダーを信頼するように割り当てられます**。信頼されたプラットフォームからのユーザーが AWS にアクセスすると、指定されたロールとしてアクセスします。

ただし、通常は、サードパーティプラットフォームのユーザーグループに応じて**異なるロールを割り当てたい**と考えるでしょう。そのため、複数の**IAM ロールがサードパーティアイデンティティプロバイダーを信頼**し、サードパーティプラットフォームがユーザーに異なるロールを引き受けさせることができます。

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### IAM アイデンティティセンター

AWS IAM Identity Center（AWS Single Sign-On の後継）は、AWS Identity and Access Management（IAM）の機能を拡張し、AWS アカウントとクラウドアプリケーションへの**ユーザーの管理とアクセスを一元化**する**中心的な場所**を提供します。

ログインドメインは `<user_input>.awsapps.com` のようになります。

ユーザーをログインさせるために使用できる 3 つのアイデンティティソースは次のとおりです：

* Identity Center Directory: 通常の AWS ユーザー
* Active Directory: 異なるコネクタをサポート
* External Identity Provider: すべてのユーザーとグループが外部アイデンティティプロバイダー（IdP）から来る

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Identity Center ディレクトリの最も単純なケースでは、**Identity Center にはユーザーとグループのリスト**があり、それらに**組み込まれたポリシーを組織のアカウントのいずれかに割り当てる**ことができます。

Identity Center ユーザー/グループにアカウントへのアクセス権を与えるためには、**Identity Center を信頼する SAML アイデンティティプロバイダーが作成**され、宛先アカウントには指定されたポリシーを持つ**アイデンティティプロバイダーを信頼するロールが作成**されます。

#### AwsSSOInlinePolicy

IAM Identity Center で作成されたロールに**インラインポリシーを通じて権限を与える**ことが可能です。AWS Identity Center で**インラインポリシーを持つアカウント内のロール**は、**`AwsSSOInlinePolicy`**というインラインポリシーでこれらの権限を持ちます。

したがって、**`AwsSSOInlinePolicy`** というインラインポリシーを持つ 2 つのロールを見たとしても、**同じ権限を持っているわけではない**ことに注意してください。

### クロスアカウントの信頼とロール

**ユーザー**（信頼する側）は、一部のポリシーを持つクロスアカウントロールを作成し、**別のユーザー**（信頼される側）に**新しいロールポリシーで指定されたアクセス権を持つアカウントにアクセスを許可**することができます。これを作成するには、新しいロールを作成し、クロスアカウントロールを選択します。クロスアカウントアクセス用のロールには、所有する AWS アカウント間のアクセスを提供するオプションと、所有するアカウントとサードパーティ AWS アカウントとの間のアクセスを提供するオプションがあります。\
**信頼されるユーザーを明示的に指定**し、一般的なものを指定しないようにすることが推奨されます。そうしないと、他の認証済みユーザー（フェデレーテッドユーザーなど）もこの信頼を悪用できる可能性があります。

### AWS Simple AD

サポートされていない機能：

* 信頼関係
* AD 管理センター
* 完全な PS API サポート
* AD リサイクル ビン
* グループ管理サービス アカウント
* スキーマ拡張
* OS やインスタンスへの直接アクセスはできません

#### Web Federation または OpenID 認証

アプリケーションは、一時的な資格情報を作成するために AssumeRoleWithWebIdentity を使用します。ただし、これにより AWS コンソールへのアクセスは許可されず、AWS 内のリソースにのみアクセスできます。

### その他の IAM オプション

* 最小長やパスワード要件などの**パスワードポリシー設定**オプションを**設定**できます。
* 現在の資格情報に関する情報（ユーザー作成時刻、パスワードが有効かどうかなど）を含む**「資格情報レポート」**を**ダウンロード**できます。クレデンシャル レポートは**最大で 4 時間ごと**に生成できます。

AWS Identity and Access Management（IAM）は、AWS 全体で**細かいアクセス制御**を提供します。IAM を使用すると、**誰がどのサービスやリソースにアクセスできるか**、および**どの条件でアクセスできるか**を指定できます。IAM ポリシーを使用することで、従業員やシステムへのアクセス権を管理し、**最小特権の権限**を確保できます。

### IAM ID プレフィックス

[**このページ**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) では、キーの**IAM ID プレフィックス**をその性質に応じて見つけることができます：

| ABIA | [AWS STS サービスベアラートークン](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | 特定コンテキストの資格情報                                                                                                                                                                                           |
| AGPA | ユーザーグループ                                                                                                                                                                                                            |
| AIDA | IAM ユーザー                                                                                                                                                                                                              |
| AIPA | Amazon EC2 インスタンスプロファイル                                                                                                                                                                                           |
| AKIA | アクセスキー                                                                                                                                                                                                            |
| ANPA | 管理ポリシー                                                                                                                                                                                                        |
| ANVA | 管理ポリシー内のバージョン                                                                                                                                                                                           |
| APKA | 公開鍵                                                                                                                                                                                                            |
| AROA | ロール                                                                                                                                                                                                                  |
| ASCA | 証明書                                                                                                                                                                                                           |
| ASIA | [一時的（AWS STS）アクセスキー ID](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) は、このプレフィックスを使用しますが、シークレットアクセスキーとセッショントークンとの組み合わせでのみ一意です。 |

### アカウントを監査するための推奨権限

次の権限は、さまざまなメタデータの読み取りアクセスを提供します：

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## その他

### CLI 認証

通常のユーザーが CLI を介して AWS に認証するためには、**ローカル資格情報**が必要です。デフォルトでは、`~/.aws/credentials` に**手動で**設定するか、`aws configure` を**実行**することで構成できます。\
そのファイルには複数のプロファイルを持つことができ、**aws cli** でプロファイルが指定されていない場合、そのファイル内の**`[default]`**という名前のプロファイルが使用されます。\
複数のプロファイルを持つ資格情報ファイルの例：
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
**異なるAWSアカウント** にアクセスする必要があり、プロファイルが**それらのアカウント内でロールを仮定する権限**を与えられた場合、毎回STSを手動で呼び出す必要はありません (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) そして資格情報を構成する必要もありません。

`~/.aws/config` ファイルを使用して[**仮定するロールを示す**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html)ことができ、その後通常通り `--profile` パラメータを使用します（`assume-role` はユーザーにとって透過的に実行されます）。
構成ファイルの例：
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
この設定ファイルを使用して、次のようにaws cliを使用できます：
```
aws --profile acc2 ...
```
## 参照

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong>で**ゼロからヒーローまでAWSハッキングを学ぶ**</summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**をフォローする**
* **ハッキングトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出する

</details>
