# AWS - Informa√ß√µes B√°sicas

<details>

<summary><strong>Aprenda a hackear AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Hierarquia da Organiza√ß√£o

![](<../../../.gitbook/assets/image (54).png>)

### Contas

No AWS existe uma **conta raiz,** que √© o **cont√™iner pai para todas as contas** da sua **organiza√ß√£o**. No entanto, voc√™ n√£o precisa usar essa conta para implantar recursos, voc√™ pode criar **outras contas para separar diferentes infraestruturas AWS** entre elas.

Isso √© muito interessante do ponto de vista da **seguran√ßa**, pois **uma conta n√£o poder√° acessar recursos de outra conta** (a menos que pontes sejam especificamente criadas), assim voc√™ pode criar limites entre implanta√ß√µes.

Portanto, existem **dois tipos de contas em uma organiza√ß√£o** (estamos falando de contas AWS e n√£o contas de usu√°rio): uma √∫nica conta designada como a conta de gerenciamento e uma ou mais contas membros.

*   A **conta de gerenciamento (a conta raiz)** √© a conta que voc√™ usa para criar a organiza√ß√£o. A partir da conta de gerenciamento da organiza√ß√£o, voc√™ pode fazer o seguinte:

* Criar contas na organiza√ß√£o
* Convidar outras contas existentes para a organiza√ß√£o
* Remover contas da organiza√ß√£o
* Gerenciar convites
* Aplicar pol√≠ticas a entidades (ra√≠zes, OUs ou contas) dentro da organiza√ß√£o
* Habilitar integra√ß√£o com servi√ßos AWS suportados para fornecer funcionalidade de servi√ßo em todas as contas da organiza√ß√£o.
* √â poss√≠vel fazer login como usu√°rio raiz usando o e-mail e senha usados para criar esta conta raiz/organiza√ß√£o.

A conta de gerenciamento tem as **responsabilidades de uma conta pagadora** e √© respons√°vel por pagar todas as cobran√ßas acumuladas pelas contas membros. Voc√™ n√£o pode alterar a conta de gerenciamento de uma organiza√ß√£o.
* **Contas membros** comp√µem todas as demais contas de uma organiza√ß√£o. Uma conta pode ser membro de apenas uma organiza√ß√£o por vez. Voc√™ pode anexar uma pol√≠tica a uma conta para aplicar controles apenas √†quela conta.
* Contas membros **devem usar um endere√ßo de e-mail v√°lido** e podem ter um **nome**, em geral elas n√£o poder√£o gerenciar a fatura√ß√£o (mas podem receber acesso a ela).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Unidades Organizacionais**

Contas podem ser agrupadas em **Unidades Organizacionais (OU)**. Assim, voc√™ pode criar **pol√≠ticas** para a Unidade Organizacional que ser√£o **aplicadas a todas as contas filhas**. Observe que uma OU pode ter outras OUs como filhas.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Pol√≠tica de Controle de Servi√ßo (SCP)

Uma **pol√≠tica de controle de servi√ßo (SCP)** √© uma pol√≠tica que especifica os servi√ßos e a√ß√µes que usu√°rios e fun√ß√µes podem usar nas contas afetadas pelo SCP. SCPs s√£o **semelhantes √†s pol√≠ticas de permiss√µes do IAM** exceto pelo fato de que **n√£o concedem permiss√µes**. Em vez disso, SCPs especificam as **permiss√µes m√°ximas** para uma organiza√ß√£o, unidade organizacional (OU) ou conta. Quando voc√™ anexa um SCP √† raiz da sua organiza√ß√£o ou a uma OU, o **SCP limita permiss√µes para entidades em contas membros**.

Esta √© a √öNICA maneira que **at√© o usu√°rio root pode ser impedido** de fazer algo. Por exemplo, poderia ser usado para impedir usu√°rios de desativar o CloudTrail ou excluir backups.\
A √∫nica maneira de contornar isso √© comprometer tamb√©m a **conta mestre** que configura os SCPs (conta mestre n√£o pode ser bloqueada).

{% hint style="warning" %}
Note que **SCPs apenas restringem os principais na conta**, ent√£o outras contas n√£o s√£o afetadas. Isso significa que ter um SCP negando `s3:GetObject` n√£o impedir√° pessoas de **acessarem um bucket S3 p√∫blico** na sua conta.
{% endhint %}

Exemplos de SCP:

* Negar completamente a conta root
* Permitir apenas regi√µes espec√≠ficas
* Permitir apenas servi√ßos na lista branca
*   Negar que GuardDuty, CloudTrail e Bloqueio de Acesso P√∫blico S3 sejam

desativados
*   Negar que fun√ß√µes de seguran√ßa/resposta a incidentes sejam exclu√≠das ou

modificadas.
* Negar que backups sejam exclu√≠dos.
* Negar a cria√ß√£o de usu√°rios IAM e chaves de acesso

Encontre **exemplos em JSON** em [https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html)

### ARN

**Amazon Resource Name** √© o **nome √∫nico** que cada recurso dentro da AWS possui, √© composto assim:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Note que existem 4 parti√ß√µes na AWS, mas apenas 3 maneiras de cham√°-las:

* AWS Padr√£o: `aws`
* AWS China: `aws-cn`
* AWS US internet p√∫blica (GovCloud): `aws-us-gov`
* AWS Secreta (US Classificada): `aws`

## IAM - Gerenciamento de Identidade e Acesso

IAM √© o servi√ßo que permitir√° gerenciar **Autentica√ß√£o**, **Autoriza√ß√£o** e **Controle de Acesso** dentro da sua conta AWS.

* **Autentica√ß√£o** - Processo de defini√ß√£o de uma identidade e a verifica√ß√£o dessa identidade. Este processo pode ser subdividido em: Identifica√ß√£o e verifica√ß√£o.
* **Autoriza√ß√£o** - Determina o que uma identidade pode acessar dentro de um sistema uma vez que tenha sido autenticada nele.
* **Controle de Acesso** - O m√©todo e processo de como o acesso √© concedido a um recurso seguro

IAM pode ser definido pela sua capacidade de gerenciar, controlar e governar mecanismos de autentica√ß√£o, autoriza√ß√£o e controle de acesso de identidades aos seus recursos dentro da sua conta AWS.

### [Usu√°rio raiz da conta AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html) <a href="#id_root" id="id_root"></a>

Quando voc√™ cria uma conta Amazon Web Services (AWS) pela primeira vez, come√ßa com uma √∫nica identidade de acesso que tem **acesso completo a todos** os servi√ßos e recursos AWS na conta. Este √© o _**usu√°rio raiz**_ da conta AWS e √© acessado ao entrar com o **endere√ßo de e-mail e senha que voc√™ usou para criar a conta**.

Note que um novo **usu√°rio admin** ter√° **menos permiss√µes que o usu√°rio raiz**.

Do ponto de vista de seguran√ßa, √© recomendado criar outros usu√°rios e evitar usar este.

### [Usu√°rios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Um _usu√°rio_ IAM √© uma entidade que voc√™ cria na AWS para **representar a pessoa ou aplicativo** que a usa para **interagir com a AWS**. Um usu√°rio na AWS consiste em um nome e credenciais (senha e at√© duas chaves de acesso).

Quando voc√™ cria um usu√°rio IAM, voc√™ concede a ele **permiss√µes** tornando-o **membro de um grupo de usu√°rios** que tem pol√≠ticas de permiss√£o apropriadas anexadas (recomendado), ou **anexando pol√≠ticas diretamente** ao usu√°rio.

Usu√°rios podem ter **MFA ativado para login** atrav√©s do console. Tokens de API de usu√°rios com MFA ativado n√£o s√£o protegidos pelo MFA. Se voc√™ quiser **restringir o acesso das chaves de API de um usu√°rio usando MFA**, voc√™ precisa indicar na pol√≠tica que, para realizar certas a√ß√µes, o MFA precisa estar presente (exemplo [**aqui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html)).

#### CLI

* **ID da Chave de Acesso**: 20 caracteres alfanum√©ricos aleat√≥rios mai√∫sculos como AKHDNAPO86BSHKDIRYT
* **ID da chave de acesso secreta**: 40 caracteres aleat√≥rios mai√∫sculos e min√∫sculos: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (N√£o √© poss√≠vel recuperar IDs de chaves de acesso secretas perdidas).

Sempre que precisar **mudar a Chave de Acesso**, este √© o processo que voc√™ deve seguir:\
_Criar uma nova chave de acesso -> Aplicar a nova chave ao sistema/aplicativo -> marcar a original como inativa -> Testar e verificar se a nova chave de acesso est√° funcionando -> Excluir a chave de acesso antiga_

### MFA - Autentica√ß√£o de M√∫ltiplos Fatores

√â usada para **criar um fator adicional para autentica√ß√£o** al√©m dos seus m√©todos existentes, como senha, criando assim um n√≠vel de autentica√ß√£o de m√∫ltiplos fatores.\
Voc√™ pode usar uma **aplica√ß√£o virtual gratuita ou um dispositivo f√≠sico**. Voc√™ pode usar aplicativos como o Google Authenticator gratuitamente para ativar um MFA na AWS.

Pol√≠ticas com condi√ß√µes de MFA podem ser anexadas ao seguinte:

* Um usu√°rio ou grupo IAM
* Um recurso como um bucket Amazon S3, fila Amazon SQS ou t√≥pico Amazon SNS
* A pol√≠tica de confian√ßa de uma fun√ß√£o IAM que pode ser assumida por um usu√°rio

Se voc√™ quiser **acessar via CLI** um recurso que **verifica o MFA**, voc√™ precisa chamar **`GetSessionToken`**. Isso lhe dar√° um token com informa√ß√µes sobre o MFA.\
Note que as credenciais de **`AssumeRole` n√£o cont√™m essa informa√ß√£o**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Como [**mencionado aqui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html), existem muitos casos diferentes onde o **MFA n√£o pode ser usado**.

### [Grupos de usu√°rios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Um [grupo de usu√°rios](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) IAM √© uma maneira de **associar pol√≠ticas a v√°rios usu√°rios** de uma s√≥ vez, o que pode facilitar o gerenciamento das permiss√µes para esses usu√°rios. **Fun√ß√µes e grupos n√£o podem fazer parte de um grupo**.

Voc√™ pode anexar uma **pol√≠tica baseada em identidade a um grupo de usu√°rios** para que todos os **usu√°rios** no grupo de usu√°rios **recebam as permiss√µes da pol√≠tica**. Voc√™ **n√£o pode** identificar um **grupo de usu√°rios** como um **`Principal`** em uma **pol√≠tica** (como uma pol√≠tica baseada em recursos) porque grupos se relacionam com permiss√µes, n√£o autentica√ß√£o, e principais s√£o entidades IAM autenticadas.

Aqui est√£o algumas caracter√≠sticas importantes dos grupos de usu√°rios:

* Um grupo de usu√°rios **pode conter muitos usu√°rios**, e um **usu√°rio** pode **pertencer a v√°rios grupos**.
* **Grupos de usu√°rios n√£o podem ser aninhados**; eles podem conter apenas usu√°rios, n√£o outros grupos de usu√°rios.
* N√£o existe **um grupo de usu√°rios padr√£o que inclua automaticamente todos os usu√°rios na conta AWS**. Se voc√™ deseja ter um grupo de usu√°rios assim, voc√™ deve cri√°-lo e atribuir cada novo usu√°rio a ele.
* O n√∫mero e tamanho dos recursos IAM em uma conta AWS, como o n√∫mero de grupos e o n√∫mero de grupos que um usu√°rio pode ser membro, s√£o limitados. Para mais informa√ß√µes, veja [IAM e cotas do AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-quotas.html).

### [Fun√ß√µes IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Uma fun√ß√£o IAM √© muito **semelhante** a um **usu√°rio**, no sentido de que √© uma **identidade com pol√≠ticas de permiss√£o que determinam o que** ela pode e n√£o pode fazer na AWS. No entanto, uma fun√ß√£o **n√£o possui credenciais** (senha ou chaves de acesso) associadas a ela. Em vez de estar associada exclusivamente a uma pessoa, uma fun√ß√£o √© destinada a ser **assum√≠vel por qualquer pessoa que precise dela (e tenha permiss√µes suficientes)**. Um **usu√°rio IAM pode assumir uma fun√ß√£o temporariamente** para adotar diferentes permiss√µes para uma tarefa espec√≠fica. Uma fun√ß√£o pode ser **atribu√≠da a um** [**usu√°rio federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html) que se conecta usando um provedor de identidade externo em vez de IAM.

Uma fun√ß√£o IAM consiste em **dois tipos de pol√≠ticas**: Uma **pol√≠tica de confian√ßa**, que n√£o pode estar vazia, definindo **quem pode assumir** a fun√ß√£o, e uma **pol√≠tica de permiss√µes**, que n√£o pode estar vazia, definindo **o que ela pode acessar**.

#### Servi√ßo de Token de Seguran√ßa AWS (STS)

Este √© um servi√ßo web que permite que voc√™ **solicite credenciais tempor√°rias e de privil√©gio limitado** para usu√°rios do AWS Identity and Access Management (IAM) ou para usu√°rios que voc√™ autentica (usu√°rios federados).

### [Credenciais tempor√°rias no IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Credenciais tempor√°rias s√£o usadas principalmente com fun√ß√µes IAM**, mas tamb√©m existem outros usos. Voc√™ pode solicitar credenciais tempor√°rias que t√™m um conjunto mais restrito de permiss√µes do que seu usu√°rio IAM padr√£o. Isso **previne** que voc√™ **execute acidentalmente tarefas que n√£o s√£o permitidas** pelas credenciais mais restritas. Um benef√≠cio das credenciais tempor√°rias √© que elas expiram automaticamente ap√≥s um per√≠odo de tempo definido. Voc√™ tem controle sobre a dura√ß√£o que as credenciais s√£o v√°lidas.

### Pol√≠ticas

#### Permiss√µes de Pol√≠tica

S√£o usadas para atribuir permiss√µes. Existem 2 tipos:

* Pol√≠ticas gerenciadas pela AWS (pr√©-configuradas pela AWS)
* Pol√≠ticas Gerenciadas pelo Cliente: Configuradas por voc√™. Voc√™ pode criar pol√≠ticas com base em pol√≠ticas gerenciadas pela AWS (modificando uma delas e criando a sua pr√≥pria), usando o gerador de pol√≠ticas (uma vis√£o GUI que ajuda voc√™ a conceder e negar permiss√µes) ou escrevendo a sua pr√≥pria.

Por **padr√£o o acesso** √© **negado**, o acesso ser√° concedido se um papel expl√≠cito tiver sido especificado.\
Se existir um √∫nico "Negar", ele sobrescrever√° o "Permitir", exceto para solicita√ß√µes que usam as credenciais de seguran√ßa raiz da conta AWS (que s√£o permitidas por padr√£o).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Os [campos globais que podem ser usados para condi√ß√µes em qualquer servi√ßo est√£o documentados aqui](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-resourceaccount).
Os [campos espec√≠ficos que podem ser usados para condi√ß√µes por servi√ßo est√£o documentados aqui](https://docs.aws.amazon.com/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html).

#### Pol√≠ticas Inline

Esse tipo de pol√≠ticas s√£o **atribu√≠das diretamente** a um usu√°rio, grupo ou fun√ß√£o. Ent√£o, elas n√£o aparecem na lista de Pol√≠ticas como outras que qualquer um pode usar.
Pol√≠ticas inline s√£o √∫teis se voc√™ quer **manter uma rela√ß√£o estrita um-para-um entre uma pol√≠tica e a identidade** √† qual ela √© aplicada. Por exemplo, voc√™ quer ter certeza de que as permiss√µes em uma pol√≠tica n√£o s√£o inadvertidamente atribu√≠das a uma identidade diferente daquela para a qual s√£o destinadas. Quando voc√™ usa uma pol√≠tica inline, as permiss√µes na pol√≠tica n√£o podem ser inadvertidamente anexadas √† identidade errada. Al√©m disso, quando voc√™ usa o AWS Management Console para excluir essa identidade, as pol√≠ticas incorporadas na identidade tamb√©m s√£o exclu√≠das. Isso porque elas fazem parte da entidade principal.

#### Pol√≠ticas de Bucket de Recursos

Estas s√£o **pol√≠ticas** que podem ser definidas em **recursos**. **Nem todos os recursos da AWS as suportam**.

Se um principal n√£o tem uma nega√ß√£o expl√≠cita sobre eles, e uma pol√≠tica de recurso concede acesso, ent√£o eles s√£o permitidos.

### Limites do IAM

Limites do IAM podem ser usados para **limitar as permiss√µes que um usu√°rio ou fun√ß√£o devem ter acesso**. Desta forma, mesmo que um conjunto diferente de permiss√µes seja concedido ao usu√°rio por uma **pol√≠tica diferente**, a opera√ß√£o ir√° **falhar** se ele tentar us√°-las.

Um limite √© apenas uma pol√≠tica anexada a um usu√°rio que **indica o n√≠vel m√°ximo de permiss√µes que o usu√°rio ou fun√ß√£o pode ter**. Ent√£o, **mesmo que o usu√°rio tenha acesso de Administrador**, se o limite indica que ele s√≥ pode ler buckets S3, isso √© o m√°ximo que ele pode fazer.

**Isso**, **SCPs** e **seguir o princ√≠pio do menor privil√©gio** s√£o as maneiras de controlar que os usu√°rios n√£o tenham mais permiss√µes do que as que eles precisam.

### Pol√≠ticas de Sess√£o

Uma pol√≠tica de sess√£o √© uma **pol√≠tica definida quando uma fun√ß√£o √© assumida** de alguma forma. Isso ser√° como um **limite do IAM para aquela sess√£o**: Isso significa que a pol√≠tica de sess√£o n√£o concede permiss√µes, mas **restringe-as √†s indicadas na pol√≠tica** (sendo as permiss√µes m√°ximas as que a fun√ß√£o tem).

Isso √© √∫til para **medidas de seguran√ßa**: Quando um administrador vai assumir uma fun√ß√£o muito privilegiada, ele poderia restringir a permiss√£o para apenas as indicadas na pol√≠tica de sess√£o, caso a sess√£o seja comprometida.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Note que por padr√£o **a AWS pode adicionar pol√≠ticas de sess√£o a sess√µes** que ser√£o geradas por terceiros. Por exemplo, em [fun√ß√µes assumidas pelo cognito n√£o autenticado](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) por padr√£o (usando autentica√ß√£o aprimorada), a AWS gerar√° **credenciais de sess√£o com uma pol√≠tica de sess√£o** que limita os servi√ßos que a sess√£o pode acessar [**para a seguinte lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Portanto, se em algum momento voc√™ se deparar com o erro "... porque nenhuma pol√≠tica de sess√£o permite o ...", e a fun√ß√£o tem acesso para realizar a a√ß√£o, √© porque **existe uma pol√≠tica de sess√£o impedindo isso**.

### Federa√ß√£o de Identidade

A federa√ß√£o de identidade **permite que usu√°rios de provedores de identidade externos** √† AWS acessem recursos da AWS de forma segura sem ter que fornecer credenciais de usu√°rio da AWS de uma conta IAM v√°lida.\
Um exemplo de provedor de identidade pode ser o seu pr√≥prio **Microsoft Active Directory** (via **SAML**) ou servi√ßos **OpenID** (como **Google**). O acesso federado permitir√° ent√£o que os usu√°rios dentro dele acessem a AWS.

Para configurar essa confian√ßa, um **Provedor de Identidade IAM √© gerado (SAML ou OAuth)** que ir√° **confiar** na **outra plataforma**. Ent√£o, pelo menos uma **fun√ß√£o IAM √© atribu√≠da (confiando) ao Provedor de Identidade**. Se um usu√°rio da plataforma confi√°vel acessar a AWS, ele estar√° acessando como a fun√ß√£o mencionada.

No entanto, voc√™ geralmente desejar√° dar uma **fun√ß√£o diferente dependendo do grupo do usu√°rio** na plataforma de terceiros. Ent√£o, v√°rias **fun√ß√µes IAM podem confiar** no Provedor de Identidade de terceiros e a plataforma de terceiros ser√° a respons√°vel por permitir que os usu√°rios assumam uma fun√ß√£o ou outra.

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

O AWS IAM Identity Center (sucessor do AWS Single Sign-On) expande as capacidades do AWS Identity and Access Management (IAM) para fornecer um **local central** que re√∫ne **administra√ß√£o de usu√°rios e seu acesso a contas da AWS** e aplica√ß√µes em nuvem.

O dom√≠nio de login ser√° algo como `<user_input>.awsapps.com`.

Para fazer login dos usu√°rios, existem 3 fontes de identidade que podem ser usadas:

* Diret√≥rio do Identity Center: Usu√°rios regulares da AWS
* Active Directory: Suporta diferentes conectores
* Provedor de Identidade Externo: Todos os usu√°rios e grupos v√™m de um Provedor de Identidade Externo (IdP)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

No caso mais simples do diret√≥rio do Identity Center, o **Identity Center ter√° uma lista de usu√°rios e grupos** e poder√° **atribuir pol√≠ticas** a eles para **qualquer uma das contas** da organiza√ß√£o.

Para dar acesso a um usu√°rio/grupo do Identity Center a uma conta, um **Provedor de Identidade SAML confiando no Identity Center ser√° criado**, e uma **fun√ß√£o confiando no Provedor de Identidade com as pol√≠ticas indicadas ser√° criada** na conta de destino.

#### AwsSSOInlinePolicy

√â poss√≠vel **conceder permiss√µes via pol√≠ticas inline para fun√ß√µes criadas via IAM Identity Center**. As fun√ß√µes criadas nas contas com **pol√≠ticas inline no AWS Identity Center** ter√£o essas permiss√µes em uma pol√≠tica inline chamada **`AwsSSOInlinePolicy`**.

Portanto, mesmo que voc√™ veja 2 fun√ß√µes com uma pol√≠tica inline chamada **`AwsSSOInlinePolicy`**, isso **n√£o significa que elas t√™m as mesmas permiss√µes**.

### Confian√ßas e Fun√ß√µes entre Contas

**Um usu√°rio** (confiante) pode criar uma Fun√ß√£o entre Contas com algumas pol√≠ticas e, em seguida, **permitir que outro usu√°rio** (confi√°vel) **acesse sua conta**, mas apenas t**endo o acesso indicado nas novas pol√≠ticas da fun√ß√£o**. Para criar isso, basta criar uma nova Fun√ß√£o e selecionar Fun√ß√£o entre Contas. Fun√ß√µes para Acesso entre Contas oferecem duas op√ß√µes. Fornecer acesso entre contas da AWS que voc√™ possui e fornecer acesso entre uma conta que voc√™ possui e uma conta AWS de terceiros.\
√â recomendado **especificar o usu√°rio que √© confi√°vel e n√£o colocar algo gen√©rico** porque, caso contr√°rio, outros usu√°rios autenticados, como usu√°rios federados, tamb√©m poder√£o abusar dessa confian√ßa.

### AWS Simple AD

N√£o suportado:

* Rela√ß√µes de Confian√ßa
* AD Admin Center
* Suporte completo √† API PS
* Lixeira do AD
* Contas de Servi√ßo Gerenciadas pelo Grupo
* Extens√µes de Esquema
* Sem acesso direto ao SO ou Inst√¢ncias

#### Federa√ß√£o Web ou Autentica√ß√£o OpenID

O aplicativo usa o AssumeRoleWithWebIdentity para criar credenciais tempor√°rias. No entanto, isso n√£o concede acesso ao console da AWS, apenas acesso a recursos dentro da AWS.

### Outras op√ß√µes de IAM

* Voc√™ pode **definir uma pol√≠tica de senha** com op√ß√µes como comprimento m√≠nimo e requisitos de senha.
* Voc√™ pode **baixar "Relat√≥rio de Credenciais"** com informa√ß√µes sobre credenciais atuais (como tempo de cria√ß√£o do usu√°rio, se a senha est√° habilitada...). Voc√™ pode gerar um relat√≥rio de credenciais com frequ√™ncia de at√© **quatro horas**.

O AWS Identity and Access Management (IAM) fornece **controle de acesso detalhado** em toda a AWS. Com o IAM, voc√™ pode especificar **quem pode acessar quais servi√ßos e recursos**, e sob quais condi√ß√µes. Com pol√≠ticas IAM, voc√™ gerencia permiss√µes para sua for√ßa de trabalho e sistemas para **garantir permiss√µes de menor privil√©gio**.

### Prefixos de ID do IAM

Nesta [**p√°gina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) voc√™ pode encontrar os **prefixos de ID do IAM** de chaves dependendo de sua natureza:

| ABIA | [Token de portador do servi√ßo AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial espec√≠fica do contexto                                                                                                                                                                                     |
| AGPA | Grupo de usu√°rios                                                                                                                                                                                                     |
| AIDA | Usu√°rio IAM                                                                                                                                                                                                           |
| AIPA | Perfil de inst√¢ncia Amazon EC2                                                                                                                                                                                        |
| AKIA | Chave de acesso                                                                                                                                                                                                       |
| ANPA | Pol√≠tica gerenciada                                                                                                                                                                                                   |
| ANVA | Vers√£o em uma pol√≠tica gerenciada                                                                                                                                                                                     |
| APKA | Chave p√∫blica                                                                                                                                                                                                         |
| AROA | Fun√ß√£o                                                                                                                                                                                                                |
| ASCA | Certificado                                                                                                                                                                                                           |
| ASIA | [Chaves de acesso tempor√°rias (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) usam este prefixo, mas s√£o √∫nicas apenas em combina√ß√£o com a chave de acesso secreta e o token de sess√£o. |

### Permiss√µes recomendadas para auditoria de contas

Os seguintes privil√©gios concedem v√°rios acessos de leitura de metadados:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`
## Diversos

### Autentica√ß√£o CLI

Para que um usu√°rio comum se autentique no AWS via CLI, √© necess√°rio ter **credenciais locais**. Por padr√£o, voc√™ pode configur√°-las **manualmente** em `~/.aws/credentials` ou **executando** `aws configure`.\
Nesse arquivo, voc√™ pode ter mais de um perfil. Se **nenhum perfil** for especificado ao usar o **aws cli**, o chamado **`[default]`** nesse arquivo ser√° utilizado.\
Exemplo de arquivo de credenciais com mais de 1 perfil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Se voc√™ precisa acessar **diferentes contas da AWS** e seu perfil foi dado acesso para **assumir um papel dentro dessas contas**, voc√™ n√£o precisa chamar manualmente o STS todas as vezes (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) e configurar as credenciais.

Voc√™ pode usar o arquivo `~/.aws/config` para [**indicar quais pap√©is assumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), e ent√£o usar o par√¢metro `--profile` como de costume (o `assume-role` ser√° realizado de forma transparente para o usu√°rio).\
Um exemplo de arquivo de configura√ß√£o:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Com este arquivo de configura√ß√£o, voc√™ pode ent√£o usar o aws cli como:
```
aws --profile acc2 ...
```
Se voc√™ est√° procurando algo **similar** a isso, mas para o **navegador**, voc√™ pode conferir a **extens√£o** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Refer√™ncias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
