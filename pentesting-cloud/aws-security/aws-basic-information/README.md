# AWS - Informazioni di base

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Gerarchia dell'organizzazione

![](<../../../.gitbook/assets/image (54).png>)

### Account

In AWS c'√® un **account principale**, che √® il **contenitore principale per tutti gli account** della tua **organizzazione**. Tuttavia, non √® necessario utilizzare quell'account per distribuire risorse, √® possibile creare **altri account per separare le diverse infrastrutture AWS** tra di loro.

Questo √® molto interessante dal punto di vista della **sicurezza**, poich√© **un account non sar√† in grado di accedere alle risorse di un altro account** (a meno che non vengano creati appositamente dei collegamenti), in questo modo √® possibile creare confini tra le distribuzioni.

Pertanto, ci sono **due tipi di account in un'organizzazione** (stiamo parlando di account AWS e non di account utente): un singolo account designato come account di gestione e uno o pi√π account membri.

*   L'**account di gestione (l'account principale)** √® l'account che si utilizza per creare l'organizzazione. Dall'account di gestione dell'organizzazione, √® possibile fare quanto segue:

* Creare account nell'organizzazione
* Invitare altri account esistenti all'organizzazione
* Rimuovere account dall'organizzazione
* Gestire inviti
* Applicare politiche alle entit√† (radici, OU o account) all'interno dell'organizzazione
* Abilitare l'integrazione con i servizi AWS supportati per fornire funzionalit√† di servizio in tutti gli account dell'organizzazione.
* √à possibile accedere come utente principale utilizzando l'email e la password utilizzate per creare questo account principale/organizzazione.

L'account di gestione ha le **responsabilit√† di un account pagante** ed √® responsabile del pagamento di tutte le spese accumulate dagli account membri. Non √® possibile modificare l'account di gestione di un'organizzazione.
* Gli **account membri** costituiscono tutti gli altri account di un'organizzazione. Un account pu√≤ essere membro di una sola organizzazione alla volta. √à possibile allegare una policy a un account per applicare controlli solo a quell'account.
* Gli account membri **devono utilizzare un indirizzo email valido** e possono avere un **nome**, in generale non saranno in grado di gestire la fatturazione (ma potrebbero essere autorizzati ad accedervi).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Unit√† Organizzative**

Gli account possono essere raggruppati in **Unit√† Organizzative (OU)**. In questo modo, √® possibile creare **policy** per l'Unit√† Organizzativa che verranno **applicate a tutti gli account figli**. Nota che un'OU pu√≤ avere altre OU come figli.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Service Control Policy (SCP)

Una **Service Control Policy (SCP)** √® una politica che specifica i servizi e le azioni che gli utenti e i ruoli possono utilizzare negli account che l'SCP interessa. Gli SCP sono **simili alle politiche di autorizzazioni IAM**, tranne che non concedono alcuna autorizzazione. Invece, gli SCP specificano le **autorizzazioni massime** per un'organizzazione, un'unit√† organizzativa (OU) o un account. Quando si attacca un SCP alla radice dell'organizzazione o a un'OU, l'SCP limita le autorizzazioni per le entit√† negli account membri.

Questa √® l'UNICA modalit√† in cui **anche l'utente root pu√≤ essere bloccato** dal fare qualcosa. Ad esempio, potrebbe essere utilizzato per impedire agli utenti di disabilitare CloudTrail o eliminare i backup.\
L'unico modo per aggirare ci√≤ √® compromettere anche l'**account principale** che configura gli SCP (l'account principale non pu√≤ essere bloccato).

{% hint style="warning" %}
Si noti che **gli SCP limitano solo i principali nell'account**, quindi gli altri account non sono interessati. Ci√≤ significa che negare un'azione `s3:GetObject` non impedir√† alle persone di **accedere a un bucket S3 pubblico** nel tuo account.
{% endhint %}

Esempi di SCP:

* Negare completamente l'account root
* Consentire solo regioni specifiche
* Consentire solo servizi in una whitelist
*   Negare la disabilitazione di GuardDuty, CloudTrail e l'accesso

pubblico a S3
*   Negare l'eliminazione o la modifica di ruoli di sicurezza o di

risposta agli incidenti.
* Negare l'eliminazione dei backup.
* Negare la creazione di utenti IAM e chiavi di accesso

Trova esempi di **JSON** su [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** √® il **nome univoco** che ogni risorsa all'interno di AWS ha, √® composto nel seguente modo:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Nota che ci sono 4 partizioni in AWS ma solo 3 modi per chiamarle:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identity and Access Management

IAM √® il servizio che ti permette di gestire **Autenticazione**, **Autorizzazione** e **Controllo degli Accessi** all'interno del tuo account AWS.

* **Autenticazione** - Processo di definizione di un'identit√† e la verifica di tale identit√†. Questo processo pu√≤ essere suddiviso in: Identificazione e verifica.
* **Autorizzazione** - Determina a cosa pu√≤ accedere un'identit√† all'interno di un sistema una volta che √® stata autenticata.
* **Controllo degli Accessi** - Il metodo e il processo di come viene concesso l'accesso a una risorsa sicura.

IAM pu√≤ essere definito dalla sua capacit√† di gestire, controllare e governare i meccanismi di autenticazione, autorizzazione e controllo degli accessi delle identit√† alle risorse all'interno del tuo account AWS.

### [Utente root dell'account AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Quando crei per la prima volta un account Amazon Web Services (AWS), inizi con un'identit√† di accesso singola che ha **accesso completo a tutti** i servizi e le risorse AWS nell'account. Questo √® l'utente _**root**_ dell'account AWS e si accede utilizzando l'**indirizzo email e la password** utilizzati per creare l'account.

Nota che un nuovo **utente amministratore** avr√† **meno autorizzazioni rispetto all'utente root**.

Dal punto di vista della sicurezza, √® consigliabile creare altri utenti e evitare di utilizzare questo.

### [Utenti IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _utente IAM_ √® un'entit√† che crei in AWS per **rappresentare la persona o l'applicazione** che lo utilizza per **interagire con AWS**. Un utente in AWS √® composto da un nome e credenziali (password e fino a due chiavi di accesso).

Quando crei un utente IAM, gli concedi **autorizzazioni** rendendolo un **membro di un gruppo di utenti** a cui sono associate le opportune politiche di autorizzazione (consigliato), o **allegando direttamente politiche** all'utente.

Gli utenti possono avere **MFA abilitato per l'accesso** tramite la console. I token API degli utenti con MFA abilitato non sono protetti da MFA. Se vuoi **limitare l'accesso alle chiavi API di un utente utilizzando MFA**, devi indicare nella policy che per eseguire determinate azioni √® necessaria la presenza di MFA (esempio [**qui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID chiave di accesso**: 20 caratteri alfanumerici maiuscoli casuali come AKHDNAPO86BSHKDIRYT
* **ID chiave di accesso segreta**: 40 caratteri casuali maiuscoli e minuscoli: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (Non √® possibile recuperare le ID chiave di accesso segrete perse).

Ogni volta che hai bisogno di **cambiare la chiave di accesso**, questo √® il processo che dovresti seguire:\
_Crea una nuova chiave di accesso -> Applica la nuova chiave al sistema/applicazione -> segna quella originale come inattiva -> Testa e verifica che la nuova chiave di accesso funzioni -> Elimina la vecchia chiave di accesso_

### MFA - Autenticazione Multifattore

Viene utilizzata per **creare un fattore aggiuntivo per l'autenticazione** oltre ai metodi esistenti, come la password, creando quindi un livello di autenticazione multifattore.\
Puoi utilizzare un'applicazione virtuale gratuita o un dispositivo fisico. Puoi utilizzare app come Google Authenticator gratuitamente per attivare un MFA in AWS.

Le policy con condizioni MFA possono essere allegati ai seguenti elementi:

* Un utente o un gruppo IAM
* Una risorsa come un bucket Amazon S3, una coda Amazon SQS o un argomento Amazon SNS
* La policy di trust di un ruolo IAM che pu√≤ essere assunto da un utente

Se vuoi **accedere tramite CLI** a una risorsa che **richiede MFA**, devi chiamare **`GetSessionToken`**. Questo ti fornir√† un token con informazioni su MFA.\
Nota che le credenziali di **`AssumeRole` non contengono queste informazioni**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Come [**indicato qui**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), ci sono molti casi in cui **MFA non pu√≤ essere utilizzato**.

### [Gruppi utente IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un **gruppo utente IAM** √® un modo per **associare le policy a pi√π utenti** contemporaneamente, semplificando cos√¨ la gestione delle autorizzazioni per quegli utenti. **I ruoli e i gruppi non possono far parte di un gruppo**.

√à possibile associare una **policy basata sull'identit√† a un gruppo utente** in modo che tutti gli **utenti** nel gruppo utente **ricevano le autorizzazioni della policy**. Non √® possibile identificare un **gruppo utente** come un **`Principal`** in una **policy** (come una policy basata sulle risorse) perch√© i gruppi sono correlati alle autorizzazioni, non all'autenticazione, e i principali sono entit√† IAM autenticate.

Ecco alcune caratteristiche importanti dei gruppi utente:

* Un **gruppo utente** pu√≤ **contenere molti utenti**, e un **utente** pu√≤ **appartenere a pi√π gruppi**.
* **I gruppi utente non possono essere nidificati**; possono contenere solo utenti, non altri gruppi utente.
* Non esiste un **gruppo utente predefinito che includa automaticamente tutti gli utenti nell'account AWS**. Se si desidera avere un gruppo utente del genere, √® necessario crearlo e assegnare ogni nuovo utente ad esso.
* Il numero e la dimensione delle risorse IAM in un account AWS, come il numero di gruppi e il numero di gruppi di cui un utente pu√≤ essere membro, sono limitati. Per ulteriori informazioni, consultare [IAM e le quote di AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Ruoli IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **ruolo IAM** √® molto **simile** a un **utente**, nel senso che √® un'**identit√† con policy di autorizzazione che determinano cosa** pu√≤ e non pu√≤ fare in AWS. Tuttavia, un ruolo **non ha credenziali** (password o chiavi di accesso) associate ad esso. Invece di essere associato in modo univoco a una persona, un ruolo √® destinato ad essere **assumibile da chiunque ne abbia bisogno (e abbia abbastanza permessi)**. Un **utente IAM pu√≤ assumere un ruolo per assumere temporaneamente** diverse autorizzazioni per un compito specifico. Un ruolo pu√≤ essere **assegnato a un** [**utente federato**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) che accede utilizzando un provider di identit√† esterno anzich√© IAM.

Un ruolo IAM √® composto da **due tipi di policy**: una **policy di trust**, che non pu√≤ essere vuota, che definisce **chi pu√≤ assumere** il ruolo, e una **policy di autorizzazioni**, che non pu√≤ essere vuota, che definisce **a cosa pu√≤ accedere**.

#### AWS Security Token Service (STS)

AWS Security Token Service (STS) √® un servizio web che facilita l'**emissione di credenziali temporanee con privilegi limitati**. √à specificamente progettato per:

### [Credenziali temporanee in IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Le credenziali temporanee sono principalmente utilizzate con i ruoli IAM**, ma ci sono anche altri utilizzi. √à possibile richiedere credenziali temporanee che hanno un insieme di autorizzazioni pi√π restrittivo rispetto all'utente IAM standard. Questo **impedisce** di **eseguire accidentalmente attivit√† non consentite** dalle credenziali pi√π restrittive. Un vantaggio delle credenziali temporanee √® che scadono automaticamente dopo un determinato periodo di tempo. Si ha il controllo sulla durata di validit√† delle credenziali.

### Policy

#### Autorizzazioni delle policy

Vengono utilizzate per assegnare autorizzazioni. Ci sono 2 tipi:

* Policy gestite da AWS (preconfigurate da AWS)
* Policy gestite dal cliente: Configurate da te. Puoi creare policy basate su policy gestite da AWS (modificandone una e creandone una tua), utilizzando il generatore di policy (una vista GUI che ti aiuta a concedere e negare autorizzazioni) o scrivendo la tua.

Per **default l'accesso** √® **negato**, l'accesso verr√† concesso se √® stato specificato un ruolo esplicito.\
Se esiste un **singolo "Deny"**, esso **sovrascriver√† l'"Allow"**, ad eccezione delle richieste che utilizzano le credenziali di sicurezza radice dell'account AWS (che sono consentite per impostazione predefinita).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
I [campi globali che possono essere utilizzati per le condizioni in qualsiasi servizio sono documentati qui](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
I [campi specifici che possono essere utilizzati per le condizioni per servizio sono documentati qui](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Inline Policies

Questo tipo di politiche viene **assegnato direttamente** a un utente, gruppo o ruolo. Quindi, non appaiono nell'elenco delle politiche come qualsiasi altra pu√≤ usarle.\
Le politiche inline sono utili se si desidera **mantenere una stretta relazione uno a uno tra una politica e l'identit√†** a cui viene applicata. Ad esempio, si desidera essere sicuri che i permessi in una politica non vengano assegnati per errore a un'identit√† diversa da quella prevista. Quando si utilizza una politica inline, i permessi nella politica non possono essere assegnati per errore all'identit√† sbagliata. Inoltre, quando si utilizza la console di gestione AWS per eliminare quell'identit√†, le politiche incorporate nell'identit√† vengono eliminate anche. Questo perch√© fanno parte dell'entit√† principale.

#### Politiche del bucket delle risorse

Queste sono **politiche** che possono essere definite nelle **risorse**. **Non tutte le risorse di AWS le supportano**.

Se un principale non ha un rifiuto esplicito su di esse e una politica delle risorse concede loro l'accesso, allora sono consentiti.

### Limiti IAM

I limiti IAM possono essere utilizzati per **limitare le autorizzazioni a cui un utente o un ruolo dovrebbe avere accesso**. In questo modo, anche se un diverso set di autorizzazioni viene concesso all'utente da una **diversa politica**, l'operazione **fallir√†** se prova a utilizzarle.

Un limite √® semplicemente una politica allegata a un utente che **indica il livello massimo di autorizzazioni che l'utente o il ruolo pu√≤ avere**. Quindi, **anche se l'utente ha accesso di amministratore**, se il limite indica che pu√≤ solo leggere i bucket S3, quello √® il massimo che pu√≤ fare.

**Questo**, **SCP** e **seguire il principio del privilegio minimo** sono i modi per controllare che gli utenti non abbiano pi√π autorizzazioni di quelle necessarie.

### Politiche di sessione

Una politica di sessione √® una **politica impostata quando viene assunto un ruolo** in qualche modo. Questo sar√† come un **limite IAM per quella sessione**: ci√≤ significa che la politica di sessione non concede autorizzazioni ma **le limita a quelle indicate nella politica** (essendo le autorizzazioni massime quelle del ruolo).

Questo √® utile per **misure di sicurezza**: quando un amministratore sta per assumere un ruolo molto privilegiato, potrebbe limitare i permessi solo a quelli indicati nella politica di sessione nel caso in cui la sessione venga compromessa.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Nota che per impostazione predefinita **AWS potrebbe aggiungere le session policies alle sessioni** che verranno generate a causa di terze parti. Ad esempio, in [ruoli assunti di Cognito non autenticati](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) per impostazione predefinita (utilizzando l'autenticazione avanzata), AWS generer√† **credenziali di sessione con una session policy** che limita i servizi ai quali la sessione pu√≤ accedere [**alla seguente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Pertanto, se a un certo punto si verifica l'errore "... perch√© nessuna session policy consente il ...", e il ruolo ha accesso per eseguire l'azione, √® perch√© **esiste una session policy che lo impedisce**.

### Federazione delle identit√†

La federazione delle identit√† **consente agli utenti di fornitori di identit√† esterni** ad AWS di accedere in modo sicuro alle risorse di AWS senza dover fornire le credenziali dell'utente AWS da un account IAM valido.\
Un esempio di provider di identit√† pu√≤ essere il proprio **Microsoft Active Directory** aziendale (tramite **SAML**) o servizi **OpenID** (come **Google**). L'accesso federato consentir√† quindi agli utenti di accedere ad AWS all'interno di esso.

Per configurare questa fiducia, viene generato un **IAM Identity Provider (SAML o OAuth)** che **affider√†** l'**altra piattaforma**. Quindi, viene assegnato almeno un **ruolo IAM (fiducia) all'Identity Provider**. Se un utente della piattaforma fidata accede ad AWS, acceder√† come il ruolo menzionato.

Tuttavia, di solito si desidera assegnare un **ruolo diverso a seconda del gruppo dell'utente** nella piattaforma di terze parti. Quindi, diversi **ruoli IAM possono fidarsi** del provider di identit√† di terze parti e sar√† la piattaforma di terze parti a consentire agli utenti di assumere uno o l'altro ruolo.

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center (successore di AWS Single Sign-On) amplia le funzionalit√† di AWS Identity and Access Management (IAM) per fornire un **punto centrale** che riunisce **l'amministrazione degli utenti e il loro accesso agli account AWS** e alle applicazioni cloud.

Il dominio di accesso sar√† qualcosa come `<user_input>.awsapps.com`.

Per accedere agli utenti, ci sono 3 fonti di identit√† che possono essere utilizzate:

* Identity Center Directory: utenti regolari di AWS
* Active Directory: supporta diversi connettori
* External Identity Provider: tutti gli utenti e i gruppi provengono da un provider di identit√† esterno (IdP)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

Nel caso pi√π semplice del directory Identity Center, l'**Identity Center avr√† un elenco di utenti e gruppi** e sar√† in grado di **assegnare policy** a loro per **qualsiasi account** dell'organizzazione.

Per concedere l'accesso a un utente/gruppo di Identity Center a un account, verr√† creato un **SAML Identity Provider che si fida dell'Identity Center**, e verr√† creato un **ruolo che si fida dell'Identity Provider con le policy indicate** nell'account di destinazione.

#### AwsSSOInlinePolicy

√à possibile **concedere autorizzazioni tramite inline policies ai ruoli creati tramite IAM Identity Center**. I ruoli creati negli account a cui vengono **assegnate inline policies in AWS Identity Center** avranno queste autorizzazioni in una inline policy chiamata **`AwsSSOInlinePolicy`**.

Pertanto, anche se si vedono 2 ruoli con una inline policy chiamata **`AwsSSOInlinePolicy`**, **non significa che abbiano le stesse autorizzazioni**.

### Trust e ruoli tra account

**Un utente** (fiducia) pu√≤ creare un ruolo tra account con alcune policy e quindi, **consentire a un altro utente** (fidato) di **accedere al suo account** ma solo **avendo l'accesso indicato nelle nuove policy del ruolo**. Per creare questo, basta creare un nuovo ruolo e selezionare Ruolo tra account. I ruoli per l'accesso tra account offrono due opzioni. Fornire accesso tra account AWS di propriet√† e fornire accesso tra un account di propriet√† e un account AWS di terze parti.\
Si consiglia di **specificare l'utente di fiducia e non inserire qualcosa di generico** perch√© in caso contrario, altri utenti autenticati come utenti federati saranno in grado di abusare di questa fiducia.

### AWS Simple AD

Non supportato:

* Relazioni di fiducia
* AD Admin Center
* Supporto completo per l'API PS
* Cestino di AD
* Account di servizio gestiti dal gruppo
* Estensioni dello schema
* Nessun accesso diretto al sistema operativo o alle istanze

#### Web Federation o autenticazione OpenID

L'app utilizza AssumeRoleWithWebIdentity per creare credenziali temporanee. Tuttavia, ci√≤ non concede l'accesso alla console AWS, ma solo l'accesso alle risorse all'interno di AWS.

### Altre opzioni IAM

* √à possibile **impostare una password policy** con opzioni come la lunghezza minima e i requisiti della password.
* √à possibile **scaricare il "Credential Report"** con informazioni sulle credenziali correnti (come l'ora di creazione dell'utente, se la password √® abilitata...). √à possibile generare un rapporto sulle credenziali fino a una volta ogni **quattro ore**.

AWS Identity and Access Management (IAM) fornisce un **controllo degli accessi dettagliato** su tutti i servizi di AWS. Con IAM, √® possibile specificare **chi pu√≤ accedere a quali servizi e risorse**, e in quali condizioni. Con le policy IAM, √® possibile gestire le autorizzazioni per il proprio personale e i propri sistemi per **garantire le autorizzazioni di privilegio minimo**.

### Prefissi IAM ID

In [**questa pagina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) √® possibile trovare i prefissi IAM ID delle chiavi in base alla loro natura:

| ABIA | [AWS STS service bearer token](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credenziale specifica del contesto                                                                                                                                                                                     |
| AGPA | Gruppo di utenti                                                                                                                                                                                                      |
| AIDA | Utente IAM                                                                                                                                                                                                            |
| AIPA | Profilo istanza Amazon EC2                                                                                                                                                                                            |
| AKIA | Chiave di accesso                                                                                                                                                                                                     |
| ANPA | Policy gestita                                                                                                                                                                                                        |
| ANVA | Versione in una policy gestita                                                                                                                                                                                        |
| APKA | Chiave pubblica                                                                                                                                                                                                       |
| AROA | Ruolo                                                                                                                                                                                                                 |
| ASCA | Certificato                                                                                                                                                                                                           |
| ASIA | Gli ID delle chiavi di accesso temporaneo (AWS STS) usano questo prefisso, ma sono univoci solo in combinazione con la chiave di accesso segreta e il token di sessione.                                              |

### Autorizzazioni consigliate per l'audit degli account

I seguenti privilegi concedono vari accessi in lettura dei metadati:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Varie

### Autenticazione CLI

Affinch√© un utente regolare si autentichi ad AWS tramite CLI, √® necessario disporre di **credenziali locali**. Per impostazione predefinita, √® possibile configurarle **manualmente** in `~/.aws/credentials` o **eseguendo** `aws configure`.\
In quel file √® possibile avere pi√π di un profilo, se **nessun profilo** viene specificato utilizzando il **cli aws**, verr√† utilizzato quello chiamato **`[default]`** in quel file.\
Esempio di file di credenziali con pi√π di 1 profilo:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Se hai bisogno di accedere a **diversi account AWS** e il tuo profilo ha ottenuto l'accesso per **assumere un ruolo all'interno di quegli account**, non √® necessario chiamare manualmente STS ogni volta (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) e configurare le credenziali.

Puoi utilizzare il file `~/.aws/config` per [**indicare quali ruoli assumere**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), e quindi utilizzare il parametro `--profile` come al solito (l'`assume-role` verr√† eseguito in modo trasparente per l'utente).\
Un esempio di file di configurazione:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Con questo file di configurazione, √® possibile utilizzare aws cli come segue:
```
aws --profile acc2 ...
```
Se stai cercando qualcosa di **simile** a questo ma per il **browser**, puoi controllare l'**estensione** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Riferimenti

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
