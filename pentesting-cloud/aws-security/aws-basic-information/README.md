# AWS - Informaci칩n B치sica

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Jerarqu칤a de la Organizaci칩n

![](<../../../.gitbook/assets/image (151).png>)

### Cuentas

En AWS existe una **cuenta ra칤z,** que es el **contenedor principal para todas las cuentas** de tu **organizaci칩n**. Sin embargo, no es necesario utilizar esa cuenta para implementar recursos, puedes crear **otras cuentas para separar diferentes infraestructuras de AWS** entre ellas.

Esto es muy interesante desde un punto de vista de **seguridad**, ya que **una cuenta no podr치 acceder a recursos de otra cuenta** (a menos que se creen puentes espec칤ficamente), de esta manera puedes crear l칤mites entre despliegues.

Por lo tanto, existen **dos tipos de cuentas en una organizaci칩n** (estamos hablando de cuentas de AWS y no de cuentas de usuario): una cuenta 칰nica designada como la cuenta de gesti칩n, y una o m치s cuentas de miembro.

*   La **cuenta de gesti칩n (la cuenta ra칤z)** es la cuenta que utilizas para crear la organizaci칩n. Desde la cuenta de gesti칩n de la organizaci칩n, puedes hacer lo siguiente:

* Crear cuentas en la organizaci칩n
* Invitar a otras cuentas existentes a la organizaci칩n
* Eliminar cuentas de la organizaci칩n
* Gestionar invitaciones
* Aplicar pol칤ticas a entidades (ra칤ces, OUs o cuentas) dentro de la organizaci칩n
* Habilitar la integraci칩n con servicios de AWS compatibles para proporcionar funcionalidad de servicio en todas las cuentas de la organizaci칩n.
* Es posible iniciar sesi칩n como usuario ra칤z utilizando el correo electr칩nico y la contrase침a utilizados para crear esta cuenta ra칤z/organizaci칩n.

La cuenta de gesti칩n tiene las **responsabilidades de una cuenta pagadora** y es responsable de pagar todos los cargos acumulados por las cuentas de miembro. No se puede cambiar la cuenta de gesti칩n de una organizaci칩n.
* Las **cuentas de miembro** conforman todas las dem치s cuentas en una organizaci칩n. Una cuenta puede ser miembro de solo una organizaci칩n a la vez. Puedes adjuntar una pol칤tica a una cuenta para aplicar controles solo a esa cuenta.
* Las cuentas de miembro **deben utilizar una direcci칩n de correo electr칩nico v치lida** y pueden tener un **nombre**, en general no podr치n gestionar la facturaci칩n (pero podr칤an tener acceso a ella).
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Unidades de Organizaci칩n**

Las cuentas pueden agruparse en **Unidades de Organizaci칩n (OU)**. De esta manera, puedes crear **pol칤ticas** para la Unidad de Organizaci칩n que se van a **aplicar a todas las cuentas hijas**. Ten en cuenta que una OU puede tener otras OUs como hijos.
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### Pol칤tica de Control de Servicios (SCP)

Una **pol칤tica de control de servicios (SCP)** es una pol칤tica que especifica los servicios y acciones que los usuarios y roles pueden utilizar en las cuentas que la SCP afecta. Las SCP son **similares a las pol칤ticas de permisos IAM** excepto que **no otorgan ning칰n permiso**. En cambio, las SCP especifican los **permisos m치ximos** para una organizaci칩n, unidad organizativa (OU) o cuenta. Cuando adjuntas una SCP a la ra칤z de tu organizaci칩n o a una OU, la **SCP limita los permisos para las entidades en las cuentas miembro**.

Esta es la 칔NICA forma en que **incluso el usuario ra칤z puede ser detenido** de hacer algo. Por ejemplo, podr칤a usarse para evitar que los usuarios deshabiliten CloudTrail o eliminen copias de seguridad.\
La 칰nica forma de evitar esto es comprometiendo tambi칠n la **cuenta maestra** que configura las SCP (la cuenta maestra no puede ser bloqueada).

{% hint style="warning" %}
Ten en cuenta que las **SCPs solo restringen a los principales en la cuenta**, por lo que otras cuentas no se ven afectadas. Esto significa que si una SCP niega `s3:GetObject`, no impedir치 que las personas **accedan a un bucket S3 p칰blico** en tu cuenta.
{% endhint %}

Ejemplos de SCP:

* Denegar por completo la cuenta ra칤z
* Solo permitir regiones espec칤ficas
* Solo permitir servicios en lista blanca
* Denegar que se deshabiliten GuardDuty, CloudTrail y el acceso p칰blico a S3
* Denegar que se eliminen o modifiquen roles de seguridad/incidencias
* Denegar que se eliminen copias de seguridad
* Denegar la creaci칩n de usuarios IAM y claves de acceso

Encuentra ejemplos en formato **JSON** en [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** es el **nombre 칰nico** que tiene cada recurso dentro de AWS, se compone de la siguiente manera:
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
Hay 4 particiones en AWS pero solo 3 formas de llamarlas:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Identidad y Gesti칩n de Acceso

IAM es el servicio que te permitir치 gestionar **Autenticaci칩n**, **Autorizaci칩n** y **Control de Acceso** dentro de tu cuenta de AWS.

* **Autenticaci칩n** - Proceso de definir una identidad y la verificaci칩n de esa identidad. Este proceso se puede subdividir en: Identificaci칩n y verificaci칩n.
* **Autorizaci칩n** - Determina a qu칠 puede acceder una identidad dentro de un sistema una vez que ha sido autenticada en 칠l.
* **Control de Acceso** - El m칠todo y proceso de c칩mo se otorga acceso a un recurso seguro.

IAM se puede definir por su capacidad para gestionar, controlar y gobernar los mecanismos de autenticaci칩n, autorizaci칩n y control de acceso de identidades a tus recursos dentro de tu cuenta de AWS.

### [Usuario ra칤z de la cuenta de AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Cuando creas por primera vez una cuenta de Amazon Web Services (AWS), comienzas con una identidad de inicio de sesi칩n 칰nica que tiene **acceso completo a todos** los servicios y recursos de AWS en la cuenta. Este es el usuario ra칤z de la cuenta de AWS y se accede iniciando sesi칩n con la **direcci칩n de correo electr칩nico y la contrase침a que utilizaste para crear la cuenta**.

Ten en cuenta que un nuevo **usuario administrador** tendr치 **menos permisos que el usuario ra칤z**.

Desde un punto de vista de seguridad, se recomienda crear otros usuarios y evitar usar este.

### [Usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _usuario_ IAM es una entidad que creas en AWS para **representar a la persona o aplicaci칩n** que lo utiliza para **interactuar con AWS**. Un usuario en AWS consta de un nombre y credenciales (contrase침a y hasta dos claves de acceso).

Cuando creas un usuario IAM, le otorgas **permisos** haci칠ndolo miembro de un **grupo de usuarios** que tiene pol칤ticas de permisos apropiadas adjuntas (recomendado), o **adjuntando directamente pol칤ticas** al usuario.

Los usuarios pueden tener **MFA habilitado para iniciar sesi칩n** a trav칠s de la consola. Los tokens de API de usuarios con MFA habilitado no est치n protegidos por MFA. Si deseas **restringir el acceso de las claves API de un usuario utilizando MFA** debes indicar en la pol칤tica que para realizar ciertas acciones se necesita MFA (ejemplo [**aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID de Clave de Acceso**: 20 caracteres alfanum칠ricos en may칰sculas aleatorios como AKHDNAPO86BSHKDIRYT
* **ID de Clave de Acceso Secreta**: 40 caracteres aleatorios en may칰sculas y min칰sculas: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (No es posible recuperar claves de acceso secretas perdidas).

Si necesitas **cambiar la Clave de Acceso** este es el proceso que debes seguir:\
_Crear una nueva clave de acceso -> Aplicar la nueva clave al sistema/aplicaci칩n -> marcar la original como inactiva -> Probar y verificar que la nueva clave de acceso funciona -> Eliminar la antigua clave de acceso_

### MFA - Autenticaci칩n Multifactor

Se utiliza para **crear un factor adicional para la autenticaci칩n** adem치s de tus m칠todos existentes, como la contrase침a, creando as칤 un nivel de autenticaci칩n multifactorial.\
Puedes usar una **aplicaci칩n virtual gratuita o un dispositivo f칤sico**. Puedes usar aplicaciones como la autenticaci칩n de Google de forma gratuita para activar un MFA en AWS.

Las pol칤ticas con condiciones de MFA se pueden adjuntar a lo siguiente:

* Un usuario o grupo IAM
* Un recurso como un bucket de Amazon S3, una cola de Amazon SQS o un tema de Amazon SNS
* La pol칤tica de confianza de un rol IAM que puede ser asumido por un usuario

Si deseas **acceder a trav칠s de CLI** a un recurso que **verifica MFA** debes llamar a **`GetSessionToken`**. Eso te dar치 un token con informaci칩n sobre MFA.\
Ten en cuenta que las credenciales de **`AssumeRole` no contienen esta informaci칩n**.
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
Como se [**indica aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), hay muchos casos diferentes donde **no se puede usar MFA**.

### [Grupos de usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un **grupo de usuarios IAM** es una forma de **adjuntar pol칤ticas a m칰ltiples usuarios** al mismo tiempo, lo que puede facilitar la gesti칩n de los permisos para esos usuarios. **Los roles y grupos no pueden formar parte de un grupo**.

Puede adjuntar una **pol칤tica basada en identidad a un grupo de usuarios** para que todos los **usuarios** en el grupo de usuarios **reciban los permisos de la pol칤tica**. **No** puede identificar un **grupo de usuarios** como un **`Principal`** en una **pol칤tica** (como una pol칤tica basada en recursos) porque los grupos se relacionan con permisos, no con autenticaci칩n, y los principales son entidades IAM autenticadas.

Aqu칤 hay algunas caracter칤sticas importantes de los grupos de usuarios:

* Un **grupo de usuarios** puede **contener muchos usuarios**, y un **usuario** puede **pertenecer a varios grupos**.
* **Los grupos de usuarios no pueden estar anidados**; solo pueden contener usuarios, no otros grupos de usuarios.
* No hay **un grupo de usuarios predeterminado que incluya autom치ticamente a todos los usuarios en la cuenta de AWS**. Si desea tener un grupo de usuarios as칤, debe crearlo y asignar a cada nuevo usuario a 칠l.
* El n칰mero y tama침o de los recursos IAM en una cuenta de AWS, como el n칰mero de grupos y el n칰mero de grupos de los que un usuario puede ser miembro, est치n limitados. Para obtener m치s informaci칩n, consulte [Cuotas de IAM y AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Roles IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **rol IAM** es muy **similar** a un **usuario**, en el sentido de que es una **identidad con pol칤ticas de permisos que determinan lo que** puede y no puede hacer en AWS. Sin embargo, un rol **no tiene credenciales** (contrase침a o claves de acceso) asociadas. En lugar de estar asociado de forma 칰nica con una persona, se pretende que un rol sea **asumible por cualquier persona que lo necesite (y tenga suficientes permisos)**. Un **usuario IAM puede asumir un rol temporalmente** para asumir diferentes permisos para una tarea espec칤fica. Un rol puede ser **asignado a un** [**usuario federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) que inicia sesi칩n utilizando un proveedor de identidades externo en lugar de IAM.

Un rol IAM consta de **dos tipos de pol칤ticas**: Una **pol칤tica de confianza**, que no puede estar vac칤a, define **qui칠n puede asumir** el rol, y una **pol칤tica de permisos**, que no puede estar vac칤a, define **a qu칠 puede acceder**.

#### Servicio de tokens de seguridad de AWS (STS)

El Servicio de tokens de seguridad de AWS (STS) es un servicio web que facilita la **emisi칩n de credenciales temporales y con privilegios limitados**. Est치 espec칤ficamente dise침ado para:

### [Credenciales temporales en IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**Las credenciales temporales se utilizan principalmente con roles IAM**, pero tambi칠n tienen otros usos. Puede solicitar credenciales temporales que tengan un conjunto de permisos m치s restringido que su usuario IAM est치ndar. Esto **evita** que realice **accidentalmente tareas no permitidas** por las credenciales m치s restringidas. Una ventaja de las credenciales temporales es que caducan autom치ticamente despu칠s de un per칤odo de tiempo establecido. Usted tiene control sobre la duraci칩n en que las credenciales son v치lidas.

### Pol칤ticas

#### Permisos de pol칤tica

Se utilizan para asignar permisos. Hay 2 tipos:

* Pol칤ticas administradas por AWS (preconfiguradas por AWS)
* Pol칤ticas administradas por el cliente: Configuradas por usted. Puede crear pol칤ticas basadas en pol칤ticas administradas por AWS (modificando una de ellas y creando la suya), utilizando el generador de pol칤ticas (una vista GUI que le ayuda a otorgar y denegar permisos) o escribiendo la suya propia.

Por **defecto, el acceso** est치 **denegado**, el acceso se conceder치 si se ha especificado un rol expl칤cito.\
Si existe un **칰nico "Denegar", anular치 el "Permitir"**, excepto para las solicitudes que utilizan las credenciales de seguridad ra칤z de la cuenta de AWS (que est치n permitidas de forma predeterminada).
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
Los [campos globales que se pueden usar para condiciones en cualquier servicio est치n documentados aqu칤](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount).\
Los [campos espec칤ficos que se pueden usar para condiciones por servicio est치n documentados aqu칤](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html).

#### Pol칤ticas en l칤nea

Este tipo de pol칤ticas se **asignan directamente** a un usuario, grupo o rol. Entonces, no aparecen en la lista de Pol칤ticas como cualquier otro que se pueda usar.\
Las pol칤ticas en l칤nea son 칰tiles si deseas **mantener una estricta relaci칩n uno a uno entre una pol칤tica y la identidad** a la que se aplica. Por ejemplo, deseas asegurarte de que los permisos en una pol칤tica no se asignen inadvertidamente a una identidad distinta a la prevista. Cuando usas una pol칤tica en l칤nea, los permisos de la pol칤tica no pueden adjuntarse inadvertidamente a la identidad incorrecta. Adem치s, cuando utilizas la Consola de administraci칩n de AWS para eliminar esa identidad, las pol칤ticas incrustadas en la identidad tambi칠n se eliminan. Esto se debe a que son parte de la entidad principal.

#### Pol칤ticas de cubo de recursos

Estas son **pol칤ticas** que se pueden definir en **recursos**. **No todos los recursos de AWS las admiten**.

Si un principal no tiene una denegaci칩n expl칤cita sobre ellas, y una pol칤tica de recursos les otorga acceso, entonces se les permite.

### L칤mites de IAM

Los l칤mites de IAM se pueden usar para **limitar los permisos a los que un usuario o rol deber칤a tener acceso**. De esta manera, incluso si se otorga un conjunto diferente de permisos al usuario mediante una **pol칤tica diferente**, la operaci칩n **fallar치** si intenta usarlos.

Un l칤mite es simplemente una pol칤tica adjunta a un usuario que **indica el nivel m치ximo de permisos que el usuario o rol puede tener**. Entonces, **incluso si el usuario tiene acceso de administrador**, si el l칤mite indica que solo puede leer los buckets de S3, ese es el m치ximo que puede hacer.

**Esto**, **SCPs** y **seguir el principio de privilegio m칤nimo** son las formas de controlar que los usuarios no tengan m치s permisos de los que necesitan.

### Pol칤ticas de sesi칩n

Una pol칤tica de sesi칩n es una **pol칤tica establecida cuando se asume un rol** de alguna manera. Esto ser치 como un **l칤mite de IAM para esa sesi칩n**: Esto significa que la pol칤tica de sesi칩n no otorga permisos, sino que los **restringe a los indicados en la pol칤tica** (siendo los m치ximos permisos los que tiene el rol).

Esto es 칰til para **medidas de seguridad**: Cuando un administrador va a asumir un rol muy privilegiado, podr칤a restringir los permisos solo a los indicados en la pol칤tica de sesi칩n en caso de que la sesi칩n se vea comprometida.
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
Tenga en cuenta que por defecto **AWS podr칤a agregar pol칤ticas de sesi칩n a las sesiones** que se van a generar debido a terceras razones. Por ejemplo, en [roles asumidos de cognito no autenticados](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) por defecto (usando autenticaci칩n mejorada), AWS generar치 **credenciales de sesi칩n con una pol칤tica de sesi칩n** que limita los servicios a los que la sesi칩n puede acceder [**a la siguiente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Por lo tanto, si en alg칰n momento se encuentra con el error "... porque ninguna pol칤tica de sesi칩n permite el...", y el rol tiene acceso para realizar la acci칩n, es porque **hay una pol칤tica de sesi칩n que lo est치 impidiendo**.

### Federaci칩n de Identidad

La federaci칩n de identidad **permite a los usuarios de proveedores de identidad externos** a AWS acceder de forma segura a los recursos de AWS sin tener que proporcionar credenciales de usuario de AWS desde una cuenta de IAM v치lida.\
Un ejemplo de un proveedor de identidad puede ser su propio **Active Directory de Microsoft** (a trav칠s de **SAML**) o servicios de **OpenID** (como **Google**). El acceso federado permitir치 entonces a los usuarios dentro de 칠l acceder a AWS.

Para configurar esta confianza, se genera un **Proveedor de Identidad de IAM (SAML u OAuth)** que **confiar치** en la **otra plataforma**. Luego, al menos un **rol de IAM se asigna (confiando) al Proveedor de Identidad**. Si un usuario de la plataforma de confianza accede a AWS, lo har치 como el rol mencionado.

Sin embargo, generalmente se querr치 asignar un **rol diferente dependiendo del grupo del usuario** en la plataforma de terceros. Entonces, varios **roles de IAM pueden confiar** en el Proveedor de Identidad de terceros y la plataforma de terceros ser치 la que permita a los usuarios asumir uno u otro rol.

<figure><img src="../../../.gitbook/assets/image (247).png" alt=""><figcaption></figcaption></figure>

### Centro de Identidad IAM

El Centro de Identidad IAM de AWS (sucesor de AWS Single Sign-On) ampl칤a las capacidades de Gesti칩n de Identidad y Acceso de AWS (IAM) para proporcionar un **lugar central** que re칰ne la **administraci칩n de usuarios y su acceso a las cuentas de AWS** y aplicaciones en la nube.

El dominio de inicio de sesi칩n ser치 algo como `<user_input>.awsapps.com`.

Para iniciar sesi칩n, hay 3 fuentes de identidad que se pueden utilizar:

* Directorio del Centro de Identidad: Usuarios regulares de AWS
* Active Directory: Admite diferentes conectores
* Proveedor de Identidad Externo: Todos los usuarios y grupos provienen de un Proveedor de Identidad externo (IdP)

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

En el caso m치s simple del directorio del Centro de Identidad, el **Centro de Identidad tendr치 una lista de usuarios y grupos** y podr치 **asignar pol칤ticas** a ellos para **cualquiera de las cuentas** de la organizaci칩n.

Para dar acceso a un usuario/grupo del Centro de Identidad a una cuenta, se crear치 un **Proveedor de Identidad SAML que conf칤e en el Centro de Identidad**, y se crear치 un **rol que conf칤e en el Proveedor de Identidad con las pol칤ticas indicadas** en la cuenta de destino.

#### AwsSSOInlinePolicy

Es posible **dar permisos a roles creados a trav칠s del Centro de Identidad IAM mediante pol칤ticas en l칤nea**. Los roles creados en las cuentas que reciben **pol칤ticas en l칤nea en el Centro de Identidad IAM de AWS** tendr치n estos permisos en una pol칤tica en l칤nea llamada **`AwsSSOInlinePolicy`**.

Por lo tanto, incluso si ve 2 roles con una pol칤tica en l칤nea llamada **`AwsSSOInlinePolicy`**, **no significa que tengan los mismos permisos**.

### Confianzas y Roles entre Cuentas Cruzadas

**Un usuario** (confiante) puede crear un Rol entre Cuentas Cruzadas con algunas pol칤ticas y luego, **permitir que otro usuario** (de confianza) **acceda a su cuenta** pero solo **teniendo el acceso indicado en las nuevas pol칤ticas de rol**. Para crear esto, simplemente cree un nuevo Rol y seleccione Rol entre Cuentas Cruzadas. Los Roles para Acceso entre Cuentas Cruzadas ofrecen dos opciones. Proporcionar acceso entre cuentas de AWS que posee y proporcionar acceso entre una cuenta que posee y una cuenta de AWS de un tercero.\
Se recomienda **especificar el usuario que se conf칤a y no poner algo gen칠rico** porque de lo contrario, otros usuarios autenticados como usuarios federados tambi칠n podr치n abusar de esta confianza.

### AWS Simple AD

No es compatible con:

* Relaciones de Confianza
* Centro de Administraci칩n de AD
* Soporte completo de API de PS
* Papel de Servicio Administrado de Grupo
* Extensiones de Esquema
* Sin acceso directo al SO o a las Instancias

#### Federaci칩n Web o Autenticaci칩n OpenID

La aplicaci칩n utiliza el AssumeRoleWithWebIdentity para crear credenciales temporales. Sin embargo, esto no otorga acceso a la consola de AWS, solo acceso a recursos dentro de AWS.

### Otras opciones de IAM

* Puede **establecer una pol칤tica de contrase침a** con opciones como longitud m칤nima y requisitos de contrase침a.
* Puede **descargar un "Informe de Credenciales"** con informaci칩n sobre las credenciales actuales (como la hora de creaci칩n del usuario, si la contrase침a est치 habilitada...). Puede generar un informe de credenciales tan a menudo como una vez cada **cuatro horas**.

La Gesti칩n de Identidad y Acceso de AWS (IAM) proporciona un **control de acceso detallado** en toda AWS. Con IAM, puede especificar **qui칠n puede acceder a qu칠 servicios y recursos**, y bajo qu칠 condiciones. Con las pol칤ticas de IAM, administra los permisos de su personal y sistemas para **garantizar permisos de privilegio m칤nimo**.

### Prefijos de ID de IAM

En [**esta p치gina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) puede encontrar los **prefijos de ID de IAM** de las claves seg칰n su naturaleza:

| ABIA | [Token portador de servicio AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial espec칤fica del contexto                                                                                                                                                                                           |
| AGPA | Grupo de usuarios                                                                                                                                                                                                            |
| AIDA | Usuario IAM                                                                                                                                                                                                              |
| AIPA | Perfil de instancia de Amazon EC2                                                                                                                                                                                           |
| AKIA | Clave de acceso                                                                                                                                                                                                            |
| ANPA | Pol칤tica administrada                                                                                                                                                                                                        |
| ANVA | Versi칩n en una pol칤tica administrada                                                                                                                                                                                           |
| APKA | Clave p칰blica                                                                                                                                                                                                            |
| AROA | Rol                                                                                                                                                                                                                  |
| ASCA | Certificado                                                                                                                                                                                                           |
| ASIA | [ID de claves de acceso temporal (AWS STS)](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html) usa este prefijo, pero es 칰nico solo en combinaci칩n con la clave de acceso secreta y el token de sesi칩n. |

### Permisos recomendados para auditar cuentas

Los siguientes privilegios otorgan varios accesos de lectura de metadatos:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Miscel치neo

### Autenticaci칩n de CLI

Para que un usuario regular se autentique en AWS a trav칠s de la CLI, necesita tener **credenciales locales**. Por defecto, puede configurarlas **manualmente** en `~/.aws/credentials` o **ejecutando** `aws configure`.\
En ese archivo puede tener m치s de un perfil, si no se especifica un **perfil** utilizando la **CLI de AWS**, se usar치 el llamado **`[default]`** en ese archivo.\
Ejemplo de archivo de credenciales con m치s de 1 perfil:
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
Si necesitas acceder a **diferentes cuentas de AWS** y tu perfil tiene acceso para **asumir un rol dentro de esas cuentas**, no necesitas llamar manualmente a STS cada vez (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) y configurar las credenciales.

Puedes usar el archivo `~/.aws/config` para [**indicar qu칠 roles asumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), y luego usar el par치metro `--profile` como de costumbre (la `asunci칩n de rol` se realizar치 de forma transparente para el usuario).\
Un ejemplo de archivo de configuraci칩n:
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
Con este archivo de configuraci칩n, puedes usar aws cli de la siguiente manera:
```
aws --profile acc2 ...
```
Si est치s buscando algo **similar** a esto pero para el **navegador**, puedes revisar la **extensi칩n** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Referencias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
