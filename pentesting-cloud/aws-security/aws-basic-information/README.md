# AWS - 基本情報

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>

## 組織階層

![](<../../../.gitbook/assets/image (54).png>)

### アカウント

AWSには、**ルートアカウント**があり、これは**組織**のすべてのアカウントの**親コンテナ**です。しかし、リソースをデプロイするためにそのアカウントを使用する必要はありません。異なるAWSインフラストラクチャを分離するために、**他のアカウントを作成**することができます。

これは、**一つのアカウントが他のアカウントのリソースにアクセスできない**（特にブリッジが作成されていない限り）ため、**セキュリティ**の観点から非常に興味深いです。この方法で、デプロイメント間に境界を作成することができます。

したがって、組織内には**2種類のアカウント**があります（ここで言うAWSアカウントはユーザーアカウントではありません）：管理アカウントとして指定された単一のアカウントと、一つ以上のメンバーアカウント。

* **管理アカウント（ルートアカウント）**は、組織を作成するために使用するアカウントです。組織の管理アカウントから、以下のことができます：

* 組織内にアカウントを作成する
* 他の既存のアカウントを組織に招待する
* 組織からアカウントを削除する
* 招待を管理する
* 組織内のエンティティ（ルーツ、OU、またはアカウント）にポリシーを適用する
* 組織内のすべてのアカウントにわたってサービス機能を提供するために、サポートされているAWSサービスとの統合を有効にする。
* このルートアカウント/組織を作成するために使用したメールとパスワードを使用して、ルートユーザーとしてログインすることが可能です。

管理アカウントは**支払いアカウントの責任**を持ち、メンバーアカウントが発生させたすべての料金を支払う責任があります。組織の管理アカウントを変更することはできません。
* **メンバーアカウント**は、組織内の残りのすべてのアカウントです。アカウントは一度に一つの組織のメンバーになることができます。アカウントにポリシーを添付して、その一つのアカウントにのみコントロールを適用することができます。
* メンバーアカウントは**有効なメールアドレスを使用する必要があり**、**名前**を持つことができますが、一般的には請求管理ができません（ただし、それにアクセスする権限が与えられることもあります）。
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **Organization Units**

アカウントは **Organization Units (OU)** にグループ化することができます。この方法では、Organization Unitの**ポリシー**を作成し、それらが**すべての子アカウントに適用される**ようにできます。OUは他のOUを子として持つことができることに注意してください。
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### サービスコントロールポリシー (SCP)

**サービスコントロールポリシー (SCP)** は、SCPが影響を与えるアカウント内のユーザーやロールが使用できるサービスとアクションを指定するポリシーです。SCPは**IAM権限ポリシーに似ていますが**、権限を**付与しません**。代わりに、SCPは組織、組織単位（OU）、またはアカウントの**最大権限**を指定します。組織のルートまたはOUにSCPをアタッチすると、**メンバーアカウント内のエンティティの権限が制限されます**。

これは、**ルートユーザーでさえ何かを止めることができる唯一の方法です**。例えば、CloudTrailの無効化やバックアップの削除を防ぐために使用できます。\
これをバイパスする唯一の方法は、SCPを設定する**マスターアカウント**も侵害することです（マスターアカウントはブロックできません）。

{% hint style="warning" %}
**SCPはアカウント内のプリンシパルのみを制限する**ことに注意してください。つまり、他のアカウントには影響しません。これは、SCPで`s3:GetObject`を拒否しても、アカウント内の**公開S3バケットへのアクセスを止めることはできない**ということを意味します。
{% endhint %}

SCPの例:

* ルートアカウントを完全に拒否
* 特定のリージョンのみを許可
* ホワイトリストに登録されたサービスのみを許可
*   GuardDuty、CloudTrail、S3 Public Block Accessの無効化を

拒否
*   セキュリティ/インシデント対応ロールの削除や

変更を拒否。
* バックアップの削除を拒否。
* IAMユーザーやアクセスキーの作成を拒否

**JSONの例**は[https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples.html)で見つけることができます。

### ARN

**Amazonリソースネーム**は、AWS内のすべてのリソースにある**ユニークな名前**で、このように構成されています：
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
AWSには4つのパーティションがありますが、呼び出し方は3つだけです：

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US公共インターネット（GovCloud）: `aws-us-gov`
* AWS Secret（米国機密）: `aws`

## IAM - Identity and Access Management

IAMは、AWSアカウント内の**認証**、**承認**、**アクセス制御**を管理するためのサービスです。

* **認証** - 身元を定義し、その身元を検証するプロセス。このプロセスは、識別と検証に細分化されます。
* **承認** - 認証されたシステム内で、身元がアクセスできるものを決定します。
* **アクセス制御** - 安全なリソースへのアクセスを許可する方法とプロセス

IAMは、AWSアカウント内のリソースへのアクセスに対する認証、承認、アクセス制御メカニズムを管理、制御、統治する能力によって定義されます。

### [AWSアカウントのルートユーザー](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html) <a href="#id_root" id="id_root"></a>

Amazon Web Services（AWS）アカウントを初めて作成すると、アカウント内のすべてのAWSサービスとリソースに**完全なアクセス権**を持つ単一のサインイン身元で始まります。これがAWSアカウントの_**ルートユーザー**_であり、アカウントを作成する際に使用した**メールアドレスとパスワード**でサインインすることでアクセスします。

新しい**管理ユーザー**は、ルートユーザーよりも**権限が少ない**ことに注意してください。

セキュリティの観点から、他のユーザーを作成し、このユーザーの使用を避けることが推奨されます。

### [IAMユーザー](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAMの_ユーザー_は、AWSで作成するエンティティで、**人またはアプリケーション**を表し、AWSと**対話するために使用**します。AWSのユーザーは、名前と認証情報（パスワードと最大2つのアクセスキー）で構成されます。

IAMユーザーを作成するとき、適切な権限ポリシーが添付された**ユーザーグループのメンバー**にすることで（推奨）、またはユーザーに**直接ポリシーを添付**することで**権限**を付与します。

ユーザーは**MFAを有効にしてコンソールにログイン**できます。MFAが有効なユーザーのAPIトークンはMFAで保護されません。ユーザーのAPIキーのアクセスをMFAを使用して**制限したい場合**、ポリシーに特定のアクションを実行するためにMFAが必要であることを示す必要があります（[**こちら**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html)の例）。

#### CLI

* **アクセスキーID**: 20文字のランダムな大文字英数字、例：AKHDNAPO86BSHKDIRYT
* **シークレットアクセスキーID**: 40文字のランダムな大文字小文字、例：S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU（失われたシークレットアクセスキーIDを取得することはできません）。

**アクセスキーを変更する**必要がある場合、次のプロセスに従うべきです：\
_新しいアクセスキーを作成 -> 新しいキーをシステム/アプリケーションに適用 -> 元のキーを非アクティブにする -> 新しいアクセスキーが動作していることをテストして確認 -> 古いアクセスキーを削除_

### MFA - Multi Factor Authentication

既存の方法、例えばパスワードに加えて、認証のための**追加要素を作成するために使用**されます。これにより、多要素認証レベルが作成されます。\
**無料の仮想アプリケーションまたは物理デバイス**を使用できます。google authenticationのようなアプリを無料で使用して、AWSにMFAをアクティブにすることができます。

MFA条件を含むポリシーは、以下に添付できます：

* IAMユーザーまたはグループ
* Amazon S3バケット、Amazon SQSキュー、またはAmazon SNSトピックなどのリソース
* ユーザーによって引き受けられるIAMロールの信頼ポリシー

**CLI経由でアクセス**したいリソースが**MFAをチェックする場合**、**`GetSessionToken`**を呼び出す必要があります。これにより、MFAに関する情報を含むトークンが提供されます。\
**`AssumeRole`**の資格情報にはこの情報が含まれていないことに注意してください。
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
以下は、[**こちらで述べられている**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_configure-api-require.html)ように、**MFAを使用できない**さまざまなケースがあります。

### [IAMユーザーグループ](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [ユーザーグループ](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html)は、一度に複数のユーザーに**ポリシーをアタッチする**方法であり、それによってユーザーの権限を管理しやすくなります。**ロールとグループはグループの一部にはなれません**。

**ユーザーグループにアイデンティティベースのポリシーをアタッチする**ことで、そのユーザーグループ内の全ての**ユーザーがポリシーの権限を受け取ります**。**ポリシー**（例えばリソースベースのポリシー）の**`Principal`**として**ユーザーグループ**を指定することは**できません**。なぜなら、グループは権限に関連しており、認証ではなく、プリンシパルは認証されたIAMエンティティだからです。

ユーザーグループのいくつかの重要な特徴は以下の通りです：

* ユーザー**グループ**は**多くのユーザーを含む**ことができ、**ユーザー**は**複数のグループに属する**ことができます。
* **ユーザーグループはネストできません**。ユーザーのみを含むことができ、他のユーザーグループを含むことはできません。
* AWSアカウント内の全てのユーザーを自動的に含む**デフォルトのユーザーグループは存在しません**。そのようなユーザーグループを持ちたい場合は、作成して新しいユーザーをそれに割り当てる必要があります。
* AWSアカウント内のIAMリソースの数とサイズ、例えばグループの数やユーザーがメンバーになれるグループの数には制限があります。詳細については、[IAMとAWS STSのクォータ](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_iam-quotas.html)を参照してください。

### [IAMロール](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **ロール**は、AWSで何ができて何ができないかを決定する権限ポリシーを持つ**アイデンティティ**である点で**ユーザー**に非常に**似ています**。しかし、ロールにはそれに関連する資格情報（パスワードやアクセスキー）が**ありません**。ロールは一人の人物に固有に関連付けられるのではなく、必要な人（十分な権限を持つ人）によって**仮想的に引き受けられる**ことを意図しています。**IAMユーザーはロールを仮想的に引き受けて**、特定のタスクのために異なる権限を一時的に取得することができます。ロールは、IAMではなく外部のアイデンティティプロバイダーを使用してサインインする[**フェデレーテッドユーザー**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html)に**割り当てることができます**。

IAMロールは**2種類のポリシー**で構成されています：ロールを**引き受けることができる人**を定義する**信頼ポリシー**（空にはできません）と、ロールが**アクセスできるもの**を定義する**権限ポリシー**（空にはできません）。

#### AWSセキュリティトークンサービス（STS）

これは、AWS Identity and Access Management（IAM）ユーザーや認証するユーザー（フェデレーテッドユーザー）のために、**一時的で権限が限定された資格情報を要求する**ことを可能にするウェブサービスです。

### [IAMでの一時的な資格情報](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**一時的な資格情報は主にIAMロールと共に使用されます**が、他にも使用法があります。標準のIAMユーザーよりも制限された権限セットを持つ一時的な資格情報を要求することができます。これにより、より制限された資格情報で**許可されていないタスクを誤って実行することを防ぐ**ことができます。一時的な資格情報の利点は、設定された期間の後に自動的に期限切れになることです。資格情報が有効である期間をコントロールすることができます。

### ポリシー

#### ポリシー権限

権限を割り当てるために使用されます。2種類あります：

* AWSが事前に設定した管理ポリシー
* 顧客管理ポリシー：あなたが設定します。AWS管理ポリシーを基にして（そのうちの1つを変更して自分のものを作成）、ポリシージェネレーターを使用して（権限の付与と拒否を支援するGUIビュー）、または独自に書いて作成することができます。

**デフォルトのアクセス**は**拒否されています**。明示的なロールが指定されている場合にのみアクセスが許可されます。\
**単一の「拒否」が存在する場合、それは「許可」を上書きします**。ただし、AWSアカウントのルートセキュリティ資格情報を使用するリクエスト（デフォルトで許可されている）を除きます。
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
以下は、AWSのセキュリティに関する基本情報についてのペンテストクラウドのドキュメントからの抜粋です。

#### インラインポリシー

この種のポリシーは、ユーザー、グループ、またはロールに**直接割り当てられます**。したがって、他の誰かが使用できるポリシーとしてポリシー一覧には表示されません。\
インラインポリシーは、ポリシーとそれが適用されるアイデンティティとの間に**厳格な一対一の関係を維持したい場合**に役立ちます。たとえば、ポリシー内の権限が意図したアイデンティティ以外に誤って割り当てられないようにしたい場合です。インラインポリシーを使用すると、ポリシー内の権限が誤って間違ったアイデンティティに添付されることはありません。さらに、AWS管理コンソールを使用してそのアイデンティティを削除すると、アイデンティティに埋め込まれたポリシーも削除されます。それは、それらが主体エンティティの一部だからです。

#### リソースバケットポリシー

これらは、**リソース**で定義できる**ポリシー**です。**AWSのすべてのリソースがそれらをサポートしているわけではありません**。

プリンシパルに明示的な拒否がなく、リソースポリシーがアクセスを許可している場合、アクセスが許可されます。

### IAM境界

IAM境界は、ユーザーやロールがアクセスすべき権限を**制限するために使用できます**。この方法では、**異なるポリシー**によってユーザーに別の権限セットが付与されていても、それらを使用しようとすると操作が**失敗**します。

境界とは、ユーザーに添付されたポリシーで、ユーザーやロールが持つことができる権限の**最大レベルを示します**。したがって、ユーザーが管理者アクセス権を持っていても、境界がS3バケットの読み取りのみを許可している場合、それができる最大のことです。

**これ**、**SCP**、および**最小権限**の原則に従うことは、ユーザーが必要以上の権限を持たないように制御する方法です。

### セッションポリシー

セッションポリシーは、何らかの方法でロールが想定されたときに設定される**ポリシー**です。これはそのセッションに対する**IAM境界のようなもの**です：つまり、セッションポリシーは権限を付与するのではなく、ポリシーに示された権限に**制限します**（ロールが持つ権限が最大の権限です）。

これは**セキュリティ対策**に役立ちます：管理者が非常に特権的なロールを想定する際に、セッションが侵害された場合に備えて、セッションポリシーに示された権限のみに権限を制限することができます。
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
デフォルトでは、**AWSは第三者の理由で生成されるセッションにセッションポリシーを追加する可能性があります**。例えば、[認証されていないcognitoの想定されたロール](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles)では、デフォルトで（強化された認証を使用して）、AWSは**セッションポリシーを持つセッション資格情報**を生成し、そのセッションがアクセスできるサービスを[**以下のリストに限定します**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)。

したがって、"…セッションポリシーが…を許可していないため"というエラーに直面した場合、ロールがアクションを実行するアクセス権を持っていても、**セッションポリシーがそれを防いでいる**のです。

### Identity Federation

Identity federationは、**AWSの外部にあるIDプロバイダーのユーザー**が、有効なIAMユーザーアカウントのAWSユーザー資格情報を提供することなく、安全にAWSリソースにアクセスできるようにします。\
IDプロバイダーの例には、独自の**Microsoft Active Directory**（**SAML**経由）や**OpenID**サービス（**Google**など）があります。Federated accessにより、それに属するユーザーがAWSにアクセスできます。

この信頼を設定するために、**IAM Identity Provider（SAMLまたはOAuth）が生成され**、**他のプラットフォームを信頼します**。次に、少なくとも1つの**IAMロールがIdentity Providerに割り当てられ（信頼しています）**。信頼されたプラットフォームのユーザーがAWSにアクセスする場合、彼は言及されたロールとしてアクセスします。

しかし、通常は、第三者プラットフォームのユーザーグループに応じて**異なるロールを与えたい**でしょう。その後、複数の**IAMロールが**第三者Identity Providerを信頼し、第三者プラットフォームがユーザーに一方または他方のロールを想定させることができます。

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### IAM Identity Center

AWS IAM Identity Center（AWS Single Sign-Onの後継）は、AWS Identity and Access Management（IAM）の機能を拡張し、**AWSアカウントとクラウドアプリケーションへのユーザーとそのアクセスの管理を一元化する中心的な場所**を提供します。

ログインドメインは `<user_input>.awsapps.com` のようになります。

ユーザーをログインさせるために、3つのIDソースを使用できます：

* Identity Center Directory：通常のAWSユーザー
* Active Directory：異なるコネクタをサポート
* 外部Identity Provider：すべてのユーザーとグループが外部Identity Provider（IdP）から来ます

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

Identity Center directoryの最も単純なケースでは、**Identity Centerにはユーザーとグループのリストがあり**、組織の**いずれかのアカウントにポリシーを割り当てる**ことができます。

Identity Centerのユーザー/グループにアカウントへのアクセスを与えるためには、**Identity Centerを信頼するSAML Identity Providerが作成され**、目的のアカウントに**指定されたポリシーを持つIdentity Providerを信頼するロールが作成されます**。

#### AwsSSOInlinePolicy

**IAM Identity Centerを介して作成されたロールにインラインポリシーを介して権限を与える**ことが可能です。AWS Identity Centerで**インラインポリシーを持つアカウントに作成されたロール**は、**`AwsSSOInlinePolicy`** と呼ばれるインラインポリシーにこれらの権限を持ちます。

したがって、**`AwsSSOInlinePolicy`** というインラインポリシーを持つ2つのロールがあっても、**同じ権限を持っているとは限りません**。

### Cross Account Trusts and Roles

**ユーザー**（信頼している）は、いくつかのポリシーを持つCross Account Roleを作成し、**別のユーザー**（信頼されている）に**自分のアカウントにアクセスすることを許可する**ことができますが、新しいロールポリシーで示されたアクセスのみを持っています。これを作成するには、新しいロールを作成し、Cross Account Roleを選択します。Cross-Account Accessのロールには2つのオプションがあります。所有するAWSアカウント間でのアクセスを提供すること、および所有するアカウントと第三者のAWSアカウント間でのアクセスを提供すること。\
**信頼されているユーザーを指定し、何か一般的なものを置かないことをお勧めします**。そうでないと、連合ユーザーなどの他の認証されたユーザーもこの信頼を悪用することができます。

### AWS Simple AD

サポートされていない：

* 信頼関係
* AD管理センター
* 完全なPS APIサポート
* ADリサイクルビン
* グループ管理サービスアカウント
* スキーマ拡張
* OSまたはインスタンスへの直接アクセスなし

#### Web FederationまたはOpenID認証

アプリはAssumeRoleWithWebIdentityを使用して一時的な資格情報を作成します。しかし、これはAWSコンソールへのアクセスを許可するものではなく、AWS内のリソースへのアクセスのみを許可します。

### その他のIAMオプション

* 最小の長さやパスワード要件などのオプションを含む**パスワードポリシー設定を設定**できます。
* 現在の資格情報に関する情報（ユーザー作成時間、パスワードが有効かどうかなど）を含む**"Credential Report"をダウンロード**できます。**4時間**ごとにクレデンシャルレポートを生成できます。

AWS Identity and Access Management（IAM）は、AWS全体で**細かいアクセス制御**を提供します。IAMを使用すると、**誰がどのサービスとリソースにアクセスできるか**、およびどの条件下でアクセスできるかを指定できます。IAMポリシーを使用して、**最小限の権限の原則を確保するために**、労働力とシステムへのアクセスを管理します。

### IAM ID Prefixes

[**このページ**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids)では、キーの性質に応じて**IAM IDプレフィックス**を見つけることができます：

| ABIA | [AWS STSサービスベアラートークン](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | コンテキスト固有の資格情報                                                                                                                                                                                           |
| AGPA | ユーザーグループ                                                                                                                                                                                                            |
| AIDA | IAMユーザー                                                                                                                                                                                                              |
| AIPA | Amazon EC2インスタンスプロファイル                                                                                                                                                                                           |
| AKIA | アクセスキー                                                                                                                                                                                                            |
| ANPA | 管理ポリシー                                                                                                                                                                                                        |
| ANVA | 管理ポリシーのバージョン                                                                                                                                                                                           |
| APKA | 公開キー                                                                                                                                                                                                            |
| AROA | ロール                                                                                                                                                                                                                  |
| ASCA | 証明書                                                                                                                                                                                                           |
| ASIA | [一時的な（AWS STS）アクセスキーID](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html)はこのプレフィックスを使用しますが、シークレットアクセスキーとセッショントークンと組み合わせてのみユニークです。 |

### アカウント監査に推奨される権限

以下の特権は、メタデータのさまざまな読み取りアクセスを付与します：

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Misc

### CLI認証

通常のユーザーがCLI経由でAWSに認証するためには、**ローカル資格情報**が必要です。デフォルトでは、`~/.aws/credentials`に**手動で**設定するか、`aws configure`を**実行する**ことができます。\
そのファイルには複数のプロファイルを持つことができ、**aws cli**を使用して**プロファイルが指定されていない場合**、そのファイルの**`[default]`**と呼ばれるものが使用されます。\
1つ以上のプロファイルを持つ資格情報ファイルの例：
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
以下は、AWSアカウントへのアクセスに関する情報です。プロファイルが**異なるAWSアカウント**内で役割を想定するアクセス権を与えられている場合、毎回手動でSTSを呼び出す必要はありません（`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`）し、資格情報を設定する必要もありません。

`~/.aws/config` ファイルを使用して[**どの役割を想定するかを指示する**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html)ことができ、通常どおり `--profile` パラメータを使用することができます（`assume-role` はユーザーにとって透明な方法で実行されます）。\
設定ファイルの例：
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
この設定ファイルを使用して、次のようにaws cliを使用できます：
```
aws --profile acc2 ...
```
```markdown
この**ブラウザ**版に**似たもの**を探している場合は、**拡張機能** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en)を確認してください。

## 参考文献

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
```
