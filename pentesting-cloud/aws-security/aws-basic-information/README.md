# AWS - Informaci칩n B치sica

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Jerarqu칤a de la organizaci칩n

![](<../../../.gitbook/assets/image (54).png>)

### Cuentas

En AWS hay una **cuenta ra칤z**, que es el **contenedor principal para todas las cuentas** de tu **organizaci칩n**. Sin embargo, no es necesario utilizar esa cuenta para implementar recursos, puedes crear **otras cuentas para separar diferentes infraestructuras de AWS** entre ellas.

Esto es muy interesante desde un punto de vista de **seguridad**, ya que **una cuenta no podr치 acceder a los recursos de otra cuenta** (excepto si se crean puentes espec칤ficamente), de esta manera puedes crear l칤mites entre las implementaciones.

Por lo tanto, hay **dos tipos de cuentas en una organizaci칩n** (estamos hablando de cuentas de AWS y no de cuentas de usuario): una sola cuenta que se designa como cuenta de administraci칩n y una o m치s cuentas de miembro.

*   La **cuenta de administraci칩n (la cuenta ra칤z)** es la cuenta que se utiliza para crear la organizaci칩n. Desde la cuenta de administraci칩n de la organizaci칩n, puedes hacer lo siguiente:

    * Crear cuentas en la organizaci칩n
    * Invitar a otras cuentas existentes a la organizaci칩n
    * Eliminar cuentas de la organizaci칩n
    * Gestionar invitaciones
    * Aplicar pol칤ticas a entidades (ra칤ces, OUs o cuentas) dentro de la organizaci칩n
    * Habilitar la integraci칩n con servicios de AWS admitidos para proporcionar funcionalidad de servicio en todas las cuentas de la organizaci칩n.
    * Es posible iniciar sesi칩n como usuario ra칤z utilizando el correo electr칩nico y la contrase침a utilizados para crear esta cuenta ra칤z/organizaci칩n.

    La cuenta de administraci칩n tiene las **responsabilidades de una cuenta pagadora** y es responsable de pagar todos los cargos que se acumulan en las cuentas de miembro. No se puede cambiar la cuenta de administraci칩n de una organizaci칩n.
* Las **cuentas de miembro** conforman todas las dem치s cuentas en una organizaci칩n. Una cuenta puede ser miembro de solo una organizaci칩n a la vez. Puedes adjuntar una pol칤tica a una cuenta para aplicar controles solo a esa cuenta.
  * Las cuentas de miembro **deben usar una direcci칩n de correo electr칩nico v치lida** y pueden tener un **nombre**, en general no podr치n administrar la facturaci칩n (pero se les puede dar acceso a ella).

```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```

### **Unidades de organizaci칩n**

Las cuentas se pueden agrupar en **Unidades de Organizaci칩n (OU)**. De esta manera, puedes crear **pol칤ticas** para la Unidad de Organizaci칩n que se van a **aplicar a todas las cuentas hijas**. Ten en cuenta que una OU puede tener otras OUs como hijos.

```bash
# Puedes obtener el id ra칤z de aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```

### Pol칤tica de control de servicios (SCP)

Una **pol칤tica de control de servicios (SCP)** es una pol칤tica que especifica los servicios y acciones que los usuarios y roles pueden usar en las cuentas que afecta la SCP. Las SCP son **similares a las pol칤ticas de permisos de IAM** excepto que no otorgan ning칰n permiso. En su lugar, las SCP especifican los **permisos m치ximos** para una organizaci칩n, unidad organizativa (OU) o cuenta. Cuando adjuntas una SCP a la ra칤z de tu organizaci칩n o a una OU, la **SCP limita los permisos para las entidades en las cuentas de miembro**.

Esta es la 칔NICA forma en que **incluso el usuario ra칤z puede ser detenido** de hacer algo. Por ejemplo, se podr칤a usar para evitar que los usuarios desactiven CloudTrail o eliminen copias de seguridad.\
La 칰nica forma de evitar esto es comprometiendo tambi칠n la **cuenta principal** que configura las SCP (la cuenta principal no se puede bloquear).

{% hint style="warning" %}
Ten en cuenta que **las SCP solo restringen los principios en la cuenta**, por lo que otras cuentas no se ven afectadas. Esto significa que tener una SCP que niegue `s3:GetObject` no evitar치 que las personas accedan a un **bucket S3 p칰blico** en tu cuenta.
{% endhint %}

Ejemplos de SCP:

* Denegar completamente la cuenta ra칤z
* Solo permitir regiones espec칤ficas
* Solo permitir servicios en lista blanca
* Denegar que se desactiven GuardDuty, CloudTrail y el acceso p칰blico a S3
* Denegar que se eliminen roles de seguridad/incidentes
* Denegar que se eliminen copias de seguridad.
* Denegar la creaci칩n de usuarios IAM y claves de acceso

Encuentra **ejemplos JSON** en [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)

### ARN

**Amazon Resource Name** es el **nombre 칰nico** que tiene cada recurso dentro de AWS, se compone as칤:

```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```

Ten en cuenta que hay 4 particiones en AWS pero solo 3 formas de llamarlas:

* AWS Standard: `aws`
* AWS China: `aws-cn`
* AWS US public Internet (GovCloud): `aws-us-gov`
* AWS Secret (US Classified): `aws`

## IAM - Gesti칩n de identidades y accesos

IAM es el servicio que te permitir치 gestionar la **autenticaci칩n**, **autorizaci칩n** y **control de acceso** dentro de tu cuenta de AWS.

* **Autenticaci칩n** - Proceso de definici칩n de una identidad y la verificaci칩n de esa identidad. Este proceso se puede subdividir en: Identificaci칩n y verificaci칩n.
* **Autorizaci칩n** - Determina a qu칠 puede acceder una identidad dentro de un sistema una vez que se ha autenticado en 칠l.
* **Control de acceso** - El m칠todo y proceso de c칩mo se concede el acceso a un recurso seguro

IAM se puede definir por su capacidad para gestionar, controlar y gobernar los mecanismos de autenticaci칩n, autorizaci칩n y control de acceso de las identidades a tus recursos dentro de tu cuenta de AWS.

### [Usuario ra칤z de la cuenta de AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

Cuando creas una cuenta de Amazon Web Services (AWS) por primera vez, comienzas con una identidad de inicio de sesi칩n 칰nica que tiene **acceso completo a todos** los servicios y recursos de AWS en la cuenta. Este es el usuario ra칤z de la cuenta de AWS y se accede iniciando sesi칩n con la **direcci칩n de correo electr칩nico y la contrase침a que utilizaste para crear la cuenta**.

Ten en cuenta que un nuevo **usuario administrador** tendr치 **menos permisos que el usuario ra칤z**.

Desde un punto de vista de seguridad, se recomienda crear otros usuarios y evitar usar este.
### [Usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

Un _usuario_ IAM es una entidad que se crea en AWS para **representar a la persona o aplicaci칩n** que lo utiliza para **interactuar con AWS**. Un usuario en AWS consta de un nombre y credenciales (contrase침a y hasta dos claves de acceso).

Cuando se crea un usuario IAM, se le otorgan **permisos** al hacerlo miembro de un **grupo de usuarios** que tiene pol칤ticas de permisos apropiadas adjuntas (recomendado), o por **adjuntar directamente pol칤ticas** al usuario.

Los usuarios pueden tener **MFA habilitado para iniciar sesi칩n** a trav칠s de la consola. Los tokens de API de los usuarios habilitados para MFA no est치n protegidos por MFA. Si desea **restringir el acceso de las claves API de un usuario usando MFA**, debe indicar en la pol칤tica que para realizar ciertas acciones se necesita MFA (ejemplo [**aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)).

#### CLI

* **ID de clave de acceso**: 20 caracteres alfanum칠ricos en may칰sculas aleatorios como AKHDNAPO86BSHKDIRYT
* **ID de clave de acceso secreta**: 40 caracteres aleatorios en may칰sculas y min칰sculas: S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU (No es posible recuperar las ID de clave de acceso secreta perdidas).

Cada vez que necesite **cambiar la clave de acceso**, este es el proceso que debe seguir:\
_Crear una nueva clave de acceso -> Aplicar la nueva clave al sistema/aplicaci칩n -> Marcar la original como inactiva -> Probar y verificar que la nueva clave de acceso funciona -> Eliminar la antigua clave de acceso_

### MFA - Autenticaci칩n de m칰ltiples factores

Se utiliza para **crear un factor adicional para la autenticaci칩n** adem치s de sus m칠todos existentes, como la contrase침a, creando as칤 un nivel de autenticaci칩n de m칰ltiples factores.\
Puede utilizar una **aplicaci칩n virtual gratuita o un dispositivo f칤sico**. Puede utilizar aplicaciones como la autenticaci칩n de Google de forma gratuita para activar un MFA en AWS.

Las pol칤ticas con condiciones MFA se pueden adjuntar a lo siguiente:

* Un usuario o grupo IAM
* Un recurso como un cubo de Amazon S3, una cola de Amazon SQS o un tema de Amazon SNS
* La pol칤tica de confianza de una funci칩n IAM que puede ser asumida por un usuario

Si desea **acceder a trav칠s de CLI** a un recurso que **verifica MFA**, debe llamar a **`GetSessionToken`**. Eso le dar치 un token con informaci칩n sobre MFA.\
Tenga en cuenta que las **credenciales de `AssumeRole` no contienen esta informaci칩n**.

```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```

Como se [**indica aqu칤**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html), hay muchos casos diferentes en los que **no se puede usar MFA**.

### [Grupos de usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

Un [grupo de usuarios IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) es una forma de **adjuntar pol칤ticas a varios usuarios** al mismo tiempo, lo que puede facilitar la gesti칩n de los permisos para esos usuarios. **Los roles y grupos no pueden formar parte de un grupo**.

Puede adjuntar una **pol칤tica basada en identidad a un grupo de usuarios** para que todos los **usuarios** del grupo de usuarios **reciban los permisos de la pol칤tica**. **No puede** identificar un **grupo de usuarios** como un **`Principal`** en una **pol칤tica** (como una pol칤tica basada en recursos) porque los grupos se relacionan con permisos, no con autenticaci칩n, y los principales son entidades IAM autenticadas.

Aqu칤 hay algunas caracter칤sticas importantes de los grupos de usuarios:

* Un **grupo de usuarios** puede **contener muchos usuarios**, y un **usuario** puede **pertenecer a varios grupos**.
* **Los grupos de usuarios no pueden estar anidados**; solo pueden contener usuarios, no otros grupos de usuarios.
* No hay **un grupo de usuarios predeterminado que incluya autom치ticamente a todos los usuarios en la cuenta de AWS**. Si desea tener un grupo de usuarios as칤, debe crearlo y asignar a cada nuevo usuario a 칠l.
* El n칰mero y tama침o de los recursos IAM en una cuenta de AWS, como el n칰mero de grupos y el n칰mero de grupos de los que un usuario puede ser miembro, est치n limitados. Para obtener m치s informaci칩n, consulte [Cuotas de IAM y AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html).

### [Roles IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

Un **rol IAM** es muy **similar** a un **usuario**, en el sentido de que es una **identidad con pol칤ticas de permisos que determinan lo que** puede y no puede hacer en AWS. Sin embargo, un rol **no tiene ninguna credencial** (contrase침a o claves de acceso) asociada. En lugar de estar asociado de manera 칰nica con una persona, se pretende que un rol sea **asumible por cualquier persona que lo necesite (y tenga suficientes permisos)**. Un **usuario IAM puede asumir un rol temporalmente** para asumir diferentes permisos para una tarea espec칤fica. Un rol se puede **asignar a un** [**usuario federado**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html) que inicia sesi칩n mediante el uso de un proveedor de identidad externo en lugar de IAM.

Un rol IAM consta de **dos tipos de pol칤ticas**: una **pol칤tica de confianza**, que no puede estar vac칤a, que define **qui칠n puede asumir** el rol, y una **pol칤tica de permisos**, que no puede estar vac칤a, que define **a qu칠 puede acceder**.

#### Servicio de tokens de seguridad de AWS (STS)

Este es un servicio web que le permite **solicitar credenciales temporales y de privilegio limitado** para usuarios de AWS Identity and Access Management (IAM) o para usuarios que autentique (usuarios federados).

### [Credenciales temporales en IAM](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

Las **credenciales temporales se utilizan principalmente con roles IAM**, pero tambi칠n hay otros usos. Puede solicitar credenciales temporales que tengan un conjunto de permisos m치s restringido que su usuario IAM est치ndar. Esto **evita** que **realice accidentalmente tareas que no est치n permitidas** por las credenciales m치s restringidas. Una ventaja de las credenciales temporales es que expiran autom치ticamente despu칠s de un per칤odo de tiempo determinado. Tiene control sobre la duraci칩n durante la cual las credenciales son v치lidas.

### Pol칤ticas

#### Permisos de pol칤tica

Se utilizan para asignar permisos. Hay 2 tipos:

* Pol칤ticas administradas por AWS (preconfiguradas por AWS)
* Pol칤ticas administradas por el cliente: configuradas por usted. Puede crear pol칤ticas basadas en pol칤ticas administradas por AWS (modificando una de ellas y creando la suya), utilizando el generador de pol칤ticas (una vista GUI que le ayuda a otorgar y denegar permisos) o escribiendo la suya.

Por **defecto, el acceso** est치 **denegado**, se otorgar치 acceso si se ha especificado un rol expl칤cito.\
Si **existe un solo "Deny", anular치 el "Allow"**, excepto para las solicitudes que utilizan las credenciales de seguridad ra칤z de la cuenta de AWS (que est치n permitidas de forma predeterminada).

```javascript
{
    "Version": "2012-10-17",  //Versi칩n de la pol칤tica
    "Statement": [  //Elemento principal, puede haber m치s de 1 entrada en esta matriz
        {
            "Sid": "Stmt32894y234276923" //Identificador 칰nico (opcional)
            "Effect": "Allow", //Permitir o denegar
            "Action": [  //Acciones que se permitir치n o denegar치n
                "ec2:AttachVolume",
                "ec2:DetachVolume"
            ], 
            "Resource": [ //Recurso al que se aplicar치 la acci칩n y el efecto
                "arn:aws:ec2:*:*:volume/*",
                "arn:aws:ec2:*:*:instance/*"
            ],
            "Condition": { //Elemento opcional que permite controlar cu치ndo ser치 efectivo el permiso
                "ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
            }
        }
    ]
}
```
#### Pol칤ticas en l칤nea

Este tipo de pol칤ticas se asignan **directamente** a un usuario, grupo o rol. Entonces, no aparecen en la lista de Pol칤ticas como cualquier otra que se pueda usar.\
Las pol칤ticas en l칤nea son 칰tiles si desea **mantener una estricta relaci칩n uno a uno entre una pol칤tica y la identidad** a la que se aplica. Por ejemplo, desea asegurarse de que los permisos en una pol칤tica no se asignen inadvertidamente a una identidad que no sea la prevista. Cuando usa una pol칤tica en l칤nea, los permisos en la pol칤tica no se pueden adjuntar inadvertidamente a la identidad equivocada. Adem치s, cuando usa la Consola de administraci칩n de AWS para eliminar esa identidad, las pol칤ticas incrustadas en la identidad tambi칠n se eliminan. Eso se debe a que son parte de la entidad principal.

#### Pol칤ticas de cubo de recursos

Estas son **pol칤ticas** que se pueden definir en **recursos**. **No todos los recursos de AWS las admiten**.

Si un principal no tiene una denegaci칩n expl칤cita en ellas y una pol칤tica de recursos les otorga acceso, entonces se les permite.

### L칤mites de IAM

Los l칤mites de IAM se pueden usar para **limitar los permisos a los que un usuario o rol deber칤a tener acceso**. De esta manera, incluso si se otorga un conjunto diferente de permisos al usuario por una **pol칤tica diferente**, la operaci칩n **fallar치** si intenta usarlos.

Un l칤mite es solo una pol칤tica adjunta a un usuario que **indica el nivel m치ximo de permisos que el usuario o rol puede tener**. Entonces, **incluso si el usuario tiene acceso de administrador**, si el l칤mite indica que solo puede leer los buckets S3, eso es lo m치ximo que puede hacer.

**Esto**, **SCP** y **seguir el principio de privilegio m칤nimo** son las formas de controlar que los usuarios no tengan m치s permisos de los que necesitan.

### Pol칤ticas de sesi칩n

Una pol칤tica de sesi칩n es una **pol칤tica establecida cuando se asume un rol** de alguna manera. Esto ser치 como un **l칤mite de IAM para esa sesi칩n**: esto significa que la pol칤tica de sesi칩n no otorga permisos, sino que los **restringe a los indicados en la pol칤tica** (siendo los permisos m치ximos los que tiene el rol).

Esto es 칰til para **medidas de seguridad**: cuando un administrador va a asumir un rol muy privilegiado, podr칤a restringir el permiso solo a los indicados en la pol칤tica de sesi칩n en caso de que la sesi칩n se vea comprometida.

```bash
aws sts assume-role \
    --role-arn <value> \
    --role-session-name <value> \
    [--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
    [--policy <file://policy.json>]
```

Tenga en cuenta que por defecto **AWS puede agregar pol칤ticas de sesi칩n a las sesiones** que se van a generar debido a terceros. Por ejemplo, en [roles asumidos de cognito no autenticados](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles) de forma predeterminada (usando autenticaci칩n mejorada), AWS generar치 **credenciales de sesi칩n con una pol칤tica de sesi칩n** que limita los servicios a los que puede acceder la sesi칩n [**a la siguiente lista**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services).

Por lo tanto, si en alg칰n momento se enfrenta al error "... porque ninguna pol칤tica de sesi칩n permite el...", y el rol tiene acceso para realizar la acci칩n, es porque **hay una pol칤tica de sesi칩n que lo impide**.

### Federaci칩n de identidad

La federaci칩n de identidad **permite que los usuarios de proveedores de identidad externos** a AWS accedan a los recursos de AWS de manera segura sin tener que proporcionar las credenciales de usuario de AWS desde una cuenta de usuario IAM v치lida.\
Un ejemplo de un proveedor de identidad puede ser su propio **Microsoft Active Directory** (a trav칠s de **SAML**) o servicios **OpenID** (como **Google**). El acceso federado permitir치 entonces que los usuarios dentro de 칠l accedan a AWS.

Para configurar esta confianza, se genera un **Proveedor de identidad IAM (SAML u OAuth)** que **confiar치** en la **otra plataforma**. Luego, se asigna al menos un **rol IAM (de confianza) al Proveedor de identidad**. Si un usuario de la plataforma de confianza accede a AWS, estar치 accediendo como el rol mencionado.

Sin embargo, generalmente querr치 dar un **rol diferente seg칰n el grupo del usuario** en la plataforma de terceros. Luego, varios **roles IAM pueden confiar** en el Proveedor de identidad de terceros y la plataforma de terceros ser치 la que permita a los usuarios asumir uno u otro rol.

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### Centro de identidad IAM

El Centro de identidad IAM de AWS (sucesor de AWS Single Sign-On) ampl칤a las capacidades de Identity and Access Management (IAM) de AWS para proporcionar un **lugar central** que re칰ne la **administraci칩n de usuarios y su acceso a las cuentas de AWS** y aplicaciones en la nube.

El dominio de inicio de sesi칩n ser치 algo como `<user_input>.awsapps.com`.

Para iniciar sesi칩n en los usuarios, hay 3 fuentes de identidad que se pueden usar:

* Directorio del Centro de identidad: usuarios regulares de AWS
* Active Directory: admite diferentes conectores
* Proveedor de identidad externo: todos los usuarios y grupos provienen de un proveedor de identidad externo (IdP)

<figure><img src="../../../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

En el caso m치s simple del directorio del Centro de identidad, el **Centro de identidad tendr치 una lista de usuarios y grupos** y podr치 **asignar pol칤ticas** a ellos para **cualquiera de las cuentas** de la organizaci칩n.

Para dar acceso a un usuario/grupo del Centro de identidad a una cuenta, se crear치 un **Proveedor de identidad SAML que conf칤a en el Centro de identidad**, y se crear치 un **rol que conf칤a en el Proveedor de identidad con las pol칤ticas indicadas** en la cuenta de destino.

#### AwsSSOInlinePolicy

Es posible **dar permisos a trav칠s de pol칤ticas en l칤nea a roles creados a trav칠s del Centro de identidad IAM**. Los roles creados en las cuentas que reciben **pol칤ticas en l칤nea en el Centro de identidad de AWS** tendr치n estos permisos en una pol칤tica en l칤nea llamada **`AwsSSOInlinePolicy`**.

Por lo tanto, incluso si ve 2 roles con una pol칤tica en l칤nea llamada **`AwsSSOInlinePolicy`**, no significa que tengan los mismos permisos.

### Confianzas y roles entre cuentas cruzadas

**Un usuario** (de confianza) puede crear un Rol entre cuentas cruzadas con algunas pol칤ticas y luego, **permitir que otro usuario** (de confianza) **acceda a su cuenta** pero solo **teniendo acceso a lo indicado en las pol칤ticas del nuevo rol**. Para crear esto, simplemente cree un nuevo Rol y seleccione Rol entre cuentas cruzadas. Los roles para acceso entre cuentas cruzadas ofrecen dos opciones. Proporcionar acceso entre cuentas de AWS que posee y proporcionar acceso entre una cuenta que posee y una cuenta de AWS de terceros.\
Se recomienda **especificar el usuario de confianza y no poner algo gen칠rico** porque si no, otros usuarios autenticados como usuarios federados tambi칠n podr치n abusar de esta confianza.
### AWS Simple AD

No soportado:

* Relaciones de confianza
* Centro de administraci칩n de AD
* Soporte completo de PS API
* Papelera de reciclaje de AD
* Cuentas de servicio administradas por grupo
* Extensiones de esquema
* Sin acceso directo al sistema operativo o a las instancias

#### Federaci칩n web o autenticaci칩n OpenID

La aplicaci칩n utiliza AssumeRoleWithWebIdentity para crear credenciales temporales. Sin embargo, esto no otorga acceso a la consola de AWS, solo acceso a los recursos dentro de AWS.

### Otras opciones de IAM

* Puede **establecer una pol칤tica de contrase침as** opciones como longitud m칤nima y requisitos de contrase침a.
* Puede **descargar un "Informe de credenciales"** con informaci칩n sobre las credenciales actuales (como la hora de creaci칩n del usuario, si se habilit칩 la contrase침a ...). Puede generar un informe de credenciales tan a menudo como una vez cada **cuatro horas**.

AWS Identity and Access Management (IAM) proporciona **control de acceso fino** en toda AWS. Con IAM, puede especificar **qui칠n puede acceder a qu칠 servicios y recursos**, y en qu칠 condiciones. Con las pol칤ticas de IAM, administra los permisos de su fuerza laboral y sistemas para **asegurar permisos de privilegio m칤nimo**.

### Prefijos de ID de IAM

En [**esta p치gina**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids) puede encontrar los **prefijos de ID de IAM** de las claves seg칰n su naturaleza:

| ABIA | [Token de portador de servicio AWS STS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)                                                                                                         |
| ---- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | Credencial espec칤fica del contexto                                                                                                                                                                                           |
| AGPA | Grupo de usuarios                                                                                                                                                                                                            |
| AIDA | Usuario IAM                                                                                                                                                                                                              |
| AIPA | Perfil de instancia de Amazon EC2                                                                                                                                                                                           |
| AKIA | Clave de acceso                                                                                                                                                                                                            |
| ANPA | Pol칤tica administrada                                                                                                                                                                                                        |
| ANVA | Versi칩n en una pol칤tica administrada                                                                                                                                                                                           |
| APKA | Clave p칰blica                                                                                                                                                                                                            |
| AROA | Rol                                                                                                                                                                                                                  |
| ASCA | Certificado                                                                                                                                                                                                           |
| ASIA | Las ID de clave de acceso temporales (AWS STS) usan este prefijo, pero son 칰nicas solo en combinaci칩n con la clave de acceso secreta y el token de sesi칩n. |

### Permisos recomendados para auditar cuentas

Los siguientes privilegios otorgan varios accesos de lectura de metadatos:

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`

## Miscel치neo

### Autenticaci칩n de CLI

Para que un usuario regular se autentique en AWS a trav칠s de CLI, necesita tener **credenciales locales**. De forma predeterminada, puede configurarlos **manualmente** en `~/.aws/credentials` o **ejecutando** `aws configure`.\
En ese archivo puede tener m치s de un perfil, si no se especifica **ning칰n perfil** usando el **cli de aws**, se usar치 el que se llama **`[default]`** en ese archivo.\
Ejemplo de archivo de credenciales con m치s de 1 perfil:

```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```

Si necesita acceder a **diferentes cuentas de AWS** y se le dio acceso a su perfil para **asumir un rol dentro de esas cuentas**, no necesita llamar manualmente a STS cada vez (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) y configurar las credenciales.

Puede usar el archivo `~/.aws/config` para [**indicar qu칠 roles asumir**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html), y luego usar el par치metro `--profile` como de costumbre (el `assume-role` se realizar치 de manera transparente para el usuario).\
Un ejemplo de archivo de configuraci칩n:

```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```

Con este archivo de configuraci칩n, puede usar aws cli como:

```
aws --profile acc2 ...
```

Si est치 buscando algo **similar** a esto pero para el **navegador**, puede verificar la **extensi칩n** [**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en).

## Referencias

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si desea ver su **empresa anunciada en HackTricks** o si desea acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulte los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>