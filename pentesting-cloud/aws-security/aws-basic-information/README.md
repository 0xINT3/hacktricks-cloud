# AWS - 基本信息

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## 组织层级结构

![](<../../../.gitbook/assets/image (54).png>)

### 账户

在 AWS 中，有一个**根账户**，它是您**组织中所有账户的父容器**。但是，您不需要使用该账户来部署资源，您可以创建**其他账户来将不同的 AWS 基础设施分隔开**。

从**安全**的角度来看，这非常有趣，因为**一个账户无法访问其他账户的资源**（除非专门创建了桥接），因此您可以在部署之间创建边界。

因此，组织中有**两种类型的账户**（我们讨论的是 AWS 账户，而不是用户账户）：一个被指定为管理账户的单个账户，以及一个或多个成员账户。

*   **管理账户（根账户）** 是您用来创建组织的账户。从组织的管理账户中，您可以执行以下操作：

* 在组织中创建账户
* 邀请其他现有账户加入组织
* 从组织中删除账户
* 管理邀请
* 对组织内的实体（根、OU 或账户）应用策略
* 启用与支持的 AWS 服务的集成，以在组织中的所有账户上提供服务功能。
* 可以使用用于创建此根账户/组织的电子邮件和密码作为根用户登录。

管理账户具有**付款账户的责任**，负责支付所有成员账户产生的费用。您无法更改组织的管理账户。
* **成员账户**组成组织中的所有其他账户。一个账户一次只能是一个组织的成员。您可以将策略附加到一个账户，仅对该账户应用控制。
* 成员账户**必须使用有效的电子邮件地址**，可以有一个**名称**，通常它们无法管理计费（但可能会被授予访问权限）。
```
aws organizations create-account --account-name testingaccount --email testingaccount@lalala1233fr.com
```
### **组织单位**

账户可以分组为**组织单位（OU）**。通过这种方式，您可以为组织单位创建**策略**，这些策略将被**应用于所有子账户**。请注意，一个OU可以有其他OU作为子账户。
```bash
# You can get the root id from aws organizations list-roots
aws organizations create-organizational-unit --parent-id r-lalala --name TestOU
```
### 服务控制策略（SCP）

**服务控制策略（SCP）**是指定用户和角色可以在SCP影响的账户中使用的服务和操作的策略。SCP与IAM权限策略类似，但SCP不授予任何权限。相反，SCP指定了组织、组织单位（OU）或账户的最大权限。当您将SCP附加到组织根或OU时，SCP会限制成员账户中实体的权限。

这是**即使是根用户也可以被阻止**做某些事情的唯一方法。例如，它可以用于阻止用户禁用CloudTrail或删除备份。\
绕过这个限制的唯一方法是同时入侵配置SCP的**主账户**（主账户无法被阻止）。

{% hint style="warning" %}
请注意，**SCP仅限制账户中的主体**，因此其他账户不受影响。这意味着拒绝SCP中的`s3:GetObject`不会阻止人们访问您账户中的**公共S3存储桶**。
{% endhint %}

SCP示例：

* 完全拒绝根账户
* 仅允许特定区域
* 仅允许白名单服务
*   拒绝禁用GuardDuty、CloudTrail和S3公共块访问
*   拒绝删除或修改安全/事件响应角色
* 拒绝删除备份
* 拒绝创建IAM用户和访问密钥

在[https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_manage\_policies\_scps\_examples.html)中找到**JSON示例**。


### ARN

**Amazon资源名称（ARN）**是AWS内每个资源的唯一名称，它由以下部分组成：
```
arn:partition:service:region:account-id:resource-type/resource-id
arn:aws:elasticbeanstalk:us-west-1:123456789098:environment/App/Env
```
注意，AWS有4个分区，但只有3种调用方式：

* AWS标准：`aws`
* AWS中国：`aws-cn`
* AWS美国公共互联网（GovCloud）：`aws-us-gov`
* AWS秘密（美国机密）：`aws`

## IAM - 身份和访问管理

IAM是一种服务，允许您在AWS账户内管理**身份验证**、**授权**和**访问控制**。

* **身份验证** - 定义身份并验证该身份的过程。此过程可以细分为：识别和验证。
* **授权** - 确定身份在系统内经过身份验证后可以访问的内容。
* **访问控制** - 授予对安全资源的访问的方法和过程。

IAM可以通过管理、控制和管理身份对您的AWS账户内资源的身份验证、授权和访问控制机制来定义。

### [AWS账户根用户](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_root-user.html) <a href="#id_root" id="id_root"></a>

当您首次创建Amazon Web Services（AWS）账户时，您将拥有一个单一的登录身份，该身份对账户中的所有AWS服务和资源具有**完全访问权限**。这是AWS账户的_**根用户**_，通过使用**创建账户时使用的电子邮件地址和密码**进行登录。

请注意，新的**管理员用户**将具有**比根用户更少的权限**。

从安全角度来看，建议创建其他用户并避免使用此用户。

### [IAM用户](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_users.html) <a href="#id_iam-users" id="id_iam-users"></a>

IAM _用户_是您在AWS中创建的实体，用于**代表使用它与AWS进行交互的人员或应用程序**。AWS中的用户由名称和凭据（密码和最多两个访问密钥）组成。

创建IAM用户时，您可以通过将其设置为附加适当的权限策略的**用户组成员**（推荐）或通过**直接附加策略**到用户来授予权限。

用户可以启用**多因素身份验证（MFA）**以通过控制台登录。启用MFA的用户的API令牌不受MFA保护。如果您想要使用MFA**限制用户API密钥的访问**，您需要在策略中指示，为了执行某些操作，需要MFA（示例[**在此处**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)）。

#### CLI

* **访问密钥ID**：20个随机的大写字母数字字符，例如AKHDNAPO86BSHKDIRYT
* **秘密访问密钥ID**：40个随机的大小写字母字符，例如S836fh/J73yHSb64Ag3Rkdi/jaD6sPl6/antFtU（无法找回丢失的秘密访问密钥ID）。

每当您需要**更改访问密钥**时，应按照以下过程进行：\
_创建新的访问密钥 -> 将新密钥应用于系统/应用程序 -> 将原始密钥标记为不活动 -> 测试和验证新的访问密钥是否正常工作 -> 删除旧的访问密钥_

### MFA - 多因素身份验证

它用于在现有方法（如密码）之外**创建额外的身份验证因素**，从而创建多因素身份验证级别。\
您可以使用**免费的虚拟应用程序或物理设备**。您可以使用类似谷歌身份验证的应用程序免费激活AWS中的MFA。

具有MFA条件的策略可以附加到以下内容：

* IAM用户或组
* 资源，如Amazon S3存储桶、Amazon SQS队列或Amazon SNS主题
* 可由用户承担的IAM角色的信任策略

如果您想要通过CLI**访问检查MFA的资源**，您需要调用**`GetSessionToken`**。这将为您提供一个包含有关MFA信息的令牌。\
请注意，**`AssumeRole`凭证不包含此信息**。
```bash
aws sts get-session-token --serial-number <arn_device> --token-code <code>
```
如[**在此处**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_mfa\_configure-api-require.html)所述，有许多不适用**MFA**的情况。

### [IAM用户组](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) <a href="#id_iam-groups" id="id_iam-groups"></a>

IAM [用户组](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_groups.html) 是一种将策略附加到多个用户的方式，这样可以更容易地管理这些用户的权限。**角色和组不能是组的一部分**。

您可以将**基于身份的策略附加到用户组**，以便用户组中的所有**用户都获得策略的权限**。您**不能**将**用户组**标识为**策略**（例如资源策略）中的**`Principal`**，因为组与权限相关，而不是身份验证，而主体是经过身份验证的IAM实体。

以下是用户组的一些重要特点：

* 一个用户**组**可以**包含多个用户**，而一个**用户**可以**属于多个组**。
* **用户组不能嵌套**；它们只能包含用户，而不能包含其他用户组。
* 没有默认的用户组自动包含AWS账户中的所有用户。如果您想要这样的用户组，必须创建它并将每个新用户分配给它。
* AWS账户中IAM资源的数量和大小，例如组的数量以及用户可以成为成员的组的数量，是有限制的。有关更多信息，请参阅[IAM和AWS STS配额](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_iam-quotas.html)。

### [IAM角色](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html) <a href="#id_iam-roles" id="id_iam-roles"></a>

IAM **角色**与**用户**非常相似，因为它是一个具有权限策略的身份，确定了它在AWS中可以做什么和不能做什么。然而，角色**没有与之关联的任何凭证**（密码或访问密钥）。角色不是唯一与某个人关联的，而是**可以由任何需要它（并具有足够权限）的人承担**。IAM用户可以扮演角色以临时获得不同的权限来执行特定任务。角色可以分配给通过使用外部身份提供者而不是IAM进行登录的[**联合用户**](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles\_providers.html)。

IAM角色由**两种类型的策略**组成：**信任策略**（不能是空的），定义了**谁可以扮演**该角色，以及**权限策略**（不能是空的），定义了**它可以访问什么**。

#### AWS安全令牌服务（STS）

这是一个Web服务，使您能够为AWS身份和访问管理（IAM）用户或您进行身份验证的用户（联合用户）**请求临时的有限特权凭证**。

### [IAM中的临时凭证](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_temp.html) <a href="#id_temp-creds" id="id_temp-creds"></a>

**临时凭证主要与IAM角色一起使用**，但也有其他用途。您可以请求具有比标准IAM用户更受限的权限集的临时凭证。这样可以**防止**您**意外执行不允许的任务**。临时凭证的好处是它们在一定时间后会自动过期。您可以控制凭证的有效期。

### 策略

#### 策略权限

用于分配权限。有两种类型：

* AWS托管策略（由AWS预配置）
* 客户管理的策略：由您配置。您可以基于AWS托管策略创建策略（修改其中一个并创建自己的策略），使用策略生成器（一个GUI视图，帮助您授予和拒绝权限）或编写自己的策略。

默认情况下，访问是被**拒绝**的，只有在指定了显式角色的情况下才会被授予访问权限。\
如果存在**单个"拒绝"，它将覆盖"允许"**，但对于使用AWS账户的根安全凭证的请求（默认情况下允许）。
```javascript
{
"Version": "2012-10-17",  //Version of the policy
"Statement": [  //Main element, there can be more than 1 entry in this array
{
"Sid": "Stmt32894y234276923" //Unique identifier (optional)
"Effect": "Allow", //Allow or deny
"Action": [  //Actions that will be allowed or denied
"ec2:AttachVolume",
"ec2:DetachVolume"
],
"Resource": [ //Resource the action and effect will be applied to
"arn:aws:ec2:*:*:volume/*",
"arn:aws:ec2:*:*:instance/*"
],
"Condition": { //Optional element that allow to control when the permission will be effective
"ArnEquals": {"ec2:SourceInstanceARN": "arn:aws:ec2:*:*:instance/instance-id"}
}
}
]
}
```
[全局字段可用于任何服务的条件在此处记录](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_policies\_condition-keys.html#condition-keys-resourceaccount)。\
[每个服务可用于条件的特定字段在此处记录](https://docs.aws.amazon.com/service-authorization/latest/reference/reference\_policies\_actions-resources-contextkeys.html)。

#### 内联策略

这种策略是直接分配给用户、组或角色的。因此，它们不会出现在策略列表中，任何其他人都可以使用它们。\
内联策略在以下情况下非常有用：如果您想要在策略和应用策略的身份之间保持严格的一对一关系。例如，您希望确保策略中的权限不会意外地分配给除预期身份之外的身份。当您使用内联策略时，策略中的权限不会意外地附加到错误的身份上。此外，当您使用AWS管理控制台删除该身份时，嵌入在身份中的策略也将被删除。这是因为它们是主体实体的一部分。

#### 资源存储桶策略

这些是可以在资源中定义的策略。并非AWS的所有资源都支持它们。

如果主体没有明确拒绝它们的权限，并且资源策略授予它们访问权限，则它们将被允许。

### IAM边界

IAM边界可用于限制用户或角色应具有的权限。这样，即使通过不同的策略向用户授予了不同的权限集，如果尝试使用这些权限，操作将失败。

边界只是附加到用户的策略，指示用户或角色可以具有的最高级别权限。因此，即使用户具有管理员访问权限，如果边界指示他只能读取S3存储桶，那就是他能做的最大权限。

这种方法，SCP和遵循最小权限原则是控制用户不具有比所需权限更多的权限的方式。

### 会话策略

会话策略是在某种情况下扮演角色时设置的策略。这将类似于该会话的IAM边界：这意味着会话策略不授予权限，而是将其限制为策略中指定的权限（最大权限为角色拥有的权限）。

这对于安全措施非常有用：当管理员要扮演一个非常特权的角色时，他可以将权限限制为仅限于会话策略中指定的权限，以防会话被入侵。
```bash
aws sts assume-role \
--role-arn <value> \
--role-session-name <value> \
[--policy-arns <arn_custom_policy1> <arn_custom_policy2>]
[--policy <file://policy.json>]
```
请注意，默认情况下，**AWS可能会为将要生成的会话添加会话策略**，因为有第三方原因。例如，在[未经身份验证的Cognito假定角色](../aws-services/aws-cognito-enum/cognito-identity-pools.md#accessing-iam-roles)中，默认情况下（使用增强身份验证），AWS将生成具有会话策略的会话凭证，该策略限制会话可以访问的服务[**如下列表所示**](https://docs.aws.amazon.com/cognito/latest/developerguide/iam-roles.html#access-policies-scope-down-services)。

因此，如果您在某个时候遇到错误"...因为没有会话策略允许..."，并且该角色具有执行该操作的访问权限，那么这是因为**存在阻止该操作的会话策略**。

### 身份联合

身份联合允许来自外部身份提供者的用户在不必提供有效IAM用户帐户的AWS用户凭证的情况下安全地访问AWS资源。\
身份提供者的示例可以是您自己的企业**Microsoft Active Directory**（通过**SAML**）或**OpenID**服务（如**Google**）。联合访问将允许其中的用户访问AWS。

为了配置这种信任，将生成一个**IAM身份提供者（SAML或OAuth）**，该提供者将**信任**另一个平台。然后，至少分配一个**IAM角色（信任）给身份提供者**。如果来自受信任平台的用户访问AWS，他将作为所提到的角色进行访问。

然而，通常情况下，您希望根据第三方平台中的用户组给出**不同的角色**。然后，多个**IAM角色可以信任**第三方身份提供者，第三方平台将允许用户扮演其中一个角色。

<figure><img src="../../../.gitbook/assets/image (1) (2).png" alt=""><figcaption></figcaption></figure>

### IAM身份中心

AWS IAM身份中心（AWS Single Sign-On的继任者）扩展了AWS身份和访问管理（IAM）的功能，提供了一个**集中的地方**，汇集了**用户的管理和他们对AWS帐户和云应用程序的访问**。

登录域将类似于`<user_input>.awsapps.com`。

要登录用户，有3个可以使用的身份来源：

* 身份中心目录：常规AWS用户
* Active Directory：支持不同的连接器
* 外部身份提供者：所有用户和组都来自外部身份提供者（IdP）

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

在最简单的身份中心目录的情况下，**身份中心将有一个用户和组的列表**，并且将能够将策略分配给组织的**任何帐户**。

为了给身份中心用户/组访问帐户，将创建一个**信任身份中心的SAML身份提供者**，并在目标帐户中创建一个**信任身份提供者的角色**，该角色具有指定的策略。

#### AwsSSOInlinePolicy

可以通过在AWS身份中心中为创建的角色**提供内联策略来授予权限**。在为给定**内联策略的帐户中创建的角色**中，这些权限将在名为**`AwsSSOInlinePolicy`**的内联策略中。

因此，即使您看到两个具有名为**`AwsSSOInlinePolicy`**的内联策略的角色，也**不意味着它们具有相同的权限**。

### 跨帐户信任和角色

**一个用户**（信任者）可以创建具有一些策略的跨帐户角色，然后，**允许另一个用户**（受信任者）**访问他的帐户**，但只能**具有新角色策略中指定的访问权限**。要创建此角色，只需创建一个新角色并选择跨帐户角色。跨帐户访问的角色提供了两个选项。提供您拥有的AWS帐户之间的访问权限，以及提供您拥有的帐户与第三方AWS帐户之间的访问权限。\
建议**指定受信任的用户**，而不是放置一些通用的内容，因为如果不这样做，其他经过身份验证的用户（如联合用户）也将能够滥用此信任。

### AWS Simple AD

不支持的功能：

* 信任关系
* AD管理中心
* 完整的PS API支持
* AD回收站
* 群组托管服务帐户
* 模式扩展
* 无法直接访问操作系统或实例

#### Web联合或OpenID身份验证

该应用程序使用AssumeRoleWithWebIdentity创建临时凭证。但是，这不会授予对AWS控制台的访问权限，只能访问AWS内的资源。

### 其他IAM选项

* 您可以**设置密码策略设置**，例如最小长度和密码要求。
* 您可以使用“凭证报告”**下载有关当前凭证的信息**（例如用户创建时间，是否启用密码等）。您可以每隔**四个小时**生成一次凭证报告。

AWS身份和访问管理（IAM）在AWS的所有领域提供了**细粒度的访问控制**。通过IAM，您可以指定**谁可以访问哪些服务和资源**，以及在哪些条件下。通过IAM策略，您可以管理对您的工作人员和系统的权限，以**确保最小特权权限**。

### IAM ID前缀

在[**此页面**](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference\_identifiers.html#identifiers-unique-ids)中，您可以找到根据其性质的密钥的**IAM ID前缀**：

| ABIA | [AWS STS服务承载令牌](https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_credentials\_bearer.html)的上下文特定凭证 |
| ---- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| ACCA | 上下文特定凭证                                                                                                                                                                                           |
| AGPA | 用户组                                                                                                                                                                                                            |
| AIDA | IAM用户                                                                                                                                                                                                              |
| AIPA | Amazon EC2实例配置文件                                                                                                                                                                                           |
| AKIA | 访问密钥                                                                                                                                                                                                            |
| ANPA | 托管策略                                                                                                                                                                                                        |
| ANVA | 托管策略中的版本                                                                                                                                                                                           |
| APKA | 公钥                                                                                                                                                                                                            |
| AROA | 角色                                                                                                                                                                                                                  |
| ASCA | 证书                                                                                                                                                                                                           |
| ASIA | [临时（AWS STS）访问密钥ID](https://docs.aws.amazon.com/STS/latest/APIReference/API\_Credentials.html)使用此前缀，但仅在与秘密访问密钥和会话令牌结合使用时才是唯一的。 |

### 建议审核帐户的权限

以下权限授予各种元数据的读取访问：

* `arn:aws:iam::aws:policy/SecurityAudit`
* `arn:aws:iam::aws:policy/job-function/ViewOnlyAccess`
* `codebuild:ListProjects`
* `config:Describe*`
* `cloudformation:ListStacks`
* `logs:DescribeMetricFilters`
* `directconnect:DescribeConnections`
* `dynamodb:ListTables`
## 其他

### CLI身份验证

为了让普通用户通过CLI进行AWS身份验证，您需要拥有**本地凭据**。默认情况下，您可以在`~/.aws/credentials`中手动配置它们，或者通过运行`aws configure`来配置。\
在该文件中，您可以拥有多个配置文件，如果在使用**aws cli**时未指定配置文件，则将使用该文件中名为**`[default]`**的配置文件。\
以下是一个包含多个配置文件的凭据文件示例：
```
[default]
aws_access_key_id = AKIA5ZDCUJHF83HDTYUT
aws_secret_access_key = uOcdhof683fbOUGFYEQug8fUGIf68greoihef

[Admin]
aws_access_key_id = AKIA8YDCu7TGTR356SHYT
aws_secret_access_key = uOcdhof683fbOUGFYEQuR2EIHG34UY987g6ff7
region = eu-west-2
```
如果您需要访问**不同的AWS账户**，并且您的配置文件被授予在这些账户中**扮演角色的权限**，您无需每次手动调用STS (`aws sts assume-role --role-arn <role-arn> --role-session-name sessname`) 并配置凭证。

您可以使用 `~/.aws/config` 文件来[**指定要扮演的角色**](https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-role.html)，然后像往常一样使用 `--profile` 参数（`assume-role` 将对用户透明地执行）。
配置文件示例：
```
[profile acc2]
region=eu-west-2
role_arn=arn:aws:iam::<account-id>:role/<role-path>
role_session_name = <session_name>
source_profile = <profile_with_assume_role>
sts_regional_endpoints = regional
```
使用此配置文件，您可以像这样使用 AWS CLI：
```
aws --profile acc2 ...
```
如果你正在寻找类似于这个的**浏览器**扩展，你可以查看[**AWS Extend Switch Roles**](https://chrome.google.com/webstore/detail/aws-extend-switch-roles/jpmkfafbacpgapdghgdpembnojdlgkdl?hl=en)。

## 参考资料

* [https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html](https://docs.aws.amazon.com/organizations/latest/userguide/orgs\_getting-started\_concepts.html)
* [https://aws.amazon.com/iam/](https://aws.amazon.com/iam/)
* [https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html](https://docs.aws.amazon.com/singlesignon/latest/userguide/what-is.html)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果你想看到你的**公司在 HackTricks 中被宣传**，或者如果你想访问**PEASS 的最新版本或下载 PDF 格式的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享你的黑客技巧。**

</details>
