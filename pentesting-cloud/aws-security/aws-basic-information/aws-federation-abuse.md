# AWS - Abuso di Federazione

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## SAML

Per informazioni su SAML, consulta:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

Per configurare una **Federazione di Identit√† tramite SAML**, √® sufficiente fornire un **nome** e il **metadata XML** contenente tutte le configurazioni SAML (**endpoints**, **certificato** con chiave pubblica)

## OIDC - Abuso di Github Actions

Per aggiungere una github action come provider di identit√†:

1. Per il _Tipo di provider_, selezionare **OpenID Connect**.
2. Per l'_URL del provider_, inserire `https://token.actions.githubusercontent.com`
3. Fare clic su _Ottieni thumbprint_ per ottenere l'hash del provider
4. Per l'_Audience_, inserire `sts.amazonaws.com`
5. Creare un **nuovo ruolo** con i **permessi** necessari per la github action e una **politica di trust** che si fida del provider come segue:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. Nota nella politica precedente come solo un **branch** di un **repository** di un'**organizzazione** sia stato autorizzato con un **trigger** specifico.
7. L'**ARN** del **ruolo** che la github action sar√† in grado di **impersonare** sar√† il "segreto" che la github action deve conoscere, quindi **memorizzarlo** all'interno di un **segreto** all'interno di un **ambiente**.
8. Infine, utilizzare una github action per configurare le credenziali AWS da utilizzare nel workflow.
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## Abuso di OIDC - EKS

L'OpenID Connect (OIDC) √® un protocollo di autenticazione e autorizzazione basato su OAuth 2.0 che viene spesso utilizzato per consentire l'accesso federato alle risorse in ambienti cloud come Amazon Elastic Kubernetes Service (EKS). Tuttavia, √® possibile sfruttare l'implementazione di OIDC in EKS per ottenere accesso non autorizzato alle risorse.

### Scenari di abuso di OIDC in EKS

#### 1. Utilizzo di token scaduti

Se un token OIDC viene compromesso o scade, potrebbe essere possibile utilizzarlo per ottenere accesso non autorizzato alle risorse di EKS. Questo pu√≤ essere fatto utilizzando il token scaduto per autenticarsi e ottenere un nuovo token valido.

#### 2. Utilizzo di token rubati

Se un token OIDC viene rubato, un attaccante potrebbe utilizzarlo per ottenere accesso non autorizzato alle risorse di EKS. L'attaccante pu√≤ impersonare l'utente legittimo e utilizzare il token rubato per autenticarsi e ottenere accesso alle risorse.

#### 3. Utilizzo di token non revocati

Se un token OIDC viene revocato, ma il server di autorizzazione non lo riconosce come revocato, potrebbe essere possibile utilizzarlo per ottenere accesso non autorizzato alle risorse di EKS. Questo pu√≤ accadere se il server di autorizzazione non √® correttamente configurato per gestire la revoca dei token.

### Contromisure

Per mitigare il rischio di abuso di OIDC in EKS, √® consigliabile adottare le seguenti contromisure:

- Implementare un meccanismo di gestione dei token robusto che includa la revoca dei token scaduti o compromessi.
- Monitorare attentamente l'attivit√† degli utenti e rilevare eventuali anomalie o accessi non autorizzati.
- Configurare correttamente il server di autorizzazione per gestire correttamente la revoca dei token.
- Utilizzare autenticazione a pi√π fattori per aumentare la sicurezza dell'accesso alle risorse di EKS.

### Conclusioni

L'abuso di OIDC in EKS pu√≤ consentire agli attaccanti di ottenere accesso non autorizzato alle risorse. √à importante implementare le contromisure appropriate per mitigare questo rischio e proteggere le risorse di EKS.
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
√à possibile generare **provider OIDC** in un cluster **EKS** semplicemente impostando l'**URL OIDC** del cluster come un **nuovo provider di identit√† Open ID**. Questa √® una politica comune predefinita:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Questa politica indica correttamente che solo il cluster EKS con ID `20C159CDF6F2349B68846BEC03BE031B` pu√≤ assumere il ruolo. Tuttavia, non indica quale account di servizio pu√≤ assumerlo, il che significa che QUALSIASI account di servizio con un token di identit√† web sar√† in grado di assumere il ruolo.

Per specificare quale account di servizio dovrebbe essere in grado di assumere il ruolo, √® necessario specificare una condizione in cui viene specificato il nome dell'account di servizio, ad esempio:&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## Riferimenti

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
