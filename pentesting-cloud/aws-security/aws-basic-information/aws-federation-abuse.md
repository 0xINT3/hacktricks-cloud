# AWS - フェデレーションの悪用

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし **HackTricks で会社を宣伝したい**場合や、**PEASS の最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは、私たちの独占的な [**NFT**](https://opensea.io/collection/the-peass-family) のコレクションです
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、私を **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) で **フォロー**してください。
* 自分のハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出してください。

</details>

## SAML

SAML に関する情報は以下を参照してください：

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAML を介したアイデンティティフェデレーション**を設定するには、**名前**と、すべての SAML 構成（**エンドポイント**、**公開鍵を含む証明書**）を含む **メタデータ XML** を提供するだけです。

## OIDC - Github Actions の悪用

Identity プロバイダとして github action を追加するには、以下の手順を実行します：

1. _Provider type_ で **OpenID Connect** を選択します。
2. _Provider URL_ に `https://token.actions.githubusercontent.com` を入力します。
3. _Get thumbprint_ をクリックして、プロバイダのサムプリントを取得します。
4. _Audience_ に `sts.amazonaws.com` を入力します。
5. github action が必要とする **権限** と、プロバイダを信頼する **信頼ポリシー** を持つ **新しいロール** を作成します。例えば：
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. 前述のポリシーでは、特定の **トリガー** で **組織** の **リポジトリ** の **ブランチ** のみが承認されていることに注意してください。
7. github action が **なりすまし** を行うことができる **ロール** の **ARN** は、github action が知る必要がある "秘密" です。したがって、それを **環境** の **シークレット** 内に **保存**してください。
8. 最後に、AWS のクレデンシャルをワークフローで使用するために、github action を使用します：
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKSの悪用

In this section, we will explore how to abuse the OpenID Connect (OIDC) authentication mechanism in Amazon Elastic Kubernetes Service (EKS). OIDC is a widely used standard for user authentication and authorization in cloud environments.

このセクションでは、Amazon Elastic Kubernetes Service (EKS) での OpenID Connect (OIDC) 認証メカニズムの悪用方法について説明します。OIDCは、クラウド環境でのユーザー認証と認可に広く使用されている標準です。

### Overview

概要

EKS allows you to configure OIDC to enable authentication and authorization for your Kubernetes cluster. When OIDC is enabled, EKS acts as an identity provider (IdP) and generates JSON Web Tokens (JWTs) for authenticated users. These tokens can be used to access various AWS resources.

EKSでは、OIDCを設定してKubernetesクラスターの認証と認可を有効にすることができます。OIDCが有効になると、EKSはアイデンティティプロバイダ（IdP）として機能し、認証されたユーザーに対してJSON Webトークン（JWT）を生成します。これらのトークンは、さまざまなAWSリソースにアクセスするために使用できます。

### Abuse Scenarios

悪用シナリオ

1. **Token Leakage**: If an attacker gains access to a user's JWT, they can abuse it to perform unauthorized actions on the EKS cluster or access other AWS resources. This can happen if the JWT is leaked through insecure channels or stored in an insecure manner.

1. **トークンの漏洩**: 攻撃者がユーザーのJWTにアクセスできる場合、それを悪用してEKSクラスターでの不正な操作を実行したり、他のAWSリソースにアクセスしたりすることができます。これは、JWTが安全でないチャネルを介して漏洩したり、安全でない方法で保存されたりする場合に発生する可能性があります。

2. **Token Manipulation**: An attacker can tamper with the JWT to modify its claims and gain elevated privileges. For example, they can change the user's group membership or add additional roles to the token.

2. **トークンの改ざん**: 攻撃者はJWTを改ざんしてそのクレームを変更し、特権を取得することができます。たとえば、ユーザーのグループメンバーシップを変更したり、トークンに追加の役割を追加したりすることができます。

3. **Token Replay**: If an attacker intercepts a valid JWT, they can replay it to gain unauthorized access to the EKS cluster or other AWS resources. This can happen if the JWT is transmitted over insecure channels without proper encryption or integrity checks.

3. **トークンの再利用**: 攻撃者が有効なJWTを傍受すると、それを再生してEKSクラスターや他のAWSリソースに不正アクセスすることができます。これは、JWTが適切な暗号化や整合性チェックなしに安全でないチャネルを介して送信される場合に発生する可能性があります。

### Mitigation

緩和策

To mitigate the abuse of OIDC in EKS, consider the following measures:

EKSでのOIDCの悪用を緩和するために、以下の対策を検討してください。

1. **Secure Token Handling**: Ensure that JWTs are transmitted and stored securely. Use secure channels for transmission and encrypt the tokens at rest. Implement proper access controls and permissions to prevent unauthorized access to the tokens.

1. **トークンの安全な取り扱い**: JWTが安全に送信および保存されることを確認してください。送信には安全なチャネルを使用し、トークンを静止状態で暗号化します。トークンへの不正アクセスを防ぐために適切なアクセス制御と権限を実装してください。

2. **Token Expiration**: Set appropriate expiration times for JWTs to limit their validity period. This reduces the window of opportunity for attackers to abuse stolen or intercepted tokens.

2. **トークンの有効期限**: JWTの有効期間を適切に設定して、その有効期間を制限してください。これにより、攻撃者が盗まれたり傍受されたりしたトークンを悪用する機会が減ります。

3. **Token Revocation**: Implement a mechanism to revoke JWTs in case of compromise or suspected abuse. This can be done by maintaining a blacklist of revoked tokens and validating the token's status during authentication.

3. **トークンの無効化**: トークンが危険にさらされた場合や悪用が疑われる場合には、トークンを無効化する仕組みを実装してください。これは、無効化されたトークンのブラックリストを維持し、認証時にトークンのステータスを検証することで行うことができます。

By implementing these measures, you can enhance the security of your EKS cluster and protect against OIDC abuse.

これらの対策を実装することで、EKSクラスターのセキュリティを向上させ、OIDCの悪用に対して保護することができます。
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
**OIDCプロバイダ**は、**EKS**クラスタの**OIDC URL**を**新しいOpen ID Identityプロバイダ**として設定することで簡単に生成することができます。これは一般的なデフォルトポリシーです。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
このポリシーは、**id**が`20C159CDF6F2349B68846BEC03BE031B`である**EKSクラスター**のみがロールを引き受けることができることを正しく示しています。ただし、どのサービスアカウントがそれを引き受けることができるかは示されていません。つまり、**Web Identity Tokenを持つ任意のサービスアカウント**がロールを引き受けることができます。

**どのサービスアカウントがロールを引き受けることができるかを指定するには、**サービスアカウント名が指定されている**条件**を指定する必要があります。例えば、次のように指定します：&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## 参考文献

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **ハックトリックで会社を宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしてください🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
