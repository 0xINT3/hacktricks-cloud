# AWS - 联合滥用

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

## SAML

有关 SAML 的信息，请查看：

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

要通过 SAML 配置**身份联合**，您只需要提供一个**名称**和包含所有 SAML 配置（**端点**、**带有公钥的证书**）的**元数据 XML**。

## OIDC - Github Actions 滥用

要将 github action 添加为身份提供者，请执行以下操作：

1. 对于 _Provider type_，选择 **OpenID Connect**。
2. 对于 _Provider URL_，输入 `https://token.actions.githubusercontent.com`。
3. 单击 _Get thumbprint_ 以获取提供者的 thumbprint。
4. 对于 _Audience_，输入 `sts.amazonaws.com`。
5. 创建一个具有 github action 需要的**权限**和**信任策略**的**新角色**，该策略信任提供者，例如：
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. 请注意，在上述策略中，只有来自组织的存储库的**分支**被授权使用特定的**触发器**。
7. github action 将能够**冒充**的**角色**的**ARN**将成为 github action 需要知道的"秘密"，因此将其存储在环境的**秘密**中。
8. 最后，使用 github action 配置要由工作流程使用的 AWS 凭据：
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS 滥用

In this section, we will discuss how to abuse the OpenID Connect (OIDC) authentication mechanism in Amazon Elastic Kubernetes Service (EKS) to gain unauthorized access to resources.

### Introduction

Amazon EKS allows users to authenticate to their Kubernetes clusters using OIDC. This authentication mechanism relies on the integration between EKS and AWS Identity and Access Management (IAM). When a user authenticates using OIDC, EKS verifies the user's identity with IAM and grants the necessary permissions to access the cluster.

### OIDC Federation Abuse

An attacker can abuse the OIDC federation feature in EKS to gain unauthorized access to the cluster. This can be done by creating a malicious OIDC provider and associating it with the EKS cluster. The attacker can then create a role mapping that grants excessive permissions to the malicious provider.

To abuse OIDC federation in EKS, the attacker needs to perform the following steps:

1. Create a malicious OIDC provider using the AWS CLI or SDKs.
2. Associate the malicious provider with the EKS cluster using the `eksctl` command or the AWS Management Console.
3. Create a role mapping that grants excessive permissions to the malicious provider.
4. Authenticate to the EKS cluster using the malicious provider.

By following these steps, the attacker can gain unauthorized access to the EKS cluster and perform actions that they are not supposed to be able to do.

### Mitigation

To mitigate the abuse of OIDC federation in EKS, it is recommended to follow these best practices:

1. Regularly review and audit the role mappings associated with the OIDC provider.
2. Limit the permissions granted to the OIDC provider to only what is necessary for its intended purpose.
3. Monitor the EKS cluster for any unauthorized access attempts or suspicious activities.
4. Implement strong authentication mechanisms, such as multi-factor authentication (MFA), to protect the OIDC provider.

By implementing these best practices, the risk of OIDC federation abuse in EKS can be significantly reduced.

### Conclusion

Abusing the OIDC federation feature in EKS can lead to unauthorized access to Kubernetes clusters and potential data breaches. It is important for organizations to be aware of this risk and take appropriate measures to secure their EKS clusters. Regular monitoring, auditing, and implementing strong authentication mechanisms are crucial in mitigating the abuse of OIDC federation in EKS.
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
可以通过将集群的 OIDC URL 设置为新的 Open ID Identity 提供者，简单地在 EKS 集群中生成 OIDC 提供者。这是一个常见的默认策略：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
这个策略正确地指示了只有具有ID为`20C159CDF6F2349B68846BEC03BE031B`的EKS集群可以扮演这个角色。然而，它没有指明哪个服务账号可以扮演这个角色，这意味着**任何具有Web身份令牌的服务账号**都可以扮演这个角色。

为了指定**哪个服务账号可以扮演这个角色**，需要指定一个**条件**，其中包括指定服务账号名称，例如：&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## 参考资料

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>
