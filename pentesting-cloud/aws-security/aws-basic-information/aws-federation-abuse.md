# AWS - Federation Abuse

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## SAML

SAML рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдХреГрдкрдпрд╛ рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**Identity Federation through SAML** рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдХреЗрд╡рд▓ рдПрдХ **рдирд╛рдо** рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ **metadata XML** рдЬрд┐рд╕рдореЗрдВ рд╕рднреА SAML рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди (**endpoints**, **certificate** with public key) рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

## OIDC - Github Actions Abuse

Github action рдХреЛ Identity provider рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП:

1. _Provider type_ рдХреЗ рд▓рд┐рдП, **OpenID Connect** рдЪреБрдиреЗрдВред
2. _Provider URL_ рдХреЗ рд▓рд┐рдП, `https://token.actions.githubusercontent.com` рджрд░реНрдЬ рдХрд░реЗрдВред
3. рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдХреЗ thumbprint рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП _Get thumbprint_ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред
4. _Audience_ рдХреЗ рд▓рд┐рдП, `sts.amazonaws.com` рджрд░реНрдЬ рдХрд░реЗрдВред
5. Github action рдХреА рдЬрд░реВрд░рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░ **рдирдпрд╛ рд░реЛрд▓** рдмрдирд╛рдПрдВ рдЬрд┐рд╕рдореЗрдВ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рдФрд░ рдРрд╕реА **trust policy** рд╣реЛ рдЬреЛ рдкреНрд░реЛрд╡рд╛рдЗрдбрд░ рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░реЗ рдЬреИрд╕реЗ:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. рдкрд┐рдЫрд▓реА рдкреЙрд▓рд┐рд╕реА рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреИрд╕реЗ рдХреЗрд╡рд▓ рдПрдХ **рд╢рд╛рдЦрд╛** рдХреЛ **рд╕рдВрдЧрдарди** рдХреЗ **рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА** рд╕реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ **рдЯреНрд░рд┐рдЧрд░** рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдХреГрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред
7. Github action рджреНрд╡рд╛рд░рд╛ **рдирдХрд▓реА** рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ **рд░реЛрд▓** рдХрд╛ **ARN** "рд╕реАрдХреНрд░реЗрдЯ" рд╣реЛрдЧрд╛ рдЬрд┐рд╕реЗ github action рдХреЛ рдЬрд╛рдирдирд╛ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдХрд┐рд╕реА **рдкрд░реНрдпрд╛рд╡рд░рдг** рдореЗрдВ **рд╕реАрдХреНрд░реЗрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ **рд╕реНрдЯреЛрд░** рдХрд░реЗрдВред
8. рдЕрдВрдд рдореЗрдВ, рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдпреБрдХреНрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ AWS рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ github action рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS рджреБрд░реБрдкрдпреЛрдЧ
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
рдПрдХ **EKS** рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ **OIDC рдкреНрд░реЛрд╡рд╛рдЗрдбрд░реНрд╕** рдХреЛ рд╕рд┐рд░реНрдл рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ **OIDC URL** рдХреЛ **рдирдП Open ID Identity рдкреНрд░реЛрд╡рд╛рдЗрдбрд░** рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░рдХреЗ рдЬрдирд░реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдиреАрддрд┐ рд╣реИ:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
рдпрд╣ рдиреАрддрд┐ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рд╕рдВрдХреЗрдд рдХрд░ рд░рд╣реА рд╣реИ рдХрд┐ **рдХреЗрд╡рд▓** **EKS рдХреНрд▓рд╕реНрдЯрд░** рдЬрд┐рд╕рдХреА **id** `20C159CDF6F2349B68846BEC03BE031B` рд╣реИ, рд╡рд╣реА рднреВрдорд┐рдХрд╛ рдХреЛ рдорд╛рди рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдпрд╣ рдирд╣реАрдВ рдмрддрд╛ рд░рд╣рд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЗрд╕реЗ рдорд╛рди рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **рдХреЛрдИ рднреА рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рд╡реЗрдм рдкрд╣рдЪрд╛рди рдЯреЛрдХрди рд╣реИ** рд╡рд╣ рднреВрдорд┐рдХрд╛ рдХреЛ **рдорд╛рдирдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**ред

рдпрд╣ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ **рдХреМрди рд╕рд╛ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рднреВрдорд┐рдХрд╛ рдХреЛ рдорд╛рдирдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП,** рдПрдХ **рд╢рд░реНрдд** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреА рд╣реЛрдЧреА рдЬрд╣рд╛рдВ **рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рдХрд╛ рдирд╛рдо рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ**, рдЬреИрд╕реЗ рдХрд┐:

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## рд╕рдВрджрд░реНрдн

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
