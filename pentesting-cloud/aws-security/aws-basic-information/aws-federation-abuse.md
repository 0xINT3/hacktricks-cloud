# AWS - рдлреЗрдбрд░реЗрд╢рди рджреБрд░реБрдкрдпреЛрдЧ

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ рдпрджрд┐ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **рддреБрд░рдВрдд** рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ,** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## SAML

SAML рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдХреГрдкрдпрд╛ рджреЗрдЦреЗрдВ:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

**SAML** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдПрдХ рдЖрдЗрдбреЗрдВрдЯрд┐рдЯреА рдлреЗрдбрд░реЗрд╢рди рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдмрд╕ рдПрдХ **рдирд╛рдо** рдФрд░ рд╕рднреА SAML рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди (**рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕**, **рдкрдмреНрд▓рд┐рдХ рдХреА рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░**) рдХреЛ рд╕рдореЗрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдореЗрдЯрд╛рдбреЗрдЯрд╛ XML** рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

## OIDC - Github Actions рджреБрд░реБрдкрдпреЛрдЧ

рдПрдХ github action рдХреЛ рдЖрдЗрдбреЗрдВрдЯрд┐рдЯреА рдкреНрд░рджрд╛рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП:

1. _рдкреНрд░рджрд╛рддрд╛ рдкреНрд░рдХрд╛рд░_ рдХреЗ рд▓рд┐рдП, **OpenID Connect** рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред
2. _рдкреНрд░рджрд╛рддрд╛ URL_ рдХреЗ рд▓рд┐рдП, `https://token.actions.githubusercontent.com` рджрд░реНрдЬ рдХрд░реЗрдВ
3. рдкреНрд░рджрд╛рддрд╛ рдХреЗ рдердВрдмрдкреНрд░рд┐рдВрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП _рдердВрдмрдкреНрд░рд┐рдВрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ_ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ
4. _рдПрдбрд┐рдпрдВрд╕_ рдХреЗ рд▓рд┐рдП, `sts.amazonaws.com` рджрд░реНрдЬ рдХрд░реЗрдВ
5. рдПрдХ **рдирдпрд╛ рд░реЛрд▓** рдмрдирд╛рдПрдВ рдЬрд┐рд╕рдореЗрдВ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реЛрдВ рдФрд░ рдПрдХ **рд╡рд┐рд╢реНрд╡рд╛рд╕ рдиреАрддрд┐** рд╣реЛ рдЬреЛ рдкреНрд░рджрд╛рддрд╛ рдХреЛ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХрд░рддреА рд╣реИ, рдЬреИрд╕реЗ:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. рдкрд┐рдЫрд▓реА рдиреАрддрд┐ рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреЗрд╡рд▓ рдПрдХ **рд╢рд╛рдЦрд╛** рдХреЛ **рд╕рдВрдЧрдарди** рдХреЗ **рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐** рдХреЗ рд╕рд╛рде рдПрдХ рд╡рд┐рд╢реЗрд╖ **рдЯреНрд░рд┐рдЧрд░** рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдХреГрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред
7. github action рдХреЛ **рдЕрднрд┐рдорд╛рдирд┐рдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ **рд░реЛрд▓** рдХрд╛ **ARN** рдПрдХ "рд╕реАрдХреНрд░реЗрдЯ" рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдПрдХ **рд╕реАрдХреНрд░реЗрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ **рд╡рд╛рддрд╛рдиреБрдХреВрд▓рди** рдХреЗ рднреАрддрд░ рдПрдХ **рдкрд░реНрдпрд╛рд╡рд░рдг** рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдВред
8. рдЕрдВрдд рдореЗрдВ, AWS рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ github action рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬреЛ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВред
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS рджреБрд░реБрдкрдпреЛрдЧ

рдУрдЖрдИрдбреАрд╕реА - рдИрдХреНрд╕ рджреБрд░реБрдкрдпреЛрдЧ
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
рдПрдХ **EKS** рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ **OIDC рдкреНрд░рджрд╛рддрд╛** рдЖрд╕рд╛рдиреА рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдмрд╕ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ **OIDC URL** рдХреЛ рдПрдХ **рдирдпрд╛ рдУрдкрди рдЖрдИрдбреА рдЖрдИрдбреЗрдВрдЯрд┐рдЯреА рдкреНрд░рджрд╛рддрд╛** рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░рдХреЗред рдпрд╣ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдиреАрддрд┐ рд╣реИ:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
рдпрд╣ рдиреАрддрд┐ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдЗрдВрдЧрд┐рдд рдХрд░ рд░рд╣реА рд╣реИ рдХрд┐ рдХреЗрд╡рд▓ **EKS рдХреНрд▓рд╕реНрдЯрд░** рдЬрд┐рд╕рдХрд╛ **id** `20C159CDF6F2349B68846BEC03BE031B` рд╣реИ, рд╡рд╣реА **role** рдЕрд╕реНрд╕реВрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдЗрдВрдЧрд┐рдд рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдЙрд╕реЗ рдЕрд╕реНрд╕реВрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ **рдХрд┐рд╕реА рднреА рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рд╡реЗрдм рдЖрдЗрдбреЗрдВрдЯрд┐рдЯреА рдЯреЛрдХрди** рдХреЗ рд╕рд╛рде рдЕрд╕реНрд╕реВрдо рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдЧреАред

**рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХреМрди рд╕рд╛ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рд░реЛрд▓ рдЕрд╕реНрд╕реВрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ,** рдПрдХ **рд╢рд░реНрдд** рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬрд╣рд╛рдВ **рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдирд╛рдо рдирд┐рд░реНрджрд┐рд╖реНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕реЗ:&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## рд╕рдВрджрд░реНрдн

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ рдФрд░ рд▓рд╛рдн рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ!</strong></summary>

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ рдпрджрд┐ рдЖрдкрдХреЛ **PEASS рдХреА рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдирд╛ рд╣реИ, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред**

</details>
