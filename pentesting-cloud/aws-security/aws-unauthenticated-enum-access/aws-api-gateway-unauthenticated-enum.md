# AWS - API Gateway Yetkilendirilmemiş Enum

<details>

<summary><strong>Sıfırdan kahraman olana kadar AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

### API Invoke bypass

[Alexandre & Leonardo tarafından sunulan API'ler için Saldırı Vektörleri - AWS API Gateway Lambda Yetkilendiricilerini Kullanan Saldırı Vektörleri](https://www.youtube.com/watch?v=bsPKk7WDOnE) adlı konuşmaya göre, Lambda Yetkilendiricileri, API uç noktalarını çağırmak için izin vermek için **IAM sözdizimini kullanarak yapılandırılabilir**. Bu, [**belgelerden alınmıştır**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Bu yöntemle uç noktaları çağırmak için izin verme sorunu, **"\*" her şeyi ima ettiği için ve artık desteklenmeyen regex sözdizimi olmadığı** gerçeğindedir.

Bazı örnekler:

* Her kullanıcıya `/dashboard/user/{username}` erişimini vermek için `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` gibi bir kural, örneğin `/admin/dashboard/createAdmin` gibi diğer rotalara erişim sağlayacaktır.

{% hint style="warning" %}
**"\*" kesmelerle genişlemeyi durdurmaz**, bu nedenle örneğin api-id'de "\*" kullanırsanız, son regex hala geçerli olduğu sürece "herhangi bir aşama" veya "herhangi bir yöntem" de belirtebilir.\
Bu nedenle `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
Örneğin `/prod/GET/dashboard/admin` yoluna bir post isteğini doğrulayabilir.
{% endhint %}

Her zaman kimin erişimine izin vermek istediğinizi net bir şekilde belirlemeli ve ardından verilen izinlerle diğer senaryoların mümkün olup olmadığını kontrol etmelisiniz.

Daha fazla bilgi için, [**belgelerin**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html) yanı sıra, [**bu resmi aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints) içinde yetkilendirme uygulamak için kod bulabilirsiniz.

### IAM Politikası Enjeksiyonu

Aynı [**sunumda**](https://www.youtube.com/watch?v=bsPKk7WDOnE) belirtildiği gibi, kodun **kullanıcı girdisini** kullanarak **IAM politikalarını oluşturduğu** durumda, joker karakterler (ve "." veya belirli dizeler gibi diğerleri) kısıtlamaları **atlamak** amacıyla içine dahil edilebilir.

### Genel URL şablonu
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Genel API Gateway URL'sinden Hesap Kimliği Alın

S3 kovaları, Veri Değişimi ve Lambda URL geçitleri gibi, genel bir API Gateway URL'sinden bir hesabın **`aws:ResourceAccount`** **Politika Koşul Anahtarı** kötüye kullanılarak hesap kimliğini bulmak mümkündür. Bu, politikanın **`aws:ResourceAccount`** bölümünde joker karakterlerini kötüye kullanarak hesap kimliğini bir karakter at a time bulmayı sağlar.\
Bu teknik ayrıca, **etiket değerlerini** almanıza da olanak tanır, etiket anahtarını bildiğiniz sürece (bazı varsayılan ilginç olanlar var).

Daha fazla bilgiyi [**orijinal araştırmada**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) ve bu sömürüyü otomatikleştirmek için [**conditional-love**](https://github.com/plerionhq/conditional-love/) aracında bulabilirsiniz.

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
