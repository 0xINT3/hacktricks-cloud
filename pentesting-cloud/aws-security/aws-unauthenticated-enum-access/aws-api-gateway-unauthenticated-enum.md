# AWS - Enum√©ration non authentifi√©e de l'API Gateway

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### Contournement de l'invocation de l'API

Selon la pr√©sentation [Vecteurs d'attaque pour les API utilisant les autorisateurs Lambda de la passerelle API AWS - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), les autorisateurs Lambda peuvent √™tre configur√©s **en utilisant la syntaxe IAM** pour donner des autorisations d'invocation aux points de terminaison de l'API. Ceci est extrait [**de la documentation**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
Le probl√®me avec cette fa√ßon de donner des autorisations pour invoquer des points de terminaison est que le **"\*" implique "anything"** et qu'il n'y a **plus de syntaxe regex support√©e**.

Quelques exemples :

* Une r√®gle telle que `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` afin de donner √† chaque utilisateur l'acc√®s √† `/dashboard/user/{username}` leur donnera √©galement acc√®s √† d'autres routes telles que `/admin/dashboard/createAdmin` par exemple.

{% hint style="warning" %}
Notez que **"\*" ne cesse pas de se d√©velopper avec les barres obliques**, donc, si vous utilisez "\*" dans api-id par exemple, cela pourrait √©galement indiquer "any stage" ou "any method" tant que l'expression r√©guli√®re finale est toujours valide.\
Ainsi `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
Peut valider une requ√™te POST vers le stage de test vers le chemin `/prod/GET/dashboard/admin` par exemple.
{% endhint %}

Vous devriez toujours avoir clairement ce que vous voulez autoriser √† acc√©der, puis v√©rifier si d'autres sc√©narios sont possibles avec les autorisations accord√©es.

Pour plus d'informations, en plus de la [**documentation**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), vous pouvez trouver du code pour impl√©menter des authorizers dans [**ce r√©f√©rentiel officiel aws github**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### Injection de politique IAM

Dans le m√™me [**talk**](https://www.youtube.com/watch?v=bsPKk7WDOnE), il est expos√© le fait que si le code utilise **l'entr√©e utilisateur** pour **g√©n√©rer les politiques IAM**, des caract√®res g√©n√©riques (et d'autres comme "." ou des cha√Ænes sp√©cifiques) peuvent √™tre inclus dans le but de **contourner les restrictions**.

### Mod√®le d'URL publique
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
### Obtenir l'identifiant du compte √† partir de l'URL publique de l'API Gateway

Tout comme avec les compartiments S3, Data Exchange et les passerelles d'URL Lambda, il est possible de trouver l'identifiant du compte d'un compte en abusant de la **cl√© de condition de strat√©gie `aws:ResourceAccount`** √† partir d'une URL publique de l'API Gateway. Cela se fait en trouvant l'identifiant du compte un caract√®re √† la fois en abusant des caract√®res g√©n√©riques dans la section **`aws:ResourceAccount`** de la politique.\
Cette technique permet √©galement d'obtenir les **valeurs des tags** si vous connaissez la cl√© du tag (il y en a quelques-unes int√©ressantes par d√©faut).

Vous pouvez trouver plus d'informations dans la [**recherche originale**](https://blog.plerion.com/conditional-love-for-aws-metadata-enumeration/) et l'outil [**conditional-love**](https://github.com/plerionhq/conditional-love/) pour automatiser cette exploitation.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
