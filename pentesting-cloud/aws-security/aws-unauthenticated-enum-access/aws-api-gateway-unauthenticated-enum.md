# AWS - Enumeraci√≥n sin autenticaci√≥n de Api Gateway

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### Bypass de invocaci√≥n de API

Seg√∫n la charla [Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE), los autorizadores Lambda se pueden configurar **usando la sintaxis IAM** para dar permisos para invocar puntos finales de API. Esto se toma [**de la documentaci√≥n**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Permission",
      "Action": [
        "execute-api:Execution-operation"           
      ],
      "Resource": [
        "arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
      ]
    }
  ]
} 
```

El problema con esta forma de dar permisos para invocar puntos finales es que el **"\*" implica "cualquier cosa"** y no hay **sintaxis de expresiones regulares compatibles**.

Algunos ejemplos:

* Una regla como `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*` para dar a cada usuario acceso a `/dashboard/user/{username}` les dar√° acceso a otras rutas como `/admin/dashboard/createAdmin`, por ejemplo.

{% hint style="warning" %}
Ten en cuenta que el **"\*" no deja de expandirse con barras**, por lo tanto, si usas "\*" en api-id, por ejemplo, tambi√©n podr√≠a indicar "cualquier etapa" o "cualquier m√©todo" siempre y cuando la expresi√≥n regular final siga siendo v√°lida.\
As√≠ que `arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
Puede validar una solicitud POST a la etapa de prueba en la ruta `/prod/GET/dashboard/admin`, por ejemplo.
{% endhint %}

Siempre debes tener claro lo que quieres permitir el acceso y luego verificar si otros escenarios son posibles con los permisos otorgados.

Para obtener m√°s informaci√≥n, adem√°s de la [**documentaci√≥n**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html), puedes encontrar c√≥digo para implementar autorizadores en [**este repositorio oficial de aws**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints).

### Inyecci√≥n de pol√≠tica IAM

En la misma [**charla** ](https://www.youtube.com/watch?v=bsPKk7WDOnE)se expone el hecho de que si el c√≥digo est√° utilizando **entrada de usuario** para **generar las pol√≠ticas IAM**, se pueden incluir comodines (y otros como "." o cadenas espec√≠ficas) con el objetivo de **burlar las restricciones**.

### Plantilla de URL p√∫blica

```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>