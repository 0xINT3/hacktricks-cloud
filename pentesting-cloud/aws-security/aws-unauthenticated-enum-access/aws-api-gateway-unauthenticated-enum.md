# AWS - Api Gateway未認証の列挙

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで広告表示したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

### API Invokeバイパス

[Attack Vectors for APIs Using AWS API Gateway Lambda Authorizers - Alexandre & Leonardo](https://www.youtube.com/watch?v=bsPKk7WDOnE)というトークによると、Lambda Authorizersは**IAM構文を使用して**APIエンドポイントの呼び出し権限を付与することができます。これは[**ドキュメントから取得**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html)されます：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Permission",
"Action": [
"execute-api:Execution-operation"
],
"Resource": [
"arn:aws:execute-api:region:account-id:api-id/stage/METHOD_HTTP_VERB/Resource-path"
]
}
]
}
```
このエンドポイントへのアクセス権限を与える方法の問題は、**"\*"は"anything"を意味し、正規表現の構文はサポートされていない**ということです。

いくつかの例:

* `arn:aws:execute-apis:sa-east-1:accid:api-id/prod/*/dashboard/*`のようなルールは、ユーザーごとに`/dashboard/user/{username}`へのアクセス権限を与えるために使用されますが、`/admin/dashboard/createAdmin`などの他のルートへのアクセス権も与えてしまいます。

{% hint style="warning" %}
**"\*"はスラッシュで展開が止まらない**ことに注意してください。したがって、例えばapi-idに"\*"を使用する場合、それは「任意のステージ」または「任意のメソッド」を示すこともできますが、最終的な正規表現が有効である限りです。\
したがって、`arn:aws:execute-apis:sa-east-1:accid:*/prod/GET/dashboard/*`\
は、例えばテストステージへのPOSTリクエストを`/prod/GET/dashboard/admin`のパスに対して検証することができます。
{% endhint %}

常にアクセスを許可したい内容を明確にし、許可された権限で他のシナリオが可能かどうかを確認する必要があります。

詳細については、[**ドキュメント**](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-control-access-using-iam-policies-to-invoke-api.html)の他に、[**この公式のAWS GitHub**](https://github.com/awslabs/aws-apigateway-lambda-authorizer-blueprints/tree/master/blueprints)で、オーソライザを実装するためのコードを見つけることができます。

### IAMポリシーのインジェクション

同じ[**トーク**](https://www.youtube.com/watch?v=bsPKk7WDOnE)では、コードが**ユーザーの入力**を使用して**IAMポリシーを生成**している場合、ワイルドカード（および"."や特定の文字列など）を含めることで、制限を**バイパス**することができることが示されています。

### パブリックURLテンプレート
```
https://{random_id}.execute-api.{region}.amazonaws.com/{user_provided}
```
<details>

<summary><strong>Support HackTricksと特典を受け取る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
