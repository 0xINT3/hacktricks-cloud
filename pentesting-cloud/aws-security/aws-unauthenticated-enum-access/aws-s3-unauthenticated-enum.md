# AWS - Enumeraci√≥n no autenticada de S3

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Buckets p√∫blicos de S3

Un bucket se considera **"p√∫blico"** si **cualquier usuario puede listar el contenido** del bucket, y **"privado"** si el contenido del bucket solo puede ser listado o escrito por ciertos usuarios.

Las empresas pueden tener **permisos de buckets mal configurados** que dan acceso a todo o a cualquier usuario autenticado en AWS en cualquier cuenta (es decir, a cualquier persona). Ten en cuenta que incluso con estas configuraciones incorrectas, es posible que algunas acciones no se puedan realizar, ya que los buckets pueden tener sus propias listas de control de acceso (ACLs).

**Aprende sobre la mala configuraci√≥n de AWS-S3 aqu√≠:** [**http://flaws.cloud**](http://flaws.cloud/) **y** [**http://flaws2.cloud/**](http://flaws2.cloud)

### Encontrar buckets de AWS

Diferentes m√©todos para encontrar cuando una p√°gina web est√° utilizando AWS para almacenar algunos recursos:

#### Enumeraci√≥n y OSINT:

* Usando el complemento del navegador **wappalyzer**
* Usando burp (**rastreando** la web) o navegando manualmente por la p√°gina, todos los **recursos cargados** se guardar√°n en el Historial.
*   **Comprueba los recursos** en dominios como:

```
http://s3.amazonaws.com/[nombre_del_bucket]/
http://[nombre_del_bucket].s3.amazonaws.com/
```
* Comprueba los **CNAMES** ya que `resources.domain.com` podr√≠a tener el CNAME `bucket.s3.amazonaws.com`
* Comprueba [https://buckets.grayhatwarfare.com](https://buckets.grayhatwarfare.com/), una web con **buckets abiertos ya descubiertos**.
* El **nombre del bucket** y el **nombre de dominio del bucket** deben ser **iguales**.
* **flaws.cloud** est√° en la **IP** 52.92.181.107 y si vas all√≠ te redirige a [https://aws.amazon.com/s3/](https://aws.amazon.com/s3/). Adem√°s, `dig -x 52.92.181.107` devuelve `s3-website-us-west-2.amazonaws.com`.
* Para comprobar si es un bucket tambi√©n puedes **visitar** [https://flaws.cloud.s3.amazonaws.com/](https://flaws.cloud.s3.amazonaws.com/).

#### Fuerza bruta

Puedes encontrar buckets mediante la **fuerza bruta de nombres** relacionados con la empresa que est√°s probando:

* [https://github.com/sa7mon/S3Scanner](https://github.com/sa7mon/S3Scanner)
* [https://github.com/clario-tech/s3-inspector](https://github.com/clario-tech/s3-inspector)
* [https://github.com/jordanpotti/AWSBucketDump](https://github.com/jordanpotti/AWSBucketDump) (Contiene una lista con posibles nombres de buckets)
* [https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets](https://github.com/fellchase/flumberboozle/tree/master/flumberbuckets)
* [https://github.com/smaranchand/bucky](https://github.com/smaranchand/bucky)
* [https://github.com/tomdev/teh\_s3\_bucketeers](https://github.com/tomdev/teh\_s3\_bucketeers)
* [https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/s3)
* [https://github.com/Eilonh/s3crets\_scanner](https://github.com/Eilonh/s3crets\_scanner)
* [https://github.com/belane/CloudHunter](https://github.com/belane/CloudHunter)

<pre class="language-bash"><code class="lang-bash"># Generar una lista de palabras para crear permutaciones
curl -s https://raw.githubusercontent.com/cujanovic/goaltdns/master/words.txt > /tmp/words-s3.txt.temp
curl -s https://raw.githubusercontent.com/jordanpotti/AWSBucketDump/master/BucketNames.txt >>/tmp/words-s3.txt.temp
cat /tmp/words-s3.txt.temp | sort -u > /tmp/words-s3.txt

# Generar una lista de palabras basada en los dominios y subdominios a probar
## Escribe esos dominios y subdominios en subdomains.txt
cat subdomains.txt > /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "-" >> /tmp/words-hosts-s3.txt
cat subdomains.txt | tr "." "\n" | sort -u >> /tmp/words-hosts-s3.txt

# Crear permutaciones basadas en una lista con los dominios y subdominios a atacar
goaltdns -l /tmp/words-hosts-s3.txt -w /tmp/words-s3.txt -o /tmp/final-words-s3.txt.temp
## La herramienta anterior est√° especializada en crear permutaciones para subdominios, vamos a filtrar esa lista
<strong>### Eliminar l√≠neas que terminen con "."
</strong>cat /tmp/final-words-s3.txt.temp | grep -Ev "\.$" > /tmp/final-words-s3.txt.temp2
### Crear lista sin TLD
cat /tmp/final-words-s3.txt.temp2 | sed -E 's/\.[a-zA-Z0-9]+$//' > /tmp/final-words-s3.txt.temp3
### Crear lista sin puntos
cat /tmp/final-words-s3.txt.temp3 | tr -d "." > /tmp/final-words-s3.txt.temp4http://phantom.s3.amazonaws.com/
### Crear lista sin guiones
cat /tmp/final-words-s3.txt.temp3 | tr "." "-" > /tmp/final-words-s3.txt.temp5

## Generar la lista de palabras final
cat /tmp/final-words-s3.txt.temp2 /tmp/final-words-s3.txt.temp3 /tmp/final-words-s3.txt.temp4 /tmp/final-words-s3.txt.temp5 | grep -v -- "-\." | awk '{print tolower($0)}' | sort -u > /tmp/final-words-s3.txt

## Llamar a s3scanner
s3scanner --threads 100 scan --buckets-file /tmp/final-words-s3.txt  | grep bucket_exists
</code></pre>

#### Bot√≠n de Buckets S3

Dado que los buckets S3 est√°n abiertos, [**BucketLoot**](https://github.com/redhuntlabs/BucketLoot) puede **buscar autom√°ticamente informaci√≥n interesante**.

### Encontrar la Regi√≥n

Puedes encontrar todas las regiones admitidas por AWS en [**https://docs.aws.amazon.com/general/latest/gr/s3.html**](https://docs.aws.amazon.com/general/latest/gr/s3.html)

#### Por DNS

Puedes obtener la regi√≥n de un bucket con **`dig`** y **`nslookup`** haciendo una **solicitud DNS de la IP descubierta**:
```bash
dig flaws.cloud
;; ANSWER SECTION:
flaws.cloud.    5    IN    A    52.218.192.11

nslookup 52.218.192.11
Non-authoritative answer:
11.192.218.52.in-addr.arpa name = s3-website-us-west-2.amazonaws.com.
```
Verifica que el dominio resuelto tenga la palabra "website".\
Puedes acceder al sitio web est√°tico yendo a: `flaws.cloud.s3-website-us-west-2.amazonaws.com`\
o puedes acceder al bucket visitando: `flaws.cloud.s3-us-west-2.amazonaws.com`

#### Mediante Prueba

Si intentas acceder a un bucket, pero en el **nombre de dominio especificas otra regi√≥n** (por ejemplo, el bucket est√° en `bucket.s3.amazonaws.com` pero intentas acceder a `bucket.s3-website-us-west-2.amazonaws.com`), entonces se te **indicar√° la ubicaci√≥n correcta**:

![](<../../../.gitbook/assets/image (57).png>)

### Enumerando el bucket

Para probar la apertura del bucket, un usuario puede simplemente ingresar la URL en su navegador web. Un bucket privado responder√° con "Acceso denegado". Un bucket p√∫blico mostrar√° una lista de los primeros 1,000 objetos almacenados.

Abierto a todos:

![](<../../../.gitbook/assets/image (67).png>)

Privado:

![](<../../../.gitbook/assets/image (78).png>)

Tambi√©n puedes verificar esto con la l√≠nea de comandos (CLI):
```bash
#Use --no-sign-request for check Everyones permissions
#Use --profile <PROFILE_NAME> to indicate the AWS profile(keys) that youwant to use: Check for "Any Authenticated AWS User" permissions
#--recursive if you want list recursivelyls
#Opcionally you can select the region if you now it
aws s3 ls s3://flaws.cloud/ [--no-sign-request] [--profile <PROFILE_NAME>] [ --recursive] [--region us-west-2]
```
Si el bucket no tiene un nombre de dominio, al intentar enumerarlo, **solo coloque el nombre del bucket** y no todo el dominio de AWSs3. Ejemplo: `s3://<NOMBREDELBUCKET>`

### Plantilla de URL p√∫blica
```
https://{user_provided}.s3.amazonaws.com
```
## Referencias

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
