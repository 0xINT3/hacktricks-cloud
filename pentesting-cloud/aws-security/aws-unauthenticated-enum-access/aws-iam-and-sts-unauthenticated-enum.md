# AWS - Enum√©ration IAM & STS non authentifi√©e

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Enum√©rer les r√¥les et noms d'utilisateur dans un compte

### ~~Brute-Force d'Assume Role~~

{% hint style="danger" %}
**Cette technique ne fonctionne plus** car que le r√¥le existe ou non, vous obtenez toujours cette erreur :

`An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::947247140022:user/testenv is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::429217632764:role/account-balanceasdas`

Vous pouvez **tester ceci en ex√©cutant** :

`aws sts assume-role --role-arn arn:aws:iam::412345678909:role/superadmin --role-session-name s3-access-example`
{% endhint %}

Tenter d'**assumer un r√¥le sans les autorisations n√©cessaires** d√©clenche un message d'erreur AWS. Par exemple, si non autoris√©, AWS pourrait renvoyer :
```ruby
An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::012345678901:user/MyUser is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::111111111111:role/aws-service-role/rds.amazonaws.com/AWSServiceRoleForRDS
```
Ce message confirme l'existence du r√¥le mais indique que sa politique d'assumption de r√¥le ne permet pas votre assumption. En revanche, essayer d'**assumer un r√¥le inexistant entra√Æne une erreur diff√©rente** :
```less
An error occurred (AccessDenied) when calling the AssumeRole operation: Not authorized to perform sts:AssumeRole
```
Int√©ressant, cette m√©thode de **diff√©renciation entre les r√¥les existants et non existants** est applicable m√™me entre diff√©rents comptes AWS. Avec un ID de compte AWS valide et une liste de mots cibl√©e, il est possible d'√©num√©rer les r√¥les pr√©sents dans le compte sans rencontrer de limitations inh√©rentes.

Vous pouvez utiliser ce [script pour √©num√©rer les principaux potentiels](https://github.com/RhinoSecurityLabs/Security-Research/tree/master/tools/aws-pentest-tools/assume\_role\_enum) en exploitant ce probl√®me.

### Politiques de confiance : Brute-Force des r√¥les et utilisateurs inter-comptes

La configuration ou la mise √† jour d'une **politique de confiance d'un r√¥le IAM implique de d√©finir quels ressources ou services AWS sont autoris√©s √† assumer ce r√¥le** et √† obtenir des informations d'identification temporaires. Si la ressource sp√©cifi√©e dans la politique **existe**, la politique de confiance est enregistr√©e **avec succ√®s**. Cependant, si la ressource **n'existe pas**, une **erreur est g√©n√©r√©e**, indiquant qu'un principal invalide a √©t√© fourni.

{% hint style="warning" %}
Notez que dans cette ressource, vous pouvez sp√©cifier un r√¥le ou un utilisateur inter-comptes :

* `arn:aws:iam::acc_id:role/role_name`
* `arn:aws:iam::acc_id:user/user_name`
{% endhint %}

Voici un exemple de politique :
```json
{
"Version":"2012-10-17",
"Statement":[
{
"Effect":"Allow",
"Principal":
{
"AWS":"arn:aws:iam::216825089941:role\/Test"
},
"Action":"sts:AssumeRole"
}
]
}
```
#### GUI

C'est l'**erreur** que vous trouverez si vous utilisez un **r√¥le qui n'existe pas**. Si le r√¥le **existe**, la politique sera **enregistr√©e** sans erreurs. (L'erreur est pour la mise √† jour, mais cela fonctionne √©galement lors de la cr√©ation)

![](<../../../.gitbook/assets/image (68).png>)

#### CLI
```bash
### You could also use: aws iam update-assume-role-policy
# When it works
aws iam create-role --role-name Test-Role --assume-role-policy-document file://a.json
{
"Role": {
"Path": "/",
"RoleName": "Test-Role",
"RoleId": "AROA5ZDCUJS3DVEIYOB73",
"Arn": "arn:aws:iam::947247140022:role/Test-Role",
"CreateDate": "2022-05-03T20:50:04Z",
"AssumeRolePolicyDocument": {
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::316584767888:role/account-balance"
},
"Action": [
"sts:AssumeRole"
]
}
]
}
}
}

# When it doesn't work
aws iam create-role --role-name Test-Role2 --assume-role-policy-document file://a.json
An error occurred (MalformedPolicyDocument) when calling the CreateRole operation: Invalid principal in policy: "AWS":"arn:aws:iam::316584767888:role/account-balanceefd23f2"
```
Vous pouvez automatiser ce processus avec [https://github.com/carlospolop/aws\_tools](https://github.com/carlospolop/aws\_tools)

* `bash unauth_iam.sh -t user -i 316584767888 -r TestRole -w ./unauth_wordlist.txt`

En utilisant [Pacu](https://github.com/RhinoSecurityLabs/pacu):

* `run iam__enum_users --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* `run iam__enum_roles --role-name admin --account-id 229736458923 --word-list /tmp/names.txt`
* Le r√¥le `admin` utilis√© dans l'exemple est un **r√¥le dans votre compte √† impersonner** par Pacu pour cr√©er les politiques n√©cessaires √† l'√©num√©ration

### √âl√©vation de privil√®ges

Dans le cas o√π le r√¥le aurait √©t√© mal configur√© et permettrait √† n'importe qui de l'assumer:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
Le pirate pourrait simplement le supposer.

## F√©d√©ration OIDC de tiers

Imaginez que vous parveniez √† lire un **flux de travail Github Actions** qui acc√®de √† un **r√¥le** √† l'int√©rieur d'**AWS**.\
Cette confiance pourrait donner acc√®s √† un r√¥le avec la **politique de confiance** suivante:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::<acc_id>:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
Ce **manque de conditions suppl√©mentaires** devrait vous inciter √† vous m√©fier, m√™me si cette strat√©gie de confiance semble correcte.\
Cela est d√ª au fait que le r√¥le pr√©c√©dent peut √™tre assum√© par **N'IMPORTE QUI de Github Actions**! Vous devriez √©galement sp√©cifier dans les conditions d'autres √©l√©ments tels que le nom de l'organisation, le nom du d√©p√¥t, l'environnement, la branche...

Une autre erreur potentielle de configuration est d'**ajouter une condition** comme suit :
```json
"StringLike": {
"token.actions.githubusercontent.com:sub": "repo:org_name*:*"
}
```
Notez que le **joker** (\*) avant les **deux-points** (:). Vous pouvez cr√©er une organisation telle que **org\_name1** et **assumer le r√¥le** depuis une action Github.

## R√©f√©rences

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/](https://rhinosecuritylabs.com/aws/assume-worst-aws-assume-role-enumeration/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
