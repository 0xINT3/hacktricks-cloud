# AWS - Misc Privesc

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Misc

Aqu칤 encontrar치s **combinaciones de permisos** que podr칤as abusar para **escalar privilegios** o **acceder a datos sensibles**.

### `route53:CreateHostedZone`, `route53:ChangeResourceRecordSets`, `acm-pca:IssueCertificate`, `acm-pca:GetCertificate`

{% hint style="info" %}
Para realizar este ataque, la cuenta objetivo ya debe tener una [**Autoridad de Certificaci칩n Privada de AWS Certificate Manager**](https://aws.amazon.com/certificate-manager/private-certificate-authority/) **(AWS-PCA)** configurada en la cuenta, y las instancias EC2 en las VPC ya deben haber importado los certificados para confiar en ella. Con esta infraestructura en su lugar, se puede realizar el siguiente ataque para interceptar el tr치fico de la API de AWS.
{% endhint %}

Otros permisos **recomendados pero no requeridos para la parte de enumeraci칩n**: `route53:GetHostedZone`, `route53:ListHostedZones`, `acm-pca:ListCertificateAuthorities`, `ec2:DescribeVpcs`

Suponiendo que hay una VPC de AWS con m칰ltiples aplicaciones nativas en la nube que se comunican entre s칤 y con la API de AWS. Dado que la comunicaci칩n entre los microservicios suele estar cifrada con TLS, debe haber una CA privada para emitir los certificados v치lidos para esos servicios. **Si se usa ACM-PCA** para eso y el adversario logra obtener **acceso para controlar tanto route53 como la CA privada de acm-pca** con el conjunto m칤nimo de permisos descritos anteriormente, puede **interceptar las llamadas de la aplicaci칩n a la API de AWS** y tomar sus permisos IAM.

Esto es posible porque:

* Los SDK de AWS no tienen [Certificate Pinning](https://www.digicert.com/blog/certificate-pinning-what-is-certificate-pinning)
* Route53 permite crear una zona alojada privada y registros DNS para los nombres de dominio de las API de AWS
* La CA privada en ACM-PCA no se puede restringir para firmar solo certificados para nombres comunes espec칤ficos

Ver la investigaci칩n y explotaci칩n en:

{% content-ref url="route53-createhostedzone-route53-changeresourcerecordsets-acm-pca-issuecertificate-acm-pca-getcer.md" %}
[route53-createhostedzone-route53-changeresourcerecordsets-acm-pca-issuecertificate-acm-pca-getcer.md](route53-createhostedzone-route53-changeresourcerecordsets-acm-pca-issuecertificate-acm-pca-getcer.md)
{% endcontent-ref %}

**Impacto potencial:** Privesc indirecto mediante la interceptaci칩n de informaci칩n sensible en el tr치fico.

### `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

Con todos estos permisos podr치s **ejecutar un "malmirror"** que ser치 capaz de **robar los paquetes de red enviados dentro de la VPC.**

Para obtener m치s informaci칩n, consulta esta p치gina:

{% content-ref url="../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

**Impacto potencial:** Privesc indirecto mediante la interceptaci칩n de informaci칩n sensible en el tr치fico.

### Llamadas a la API que devuelven credenciales

* chime:createapikey
* [codepipeline:pollforjobs](https://docs.aws.amazon.com/codepipeline/latest/APIReference/API\_PollForJobs.html)
* [cognito-identity:getopenidtoken](https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API\_GetOpenIdToken.html)
* [cognito-identity:getopenidtokenfordeveloperidentity](https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API\_GetOpenIdTokenForDeveloperIdentity.html)
* [cognito-identity:getcredentialsforidentity](https://docs.aws.amazon.com/cognitoidentity/latest/APIReference/API\_GetCredentialsForIdentity.html)
* [connect:getfederationtoken](https://docs.aws.amazon.com/connect/latest/APIReference/API\_GetFederationToken.html)
* [connect:getfederationtokens](https://docs.aws.amazon.com/connect/latest/APIReference/API\_GetFederationToken.html)
* [ecr:getauthorizationtoken](https://docs.aws.amazon.com/AmazonECR/latest/APIReference/API\_GetAuthorizationToken.html)
* [gamelift:requestuploadcredentials](https://docs.aws.amazon.com/gamelift/latest/apireference/API\_RequestUploadCredentials.html)
* [iam:createaccesskey](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_CreateAccessKey.html)
* [iam:createloginprofile](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_CreateLoginProfile.html)
* [iam:createservicespecificcredential](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_CreateServiceSpecificCredential.html)
* [iam:resetservicespecificcredential](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResetServiceSpecificCredential.html)
* [iam:updateaccesskey](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UpdateAccessKey.html)
* [lightsail:getinstanceaccessdetails](https://docs.aws.amazon.com/lightsail/2016-11-28/api-reference/API\_GetInstanceAccessDetails.html)
* [lightsail:getrelationaldatabasemasteruserpassword](https://docs.aws.amazon.com/lightsail/2016-11-28/api-reference/API\_GetRelationalDatabaseMasterUserPassword.html)
* [rds-db:connect](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html)
* [redshift:getclustercredentials](https://docs.aws.amazon.com/redshift/latest/APIReference/API\_GetClusterCredentials.html)
* [sso:getrolecredentials](https://docs.aws.amazon.com/singlesignon/latest/PortalAPIReference/API\_GetRoleCredentials.html)
* [mediapackage:rotatechannelcredentials](https://docs.aws.amazon.com/mediapackage/latest/apireference/channels-id-credentials.html)
* [mediapackage:rotateingestendpointcredentials](https://docs.aws.amazon.com/mediapackage/latest/apireference/channels-id-ingest\_endpoints-ingest\_endpoint\_id-credentials.html)
* [sts:assumerole](https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html)
* [sts:assumerolewithsaml](https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role-with