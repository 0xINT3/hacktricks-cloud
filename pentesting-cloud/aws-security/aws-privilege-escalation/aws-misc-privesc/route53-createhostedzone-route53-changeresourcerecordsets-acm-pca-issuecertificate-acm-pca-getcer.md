# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

**Pesquisa copiada de:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)

## Sequestrando chamadas de API da AWS

### Usando a modifica√ß√£o do Route53 e certificados ACM-PCA

Postado em 11 de mar√ßo de 2022

Algum tempo atr√°s, fiz algumas pesquisas sobre poss√≠veis amea√ßas de Man-in-the-Middle na AWS. Esta postagem descreve os resultados dessa pesquisa e mostra uma maneira interessante de escalar os privil√©gios do IAM na VPC da AWS.

Vamos come√ßar com os pr√©-requisitos de que o atacante assumiu a fun√ß√£o IAM que permite fazer modifica√ß√µes no Route53 e emitir os certificados assinados pela CA privada do ACM-PCA.

As permiss√µes m√≠nimas do IAM que a fun√ß√£o deve ter para fazer a mesma explora√ß√£o s√£o:

```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```

As outras permiss√µes do IAM que podem ser √∫teis na enumera√ß√£o, mas n√£o s√£o obrigat√≥rias para explorar:

```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```

Depois que o atacante tem permiss√µes m√≠nimas do IAM no route53 e acm-pca, ele ou ela seria capaz de sequestrar as chamadas para a API da AWS e escalar com sucesso os privil√©gios do IAM na implanta√ß√£o da AWS - encaminhando as chamadas de API da AWS sequestradas para os Endpoints relevantes da VPC e lendo as respostas, por exemplo, a chamada secretsmanager:GetSecretValue.

Fiquei surpreso que isso √© poss√≠vel, por causa da minha falsa suposi√ß√£o de que: 1) o SDK da AWS usa algum tipo de pinning de certificado, 2) tanto o route53 quanto o acm-pca n√£o permitiriam controlar os nomes de dom√≠nio internos da AWS.

Todas essas suposi√ß√µes n√£o s√£o verdadeiras. A Seguran√ßa da AWS foi consultada, mas descobriu-se que n√£o √© um bug de seguran√ßa. Existem casos de uso em que os clientes desejam configurar o proxy ou roteamento personalizado para o tr√°fego para as APIs da AWS. Decidi documentar e compartilhar esse comportamento, pois pode ser √∫til para outros testadores de penetra√ß√£o em nuvem.

### Descoberta <a href="#discovery" id="discovery"></a>

A descoberta come√ßou com a manipula√ß√£o do route53, criando primeiro a zona hospedada para amazonaws.com, o que falhou:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

Tentei o mesmo para us-east-1.amazonaws.com, que deu os mesmos resultados:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Mas para minha surpresa, o secretsmanager.us-east-1.amazonaws.com funcionou:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Agora, pode-se criar um registro A para o secretsmanager.us-east-1.amazonaws.com apontando para algum IP interno dentro da VPC:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

Simulando a listagem de segredos na m√°quina da v√≠tima e na m√°quina do atacante, recebemos a conex√£o que √© tr√°fego criptografado por TLS:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

A comunica√ß√£o √© criptografada por TLS, mas se as aplica√ß√µes na VPC confiarem na CA privada gerenciada pelo ACM-PCA e o atacante tiver permiss√µes do IAM para controlar essa CA privada no ACM-PCA, seria poss√≠vel fazer um Man-In-The-Middle completo e escalar os privil√©gios do IAM.

### Explora√ß√£o <a href="#exploitation" id="exploitation"></a>

Voc√™ pode assistir a toda a explora√ß√£o aqui:

[https://youtu.be/I-IakgPyE