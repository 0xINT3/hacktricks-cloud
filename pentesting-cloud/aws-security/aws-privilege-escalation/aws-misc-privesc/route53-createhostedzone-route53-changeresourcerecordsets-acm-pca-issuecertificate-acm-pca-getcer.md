# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Investigación copiada de:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)

## Secuestro de llamadas de API de AWS

### Usando la modificación de Route53 y los certificados ACM-PCA

Publicado el 11 de marzo de 2022

Hace algún tiempo realicé una investigación sobre posibles amenazas de Man-in-the-Middle en AWS. Esta publicación de blog describe los resultados de esta investigación y muestra una forma interesante de escalar los privilegios IAM en el VPC de AWS.

Comencemos con los requisitos previos de que el atacante haya tomado el control del rol IAM que permite realizar modificaciones en Route53 y emitir los certificados firmados por CA privada de ACM-PCA.

Los permisos IAM mínimos que el rol debe tener para realizar la misma explotación son:

```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```

Los otros permisos IAM que pueden ser útiles en la enumeración pero no son obligatorios para explotar son:

```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```

Una vez que el atacante tiene permisos IAM mínimos en route53 y acm-pca, podría secuestrar las llamadas a la API de AWS y escalar con éxito los privilegios IAM en la implementación de AWS, reenviando las llamadas de API de AWS secuestradas a los puntos finales relevantes de VPC y leyendo las respuestas, por ejemplo, la llamada secretsmanager:GetSecretValue.

Me sorprendió que esto fuera posible, debido a mi falsa suposición de que: 1) el SDK de AWS utiliza una especie de fijación de certificado, 2) tanto route53 como acm-pca no permitirían controlar los nombres de dominio internos de AWS.

Todas esas suposiciones no son ciertas. Se consultó a la seguridad de AWS, pero resultó que no es un error de seguridad. Hay casos de uso en los que los clientes quieren configurar el proxy o el enrutamiento personalizado para el tráfico a las API de AWS. He decidido documentar y compartir este comportamiento, ya que puede ser útil para otros pen-testers en la nube.

### Descubrimiento <a href="#discovery" id="discovery"></a>

El descubrimiento comenzó jugando con route53, creando primero la zona alojada para amazonaws.com, lo que falló:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

Hice lo mismo para us-east-1.amazonaws.com, que dio los mismos resultados:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Pero para mi sorpresa, funcionó secretsmanager.us-east-1.amazonaws.com:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Ahora, se puede crear un registro A para secretsmanager.us-east-1.amazonaws.com que apunte a alguna IP interna dentro del VPC:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

Simulando la lista de secretos de la víctima en la máquina de la víctima y en la máquina del atacante, recibimos la conexión que es tráfico cifrado TLS:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

La comunicación está cifrada con TLS, pero si las aplicaciones en el VPC confían en la CA privada administrada por ACM-PCA y el atacante tiene permisos IAM para controlar esa CA privada en ACM-PCA, sería posible hacer un Man-In-The-Middle completo y escalar los privilegios IAM.

### Explotación <a href="#exploitation" id="exploitation"></a>

Puedes ver toda la explotación aquí:

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

Si prefieres leer y ver las capturas de pantalla, sigue leyendo.

Para fines de demostración, supongamos que el atacante comprometió uno de los ec2 con el siguiente rol IAM asumido:

![aws\_hijack](https://github.com/niebardzo/niebard