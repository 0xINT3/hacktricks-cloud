# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous voulez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

**Recherche copi√©e depuis:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)

## Piratage des appels d'API AWS

### Utilisation de la modification de Route53 et des certificats ACM-PCA

Publi√© le 11 mars 2022

Il y a quelque temps, j'ai effectu√© des recherches sur les possibles menaces de l'homme du milieu dans AWS. Cet article de blog d√©crit les r√©sultats de cette recherche et montre une fa√ßon int√©ressante d'escalader les privil√®ges IAM dans le VPC AWS.

Commen√ßons par les pr√©requis que l'attaquant a pris le contr√¥le du r√¥le IAM qui permet de modifier Route53 et d'√©mettre des certificats sign√©s par une CA priv√©e d'ACM-PCA.

Les autorisations IAM minimales que le r√¥le doit avoir pour effectuer la m√™me exploitation sont :

```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```

Les autres autorisations IAM qui peuvent √™tre utiles dans l'√©num√©ration mais qui ne sont pas obligatoires pour l'exploitation sont :

```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```

Une fois que l'attaquant dispose des autorisations IAM minimales sur route53 et acm-pca, il ou elle serait en mesure de d√©tourner les appels √† l'API AWS et d'escalader avec succ√®s les privil√®ges IAM dans le d√©ploiement AWS - en redirigeant les appels d'API AWS d√©tourn√©s vers les points de terminaison VPC pertinents et en lisant les r√©ponses, par exemple l'appel secretsmanager:GetSecretValue.

J'ai √©t√© √©tonn√© que cela soit possible, en raison de ma fausse hypoth√®se que : 1) le SDK AWS utilise une sorte de broche de certificat, 2) √† la fois route53 et acm-pca ne permettraient pas de contr√¥ler les noms de domaine internes AWS.

Toutes ces hypoth√®ses sont fausses. La s√©curit√© AWS a √©t√© consult√©e mais il s'est av√©r√© qu'il ne s'agit pas d'un bogue de s√©curit√©. Il existe des cas d'utilisation o√π les clients souhaitent configurer le proxy ou le routage personnalis√© pour le trafic vers les API AWS. J'ai d√©cid√© de documenter et de partager ce comportement car il pourrait √™tre utile pour d'autres testeurs de p√©n√©tration cloud.

### D√©couverte <a href="#discovery" id="discovery"></a>

La d√©couverte a commenc√© en jouant avec route53, en cr√©ant d'abord la zone h√©berg√©e pour amazonaws.com, qui a √©chou√© :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

J'ai essay√© la m√™me chose pour us-east-1.amazonaws.com, qui a donn√© les m√™mes r√©sultats :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Mais √† ma grande surprise, secretsmanager.us-east-1.amazonaws.com a fonctionn√© :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Maintenant, on peut cr√©er un enregistrement A pour secretsmanager.us-east-1.amazonaws.com pointant vers une adresse IP interne √† l'int√©rieur du VPC :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

En simulant la liste des secrets sur la machine victime et sur la machine de l'attaquant, nous recevons la connexion qui est un trafic chiffr√© TLS :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

La communication est chiffr√©e en TLS, mais si les applications dans le VPC font confiance √† la CA priv√©e g√©r√©e par l'ACM-PCA et que l'attaquant dispose des autorisations IAM pour contr√¥ler cette CA priv√©e dans l'ACM-PCA, il serait possible de faire une interception de l'homme du milieu compl√®te et d'escalader les priv