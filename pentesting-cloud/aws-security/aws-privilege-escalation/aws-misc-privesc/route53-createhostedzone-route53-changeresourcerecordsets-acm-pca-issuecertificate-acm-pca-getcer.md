# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 仓库提交 PR 来分享您的黑客技巧。**

</details>

**研究来源：**[**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## 劫持 AWS API 调用

### 使用 Route53 修改和 ACM-PCA 证书

发布于 2022 年 3 月 11 日

前段时间，我对 AWS 中可能存在的中间人攻击进行了一些研究。本博文描述了这项研究的结果，并展示了一种提升 AWS VPC 中 IAM 权限的有趣方法。

让我们从攻击者已接管允许对 Route53 进行修改并由 ACM-PCA 签署私有 CA 证书的 IAM 角色的先决条件开始。

要执行相同的利用，角色必须具有的最低 IAM 权限为：
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
其他IAM权限可以用于枚举，但不是利用的必要条件：
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
一旦攻击者在route53和acm-pca上拥有最低的IAM权限，他或她将能够劫持对AWS API的调用，并成功升级AWS部署中的IAM权限-通过将劫持的AWS API调用转发到相关的VPC终端节点并读取响应，例如secretsmanager:GetSecretValue调用。

我对此感到惊讶，因为我错误地认为：1）AWS SDK使用某种证书固定，2）route53和acm-pca都不允许控制AWS内部域名。

所有这些假设都是不正确的。已经咨询了AWS安全团队，但结果表明这不是一个安全漏洞。有一些用例需要客户为流量到AWS API设置代理或自定义路由。我决定记录并分享这种行为，因为它可能对其他云渗透测试人员有用。

### 发现 <a href="#discovery" id="discovery"></a>

发现始于对route53的探索，首先尝试为amazonaws.com创建托管区域，但失败了：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

我尝试了us-east-1.amazonaws.com，结果相同：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

但令我惊讶的是，secretsmanager.us-east-1.amazonaws.com起作用了：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

现在，可以为secretsmanager.us-east-1.amazonaws.com创建指向VPC内部IP的A记录：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

模拟受害者在受害者机器上列出秘密，在攻击者的机器上接收到TLS加密的流量：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

通信是TLS加密的，但如果VPC中的应用程序信任由ACM-PCA管理的私有CA，并且攻击者具有IAM权限来控制ACM-PCA中的私有CA，那么就可以进行完全的中间人攻击并升级IAM权限。

### 利用 <a href="#exploitation" id="exploitation"></a>

您可以在此处观看整个利用过程：

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

如果您更喜欢阅读并查看屏幕截图，请继续阅读。

为了演示目的，假设攻击者入侵了具有以下IAM角色的ec2之一：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

在现实世界中，ec2不应具有如此广泛的权限，但您可能会遇到一些开发人员或DevOps角色具有此类权限。

具有特权IAM角色的受损ec2的内部IP为10.0.0.87，受害者应用程序运行在具有IP 10.0.0.224的ec2上。

现在，在攻击者拥有的机器上，我们为secretsmanager.us-east-1.amazonaws.com创建托管区域：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

然后将A记录设置为将secretsmanager.us-east-1.amazonaws.com指向10.0.0.87：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

我们知道ACM-PCA中定义了一个私有CA：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

运行在受害者机器（10.0.0.224）上的Java应用程序信任此私有CA以签署Web服务证书。私有CA位于Java TrustStore中。

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

现在，在攻击者的机器上，我们生成私钥和CSR。然后，我们调用acm-ca以由私有CA签署的证书。API响应包含已签署的证书ARN：![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

然后，攻击者从ACM-PCA检索已签署的证书：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

为了模拟Java应用程序从受害者机器调用Secrets Manager，我通过maven运行了JUnit测试，在下面的屏幕截图中，您可以看到没有异常，这意味着证书是受信任的：![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

最后，在ncat侦听器中，我们可以看到Java应用程序从AWS SDK发送的HTTP请求。![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

如何利用这一点来升级IAM权限？我们没有权限对任何s3对象执行s3:GetObject操作，也没有权限执行secretsmanager:GetSecretValue操作，但是如果我们嗅探到与这些调用相关的S3或secretsmanager的流量，我们可以将请求转发到相应的VPCE，并获得对存储在S3中的对象或存储在secretsmanager中的秘密的访问权限。
### 结论 <a href="#conclusions" id="conclusions"></a>

建议避免在创建私有托管区域或无限制的route53:ChangeResourceRecordSets方面使用广泛的route53 IAM权限。由于ACM-PCA不允许对私有CA可以签署的域名证书应用限制，因此建议特别注意acm-pca:IssueCertificate IAM权限。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品，[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
