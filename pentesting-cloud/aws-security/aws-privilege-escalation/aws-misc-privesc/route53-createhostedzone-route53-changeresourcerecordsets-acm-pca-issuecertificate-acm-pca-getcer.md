# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社の広告を見たい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

**リサーチのコピー元:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## AWS API呼び出しのハイジャック

### Route53の変更とACM-PCA証明書を使用する

2022年3月11日に投稿

以前、AWSでの可能な中間者攻撃について調査を行いました。このブログ投稿では、この調査の結果と、AWS VPCでIAM特権をエスカレーションする興味深い方法を示します。

まず、攻撃者がIAMロールを乗っ取り、Route53の変更とACM-PCAから署名された証明書を発行することを許可する権限を持っているという前提条件から始めましょう。

同じ攻撃を行うために、ロールが持っている必要最低限のIAM権限は次のとおりです：
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
他のIAM権限は列挙に役立つかもしれませんが、攻撃を行うためには必須ではありません。
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
一旦攻撃者がroute53とacm-pcaの最小限のIAM権限を持っている場合、彼または彼女はAWS APIへの呼び出しを乗っ取り、IAM特権をAWSデプロイメントで成功裏にエスカレーションすることができます。これは、乗っ取ったAWS API呼び出しを関連するVPCエンドポイントに転送し、例えばsecretsmanager:GetSecretValue呼び出しの応答を読み取ることによって実現されます。

私はこれが可能であることに驚きました。なぜなら、1) AWS SDKがある種の証明書ピニングを使用しているという誤った前提、2) route53とacm-pcaの両方がAWSの内部ドメイン名を制御することを許可しないという前提があったからです。

これらの前提はすべて誤りです。AWSセキュリティに相談しましたが、これはセキュリティ上のバグではないことが判明しました。クライアントがトラフィックをAWS APIに対してプロキシまたはカスタムルーティングを設定したい場合があるため、この動作を文書化して共有することにしました。他のクラウドペンテスターにとって有用かもしれません。

### 発見 <a href="#discovery" id="discovery"></a>

発見は、まずamazonaws.comのホストゾーンを作成することから始まりましたが、失敗しました：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

次にus-east-1.amazonaws.comに対して同じことを試しましたが、同じ結果が得られました：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

しかし驚いたことに、secretsmanager.us-east-1.amazonaws.comは動作しました：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

これで、secretsmanager.us-east-1.amazonaws.comのAレコードをVPC内の内部IPを指すように作成できます：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

被害者マシンでシークレットをリストアップするシミュレーションを行い、攻撃者のマシンでは応答を受け取ります。通信はTLSで暗号化されています：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

通信はTLSで暗号化されていますが、VPC内のアプリケーションがACM-PCAで管理されるプライベートCAを信頼し、攻撃者がACM-PCAでそのプライベートCAを制御するIAM権限を持っている場合、完全な中間者攻撃（Man-In-The-Middle）を行い、IAM特権をエスカレーションすることが可能です。

### 悪用 <a href="#exploitation" id="exploitation"></a>

完全な悪用の様子はこちらでご覧いただけます：

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

スクリーンショットを読んで進む場合は、以下をご覧ください。

デモンストレーションのために、攻撃者が次のIAMロールを仮定してec2の1つを侵害したとします：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

実際の世界では、ec2にはこのような広範な権限を持つべきではありませんが、開発者やDevOpsの役割に遭遇することがあります。

特権のあるIAMロールを持つ侵害されたec2の内部IPは10.0.0.87であり、被害者アプリケーションはIPが10.0.0.224のec2で実行されています。

攻撃者の所有するマシンで、secretsmanager.us-east-1.amazonaws.comのホストゾーンを作成します：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

次に、secretsmanager.us-east-1.amazonaws.comのAレコードを10.0.0.87を指すように設定します：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

ACM-PCAに定義されたプライベートCAが存在することを知っています：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

被害者マシン（10.0.0.224）で実行されているJavaアプリケーションは、このプライベートCAを信頼してWebサービス証明書に署名するためにこのプライベートCAを信頼しています。プライベートCAはJava TrustStoreにあります。

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

攻撃者のマシンで、プライベートキーとCSRを生成します。そして、acm-caを呼び出してプライベートCAによって署名された証明書を発行します。APIは署名された証明書のARNで応答します： ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

次に、攻撃者はACM-PCAから署名された証明書を取得します：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

被害者のマシンからSecrets ManagerへのJavaアプリケーションの呼び出しをシミュレートするために、JUnitテストをmavenを介して実行しました。以下のスクリーンショットでは、例外が発生していないことがわかります。これは、証明書が信頼されていることを意味します： ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

最後に、ncatリスナーでJavaアプリケーションから送信されたHTTPリクエストが表示されます。 ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

どのようにしてIAM特権をエスカレーションするのでしょうか？私たちはs3:GetObjectやsecretsmanager:GetSecretValueの権限を持っていませんが、これらの呼び出しでのトラフィックをスニフィングし、リクエストを対応するVPCEに転送することで、S3に格納されているオブジェクトにアクセスしたり、secretsmanagerに格納されているシークレットにアクセスしたりすることができます。
### 結論 <a href="#conclusions" id="conclusions"></a>

プライベートホストゾーンの作成や制限のないroute53:ChangeResourceRecordSetsに関する広範なroute53 IAM権限は避けることをおすすめします。また、ACM-PCAでは、プライベートCAによって署名されるドメインの証明書を制限することはできないため、acm-pca:IssueCertificate IAM権限に特に注意を払うこともおすすめします。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリに**PRを提出**することで、あなたのハッキングトリックを共有しましょう。

</details>
