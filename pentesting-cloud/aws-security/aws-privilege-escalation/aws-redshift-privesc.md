# AWS - Escalada de privilegios en Redshift

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si deseas ver a **tu empresa anunciada en HackTricks** o si deseas acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Redshift

Para obtener m√°s informaci√≥n sobre RDS, consulte:

{% content-ref url="../aws-services/aws-databases/aws-redshift-enum.md" %}
[aws-redshift-enum.md](../aws-services/aws-databases/aws-redshift-enum.md)
{% endcontent-ref %}

### `redshift:DescribeClusters`, `redshift:GetClusterCredentials`

Con estos permisos, puede obtener **informaci√≥n de todos los cl√∫steres** (incluido el nombre y el nombre de usuario del cl√∫ster) y **obtener credenciales** para acceder a √©l:

```bash
# Obtener credenciales
aws redshift get-cluster-credentials --db-user postgres --cluster-identifier redshift-cluster-1
# Conectar, incluso si la contrase√±a es una cadena base64, esa es la contrase√±a
psql -h redshift-cluster-1.asdjuezc439a.us-east-1.redshift.amazonaws.com -U "IAM:<username>" -d template1 -p 5439
```

**Impacto potencial:** Encontrar informaci√≥n confidencial dentro de las bases de datos.

### `redshift:DescribeClusters`, `redshift:GetClusterCredentialsWithIAM`

Con estos permisos, puede obtener **informaci√≥n de todos los cl√∫steres** y **obtener credenciales** para acceder a √©l.\
Tenga en cuenta que el usuario postgres tendr√° los **permisos que la identidad IAM** utilizada para obtener las credenciales tiene.

```bash
# Obtener credenciales
aws redshift get-cluster-credentials-with-iam --cluster-identifier redshift-cluster-1
# Conectar, incluso si la contrase√±a es una cadena base64, esa es la contrase√±a
psql -h redshift-cluster-1.asdjuezc439a.us-east-1.redshift.amazonaws.com -U "IAMR:AWSReservedSSO_AdministratorAccess_4601154638985c45" -d template1 -p 5439
```

**Impacto potencial:** Encontrar informaci√≥n confidencial dentro de las bases de datos.

### `redshift:DescribeClusters`, `redshift:ModifyCluster?`

Es posible **modificar la contrase√±a maestra** del usuario postgres interno (redshit) desde aws cli (creo que esos son los permisos que necesita, pero a√∫n no los he probado):

```
aws redshift modify-cluster ‚Äìcluster-identifier <identifier-for-the cluster> ‚Äìmaster-user-password ‚Äòmaster-password‚Äô;
```

**Impacto potencial:** Encontrar informaci√≥n confidencial dentro de las bases de datos.

## Acceso a servicios externos

{% hint style="warning" %}
Para acceder a todos los recursos siguientes, deber√° **especificar el rol a utilizar**. Un cl√∫ster Redshift **puede tener asignada una lista de roles de AWS** que puede utilizar **si conoce el ARN** o simplemente puede establecer "**default**" para utilizar el asignado por defecto.

Adem√°s, como se explica [**aqu√≠**](https://docs.aws.amazon.com/redshift/latest/mgmt/authorizing-redshift-service.html), Redshift tambi√©n permite concatenar roles (siempre y cuando el primero pueda asumir el segundo) para obtener un mayor acceso, pero simplemente **separ√°ndolos** con una **coma**: `iam_role 'arn:aws:iam::123456789012:role/RoleA,arn:aws:iam::210987654321:role/RoleB';`
{% endhint %}

### Lambdas

Como se explica en [https://docs.aws.amazon.com/redshift/latest/dg/r\_CREATE\_EXTERNAL\_FUNCTION.html](https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_EXTERNAL_FUNCTION.html), es posible **llamar a una funci√≥n lambda desde redshift** con algo como:

```sql
CREATE EXTERNAL FUNCTION exfunc_sum2(INT,INT) 
RETURNS INT 
STABLE 
LAMBDA 'lambda_function' 
IAM_ROLE default;
```

### S3

Como se explica en [https://docs.aws.amazon.com/redshift/latest/dg/tutorial-loading-run-copy.html](https://docs.aws.amazon.com/redshift/latest/dg/tutorial-loading-run-copy.html), es posible **leer y escribir en los buckets de S3**:

```sql
# Leer
copy table from 's3://<your-bucket-name>/load/key_prefix' 
credentials 'aws_iam_role=arn:aws:iam::<aws-account-id>:role/<role-name>'
region '<region>'
options;

# Escribir
unload ('select * from venue')   
to 's3://mybucket/tickit/unload/venue_' 
iam_role default;
```

### Dynamo

Como se explica en [https://docs.aws.amazon.com/redshift/latest/dg/t\_Loading-data-from-dynamodb.html](https://docs.aws.amazon.com/redshift/latest/dg/t_Loading-data-from-dynamodb.html), es posible **obtener datos de dynamodb**:

```sql
copy favoritemovies 
from 'dynamodb://ProductCatalog'
iam_role 'arn:aws:iam::0123456789012:role/MyRedshiftRole';
```

{% hint style="warning" %}
La tabla de Amazon DynamoDB que proporciona los datos debe crearse en la misma regi√≥n de AWS que su cl√∫ster a menos que use la opci√≥n [REGION](https://docs.aws.amazon.com/redshift/latest/dg/copy-parameters-data-source-s3.html#copy-region) para especificar la regi√≥n de AWS en la que se encuentra la tabla de Amazon DynamoDB.
{% endhint %}

### EMR

Consulte [https://docs.aws.amazon.com/redshift/latest/dg/loading-data-from-emr.html](https://docs.aws.amazon.com/redshift/latest/dg/loading-data-from-emr.html)