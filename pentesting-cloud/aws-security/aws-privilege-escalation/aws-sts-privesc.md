# AWS - STS 권한 상승

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 상품**](https://peass.creator-spring.com)을 구매하세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 기법을 공유**하세요.

</details>

## STS

### `sts:AssumeRole`

모든 역할은 **역할 신뢰 정책**과 함께 생성됩니다. 이 정책은 **어떤 계정이 생성된 역할을 가정할 수 있는지**를 나타냅니다. **동일한 계정**의 역할이 특정 계정이 가정할 수 있다고 말하면, 해당 계정은 역할에 액세스할 수 있으며 (그리고 잠재적으로 **권한 상승**할 수 있습니다).

예를 들어, 다음 역할 신뢰 정책은 누구나 가정할 수 있다고 나타내므로, **어떤 사용자든지 해당 역할과 관련된 권한 상승**을 할 수 있습니다.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
다음 명령을 실행하여 역할을 위장할 수 있습니다:
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**잠재적 영향:** 역할에 대한 권한 상승.

{% hint style="danger" %}
이 경우에는 권한 `sts:AssumeRole`이 **악용할 역할에 표시**되어야 하며, 공격자에게 속한 정책에는 포함되어서는 안됩니다.\
다른 계정에서 역할을 **가정**하기 위해서는 공격자 계정도 역할에 대한 **`sts:AssumeRole`**을 가져야 합니다.
{% endhint %}

### `sts:AssumeRoleWithSAML`

이 역할을 가진 신뢰 정책은 **SAML을 통해 인증된 사용자가 역할을 가장할 수 있는 권한을 부여합니다.**

이 권한을 가진 신뢰 정책의 예시는 다음과 같습니다:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
일반적으로 역할을 위장하기 위해 자격 증명을 생성하려면 다음과 같이 사용할 수 있습니다:
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
하지만 **공급업체**는 [onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role)과 같은 **자체 도구**를 사용하여 이를 더 쉽게 만들 수 있습니다:

{% code overflow="wrap" %}
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
{% endcode %}

**잠재적인 영향:** 역할에 대한 권한 상승.

### `sts:AssumeRoleWithWebIdentity`

이 권한은 웹 신원 제공자로 인증된 사용자들에게 일시적인 보안 자격 증명을 얻을 수 있는 권한을 부여합니다. 이는 모바일, 웹 애플리케이션, EKS 등에서 인증된 사용자들에게 적용됩니다. [여기에서 자세히 알아보세요.](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)

예를 들어, **EKS 서비스 계정**이 **IAM 역할을 가장할 수** 있어야 하는 경우, **`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`**에 토큰이 있으며, 다음과 같이 역할을 가장하고 자격 증명을 얻을 수 있습니다:

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
{% endcode %}

### 연합 남용

{% content-ref url="../aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* 회사를 **HackTricks에서 광고**하거나 **PDF로 HackTricks를 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
