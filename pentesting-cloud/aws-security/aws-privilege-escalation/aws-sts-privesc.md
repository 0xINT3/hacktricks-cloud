# AWS - STS特権エスカレーション

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をハックトリックで広告表示したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆ハックトリックのグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## STS

### `sts:AssumeRole`

すべてのロールは、**ロール信頼ポリシー**と呼ばれるもので作成されます。このポリシーは、**どのアカウントが作成されたロールを引き受けることができるか**を示しています。同じアカウントのロールが、アカウントが引き受けることができると言っている場合、そのアカウントはそのロールにアクセスできるようになります（そして潜在的に**特権エスカレーション**が可能です）。

例えば、以下のロール信頼ポリシーは、誰でも引き受けることができると示しているため、**どのユーザーでもそのロールに特権エスカレーション**できます。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
あなたは次のコマンドを実行することで、ロールをなりすますことができます：

```bash
aws sts assume-role --role-arn <role_arn> --role-session-name <session_name>
```

このコマンドでは、`<role_arn>`になりたいロールのARN（Amazon Resource Name）を指定し、`<session_name>`にセッションの名前を指定します。これにより、指定したロールの権限を取得し、そのロールとしてAWSリソースにアクセスすることができます。
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**潜在的な影響:** ロールへの特権昇格。

{% hint style="danger" %}
この場合、権限`sts:AssumeRole`は攻撃者のポリシーではなく、**悪用するロールに指定する必要があります**。ただし、異なるアカウントからロールを**引き継ぐためには**、攻撃者のアカウントもロールに対して**`sts:AssumeRole`**を持っている必要があります。
{% endhint %}

### `sts:AssumeRoleWithSAML`

このロールに対して信頼ポリシーがある場合、**SAML経由で認証されたユーザーがロールをなりすますことができます。**

この権限を持つ信頼ポリシーの例は以下の通りです：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
一般的に、役割をなりすますための資格情報を生成するには、次のような方法を使用できます。
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
しかし、**プロバイダー**は、[onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role)のような**独自のツール**を使用して、これを容易にする場合があります：

{% code overflow="wrap" %}
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
{% endcode %}

**潜在的な影響:** ロールへの特権昇格。

### `sts:AssumeRoleWithWebIdentity`

この権限は、モバイル、Webアプリケーション、EKSなどで認証されたユーザーに一時的なセキュリティ資格情報を取得する権限を付与します。[ここで詳細を学ぶ。](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)

例えば、**EKSサービスアカウント**が**IAMロールをなりすます**ことができるようにする場合、**`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`**にトークンがあり、次のような操作で**ロールを引き受けて資格情報を取得**することができます：

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
{% endcode %}

### フェデレーションの悪用

{% content-ref url="../aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有しましょう。

</details>
