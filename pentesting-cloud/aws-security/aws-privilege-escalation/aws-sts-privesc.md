# AWS - STS Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## STS

### `sts:AssumeRole`

すべてのロールは**ロール信頼ポリシー**とともに作成されます。このポリシーは**誰が作成されたロールを引き受けることができるか**を示します。**同じアカウント**のロールがアカウントがそれを引き受けることができると言っている場合、それはアカウントがロールにアクセスできる（そして潜在的に**privesc**することができる）ことを意味します。

例えば、以下のロール信頼ポリシーは誰でも引き受けることができると示しているため、**任意のユーザーがそのロールに関連付けられた権限にprivescすることができます**。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": "sts:AssumeRole"
}
]
}
```
役割を模倣するには、以下を実行します：
```bash
aws sts assume-role --role-arn $ROLE_ARN --role-session-name sessionname
```
**潜在的な影響：** ロールへの権限昇格。

{% hint style="danger" %}
このケースでは、`sts:AssumeRole` 権限が攻撃者に属するポリシーではなく、**悪用するロールに** **指定されている必要があります。**
ただし、例外として、**異なるアカウントからロールを引き受ける**ためには、攻撃者アカウントもそのロールに対して **`sts:AssumeRole`** を **持っている必要があります。**
{% endhint %}

### `sts:AssumeRoleWithSAML`

このロールの信頼ポリシーは、**SAML経由で認証されたユーザーにロールのなりすましを許可します。**

この権限を持つ信頼ポリシーの例は以下の通りです：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "OneLogin",
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::290594632123:saml-provider/OneLogin"
},
"Action": "sts:AssumeRoleWithSAML",
"Condition": {
"StringEquals": {
"SAML:aud": "https://signin.aws.amazon.com/saml"
}
}
}
]
}
```
役割を一般的に模倣するための認証情報を生成するには、次のようなものを使用できます：
```bash
aws sts  assume-role-with-saml --role-arn <value> --principal-arn <value>
```
しかし、**プロバイダー**はこれを容易にするための**独自のツール**を持っているかもしれません。例えば、[onelogin-aws-assume-role](https://github.com/onelogin/onelogin-python-aws-assume-role)のように：

{% code overflow="wrap" %}
```bash
onelogin-aws-assume-role --onelogin-subdomain mettle --onelogin-app-id 283740 --aws-region eu-west-1 -z 3600
```
{% endcode %}

**潜在的な影響：** ロールへの権限昇格。

### `sts:AssumeRoleWithWebIdentity`

この権限は、**モバイル、ウェブアプリケーション、EKS...** で認証されたユーザーに一時的なセキュリティ認証情報を取得する権限を付与します。[こちらで詳細を学ぶ。](https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRoleWithWebIdentity.html)

例えば、**EKSサービスアカウント**が**IAMロールをなりすます**ことができるようにする場合、**`/var/run/secrets/eks.amazonaws.com/serviceaccount/token`** にトークンがあり、ロールを**想定して認証情報を取得する**ことができます。

{% code overflow="wrap" %}
```bash
aws sts assume-role-with-web-identity --role-arn arn:aws:iam::123456789098:role/<role_name> --role-session-name something --web-identity-token file:///var/run/secrets/eks.amazonaws.com/serviceaccount/token
# The role name can be found in the metadata of the configuration of the pod
```
### フェデレーションの悪用

{% content-ref url="../aws-basic-information/aws-federation-abuse.md" %}
[aws-federation-abuse.md](../aws-basic-information/aws-federation-abuse.md)
{% endcontent-ref %}

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
