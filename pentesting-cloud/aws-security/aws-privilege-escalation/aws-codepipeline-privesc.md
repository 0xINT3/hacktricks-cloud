# AWS - Codepipeline提权

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS红队专家）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在**Twitter**上关注我们 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## codepipeline

有关codepipeline的更多信息，请查看：

{% content-ref url="../aws-services/aws-datapipeline-codepipeline-codebuild-and-codecommit.md" %}
[aws-datapipeline-codepipeline-codebuild-and-codecommit.md](../aws-services/aws-datapipeline-codepipeline-codebuild-and-codecommit.md)
{% endcontent-ref %}

### `iam:PassRole`, `codepipeline:CreatePipeline`, `codebuild:CreateProject, codepipeline:StartPipelineExecution`

在创建codepipeline时，您可以指定一个**codepipeline IAM角色来运行**，因此您可能会 compromise them。

除了之前的权限外，您还需要**访问存储代码的位置**（S3、ECR、github、bitbucket...）

我在网页上测试了这个过程，之前提到的权限不是创建codepipeline所需的List/Get权限，但是在网页上创建时，您还需要：`codebuild:ListCuratedEnvironmentImages, codebuild:ListProjects, codebuild:ListRepositories, codecommit:ListRepositories, events:PutTargets, codepipeline:ListPipelines, events:PutRule, codepipeline:ListActionTypes, cloudtrail:<several>`

在**创建构建项目**时，您可以指定要运行的**命令**（反向shell？）并将构建阶段作为**特权用户**运行，这是攻击者需要 compromise 的配置：

![](<../../../.gitbook/assets/image (53).png>)

![](<../../../.gitbook/assets/image (64).png>)

### ?`codebuild:UpdateProject, codepipeline:UpdatePipeline, codepipeline:StartPipelineExecution`

可能可以使用先前的权限修改在codepipeline上使用的角色和执行的命令。

### `codepipeline:pollforjobs`

[AWS提到](https://docs.aws.amazon.com/codepipeline/latest/APIReference/API\_PollForJobs.html)：

> 当调用此API时，CodePipeline会为用于存储管道的工件的S3存储桶**返回临时凭证**，如果操作需要访问该S3存储桶以获取输入或输出工件。此API还**返回为操作定义的任何秘密值**。
