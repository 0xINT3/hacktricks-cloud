# AWS - Codestar Privesc

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* もし、あなたの**会社をハックトリックで宣伝したい**場合や、**PEASSの最新バージョンやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するために、PRを提出して** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに参加しましょう。**

</details>

## Codestar

Codestarに関する詳細情報は以下で見つけることができます：

{% content-ref url="codestar-createproject-codestar-associateteammember.md" %}
[codestar-createproject-codestar-associateteammember.md](codestar-createproject-codestar-associateteammember.md)
{% endcontent-ref %}

### `iam:PassRole`, `codestar:CreateProject`

これらの権限を使用すると、**codestar IAMロール**を悪用して、**クラウドフォーメーションテンプレート**を介して**任意のアクション**を実行することができます。次のページをチェックしてください：

{% content-ref url="iam-passrole-codestar-createproject.md" %}
[iam-passrole-codestar-createproject.md](iam-passrole-codestar-createproject.md)
{% endcontent-ref %}

### `codestar:CreateProject`, `codestar:AssociateTeamMember`

このテクニックでは、`codestar:CreateProject`を使用してcodestarプロジェクトを作成し、`codestar:AssociateTeamMember`を使用してIAMユーザーを新しいCodeStarプロジェクトの**オーナー**にすることができます。これにより、彼らには**いくつかの追加の権限を持つ新しいポリシー**が付与されます。
```bash
PROJECT_NAME="supercodestar"

aws --profile "$NON_PRIV_PROFILE_USER" codestar create-project \
--name $PROJECT_NAME \
--id $PROJECT_NAME

echo "Waiting 1min to start the project"
sleep 60

USER_ARN=$(aws --profile "$NON_PRIV_PROFILE_USER" opsworks describe-my-user-profile | jq .UserProfile.IamUserArn | tr -d '"')

aws --profile "$NON_PRIV_PROFILE_USER" codestar associate-team-member \
--project-id $PROJECT_NAME \
--user-arn "$USER_ARN" \
--project-role "Owner" \
--remote-access-allowed
```
もしすでに**プロジェクトのメンバー**である場合、`codestar:AssociateTeamMember`の代わりに**`codestar:UpdateTeamMember`**権限を使用して、**役割をオーナーに更新**することができます。

**潜在的な影響:** codestarポリシーへの特権昇格。そのポリシーの例は以下で見つけることができます：

{% content-ref url="codestar-createproject-codestar-associateteammember.md" %}
[codestar-createproject-codestar-associateteammember.md](codestar-createproject-codestar-associateteammember.md)
{% endcontent-ref %}

### `codestar:CreateProjectFromTemplate`

1. **`codestar:CreateProjectFromTemplate`**を使用して新しいプロジェクトを作成します。
1. "CodeStarWorker-\<プロジェクト名>-CloudFormation" IAMロールが渡されたスタックに対して**`cloudformation:UpdateStack`**へのアクセス権が付与されます。
2. CloudFormationの権限を使用して、ターゲットスタックを選択したCloudFormationテンプレートで更新します。
1. 更新するスタックの名前は、使用されるテンプレートによって"awscodestar-\<プロジェクト名>-infrastructure"または"awscodestar-\<プロジェクト名>-lambda"になります（少なくとも例のエクスプロイトスクリプトでは）。

この時点で、**CloudFormation IAMロール**に付与された権限への**完全なアクセス**が可能になります。ただし、これだけでは完全な管理者権限を取得することはできません。環境内の他の設定ミスのリソースが必要です。

詳細は、元の研究を参照してください：[https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/](https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/)。\
エクスプロイトは[https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/codestar\_createprojectfromtemplate\_privesc/CodeStarPrivEsc.py](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/codestar\_createprojectfromtemplate\_privesc/CodeStarPrivEsc.py)で見つけることができます。

**潜在的な影響:** cloudformation IAMロールへの特権昇格。

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝**したい場合や、**PEASSの最新バージョンにアクセス**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを発見しましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングのトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出してください。

</details>
