# Pentesting de AWS

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>

## Informaci칩n b치sica

**Antes de comenzar a pentesting** un entorno de **AWS**, hay algunas **cosas b치sicas que debes saber** sobre c칩mo funciona AWS para ayudarte a entender lo que necesitas hacer, c칩mo encontrar configuraciones incorrectas y c칩mo explotarlas.

Conceptos como la jerarqu칤a de organizaci칩n, IAM y otros conceptos b치sicos se explican en:

{% content-ref url="aws-basic-information/" %}
[aws-basic-information](aws-basic-information/)
{% endcontent-ref %}

## Laboratorios para aprender

* [https://github.com/RhinoSecurityLabs/cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
* [https://hackingthe.cloud/aws/capture\_the\_flag/cicdont/](https://hackingthe.cloud/aws/capture\_the\_flag/cicdont/)
* [https://github.com/BishopFox/iam-vulnerable](https://github.com/BishopFox/iam-vulnerable)
* [http://flaws.cloud/](http://flaws.cloud/)
* [http://flaws2.cloud/](http://flaws2.cloud/)
* [https://github.com/nccgroup/sadcloud](https://github.com/nccgroup/sadcloud)
* [https://github.com/bridgecrewio/terragoat](https://github.com/bridgecrewio/terragoat)
* [https://github.com/ine-labs/AWSGoat](https://github.com/ine-labs/AWSGoat)

## Metodolog칤a de Pentester/Red Team de AWS

Para auditar un entorno de AWS es muy importante saber: qu칠 **servicios se est치n utilizando**, qu칠 se est치 **exponiendo**, qui칠n tiene **acceso** a qu칠 y c칩mo se conectan los servicios internos de AWS y los servicios externos.

Desde el punto de vista de Red Team, el **primer paso para comprometer un entorno de AWS** es lograr obtener algunas **credenciales**. Aqu칤 tienes algunas ideas sobre c칩mo hacerlo:

* **Fugas** en github (o similar) - OSINT
* **Ingenier칤a** social
* Reutilizaci칩n de **contrase침as** (filtraciones de contrase침as)
* Vulnerabilidades en aplicaciones alojadas en AWS
  * [**Falsificaci칩n de petici칩n en servidor**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) con acceso al punto final de metadatos
  * **Lectura de archivo local**
    * `/home/USERNAME/.aws/credentials`
    * `C:\Users\USERNAME\.aws\credentials`
* Terceros **violados**
* Empleado **interno**
* Credenciales de [**Cognito** ](aws-services/aws-cognito-enum/#cognito)

O mediante la **compromiso de un servicio no autenticado** expuesto:

{% content-ref url="aws-unauthenticated-enum-access/" %}
[aws-unauthenticated-enum-access](aws-unauthenticated-enum-access/)
{% endcontent-ref %}

O si est치s haciendo una **revisi칩n**, simplemente puedes **solicitar credenciales** con estos roles:

{% content-ref url="aws-permissions-for-a-pentest.md" %}
[aws-permissions-for-a-pentest.md](aws-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Despu칠s de haber logrado obtener credenciales, necesitas saber **a qui칠n pertenecen esas credenciales** y **a qu칠 tienen acceso**, por lo que necesitas realizar una enumeraci칩n b치sica:
{% endhint %}

## Enumeraci칩n b치sica

### SSRF

Si encontraste un SSRF en una m치quina dentro de AWS, consulta esta p치gina para obtener trucos:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Whoami

Una de las primeras cosas que debes saber es qui칠n eres (en qu칠 cuenta est치s en otra informaci칩n sobre el entorno de AWS):

```bash
# La forma m치s f치cil, pero puede ser monitoreado?
aws sts get-caller-identity
aws iam get-user # Esto obtendr치 tu propio usuario

# Si tienes un ID de clave
aws sts get-access-key-info --access-key-id=ASIA1234567890123456

# Obtener dentro del mensaje de error
aws sns publish --topic-arn arn:aws:sns:us-east-1:*account id*:aaa --message aaa

# Desde metadatos
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/dynamic/instance-identity/document
```

{% hint style="danger" %}
Ten en cuenta que las empresas pueden usar **tokens canarios** para identificar cu치ndo se est치n robando y utilizando **tokens**. Se recomienda verificar si un token es un token canario o no antes de usarlo.\
Para obtener m치s informaci칩n, [**consulte esta p치gina**](aws-services/aws-security-and-detection-services/aws-cloudtrail-enum.md#honeytokens-bypass).
{% endhint %}

### Enumeraci칩n de organizaci칩n

{% content-ref url="../aws-pentesting/aws-services/aws-organizations-enum.md" %}
[aws-organizations-enum.md](../aws-pentesting/aws-services/aws-organizations-enum.md)
{% endcontent-ref %}

### Enumeraci칩n de IAM

Si tienes suficientes permisos, **verificar los privilegios de cada entidad dentro de la cuenta de AWS** te ayudar치 a comprender lo que t칰 y otras identidades pueden hacer y c칩mo **escalar privilegios**.

Si no tienes suficientes permisos para enumerar IAM, puedes **robarlos por fuerza bruta** para descubrirlos.
## Herramientas Automatizadas

### Reconocimiento

* [**aws-recon**](https://github.com/darkbitio/aws-recon): Una herramienta de recolecci칩n de inventario de seguridad de AWS enfocada en la seguridad, escrita en Ruby y con m칰ltiples hilos.

```bash
# Instalar
gem install aws_recon

# Reconocimiento y obtener json
AWS_PROFILE=<profile> aws_recon \
  --services S3,EC2 \
  --regions global,us-east-1,us-east-2 \
  --verbose
```

* [**cloudlist**](https://github.com/projectdiscovery/cloudlist): Cloudlist es una herramienta multi-nube para obtener activos (nombres de host, direcciones IP) de proveedores de nube.
* [**cloudmapper**](https://github.com/duo-labs/cloudmapper): CloudMapper te ayuda a analizar tus entornos de Amazon Web Services (AWS). Ahora contiene mucha m치s funcionalidad, incluyendo auditor칤a para problemas de seguridad.

```bash
# Pasos de instalaci칩n en github
# Crear un archivo config.json con la informaci칩n de aws, como:
{
    "accounts": [
        {
            "default": true,
            "id": "<account id>",
            "name": "dev"
        }
    ],
    "cidrs":
    {
        "2.2.2.2/28": {"name": "NY Office"}
    }
}

# Enumerar
python3 cloudmapper.py collect --profile dev
## N칰mero de recursos descubiertos
python3 cloudmapper.py stats --accounts dev

# Crear informe HTML
## En el informe encontrar치s toda la informaci칩n
python3 cloudmapper.py report --accounts dev

# Identificar posibles problemas
python3 cloudmapper.py audit --accounts dev --json > audit.json
python3 cloudmapper.py audit --accounts dev --markdow > audit.md
python3 cloudmapper.py iam_report --accounts dev

# Identificar administradores
## Los permisos que se buscan est치n en https://github.com/duo-labs/cloudmapper/blob/4df9fd7303e0337ff16a08f5e58f1d46047c4a87/shared/iam_audit.py#L163-L175
python3 cloudmapper.py find_admins --accounts dev

# Identificar elementos no utilizados
python3 cloudmapper.py find_unused --accounts dev

# Identificar recursos expuestos p칰blicamente
python3 cloudmapper.py public --accounts dev

python cloudmapper.py prepare #Preparar servidor web
python cloudmapper.py webserver #Mostrar servidor web
```

* [**cartography**](https://github.com/lyft/cartography): Cartography es una herramienta de Python que consolida los activos de infraestructura y las relaciones entre ellos en una vista de gr치fico intuitiva impulsada por una base de datos Neo4j.

```bash
# Instalar
pip install cartography
## En el momento de escribir esto, se necesita la versi칩n 3.5.* de neo4j

# Obtener informaci칩n de AWS
AWS_PROFILE=dev cartography --neo4j-uri bolt://127.0.0.1:7687 --neo4j-password-prompt  --neo4j-user neo4j
```

* [**starbase**](https://github.com/JupiterOne/starbase): Starbase recopila activos y relaciones de servicios y sistemas, incluyendo infraestructura en la nube, aplicaciones SaaS, controles de seguridad y m치s, en una vista de gr치fico intuitiva respaldada por la base de datos Neo4j.
* [**aws-inventory**](https://github.com/nccgroup/aws-inventory): (Usa python2) Esta es una herramienta que intenta descubrir todos los recursos de [AWS](https://docs.aws.amazon.com/general/latest/gr/glos-chap.html#resource) creados en una cuenta.
* [**aws\_public\_ips**](https://github.com/arkadiyt/aws\_public\_ips): Es una herramienta para obtener todas las direcciones IP p칰blicas (IPv4/IPv6) asociadas con una cuenta de AWS.

### Privesc y Explotaci칩n

* [**SkyArk**](https://github.com/cyberark/SkyArk)**:** Descubre los usuarios m치s privilegiados en el entorno de AWS escaneado, incluidos los administradores de sombra de AWS. Utiliza PowerShell. Puedes encontrar la definici칩n de las pol칤ticas privilegiadas en la funci칩n **`Check-PrivilegedPolicy`** en [https://github.com/cyberark/SkyArk/blob/master/AWStealth/AWStealth.ps1](https://github.com/cyberark/SkyArk/blob/master/AWStealth/AWStealth.ps1).
* [**pacu**](https://github.com/RhinoSecurityLabs/pacu): Pacu es un marco de explotaci칩n de AWS de c칩digo abierto, dise침ado para pruebas de seguridad ofensivas contra entornos en la nube. Puede enumerar, encontrar configuraciones incorrectas y explotarlas. Puedes encontrar la definici칩n de permisos privilegiados en [https://github.com/RhinoSecurityLabs/pacu/blob/866376cd711666c775bbfcde0524c817f2c5b181/pacu/modules/iam\_\_privesc\_scan/main.py#L134](https://github.com/RhinoSecurityLabs/pacu/blob/866376cd711666c775bbfcde0524c817f2c5b181/pacu/modules/iam\_\_privesc\_scan/main.py#L134) dentro del diccionario **`user_escalation_methods`**.
  * Ten en cuenta que pacu **solo verifica tus propias rutas de privesc** (no en toda la cuenta).

```bash
# Instalar
## Si칠ntete libre de usar venvs
pip3 install pacu

# Usa la CLI de pacu
pacu
> import_keys <profile_name> # importar 1 perfil de .aws/credentials
> import_keys --all # importar todos los perfiles
> list # listar m칩dulos
> exec iam__enum_permissions # Obtener permisos
> exec iam__privesc_scan # Listar permisos privilegiados
```

* [**PMapper**](https://github.com/nccgroup/PMapper): Principal Mapper (PMapper) es un script y una biblioteca para identificar riesgos en la configuraci칩n de AWS Identity and Access Management (IAM) para una cuenta de AWS o una organizaci칩n de AWS. Modela los diferentes usuarios y roles de IAM en una cuenta como un grafo dirigido, lo que permite comprobar la escalada de privilegios y las rutas alternativas que un atacante podr칤a tomar para obtener acceso a un recurso o acci칩n en AWS. Puedes comprobar los permisos utilizados para encontrar rutas de privesc en los nombres de archivo que terminan en `_edges.py` en [https://github.com/nccgroup/PMapper/tree/master/principalmapper/graphing](https://github.com/nccgroup/PMapper/tree/master/principalmapper/graphing)

```bash
# Instalar
pip install principalmapper

# Obtener datos
pmapper --profile dev graph create
pmapper --profile dev graph display # Mostrar informaci칩n b치sica
# Generar gr치fico
pmapper --profile dev visualize # Generar archivo de gr치fico svg (tambi칠n puede ser png, dot y graphml)
pmapper --profile dev visualize --only-privesc # Solo permisos de privesc

#
### Auditor칤a constante

* [**cloud-custodian**](https://github.com/cloud-custodian/cloud-custodian): Cloud Custodian es un motor de reglas para administrar cuentas y recursos de la nube p칰blica. Permite a los usuarios **definir pol칤ticas para habilitar una infraestructura en la nube bien administrada**, que sea segura y optimizada en costos. Consolida muchos de los scripts ad hoc que tienen las organizaciones en una herramienta ligera y flexible, con m칠tricas y reportes unificados.
* [**pacbot**](https://github.com/tmobile/pacbot)**: Policy as Code Bot (PacBot)** es una plataforma para **monitoreo continuo de cumplimiento, reporte de cumplimiento y automatizaci칩n de seguridad para la nube**. En PacBot, las pol칤ticas de seguridad y cumplimiento se implementan como c칩digo. Todos los recursos descubiertos por PacBot se eval칰an en funci칩n de estas pol칤ticas para medir la conformidad de la pol칤tica. El marco de **auto-correcci칩n** de PacBot proporciona la capacidad de responder autom치ticamente a las violaciones de pol칤ticas tomando acciones predefinidas.
* [**streamalert**](https://github.com/airbnb/streamalert)**:** StreamAlert es un marco de an치lisis de datos sin servidor y **en tiempo real** que le permite **ingresar, analizar y alertar** sobre datos de cualquier entorno, **utilizando fuentes de datos y l칩gica de alerta que defina**. Los equipos de seguridad inform치tica utilizan StreamAlert para escanear terabytes de datos de registro todos los d칤as para la detecci칩n y respuesta de incidentes.

## DEBUG: Capturar solicitudes de AWS cli

```bash
# Establecer proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080

# Capturar con burp sin verificar ssl
aws --no-verify-ssl ...

# Descargar el certificado de burp y transformarlo a pem
curl http://127.0.0.1:8080/cert --output Downloads/certificate.cer
openssl x509 -inform der -in Downloads/certificate.cer -out Downloads/certificate.pem

# Indicar el certificado ca a confiar
export AWS_CA_BUNDLE=~/Downloads/certificate.pem

# Ejecutar aws cli normalmente confiando en el certificado de burp
aws ...
```

## Referencias

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudsecdocs.com/aws/defensive/tooling/audit/](https://cloudsecdocs.com/aws/defensive/tooling/audit/)

<details>

<summary><strong>춰Apoya a HackTricks y obt칠n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **칰ltima versi칩n de PEASS o descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>