# AWS Pentesting

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

**Avant de commencer le pentesting** d'un environnement **AWS**, il y a quelques **choses de base que vous devez savoir** sur le fonctionnement d'AWS pour vous aider √† comprendre ce que vous devez faire, comment trouver des erreurs de configuration et comment les exploiter.

Des concepts tels que la hi√©rarchie de l'organisation, IAM et d'autres concepts de base sont expliqu√©s dans :

{% content-ref url="aws-basic-information/" %}
[aws-basic-information](aws-basic-information/)
{% endcontent-ref %}

## Labs pour apprendre

* [https://github.com/RhinoSecurityLabs/cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
* [https://hackingthe.cloud/aws/capture\_the\_flag/cicdont/](https://hackingthe.cloud/aws/capture\_the\_flag/cicdont/)
* [https://github.com/BishopFox/iam-vulnerable](https://github.com/BishopFox/iam-vulnerable)
* [https://github.com/nccgroup/sadcloud](https://github.com/nccgroup/sadcloud)
* [https://github.com/bridgecrewio/terragoat](https://github.com/bridgecrewio/terragoat)
* [https://github.com/ine-labs/AWSGoat](https://github.com/ine-labs/AWSGoat)
* [http://flaws.cloud/](http://flaws.cloud/)
* [http://flaws2.cloud/](http://flaws2.cloud/)

## M√©thodologie de Pentester/Red Team AWS

Pour auditer un environnement AWS, il est tr√®s important de savoir : quels **services sont utilis√©s**, ce qui est **expos√©**, qui a **acc√®s** √† quoi, et comment les services AWS internes et les services **externes** sont connect√©s.

Du point de vue de la Red Team, la **premi√®re √©tape pour compromettre un environnement AWS** est de parvenir √† obtenir des **informations d'identification**. Voici quelques id√©es sur la fa√ßon de le faire :

* **Fuites** sur github (ou similaire) - OSINT
* **Ing√©nierie** sociale
* R√©utilisation de **mots de passe** (fuites de mots de passe)
* Vuln√©rabilit√©s dans les applications h√©berg√©es par AWS
  * [**Server Side Request Forgery**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf) avec acc√®s √† l'endpoint de m√©tadonn√©es
  * **Lecture de fichiers locaux**
    * `/home/USERNAME/.aws/credentials`
    * `C:\Users\USERNAME\.aws\credentials`
* 3√®me parties **compromises**
* Employ√© **interne**
* [**Cognito** ](aws-services/aws-cognito-enum/#cognito)credentials

Ou en **compromettant un service non authentifi√©** expos√© :

{% content-ref url="aws-unauthenticated-enum-access/" %}
[aws-unauthenticated-enum-access](aws-unauthenticated-enum-access/)
{% endcontent-ref %}

Ou si vous effectuez une **revue**, vous pouvez simplement **demander des informations d'identification** avec ces r√¥les :

{% content-ref url="aws-permissions-for-a-pentest.md" %}
[aws-permissions-for-a-pentest.md](aws-permissions-for-a-pentest.md)
{% endcontent-ref %}

{% hint style="info" %}
Apr√®s avoir r√©ussi √† obtenir des informations d'identification, vous devez savoir **√† qui appartiennent ces informations d'identification**, et **√† quoi elles ont acc√®s**, vous devez donc effectuer une certaine √©num√©ration de base :
{% endhint %}

## √ânum√©ration de base

### SSRF

Si vous avez trouv√© un SSRF dans une machine √† l'int√©rieur d'AWS, consultez cette page pour des astuces :

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf" %}

### Whoami

Une des premi√®res choses que vous devez savoir est qui vous √™tes (dans quel compte vous √™tes dans d'autres informations sur l'environnement AWS) :

```bash
# La fa√ßon la plus simple, mais peut √™tre surveill√©e ?
aws sts get-caller-identity
aws iam get-user # Cela r√©cup√©rera votre propre utilisateur

# Si vous avez un ID de cl√©
aws sts get-access-key-info --access-key-id=ASIA1234567890123456

# Obtenir un message d'erreur interne
aws sns publish --topic-arn arn:aws:sns:us-east-1:*account id*:aaa --message aaa

# √Ä partir des m√©tadonn√©es
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/dynamic/instance-identity/document
```

{% hint style="danger" %}
Notez que les entreprises peuvent utiliser des **tokens canary** pour identifier quand les **tokens sont vol√©s et utilis√©s**. Il est recommand√© de v√©rifier si un token est un token canary ou non avant de l'utiliser.\
Pour plus d'informations, [**consultez cette page**](aws-services/aws-security-and-detection-services/aws-cloudtrail-enum.md#honeytokens-bypass).
{% endhint %}

### √ânum√©ration de
# Installation
gem install aws_recon

# Reconnaissance et obtention de JSON
AWS_PROFILE=<profile> aws_recon \
  --services S3,EC2 \
  --regions global,us-east-1,us-east-2 \
  --verbose
```

* [**cloudlist**](https://github.com/projectdiscovery/cloudlist): Cloudlist est un outil multi-cloud pour obtenir des actifs (noms d'h√¥tes, adresses IP) √† partir de fournisseurs de cloud.
* [**cloudmapper**](https://github.com/duo-labs/cloudmapper): CloudMapper vous aide √† analyser vos environnements Amazon Web Services (AWS). Il contient maintenant beaucoup plus de fonctionnalit√©s, y compris l'audit des probl√®mes de s√©curit√©.

```bash
# √âtapes d'installation sur github
# Cr√©er un fichier config.json avec les informations aws, comme:
{
    "accounts": [
        {
            "default": true,
            "id": "<account id>",
            "name": "dev"
        }
    ],
    "cidrs":
    {
        "2.2.2.2/28": {"name": "NY Office"}
    }
}

# √ânum√©rer
python3 cloudmapper.py collect --profile dev
## Nombre de ressources d√©couvertes
python3 cloudmapper.py stats --accounts dev

# Cr√©er un rapport HTML
## Dans le rapport, vous trouverez d√©j√† toutes les informations
python3 cloudmapper.py report --accounts dev

# Identifier les probl√®mes potentiels
python3 cloudmapper.py audit --accounts dev --json > audit.json
python3 cloudmapper.py audit --accounts dev --markdow > audit.md
python3 cloudmapper.py iam_report --accounts dev

# Identifier les administrateurs
## Les autorisations recherch√©es sont dans https://github.com/duo-labs/cloudmapper/blob/4df9fd7303e0337ff16a08f5e58f1d46047c4a87/shared/iam_audit.py#L163-L175
python3 cloudmapper.py find_admins --accounts dev

# Identifier les √©l√©ments inutilis√©s
python3 cloudmapper.py find_unused --accounts dev

# Identifier les ressources expos√©es publiquement
python3 cloudmapper.py public --accounts dev

python cloudmapper.py prepare # Pr√©parer le serveur web
python cloudmapper.py webserver # Afficher le serveur web
```

* [**cartography**](https://github.com/lyft/cartography): Cartography est un outil Python qui consolide les actifs d'infrastructure et les relations entre eux dans une vue graphique intuitive aliment√©e par une base de donn√©es Neo4j.

```bash
# Installation
pip install cartography
## Au moment de la r√©daction de cet article, vous avez besoin de la version neo4j 3.5.*

# Obtenir des informations AWS
AWS_PROFILE=dev cartography --neo4j-uri bolt://127.0.0.1:7687 --neo4j-password-prompt  --neo4j-user neo4j
```

* [**starbase**](https://github.com/JupiterOne/starbase): Starbase collecte des actifs et des relations √† partir de services et de syst√®mes, y compris l'infrastructure cloud, les applications SaaS, les contr√¥les de s√©curit√©, et plus encore, dans une vue graphique intuitive soutenue par la base de donn√©es Neo4j.
* [**aws-inventory**](https://github.com/nccgroup/aws-inventory): (Utilise python2) C'est un outil qui essaie de d√©couvrir toutes les ressources AWS cr√©√©es dans un compte.
* [**aws\_public\_ips**](https://github.com/arkadiyt/aws\_public\_ips): C'est un outil pour r√©cup√©rer toutes les adresses IP publiques (IPv4/IPv6) associ√©es √† un compte AWS.

### Privesc & Exploiting

* [**SkyArk**](https://github.com/cyberark/SkyArk)**:** D√©couvrez les utilisateurs les plus privil√©gi√©s dans l'environnement AWS analys√©, y compris les administrateurs AWS Shadow. Il utilise PowerShell. Vous pouvez trouver la d√©finition des politiques privil√©gi√©es dans la fonction `Check-PrivilegedPolicy` dans [https://github.com/cyberark/SkyArk/blob/master/AWStealth/AWStealth.ps1](https://github.com/cyberark/SkyArk/blob/master/AWStealth/AWStealth.ps1).
* [**pacu**](https://github.com/RhinoSecurityLabs/pacu): Pacu est un cadre d'exploitation AWS open source, con√ßu pour les tests de s√©curit√© offensifs contre les environnements cloud. Il peut √©num√©rer, trouver des erreurs de configuration et les exploiter. Vous pouvez trouver la d√©finition des autorisations privil√©gi√©es dans [https://github.com/RhinoSecurityLabs/pacu/blob/866376cd711666c775bbfcde0524c817f2c5b181/pacu/modules/iam\_\_privesc\_scan/main.py#L134](https://github.com/RhinoSecurityLabs/pacu/blob/866376cd711666c775bbfcde0524c817f2c5b181/pacu/modules/iam\_\_privesc\_scan/main.py#L134) √† l'int√©rieur du dictionnaire `user_escalation_methods`.
  * Notez que pacu ne v√©rifie que vos propres chemins de privescs (pas √† l'√©chelle du compte).

```bash
# Installation
## N'h√©sitez pas √† utiliser des venvs
pip3 install pacu

# Utiliser la CLI pacu
pacu
> import_keys <profile_name> # importer 1 profil depuis .aws/credentials
> import_keys --all # importer tous les profils
> list # lister les modules
> exec iam__enum_permissions # Obtenir les autorisations
> exec iam__privesc_scan # Lister les autorisations privil√©gi√©es
```

* [**PMapper**](https://github.com/nccgroup/PMapper): Principal Mapper (PMapper) est un script et une biblioth√®que pour identifier les risques dans la configuration de l'AWS Identity and Access Management (IAM) pour un compte AWS ou une organisation AWS. Il mod√©lise les diff√©rents utilisateurs et r√¥les IAM dans un compte sous forme de grap
## DEBUG: Capturer les requ√™tes AWS cli

```bash
# D√©finir le proxy
export HTTP_PROXY=http://localhost:8080
export HTTPS_PROXY=http://localhost:8080

# Capturer avec burp sans v√©rifier ssl
aws --no-verify-ssl ...

# T√©l√©charger le certificat burp et le transformer en pem
curl http://127.0.0.1:8080/cert --output Downloads/certificate.cer
openssl x509 -inform der -in Downloads/certificate.cer -out Downloads/certificate.pem

# Indiquer le certificat ca √† faire confiance
export AWS_CA_BUNDLE=~/Downloads/certificate.pem

# Ex√©cuter aws cli normalement en faisant confiance au certificat burp
aws ...
```

## R√©f√©rences

* [https://www.youtube.com/watch?v=8ZXRw4Ry3mQ](https://www.youtube.com/watch?v=8ZXRw4Ry3mQ)
* [https://cloudsecdocs.com/aws/defensive/tooling/audit/](https://cloudsecdocs.com/aws/defensive/tooling/audit/)

<details>

<summary><strong>Soutenez HackTricks et obtenez des avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>